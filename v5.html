<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>LocalLife OS - Hyper-Integrated AI Platform</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.2.0/crypto-js.min.js"></script>
    <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyDczcazYyFVZc7ZJz9VDRYbXW8V8aShknw&libraries=visualization,drawing&callback=initMap" async defer></script>

    <style>
        :root {
            --bg-color: #F7F7F7;
            --card-bg: #FFFFFF;
            --text-color: #333333;
            --text-secondary-color: #777777;
            --primary-accent: #4DB6AC;
            --primary-accent-darker: #3aa396;
            --moss-green: #8FBC8F;
            --soft-blue: #ADD8E6;
            --warm-gray: #D3D3D3;
            --muted-terracotta: #E07A5F;
            --danger-color: #E57373;
            --success-color: #66BB6A;
            --placeholder-bg: #F0F0F0;
            --info-color: #2196F3;
            --ai-suggestion-bg: color-mix(in srgb, var(--primary-accent) 10%, var(--card-bg));
            --ai-info-toast-bg: #2979FF;
            --favorite-color: #FFC107;
            --xp-color: #9C27B0;
            --font-family: 'Inter', sans-serif;
            --base-font-size: 16px;
            --border-radius-lg: 20px;
            --border-radius-md: 12px;
            --border-radius-sm: 8px;
            --shadow-color-rgb: 0, 0, 0;
            --card-shadow: 0 4px 12px 0 rgba(var(--shadow-color-rgb), 0.08);
            --element-shadow: 0 2px 8px 0 rgba(var(--shadow-color-rgb), 0.07);
            --card-shadow-hover: 0 8px 20px 0 rgba(var(--shadow-color-rgb), 0.1);
            --fab-shadow: 0 6px 16px 0 rgba(var(--shadow-color-rgb), 0.12);
            --skeleton-bg: #EAEAEA;
            --skeleton-highlight: #F5F5F5;
            --chat-bg: #E5DDD5;
            --chat-bubble-user-bg: var(--primary-accent);
            --chat-bubble-other-bg: var(--card-bg);
            --chat-timestamp-color: rgba(0, 0, 0, 0.45);
            --chat-user-timestamp-color: rgba(255, 255, 255, 0.7);
            --chat-header-status-color: #666;
            --chat-date-separator-bg: #e1f3fb;
            --chat-date-separator-text: #5085a0;
            --space-xs: clamp(0.25rem, 1vw, 0.5rem);
            --space-sm: clamp(0.5rem, 1.5vw, 0.75rem);
            --space-md: clamp(0.75rem, 2.5vw, 1.25rem);
            --space-lg: clamp(1rem, 3.5vw, 1.75rem);
            --space-xl: clamp(1.5rem, 5vw, 2.5rem);
            --ease-out-bounce: cubic-bezier(0.175, 0.885, 0.32, 1.275);
            --ease-out-smooth: cubic-bezier(0.22, 1, 0.36, 1);
        }
        body.dark-mode {
            --bg-color: #121212;
            --card-bg: #1E1E1E;
            --text-color: #E0E0E0;
            --text-secondary-color: #AAAAAA;
            --warm-gray: #4A4A4A;
            --placeholder-bg: #2C2C2C;
            --info-color: #64B5F6;
            --ai-suggestion-bg: color-mix(in srgb, var(--primary-accent) 20%, var(--card-bg));
            --ai-info-toast-bg: #64B5F6;
            --xp-color: #BA68C8;
            --shadow-color-rgb: 0, 0, 0;
            --card-shadow: 0 4px 12px 0 rgba(var(--shadow-color-rgb), 0.35);
            --element-shadow: 0 2px 8px 0 rgba(var(--shadow-color-rgb), 0.3);
            --card-shadow-hover: 0 8px 20px 0 rgba(var(--shadow-color-rgb), 0.4);
            --fab-shadow: 0 6px 16px 0 rgba(var(--shadow-color-rgb), 0.45);
            --skeleton-bg: #3a3a3a;
            --skeleton-highlight: #4a4a4a;
            --chat-bg: #0e1621;
            --chat-bubble-other-bg: #262d31;
            --chat-timestamp-color: rgba(255, 255, 255, 0.45);
            --chat-header-status-color: #ccc;
            --chat-date-separator-bg: #1f2c34;
            --chat-date-separator-text: #8696a0;
        }
        * { box-sizing: border-box; margin: 0; padding: 0; }
        html { font-size: var(--base-font-size); height: 100%; }
        body { 
            min-height: 100svh;
            font-family: var(--font-family); 
            background-color: var(--bg-color); 
            color: var(--text-color); 
            -webkit-tap-highlight-color: transparent; 
            transition: background-color 0.4s var(--ease-out-smooth), color 0.4s var(--ease-out-smooth); 
            display: flex;
            flex-direction: column;
        }
        #authContainer { display: flex; flex-direction: column; align-items: center; justify-content: center; flex-grow: 1; width: 100%; padding: var(--space-md); background-color: var(--bg-color); }
        .auth-screen { display: none; width: 100%; max-width: 400px; text-align: center; animation: fadeInAuth 0.5s var(--ease-out-smooth); }
        .auth-screen.active { display: block; }
        @keyframes fadeInAuth { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
        .auth-logo { font-size: clamp(2rem, 6vw, 2.5rem); color: var(--primary-accent); margin-bottom: var(--space-sm); }
        .auth-title { font-size: clamp(1.5rem, 4.5vw, 1.8rem); font-weight: 700; margin-bottom: var(--space-xs); color: var(--text-color); }
        .auth-subtitle { font-size: clamp(0.9rem, 2.5vw, 1rem); color: var(--text-secondary-color); margin-bottom: var(--space-lg); font-weight: 400; line-height: 1.5; }
        .auth-form .input-group { margin-bottom: var(--space-md); }
        .auth-form .input-field { text-align: left; }
        .auth-form .button { width: 100%; margin-top: var(--space-sm); }
        .auth-link { display: block; margin-top: var(--space-md); color: var(--primary-accent); text-decoration: none; font-weight: 500; font-size: clamp(0.85rem, 2.2vw, 0.95rem); }
        .auth-link:hover { text-decoration: underline; }
        .app-container { display: flex; flex-direction: column; height: 100svh; width: 100%; max-width: 450px; margin: 0 auto; background-color: var(--bg-color); overflow: hidden; position: relative; transition: background-color 0.3s var(--ease-out-smooth); }
        .app-container.hidden { display: none; }
        .content { flex-grow: 1; overflow-y: auto; padding: var(--space-md) var(--space-md) calc(80px + env(safe-area-inset-bottom)) var(--space-md); transition: padding-bottom 0.3s var(--ease-out-smooth); overscroll-behavior: contain; -webkit-overflow-scrolling: touch; scroll-padding-top: var(--space-md); }
        .app-container.full-page-active .bottom-nav, .app-container.full-page-active .ai-fab { transform: translateY(150%); pointer-events: none; opacity: 0; }
        .app-container.full-page-active .content { padding: 0; overflow: hidden; }
        .screen { display: none; animation: fadeIn 0.4s var(--ease-out-smooth); }
        .screen.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .screen-header { display: flex; align-items: center; margin-bottom: var(--space-sm); justify-content: space-between;}
        .screen-header .back-button { font-size: clamp(1.1rem, 3vw, 1.2rem); color: var(--primary-accent); margin-right: var(--space-sm); padding: var(--space-xs); cursor: pointer; background: none; border: none; }
        .screen-header .title-group { display: flex; align-items: center; min-width: 0; flex-grow: 1; }
        .screen-header .title { font-size: clamp(1.3rem, 4vw, 1.5rem); font-weight: 600; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; min-width: 0; }
        .screen-header .action-button { font-size: clamp(1.1rem, 3vw, 1.2rem); color: var(--primary-accent); padding: var(--space-xs); cursor: pointer; background: none; border: none; flex-shrink: 0; margin-left: var(--space-xs); position:relative; transition: transform 0.2s var(--ease-out-bounce); }
        .screen-header .action-button:active { transform: scale(0.9); }
        .unread-notification-badge { position: absolute; top: -2px; right: -5px; background-color: var(--danger-color); color: white; border-radius: 50%; width: clamp(16px, 4vw, 18px); height: clamp(16px, 4vw, 18px); font-size: clamp(0.6rem, 1.8vw, 0.7rem); display: flex; align-items: center; justify-content: center; font-weight: bold; box-shadow: 0 0 5px rgba(0,0,0,0.3); transform: scale(1); transition: transform 0.3s var(--ease-out-bounce); }
        .unread-notification-badge.hidden { transform: scale(0); }
        .skeleton-loader .skeleton-item { background-color: var(--skeleton-bg); border-radius: var(--border-radius-sm); margin-bottom: var(--space-sm); animation: pulse 1.5s infinite ease-in-out; }
        .skeleton-loader .skeleton-item.title { height: clamp(18px, 2.5vw, 20px); width: 60%; margin-bottom: var(--space-md); }
        .skeleton-loader .skeleton-item.text { height: clamp(10px, 1.8vw, 12px); width: 80%; }
        .skeleton-loader .skeleton-item.text-short { height: clamp(10px, 1.8vw, 12px); width: 40%; margin-top: var(--space-xs); }
        .skeleton-loader .skeleton-card { background-color: var(--card-bg); border-radius: var(--border-radius-lg); padding: var(--space-md); margin-bottom: var(--space-md); box-shadow: var(--card-shadow); display:flex; gap: var(--space-sm); align-items:center;}
        .skeleton-loader .skeleton-card .skeleton-avatar { width:clamp(50px, 12vw, 60px); height:clamp(50px, 12vw, 60px); border-radius:var(--border-radius-md); background-color: var(--skeleton-bg); animation: pulse 1.5s infinite ease-in-out; flex-shrink:0;}
        .skeleton-loader .skeleton-card .skeleton-info { flex-grow:1;}
        .skeleton-loader .skeleton-list-item { display: flex; align-items: center; padding: var(--space-sm) 0; border-bottom: 1px solid var(--placeholder-bg); }
        .skeleton-loader .skeleton-list-item .skeleton-checkbox { width: clamp(18px, 4.5vw, 20px); height: clamp(18px, 4.5vw, 20px); border-radius: 50%; background-color: var(--skeleton-bg); margin-right: var(--space-sm); animation: pulse 1.5s infinite ease-in-out; }
        .skeleton-loader .skeleton-list-item .skeleton-text-line { height: clamp(14px, 2.2vw, 16px); background-color: var(--skeleton-bg); border-radius: 4px; animation: pulse 1.5s infinite ease-in-out; }
        .skeleton-loader .skeleton-list-item .skeleton-text-line.long { width: 70%; }
        .skeleton-loader .skeleton-list-item .skeleton-text-line.short { width: 40%; margin-top: var(--space-xs); height: clamp(10px, 1.8vw, 12px); }
        @keyframes pulse { 0% { background-color: var(--skeleton-bg); } 50% { background-color: var(--skeleton-highlight); } 100% { background-color: var(--skeleton-bg); } }
        .empty-state { text-align: center; padding: var(--space-lg) var(--space-md); color: var(--text-secondary-color); animation: fadeIn 0.5s; }
        .empty-state i { font-size: clamp(2rem, 6vw, 2.5rem); margin-bottom: var(--space-sm); color: var(--warm-gray); }
        .empty-state p { font-size: clamp(0.9rem, 2.5vw, 1rem); line-height: 1.5; }
        .card { background-color: var(--card-bg); border-radius: var(--border-radius-lg); padding: var(--space-md); margin-bottom: var(--space-md); box-shadow: var(--card-shadow); transition: transform 0.25s var(--ease-out-smooth), background-color 0.3s, box-shadow 0.25s var(--ease-out-smooth); will-change: transform, box-shadow; }
        .card:hover:not(.no-press) { box-shadow: var(--card-shadow-hover); transform: translateY(-3px); }
        .card:active:not(.no-press) { transform: scale(0.98) translateY(0px); box-shadow: var(--card-shadow); transition-duration: 0.1s; }
        .card-title { font-size: clamp(1.1rem, 3.2vw, 1.2rem); font-weight: 600; margin-bottom: var(--space-sm); color: var(--text-color); white-space: nowrap; overflow: hidden; text-overflow: ellipsis;}
        .card-subtitle { font-size: clamp(0.85rem, 2.4vw, 0.9rem); color: var(--text-secondary-color); margin-bottom: var(--space-sm); font-weight: 400; line-height: 1.5; }
        .button { background-color: var(--primary-accent); color: white; border: none; padding: clamp(10px, 2.8vw, 12px) clamp(16px, 4vw, 20px); border-radius: var(--border-radius-md); font-size: clamp(0.9rem, 2.5vw, 1rem); font-weight: 500; cursor: pointer; text-align: center; box-shadow: var(--element-shadow); transition: background-color 0.2s, transform 0.15s var(--ease-out-smooth), box-shadow 0.2s; will-change: transform, box-shadow; }
        .button:active { background-color: var(--primary-accent-darker); transform: scale(0.97); box-shadow: none; }
        .button:disabled { background-color: var(--warm-gray); cursor: not-allowed; opacity: 0.7; box-shadow: none; transform: none; }
        .button-secondary { background-color: var(--placeholder-bg); color: var(--text-color); }
        .button-secondary:active { background-color: color-mix(in srgb, var(--placeholder-bg) 80%, black); }
        body.dark-mode .button-secondary { background-color: #444; color: var(--text-color); }
        body.dark-mode .button-secondary:active { background-color: #555; }
        .button.danger { background-color: var(--danger-color); }
        .button.danger:active { background-color: #d32f2f; }
        .button.voice-button { flex-shrink: 0; padding: 0 clamp(10px, 2.8vw, 12px); font-size: clamp(1.1rem, 3vw, 1.2rem); margin-left: var(--space-xs); background-color: var(--placeholder-bg); color: var(--text-color);}
        .input-group { position: relative; margin-bottom: var(--space-sm); }
        .input-field { width: 100%; padding: clamp(10px, 2.8vw, 12px); border: 1px solid color-mix(in srgb, var(--text-color) 20%, transparent); border-radius: var(--border-radius-md); font-size: clamp(0.9rem, 2.5vw, 1rem); background-color: color-mix(in srgb, var(--bg-color) 95%, var(--text-color) 3%); color: var(--text-color); transition: border-color 0.2s, box-shadow 0.2s, background-color 0.2s; }
        .input-field:focus { outline: none; border-color: var(--primary-accent); background-color: var(--card-bg); box-shadow: 0 0 0 3px color-mix(in srgb, var(--primary-accent) 20%, transparent); }
        body.dark-mode .input-field { border-color: color-mix(in srgb, var(--text-color) 25%, transparent); }
        body.dark-mode .input-field:focus { background-color: var(--card-bg); }
        .input-clear-btn { position: absolute; right: 10px; top: 50%; transform: translateY(-50%); background: none; border: none; color: var(--text-secondary-color); cursor: pointer; font-size: clamp(1rem, 2.8vw, 1.1rem); padding: var(--space-xs); }
        textarea.input-field { resize: vertical;}
        label { display: block; margin-bottom: var(--space-xs); font-weight: 500; font-size: clamp(0.85rem, 2.3vw, 0.9rem);}
        select.input-field { appearance: none; -webkit-appearance: none; -moz-appearance: none; background-image: url("data:image/svg+xml;charset=US-ASCII,%3Csvg%20xmlns%3D%27http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%27%20width%3D%27292.4%27%20height%3D%27292.4%27%3E%3Cpath%20fill%3D%27%23777777%27%20d%3D%27M287%2069.4a17.6%2017.6%200%200%200-13-5.4H18.4c-5%200-9.3%201.8-12.9%205.4A17.6%2017.6%200%200%200%200%2082.2c0%205%201.8%209.3%205.4%2012.9l128%20127.9c3.6%203.6%207.8%205.4%2012.8%205.4s9.2-1.8%2012.8-5.4L287%2095c3.5-3.5%205.4-7.8%205.4-12.8%200-5-1.9-9.2-5.5-12.8z%27%2F%3E%3C%2Fsvg%3E"); background-repeat: no-repeat; background-position: right 10px center; background-size: .65em auto; padding-right: 30px; }
        body.dark-mode select.input-field { background-image: url("data:image/svg+xml;charset=US-ASCII,%3Csvg%20xmlns%3D%27http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%27%20width%3D%27292.4%27%20height%3D%27292.4%27%3E%3Cpath%20fill%3D%27%23AAAAAA%27%20d%3D%27M287%2069.4a17.6%2017.6%200%200%200-13-5.4H18.4c-5%200-9.3%201.8-12.9%205.4A17.6%2017.6%200%200%200%200%2082.2c0%205%201.8%209.3%205.4%2012.9l128%20127.9c3.6%203.6%207.8%205.4%2012.8%205.4s9.2-1.8%2012.8-5.4L287%2095c3.5-3.5%205.4-7.8%205.4-12.8%200-5-1.9-9.2-5.5-12.8z%27%2F%3E%3C%2Fsvg%3E");}
        .bottom-nav { position: fixed; bottom: 0; left: 0; right: 0; max-width: 450px; margin: 0 auto; display: flex; justify-content: space-around; background-color: var(--card-bg); padding: var(--space-xs) 0 calc(var(--space-sm) + env(safe-area-inset-bottom)) 0; box-shadow: 0 -4px 20px rgba(var(--shadow-color-rgb),0.1); border-top-left-radius: var(--border-radius-lg); border-top-right-radius: var(--border-radius-lg); z-index: 1000; transition: background-color 0.3s, transform 0.4s var(--ease-out-smooth); will-change: transform; }
        .nav-item { display: flex; flex-direction: column; align-items: center; justify-content: center; color: var(--text-secondary-color); cursor: pointer; padding: var(--space-sm) var(--space-xs); border-radius: var(--border-radius-sm); transition: color 0.2s, background-color 0.2s, transform 0.15s; flex-basis: 0; flex-grow: 1; text-align: center; background: none; border: none; }
        .nav-item i { font-size: clamp(1.2rem, 3.5vw, 1.35rem); margin-bottom: 0; transition: transform 0.3s var(--ease-out-bounce), text-shadow 0.3s var(--ease-out-smooth); }
        .nav-item span { display: none; }
        .nav-item.active { color: var(--primary-accent); }
        .nav-item.active i { transform: scale(1.15) translateY(-2px); text-shadow: 0 0 15px color-mix(in srgb, var(--primary-accent) 50%, transparent); }
        .nav-item:active { background-color: color-mix(in srgb, var(--primary-accent) 10%, transparent); }
        .nav-item:active i { transform: scale(0.9); }
        body.dark-mode .nav-item:active { background-color: color-mix(in srgb, var(--primary-accent) 15%, transparent); }
        #dynamicIslandAlert { position: absolute; top: var(--space-md); left: 50%; transform: translateX(-50%) scale(0.95) translateY(-20px); width: auto; max-width: 90%; background-color: rgba(var(--shadow-color-rgb), 0.5); backdrop-filter: blur(15px); -webkit-backdrop-filter: blur(15px); color: white; padding: var(--space-xs) var(--space-sm); border-radius: 50px; border: 1px solid rgba(255, 255, 255, 0.1); z-index: 1500; display: flex; align-items: center; gap: var(--space-sm); box-shadow: 0 4px 15px rgba(var(--shadow-color-rgb), 0.2); opacity: 0; pointer-events: none; transition: opacity 0.4s var(--ease-out-smooth), transform 0.4s var(--ease-out-bounce); will-change: opacity, transform; }
        #dynamicIslandAlert.show { opacity: 1; transform: translateX(-50%) scale(1) translateY(0); pointer-events: all; }
        body.dark-mode #dynamicIslandAlert { background-color: rgba(30, 30, 30, 0.7); }
        #dynamicIslandAlert .icon { font-size: clamp(0.9rem, 2.5vw, 1rem); flex-shrink: 0; }
        #dynamicIslandAlert .text { font-size: clamp(0.8rem, 2.2vw, 0.85rem); font-weight: 500; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        #dynamicIslandAlert .action-button { background: none; border: none; color: white; opacity: 0.7; font-size: 0.9rem; }
        #dashboard .ai-greeting { font-size: clamp(1.3rem, 4vw, 1.5rem); font-weight: 600; margin-bottom: var(--space-xs); }
        #dashboard .local-context-card .context-item { display: flex; align-items: center; margin-bottom: var(--space-xs); font-size: clamp(0.85rem, 2.3vw, 0.9rem); }
        #dashboard .local-context-card .context-item i { margin-right: var(--space-sm); color: var(--primary-accent); width: 20px; text-align: center; }
        .nearby-pulse-carousel { display: flex; overflow-x: auto; padding-bottom: var(--space-sm); gap: var(--space-sm); margin-bottom: var(--space-md); -webkit-overflow-scrolling: touch; scroll-snap-type: x mandatory;}
        .nearby-pulse-carousel::-webkit-scrollbar { display: none; }
        .story-item { display: flex; flex-direction: column; align-items: center; cursor: pointer; min-width: clamp(70px, 18vw, 80px); background: none; border:none; padding:0; transition: transform 0.2s; scroll-snap-align: start;}
        .story-item:active { transform: scale(0.9); }
        .story-item .story-avatar { width: clamp(50px, 13vw, 60px); height: clamp(50px, 13vw, 60px); border-radius: 50%; background-color: var(--warm-gray); border: 3px solid var(--primary-accent); display: flex; justify-content: center; align-items: center; overflow: hidden; margin-bottom: var(--space-xs); box-shadow: var(--element-shadow); }
        .story-item .story-avatar i { font-size: clamp(1.5rem, 4.5vw, 1.8rem); color: white; }
        .story-item .story-label { font-size: clamp(0.7rem, 2vw, 0.75rem); text-align: center; color: var(--text-secondary-color); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; width: clamp(60px, 17vw, 70px); }
        .safety-ticker { background-color: var(--muted-terracotta); color: white; padding: var(--space-sm); border-radius: var(--border-radius-md); font-size: clamp(0.8rem, 2.2vw, 0.85rem); text-align: center; margin-bottom: var(--space-md); box-shadow: var(--element-shadow); cursor:pointer; display:flex; align-items:center; justify-content:center; }
        .safety-ticker #safetyTickerText { transition: opacity 0.2s ease-in-out; margin-left: var(--space-xs); flex-grow:1; text-align:left;}
        .safety-ticker .sos-button { background-color: #fff; color: var(--danger-color); border:none; border-radius:50%; width:clamp(28px, 7vw, 30px); height:clamp(28px, 7vw, 30px); font-size:clamp(0.8rem, 2.2vw, 0.9rem); display:flex; align-items:center; justify-content:center; margin-left:var(--space-sm); box-shadow: var(--element-shadow); flex-shrink:0; transition: transform 0.2s; }
        .safety-ticker .sos-button:active { transform: scale(0.9); }
        .suggestion-action { display: block; margin-top: var(--space-sm); padding: clamp(6px, 1.8vw, 8px) clamp(10px, 2.5vw, 12px); font-size: clamp(0.85rem, 2.3vw, 0.9rem); }
        #pinnedWidgetsContainer { display: grid; grid-template-columns: repeat(auto-fit, minmax(110px, 1fr)); gap: var(--space-sm); }
        .pinned-widget-item { background-color: color-mix(in srgb, var(--bg-color) 90%, var(--card-bg) 10%); border: 1px solid var(--placeholder-bg); border-radius: var(--border-radius-md); padding: var(--space-sm); font-size: clamp(0.75rem, 2vw, 0.8rem); display: flex; flex-direction: column; align-items: flex-start; box-shadow: var(--element-shadow); min-height: clamp(60px, 15vw, 70px); cursor: grab; transition: transform 0.2s var(--ease-out-smooth), box-shadow 0.2s var(--ease-out-smooth); position: relative; overflow: hidden; }
        .pinned-widget-item:active { cursor: grabbing; transform: scale(0.96); transition-duration: 0.1s; }
        .pinned-widget-item::after { content: ''; position: absolute; top: 0; right: 0; bottom: 0; left: 0; transform: translateX(-100%); background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.1), transparent); animation: shimmer 3s infinite; }
        @keyframes shimmer { 100% { transform: translateX(100%); } }
        .pinned-widget-item:hover { transform: translateY(-2px); box-shadow: var(--card-shadow-hover); }
        body.dark-mode .pinned-widget-item { background-color: color-mix(in srgb, var(--bg-color) 90%, var(--card-bg) 10%); border-color: var(--warm-gray); }
        body.dark-mode .pinned-widget-item::after { background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.04), transparent); }
        .pinned-widget-item .widget-icon { font-size: clamp(1.1rem, 3vw, 1.2rem); margin-bottom: var(--space-xs); color: var(--primary-accent); }
        .pinned-widget-item .widget-title { font-weight: 500; color: var(--text-secondary-color); margin-bottom: 3px; }
        .pinned-widget-item .widget-value { font-weight: 600; font-size: clamp(0.85rem, 2.3vw, 0.9rem); color: var(--text-color); line-height: 1.3; word-break: break-word; }
        #dashboardDealsList .deal-card { margin-bottom: var(--space-sm); } 
        #dashboardDealsList .deal-card:last-child { margin-bottom: 0; }
        #aiDashboardInsight { background-color: var(--ai-suggestion-bg); padding: var(--space-sm); border-radius: var(--border-radius-md); font-size: clamp(0.8rem, 2.2vw, 0.85rem); margin-top: var(--space-xs); color: var(--text-color); border: 1px solid color-mix(in srgb, var(--primary-accent) 30%, transparent);}
        #aiDashboardInsight i { margin-right: var(--space-xs); color: var(--primary-accent); }
        #newsSummaryCard #newsSummaryContent ul { list-style-type: none; padding-left: 0; margin: 0; }
        #newsSummaryCard #newsSummaryContent li { display: flex; align-items: flex-start; margin-bottom: var(--space-sm); font-size: clamp(0.85rem, 2.3vw, 0.9rem); line-height: 1.4; }
        #newsSummaryCard #newsSummaryContent li::before { content: "\f10c"; font-family: "Font Awesome 6 Free"; font-weight: 900; color: var(--primary-accent); font-size: 0.6em; margin-right: var(--space-sm); margin-top: 0.4em; flex-shrink: 0; }
        #newsSummaryCard #newsSummaryContent li:last-child { margin-bottom: 0; }
        #dashboardTaskList .task-item { display: flex; align-items: center; gap: var(--space-sm); padding: var(--space-xs) 0; }
        #dashboardTaskList .task-checkbox-button { background: none; border: none; padding: 0; cursor: pointer; }
        #dashboardTaskList .task-checkbox { width: 20px; height: 20px; border: 2px solid var(--primary-accent); border-radius: 50%; display:flex; justify-content:center; align-items:center; }
        #dashboardTaskList .task-checkbox.completed { background-color: var(--primary-accent); }
        #dashboardTaskList .task-checkbox.completed i { color: white; font-size: 0.7em; }
        #dashboardTaskList .task-title { font-weight: 500; }
        #dashboardTaskList .task-title.completed { text-decoration: line-through; color: var(--text-secondary-color); }
        #dashboardTaskList .task-time { font-size: 0.8rem; color: var(--text-secondary-color); margin-left: auto; flex-shrink: 0; }
        .task-list { list-style: none; padding: 0; display: grid; gap: var(--space-sm); }
        .task-card { background-color: var(--card-bg); border-radius: var(--border-radius-lg); padding: var(--space-sm); box-shadow: var(--element-shadow); transition: background-color 0.1s; display: flex; align-items: flex-start; gap: var(--space-sm); }
        .task-card:hover { background-color: color-mix(in srgb, var(--primary-accent) 5%, transparent); }
        body.dark-mode .task-card { background-color: var(--card-bg); }
        body.dark-mode .task-card:hover { background-color: color-mix(in srgb, var(--primary-accent) 10%, var(--card-bg)); }
        .task-card .task-checkbox-button { background: none; border: none; padding: 0; cursor: pointer; flex-shrink: 0; transition: transform 0.2s; margin-top: 2px; }
        .task-card .task-checkbox-button:active { transform: scale(0.85); }
        .task-card .task-checkbox { width: clamp(20px, 5vw, 22px); height: clamp(20px, 5vw, 22px); border: 2px solid var(--primary-accent); border-radius: 50%; display: flex; justify-content: center; align-items: center; transition: background-color 0.2s, border-color 0.2s; }
        .task-card .task-checkbox.completed { background-color: var(--primary-accent); border-color: var(--primary-accent); }
        .task-card .task-checkbox.completed i { color: white; font-size: clamp(0.7em, 1.8vw, 0.8em); transform: scale(1); transition: transform 0.3s var(--ease-out-bounce); }
        .task-card .task-info { flex-grow: 1; min-width: 0; position: relative; }
        .task-card .task-title { font-weight: 500; word-break: break-word; font-size: clamp(0.9rem, 2.5vw, 1rem); line-height: 1.4; }
        .task-card .task-title.completed { text-decoration: line-through; color: var(--text-secondary-color); }
        .task-card .task-meta { font-size: clamp(0.75rem, 2vw, 0.8rem); color: var(--text-secondary-color); display: flex; flex-wrap: wrap; gap: var(--space-sm); margin-top: var(--space-xs); align-items: center;}
        .task-card .task-meta .task-time, .task-card .task-meta .task-duedate { display: inline-flex; align-items: center; gap: 4px; }
        .task-card .task-meta-ai { font-size: clamp(0.7rem, 1.9vw, 0.75rem); color: var(--primary-accent); font-style: italic; margin-top: 5px; background-color: var(--ai-suggestion-bg); padding: 3px 6px; border-radius: var(--border-radius-sm); display: block; line-height: 1.4; }
        .task-card .task-actions { display: flex; align-items: center; flex-shrink: 0; margin-left: auto; }
        .task-card .task-action-button { color: var(--text-secondary-color); cursor: pointer; font-size: clamp(0.85rem, 2.3vw, 0.9rem); background: none; border: none; padding: var(--space-xs); }
        .task-card .task-action-button.delete { color: var(--danger-color); }
        .task-category-color-bar { width: 5px; height: auto; align-self: stretch; border-radius: 5px; flex-shrink: 0; }
        .task-category-work .task-category-color-bar { background-color: var(--moss-green); }
        .task-category-personal .task-category-color-bar { background-color: var(--soft-blue); }
        .task-category-errands .task-category-color-bar { background-color: var(--muted-terracotta); }
        .task-category-learning .task-category-color-bar { background-color: #FFC107; }
        .task-category-health .task-category-color-bar { background-color: #9575CD; }
        .calendar-view-placeholder { min-height: clamp(120px, 30vh, 150px); background-color: var(--placeholder-bg); border-radius: var(--border-radius-md); display: grid; grid-template-columns: repeat(7, 1fr); gap: clamp(1px, 0.5vw, 2px); padding: var(--space-xs); color: var(--text-secondary-color); margin-bottom: var(--space-md); }
        .calendar-view-placeholder .day { background-color: var(--card-bg); border-radius: 4px; display: flex; align-items: center; justify-content: center; font-size: clamp(0.6rem, 1.8vw, 0.7rem); position: relative; cursor: pointer; transition: transform 0.2s, background-color 0.2s; aspect-ratio: 1 / 1; }
        .calendar-view-placeholder .day:hover { transform: scale(1.1); z-index: 1; }
        .calendar-view-placeholder .day.today { background: linear-gradient(135deg, var(--primary-accent), var(--primary-accent-darker)); color: white; font-weight: bold; }
        .calendar-task-dot { position: absolute; bottom: 3px; left: 50%; transform: translateX(-50%); width: 5px; height: 5px; border-radius: 50%; background-color: var(--danger-color); }
        .calendar-view-placeholder .day.today .calendar-task-dot { background-color: white; }
        .add-task-input-container { display: flex; gap: var(--space-sm); margin-bottom: var(--space-sm); }
        .add-task-input { flex-grow:1; } 
        .add-task-button { padding: 0 clamp(12px, 3.5vw, 15px); font-size: clamp(1.1rem, 3vw, 1.2rem); }
        .ai-planner-suggestion { background-color: var(--ai-suggestion-bg); padding: var(--space-sm) var(--space-md); border-radius: var(--border-radius-md); font-size: clamp(0.85rem, 2.3vw, 0.9rem); margin-top: var(--space-sm); color: var(--text-color); border: 1px solid color-mix(in srgb, var(--primary-accent) 30%, transparent);}
        .ai-planner-suggestion i { color: var(--primary-accent); margin-right: var(--space-xs);}
        .planner-actions-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: var(--space-md); margin-top: var(--space-lg); }
        .planner-action-item { background-color: var(--card-bg); border: 1px solid var(--placeholder-bg); border-radius: var(--border-radius-lg); padding: var(--space-md); display: flex; flex-direction: column; align-items: center; justify-content: center; text-align: center; cursor: pointer; box-shadow: var(--card-shadow); transition: transform 0.2s var(--ease-out-smooth), box-shadow 0.2s var(--ease-out-smooth), border-color 0.2s; will-change: transform, box-shadow; min-height: 100px; }
        .planner-action-item:hover { transform: translateY(-4px); box-shadow: var(--card-shadow-hover); border-color: var(--primary-accent); }
        .planner-action-item:active { transform: scale(0.96) translateY(0px); box-shadow: var(--element-shadow); transition-duration: 0.1s; }
        body.dark-mode .planner-action-item { border-color: var(--warm-gray); }
        body.dark-mode .planner-action-item:hover { border-color: var(--primary-accent); }
        .planner-action-item.primary { grid-column: 1 / -1; flex-direction: row; justify-content: flex-start; text-align: left; gap: var(--space-md); background-color: color-mix(in srgb, var(--primary-accent) 8%, var(--card-bg)); border-color: color-mix(in srgb, var(--primary-accent) 30%, transparent); }
        .planner-action-item > i { font-size: clamp(1.4rem, 4vw, 1.6rem); color: var(--primary-accent); margin-bottom: var(--space-sm); }
        .planner-action-item.primary > i { font-size: clamp(1.8rem, 5vw, 2rem); margin-bottom: 0; }
        .planner-action-item .action-text-content { display: flex; flex-direction: column; align-items: center; }
        .planner-action-item.primary .action-text-content { align-items: flex-start; }
        .planner-action-item .action-title { font-weight: 600; color: var(--text-color); font-size: clamp(0.9rem, 2.5vw, 1rem); line-height: 1.3; }
        .planner-action-item .action-subtitle { font-size: clamp(0.75rem, 2vw, 0.8rem); color: var(--text-secondary-color); line-height: 1.4; margin-top: 3px; }
        .planner-action-item.primary .action-title { font-size: clamp(1rem, 2.8vw, 1.1rem); }
        #map-container { position: relative; height: clamp(200px, 40svh, 250px); background-color: var(--placeholder-bg); border-radius: var(--border-radius-lg); margin-bottom: var(--space-md); overflow:hidden; }
        #map-container .gm-style .gm-style-iw-d { overflow: hidden !important; }
        #map-container .gm-style .gm-style-iw-c { padding: 8px !important; }
        .map-actions { position: absolute; bottom: var(--space-sm); right: var(--space-sm); display: flex; gap: var(--space-xs); z-index: 5; }
        .map-action-button { background-color: var(--card-bg); color: var(--text-color); border: none; padding: var(--space-xs) var(--space-sm); border-radius: var(--border-radius-md); box-shadow: var(--element-shadow); cursor: pointer; font-size: clamp(0.8rem, 2.2vw, 0.9rem); }
        .search-bar-container { display: flex; gap: var(--space-sm); margin-bottom: var(--space-md); }
        #exploreSearchInput { flex-grow: 1;}
        .filter-bar { display: flex; gap: var(--space-sm); margin-bottom: var(--space-md); overflow-x: auto; padding-bottom: var(--space-sm); -webkit-overflow-scrolling: touch; scroll-snap-type: x mandatory;}
        .filter-bar::-webkit-scrollbar { display: none; }
        .filter-button { padding: clamp(6px, 1.8vw, 8px) clamp(12px, 3.5vw, 15px); background-color: var(--placeholder-bg); border: none; border-radius: var(--border-radius-md); font-size: clamp(0.85rem, 2.3vw, 0.9rem); cursor: pointer; white-space: nowrap; transition: background-color 0.2s, color 0.2s, box-shadow 0.2s, transform 0.2s; color: var(--text-color); scroll-snap-align: start; }
        body.dark-mode .filter-button { background-color: #383838; color: var(--text-color); }
        .filter-button.active { background-color: var(--primary-accent); color: white; font-weight: 600; box-shadow: var(--element-shadow); transform: scale(1.05); }
        body.dark-mode .filter-button.active { background-color: var(--primary-accent-darker); border: 1px solid var(--primary-accent); }
        #placesList.grid-view { display: grid; gap: var(--space-sm); grid-template-columns: 1fr; } 
        .place-card, .deal-card { display: flex; gap: var(--space-sm); align-items: flex-start; cursor:pointer; animation: fadeIn 0.4s var(--ease-out-smooth); } 
        .place-card img, .deal-card img { width: clamp(50px, 13vw, 60px); height: clamp(50px, 13vw, 60px); border-radius: var(--border-radius-md); object-fit: cover; flex-shrink: 0;}
        .place-info, .deal-info { flex-grow:1; min-width: 0; }
        .place-info .name, .deal-info .name { font-weight: 600; margin-bottom: 4px; line-height: 1.3; font-size: clamp(0.9rem, 2.5vw, 0.95rem); white-space: nowrap; overflow: hidden; text-overflow: ellipsis;}
        .place-info .details, .deal-info .details { font-size: clamp(0.75rem, 2vw, 0.8rem); color: var(--text-secondary-color); line-height: 1.4; }
        .place-info .rating { color: #FFC107; }
        .place-info .tags { display: flex; flex-wrap: wrap; gap: 4px; margin-top: 4px; }
        .place-info .tags .tag { font-size: clamp(0.65rem, 1.8vw, 0.7rem); color: var(--primary-accent); background-color: var(--ai-suggestion-bg); padding: 2px 5px; border-radius: var(--border-radius-sm); }
        .deal-info .business { font-size:clamp(0.75rem, 2vw, 0.8rem); font-weight:500; color: var(--primary-accent); margin-top:3px;}
        .deal-info .expiry { font-size:clamp(0.7rem, 1.9vw, 0.75rem); color: var(--text-secondary-color); margin-top:3px;}
        .save-place-button { background:none; border:none; color: var(--text-secondary-color); font-size:clamp(1.1rem, 3vw, 1.2rem); cursor:pointer; padding:var(--space-xs); flex-shrink:0; transition: color 0.2s, transform 0.2s; }
        .save-place-button:active { transform: scale(0.8); }
        .save-place-button.saved { color: var(--primary-accent); }
        .ai-review-summary { font-size: clamp(0.75rem, 2vw, 0.8rem); font-style: italic; color: var(--primary-accent); margin-top: var(--space-xs); padding: var(--space-xs); background-color: var(--ai-suggestion-bg); border-radius: var(--border-radius-sm); border: 1px solid color-mix(in srgb, var(--primary-accent) 20%, transparent); }
        .ai-review-summary i { margin-right: var(--space-xs); }
        #aiExploreSuggestion.card { background-color: var(--ai-suggestion-bg); border: 1px solid color-mix(in srgb, var(--primary-accent) 40%, transparent); padding: var(--space-sm); transition: opacity 0.3s, transform 0.3s; }
        #aiExploreSuggestion .card-title { font-size: clamp(0.95rem, 2.6vw, 1rem); margin-bottom: var(--space-xs); }
        #aiExploreSuggestion .suggestion-action { font-size: clamp(0.8rem, 2.2vw, 0.85rem); padding: var(--space-xs) var(--space-sm); background-color: var(--primary-accent); color:white;}
        #aiExploreSuggestion .suggestion-action:active { background-color: var(--primary-accent-darker); }
        .bulletin-post-card { display: flex; flex-direction: column; gap: var(--space-xs); animation: fadeIn 0.4s var(--ease-out-smooth); }
        .bulletin-post-header { display: flex; align-items: center; gap: var(--space-sm); }
        .bulletin-post-avatar { width: clamp(36px, 10vw, 40px); height: clamp(36px, 10vw, 40px); border-radius: 50%; object-fit: cover; box-shadow: 0 2px 6px rgba(var(--shadow-color-rgb), 0.15); transition: transform 0.2s var(--ease-out-smooth), box-shadow 0.2s var(--ease-out-smooth); }
        .bulletin-post-avatar:hover { transform: scale(1.05); box-shadow: 0 4px 10px rgba(var(--shadow-color-rgb), 0.2); }
        .bulletin-post-meta .name { font-weight: 600; }
        .bulletin-post-meta .timestamp { font-size: clamp(0.7rem, 1.9vw, 0.75rem); color: var(--text-secondary-color); }
        .bulletin-post-body { font-size: clamp(0.9rem, 2.5vw, 0.95rem); line-height: 1.5; word-break: break-word; }
        .bulletin-post-actions { display: flex; gap: var(--space-md); margin-top: var(--space-sm); padding-top: var(--space-sm); border-top: 1px solid var(--placeholder-bg); }
        body.dark-mode .bulletin-post-actions { border-top-color: var(--warm-gray); }
        .bulletin-post-actions button { background: none; border: none; color: var(--text-secondary-color); cursor: pointer; font-size: clamp(0.8rem, 2.2vw, 0.85rem); transition: color 0.2s, transform 0.2s; }
        .bulletin-post-actions button:hover { color: var(--primary-accent); transform: scale(1.1); }
        .bulletin-post-actions button:active { transform: scale(1); }
        #communityChannelList { margin: 0 var(--space-md) var(--space-sm) var(--space-md); border-radius: var(--border-radius-lg); overflow: hidden; }
        .chat-section-header { padding: 0 var(--space-md); } 
        .channel-list-toggle { display: flex; gap: var(--space-xs); margin: 0 var(--space-md) var(--space-sm) var(--space-md); background-color: var(--placeholder-bg); padding: var(--space-xs); border-radius: var(--border-radius-md); overflow-x: auto; -webkit-overflow-scrolling: touch; }
        .channel-list-toggle::-webkit-scrollbar { display: none; }
        .channel-list-toggle button { flex: 1 0 auto; padding: var(--space-xs) var(--space-sm); border: none; border-radius: var(--border-radius-sm); background: none; font-weight: 500; color: var(--text-secondary-color); font-size: clamp(0.8rem, 2.2vw, 0.85rem); transition: background-color 0.2s, color 0.2s, box-shadow 0.2s; white-space: nowrap; }
        .channel-list-toggle button.active { background-color: var(--card-bg); color: var(--primary-accent); box-shadow: var(--element-shadow); }
        .channel-list .channel-item { display: flex; align-items: center; padding: var(--space-sm) var(--space-md); border-bottom: 1px solid var(--placeholder-bg); cursor: pointer; transition: background-color 0.2s; background: var(--card-bg); border:none; width: 100%; text-align:left; }
        body.dark-mode .channel-list .channel-item { border-bottom: 1px solid var(--warm-gray); }
        .channel-list .channel-item:last-child { border-bottom: none; }
        .channel-list .channel-item:hover { background-color: rgba(var(--shadow-color-rgb),0.03); }
        body.dark-mode .channel-list .channel-item:hover { background-color: rgba(255,255,255,0.03); }
        .channel-icon { width: clamp(40px, 11vw, 48px); height: clamp(40px, 11vw, 48px); border-radius: 50%; display: flex; justify-content: center; align-items: center; color: white; font-size: clamp(1.3rem, 4vw, 1.5rem); flex-shrink:0; margin-right: var(--space-sm); } 
        .channel-info-wrapper { display: flex; justify-content: space-between; align-items: center; flex-grow: 1; min-width: 0; }
        .channel-info { flex-grow: 1; min-width: 0; margin-right: var(--space-xs); }
        .channel-info .name { font-weight: 500; font-size: clamp(0.95rem, 2.6vw, 1rem); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; color: var(--text-color); margin-bottom: 2px;}
        body.dark-mode .channel-info .name { color: var(--text-color); }
        .channel-info .last-message { font-size: clamp(0.8rem, 2.2vw, 0.85rem); color: var(--text-secondary-color); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .channel-info .channel-type-indicator { display:none; } 
        .channel-actions-container { display: flex; flex-direction: column; align-items: flex-end; flex-shrink: 0; height: auto; gap: 4px; justify-content: flex-start; }
        .channel-actions-container .last-message-timestamp { font-size: clamp(0.7rem, 1.9vw, 0.75rem); color: var(--text-secondary-color); }
        .unread-badge { background-color: var(--primary-accent); color: white; font-size: clamp(0.65rem, 1.8vw, 0.7rem); padding: 3px 7px; border-radius: 10px; flex-shrink: 0; font-weight: 500;}
        .channel-favorite-icon { color: var(--text-secondary-color); font-size: clamp(1rem, 2.8vw, 1.1rem); padding: 0px; cursor: pointer; z-index: 1; transition: color 0.2s, transform 0.2s; } 
        .channel-favorite-icon:active { transform: scale(0.8); }
        .channel-favorite-icon.favorited { color: var(--favorite-color); }
        #chatScreenContainer { height: 100%; display: flex; flex-direction: column; }
        #specificChatView.active, #aiBottomSheet.active { position: absolute; top: 0; left: 0; right: 0; bottom: 0; width: 100%; height: 100%; display: flex; flex-direction: column; background-color: var(--chat-bg); z-index: 1002; animation: fadeIn 0.3s; opacity: 1; }
        #specificChatView .specific-chat-content, #aiBottomSheet .ai-chat-content { flex-grow: 1; display: flex; flex-direction: column; overflow: hidden; }
        #specificChatView .screen-header, #aiBottomSheet .screen-header { background-color: var(--card-bg); padding: clamp(6px, 1.8vw, 8px) clamp(8px, 2.2vw, 10px); box-shadow: var(--element-shadow); z-index: 10; flex-shrink: 0; }
        .chat-header-info { display: flex; align-items: center; flex-grow: 1; margin-left: var(--space-sm); min-width: 0; cursor: pointer; }
        .chat-header-avatar { width: clamp(36px, 10vw, 40px); height: clamp(36px, 10vw, 40px); border-radius: 50%; object-fit: cover; margin-right: var(--space-sm); }
        .chat-header-text { display: flex; flex-direction: column; flex-grow:1; min-width:0; }
        .chat-header-text .title { font-size: clamp(1rem, 2.8vw, 1.1rem) !important; margin-bottom: 0; }
        .chat-header-status { font-size: clamp(0.7rem, 1.9vw, 0.75rem); color: var(--chat-header-status-color); }
        .chat-header-actions { display: flex; align-items: center; }
        .chat-header-actions .action-button { margin-left: var(--space-xs); font-size: clamp(1rem, 2.8vw, 1.1rem); }
        .chat-messages-area, .ai-chat-area { flex-grow: 1; overflow-y: auto; padding: var(--space-sm); display: flex; flex-direction: column; gap: 2px; background-color: var(--chat-bg); overscroll-behavior: contain; -webkit-overflow-scrolling: touch; }
        .chat-date-separator { align-self: center; background-color: var(--chat-date-separator-bg); color: var(--chat-date-separator-text); padding: 4px var(--space-sm); border-radius: var(--border-radius-sm); font-size: clamp(0.7rem, 1.9vw, 0.75rem); font-weight: 500; margin: var(--space-sm) 0; box-shadow: var(--element-shadow); }
        .chat-message-wrapper { display: flex; margin-bottom: var(--space-xs); align-items: flex-end; max-width: 90%;}
        .chat-message-wrapper.user { justify-content: flex-end; margin-left: auto; }
        .chat-message-wrapper.other { justify-content: flex-start; margin-right: auto; }
        .chat-avatar { width: clamp(28px, 8vw, 32px); height: clamp(28px, 8vw, 32px); border-radius: 50%; object-fit: cover; flex-shrink: 0; box-shadow: var(--element-shadow); cursor: pointer; align-self: flex-end; }
        .chat-avatar.user-avatar { display: none; }
        .chat-avatar.other-avatar { margin-right: var(--space-xs); }
        .chat-bubble { padding: clamp(6px, 1.8vw, 8px) clamp(10px, 2.8vw, 12px); border-radius: var(--border-radius-md); max-width: 100%; font-size: clamp(0.9rem, 2.5vw, 0.95rem); line-height: 1.4; word-break: break-word; position:relative; animation: bubbleIn 0.35s var(--ease-out-bounce); box-shadow: 0 2px 4px rgba(var(--shadow-color-rgb), 0.1), 0 1px 2px rgba(var(--shadow-color-rgb), 0.08); display: flex; flex-direction: column; will-change: transform, opacity; }
        @keyframes bubbleIn { from { opacity:0; transform: scale(0.8) translateY(10px); } to { opacity:1; transform: scale(1) translateY(0); } }
        .chat-bubble::before { content: ""; position: absolute; bottom: 0px; width: 12px; height: 10px; }
        .chat-bubble.user { background-color: var(--chat-bubble-user-bg); color: white; border-bottom-right-radius: 4px; }
        .chat-bubble.user::before { right: -6px; background-color: var(--chat-bubble-user-bg); clip-path: polygon(100% 100%, 0 100%, 100% 0); }
        .chat-bubble.other { background-color: var(--chat-bubble-other-bg); color: var(--text-color); border-bottom-left-radius: 4px; }
        .chat-bubble.other::before { left: -6px; background-color: var(--chat-bubble-other-bg); clip-path: polygon(0 0, 0 100%, 100% 100%); }
        .chat-bubble.other.ai-intervention { background: linear-gradient(135deg, var(--ai-suggestion-bg), color-mix(in srgb, var(--ai-suggestion-bg) 95%, var(--primary-accent))); border: 1px solid color-mix(in srgb, var(--primary-accent) 20%, transparent); }
        .chat-bubble.other.ai-intervention::before { background-color: var(--ai-suggestion-bg); }
        body.dark-mode .chat-bubble.other { background-color: var(--chat-bubble-other-bg); }
        body.dark-mode .chat-bubble.other::before { background-color: var(--chat-bubble-other-bg); }
        body.dark-mode .chat-sender-name { color: color-mix(in srgb, var(--primary-accent) 80%, white); }
        .chat-sender-name { font-weight: 600; font-size: clamp(0.75rem, 2vw, 0.8rem); margin-bottom: 3px; display: block; color: var(--primary-accent); cursor: pointer;}
        .chat-bubble.user .chat-sender-name { display: none; }
        .chat-bubble-content { display: flex; align-items: flex-end; flex-wrap: wrap; }
        .chat-bubble-text { flex-grow: 1; padding-right: var(--space-xs); }
        .chat-bubble .button { font-size: clamp(0.8rem, 2.2vw, 0.85rem); padding: var(--space-xs) var(--space-sm); margin-top: var(--space-sm); background-color: rgba(255,255,255,0.2); color:white; }
        .chat-bubble.other .button { background-color: var(--primary-accent); }
        .message-meta { margin-left: auto; margin-top: 4px; font-size: clamp(0.65rem, 1.8vw, 0.7rem); line-height: 1; display: flex; align-items: center; align-self: flex-end; white-space: nowrap; padding-left: var(--space-xs); }
        .chat-bubble.user .message-meta .timestamp { color: var(--chat-user-timestamp-color); }
        .chat-bubble.other .message-meta .timestamp { color: var(--chat-timestamp-color); }
        .message-meta .status-ticks { margin-left: 3px; font-size: clamp(0.7rem, 1.9vw, 0.8rem); color: var(--chat-user-timestamp-color); }
        .chat-bubble.other .message-meta .status-ticks { display: none; } 
        .chat-message-actions { display: none; position: absolute; top: -25px; background-color: var(--card-bg); border-radius: var(--border-radius-sm); box-shadow: var(--element-shadow); padding: 3px; z-index: 10; gap: 3px; }
        .chat-message-wrapper:hover .chat-message-actions { display: flex; }
        .chat-message-actions button { background: none; border: none; color: var(--text-secondary-color); font-size: clamp(0.75rem, 2vw, 0.8rem); padding: 4px; cursor: pointer; }
        .chat-bubble.user .chat-message-actions { right: 5px; }
        .chat-bubble.other .chat-message-actions { left: 5px; }
        .chat-input-container { display: flex; padding: var(--space-sm) var(--space-sm) calc(var(--space-sm) + env(safe-area-inset-bottom)) var(--space-sm); align-items: flex-end; gap: var(--space-sm); flex-shrink: 0; }
        body.dark-mode .chat-input-container { border-top-color: var(--warm-gray); }
        .chat-input-wrapper { flex-grow: 1; display: flex; align-items: flex-end; background-color: var(--placeholder-bg); border-radius: var(--border-radius-lg); padding: clamp(2px, 1vw, 4px) var(--space-xs); min-height: clamp(40px, 11vw, 44px); }
        body.dark-mode .chat-input-wrapper { background-color: #2A2A2A; }
        .chat-input-wrapper .chat-icon-button { background: none; border: none; cursor: pointer; color: var(--text-secondary-color); font-size: clamp(1.2rem, 3.3vw, 1.3rem); padding: var(--space-xs); flex-shrink: 0; transition: opacity 0.2s, transform 0.2s; }
        .chat-input-wrapper.typing-active .chat-icon-button.hides-on-typing { opacity: 0; transform: scale(0.5); pointer-events: none; width: 0; padding: var(--space-xs) 0; }
        textarea.chat-input { flex-grow: 1; border: none; background: transparent; padding: clamp(8px, 2.5vw, 10px) var(--space-xs); font-size: clamp(0.9rem, 2.5vw, 1rem); line-height: 1.4; resize: none; max-height: 7.5rem; align-self: center; }
        textarea.chat-input:focus { outline: none; box-shadow: none; }
        .chat-input-action-button { background-color: var(--primary-accent); color: white; border: none; border-radius: 50%; width: clamp(40px, 11vw, 44px); height: clamp(40px, 11vw, 44px); font-size: clamp(1.2rem, 3.3vw, 1.3rem); cursor: pointer; display: flex; align-items: center; justify-content: center; flex-shrink: 0; transition: transform 0.2s var(--ease-out-smooth), background-color 0.2s; will-change: transform; }
        .chat-input-action-button:active { transform: scale(0.9); }
        .ai-chat-summary-button-container { padding: var(--space-xs) var(--space-md); text-align:center; background-color: var(--chat-bg); }
        .typing-indicator { font-style: italic; color: var(--text-secondary-color); padding: var(--space-xs) var(--space-md); font-size: clamp(0.8rem, 2.2vw, 0.85rem); transition: opacity 0.2s; background-color: var(--chat-bg); }
        .message-reactions { margin-top: var(--space-xs); display:flex; gap: 4px; align-self: flex-start; flex-wrap: wrap; }
        .chat-bubble.user .message-reactions { align-self: flex-end; justify-content: flex-end; }
        .reaction-button { background-color: color-mix(in srgb, var(--card-bg) 85%, transparent); border:1px solid var(--placeholder-bg); border-radius: var(--border-radius-lg); padding: 2px clamp(5px, 1.5vw, 7px); font-size:clamp(0.65rem, 1.8vw, 0.7rem); cursor:pointer; }
        .chat-bubble.user .reaction-button { background-color: color-mix(in srgb, var(--primary-accent) 80%, black 20%); color: rgba(255,255,255,0.9); border-color: transparent;}
        .reaction-button.reacted-by-user { background-color: var(--primary-accent); color:white; border-color: var(--primary-accent-darker);}
        body.dark-mode .reaction-button { background-color: #3e4042; border-color: #4a4c4e; }
        body.dark-mode .chat-bubble.user .reaction-button { background-color: color-mix(in srgb, var(--primary-accent) 90%, black 10%);}
        body.dark-mode .reaction-button.reacted-by-user { background-color: var(--primary-accent); border-color: var(--primary-accent-darker); }
        #mockUserSuggestionPopup { position: absolute; background-color: var(--card-bg); border: 1px solid var(--warm-gray); border-radius: var(--border-radius-sm); box-shadow: var(--element-shadow); z-index: 1100; padding: var(--space-xs); max-height: 120px; overflow-y: auto; bottom: calc(env(safe-area-inset-bottom) + 70px); left: var(--space-sm); right: var(--space-sm); width: auto; }
        .mock-user-suggestion-popup button { display: block; width: 100%; text-align: left; padding: var(--space-xs) var(--space-sm); background: none; border: none; cursor: pointer; border-radius: var(--border-radius-sm); font-size: clamp(0.85rem, 2.3vw, 0.9rem);}
        .mock-user-suggestion-popup button:hover { background-color: var(--placeholder-bg); }
        .ai-fab { position: fixed; bottom: calc(80px + env(safe-area-inset-bottom)); right: var(--space-md); width: clamp(50px, 13vw, 60px); height: clamp(50px, 13vw, 60px); background-color: var(--primary-accent); border-radius: 50%; display: flex; justify-content: center; align-items: center; color: white; font-size: clamp(1.5rem, 4.5vw, 1.8rem); box-shadow: var(--fab-shadow); cursor: pointer; z-index: 1001; transition: transform 0.4s var(--ease-out-smooth), background-color 0.2s, box-shadow 0.2s; border:none; will-change: transform, background-color; }
        .ai-fab:active { transform: scale(0.9) !important; background-color: var(--primary-accent-darker); box-shadow: var(--element-shadow); }
        .ai-fab.has-suggestion { animation: fab-pulse 1.5s infinite; }
        @keyframes fab-pulse { 0% { transform: scale(1); box-shadow: var(--fab-shadow); } 50% { transform: scale(1.1); box-shadow: 0 8px 25px 0 color-mix(in srgb, var(--info-color) 40%, transparent); } 100% { transform: scale(1); box-shadow: var(--fab-shadow); } }
        .ai-bottom-sheet { display: none; }
        .ai-bottom-sheet.active { display: flex; transform: translateY(0); opacity: 1; pointer-events: all; }
        #aiBottomSheet .ai-chat-content { height: 100%; }
        #aiBottomSheet .ai-chat-area { flex-grow: 1; }
        #aiBottomSheet .chat-input-container { flex-wrap: wrap; }
        #aiBottomSheet .chat-input-wrapper { background-color: var(--placeholder-bg); }
        body.dark-mode #aiBottomSheet .chat-input-wrapper { background-color: #2A2A2A; }
        .ai-chat-typing-suggestion { font-size: clamp(0.7rem, 1.9vw, 0.75rem); color: var(--text-secondary-color); width:100%; padding: 3px var(--space-xs) 0px var(--space-xs); height: 1.2em; text-align: left; flex-basis: 100%; }
        .ai-quick-actions-wrapper { position: sticky; top: 0; z-index: 5; padding: var(--space-sm) var(--space-md); }
        body.dark-mode .ai-quick-actions-wrapper { border-bottom-color: var(--warm-gray); }
        .ai-quick-actions { display: flex; gap: var(--space-xs); overflow-x: auto; scroll-snap-type: x mandatory; }
        .ai-quick-actions::-webkit-scrollbar { display: none; }
        .ai-quick-action-button { font-size:clamp(0.75rem, 2vw, 0.8rem); padding: var(--space-xs) clamp(6px, 1.8vw, 8px); background-color: var(--placeholder-bg); color:var(--text-color); border:none; border-radius: var(--border-radius-sm); cursor:pointer; transition: background-color 0.2s; white-space: nowrap; scroll-snap-align: start; }
        .ai-quick-action-button:hover { background-color: color-mix(in srgb, var(--placeholder-bg) 85%, black); }
        body.dark-mode .ai-quick-action-button { background-color: #444; }
        body.dark-mode .ai-quick-action-button:hover { background-color: #555; }
        .mood-log-container { display: flex; justify-content: flex-start; margin-bottom: var(--space-md); padding: var(--space-sm); background-color: var(--placeholder-bg); border-radius: var(--border-radius-md); overflow-x: auto; -webkit-overflow-scrolling: touch; scroll-snap-type: x mandatory;}
        .mood-log-container::-webkit-scrollbar { height: 6px; }
        .mood-log-container::-webkit-scrollbar-thumb { background: var(--text-secondary-color); border-radius: 3px; }
        .mood-emoji-button { font-size: clamp(1.8rem, 5.5vw, 2.2rem); cursor: pointer; transition: transform 0.2s var(--ease-out-bounce), opacity 0.2s; padding: var(--space-xs) clamp(6px, 1.8vw, 8px); opacity: 0.6; background:none; border:none; flex-shrink: 0; scroll-snap-align: center; }
        .mood-emoji-button:hover, .mood-emoji-button.selected { transform: scale(1.2); opacity: 1; }
        .mood-note-input { width: 100%; } 
        #habitListContainer { display: grid; gap: var(--space-sm); }
        .habit-card { display: flex; align-items: center; gap: clamp(0.5rem, 2vw, 1rem); background-color: var(--card-bg); border-radius: var(--border-radius-lg); padding: clamp(0.75rem, 2.5vw, 1rem); box-shadow: var(--element-shadow); }
        body.dark-mode .habit-card { background-color: var(--card-bg); }
        .habit-card .progress-ring-button { width: clamp(50px, 13vw, 56px); height: clamp(50px, 13vw, 56px); position: relative; cursor: pointer; background: none; border: none; padding: 0; flex-shrink: 0; transition: transform 0.2s var(--ease-out-bounce); }
        .habit-card .progress-ring-button:active { transform: scale(0.9); }
        .habit-card .progress-ring-circle { stroke-dasharray: 150.7; stroke-dashoffset: 150.7; stroke-linecap: round; transition: stroke-dashoffset 0.5s ease; }
        .habit-card .progress-ring-button .completion-check { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); font-size: clamp(1.2rem, 3.5vw, 1.4rem); color: var(--primary-accent); opacity: 0; transition: opacity 0.3s; }
        .habit-card .progress-ring-button.completed .completion-check { opacity: 1; }
        .habit-card .habit-info { flex-grow: 1; min-width: 0; }
        .habit-card .habit-name { font-weight: 600; font-size: clamp(0.9rem, 2.5vw, 1rem); margin-bottom: 3px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .habit-card .habit-meta { display: flex; align-items: center; flex-wrap: wrap; gap: var(--space-sm); font-size: clamp(0.75rem, 2vw, 0.8rem); color: var(--text-secondary-color); }
        .habit-card .habit-streak { display: inline-flex; align-items: center; gap: 4px; }
        .habit-card .habit-progress-info { font-weight: 500; color: var(--primary-accent); }
        .habit-card .habit-actions { display: flex; flex-direction: column; align-items: center; gap: var(--space-sm); }
        .habit-card .habit-action-button { color: var(--text-secondary-color); cursor: pointer; font-size: clamp(0.9rem, 2.5vw, 1rem); background: none; border: none; padding: 4px; }
        .habit-card .habit-action-button.delete { color: var(--danger-color); }
        .water-tracker-buttons { display:flex; gap: var(--space-xs); margin-top: var(--space-sm);}
        .water-add-button { font-size:clamp(0.75rem, 2vw, 0.8rem); padding: clamp(4px, 1.2vw, 6px) clamp(8px, 2.2vw, 10px);}
        .ai-wellness-insight { background-color: var(--ai-suggestion-bg); padding: var(--space-sm) var(--space-md); border-radius: var(--border-radius-md); font-size: clamp(0.8rem, 2.2vw, 0.85rem); margin-bottom: var(--space-sm); color: var(--text-color); border: 1px solid color-mix(in srgb, var(--primary-accent) 30%, transparent);}
        .ai-wellness-insight i { color: var(--primary-accent); margin-right: var(--space-xs);}
        #viewMoodCalendarButton { background-color: var(--primary-accent); color:white; font-weight: 500; }
        #viewMoodCalendarButton:active { background-color: var(--primary-accent-darker); }
        body.dark-mode #viewMoodCalendarButton { background-color: var(--primary-accent); color:white; }
        #aiPatternCard { background-color: var(--ai-suggestion-bg); border: 1px dashed var(--primary-accent); }
        .wellness-tools-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: var(--space-sm); margin-top: var(--space-sm); margin-bottom: var(--space-sm); }
        .wellness-tool-card { background-color: var(--card-bg); border: 1px solid var(--placeholder-bg); border-radius: var(--border-radius-lg); padding: var(--space-md); display: flex; flex-direction: column; align-items: center; justify-content: center; text-align: center; cursor: pointer; box-shadow: var(--card-shadow); transition: transform 0.2s var(--ease-out-smooth), box-shadow 0.2s var(--ease-out-smooth), border-color 0.2s; will-change: transform, box-shadow; min-height: 120px; }
        .wellness-tool-card:hover { transform: translateY(-4px); box-shadow: var(--card-shadow-hover); border-color: var(--primary-accent); }
        .wellness-tool-card:active { transform: scale(0.96) translateY(0px); box-shadow: var(--element-shadow); transition-duration: 0.1s; }
        body.dark-mode .wellness-tool-card { border-color: var(--warm-gray); }
        body.dark-mode .wellness-tool-card:hover { border-color: var(--primary-accent); }
        .wellness-tool-card i { font-size: clamp(1.6rem, 4.5vw, 1.8rem); color: var(--primary-accent); margin-bottom: var(--space-sm); }
        .wellness-tool-card .tool-title { font-weight: 600; color: var(--text-color); font-size: clamp(0.9rem, 2.5vw, 1rem); }
        .wellness-tool-card .tool-desc { font-size: clamp(0.75rem, 2vw, 0.8rem); color: var(--text-secondary-color); margin-top: 3px; }
        #guidedExerciseModal .modal-content { display: flex; flex-direction: column; height: 100%; padding: 0; justify-content: space-between; }
        .breathing-exercise-main { flex-grow: 1; display: flex; flex-direction: column; justify-content: center; align-items: center; padding: var(--space-md); }
        .breathing-exercise-controls { padding: var(--space-sm) var(--space-md) calc(var(--space-md) + env(safe-area-inset-bottom)); background-color: color-mix(in srgb, var(--card-bg) 80%, transparent); backdrop-filter: blur(10px); -webkit-backdrop-filter: blur(10px); border-top: 1px solid color-mix(in srgb, var(--text-color) 10%, transparent); display: flex; gap: var(--space-sm); }
        .breathing-exercise-presets { padding: var(--space-sm); display: flex; justify-content: center; gap: var(--space-sm); }
        #breathing-circle-container { position: relative; width: clamp(200px, 60vw, 250px); height: clamp(200px, 60vw, 250px); margin-bottom: var(--space-lg); }
        #breathing-circle, #breathing-glow { position: absolute; top: 0; left: 0; right: 0; bottom: 0; border-radius: 50%; transition: all 4s cubic-bezier(0.4, 0, 0.2, 1); }
        #breathing-glow { background-color: var(--primary-accent); opacity: 0.3; filter: blur(20px); }
        #breathing-circle { background-color: var(--primary-accent); display: flex; justify-content: center; align-items: center; transform: scale(0.5); }
        #breathing-instruction { color: white; font-size: clamp(1.2rem, 4vw, 1.8rem); font-weight: 500; transition: opacity 0.5s var(--ease-out-smooth); }
        #breathing-circle.inhale, #breathing-glow.inhale { transform: scale(1); background-color: var(--soft-blue); }
        #breathing-circle.exhale, #breathing-glow.exhale { transform: scale(0.5); background-color: var(--primary-accent); }
        .progress-dots { display: flex; gap: var(--space-sm); margin-top: var(--space-md); }
        .progress-dots .dot { width: 10px; height: 10px; border-radius: 50%; background-color: var(--warm-gray); transition: background-color 0.3s; }
        .progress-dots .dot.active { background-color: var(--primary-accent); }
        .gamification-badge { display: inline-flex; align-items: center; gap: var(--space-xs); background-color: var(--placeholder-bg); border-radius: var(--border-radius-md); padding: var(--space-xs) var(--space-sm); font-size: clamp(0.75rem, 2vw, 0.8rem); }
        .gamification-badge i { color: var(--favorite-color); }
        .xp-bar-container { width: 100%; background-color: var(--placeholder-bg); border-radius: 5px; height: 12px; overflow: hidden; margin-top: var(--space-xs); }
        .xp-bar { height: 100%; background: linear-gradient(135deg, var(--xp-color), color-mix(in srgb, var(--xp-color) 70%, #fff)); border-radius: 5px; transition: width 0.5s var(--ease-out-smooth); text-align: right; color: white; font-size: 0.6rem; line-height: 12px; padding-right: 4px; position: relative; overflow: hidden; }
        .xp-bar::after { content: ''; position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: linear-gradient(to right, rgba(255,255,255,0) 0%, rgba(255,255,255,0.4) 50%, rgba(255,255,255,0) 100%); animation: shine 2.5s infinite; }
        @keyframes shine { 0% { transform: translateX(-100%); } 100% { transform: translateX(100%); } }
        .settings-list .setting-item { display: flex; justify-content: space-between; align-items: center; padding: clamp(14px, 3.8vw, 18px) 0; border-bottom: 1px solid var(--placeholder-bg); cursor: pointer; transition: background-color 0.1s;}
        .settings-list .setting-item:hover { background-color: color-mix(in srgb, var(--primary-accent) 5%, transparent); }
        body.dark-mode .settings-list .setting-item { border-bottom: 1px solid var(--warm-gray); }
        body.dark-mode .settings-list .setting-item:hover { background-color: color-mix(in srgb, var(--primary-accent) 10%, var(--card-bg)); }
        .settings-list .setting-item:last-child { border-bottom: none; }
        .setting-item .setting-label { font-size: clamp(0.95rem, 2.6vw, 1rem); flex-grow: 1; margin-right: var(--space-sm); }
        .setting-item .setting-value, .setting-item i:not(.theme-color-dot) { color: var(--text-secondary-color); flex-shrink: 0; font-size: clamp(0.9rem, 2.5vw, 1rem);}
        .setting-item .toggle-switch-button { background:none; border:none; padding:0; cursor:pointer; flex-shrink: 0;}
        .setting-item .toggle-switch { width: 50px; height: 26px; background-color: var(--warm-gray); border-radius: 13px; position: relative;  transition: background-color 0.2s; display:inline-block; }
        .setting-item .toggle-switch.active { background-color: var(--primary-accent); }
        .setting-item .toggle-switch::before { content: ''; position: absolute; width: 22px; height: 22px; border-radius: 50%; background-color: white; top: 2px; left: 2px; transition: transform 0.2s var(--ease-out-bounce); box-shadow: 0 1px 3px rgba(0,0,0,0.2); }
        .setting-item .toggle-switch.active::before { transform: translateX(24px); }
        .modal .setting-item { padding: var(--space-sm) 0; }
        .modal .setting-item .setting-label { flex-grow: 1; margin-right: var(--space-sm); }
        .modal .setting-item .toggle-switch-button { flex-shrink: 0; }
        .theme-selector { display: flex; gap: var(--space-sm); }
        .theme-color-button { background:none; border:2px solid transparent; padding:0; border-radius:50%; cursor:pointer; transition: transform 0.2s, border-color 0.2s;}
        .theme-color-button:active { transform: scale(0.9); }
        .theme-color-dot { width: clamp(20px, 5.5vw, 24px); height: clamp(20px, 5.5vw, 24px); border-radius: 50%; box-shadow: var(--element-shadow); display:block;}
        .theme-color-button.active { border-color: var(--text-color); }
        .modal { display: none; position: fixed; z-index: 2000; left: 0; top: 0; width: 100%; height: 100svh; background-color: rgba(var(--shadow-color-rgb),0.3); backdrop-filter: blur(10px); -webkit-backdrop-filter: blur(10px); justify-content: center; align-items: center; padding: var(--space-md); }
        .modal.active { display: flex; animation: fadeInModal 0.4s var(--ease-out-smooth); }
        .modal-content { background-color: color-mix(in srgb, var(--card-bg) 85%, transparent); border: 1px solid color-mix(in srgb, var(--text-color) 10%, transparent); padding: var(--space-lg); border-radius: var(--border-radius-lg); box-shadow: 0 10px 30px rgba(var(--shadow-color-rgb),0.2); width: 100%; max-width: 400px; position: relative; animation: slideInModal 0.4s var(--ease-out-bounce); max-height: 85svh; overflow-y:auto; overscroll-behavior: contain; -webkit-overflow-scrolling: touch; will-change: transform, opacity; }
        body.dark-mode .modal-content { background-color: color-mix(in srgb, var(--card-bg) 80%, transparent); }
        .modal-close-button {
            position: absolute;
            top: clamp(8px, 2.2vw, 12px); right: clamp(8px, 2.2vw, 12px);
            font-size: clamp(1rem, 2.8vw, 1.1rem);
            color: var(--text-secondary-color);
            cursor: pointer; background: color-mix(in srgb, var(--bg-color) 80%, transparent);
            border: 1px solid var(--placeholder-bg);
            width: clamp(32px, 8vw, 36px); height: clamp(32px, 8vw, 36px);
            display: flex; align-items: center; justify-content: center;
            border-radius: 50%;
            transition: all 0.2s var(--ease-out-smooth);
        }
        .modal-close-button:hover { color: var(--text-color); background-color: var(--placeholder-bg); transform: scale(1.1); }
        body.dark-mode .modal-close-button { border-color: var(--warm-gray); }
        @keyframes fadeInModal { from { opacity: 0; } to { opacity: 1; } }
        @keyframes slideInModal { from { transform: translateY(-30px) scale(0.95); opacity: 0; } to { transform: translateY(0) scale(1); opacity: 1; } }
        .modal-title { font-size: clamp(1.2rem, 3.5vw, 1.3rem); font-weight: 600; margin-bottom: var(--space-sm); padding-right: 30px; }
        .modal-body p { margin-bottom: var(--space-sm); line-height: 1.5; font-size: clamp(0.9rem, 2.5vw, 1rem); }
        .modal-body ul { list-style-position: inside; padding-left: var(--space-xs); margin-bottom: var(--space-sm);}
        .modal-body li { margin-bottom: var(--space-xs); font-size: clamp(0.9rem, 2.5vw, 1rem); }
        .icon-selector { display:flex; flex-wrap:wrap; gap:var(--space-sm); margin-bottom:var(--space-sm); justify-content:center;}
        .icon-selector .icon-option { padding:var(--space-sm); border-radius:var(--border-radius-sm); border:1px solid var(--warm-gray); cursor:pointer; font-size:clamp(1.3rem, 4vw, 1.5rem); width:clamp(44px, 12vw, 50px); height:clamp(44px, 12vw, 50px); display:flex; align-items:center; justify-content:center; transition: background-color 0.2s, border-color 0.2s, transform 0.15s; }
        .icon-selector .icon-option:active { transform: scale(0.9); }
        .icon-selector .icon-option:hover, .icon-selector .icon-option.selected { background-color:var(--primary-accent); color:white; border-color:var(--primary-accent);}
        .rating-stars { margin-top:var(--space-xs); margin-bottom:var(--space-sm); }
        .rating-stars .fa-star { color: var(--warm-gray); cursor:pointer; font-size:clamp(1.3rem, 4vw, 1.5rem); margin:0 2px; transition: color 0.2s, transform 0.2s;}
        .rating-stars .fa-star:hover { transform: scale(1.2); }
        .rating-stars .fa-star.selected, .rating-stars .fa-star:hover, .rating-stars .fa-star:hover ~ .fa-star { color: #FFC107; }
        #notificationsModal .modal-content { max-height: 85svh; padding-bottom: 70px; }
        .notification-list { list-style: none; padding: 0; }
        .notification-item { display: flex; align-items: flex-start; padding: var(--space-sm) 0; border-bottom: 1px solid var(--placeholder-bg); }
        body.dark-mode .notification-item { border-bottom-color: var(--warm-gray); }
        .notification-item:last-child { border-bottom: none; }
        .notification-icon { font-size: clamp(1.1rem, 3vw, 1.2rem); color: var(--primary-accent); margin-right: var(--space-sm); width: 25px; text-align: center; margin-top: 3px; flex-shrink: 0;}
        .notification-content { flex-grow: 1; }
        .notification-title { font-weight: 600; font-size: clamp(0.9rem, 2.5vw, 0.95rem); margin-bottom: 3px; }
        .notification-text { font-size: clamp(0.8rem, 2.2vw, 0.85rem); color: var(--text-secondary-color); line-height: 1.4; }
        .notification-timestamp { font-size: clamp(0.65rem, 1.8vw, 0.7rem); color: var(--text-secondary-color); margin-top: var(--space-xs); }
        .notification-item.unread .notification-title { color: var(--primary-accent); font-weight: 700; }
        .notification-item .action-buttons { margin-top: var(--space-sm); display:flex; gap: var(--space-xs);}
        .toast-notification { position: fixed; bottom: var(--space-md); left: 50%; transform: translateX(-50%) translateY(20px) scale(0.9); background-color: rgba(30,30,30,0.75); backdrop-filter: blur(5px); -webkit-backdrop-filter: blur(5px); border: 1px solid rgba(255, 255, 255, 0.1); color: white; padding: clamp(10px, 2.8vw, 12px) clamp(16px, 4vw, 20px); border-radius: var(--border-radius-md); font-size: clamp(0.85rem, 2.3vw, 0.9rem); z-index: 3000; opacity: 0; transition: opacity 0.4s var(--ease-out-smooth), transform 0.4s var(--ease-out-bounce); pointer-events: none; box-shadow: 0 4px 10px rgba(var(--shadow-color-rgb),0.15); max-width: calc(100% - (2 * var(--space-md))); text-align: center; will-change: transform, opacity; }
        body.dark-mode .toast-notification { background-color: rgba(240,240,240,0.8); color: #333; border-color: rgba(0,0,0,0.1); }
        .toast-notification.show { opacity: 1; transform: translateX(-50%) translateY(0) scale(1); }
        .app-container:not(.full-page-active) .toast-notification.show { bottom: calc(var(--space-lg) + 80px + env(safe-area-inset-bottom)); }
        .toast-notification.ai-info-toast { background-color: var(--ai-info-toast-bg) !important; color:white !important; }
        body.dark-mode .toast-notification.ai-info-toast { background-color: var(--ai-info-toast-bg) !important; color:white !important; }
        #fullCalendarModal .modal-content { max-width: 95vw; width: 100%; height: 90svh; display: flex; flex-direction: column; }
        @media (min-width: 768px) { #fullCalendarModal .modal-content { max-width: 800px; } }
        .calendar-container { display: flex; flex-direction: column; height: 100%; flex-grow: 1; overflow: hidden; }
        .calendar-header { display: flex; justify-content: space-between; align-items: center; padding-bottom: var(--space-sm); }
        .calendar-grid { flex-grow: 1; display: grid; grid-template-columns: repeat(7, 1fr); grid-auto-rows: minmax(clamp(50px, 10vh, 80px), 1fr); gap: 2px; overflow-y: auto; overscroll-behavior: contain; -webkit-overflow-scrolling: touch;}
        .calendar-day-header { text-align: center; font-weight: 600; color: var(--text-secondary-color); font-size: clamp(0.7rem, 2vw, 0.8rem); padding-bottom: var(--space-xs);}
        .calendar-day { background-color: var(--placeholder-bg); border-radius: var(--border-radius-sm); padding: var(--space-xs); overflow-y: auto; cursor: pointer; display: flex; flex-direction: column; }
        .calendar-day.other-month { opacity: 0.4; }
        .calendar-day.today { border: 2px solid var(--primary-accent); }
        .calendar-day .day-number { font-weight: 500; font-size: clamp(0.7rem, 2vw, 0.8rem); margin-bottom: 2px; }
        .calendar-day .task-indicator { font-size: clamp(0.6rem, 1.7vw, 0.65rem); padding: 2px 4px; border-radius: 4px; margin-top: 3px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .calendar-day .mood-indicator { font-size: clamp(1rem, 3vw, 1.2rem); display: block; text-align: center; margin-top: var(--space-xs); }
        .day-detail-panel { margin-top: var(--space-sm); padding: var(--space-sm); background-color: var(--ai-suggestion-bg); border-radius: var(--border-radius-md); }
        .day-detail-panel h4 { font-size: clamp(0.95rem, 2.6vw, 1rem); }
        .day-detail-panel ul { list-style: none; padding-left: 0; }
        .habit-stat-item { margin-bottom: var(--space-sm); }
        .habit-stat-item .stat-title { font-weight: 500; font-size: clamp(0.85rem, 2.3vw, 0.9rem); }
        .progress-bar-container { width: 100%; background-color: var(--placeholder-bg); border-radius: 5px; height: 10px; overflow: hidden; margin-top: var(--space-xs); }
        .progress-bar { height: 100%; background-color: var(--primary-accent); border-radius: 5px; transition: width 0.5s var(--ease-out-smooth); }
        #arViewModal .modal-content { background: transparent; box-shadow: none; padding: 0; height: 100%; max-height: 100svh; }
        .ar-view-container { width: 100%; height: 100%; background: #333; position: relative; display: flex; flex-direction: column; justify-content: space-between; color: white; border-radius: var(--border-radius-lg); overflow:hidden; }
        .ar-view-container video { position: absolute; top:0; left:0; width:100%; height:100%; object-fit:cover; z-index:-1;}
        .ar-overlay { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); padding: var(--space-sm); background-color: rgba(0,0,0,0.6); border: 1px solid var(--primary-accent); border-radius: var(--border-radius-md); text-align: center; transition: opacity 0.5s; }
        .ar-overlay h4 { font-size: 1rem; margin-bottom: var(--space-xs);}
        .ar-ui-bottom { padding: var(--space-md); background: linear-gradient(transparent, rgba(0,0,0,0.7)); text-align: center; }
        #focusModeModal .modal-content { text-align: center; background: var(--bg-color); display: flex; flex-direction: column; justify-content: space-around; align-items: center; height: 100%; padding: var(--space-lg); }
        #focusSessionTimer { font-size: clamp(1.2rem, 4vw, 1.5rem); font-weight: 500; margin: var(--space-sm) 0; color: var(--text-color); line-height: 1.4; transition: opacity 0.5s; }
        #focusSessionTaskLabel { font-size: clamp(0.9rem, 3vw, 1.1rem); color: var(--text-secondary-color); max-width: 80%; }
        .focus-icon-container { position: relative; width: clamp(150px, 50vw, 220px); height: clamp(150px, 50vw, 220px); display: flex; justify-content: center; align-items: center; }
        .focus-icon-container .focus-circle { position: absolute; width: 100%; height: 100%; border-radius: 50%; border: 3px solid var(--primary-accent); opacity: 0.3; animation: pulse-focus-circle 4s infinite ease-in-out; }
        .focus-icon-container .focus-circle:nth-child(2) { animation-delay: 2s; }
        .focus-icon-container .focus-icon { font-size: clamp(3rem, 12vw, 4rem); color: var(--primary-accent); z-index: 1; }
        @keyframes pulse-focus-circle { 0% { transform: scale(0.8); opacity: 0; } 50% { opacity: 0.5; } 100% { transform: scale(1.2); opacity: 0; } }
        .focus-controls-container { display: flex; gap: var(--space-md); width: 100%; max-width: 300px; justify-content: center; flex-wrap: wrap; }
        #helpAboutModal .modal-content { text-align: left; }
        #helpAboutModal h4 { margin-top: var(--space-md); margin-bottom: var(--space-sm); font-weight: 600; color: var(--primary-accent); border-bottom: 1px solid var(--placeholder-bg); padding-bottom: var(--space-xs); }
        body.dark-mode #helpAboutModal h4 { border-bottom-color: var(--warm-gray); }
        #helpAboutModal ul { list-style-type: none; padding-left: 0; }
        #helpAboutModal li { display: flex; align-items: flex-start; margin-bottom: var(--space-sm); line-height: 1.4; }
        #helpAboutModal li::before { content: "\f058"; font-family: "Font Awesome 6 Free"; font-weight: 900; color: var(--success-color); margin-right: var(--space-sm); margin-top: 4px; font-size: 0.9em; }
        #emergencyDashboardModal .modal-content { background: linear-gradient(180deg, var(--card-bg) 70%, color-mix(in srgb, var(--danger-color) 10%, var(--card-bg))); }
        #emergencyDashboardModal .button { font-size: clamp(1rem, 3vw, 1.1rem); padding: var(--space-md); border-radius: var(--border-radius-md); box-shadow: 0 4px 10px rgba(var(--shadow-color-rgb), 0.15), 0 0 0 1px color-mix(in srgb, var(--text-color) 10%, transparent); transition: all 0.2s var(--ease-out-smooth); will-change: transform, box-shadow; }
        #emergencyDashboardModal .button:hover { transform: translateY(-3px); box-shadow: 0 7px 15px rgba(var(--shadow-color-rgb), 0.2); }
        #emergencyDashboardModal .button:active { transform: translateY(0px) scale(0.97); box-shadow: 0 2px 5px rgba(var(--shadow-color-rgb), 0.15); }
        #emergencyDashboardModal .button.danger { background: linear-gradient(145deg, var(--danger-color), #c62828); border: 1px solid rgba(255,255,255,0.2); animation: pulse-danger 2s infinite ease-in-out; }
        @keyframes pulse-danger { 0% { box-shadow: 0 0 0 0 color-mix(in srgb, var(--danger-color) 50%, transparent); } 70% { box-shadow: 0 0 0 10px color-mix(in srgb, var(--danger-color) 0%, transparent); } 100% { box-shadow: 0 0 0 0 color-mix(in srgb, var(--danger-color) 0%, transparent); } }
        .mb-1{margin-bottom:var(--space-xs)}.mb-2{margin-bottom:var(--space-sm)}.mb-3{margin-bottom:var(--space-md)}.mb-4{margin-bottom:var(--space-lg)}
        .mt-1{margin-top:var(--space-xs)}.mt-2{margin-top:var(--space-sm)}.mt-3{margin-top:var(--space-md)}.mt-4{margin-top:var(--space-lg)}
        .text-center{text-align:center}.hidden{display:none !important}
        .placeholder-box { background-color: var(--placeholder-bg); border-radius:var(--border-radius-md); padding:var(--space-md); color:var(--text-secondary-color); text-align:center; }
        .visually-hidden { position: absolute; width: 1px; height: 1px; padding: 0; margin: -1px; overflow: hidden; clip: rect(0, 0, 0, 0); border: 0; }
        #modalPlaceTags { display: flex; flex-wrap: wrap; gap: var(--space-sm); margin-bottom: var(--space-sm); }
        @media (max-width: 380px) { .habit-card { flex-direction: column; align-items: stretch; } .habit-card .habit-actions { flex-direction: row; justify-content: flex-end; } .habit-card .habit-info { text-align: center; } .habit-card .habit-meta { justify-content: center;} }
        @media (max-width: 360px) { .nav-item i { font-size: 1.15rem; } .mood-emoji-button { font-size: clamp(1.6rem, 5vw, 1.8rem); padding: 4px clamp(4px, 1.2vw, 5px); } .place-card img, .deal-card img { width: clamp(45px, 12vw, 50px); height: clamp(45px, 12vw, 50px); } .place-card, .deal-card { gap: var(--space-xs); } .card-title { font-size: clamp(1rem, 3vw, 1.1rem); } .task-title { font-size: clamp(0.85rem, 2.4vw, 0.9rem); } .pinned-widget-item .widget-value { font-size: clamp(0.8rem, 2.2vw, 0.85rem); } .ai-fab { width: 48px; height: 48px; font-size: 1.4rem; bottom: calc(65px + env(safe-area-inset-bottom)); right: var(--space-sm); } .calendar-grid { grid-auto-rows: auto; } .calendar-day .day-number { font-size: clamp(0.65rem, 1.8vw, 0.7rem); } }
        @media (min-width: 451px) { body { background-color: #E0E0E0; } body.dark-mode { background-color: #000; } .app-container { border-radius: var(--border-radius-lg); box-shadow: 0 10px 40px rgba(var(--shadow-color-rgb), 0.15); height: calc(100svh - 40px); max-height: 850px; margin: 20px auto; } .bottom-nav { border-bottom-left-radius: var(--border-radius-lg); border-bottom-right-radius: var(--border-radius-lg); } #specificChatView, #aiBottomSheet { left: auto; right: auto; border-radius: var(--border-radius-lg); } #specificChatView.active, #aiBottomSheet.active { height: 100%; } #placesList.grid-view { grid-template-columns: repeat(2, 1fr); } #pinnedWidgetsContainer { grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); } }
        @media (min-width: 768px) { .app-container { max-width: 600px; } .content { padding: var(--space-lg) var(--space-lg) calc(var(--space-xl) + 70px + env(safe-area-inset-bottom)) var(--space-lg); } #pinnedWidgetsContainer { grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); } .card-title { font-size: clamp(1.2rem, 3vw, 1.3rem); } }
    </style>
    <style>
    .place-info, .deal-info { overflow: hidden; }
    #communityChannelList, .channel-list-toggle, .chat-section-header { margin-left: 0; margin-right: 0; }
    @media (min-width: 451px) { .bottom-nav, .ai-fab, #specificChatView.active, #aiBottomSheet.active { position: absolute; } .bottom-nav { max-width: 100%; } .ai-fab { bottom: calc(var(--space-lg) + 70px + env(safe-area-inset-bottom)); right: var(--space-lg); } #placesList.grid-view { grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: var(--space-md); } }
    @media (min-width: 768px) { html { font-size: 17px; } .app-container { max-width: 720px; } .content { padding-left: var(--space-lg); padding-right: var(--space-lg); } .planner-actions-grid, .wellness-tools-grid { grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); } #pinnedWidgetsContainer { grid-template-columns: repeat(auto-fit, minmax(160px, 1fr)); } .modal-content { max-width: 600px; max-height: 90svh; } #fullCalendarModal .modal-content, #notificationsModal .modal-content { max-width: 90vw; height: 85svh; } }
    @media (min-width: 1024px) { html { font-size: 18px; } .app-container { max-width: 960px; } .screen { max-width: 840px; margin-left: auto; margin-right: auto; } #dashboard .screen-header, #chat .screen-header { max-width: none; } .filter-bar { flex-wrap: wrap; justify-content: center; padding-bottom: 0; margin-bottom: var(--space-lg); } .filter-button { margin-bottom: var(--space-xs); } .chat-message-wrapper { max-width: 70%; } }
    @media (min-width: 1280px) { .app-container { max-width: 1140px; } .screen { max-width: 980px; } .modal-content { max-width: 700px; } }

    #appletStoreContainer { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: var(--space-md); }
    .applet-card { background-color: var(--card-bg); border-radius: var(--border-radius-lg); box-shadow: var(--card-shadow); padding: var(--space-md); display: flex; flex-direction: column; text-align: left; transition: transform 0.2s var(--ease-out-smooth), box-shadow 0.2s var(--ease-out-smooth); }
    .applet-card:hover { transform: translateY(-4px); box-shadow: var(--card-shadow-hover); }
    .applet-header { display: flex; align-items: center; gap: var(--space-sm); margin-bottom: var(--space-sm); }
    .applet-icon { font-size: 1.8rem; width: 44px; height: 44px; display: flex; align-items: center; justify-content: center; border-radius: var(--border-radius-md); color: white; flex-shrink: 0; }
    .applet-title { font-weight: 600; font-size: 1.1rem; }
    .applet-desc { font-size: 0.9rem; color: var(--text-secondary-color); flex-grow: 1; line-height: 1.4; }
    .applet-ai-insight { font-size: 0.8rem; background-color: var(--ai-suggestion-bg); padding: var(--space-xs) var(--space-sm); border-radius: var(--border-radius-sm); margin-top: var(--space-sm); }
    .applet-actions { margin-top: var(--space-md); display: flex; justify-content: flex-end; align-items: center; }
    .install-button { position: relative; overflow: hidden; transition: all 0.3s var(--ease-out-smooth); width: 90px; height: 38px; }
    .install-button.loading { background-color: var(--warm-gray); color: transparent; cursor: default; }
    .install-button .loader { position: absolute; top: 50%; left: 50%; width: 20px; height: 20px; border: 2px solid rgba(255,255,255,0.5); border-top-color: white; border-radius: 50%; animation: spin 1s linear infinite; opacity: 0; transition: opacity 0.2s; transform: translate(-50%, -50%); }
    .install-button.loading .loader { opacity: 1; }
    @keyframes spin { to { transform: translate(-50%, -50%) rotate(360deg); } }
    
    .privacy-score-container { text-align: center; margin-bottom: var(--space-lg); }
    .privacy-score-dial { position: relative; width: 120px; height: 120px; margin: 0 auto var(--space-sm); }
    .privacy-score-dial svg { transform: rotate(-90deg); }
    .privacy-score-dial .dial-bg { fill: none; stroke: var(--placeholder-bg); stroke-width: 10; }
    .privacy-score-dial .dial-value { fill: none; stroke: var(--success-color); stroke-width: 10; stroke-linecap: round; transition: stroke-dashoffset 1s var(--ease-out-smooth), stroke 1s var(--ease-out-smooth); }
    .privacy-score-text { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); font-size: 1.5rem; font-weight: 700; }
    .data-usage-bar { display: flex; align-items: center; margin-bottom: var(--space-xs); font-size: 0.85rem; }
    .data-usage-bar .label { width: 100px; flex-shrink: 0; }
    .data-usage-bar .bar-container { flex-grow: 1; height: 10px; background-color: var(--placeholder-bg); border-radius: 5px; overflow: hidden; }
    .data-usage-bar .bar-fill { height: 100%; background-color: var(--primary-accent); border-radius: 5px; transition: width 0.5s var(--ease-out-smooth); }
    .ai-memory-item { display: flex; justify-content: space-between; align-items: center; padding: var(--space-sm) 0; border-bottom: 1px solid var(--placeholder-bg); }
    .ai-memory-text { flex-grow: 1; font-style: italic; }

    .subscription-tiers {
        display: grid;
        grid-template-columns: 1fr;
        gap: var(--space-md);
        margin-top: var(--space-md);
    }
    .tier-card {
        border: 2px solid var(--placeholder-bg);
        border-radius: var(--border-radius-lg);
        padding: var(--space-md);
        text-align: center;
        transition: all 0.3s var(--ease-out-smooth);
    }
    .tier-card.recommended {
        border-color: var(--primary-accent);
        transform: scale(1.05);
        box-shadow: var(--card-shadow-hover);
    }
    .tier-card.active-plan {
        background-color: var(--ai-suggestion-bg);
        border-color: var(--primary-accent);
    }
    .tier-card .tier-title {
        font-size: 1.3rem;
        font-weight: 700;
        color: var(--primary-accent);
    }
    .tier-card .tier-price {
        font-size: 1.8rem;
        font-weight: 600;
        margin: var(--space-xs) 0;
    }
    .tier-card .tier-price .period {
        font-size: 0.9rem;
        color: var(--text-secondary-color);
        font-weight: 400;
    }
    .tier-card .tier-features {
        list-style: none;
        padding: 0;
        margin: var(--space-md) 0;
        text-align: left;
    }
    .tier-card .tier-features li {
        margin-bottom: var(--space-sm);
        display: flex;
        align-items: center;
        gap: var(--space-sm);
    }
    .tier-card .tier-features li i {
        color: var(--success-color);
    }
    .tier-card .tier-features li.disabled {
        color: var(--text-secondary-color);
        text-decoration: line-through;
    }
     .tier-card .tier-features li.disabled i {
        color: var(--danger-color);
    }
    .file-upload-container {
        border: 2px dashed var(--warm-gray);
        border-radius: var(--border-radius-md);
        padding: var(--space-md);
        text-align: center;
        cursor: pointer;
        transition: background-color 0.2s;
        position: relative;
    }
    .file-upload-container:hover {
        background-color: var(--placeholder-bg);
    }
    .file-upload-container p {
        margin: 0;
    }
    .file-upload-container img.preview {
        max-width: 100px;
        max-height: 100px;
        margin-top: var(--space-sm);
        border-radius: var(--border-radius-sm);
    }
    #moodHabitTimelineContainer {
        overflow: hidden;
    }
    #moodHabitTimeline {
        display: flex;
        overflow-x: auto;
        gap: var(--space-sm);
        padding: var(--space-xs) 0 var(--space-sm) 0;
        scroll-snap-type: x mandatory;
        -webkit-overflow-scrolling: touch;
    }
    #moodHabitTimeline::-webkit-scrollbar {
        display: none;
    }
    .timeline-card {
        flex-shrink: 0;
        width: 100px;
        height: 100px;
        background-color: var(--placeholder-bg);
        border-radius: var(--border-radius-md);
        padding: var(--space-sm);
        cursor: pointer;
        transition: transform 0.2s, box-shadow 0.2s;
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
        text-align: center;
        scroll-snap-align: start;
    }
    .timeline-card:hover {
        transform: translateY(-2px);
        box-shadow: var(--element-shadow);
    }
    .timeline-card .icon {
        font-size: 1.8rem;
        margin-bottom: var(--space-xs);
    }
    .timeline-card .title {
        font-weight: 500;
        font-size: 0.8rem;
        line-height: 1.2;
    }
    .timeline-card .time {
        font-size: 0.7rem;
        color: var(--text-secondary-color);
    }
    #lockScreen {
        position: fixed;
        top: 0; left: 0; width: 100%; height: 100%;
        background-color: rgba(var(--shadow-color-rgb), 0.7);
        backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px);
        z-index: 9999;
        display: flex; flex-direction: column;
        align-items: center; justify-content: center;
        color: var(--text-color);
        animation: fadeInAuth 0.5s;
    }
    #lockScreen .auth-logo { font-size: 3rem; }
    #lockScreen p { font-size: 1.2rem; margin-top: var(--space-sm); }
    #lockScreen button { margin-top: var(--space-lg); }
    #siswatiTutorContent .quiz-mode-selection button { width: 100%; margin-bottom: var(--space-sm); }
    #siswatiTutorContent .quiz-score { text-align: right; font-weight: 600; color: var(--primary-accent); margin-bottom: var(--space-md); }
    </style>
</head>
<body>
    <div id="authContainer">
        <section id="loginScreen" class="auth-screen active" aria-labelledby="loginTitle">
            <i class="fas fa-street-view auth-logo" aria-hidden="true"></i>
            <h1 id="loginTitle" class="auth-title">Welcome to LocalLife OS</h1>
            <p class="auth-subtitle">Your community, connected.</p>
            <form id="loginForm" class="auth-form">
                <div class="input-group">
                    <label for="loginEmail" class="visually-hidden">Email or Username</label>
                    <input type="email" id="loginEmail" class="input-field" placeholder="Email or Username" required>
                </div>
                <div class="input-group">
                    <label for="loginPassword" class="visually-hidden">Password</label>
                    <input type="password" id="loginPassword" class="input-field" placeholder="Password" required>
                </div>
                <button type="button" class="button" onclick="handleLoginAttempt()">Login</button>
            </form>
            <a href="#" class="auth-link" onclick="showSignupScreen()">Don't have an account? Sign Up</a>
            <a href="#" class="auth-link" style="font-size:0.8rem; margin-top:10px;" onclick="openForgotPasswordModal()">Forgot Password?</a>
        </section>

        <section id="signupScreen" class="auth-screen" aria-labelledby="signupTitle">
            <i class="fas fa-user-plus auth-logo" aria-hidden="true"></i>
            <h1 id="signupTitle" class="auth-title">Create Account</h1>
            <p class="auth-subtitle">Join your local community.</p>
            <form id="signupForm" class="auth-form">
                <div class="input-group">
                    <label for="signupName" class="visually-hidden">Full Name</label>
                    <input type="text" id="signupName" class="input-field" placeholder="Full Name" required>
                </div>
                <div class="input-group">
                    <label for="signupEmail" class="visually-hidden">Email</label>
                    <input type="email" id="signupEmail" class="input-field" placeholder="Email Address" required>
                </div>
                <div class="input-group">
                    <label for="signupPassword" class="visually-hidden">Password</label>
                    <input type="password" id="signupPassword" class="input-field" placeholder="Create Password" required>
                </div>
                 <div class="input-group">
                    <label for="signupConfirmPassword" class="visually-hidden">Confirm Password</label>
                    <input type="password" id="signupConfirmPassword" class="input-field" placeholder="Confirm Password" required>
                </div>
                <button type="button" class="button" onclick="handleSignupAttempt()">Sign Up</button>
            </form>
            <a href="#" class="auth-link" onclick="showLoginScreen()">Already have an account? Login</a>
        </section>
    </div>
    
    <div class="app-container hidden">
        <div id="dynamicIslandAlert" role="alert">
            <span id="dynamicIslandIcon" class="icon"></span>
            <span id="dynamicIslandText" class="text"></span>
        </div>

        <main class="content">
            <section id="dashboard" class="screen active" aria-labelledby="dashboardTitle">
                <div class="screen-header">
                    <div class="title-group">
                        <p class="ai-greeting" id="aiGreeting">Good Morning, Shamase!</p>
                    </div>
                    <button class="action-button" onclick="openEmergencyDashboard()" aria-label="Open Emergency Dashboard" role="button">
                        <i class="fas fa-heart-pulse"></i>
                    </button>
                    <button class="action-button" onclick="showNotificationsPanel()" aria-label="View notifications" role="button">
                        <i class="fas fa-bell"></i>
                        <span id="unreadNotificationBadge" class="unread-notification-badge hidden">0</span>
                    </button>
                </div>
                <h2 id="dashboardTitle" class="card-subtitle mb-3" style="font-size: clamp(0.9rem, 2.5vw, 1rem); font-weight: 500;">Here's your LocalLife snapshot.</h2>

                <article class="card local-context-card no-press" id="localContextCard" aria-labelledby="localContextTitle">
                    <h3 id="localContextTitle" class="visually-hidden">Local Context</h3>
                    <div class="context-item"><i class="fas fa-clock" aria-hidden="true"></i> <span id="localTimeDate">--:-- --, ---, --- --</span></div>
                    <div class="context-item"><i class="fas fa-cloud-sun" aria-hidden="true"></i> <span id="currentWeather">Loading weather...</span></div>
                    <div class="context-item"><i class="fas fa-map-marker-alt" aria-hidden="true"></i> <span id="currentLocation">Fetching location...</span></div>
                </article>
                
                <div id="nearbyPulseSection">
                    <h3 class="card-title">Nearby Pulse</h3>
                    <div class="nearby-pulse-carousel" id="nearbyPulseCarousel" role="region" aria-label="Nearby local events and points of interest"></div>
                </div>

                <article class="card" id="newsSummaryCard" aria-labelledby="newsSummaryTitle">
                    <h3 id="newsSummaryTitle" class="card-title">AI Eswatini News Summary</h3>
                    <div id="newsSummaryContent"></div>
                </article>

                <article class="card" id="dashboardTaskListCard" aria-labelledby="dayViewTitle">
                    <h3 id="dayViewTitle" class="card-title">Dynamic Day View</h3>
                    <div id="dashboardTaskList" aria-live="polite"></div>
                    <div id="aiDashboardInsight" class="hidden"></div>
                     <button class="button button-secondary mt-2" style="width:100%; font-size:clamp(0.85rem, 2.3vw, 0.9rem);" onclick="setActiveScreen('planner')">View Full Planner</button>
                </article>
                
                <article class="card" id="pinnedWidgetsCard" aria-labelledby="pinnedWidgetsTitle">
                    <h3 id="pinnedWidgetsTitle" class="card-title">Pinned Widgets</h3>
                     <p class="card-subtitle" style="font-size:clamp(0.75rem, 2vw, 0.8rem); margin-top:-5px; margin-bottom:10px;"><em>AI auto-updates relevant info here. Configurable in Settings.</em></p>
                    <div id="pinnedWidgetsContainer" aria-live="polite">
                        <div class="skeleton-loader">
                            <div class="pinned-widget-item"><div class="skeleton-item title" style="width: 80%; height: 12px;"></div><div class="skeleton-item text" style="width: 60%; height: 10px;"></div></div>
                            <div class="pinned-widget-item"><div class="skeleton-item title" style="width: 70%; height: 12px;"></div><div class="skeleton-item text" style="width: 50%; height: 10px;"></div></div>
                        </div>
                    </div>
                </article>

                <article class="card" id="proactiveSuggestionsCard" aria-labelledby="suggestionsTitle">
                    <h3 id="suggestionsTitle" class="card-title">Smart Proactive Suggestions</h3>
                    <div id="proactiveSuggestionsContainer">
                        <p class="card-subtitle"><i class="fas fa-spinner fa-spin" style="color: var(--primary-accent);" aria-hidden="true"></i> AI is thinking of suggestions...</p>
                    </div>
                </article>
                
                <article class="card no-press" id="myAppletsCard">
                    <h3 class="card-title">My Applets</h3>
                    <div id="dashboardAppletsContainer"></div>
                </article>

                <article class="card" id="topDealsCard" aria-labelledby="topDealsTitle">
                    <h3 id="topDealsTitle" class="card-title">Today's Top Deals (AI Curated)</h3>
                    <div id="dashboardDealsList" aria-live="polite"></div>
                    <button class="button button-secondary mt-2" style="width:100%; font-size:clamp(0.85rem, 2.3vw, 0.9rem);" onclick="navigateToExploreDeals()">View More Deals in Explore</button>
                </article>
                
                <div class="safety-ticker" id="safetyTicker" role="alert" onclick="cycleSafetyTicker()">
                    <i class="fas fa-bullhorn" aria-hidden="true"></i>
                    <span id="safetyTickerText">Load shedding scheduled for Zone 3 from 6 PM - 8 PM.</span>
                    <button class="sos-button" onclick="event.stopPropagation(); openEmergencyDashboard()" aria-label="Trigger SOS">SOS</button>
                </div>
            </section>

            <section id="planner" class="screen" aria-labelledby="plannerTitle">
                <div class="screen-header">
                    <h2 id="plannerTitle" class="title">AI Daily Planner</h2>
                </div>
                <p class="card-subtitle mb-3">Manage your schedule effortlessly. AI helps parse tasks and suggests optimizations.</p>

                <article class="card" aria-labelledby="addTaskSectionTitle">
                    <h3 id="addTaskSectionTitle" class="visually-hidden">Add New Task</h3>
                    <div class="add-task-input-container">
                        <div class="input-group" style="flex-grow:1; margin-bottom:0;">
                            <label for="newTaskInput" class="visually-hidden">Add task input</label>
                            <input type="text" id="newTaskInput" class="input-field add-task-input" placeholder="e.g., 'Meet Thabo at The Gables tomorrow at 5pm'">
                            <button id="clearNewTaskInput" class="input-clear-btn hidden" onclick="clearInputField('newTaskInput', this)" aria-label="Clear new task input">&times;</button>
                        </div>
                        <button class="button voice-button" onclick="startVoiceRecognition('newTaskInput', addNewTask)" aria-label="Add task by voice"><i class="fas fa-microphone"></i></button>
                        <button class="button add-task-button" onclick="addNewTask()" aria-label="Add new task"><i class="fas fa-plus"></i></button>
                    </div>
                    <div id="aiPlannerSuggestion" class="ai-planner-suggestion hidden"></div>
                </article>

                <article class="card" aria-labelledby="scheduleTitle">
                    <h3 id="scheduleTitle" class="card-title">Today's Schedule</h3>
                    <div class="calendar-view-placeholder" id="calendarPlaceholder" aria-label="Mini calendar view"></div>
                    <ul class="task-list" id="taskList" aria-label="List of tasks"></ul>
                </article>
                <div class="planner-actions-grid" aria-label="Planner Tools">
                    <button class="planner-action-item primary" onclick="addNewTask()">
                        <i class="fas fa-plus-circle"></i>
                        <div class="action-text-content">
                            <span class="action-title">Add a New Task</span>
                            <span class="action-subtitle">Quickly create a to-do item. AI can parse details.</span>
                        </div>
                    </button>
                    <button class="planner-action-item primary" onclick="aiScheduleMyDay()">
                        <i class="fas fa-magic-wand-sparkles"></i>
                        <div class="action-text-content">
                            <span class="action-title">AI, Schedule My Day</span>
                            <span class="action-subtitle">Let AI organize today's tasks into a smart schedule.</span>
                        </div>
                    </button>
                    <button class="planner-action-item" onclick="openFullCalendar('tasks')">
                        <i class="fas fa-calendar-week"></i>
                        <div class="action-text-content">
                            <span class="action-title">Full Calendar</span>
                            <span class="action-subtitle">View your monthly schedule.</span>
                        </div>
                    </button>
                    <button class="planner-action-item" onclick="optimizeMyDay()">
                        <i class="fas fa-route"></i>
                         <div class="action-text-content">
                            <span class="action-title">Optimize Day</span>
                            <span class="action-subtitle">AI reorders tasks by priority.</span>
                        </div>
                    </button>
                    <button class="planner-action-item" onclick="getAIDayBrief()">
                        <i class="fas fa-comment-dots"></i>
                         <div class="action-text-content">
                            <span class="action-title">AI Day Brief</span>
                            <span class="action-subtitle">Get a quick verbal summary.</span>
                        </div>
                    </button>
                    <button class="planner-action-item" onclick="openAiItineraryModal()">
                        <i class="fas fa-map-marked-alt"></i>
                         <div class="action-text-content">
                            <span class="action-title">AI Itinerary</span>
                            <span class="action-subtitle">Let AI plan an outing for you.</span>
                        </div>
                    </button>
                </div>
            </section>

            <section id="explore" class="screen" aria-labelledby="exploreTitle">
                <div class="screen-header"><h2 id="exploreTitle" class="title">Explore Eswatini</h2></div>
                <p class="card-subtitle mb-3">Discover what's around you. AI provides personalized suggestions and live map updates.</p>

                <div class="search-bar-container">
                    <div class="input-group" style="flex-grow:1; margin-bottom:0;">
                        <label for="exploreSearchInput" class="visually-hidden">Search nearby places, events, and deals</label>
                        <input type="search" id="exploreSearchInput" class="input-field" placeholder="Search places, events, deals...">
                        <button id="clearExploreSearchInput" class="input-clear-btn hidden" onclick="clearInputField('exploreSearchInput', this); handleExploreSearch(true);" aria-label="Clear search input">&times;</button>
                    </div>
                    <button class="button voice-button" onclick="startVoiceRecognition('exploreSearchInput', handleExploreSearch)" aria-label="Search by voice"><i class="fas fa-microphone"></i></button>
                    <button class="button" onclick="handleExploreSearch()" aria-label="Submit search"><i class="fas fa-search"></i></button>
                </div>

                <div id="map-container">
                    <div class="map-actions">
                        <button class="map-action-button" onclick="openArView()" aria-label="Open Augmented Reality View"><i class="fas fa-camera"></i> AR View</button>
                        <button class="map-action-button" onclick="openAILayersModal()" aria-label="Open AI Map Layers"><i class="fas fa-layer-group"></i> AI Layers</button>
                    </div>
                </div>
                <div class="filter-bar" id="exploreFilterBar" role="tablist" aria-label="Filter places by category">
                    <button class="filter-button active" role="tab" aria-selected="true" data-filter="all" onclick="filterPlaces('all', this)">All Places</button>
                    <button class="filter-button" role="tab" aria-selected="false" data-filter="ai_recommended" onclick="filterPlaces('ai_recommended', this)"><i class="fas fa-wand-magic-sparkles" style="margin-right:5px;"></i>AI Picks</button>
                    <button class="filter-button" role="tab" aria-selected="false" data-filter="saved" onclick="filterPlaces('saved', this)">Saved</button>
                    <button class="filter-button" role="tab" aria-selected="false" data-filter="deals" onclick="filterPlaces('deals', this)">Deals</button>
                    <button class="filter-button" role="tab" aria-selected="false" data-filter="bulletin" onclick="filterPlaces('bulletin', this)">Bulletin</button>
                    <button class="filter-button" role="tab" aria-selected="false" data-filter="events" onclick="filterPlaces('events', this)">Events</button>
                    <button class="filter-button" role="tab" aria-selected="false" data-filter="food" onclick="filterPlaces('food', this)">Food</button>
                    <button class="filter-button" role="tab" aria-selected="false" data-filter="shops" onclick="filterPlaces('shops', this)">Shops</button>
                    <button class="filter-button" role="tab" aria-selected="false" data-filter="parks" onclick="filterPlaces('parks', this)">Nature</button>
                    <button class="filter-button" role="tab" aria-selected="false" data-filter="services" onclick="filterPlaces('services', this)">Services</button>
                    <button class="filter-button" role="tab" aria-selected="false" data-filter="open_now" onclick="filterPlaces('open_now', this)">Open Now</button>
                </div>
                <div id="aiExploreSuggestion" class="card hidden no-press">
                    <h4 class="card-title"><i class="fas fa-lightbulb"></i> AI Suggestion</h4>
                    <p id="aiExploreSuggestionText" class="card-subtitle" style="margin-bottom:10px;"></p>
                    <button class="button suggestion-action" id="aiExploreSuggestionAction">Sounds good!</button>
                </div>
                <div id="placesList" class="grid-view" aria-live="polite"></div>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: var(--space-sm); margin-top: var(--space-md);">
                    <button class="button button-secondary" onclick="openSubmitTipModal()"><i class="fas fa-plus-circle"></i> Add a Place/Tip</button>
                    <button class="button" onclick="openSubmitDealModal()"><i class="fas fa-tags"></i> Submit a Deal</button>
                </div>
                <button class="button mt-2" style="width:100%" onclick="openCreateBulletinPostModal()"><i class="fas fa-bullhorn"></i> Post to Bulletin</button>
                <p class="card-subtitle mt-2 text-center" style="font-size:clamp(0.75rem, 2vw, 0.8rem);"><em>LifeDNA learns your preferences for distance & rating over time.</em></p>
            </section>

            <section id="chat" class="screen" aria-labelledby="chatTitle">
                <div id="chatScreenContainer">
                    <div id="channelListView">
                        <div class="screen-header chat-section-header">
                            <div class="title-group"><h2 id="chatTitle" class="title">Local Community</h2></div>
                        </div>
                        <div class="channel-list-toggle">
                            <button id="showChannelsBtn" class="active" onclick="toggleChannelListType('channels', this)">Channels</button>
                            <button id="showDMsBtn" onclick="toggleChannelListType('dms', this)">Messages</button>
                            <button id="showFavoritesBtn" onclick="toggleChannelListType('favorites', this)">Favorites</button>
                            <button id="showRecentBtn" onclick="toggleChannelListType('recent', this)">Recent</button>
                        </div>
                        
                        <article class="card no-press" id="communityInsightsCard" style="margin: 0 var(--space-md) var(--space-sm) var(--space-md);">
                            <h3 class="card-title" style="font-size: 1rem;"><i class="fas fa-chart-line"></i> Community Insights (AI)</h3>
                            <div id="communityInsightsContent">
                                <p class="card-subtitle"><strong>Trending Topic:</strong> "Bushfire Festival" in #EswatiniEvents.</p>
                                <p class="card-subtitle"><strong>Community Vibe:</strong> <span style="color:var(--success-color);">Positive & Engaged</span></p>
                            </div>
                        </article>

                        <div class="channel-list" id="communityChannelList" aria-labelledby="channelsListTitle"></div>
                        <div style="padding: 0 var(--space-md);">
                            <button class="button mt-2" style="width:100%" onclick="openCreateChannelModal()"><i class="fas fa-plus-circle"></i> Create New Channel</button>
                            <button class="button button-secondary mt-2" style="width:100%" onclick="openNewMessageModal()"><i class="fas fa-paper-plane"></i> Start New Message</button>
                        </div>
                    </div>

                    <div id="specificChatView" class="hidden">
                        <div class="specific-chat-content">
                            <div class="screen-header">
                                <button class="back-button" onclick="showChannelListView()" aria-label="Go back to channel list"><i class="fas fa-arrow-left" aria-hidden="true"></i></button>
                                <div id="specificChatHeaderInfo" class="chat-header-info" onclick="showChannelDetailModal()">
                                    <img id="specificChatAvatar" src="" alt="Chat Avatar" class="chat-header-avatar" loading="lazy">
                                    <div class="chat-header-text">
                                        <h2 id="specificChatTitle" class="title">Channel Name</h2>
                                        <span id="specificChatStatus" class="chat-header-status">Tap for info</span>
                                    </div>
                                </div>
                                <div class="chat-header-actions">
                                    <button class="action-button" onclick="window.location.href='tel:999'" aria-label="Voice Call"><i class="fas fa-phone"></i></button>
                                    <button class="action-button" onclick="showToast('Video call started.', 'info')" aria-label="Video Call"><i class="fas fa-video"></i></button>
                                    <button class="action-button" onclick="showChannelDetailModal()" aria-label="View channel info and actions"><i class="fas fa-info-circle"></i></button>
                                </div>
                            </div>
                            <div id="aiChatSummaryButtonContainer" class="ai-chat-summary-button-container hidden"></div>
                            <div class="chat-messages-area" id="specificChatMessagesArea" aria-live="polite"></div>
                            <div id="typingIndicatorArea" class="typing-indicator hidden" aria-live="polite"></div>
                            <div class="chat-input-container">
                                <div class="chat-input-wrapper">
                                    
                                    <textarea id="specificChatInput" class="input-field chat-input" placeholder="Message" aria-label="Chat message input" rows="1" oninput="autoGrowTextarea(this); handleChatInputTyping(this, 'specific');"></textarea>
                                    <button id="specificChatAttachBtn" class="chat-icon-button hides-on-typing" onclick="native.filePicker('specific')" aria-label="Attach file"><i class="fas fa-paperclip"></i></button>
                                    <button id="specificChatCameraBtn" class="chat-icon-button hides-on-typing" onclick="native.filePicker('specific', true)" aria-label="Take a photo"><i class="fas fa-camera"></i></button>
                                </div>
                                <button id="specificChatActionBtn" class="chat-input-action-button" onclick="native.speechToText('specific')" aria-label="Use voice input">
                                    <i id="specificChatActionIcon" class="fas fa-microphone" aria-hidden="true"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </section>

            <section id="wellness" class="screen" aria-labelledby="wellnessTitle">
                <div class="screen-header">
                     <div class="title-group"><h2 id="wellnessTitle" class="title">Wellness Hub</h2></div>
                     <div id="wellnessGamification" class="gamification-badge">
                        <i class="fas fa-shield-alt"></i>
                        <span>Lvl <span id="wellnessLevel">1</span></span>
                     </div>
                </div>
                <p class="card-subtitle mb-3">Track your well-being. AI provides insights and personalized suggestions.</p>
                <div id="aiWellnessInsight" class="ai-wellness-insight hidden"></div>

                <article class="card" id="aiPatternCard" aria-labelledby="aiPatternCardTitle" style="display: none;">
                    <h3 id="aiPatternCardTitle" class="card-title" style="font-size: clamp(0.95rem, 2.6vw, 1rem);"><i class="fas fa-brain"></i> AI Pattern Detected</h3>
                    <p id="aiPatternText" class="card-subtitle"></p>
                </article>
                

                <article class="card" aria-labelledby="moodLogCardTitle">
                    <h3 class="card-title" id="moodLogCardTitle">How are you feeling today?</h3>
                    <div class="mood-log-container" id="moodSelector" role="radiogroup" aria-labelledby="moodLogCardTitle">
                        <button class="mood-emoji-button" data-mood="" onclick="selectMood(this)" aria-label="Sad mood"><span role="img" aria-label="Sad face emoji"></span></button>
                        <button class="mood-emoji-button" data-mood="" onclick="selectMood(this)" aria-label="Slightly sad mood"><span role="img" aria-label="Slightly sad face emoji"></span></button>
                        <button class="mood-emoji-button" data-mood="" onclick="selectMood(this)" aria-label="Neutral mood"><span role="img" aria-label="Neutral face emoji"></span></button>
                        <button class="mood-emoji-button" data-mood="" onclick="selectMood(this)" aria-label="Slightly happy mood"><span role="img" aria-label="Slightly happy face emoji"></span></button>
                        <button class="mood-emoji-button" data-mood="" onclick="selectMood(this)" aria-label="Happy mood"><span role="img" aria-label="Happy face emoji"></span></button>
                         <button class="mood-emoji-button" data-mood="" onclick="selectMood(this)" aria-label="Excited mood"><span role="img" aria-label="Excited face emoji"></span></button>
                         <button class="mood-emoji-button" data-mood="" onclick="selectMood(this)" aria-label="Relaxed mood"><span role="img" aria-label="Relaxed face emoji"></span></button>
                    </div>
                    <div class="add-task-input-container" style="margin-bottom:0;">
                         <label for="moodNoteInput" class="visually-hidden">Optional note for mood</label>
                         <textarea id="moodNoteInput" class="input-field mood-note-input" rows="2" placeholder="Add a note (AI can analyze this...)"></textarea>
                         <button class="button voice-button" onclick="startVoiceRecognition('moodNoteInput')" aria-label="Add mood note by voice"><i class="fas fa-microphone"></i></button>
                    </div>
                    <button class="button mt-2" style="width:100%;" onclick="logMood()">Log Mood</button>
                </article>

                <article class="card" id="sleepTrackerCard" aria-labelledby="sleepTrackerTitle">
                    <h3 id="sleepTrackerTitle" class="card-title">Sleep & Screen Time</h3>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: var(--space-sm);">
                        <div class="input-group" style="margin-bottom: 0;">
                            <label for="sleepHoursInput">Sleep (hours)</label>
                            <input type="number" id="sleepHoursInput" class="input-field" placeholder="e.g., 7.5">
                        </div>
                        <div class="input-group" style="margin-bottom: 0;">
                            <label for="screenTimeInput">Screen Time (hours)</label>
                            <input type="number" id="screenTimeInput" class="input-field" placeholder="e.g., 4">
                        </div>
                    </div>
                    <button class="button mt-2" style="width:100%;" onclick="logSleepAndScreenTime()">Log Today's Data</button>
                    <p class="card-subtitle mt-2 text-center" style="font-size: clamp(0.7rem, 1.9vw, 0.75rem);">AI can analyze this data for patterns.</p>
                </article>

                <article class="card habit-tracker" aria-labelledby="habitTrackerTitle">
                    <h3 id="habitTrackerTitle" class="card-title">Habit Tracker</h3>
                    <div id="habitListContainer" aria-live="polite"></div>
                    <button class="button button-secondary mt-2" style="width:100%;" onclick="openCreateHabitModal()"><i class="fas fa-plus-circle"></i> Add New Habit</button>
                    <button class="button button-secondary mt-2" style="width:100%;" onclick="openHabitStatsModal()"><i class="fas fa-chart-line"></i> View Habit Stats</button>
                </article>
                 <article class="card" aria-labelledby="aiWellnessToolsTitle">
                    <h3 id="aiWellnessToolsTitle" class="card-title">AI Insights & Tools</h3>
                    <p class="card-subtitle" id="journalPromptStaticText">AI Reflection: "What's one small thing that brought you joy today, and how can you invite more of it into your week?"</p>
                    <div class="wellness-tools-grid">
                        <button class="wellness-tool-card" onclick="openJournalModal()">
                            <i class="fas fa-feather-alt"></i>
                            <span class="tool-title">Journal Response</span>
                            <span class="tool-desc">Reflect on AI prompts.</span>
                        </button>
                        <button class="wellness-tool-card" onclick="showAIWellnessSummaryModal()">
                            <i class="fas fa-brain"></i>
                            <span class="tool-title">AI Summary</span>
                            <span class="tool-desc">Get wellness insights.</span>
                        </button>
                        <button class="wellness-tool-card" onclick="openGuidedExerciseModal()">
                            <i class="fas fa-spa"></i>
                            <span class="tool-title">Guided Breathing</span>
                            <span class="tool-desc">Relax or focus.</span>
                        </button>
                        <button class="wellness-tool-card" onclick="openFocusModeModal()">
                            <i class="fas fa-stopwatch-20"></i>
                            <span class="tool-title">Mindful Focus</span>
                            <span class="tool-desc">Start a focused session.</span>
                        </button>
                    </div>
                    <div id="moodHabitTimelineContainer" class="mt-3">
                        <h4 style="font-size:clamp(0.9rem, 2.5vw, 1rem); margin-bottom:var(--space-sm); color:var(--text-color);">Today's Timeline</h4>
                        <div id="moodHabitTimeline">No entries yet for today.</div>
                        <button id="viewMoodCalendarButton" class="button mt-2" style="font-size:clamp(0.75rem, 2vw, 0.8rem); padding: var(--space-xs) var(--space-sm);" onclick="openFullCalendar('moods')"><i class="fas fa-calendar-alt"></i> View Mood Calendar</button>
                    </div>
                </article>
            </section>

            <section id="settings" class="screen" aria-labelledby="settingsTitle">
                <div class="screen-header"><h2 id="settingsTitle" class="title">Settings</h2></div>
                <p class="card-subtitle mb-3">Customize your LocalLife OS. Fine-tune AI behavior and app preferences.</p>

                <article class="card settings-list no-press" aria-label="Application Settings">
                     <div class="setting-item" role="button" tabindex="0" onclick="openUserProfileModal()" onkeypress="if(event.key==='Enter') openUserProfileModal()">
                        <span class="setting-label">My Profile & Account</span><i class="fas fa-user-circle" aria-hidden="true"></i>
                    </div>
                    <div class="setting-item" role="button" tabindex="0" onclick="setActiveScreen('appStore')" onkeypress="if(event.key==='Enter') setActiveScreen('appStore')">
                        <span class="setting-label">Applets & Modules</span><i class="fas fa-th-large" aria-hidden="true"></i>
                    </div>
                    <div class="setting-item" role="button" tabindex="0" onclick="openTrustedCircleModal()" onkeypress="if(event.key==='Enter') openTrustedCircleModal()">
                        <span class="setting-label">Trusted Circle & Safety</span><i class="fas fa-users" aria-hidden="true"></i>
                    </div>
                    <div class="setting-item">
                        <span class="setting-label">AI Personality</span>
                        <select id="aiPersonalitySelect" class="input-field" style="width:auto; padding: var(--space-xs); margin-bottom:0; font-size: clamp(0.85rem, 2.3vw, 0.9rem);" onchange="changeAIPersonality(this.value)" aria-label="Select AI Assistant Personality">
                            <option value="neutral">Neutral</option>
                            <option value="friendly">Friendly</option>
                            <option value="professional">Professional</option>
                            <option value="witty">Witty (Pro)</option>
                            <option value="coach">Calm Coach (Pro)</option>
                            <option value="mentor">Business Mentor (Pro)</option>
                        </select>
                    </div>
                    <div class="setting-item" role="button" tabindex="0" onclick="openAILearningPrefsModal()" onkeypress="if(event.key==='Enter') openAILearningPrefsModal()">
                        <span class="setting-label">AI Learning Preferences</span><i class="fas fa-brain" aria-hidden="true"></i>
                    </div>
                    <div class="setting-item">
                        <span class="setting-label" id="darkModeLabel">Dark Mode</span>
                        <button class="toggle-switch-button" id="darkModeToggleContainer" onclick="toggleDarkMode()" aria-labelledby="darkModeLabel" role="switch" aria-checked="false">
                             <span class="toggle-switch" id="darkModeToggleVisual"></span>
                        </button>
                    </div>
                    <div class="setting-item">
                        <span class="setting-label">Theme Accent</span>
                        <div class="theme-selector" role="radiogroup" aria-label="Select theme accent color">
                            <button class="theme-color-button active" onclick="changeThemeAccent('#4DB6AC', this)" aria-label="Teal theme" role="radio" aria-checked="true"><i class="fas fa-circle theme-color-dot" style="color: #4DB6AC;" aria-hidden="true"></i></button>
                            <button class="theme-color-button" onclick="changeThemeAccent('#64B5F6', this)" aria-label="Blue theme" role="radio" aria-checked="false"><i class="fas fa-circle theme-color-dot" style="color: #64B5F6;" aria-hidden="true"></i></button>
                             <button class="theme-color-button" onclick="changeThemeAccent('#FFB74D', this)" aria-label="Orange theme" role="radio" aria-checked="false"><i class="fas fa-circle theme-color-dot" style="color: #FFB74D;" aria-hidden="true"></i></button>
                            <button class="theme-color-button" onclick="changeThemeAccent('#E07A5F', this)" aria-label="Terracotta theme" role="radio" aria-checked="false"><i class="fas fa-circle theme-color-dot" style="color: #E07A5F;" aria-hidden="true"></i></button>
                            <button class="theme-color-button" onclick="changeThemeAccent('#9CCC65', this)" aria-label="Light Green theme" role="radio" aria-checked="false"><i class="fas fa-circle theme-color-dot" style="color: #9CCC65;" aria-hidden="true"></i></button>
                        </div>
                    </div>
                    <div class="setting-item" role="button" tabindex="0" onclick="openDashboardCustomizationModal()" onkeypress="if(event.key==='Enter') openDashboardCustomizationModal()">
                        <span class="setting-label">Customize Dashboard</span><i class="fas fa-tachometer-alt" aria-hidden="true"></i>
                    </div>
                     <div class="setting-item" role="button" tabindex="0" onclick="openNotificationSettingsModal()" onkeypress="if(event.key==='Enter') openNotificationSettingsModal()">
                        <span class="setting-label">Notification Preferences</span><i class="fas fa-bell" aria-hidden="true"></i>
                    </div>
                     <div class="setting-item" role="button" tabindex="0" onclick="setActiveScreen('privacyDashboard')">
                        <span class="setting-label">Privacy & Data Controls</span><i class="fas fa-user-secret" aria-hidden="true"></i>
                    </div>
                    <div class="setting-item" role="button" tabindex="0" onclick="openIntegrationSettingsModal()">
                        <span class="setting-label">Integrations & Connected Apps</span><i class="fas fa-link"></i>
                    </div>
                    <div class="setting-item" role="button" tabindex="0" onclick="openSubscriptionModal()" onkeypress="if(event.key==='Enter') openSubscriptionModal()">
                        <span class="setting-label">Subscription: <span id="subscriptionStatus" style="color:var(--primary-accent); font-weight:bold;">Pro Tier</span></span>
                        <span class="setting-value">Manage</span>
                    </div>
                     <div class="setting-item" role="button" tabindex="0" onclick="openHelpAboutModal()" onkeypress="if(event.key==='Enter') openHelpAboutModal()">
                        <span class="setting-label">Help & About</span><i class="fas fa-question-circle" aria-hidden="true"></i>
                    </div>
                     <div class="setting-item" role="button" tabindex="0" onclick="openFeedbackModal()">
                        <span class="setting-label">Assist & Report a Bug</span><i class="fas fa-bug"></i>
                    </div>
                     <div class="setting-item" role="button" tabindex="0" onclick="handleLogout()" onkeypress="if(event.key==='Enter') handleLogout()">
                        <span class="setting-label" style="color: var(--danger-color);">Log Out</span>
                        <i class="fas fa-sign-out-alt" style="color: var(--danger-color);" aria-hidden="true"></i>
                    </div>
                     <div class="setting-item" role="button" tabindex="0" onclick="clearAllDataWithConfirmation()" onkeypress="if(event.key==='Enter') clearAllDataWithConfirmation()">
                        <span class="setting-label" style="color: var(--danger-color);">Clear All My Data (Reset App)</span>
                        <i class="fas fa-trash-restore" style="color: var(--danger-color);" aria-hidden="true"></i>
                    </div>
                </article>
                 <article class="card text-center no-press">
                    <p class="card-subtitle">LocalLife OS v12.0 <span class="gamification-badge" style="background:var(--ai-suggestion-bg); font-weight:bold;">Beta</span></p>
                    <p class="card-subtitle">Made with <i class="fas fa-heart" style="color: var(--muted-terracotta);"></i> for local life, supercharged by AI.</p>
                    <p class="card-subtitle" style="font-size:clamp(0.7rem, 1.9vw, 0.75rem);">Monetization: Pro Tier for advanced AI, featured business listings, service marketplace commissions.</p>
                </article>
            </section>
            
            <section id="servicesMarket" class="screen" aria-labelledby="servicesMarketTitle">
                <div class="screen-header"><h2 id="servicesMarketTitle" class="title">Local Services Marketplace</h2></div>
                <p class="card-subtitle mb-3">Find or offer local services. AI can help match providers with seekers.</p>
                 <div class="empty-state">
                    <i class="fas fa-handshake-angle fa-3x"></i>
                    <p>Local Services Marketplace coming soon!</p>
                    <p class="card-subtitle mt-2" style="font-size:clamp(0.8rem, 2.2vw, 0.85rem);">Here you could connect with locals for services like home repairs, tutoring, event planning, and traditional crafts. AI-powered matching, reputation system, and secure payments.</p>
                     <button class="button mt-2" onclick="showToast('AI: Searching for \'Electricians in Manzini\' (Marketplace search).', 'ai_info')"><i class="fas fa-search"></i> AI: Find me an Electrician</button>
                </div>
            </section>

            <section id="governance" class="screen" aria-labelledby="governanceTitle">
                <div class="screen-header"><h2 id="governanceTitle" class="title">Civic Engagement Hub</h2></div>
                <p class="card-subtitle mb-3">Connect with local governance. AI can summarize meeting notes or proposals.</p>
                <div class="empty-state">
                    <i class="fas fa-landmark-flag fa-3x"></i>
                    <p>Local Governance & Civic Engagement module coming soon!</p>
                    <p class="card-subtitle mt-2" style="font-size:clamp(0.8rem, 2.2vw, 0.85rem);">This hub could provide information on local chiefdoms (Tinkhundla), upcoming community meetings, and public forums. AI could summarize public announcements, or help citizens draft inquiries to local authorities.</p>
                    <button class="button mt-2" onclick="showToast('AI: Summarizing latest Mbabane City Council meeting minutes...', 'ai_info')"><i class="fas fa-file-alt"></i> AI: Summarize Last Meeting</button>
                </div>
            </section>

            <section id="appStore" class="screen" aria-labelledby="appStoreTitle">
                <div class="screen-header">
                     <button class="back-button" onclick="setActiveScreen('settings')" aria-label="Go back to settings"><i class="fas fa-arrow-left" aria-hidden="true"></i></button>
                    <h2 id="appStoreTitle" class="title">Applets & Modules</h2>
                </div>
                <p class="card-subtitle mb-3">Enhance your LocalLife experience by installing modular applets. AI can help you discover applets you'll love.</p>
                
                <div id="appletStoreContainer"></div>
            </section>

            <section id="privacyDashboard" class="screen" aria-labelledby="privacyDashboardTitle">
                <div class="screen-header">
                    <button class="back-button" onclick="setActiveScreen('settings')" aria-label="Go back to settings"><i class="fas fa-arrow-left" aria-hidden="true"></i></button>
                    <h2 id="privacyDashboardTitle" class="title">Privacy Dashboard</h2>
                </div>
                <p class="card-subtitle mb-3">Your data is yours. Here's a transparent look at how it's used to enhance your experience.</p>
                
                <div id="privacyDashboardContent"></div>
            </section>
            
            <div id="mockUserSuggestionPopup" class="mock-user-suggestion-popup hidden"></div>
        </main>

        <button class="ai-fab" id="aiFab" onclick="toggleAIChat()" aria-label="Open AI Assistant" aria-expanded="false">
            <i id="aiFabIcon" class="fas fa-brain" aria-hidden="true"></i>
        </button>

        <div class="ai-bottom-sheet" id="aiBottomSheet" role="dialog" aria-modal="true" aria-labelledby="aiAssistantTitle">
            <div class="ai-chat-content">
                <div class="screen-header" style="padding: var(--space-sm) var(--space-md); border-bottom: 1px solid var(--placeholder-bg); flex-shrink: 0;">
                    <div class="title-group">
                         <button class="back-button" onclick="toggleAIChat()" aria-label="Close AI Assistant"><i class="fas fa-times" aria-hidden="true"></i></button>
                        <h2 id="aiAssistantTitle" class="title">LocalLife AI</h2>
                    </div>
                </div>
                <div class="ai-quick-actions-wrapper">
                    <div class="ai-quick-actions">
                        <button class="ai-quick-action-button" onclick="aiChatInputText.value = 'Add task '; aiChatInputText.focus();">Add Task</button>
                        <button class="ai-quick-action-button" onclick="aiChatInputText.value = 'Find '; aiChatInputText.focus();">Find...</button>
                        <button class="ai-quick-action-button" onclick="aiChatInputText.value = 'Plan my day'; sendAIChatMessage();">Plan Day</button>
                        <button class="ai-quick-action-button" onclick="aiChatInputText.value = 'Summarize my day'; sendAIChatMessage();">Day Summary</button>
                        <button class="ai-quick-action-button" onclick="aiChatInputText.value = 'Help'; sendAIChatMessage();">Help</button>
                        <button class="ai-quick-action-button" onclick="clearAIChat()">Clear</button>
                    </div>
                </div>
                <div class="ai-chat-area" id="aiChatArea" aria-live="polite"></div>
                 <div class="chat-input-container">
                    <div class="chat-input-wrapper">
                       
                        <textarea id="aiChatInputText" class="input-field chat-input" placeholder="Ask or command..." aria-label="AI assistant chat input" rows="1" oninput="autoGrowTextarea(this); handleChatInputTyping(this, 'ai');"></textarea>
                        <button id="aiChatAttachBtn" class="chat-icon-button hides-on-typing" onclick="native.filePicker('ai')" aria-label="Attach file"><i class="fas fa-paperclip"></i></button>
                        <button id="aiChatCameraBtn" class="chat-icon-button hides-on-typing" onclick="native.filePicker('ai', true)" aria-label="Use camera"><i class="fas fa-camera"></i></button>
                    </div>
                    <button id="aiChatActionBtn" class="chat-input-action-button" onclick="native.speechToText('ai')" aria-label="Use voice input">
                        <i id="aiChatActionIcon" class="fas fa-microphone" aria-hidden="true"></i>
                    </button>
                    <div class="ai-chat-typing-suggestion" id="aiChatTypingSuggestion"></div>
                </div>
            </div>
        </div>

        <nav class="bottom-nav" role="navigation" aria-label="Main application navigation">
            <button class="nav-item active" data-screen="dashboard" aria-label="Home screen" aria-selected="true"><i class="fas fa-home" aria-hidden="true"></i><span>Home</span></button>
            <button class="nav-item" data-screen="planner" aria-label="Planner screen" aria-selected="false"><i class="fas fa-calendar-alt" aria-hidden="true"></i><span>Planner</span></button>
            <button class="nav-item" data-screen="explore" aria-label="Explore screen" aria-selected="false"><i class="fas fa-compass" aria-hidden="true"></i><span>Explore</span></button>
            <button class="nav-item" data-screen="chat" aria-label="Community chat screen" aria-selected="false"><i class="fas fa-comments" aria-hidden="true"></i><span>Community</span></button>
            <button class="nav-item" data-screen="wellness" aria-label="Wellness screen" aria-selected="false"><i class="fas fa-heartbeat" aria-hidden="true"></i><span>Wellness</span></button>
            <button class="nav-item" data-screen="settings" aria-label="Settings screen" aria-selected="false"><i class="fas fa-cog" aria-hidden="true"></i><span>Settings</span></button>
        </nav>

        <div id="placeDetailModal" class="modal" role="dialog" aria-modal="true" aria-labelledby="modalPlaceName">
            <div class="modal-content">
                <button class="modal-close-button" onclick="closeModal('placeDetailModal')" aria-label="Close place details"><i class="fas fa-xmark"></i></button>
                <h3 id="modalPlaceName" class="modal-title">Place Name</h3>
                <img id="modalPlaceImage" src="" alt="" style="width:100%; max-height:clamp(120px, 30vh, 150px); object-fit:cover; border-radius:var(--border-radius-md); margin-bottom:var(--space-sm);" loading="lazy">
                <div id="modalPlaceDetails" class="modal-body"></div>
                <div id="modalPlaceTags" class="tags mb-2"></div>
                <div id="aiPlaceReviewSummary" class="ai-review-summary hidden"></div>
                <div class="mt-3">
                    <h4 class="card-subtitle" style="font-size:clamp(0.85rem, 2.3vw, 0.9rem); font-weight:500;">Rate this place:</h4>
                    <div class="rating-stars" id="placeRatingStars" data-place-id="">
                        <i class="fas fa-star" data-value="1" onclick="ratePlace(this)" aria-label="Rate 1 star"></i>
                        <i class="fas fa-star" data-value="2" onclick="ratePlace(this)" aria-label="Rate 2 stars"></i>
                        <i class="fas fa-star" data-value="3" onclick="ratePlace(this)" aria-label="Rate 3 stars"></i>
                        <i class="fas fa-star" data-value="4" onclick="ratePlace(this)" aria-label="Rate 4 stars"></i>
                        <i class="fas fa-star" data-value="5" onclick="ratePlace(this)" aria-label="Rate 5 stars"></i>
                    </div>
                    <label for="placeReviewInput" class="visually-hidden">Write a short review</label>
                    <textarea id="placeReviewInput" class="input-field" rows="2" placeholder="Write a short review (optional)..." aria-label="Place review input"></textarea>
                    <button class="button mt-2 button-secondary" style="width:100%; font-size:clamp(0.85rem, 2.3vw, 0.9rem);" onclick="submitPlaceReview()">Submit Review</button>
                </div>
                <div class="mt-3" style="display:flex; gap:var(--space-sm);">
                    <button class="button" style="flex:1;" onclick="getDirections(document.getElementById('modalPlaceName').textContent)"><i class="fas fa-directions" aria-hidden="true"></i> Directions</button>
                    <button class="button button-secondary" style="flex:1;" onclick="shareContent('place')"><i class="fas fa-share-alt" aria-hidden="true"></i> Share</button>
                </div>
            </div>
        </div>
        
        <div id="dealDetailModal" class="modal" role="dialog" aria-modal="true" aria-labelledby="modalDealTitle">
            <div class="modal-content">
                <button class="modal-close-button" onclick="closeModal('dealDetailModal')" aria-label="Close deal details"><i class="fas fa-xmark"></i></button>
                <div id="dealDetailContent">
                    <h3 id="modalDealTitle" class="modal-title">Deal Title</h3>
                    <img id="modalDealImage" src="" alt="" style="width:100%; max-height:clamp(120px, 30vh, 150px); object-fit:cover; border-radius:var(--border-radius-md); margin-bottom:var(--space-sm);" loading="lazy">
                    <div id="modalDealBody" class="modal-body"></div>
                    <div id="dealRedemptionContainer" class="mt-3" style="display:flex; gap:var(--space-sm);">
                        <button id="redeemDealButton" class="button" style="flex:1;"><i class="fas fa-ticket-alt" aria-hidden="true"></i> Redeem</button>
                        <button class="button button-secondary" style="flex:1;" onclick="shareContent('deal')"><i class="fas fa-share-alt" aria-hidden="true"></i> Share</button>
                    </div>
                </div>
            </div>
        </div>

        <div id="submitDealModal" class="modal" role="dialog" aria-modal="true" aria-labelledby="submitDealModalTitle">
            <div class="modal-content">
                <button class="modal-close-button" onclick="closeModal('submitDealModal')" aria-label="Close submit deal form"><i class="fas fa-xmark"></i></button>
                <h3 class="modal-title" id="submitDealModalTitle">Submit a Deal or Offer</h3>
                <form id="submitDealForm">
                    <div class="input-group">
                        <label for="dealTitleInput">Deal Title*</label>
                        <input type="text" id="dealTitleInput" class="input-field" placeholder="e.g., Two-for-One Chicken Dust" required>
                    </div>
                    <div class="input-group">
                        <label for="dealBusinessNameInput">Business Name*</label>
                        <input type="text" id="dealBusinessNameInput" class="input-field" placeholder="e.g., Pick n Pay Ezulwini" required>
                    </div>
                    <div class="input-group">
                        <label for="dealDescriptionInput">Description*</label>
                        <textarea id="dealDescriptionInput" class="input-field" rows="3" placeholder="Describe the deal in detail..." required></textarea>
                    </div>
                    <div class="input-group">
                        <label for="dealCategorySelect">Category*</label>
                        <select id="dealCategorySelect" class="input-field" required></select>
                    </div>
                    <div class="input-group">
                        <label for="dealImageFileInput">Image</label>
                        <input type="file" id="dealImageFileInput" class="hidden" accept="image/*" onchange="previewImage(event, 'dealImagePreview', 'dealImageUploadText')">
                        <div class="file-upload-container" onclick="document.getElementById('dealImageFileInput').click()">
                            <p id="dealImageUploadText">Click to Upload or Open Camera</p>
                            <img id="dealImagePreview" class="preview hidden" src="" alt="Image preview"/>
                        </div>
                    </div>
                    <div class="input-group">
                        <label for="dealExpiryDateInput">Expiry Date (Optional)</label>
                        <input type="date" id="dealExpiryDateInput" class="input-field">
                    </div>
                    <div class="input-group">
                        <label for="dealTermsInput">Terms & Conditions (Optional)</label>
                        <textarea id="dealTermsInput" class="input-field" rows="2" placeholder="e.g., Valid weekdays only."></textarea>
                    </div>
                    <p class="card-subtitle" style="font-size:clamp(0.75rem, 2vw, 0.8rem); margin-bottom:10px;"><em>* Required fields. Submitted deals are reviewed by AI & human moderators.</em></p>
                    <button type="button" class="button mt-2" style="width:100%" onclick="submitNewDeal()">Submit Deal for Review</button>
                </form>
            </div>
        </div>

        <div id="journalModal" class="modal" role="dialog" aria-modal="true" aria-labelledby="journalModalTitle">
            <div class="modal-content">
                <button class="modal-close-button" onclick="closeModal('journalModal')" aria-label="Close journal entry"><i class="fas fa-xmark"></i></button>
                <h3 class="modal-title" id="journalModalTitle">AI Reflection Prompt</h3>
                <p class="card-subtitle" id="journalPromptText"></p>
                <label for="journalInput" class="visually-hidden">Journal Entry</label>
                <div class="add-task-input-container" style="margin-bottom:0; flex-direction:column; gap: var(--space-xs);">
                    <textarea id="journalInput" class="input-field mood-note-input" rows="5" placeholder="Your thoughts... AI can offer insights on your entries over time." style="width:100%; margin-top:0;" aria-label="Journal entry input"></textarea>
                    <div style="display:flex; gap:var(--space-sm); width:100%;">
                        <button class="button button-secondary" style="flex:1" onclick="startVoiceRecognition('journalInput')"><i class="fas fa-microphone"></i> Dictate</button>
                        <button class="button button-secondary" style="flex:1" onclick="native.filePicker('journal')"><i class="fas fa-camera"></i> Scan Page</button>
                    </div>
                </div>
                <p class="card-subtitle mt-2" style="font-size: clamp(0.7rem, 1.9vw, 0.75rem);">This is your ThoughtBoard. Search entries by emotion, topic, or location.</p>
                <button class="button mt-3" style="width:100%" onclick="saveJournalEntry()">Save Entry</button>
            </div>
        </div>
        
        <div id="createChannelModal" class="modal" role="dialog" aria-modal="true" aria-labelledby="createChannelModalTitle">
            <div class="modal-content">
                <button class="modal-close-button" onclick="closeModal('createChannelModal')" aria-label="Close create channel form"><i class="fas fa-xmark"></i></button>
                <h3 class="modal-title" id="createChannelModalTitle">Create New Channel</h3>
                <label for="newChannelName">Channel Name</label>
                <input type="text" id="newChannelName" class="input-field" placeholder="e.g., Manzini Market Deals">
                
                <label for="newChannelType">Channel Type</label>
                <select id="newChannelType" class="input-field mb-2" onchange="updateChannelDescPlaceholder(this.value)">
                    <option value="general">General Discussion</option>
                    <option value="skill_swap">Skill Swap (Offer/Request)</option>
                    <option value="hobby">Hobby Group</option>
                    <option value="announcements">Announcements</option>
                    <option value="local_events">Local Events Discussion</option>
                </select>

                <label for="newChannelDesc">Description (AI can help generate this)</label>
                <textarea id="newChannelDesc" class="input-field" rows="2" placeholder="e.g., Share gardening tips, or discuss local news."></textarea>
                
                <label>Channel Icon (Choose one, or upload)</label>
                 <div class="file-upload-container mb-2" onclick="document.getElementById('channelIconUpload').click()">
                    <p id="channelIconUploadText">Upload Custom Icon</p>
                    <input type="file" id="channelIconUpload" class="hidden" accept="image/*" onchange="previewImage(event, 'channelIconPreview', 'channelIconUploadText')">
                    <img id="channelIconPreview" class="preview hidden" src="" alt="Channel icon preview"/>
                </div>
                <div class="icon-selector" id="newChannelIconSelector" role="radiogroup" aria-label="Select channel icon"></div>
                <p class="card-subtitle mt-2" style="font-size:clamp(0.75rem, 2vw, 0.8rem);">Channel creators have access to moderation tools, including AI-assisted moderation.</p>
                <button class="button mt-3" style="width:100%" onclick="submitNewChannel()">Create Channel</button>
            </div>
        </div>

        <div id="createHabitModal" class="modal" role="dialog" aria-modal="true" aria-labelledby="createHabitModalTitle">
            <div class="modal-content">
                <button class="modal-close-button" onclick="closeModal('createHabitModal')" aria-label="Close create habit form"><i class="fas fa-xmark"></i></button>
                <h3 class="modal-title" id="createHabitModalTitle">Create New Habit</h3>
                <input type="hidden" id="editingHabitId">
                <label for="newHabitName">Habit Name (AI can suggest habits based on your goals)</label>
                <input type="text" id="newHabitName" class="input-field" placeholder="e.g., Morning Meditation">
                <label for="newHabitGoal">Goal (daily count)</label>
                <input type="number" id="newHabitGoal" class="input-field" value="1" min="1">
                <label for="newHabitUnit">Unit (optional)</label>
                <input type="text" id="newHabitUnit" class="input-field" placeholder="e.g., minutes, reps, glasses">
                <label>Habit Icon (Choose one)</label>
                <div class="icon-selector" id="newHabitIconSelector" role="radiogroup" aria-label="Select habit icon"></div>
                 <label>Color</label>
                <div class="icon-selector" id="newHabitColorSelector" role="radiogroup" aria-label="Select habit color"></div>
                <button id="submitHabitButton" class="button mt-3" style="width:100%" onclick="submitNewHabit()">Create Habit</button>
            </div>
        </div>
        
        <div id="editTaskModal" class="modal" role="dialog" aria-modal="true" aria-labelledby="editTaskModalTitle">
            <div class="modal-content">
                <button class="modal-close-button" onclick="closeModal('editTaskModal')" aria-label="Close edit task form"><i class="fas fa-xmark"></i></button>
                <h3 class="modal-title" id="editTaskModalTitle">Edit Task</h3>
                <input type="hidden" id="editingTaskId">
                <label for="editTaskTitleInput">Task Title</label>
                <input type="text" id="editTaskTitleInput" class="input-field">
                <label for="editTaskTimeInput">Time / Context (AI can parse this)</label>
                <input type="text" id="editTaskTimeInput" class="input-field">
                <label for="editTaskCategorySelect">Category (AI can suggest)</label>
                <select id="editTaskCategorySelect" class="input-field">
                    <option value="personal">Personal</option>
                    <option value="work">Work</option>
                    <option value="errands">Errands</option>
                    <option value="learning">Learning</option>
                    <option value="health">Health</option>
                    <option value="general">General</option>
                </select>
                <label for="editTaskDueDateInput">Due Date (AI can help schedule)</label>
                <input type="date" id="editTaskDueDateInput" class="input-field" placeholder="e.g., Tomorrow, 2024-12-25">
                <label for="editTaskRecurrenceSelect">Recurring</label>
                <select id="editTaskRecurrenceSelect" class="input-field">
                    <option value="none">None</option>
                    <option value="daily">Daily</option>
                    <option value="weekly">Weekly</option>
                    <option value="monthly">Monthly</option>
                </select>
                <label for="editTaskNotesInput">Notes / Subtasks (AI can help break down)</label>
                <textarea id="editTaskNotesInput" class="input-field" rows="3" placeholder="Add details or subtasks here..."></textarea>
                <div class="mt-3" style="display: flex; gap: var(--space-sm);">
                    <button class="button" style="width:100%;" onclick="saveEditedTask()">Save Changes</button>
                    <button class="button button-secondary" onclick="createCalendarEvent()" aria-label="Add to Device Calendar"><i class="fas fa-calendar-plus"></i></button>
                </div>
            </div>
        </div>

        <div id="submitTipModal" class="modal" role="dialog" aria-modal="true" aria-labelledby="submitTipModalTitle">
            <div class="modal-content">
                <button class="modal-close-button" onclick="closeModal('submitTipModal')" aria-label="Close submit tip form"><i class="fas fa-xmark"></i></button>
                <h3 class="modal-title" id="submitTipModalTitle">Submit a Community Tip / Place</h3>
                <form id="submitTipForm">
                    <div class="input-group">
                        <label for="tipTitleInput">Place Name / Tip Title*</label>
                        <input type="text" id="tipTitleInput" class="input-field" placeholder="e.g., Sibebe Rock or Road Closure Alert" required>
                    </div>
                    <div class="input-group">
                        <label for="tipDescriptionInput">Main Details*</label>
                        <textarea id="tipDescriptionInput" class="input-field" rows="2" placeholder="e.g., Great hiking spot, challenging trail..." required></textarea>
                    </div>
                     <div class="input-group">
                        <label for="tipSubDetailsInput">Sub-details (Optional)</label>
                        <input type="text" id="tipSubDetailsInput" class="input-field" placeholder="e.g., Open during daylight hours">
                    </div>
                    <div class="input-group">
                        <label for="tipCategorySelect">Category (AI can auto-categorize)</label>
                        <select id="tipCategorySelect" class="input-field">
                            <option value="food">Food</option>
                            <option value="parks">Nature</option>
                            <option value="events">Events</option>
                            <option value="shops">Shops</option>
                            <option value="services">Services</option>
                            <option value="safety">Safety Alert</option>
                            <option value="general">General Info</option>
                        </select>
                    </div>
                    <div class="input-group">
                        <label for="tipTagsInput">Tags (comma-separated, optional)</label>
                        <input type="text" id="tipTagsInput" class="input-field" placeholder="e.g., outdoor, hiking, scenic, adventure">
                    </div>
                     <div class="input-group">
                        <label for="tipImageFileInput">Image (Optional)</label>
                        <input type="file" id="tipImageFileInput" class="input-field hidden" accept="image/*" onchange="previewImage(event, 'tipImagePreview', 'tipImageUploadText')">
                        <div class="file-upload-container" onclick="document.getElementById('tipImageFileInput').click()">
                            <p id="tipImageUploadText">Click to Upload or Open Camera</p>
                            <img id="tipImagePreview" class="preview hidden" src="" alt="Image preview"/>
                        </div>
                    </div>
                    <button type="button" class="button mt-3" style="width:100%" onclick="submitCommunityTip()">Submit Tip (AI Moderated)</button>
                </form>
            </div>
        </div>
        
        <div id="genericModal" class="modal" role="dialog" aria-modal="true" aria-labelledby="genericModalTitle">
            <div class="modal-content">
                <button class="modal-close-button" onclick="closeModal('genericModal')" aria-label="Close modal"><i class="fas fa-xmark"></i></button>
                <h3 id="genericModalTitle" class="modal-title"></h3>
                <div id="genericModalBody" class="modal-body"></div>
                <button class="button mt-3" style="width:100%" onclick="closeModal('genericModal')">OK</button>
            </div>
        </div>
        
        <div id="userProfileModal" class="modal" role="dialog" aria-modal="true" aria-labelledby="userProfileModalTitle">
            <div class="modal-content">
                <button class="modal-close-button" onclick="closeModal('userProfileModal')" aria-label="Close user profile form"><i class="fas fa-xmark"></i></button>
                <h3 class="modal-title" id="userProfileModalTitle">My Profile</h3>
                <div class="text-center mb-3">
                    <div style="position:relative; display:inline-block;">
                        <img id="userProfileAvatar" src="https://via.placeholder.com/80/4DB6AC/FFFFFF?text=SL" alt="User Avatar" style="width: clamp(70px, 18vw, 80px); height: clamp(70px, 18vw, 80px); border-radius: 50%; object-fit: cover; margin-bottom: var(--space-sm); border: 3px solid var(--primary-accent);" loading="lazy">
                        <input type="file" id="avatarUpload" class="hidden" accept="image/*" onchange="handleAvatarUpload(event)">
                        <button class="button button-secondary" style="font-size:clamp(0.75rem, 2vw, 0.8rem); padding: var(--space-xs) var(--space-sm); position:absolute; bottom:10px; right: -10px;" onclick="document.getElementById('avatarUpload').click();">
                            <i class="fas fa-camera"></i>
                        </button>
                    </div>
                </div>
                <div class="gamification-stats-container mb-3">
                    <div style="display:flex; justify-content: space-between; align-items: center; font-size: 0.8rem; margin-bottom: var(--space-xs);">
                        <span style="font-weight: 600;">Level <span id="userLevel">1</span></span>
                        <span style="color: var(--text-secondary-color);"><span id="userXP">0</span> / <span id="userXPToNextLevel">100</span> XP</span>
                    </div>
                    <div class="xp-bar-container">
                        <div id="userXPBar" class="xp-bar" style="width: 0%;"></div>
                    </div>
                    <div id="userBadgesContainer" class="mt-2" style="display:flex; flex-wrap:wrap; gap:var(--space-xs); justify-content:center;"></div>
                </div>

                <div class="input-group">
                    <label for="profileNameInput">Full Name</label>
                    <input type="text" id="profileNameInput" class="input-field" value="Shamase Local">
                </div>
                <div class="input-group">
                    <label for="profileUsernameInput">Username</label>
                    <input type="text" id="profileUsernameInput" class="input-field" value="@shamase_local">
                </div>
                 <div class="input-group">
                    <label for="profileLocationInput">My Neighborhood</label>
                    <input type="text" id="profileLocationInput" class="input-field" placeholder="e.g., Mbabane, Manzini, Ezulwini">
                </div>
                <div class="input-group">
                    <label for="profileBioInput">Short Bio (AI can help write this!)</label>
                    <textarea id="profileBioInput" class="input-field" rows="2" placeholder="Tell us about yourself..."></textarea>
                </div>
                 <div class="input-group">
                    <label for="profileInterestsInput">Interests (comma-separated)</label>
                    <textarea id="profileInterestsInput" class="input-field" rows="2" placeholder="e.g., hiking, local music, crafts, technology"></textarea>
                </div>
                <button class="button mt-3" style="width:100%" onclick="saveUserProfile()">Save Profile</button>
            </div>
        </div>

        <div id="otherUserProfileModal" class="modal" role="dialog" aria-modal="true" aria-labelledby="otherUserProfileModalTitle">
            <div class="modal-content">
                <button class="modal-close-button" onclick="closeModal('otherUserProfileModal')" aria-label="Close user profile"><i class="fas fa-xmark"></i></button>
                <div class="text-center mb-3">
                    <img id="otherUserAvatar" src="" alt="User Avatar" style="width: clamp(70px, 18vw, 80px); height: clamp(70px, 18vw, 80px); border-radius: 50%; object-fit: cover; margin-bottom: var(--space-sm); border: 3px solid var(--primary-accent);" loading="lazy">
                    <h3 id="otherUserProfileModalTitle" class="modal-title" style="margin-bottom: var(--space-xs);">User Name</h3>
                    <p id="otherUserUsername" class="card-subtitle" style="margin-top:-5px;"></p>
                    <p id="otherUserBio" class="card-subtitle"></p>
                </div>
                <div id="otherUserInteractions" class="modal-body">
                    <h4 class="card-subtitle" style="font-size:clamp(0.85rem, 2.3vw, 0.9rem); font-weight:500;">Interests</h4>
                    <p id="otherUserInterests" class="mb-2">...</p>
                    <h4 class="card-subtitle" style="font-size:clamp(0.85rem, 2.3vw, 0.9rem); font-weight:500;">Mutual Channels</h4>
                    <p id="otherUserMutualChannels" class="mb-2">...</p>
                    <button id="otherUserMessageButton" class="button button-secondary mt-2" style="width:100%; font-size:clamp(0.85rem, 2.3vw, 0.9rem);"><i class="fas fa-paper-plane"></i> Message User</button>
                </div>
            </div>
        </div>

        <div id="channelDetailModal" class="modal" role="dialog" aria-modal="true" aria-labelledby="channelDetailModalTitle">
            <div class="modal-content">
                <button class="modal-close-button" onclick="closeModal('channelDetailModal')" aria-label="Close channel details"><i class="fas fa-xmark"></i></button>
                <div class="text-center mb-2">
                    <div id="channelDetailIcon" class="channel-icon" style="width:clamp(44px, 12vw, 50px); height:clamp(44px, 12vw, 50px); font-size:clamp(1.6rem, 4.8vw, 1.8rem); margin:0 auto var(--space-sm) auto;"></div>
                    <h3 id="channelDetailModalTitle" class="modal-title" style="margin-bottom:var(--space-xs);">Channel Name</h3>
                </div>
                <p class="card-subtitle"><strong>Type:</strong> <span id="channelDetailType"></span></p>
                <p class="card-subtitle"><strong>Description:</strong> <span id="channelDetailDescription"></span></p>
                <p class="card-subtitle"><strong>Members:</strong> <span id="channelDetailMemberCount"></span></p>
                <div id="channelDetailAIActions" class="ai-suggestion-bg p-2 mt-2" style="border-radius:var(--border-radius-sm); font-size:clamp(0.8rem, 2.2vw, 0.85rem); border: 1px solid color-mix(in srgb, var(--primary-accent) 20%, transparent);">
                    <p><i class="fas fa-brain" style="color:var(--primary-accent)"></i> <strong>AI Actions:</strong></p>
                    <button class="button button-secondary" style="font-size:clamp(0.75rem, 2vw, 0.8rem); padding: var(--space-xs) var(--space-sm); margin-top:var(--space-xs);" onclick="summarizeChannel(currentChatChannelId)">Summarize Highlights</button>
                    <button class="button button-secondary" style="font-size:clamp(0.75rem, 2vw, 0.8rem); padding: var(--space-xs) var(--space-sm); margin-top:var(--space-xs); margin-left:var(--space-xs);" onclick="showToast('AI generating suggested reply based on last message...', 'ai_info')">Suggest Reply</button>
                </div>
                <div class="mt-3" style="display:flex; gap:var(--space-sm);">
                    <button id="channelDetailJoinButton" class="button" style="flex-grow:1;" onclick=""></button>
                    <button id="channelDetailFavoriteButton" class="button button-secondary" style="flex-grow:1;" onclick=""></button>
                </div>
            </div>
        </div>

        <div id="fullCalendarModal" class="modal" role="dialog" aria-modal="true" aria-labelledby="fullCalendarModalTitle">
            <div class="modal-content">
                <div class="calendar-container">
                    <div class="calendar-header">
                        <button class="button" onclick="navigateCalendar(-1)" aria-label="Previous month"><i class="fas fa-chevron-left"></i></button>
                        <h3 id="fullCalendarModalTitle" class="modal-title" style="margin-bottom:0;">Month Year</h3>
                        <button class="button" onclick="navigateCalendar(1)" aria-label="Next month"><i class="fas fa-chevron-right"></i></button>
                    </div>
                    <div class="calendar-grid day-headers" style="grid-auto-rows: min-content; padding-right: var(--space-xs);">
                        <div class="calendar-day-header">Sun</div>
                        <div class="calendar-day-header">Mon</div>
                        <div class="calendar-day-header">Tue</div>
                        <div class="calendar-day-header">Wed</div>
                        <div class="calendar-day-header">Thu</div>
                        <div class="calendar-day-header">Fri</div>
                        <div class="calendar-day-header">Sat</div>
                    </div>
                    <div id="calendarGridBody" class="calendar-grid"></div>
                    <div id="calendarDayDetailPanel" class="day-detail-panel hidden"></div>
                </div>
                 <button class="button mt-3" style="width:100%; flex-shrink: 0;" onclick="closeModal('fullCalendarModal')">Close Calendar</button>
            </div>
        </div>

        <div id="habitStatsModal" class="modal" role="dialog" aria-modal="true" aria-labelledby="habitStatsModalTitle">
            <div class="modal-content">
                <button class="modal-close-button" onclick="closeModal('habitStatsModal')" aria-label="Close habit statistics"><i class="fas fa-xmark"></i></button>
                <h3 id="habitStatsModalTitle" class="modal-title">Habit Statistics</h3>
                <div id="habitStatsBody" class="modal-body"></div>
                <div id="habitStatsAIInsight" class="ai-wellness-insight mt-3"></div>
                <button class="button mt-3" style="width:100%" onclick="closeModal('habitStatsModal')">Close</button>
            </div>
        </div>


        <div id="dashboardCustomizationModal" class="modal" role="dialog" aria-modal="true" aria-labelledby="dashboardCustomizationModalTitle">
            <div class="modal-content">
                <button class="modal-close-button" onclick="closeModal('dashboardCustomizationModal')" aria-label="Close dashboard customization form"><i class="fas fa-xmark"></i></button>
                <h3 class="modal-title" id="dashboardCustomizationModalTitle">Customize Dashboard & Widgets</h3>
                <p class="card-subtitle mb-2">Toggle visibility of dashboard cards. AI can suggest an optimal layout!</p>
                <div id="dashboardCardToggleContainer" class="settings-list" style="padding:0;"></div>
                <button class="button mt-3" style="width:100%" onclick="saveDashboardCustomization()">Save Changes</button>
            </div>
        </div>
        
        <div id="notificationSettingsModal" class="modal" role="dialog" aria-modal="true" aria-labelledby="notificationSettingsModalTitle">
            <div class="modal-content">
                <button class="modal-close-button" onclick="closeModal('notificationSettingsModal')" aria-label="Close notification settings"><i class="fas fa-xmark"></i></button>
                <h3 class="modal-title" id="notificationSettingsModalTitle">Notification Preferences</h3>
                <p class="card-subtitle mb-2">Control what you get notified about. AI can manage "Smart Alerts" to reduce noise.</p>
                <div class="settings-list" style="padding:0;">
                    <div class="setting-item">
                        <span class="setting-label">Daily AI Briefing (7 AM)</span>
                        <button class="toggle-switch-button" data-pref="dailyBriefing" onclick="this.firstChild.classList.toggle('active')"><span class="toggle-switch active"></span></button>
                    </div>
                     <div class="setting-item">
                        <span class="setting-label">AI Smart Alerts (Fewer, more relevant)</span>
                         <button class="toggle-switch-button" data-pref="aiSmartAlerts" onclick="this.firstChild.classList.toggle('active')"><span class="toggle-switch active"></span></button>
                    </div>
                    <div class="setting-item">
                        <span class="setting-label">New Chat Messages (All)</span>
                         <button class="toggle-switch-button" data-pref="allChatMessages" onclick="this.firstChild.classList.toggle('active')"><span class="toggle-switch"></span></button>
                    </div>
                    <div class="setting-item">
                        <span class="setting-label">Chat Mentions</span>
                        <button class="toggle-switch-button" data-pref="chatMentions" onclick="this.firstChild.classList.toggle('active')"><span class="toggle-switch active"></span></button>
                    </div>
                     <div class="setting-item">
                        <span class="setting-label">AI Proactive Suggestions</span>
                        <button class="toggle-switch-button" data-pref="aiSuggestions" onclick="this.firstChild.classList.toggle('active')"><span class="toggle-switch"></span></button>
                    </div>
                    <div class="setting-item">
                        <span class="setting-label">Local Deals Alerts</span>
                        <button class="toggle-switch-button" data-pref="dealAlerts" onclick="this.firstChild.classList.toggle('active')"><span class="toggle-switch"></span></button>
                    </div>
                    <div class="setting-item">
                        <span class="setting-label">Task Reminders</span>
                        <button class="toggle-switch-button" data-pref="taskReminders" onclick="this.firstChild.classList.toggle('active')"><span class="toggle-switch active"></span></button>
                    </div>
                    <div class="setting-item">
                        <span class="setting-label">Save Destination Preferences</span>
                        <button class="toggle-switch-button" data-pref="saveDestination" onclick="this.firstChild.classList.toggle('active')"><span class="toggle-switch"></span></button>
                    </div>
                </div>
                <button class="button mt-3" style="width:100%" onclick="saveNotificationPreferences()">Save Preferences</button>
            </div>
        </div>

        <div id="helpAboutModal" class="modal" role="dialog" aria-modal="true" aria-labelledby="helpAboutModalTitle">
            <div class="modal-content">
                <button class="modal-close-button" onclick="closeModal('helpAboutModal')" aria-label="Close help and about"><i class="fas fa-xmark"></i></button>
                <h3 class="modal-title" id="helpAboutModalTitle">Help & About</h3>
                <p><strong>LocalLife OS v12.0 (Beta)</strong></p>
                <p>A functional prototype demonstrating a hyperlocal OS with advanced AI, collaboration, and modern UI concepts.</p>
                <h4>Key Features:</h4>
                <ul>
                    <li>AI-Powered Planning, Task Parsing & Optimization</li>
                    <li>Proactive Suggestions & Contextual Nudges</li>
                    <li>Live Voice UI & Dynamic Island-style Alerts</li>
                    <li>Collaborative Planner and Community Features</li>
                    <li>Gamified Wellness & Profile Progression</li>
                    <li>Integrated Emergency & Safety Dashboard</li>
                    <li>AI Assistance in Chat (Summaries, Smart Replies, Moderation)</li>
                </ul>
                <h4>FAQ</h4>
                <p><strong>Q: Is my data private?</strong><br>A: Yes. All sensitive data is encrypted with AES-256 on your device. You can manage what the AI learns and view data usage in the Privacy Dashboard.</p>
            </div>
        </div>

        <div id="guidedExerciseModal" class="modal" role="dialog" aria-modal="true" aria-labelledby="guidedExerciseModalTitle">
            <div class="modal-content">
                <button class="modal-close-button" onclick="stopBreathingExercise(); closeModal('guidedExerciseModal');" aria-label="Close guided exercise"><i class="fas fa-xmark"></i></button>
                <div class="breathing-exercise-main">
                    <h3 class="modal-title" id="guidedExerciseModalTitle">Guided Breathing</h3>
                    <div class="breathing-exercise-presets">
                        <button class="button button-secondary" style="font-size: 0.8rem; padding: 4px 8px;" onclick="setBreathingPace('relax')">Relax</button>
                        <button class="button button-secondary" style="font-size: 0.8rem; padding: 4px 8px;" onclick="setBreathingPace('focus')">Focus</button>
                        <button class="button button-secondary" style="font-size: 0.8rem; padding: 4px 8px;" onclick="setBreathingPace('calm')">Calm</button>
                    </div>
                    <div id="breathing-circle-container">
                        <div id="breathing-glow"></div>
                        <div id="breathing-circle">
                            <span id="breathing-instruction">Ready?</span>
                        </div>
                    </div>
                    <div class="progress-dots" id="breathingProgressDots"></div>
                </div>
                <div class="breathing-exercise-controls">
                    <button class="button" style="flex-grow:1;" onclick="startBreathingExercise()" id="breathingStartButton"><i class="fas fa-play"></i> Start</button>
                    <button class="button button-secondary" style="flex-grow:1;" onclick="stopBreathingExercise(); closeModal('guidedExerciseModal');"><i class="fas fa-times"></i> End Session</button>
                </div>
            </div>
        </div>


        <div id="aiWellnessSummaryModal" class="modal" role="dialog" aria-modal="true" aria-labelledby="aiWellnessSummaryTitle">
            <div class="modal-content">
                <button class="modal-close-button" onclick="closeModal('aiWellnessSummaryModal')" aria-label="Close AI Wellness Summary"><i class="fas fa-xmark"></i></button>
                <h3 class="modal-title" id="aiWellnessSummaryTitle">AI Wellness Summary</h3>
                <div id="aiWellnessSummaryBody" class="modal-body">
                    <p>Based on your recent activity:</p>
                    <ul>
                        <li>Your mood has generally been positive this week! </li>
                        <li>You're consistent with your 'Read for 30 minutes' habit. Great job!</li>
                        <li>AI Pattern Detected: You tend to complete more tasks on days you log your 'Morning Jog' habit. Keep it up!</li>
                        <li>Consider scheduling a short walk if you feel your energy dip in the afternoons.</li>
                        <li>Remember to log your water intake to see progress.</li>
                    </ul>
                    <p class="mt-2">This is a summary. A real AI would provide more personalized insights and track trends over time.</p>
                </div>
                <button class="button mt-3" style="width:100%" onclick="closeModal('aiWellnessSummaryModal')">Okay, Got It!</button>
            </div>
        </div>

        <div id="aiLearningPrefsModal" class="modal" role="dialog" aria-modal="true" aria-labelledby="aiLearningPrefsModalTitle">
            <div class="modal-content">
                <button class="modal-close-button" onclick="closeModal('aiLearningPrefsModal')" aria-label="Close AI Learning Preferences"><i class="fas fa-xmark"></i></button>
                <h3 class="modal-title" id="aiLearningPrefsModalTitle">AI Learning Preferences (LifeDNA)</h3>
                <p class="card-subtitle mb-2">Control how LocalLife AI learns to personalize your experience.</p>
                <div class="settings-list" style="padding:0;">
                    <div class="setting-item">
                        <span class="setting-label">Learn from saved places & deals</span>
                        <button class="toggle-switch-button" data-pref="learnSavedPlaces" onclick="toggleAILearningPref(this)"><span class="toggle-switch active"></span></button>
                    </div>
                    <div class="setting-item">
                        <span class="setting-label">Consider mood logs for suggestions</span>
                         <button class="toggle-switch-button" data-pref="learnMoodLogs" onclick="toggleAILearningPref(this)"><span class="toggle-switch active"></span></button>
                    </div>
                    <div class="setting-item">
                        <span class="setting-label">Analyze task patterns for planner tips</span>
                        <button class="toggle-switch-button" data-pref="learnTaskPatterns" onclick="toggleAILearningPref(this)"><span class="toggle-switch active"></span></button>
                    </div>
                     <div class="setting-item">
                        <span class="setting-label">Use habit tracking for wellness insights</span>
                        <button class="toggle-switch-button" data-pref="learnHabitTracking" onclick="toggleAILearningPref(this)"><span class="toggle-switch active"></span></button>
                    </div>
                    <div class="setting-item">
                        <span class="setting-label">Personalize chat suggestions based on my style</span>
                        <button class="toggle-switch-button" data-pref="learnChatStyle" onclick="toggleAILearningPref(this);"><span class="toggle-switch"></span></button>
                    </div>
                </div>
                <p class="card-subtitle mt-3" style="font-size:clamp(0.75rem, 2vw, 0.8rem);">These settings allow fine-grained control over AI personalization.</p>
                <button class="button mt-3" style="width:100%" onclick="closeModal('aiLearningPrefsModal'); showToast('AI Learning preferences saved.', 'success');">Save Preferences</button>
            </div>
        </div>

        <div id="confirmationModal" class="modal" role="dialog" aria-modal="true" aria-labelledby="confirmationModalTitle">
            <div class="modal-content">
                 <h3 id="confirmationModalTitle" class="modal-title">Confirm Action</h3>
                <p id="confirmationModalMessage" class="modal-body"></p>
                <div style="display:flex; gap:var(--space-sm); margin-top:var(--space-md);">
                    <button id="confirmActionButton" class="button danger" style="flex-grow:1;">Confirm</button>
                    <button class="button button-secondary" style="flex-grow:1;" onclick="closeModal('confirmationModal')">Cancel</button>
                </div>
            </div>
        </div>
        
        <div id="notificationsModal" class="modal" role="dialog" aria-modal="true" aria-labelledby="notificationsModalTitle">
            <div class="modal-content">
                <button class="modal-close-button" onclick="closeModal('notificationsModal')" aria-label="Close notifications"><i class="fas fa-xmark"></i></button>
                <h3 id="notificationsModalTitle" class="modal-title">Notifications</h3>
                 <div class="setting-item" style="padding:var(--space-xs) 0 var(--space-sm) 0; border-bottom: 1px solid var(--placeholder-bg);">
                    <span class="setting-label" style="font-size:clamp(0.85rem, 2.3vw, 0.9rem);">AI Smart Filter</span>
                    <button class="toggle-switch-button" onclick="this.firstChild.classList.toggle('active'); showToast('AI Smart Filter ' + (this.firstChild.classList.contains('active') ? 'On' : 'Off'), 'ai_info');"><span class="toggle-switch active"></span></button>
                </div>
                <ul id="notificationListContainer" class="notification-list" style="margin-top:var(--space-sm);"></ul>
                <div class="notification-actions" style="display:flex; gap: var(--space-sm); margin-top: var(--space-md);">
                    <button class="button button-secondary" style="font-size:clamp(0.75rem, 2vw, 0.8rem); padding:var(--space-xs) var(--space-sm); flex:1;" onclick="markAllNotificationsRead()">Mark All Read</button>
                    <button class="button button-secondary danger" style="font-size:clamp(0.75rem, 2vw, 0.8rem); padding:var(--space-xs) var(--space-sm); flex:1;" onclick="clearAllNotifications()">Clear All</button>
                </div>
            </div>
        </div>

        <div id="aiLayersModal" class="modal" role="dialog" aria-modal="true" aria-labelledby="aiLayersModalTitle">
             <div class="modal-content">
                <button class="modal-close-button" onclick="closeModal('aiLayersModal')" aria-label="Close AI Layers selection"><i class="fas fa-xmark"></i></button>
                <h3 class="modal-title" id="aiLayersModalTitle">AI Map Overlays (LivePulse)</h3>
                <p class="card-subtitle mb-2">View the map through different AI-curated lenses.</p>
                <div class="settings-list" style="padding:0;">
                     <div class="setting-item" role="button" tabindex="0" onclick="applyAILayer('heatmap')">
                        <span class="setting-label"><i class="fas fa-fire" style="margin-right:var(--space-sm); color: var(--muted-terracotta);"></i>Popularity Heatmap</span><i class="fas fa-chevron-right"></i>
                    </div>
                    <div class="setting-item" role="button" tabindex="0" onclick="applyAILayer('danger')">
                        <span class="setting-label"><i class="fas fa-shield-halved" style="margin-right:var(--space-sm); color: var(--danger-color);"></i>Safety Hotspots</span><i class="fas fa-chevron-right"></i>
                    </div>
                    <div class="setting-item" role="button" tabindex="0" onclick="applyAILayer('quiet')">
                        <span class="setting-label"><i class="fas fa-moon" style="margin-right:var(--space-sm); color: var(--soft-blue);"></i>Quiet Zones</span><i class="fas fa-chevron-right"></i>
                    </div>
                    <div class="setting-item" role="button" tabindex="0" onclick="applyAILayer('vibrant')">
                        <span class="setting-label"><i class="fas fa-bolt" style="margin-right:var(--space-sm); color: var(--favorite-color);"></i>Vibrant Zones</span><i class="fas fa-chevron-right"></i>
                    </div>
                    <div class="setting-item" role="button" tabindex="0" onclick="applyAILayer('family')">
                        <span class="setting-label"><i class="fas fa-child" style="margin-right:var(--space-sm); color: var(--moss-green);"></i>Family Friendly</span><i class="fas fa-chevron-right"></i>
                    </div>
                     <div class="setting-item" role="button" tabindex="0" onclick="applyAILayer('reset')">
                        <span class="setting-label">Reset to Default</span>
                    </div>
                </div>
             </div>
        </div>
        
        <div id="trustedCircleModal" class="modal" role="dialog" aria-modal="true" aria-labelledby="trustedCircleModalTitle">
            <div class="modal-content">
                <button class="modal-close-button" onclick="closeModal('trustedCircleModal')" aria-label="Close trusted circle settings"><i class="fas fa-xmark"></i></button>
                <h3 id="trustedCircleModalTitle" class="modal-title">Trusted Circle & Safety</h3>
                <p class="card-subtitle mb-2">Add contacts who will be alerted in an emergency.</p>
                <div id="trustedContactsList" class="settings-list" style="padding:0;"></div>
                <div class="input-group mt-3">
                    <label for="addContactName">Add Contact</label>
                    <input type="text" id="addContactName" class="input-field" placeholder="Contact Name">
                </div>
                <div class="input-group">
                    <label for="addContactPhone" class="visually-hidden">Contact Phone Number</label>
                    <input type="tel" id="addContactPhone" class="input-field" placeholder="Phone Number (e.g., 76XXXXXX)">
                </div>
                <button class="button mt-1" style="width:100%" onclick="addTrustedContact()">Add to Circle</button>
                <div class="setting-item mt-3">
                    <span class="setting-label">AI Auto Check-in</span>
                    <button class="toggle-switch-button" onclick="this.firstChild.classList.toggle('active'); showToast('AI Auto Check-in ' + (this.firstChild.classList.contains('active') ? 'enabled' : 'disabled'), 'ai_info')"><span class="toggle-switch"></span></button>
                </div>
                <p class="card-subtitle" style="font-size:clamp(0.75rem, 2vw, 0.8rem);">If enabled, AI will ask for a check-in after late-night events. No response will alert your Trusted Circle.</p>
            </div>
        </div>
        
        <div id="createBulletinPostModal" class="modal" role="dialog" aria-modal="true" aria-labelledby="createBulletinPostModalTitle">
            <div class="modal-content">
                <button class="modal-close-button" onclick="closeModal('createBulletinPostModal')" aria-label="Close new post form"><i class="fas fa-xmark"></i></button>
                <h3 id="createBulletinPostModalTitle" class="modal-title">New Bulletin Post</h3>
                <div class="input-group">
                    <label for="bulletinPostTitleInput">Title*</label>
                    <input type="text" id="bulletinPostTitleInput" class="input-field" placeholder="e.g., Lost Goat near Sibebe" required>
                </div>
                <div class="input-group">
                    <label for="bulletinPostContentInput">Details*</label>
                    <textarea id="bulletinPostContentInput" class="input-field" rows="4" placeholder="Provide as much detail as possible..." required></textarea>
                </div>
                <div class="input-group">
                    <label for="bulletinPostCategorySelect">Category*</label>
                    <select id="bulletinPostCategorySelect" class="input-field" required>
                        <option value="announcement">Announcement</option>
                        <option value="lost_found">Lost & Found</option>
                        <option value="event_promo">Event Promotion</option>
                        <option value="question">Question</option>
                        <option value="recommendation">Recommendation</option>
                    </select>
                </div>
                <button class="button mt-2" style="width:100%" onclick="submitBulletinPost()">Submit Post</button>
            </div>
        </div>

        <div id="focusModeModal" class="modal" role="dialog" aria-modal="true" aria-labelledby="focusModeModalTitle" style="display:none;">
            <div class="modal-content">
                <button class="modal-close-button" onclick="stopFocusMode()" aria-label="End focus session"><i class="fas fa-xmark"></i></button>
                <h3 id="focusModeModalTitle" class="modal-title" style="font-weight: 500;">Mindful Focus Session</h3>
                <div class="focus-icon-container">
                    <div class="focus-circle"></div>
                    <div class="focus-circle"></div>
                    <i class="fas fa-stopwatch-20 focus-icon"></i>
                </div>
                <h2 id="focusSessionTimer">"The secret of getting ahead is getting started."</h2>
                <p id="focusSessionTaskLabel">Focusing on: "Submit ERS Tax Returns"</p>
                <p class="card-subtitle mt-3" style="font-size: clamp(0.75rem, 2.1vw, 0.8rem);">All non-essential notifications are paused.</p>
                <div class="focus-controls-container">
                    <button class="button danger" style="flex: 1; padding: clamp(12px, 3.5vw, 15px);" onclick="stopFocusMode()" id="focusSessionControlButton">End Session</button>
                    <button class="button button-secondary" style="flex: 0 0 auto; padding: clamp(12px, 3.5vw, 15px);" onclick="openEditFocusModeModal()" aria-label="Edit focus session settings"><i class="fas fa-cog"></i></button>
                </div>
            </div>
        </div>
        
        <div id="emergencyDashboardModal" class="modal" role="dialog" aria-modal="true" aria-labelledby="emergencyDashboardModalTitle">
            <div class="modal-content">
                <button class="modal-close-button" onclick="closeModal('emergencyDashboardModal')" aria-label="Close emergency dashboard"><i class="fas fa-xmark"></i></button>
                <h3 id="emergencyDashboardModalTitle" class="modal-title" style="color:var(--danger-color);"><i class="fas fa-triangle-exclamation"></i> Emergency Dashboard</h3>
                <p class="card-subtitle mb-3">Quick access to emergency services and help. Use responsibly.</p>
                <div style="display:flex; flex-direction:column; gap:var(--space-md);">
                    <a href="tel:999" class="button danger" style="text-decoration:none;"><i class="fas fa-phone-volume"></i> Call Emergency Services (999)</a>
                    <button class="button" onclick="shareLiveLocation()"><i class="fas fa-map-marker-alt"></i> Share Live Location</button>
                    <button class="button button-secondary" onclick="alertTrustedCircle()"><i class="fas fa-users"></i> Alert Trusted Circle</button>
                    <button class="button button-secondary" onclick="findNearbyHelp()"><i class="fas fa-hand-holding-medical"></i> Find Nearby Help</button>
                </div>
                <p class="card-subtitle mt-3" style="font-size:0.8rem;"><strong>AI Feature:</strong> In an emergency, AI can listen for keywords to add context to alerts and analyze your recent activity (e.g., last known location from Explore) to inform responders.</p>
            </div>
        </div>

        <div id="arViewModal" class="modal" role="dialog" aria-modal="true" aria-labelledby="arViewModalTitle">
            <div class="modal-content">
                <div class="ar-view-container">
                    <video id="arVideo" playsinline autoplay muted loop></video>
                    <div id="arOverlay" class="ar-overlay">
                        <h4>Point camera to discover</h4>
                    </div>
                    <div class="ar-ui-bottom">
                         <p>Point your camera at a place to see info.</p>
                         <button class="button mt-2" onclick="closeModal('arViewModal')">Exit AR Mode</button>
                    </div>
                </div>
            </div>
        </div>
        
        <div id="editFocusModeModal" class="modal" role="dialog" aria-modal="true" aria-labelledby="editFocusModeModalTitle">
            <div class="modal-content">
                <button class="modal-close-button" onclick="closeModal('editFocusModeModal')" aria-label="Close focus settings"><i class="fas fa-xmark"></i></button>
                <h3 id="editFocusModeModalTitle" class="modal-title">Edit Focus Session</h3>
                <div class="input-group">
                    <label for="focusTaskSelect">Task to Focus On</label>
                    <select id="focusTaskSelect" class="input-field"></select>
                </div>
                <button class="button mt-2" style="width:100%" onclick="applyFocusModeChanges()">Update Session</button>
            </div>
        </div>

        <div id="privacySettingsModal" class="modal"role="dialog" aria-modal="true" aria-labelledby="privacySettingsModalTitle">
            <div class="modal-content">
                <button class="modal-close-button" onclick="closeModal('privacySettingsModal')" aria-label="Close privacy settings"><i class="fas fa-xmark"></i></button>
                <h3 id="privacySettingsModalTitle" class="modal-title">Privacy & Security</h3>
                <div class="settings-list" style="padding:0;">
                    <div class="setting-item">
                        <span class="setting-label">Biometric Lock (Pro)</span>
                        <button class="toggle-switch-button" id="biometricLockToggle" onclick="toggleBiometricLock(this)"><span class="toggle-switch"></span></button>
                    </div>
                     <div class="setting-item">
                        <span class="setting-label">Privacy Sandbox Mode</span>
                         <button class="toggle-switch-button" onclick="this.firstChild.classList.toggle('active'); showToast('Privacy Sandbox toggled. Notes/tasks in this mode are local-only and not used by AI.', 'info')"><span class="toggle-switch"></span></button>
                    </div>
                     
                     <div class="setting-item" role="button" tabindex="0" onclick="showToast('Backing up data to encrypted cloud storage...', 'success')">
                        <span class="setting-label">Encrypted Cloud Backup</span>
                        <span class="setting-value">Back Up Now</span>
                    </div>
                     <div class="setting-item" role="button" tabindex="0" onclick="openDataImportModal()">
                        <span class="setting-label">Import User Data</span><i class="fas fa-file-import"></i>
                    </div>
                </div>
                 <p class="card-subtitle mt-3" style="font-size:0.8rem;">Manage device permissions (location, camera) in your phone's settings. AI data usage is controlled in AI Learning Preferences.</p>
                <button class="button mt-2" style="width:100%" onclick="exportUserData()">Export My Data (JSON)</button>
            </div>
        </div>
        
        <div id="integrationSettingsModal" class="modal" role="dialog" aria-modal="true" aria-labelledby="integrationSettingsModalTitle">
            <div class="modal-content">
                <button class="modal-close-button" onclick="closeModal('integrationSettingsModal')" aria-label="Close integration settings"><i class="fas fa-xmark"></i></button>
                <h3 id="integrationSettingsModalTitle" class="modal-title">Connected Apps</h3>
                <p class="card-subtitle mb-2">Sync with other services to supercharge your AI.</p>
                <div class="settings-list" id="integrationSettingsList" style="padding:0;"></div>
                 <div class="input-group mt-3">
                    <label for="newAppIntegrationInput">Add New App Integration</label>
                    <input type="text" id="newAppIntegrationInput" class="input-field" placeholder="e.g., Strava">
                </div>
                <button class="button mt-1" style="width:100%" onclick="addAppIntegration()">Add App</button>
            </div>
        </div>
        <div id="subscriptionModal" class="modal" role="dialog" aria-modal="true" aria-labelledby="subscriptionModalTitle">
            <div class="modal-content">
                <button class="modal-close-button" onclick="closeModal('subscriptionModal')" aria-label="Close subscription details"><i class="fas fa-xmark"></i></button>
                <h3 id="subscriptionModalTitle" class="modal-title">LocalLife OS Subscription</h3>
                <p class="card-subtitle">Unlock the full potential of your hyperlocal experience with a Pro subscription.</p>
                <div class="subscription-tiers">
                    <div id="tier-free" class="tier-card">
                        <h4 class="tier-title">Free</h4>
                        <div class="tier-price">
                            E0<span class="period">/mo</span>
                        </div>
                        <ul class="tier-features">
                            <li><i class="fas fa-check-circle"></i>Core Planner & Explore</li>
                            <li><i class="fas fa-check-circle"></i>Standard AI Assistant</li>
                            <li><i class="fas fa-check-circle"></i>Community Chat Access</li>
                            <li class="disabled"><i class="fas fa-times-circle"></i>Advanced AI Personalities</li>
                            <li class="disabled"><i class="fas fa-times-circle"></i>AI News & Chat Summaries</li>
                            <li class="disabled"><i class="fas fa-times-circle"></i>AI Itinerary Planning</li>
                        </ul>
                        <button class="button button-secondary" disabled>Current Plan</button>
                    </div>
                    <div id="tier-pro" class="tier-card recommended">
                        <h4 class="tier-title">Pro</h4>
                        <div class="tier-price">
                            E99<span class="period">/mo</span>
                        </div>
                        <ul class="tier-features">
                           <li><i class="fas fa-check-circle"></i>Everything in Free, plus:</li>
                            <li><i class="fas fa-check-circle"></i><b>All AI Personalities</b></li>
                            <li><i class="fas fa-check-circle"></i><b>AI News & Chat Summaries</b></li>
                             <li><i class="fas fa-check-circle"></i>Advanced Wellness Insights</li>
                            <li class="disabled"><i class="fas fa-times-circle"></i>AI Itinerary Planning</li>
                        </ul>
                        <button class="button" data-tier="pro" onclick="handleSubscriptionChange('pro')">Upgrade to Pro</button>
                    </div>
                    <div id="tier-pro-plus" class="tier-card">
                        <h4 class="tier-title">Pro+</h4>
                         <div class="tier-price">
                            E199<span class="period">/mo</span>
                        </div>
                         <ul class="tier-features">
                            <li><i class="fas fa-check-circle"></i>Everything in Pro, plus:</li>
                            <li><i class="fas fa-check-circle"></i><b>AI Itinerary Planning</b></li>
                            <li><i class="fas fa-check-circle"></i>Priority Support</li>
                            <li><i class="fas fa-check-circle"></i>Family Sharing (up to 5)</li>
                        </ul>
                        <button class="button" data-tier="pro_plus" onclick="handleSubscriptionChange('pro_plus')">Upgrade to Pro+</button>
                    </div>
                </div>
            </div>
        </div>

        <div id="aiWellnessToolsModal" class="modal" role="dialog" aria-modal="true" aria-labelledby="aiWellnessToolsModalTitle">
            <div class="modal-content">
                <button class="modal-close-button" onclick="closeModal('aiWellnessToolsModal')"><i class="fas fa-xmark"></i></button>
                <h3 class="modal-title" id="aiWellnessToolsModalTitle">AI Wellness Summary & Tools</h3>
                <div id="aiWellnessSummaryBody" class="modal-body"></div>
                 <h4 class="mt-3" style="font-size: 1rem; font-weight: 600;">Tools for You</h4>
                 <div class="planner-actions-container mt-2">
                    <button class="button button-secondary" onclick="closeModal('aiWellnessToolsModal'); openJournalModal();"><i class="fas fa-feather-alt"></i> Journal</button>
                    <button class="button button-secondary" onclick="closeModal('aiWellnessToolsModal'); openGuidedExerciseModal();"><i class="fas fa-spa"></i> Breathe</button>
                 </div>
                 <button class="button mt-2" style="width:100%;" onclick="closeModal('aiWellnessToolsModal');">Okay, Got It!</button>
            </div>
        </div>

        <div id="bulletinCommentsModal" class="modal" role="dialog" aria-modal="true" aria-labelledby="bulletinCommentsModalTitle">
             <div class="modal-content">
                <button class="modal-close-button" onclick="closeModal('bulletinCommentsModal')" aria-label="Close comments"><i class="fas fa-xmark"></i></button>
                <h3 id="bulletinCommentsModalTitle" class="modal-title">Comments</h3>
                <div id="bulletinCommentsList" class="chat-messages-area" style="background:var(--bg-color); max-height: 40vh; padding: var(--space-sm); border-radius: var(--border-radius-md);"></div>
                <div class="chat-input-container" style="padding:var(--space-sm) 0 0 0;">
                    <div class="chat-input-wrapper">
                         <textarea id="bulletinCommentInput" class="input-field chat-input" placeholder="Add a comment..." rows="1" oninput="autoGrowTextarea(this);"></textarea>
                    </div>
                    <button id="bulletinCommentSubmit" class="chat-input-action-button" onclick="submitBulletinComment()"><i class="fas fa-paper-plane"></i></button>
                </div>
             </div>
        </div>

        <div id="dataImportModal" class="modal" role="dialog" aria-modal="true" aria-labelledby="dataImportModalTitle">
            <div class="modal-content">
                <button class="modal-close-button" onclick="closeModal('dataImportModal')" aria-label="Close data import"><i class="fas fa-xmark"></i></button>
                <h3 id="dataImportModalTitle" class="modal-title">Import User Data</h3>
                <p class="card-subtitle mb-2">Select a `LocalLifeOS_data.json` file to import your data.</p>
                <input type="file" id="importFileInput" class="input-field" accept=".json">
                <button class="button mt-2" style="width:100%;" onclick="handleDataImport()">Import Data</button>
            </div>
        </div>

        <div id="applet-localRideshare-modal" class="modal" role="dialog" aria-modal="true" aria-labelledby="applet-localRideshare-title">
            <div class="modal-content">
                <button class="modal-close-button" onclick="closeModal('applet-localRideshare-modal')"><i class="fas fa-xmark"></i></button>
                <h3 class="modal-title" id="applet-localRideshare-title"><i class="fas fa-car" style="color:#FFC107"></i> Local Rideshare</h3>
                <p class="card-subtitle mb-2">Book a ride with a trusted community driver.</p>
                <div class="input-group">
                    <label for="ride-pickup">Pickup Location</label>
                    <div style="display: flex; gap: var(--space-sm);">
                        <input type="text" id="ride-pickup" class="input-field" placeholder="e.g., Mbabane, Bus Rank">
                        <button class="button button-secondary" onclick="useCurrentLocationForRide()"><i class="fas fa-location-arrow"></i></button>
                    </div>
                </div>
                <div class="input-group">
                    <label for="ride-destination">Destination</label>
                    <input type="text" id="ride-destination" class="input-field" placeholder="e.g., The Gables, Ezulwini">
                </div>
                <button class="button" id="findRideButton" style="width:100%" onclick="showToast('Searching for nearby community drivers...', 'ai_info')" disabled>Find Ride</button>
            </div>
        </div>

        <div id="applet-groupExpense-modal" class="modal" role="dialog" aria-modal="true" aria-labelledby="applet-groupExpense-title">
            <div class="modal-content">
                <button class="modal-close-button" onclick="closeModal('applet-groupExpense-modal')"><i class="fas fa-xmark"></i></button>
                <h3 class="modal-title" id="applet-groupExpense-title"><i class="fas fa-receipt" style="color:#64B5F6"></i> Group Expense Splitter</h3>
                <p class="card-subtitle mb-2">Split a bill with your group.</p>
                <div class="input-group">
                    <label for="expense-amount">Total Bill Amount (E)</label>
                    <input type="number" id="expense-amount" class="input-field" placeholder="e.g., 250.00">
                </div>
                 <div class="input-group">
                    <label for="expense-tip">Tip (%)</label>
                    <input type="number" id="expense-tip" class="input-field" value="10" min="0">
                </div>
                <div class="input-group">
                    <label for="expense-participants">Participants</label>
                    <div id="expense-participant-list">
                        <input type="text" class="input-field mb-1" placeholder="Participant 1 (You)" value="You">
                        <input type="text" class="input-field mb-1" placeholder="Participant 2">
                    </div>
                    <button class="button button-secondary mt-1" style="font-size:0.8rem; padding: 4px 8px;" onclick="addExpenseParticipant()">+ Add Person</button>
                </div>
                <button class="button" style="width:100%" onclick="calculateSplit()">Calculate Split</button>
                <div id="split-result" class="mt-3"></div>
            </div>
        </div>

        <div id="applet-siswatiTutor-modal" class="modal" role="dialog" aria-modal="true" aria-labelledby="applet-siswatiTutor-title">
            <div class="modal-content">
                <button class="modal-close-button" onclick="closeModal('applet-siswatiTutor-modal')"><i class="fas fa-xmark"></i></button>
                <h3 class="modal-title" id="applet-siswatiTutor-title"><i class="fas fa-language" style="color:#9575CD"></i> SiSwati Tutor AI</h3>
                <div id="siswatiTutorContent">
                     <div class="empty-state"><i class="fas fa-spinner fa-spin"></i><p>Loading quiz...</p></div>
                </div>
            </div>
        </div>
        
        <div id="forgotPasswordModal" class="modal" role="dialog" aria-modal="true" aria-labelledby="forgotPasswordModalTitle">
            <div class="modal-content">
                <button class="modal-close-button" onclick="closeModal('forgotPasswordModal')" aria-label="Close forgot password form"><i class="fas fa-xmark"></i></button>
                <h3 id="forgotPasswordModalTitle" class="modal-title">Forgot Password</h3>
                <p class="card-subtitle mb-2">Enter your email address to receive a password reset link.</p>
                <div class="input-group">
                    <label for="recoveryEmail">Email Address</label>
                    <input type="email" id="recoveryEmail" class="input-field" placeholder="you@example.com" required>
                </div>
                <button class="button" style="width:100%;" onclick="handlePasswordRecovery()">Send Reset Link</button>
            </div>
        </div>

        <div id="aiItineraryModal" class="modal" role="dialog" aria-modal="true" aria-labelledby="aiItineraryModalTitle">
            <div class="modal-content">
                <button class="modal-close-button" onclick="closeModal('aiItineraryModal')"><i class="fas fa-xmark"></i></button>
                <h3 class="modal-title" id="aiItineraryModalTitle"><i class="fas fa-magic-wand-sparkles"></i> AI Itinerary Planner</h3>
                <p class="card-subtitle mb-2">Let AI create a personalized plan for you!</p>
                <div class="input-group">
                    <label for="itinerary-occasion">What's the occasion?</label>
                    <input type="text" id="itinerary-occasion" class="input-field" placeholder="e.g., A relaxing afternoon, a date night">
                </div>
                <div class="input-group">
                    <label for="itinerary-budget">Budget (Optional)</label>
                    <select id="itinerary-budget" class="input-field">
                        <option value="any">Any</option>
                        <option value="low">Low (E0 - E200)</option>
                        <option value="medium">Medium (E200 - E500)</option>
                        <option value="high">High (E500+)</option>
                    </select>
                </div>
                <button class="button" style="width:100%" onclick="generateAiItinerary()">Generate Itinerary</button>
                <div id="itinerary-result" class="mt-3"></div>
            </div>
        </div>
        
        <div id="applet-loadShedding-modal" class="modal" role="dialog" aria-modal="true" aria-labelledby="applet-loadShedding-title">
            <div class="modal-content">
                <button class="modal-close-button" onclick="closeModal('applet-loadShedding-modal')"><i class="fas fa-xmark"></i></button>
                <h3 class="modal-title" id="applet-loadShedding-title"><i class="fas fa-power-off" style="color:#E07A5F"></i> Load Shedding Info</h3>
                <div id="loadSheddingContent"></div>
            </div>
        </div>

        <div id="newMessageModal" class="modal" role="dialog" aria-modal="true" aria-labelledby="newMessageModalTitle">
            <div class="modal-content">
                <button class="modal-close-button" onclick="closeModal('newMessageModal')"><i class="fas fa-xmark"></i></button>
                <h3 id="newMessageModalTitle" class="modal-title">Start New Message</h3>
                <p class="card-subtitle mb-2">Select a user to start a direct message with.</p>
                <div id="newMessageUserList" class="settings-list" style="padding:0;"></div>
            </div>
        </div>

        <div id="toastNotification" class="toast-notification" role="status" aria-live="assertive"></div>
        <input type="file" id="nativeFileUpload" class="hidden" accept="image/*,video/*,.pdf,.doc,.docx">
        <div id="lockScreen" class="hidden">
            <i class="fas fa-fingerprint auth-logo"></i>
            <p>App Locked</p>
            <button class="button" onclick="unlockApp()">Authenticate to Unlock</button>
        </div>
    </div>

<script>
    
    const OPENWEATHER_API_KEY = "09a1e53699f97f22f6a5334c56063624"; 
    const authContainer = document.getElementById('authContainer');
    const appContainer = document.querySelector('.app-container');
    const contentContainer = document.querySelector('.content');
    const screens = document.querySelectorAll('.screen');
    const navItems = document.querySelectorAll('.nav-item');
    const aiFab = document.getElementById('aiFab');
    const aiFabIcon = document.getElementById('aiFabIcon');
    const aiBottomSheet = document.getElementById('aiBottomSheet');
    const aiChatArea = document.getElementById('aiChatArea');
    const aiChatInputText = document.getElementById('aiChatInputText');
    const aiChatTypingSuggestionEl = document.getElementById('aiChatTypingSuggestion');
    const toastNotification = document.getElementById('toastNotification');
    const dynamicIsland = document.getElementById('dynamicIslandAlert');
    const lockScreen = document.getElementById('lockScreen');
    let dynamicIslandTimeout;
    let currentOpenModalId = null;
    let toastTimeout;
    let currentAiPersonality = 'neutral'; 
    let aiConversationContext = null; 
    let aiExpectedResponseType = null;
    let exploreSearchDebounceTimeout;
    let fabSuggestionTimeout;
    let mockUserSuggestionPopupTimeout;
    let userName = 'Shamase';
    let userLocationCoords = { lat: -26.3056, lng: 31.1428 }; 
    let calendarCurrentDate = new Date();
    let currentCalendarType = 'tasks';
    let breathingInterval;
    let breathingPace = { name: 'relax', inhale: 4000, hold1: 4000, exhale: 6000, hold2: 1000, steps: 6 };
    let breathingIsActive = false;
    let focusQuoteInterval;
    let userLevel = 1;
    let userXP = 0;
    let xpToNextLevel = 100;
    let unlockedBadges = new Set();
    let userSubscriptionTier = 'free';
    let map;
    let currentPositionMarker;
    let heatmap;
    let mapPolygons = [];
    let mapMarkers = [];
    let isAppLocked = false;
    let emergencyKeywordRecognition;
    let saveDestinationPreference = false;

    
    const native = {
        geolocation: {
            getCurrent: (success, error) => {
                 if (navigator.geolocation) {
                    navigator.geolocation.getCurrentPosition(success, error);
                } else {
                    showToast("Geolocation is not supported by this browser.", "error");
                    if(error) error();
                }
            }
        },
        speechToText: (context) => {
            startVoiceRecognition(context === 'specific' ? 'specificChatInput' : 'aiChatInputText', context === 'specific' ? sendSpecificChatMessage : sendAIChatMessage);
        },
        textToSpeech: (text) => {
            speakText(text);
        },
        filePicker: (context, useCamera = false) => {
            document.getElementById('nativeFileUpload').click();
        },
        showNotification: (title, options) => {
            if (!("Notification" in window)) {
                showToast(`Notification (blocked): ${title} - ${options.body}`, 'info');
                return;
            }
            if (Notification.permission === "granted") {
                try {
                    navigator.serviceWorker.ready.then(registration => {
                        registration.showNotification(title, options);
                    });
                } catch (e) {
                     new Notification(title, options);
                }
            } else if (Notification.permission !== "denied") {
                Notification.requestPermission().then(permission => {
                    if (permission === "granted") {
                        try {
                           navigator.serviceWorker.ready.then(registration => {
                                registration.showNotification(title, options);
                           });
                        } catch(e) {
                            new Notification(title, options);
                        }
                    }
                });
            } else {
                 showToast(`Push notifications are disabled in your browser settings.`, 'error');
            }
        },
        requestNotificationPermission: () => {
             if ('Notification' in window && Notification.permission !== 'granted' && Notification.permission !== 'denied') {
                Notification.requestPermission();
            }
        },
        addToCalendar: (task) => {
            createCalendarEvent(task);
        },
        share: (type, data) => {
            shareContent(type, data);
        },
        authenticate: (callback) => {
            
            setTimeout(() => {
                const success = true; 
                callback(success);
            }, 500);
        }
    };

    let tasks = [
        { id: 1, title: "Submit ERS Tax Returns", time: "Before 5 PM", category: "work", completed: false, notes: "Ensure all income sources are declared.", dueDate: "2024-07-26", recurrence: "none", aiParsedDetails: { project: "Tax Returns", entity: "ERS"} },
        { id: 2, title: "Morning walk at Mlilwane Sanctuary", time: "7:00 AM - 8:00 AM", category: "health", completed: true, notes: "Look for zebras near the camp.", dueDate: new Date().toISOString().split('T')[0], recurrence: "daily", aiParsedDetails: {location: "Mlilwane"} },
        { id: 3, title: "Pay EEC bill at The Gables", time: "Geo: Near \"The Gables\"", category: "errands", completed: false, notes: "Account #12345", dueDate: new Date().toISOString().split('T')[0], recurrence: "none", aiParsedDetails: {item: "EEC bill", location: "The Gables"}},
        { id: 4, title: "Read 'Long Walk to Freedom' Chapter 5", time: "Evening", category: "learning", completed: false, notes: "Reflect on the themes of resilience.", dueDate: new Date(Date.now() + 86400000).toISOString().split('T')[0], recurrence: "none", aiParsedDetails: {book: "Long Walk to Freedom"}},
        { id: 5, title: "Call Gogo about weekend plans", time: "After 5 PM", category: "personal", completed: false, notes: "Ask if she needs anything from town.", dueDate: new Date().toISOString().split('T')[0], recurrence: "none", aiParsedDetails: {person: "Gogo", topic: "weekend plans"}}
    ];
    let nextTaskId = 6;
    const mockPlaces = {
        all: [
            { id: 1, name: "Malandela's Restaurant", details: "Farm-to-table dining, local ingredients - <span class='rating'><i class='fas fa-star'></i> 4.6</span> (150 reviews)", sub: "Open until 9 PM", type: "food", img: "https://source.unsplash.com/random/60x60/?restaurant,farmhouse", saved:false, openNow: true, rating: 4.6, aiSummary: "Visitors praise the atmosphere and fresh food. A local favorite for special occasions.", tags: ["restaurant", "local-cuisine", "dinner", "scenic", "popular"], position: {lat: -26.4950, lng: 31.1969} },
            { id: 2, name: "Mlilwane Wildlife Sanctuary", details: "Nature reserve with zebras, antelope, hiking & biking trails.", sub: "Open 6 AM - 6 PM", type: "parks", img: "https://source.unsplash.com/random/60x60/?zebra,savannah", saved:true, openNow: true, rating: 4.8, aiSummary: "Perfect for family outings and experiencing Eswatini's nature up close. The sunset drives are a must-do.", tags: ["nature", "hiking", "family", "wildlife", "outdoors", "scenic", "adventure", "must-see"], position: {lat: -26.4883, lng: 31.1517} },
            { id: 3, name: "MTN Bushfire Festival", details: "Annual international music & arts festival - <span class='rating'><i class='fas fa-fire'></i> Major Event</span>", sub: "Annually in May @ House on Fire", type: "events", img: "https://source.unsplash.com/random/60x60/?music,festival", saved:false, openNow: false, rating: 4.9, aiSummary: "A world-renowned event celebrating music, arts, and culture. AI recommends booking accommodation far in advance.", tags: ["event", "music", "festival", "international", "vibrant"], position: {lat: -26.4950, lng: 31.1969} }, 
            { id: 4, name: "The Gables Shopping Centre", details: "Shopping mall with cinema, restaurants, and various stores.", sub: "Closes at 7 PM", type: "shops", img: "https://source.unsplash.com/random/60x60/?shopping,mall", saved:false, openNow: true, rating: 4.3, aiSummary: "The main hub for shopping and entertainment in the Ezulwini valley.", tags: ["shopping", "cinema", "food", "services", "family"], position: {lat: -26.4172, lng: 31.1764} },
            { id: 5, name: "Vickery Seedlings", details: "Garden centre with a wide variety of plants, seeds, and tools.", sub: "Open 8 AM - 5 PM", type: "shops", img: "https://source.unsplash.com/random/60x60/?garden,plants", saved:false, openNow: true, rating: 4.5, aiSummary: "Highly rated for its healthy plants and knowledgeable staff. A must-visit for gardeners.", tags: ["gardening", "plants", "nursery", "local", "hobby"], position: {lat: -26.4421, lng: 31.1895} },
            { id: 6, name: "Sibebe Rock", details: "World's second-largest monolith. Challenging hiking trail.", sub: "Best hiked in the morning", type: "parks", img: "https://source.unsplash.com/random/60x60/?rock,mountain", saved: true, openNow: true, rating: 4.7, aiSummary: "Offers breathtaking views from the top. The hike is strenuous but rewarding. AI suggests taking plenty of water.", tags: ["hiking", "nature", "adventure", "scenic", "challenging"], position: {lat: -26.2653, lng: 31.1444} }, 
            { id: 7, name: "Manzini Market", details: "Bustling market with crafts, fresh produce, and local goods.", sub: "Busiest on Thursdays", type: "events", img: "https://source.unsplash.com/random/60x60/?market,africa", saved: false, openNow: true, rating: 4.4, aiSummary: "An authentic local experience. Great for souvenirs and fresh food. Be prepared for crowds.", tags: ["market", "local", "crafts", "food", "shopping", "vibrant"], position: {lat: -26.4947, lng: 31.3787}},
            { id: 8, name: "Ngwenya Glass", details: "Glassblowing factory creating unique items from recycled glass.", sub: "Factory tours available", type: "shops", img: "https://source.unsplash.com/random/60x60/?glass,blowing", saved:false, openNow: true, rating: 4.6, aiSummary: "Fascinating to watch the artisans at work. The products are beautiful and eco-friendly.", tags: ["crafts", "art", "local", "recycled", "tourist"], position: {lat: -26.2167, lng: 31.0333} },
        ],
        events: [], food: [], shops: [], parks: [], services: [], open_now: [], ai_recommended: [], bulletin: [], saved: []
    };
    mockPlaces.all.forEach(place => {
        if (!mockPlaces[place.type]) mockPlaces[place.type] = [];
        mockPlaces[place.type].push(place);
        if (place.openNow) mockPlaces.open_now.push(place);
        if (place.rating >= 4.5 && place.type !== 'events') mockPlaces.ai_recommended.push(place);
        if (place.saved) mockPlaces.saved.push(place);
    });
    let mockUsers = {
        'user': { id: 'user', name: 'Shamase Local', username: '@shamase_local', avatarUrl: 'https://i.pravatar.cc/40?u=user', bio: 'Exploring the beauty of Eswatini!', location: 'Mbabane', interests: 'hiking, local music, technology' },
        'sbuD': { id: 'sbuD', name: 'Sbu Dlamini', username: '@sbu_d', avatarUrl: 'https://i.pravatar.cc/40?u=sbuD', bio: 'Into photography and nature.', location: 'Manzini', interests: 'outdoors, photography, cars' },
        'nomsaM': { id: 'nomsaM', name: 'Nomsa M.', username: '@nomsaM', avatarUrl: 'https://i.pravatar.cc/40?u=nomsaM', bio: 'Foodie and market lover, new to Ezulwini.', location: 'Ezulwini', interests: 'cooking, markets, gardening' },
        'thaboK': { id: 'thaboK', name: 'Thabo Khumalo', username: '@thaboK', avatarUrl: 'https://i.pravatar.cc/40?u=thaboK', bio: 'Tech enthusiast and community volunteer.', location: 'Mbabane', interests: 'volunteering, gadgets, community events'},
        'defaultBot': { id: 'defaultBot', name: 'LocalLife AI', username: '@ai_assistant', avatarUrl: 'https://i.pravatar.cc/40?u=aiBot', bio: 'Your friendly neighborhood AI assistant.', location: 'The Cloud', interests: 'efficiency, data, helping people'}
    };
    let mockChannels = [
        { id: 1, name: 'Mbabane Community Updates', icon: 'fas fa-bullhorn', color: 'var(--moss-green)', type: 'announcements', description: "Official news and updates for Mbabane residents.", lastMessage: "City Council: Roadworks on Gwamile St.", lastMessageTimestamp: new Date(Date.now() - 3600000 * 1), unreadCount: 1, isJoined: true, isFavorite: false, lastOpened: new Date(Date.now() - 86400000 * 2), messages: [{ mid: 101, senderId: 'defaultBot', text: 'City Council: Roadworks on Gwamile St this weekend. Plan alternative routes.', timestamp: new Date(Date.now() - 3600000 * 2), reactions:{'': {count:1, users:['sbuD']}} }, { mid: 102, senderId: 'user', text: 'Thanks for the update!', timestamp: new Date(Date.now() - 3600000 * 1.5), reactions:{} }, { mid: 103, senderId: 'defaultBot', text: 'You are welcome.', timestamp: new Date(Date.now() - 3600000 * 1), reactions:{'':{count:1, users:['user']}} }] },
        { id: 2, name: 'Eswatini Hikers Club', icon: 'fas fa-hiking', color: 'var(--soft-blue)', type: 'hobby', description: "Planning hikes to Sibebe, Malolotja, and more.", lastMessage: "Sbu: Anyone for a Sibebe hike Saturday?", lastMessageTimestamp: new Date(Date.now() - 1800000), unreadCount: 3, isJoined: true, isFavorite: true, lastOpened: new Date(Date.now() - 3600000 * 5), messages: [{ mid: 201, senderId: 'sbuD', text: "Anyone for a Sibebe hike Saturday morning?", timestamp: new Date(Date.now() - 1800000), reactions:{} }, { mid: 202, senderId: 'thaboK', text: "I'm in! What time?", timestamp: new Date(Date.now() - 1700000), reactions:{'': {count:1, users:['sbuD']}} }, { mid: 203, senderId: 'user', text: "Sounds great, count me in!", timestamp: new Date(Date.now() - 1500000), reactions:{'': {count:1, users:['thaboK']}} }] },
        { id: 3, name: 'Eswatini Foodies', icon: 'fas fa-utensils', color: 'var(--muted-terracotta)', type: 'general', description: "Discover new restaurants, share recipes, and talk all things food!", lastMessage: "Nomsa: Malandela's was amazing last night!", lastMessageTimestamp: new Date(Date.now() - 7200000), unreadCount: 8, isJoined: true, isFavorite: false, lastOpened: new Date(Date.now() - 86400000), messages: [{ mid: 301, senderId: 'nomsaM', text: "Malandela's was amazing last night! The steak was perfect.", timestamp: new Date(Date.now() - 7200000), reactions:{'':{count:2, users:['user', 'sbuD']}} } ] },
        { id: 4, name: 'Eswatini Events', icon: 'fas fa-calendar-check', color: 'var(--primary-accent)', type: 'local_events', description: "Discussions about upcoming events like Bushfire, festivals, and local gigs.", lastMessage: "New: Thabo: Bushfire early bird tickets are live!", lastMessageTimestamp: new Date(Date.now() - 30000), unreadCount: 0, isJoined: false, isFavorite: false, messages: [{ mid: 401, senderId: 'thaboK', text: "Bushfire early bird tickets are live on their website!", timestamp: new Date(Date.now() - 30000), reactions:{}}]},
    ];
    let nextChannelId = mockChannels.length + 1;
    let nextMessageId = 502;
    const channelTypeLabels = {
        general: "General", skill_swap: "Skill Swap", hobby: "Hobby Group", announcements: "Announcements", local_events: "Local Events", direct_message: "Direct Message"
    };
    let habits = [
        { id: 1, name: "Drink 2 litres of water daily", goal: 8, current: 6, unit: "glasses", streak: 5, icon: "fas fa-glass-water", color: "var(--soft-blue)", isWaterTracker: true},
        { id: 2, name: "Read for 30 minutes before bed", goal: 1, current: 1, unit: "session", streak: 12, icon: "fas fa-book-open", color: "var(--moss-green)"},
        { id: 3, name: "10 min Morning Meditation", goal: 1, current: 0, unit: "session", streak: 0, icon: "fas fa-brain", color: "var(--muted-terracotta)"},
        { id: 4, name: "Practice SiSwati for 10 mins", goal: 1, current: 1, unit: "lesson", streak: 25, icon: "fas fa-language", color: "#FFC107"},
    ];
    let nextHabitId = habits.length + 1;
    let loggedMoods = []; 
    let sleepData = []; 
    const availableIcons = ['fas fa-star', 'fas fa-heart', 'fas fa-tree', 'fas fa-building', 'fas fa-bicycle', 'fas fa-gamepad', 'fas fa-music', 'fas fa-paint-brush', 'fas fa-users', 'fas fa-comments', 'fas fa-lightbulb', 'fas fa-briefcase', 'fas fa-code', 'fas fa-language', 'fas fa-wrench', 'fas fa-seedling', 'fas fa-graduation-cap', 'fas fa-dumbbell', 'fas fa-apple-alt', 'fas fa-person-walking', 'fas fa-book-open', 'fas fa-brain', 'fas fa-glass-water', 'fas fa-wine-bottle'];
    const availableColors = ['var(--primary-accent)', 'var(--moss-green)', 'var(--soft-blue)', 'var(--muted-terracotta)', '#FFC107', '#9575CD', '#9CCC65', '#F06292'];
    const journalPrompts = [
        "What's one small thing that brought you joy today, and how can you invite more of it into your week?",
        "Describe a challenge you faced recently. How did you handle it, and what did you learn?",
        "What are you grateful for right now? List three things.",
        "If you could give your younger self one piece of advice, what would it be?",
        "What's a skill you'd like to learn or improve, and what's one step you can take towards it?"
    ];
    const safetyTickerMessages = [
        "Load shedding scheduled for Zone 3 (Mbabane West) from 6 PM - 8 PM.",
        "Traffic alert: congestion on the MR3 highway near Matsapha Industrial Site.",
        "High pollen count today in the Ezulwini Valley. Take precautions.",
        "Reminder: Eswatini Mobile is doing network maintenance tonight from 1 AM - 4 AM.",
        "Public health reminder: Stay hydrated during the heatwave."
    ];
    let currentSafetyTickerIndex = 0;
    let dashboardCardConfig = [
        { id: "localContextCard", name: "Local Context", visible: true }, 
        { id: "nearbyPulseSection", name: "Nearby Pulse", visible: true },
        { id: "newsSummaryCard", name: "AI News Summary", visible: true },
        { id: "dashboardTaskListCard", name: "Dynamic Day View", visible: true },
        { id: "pinnedWidgetsCard", name: "Pinned Widgets", visible: true },
        { id: "proactiveSuggestionsCard", name: "Smart Suggestions", visible: true },
        { id: "myAppletsCard", name: "My Applets", visible: true },
        { id: "topDealsCard", name: "Today's Top Deals", visible: true },
    ];
    let aiLearningPreferences = {
        learnSavedPlaces: true, learnMoodLogs: true, learnTaskPatterns: true, learnHabitTracking: true, learnChatStyle: false
    };
    let notificationPreferences = {
        dailyBriefing: true, aiSmartAlerts: true, allChatMessages: false, chatMentions: true, aiSuggestions: false, dealAlerts: false, taskReminders: true, saveDestination: false
    };
    let mockDeals = [
        { id: 1, title: "Two-for-One Pizza Tuesdays", description: "Buy any large pizza and get a second one of equal or lesser value free! Every Tuesday.", businessName: "Pizza Inn, Mbabane", category: "food", img: "https://source.unsplash.com/random/80x80/?pizza,deal", expiryDate: null, terms: "Valid on Tuesdays only. In-store or for collection." },
        { id: 2, title: "15% Off All MTN Bundles", description: "Get 15% off when you purchase any data or voice bundle through the LocalLife App this week.", businessName: "MTN Eswatini",category: "services", img: "https://source.unsplash.com/random/80x80/?mobile,phone", expiryDate: "2024-11-30", terms: "Must be purchased via the app. Limited time offer." },
        { id: 3, title: "Happy Hour at The Pub & Grill", description: "Half-price on all local beers and ciders from 4 PM - 6 PM daily.", businessName: "The Gables Pub & Grill", category: "food", img: "https://source.unsplash.com/random/80x80/?beer,pub", expiryDate: null, terms: "Daily 4 PM - 6 PM." },
        { id: 4, title: "10% Off at Swazi Candles", description: "Get 10% off your entire purchase when you spend E300 or more at the Swazi Candles Centre.", businessName: "Swazi Candles Centre", category: "retail", img: "https://source.unsplash.com/random/80x80/?candles", expiryDate: "2024-08-04", terms: "Valid this weekend only." },
    ];
    let nextDealId = mockDeals.length + 1;
    const dealCategories = ["food", "services", "retail", "wellness", "other"]; 
    let mockNotifications = [
        { id: 1, icon: 'fas fa-comments', title: 'New message in "Eswatini Hikers"', text: 'SbuD: "Anyone for a Sibebe hike Saturday morning?"', timestamp: new Date(Date.now() - 3600000), read: false, type: 'chat_mention', action: () => { setActiveScreen('chat'); setTimeout(() => showSpecificChatView(2), 50); } },
        { id: 2, icon: 'fas fa-calendar-check', title: 'Task Reminder: Submit ERS Returns', text: 'Due today before 5 PM.', timestamp: new Date(Date.now() - 7200000), read: true, type: 'task_reminder', action: () => { setActiveScreen('planner'); } },
        { id: 3, icon: 'fas fa-brain', title: 'AI Suggestion: Lunch Spot', text: 'It\'s nearly lunchtime! Based on your preference for local cuisine, how about "e-Dladleni" in Malkerns?', timestamp: new Date(Date.now() - 10800000), read: false, type: 'ai_suggestion', action: () => { const place = mockPlaces.all.find(p=>p.name.includes("Malandela")); if(place) { setActiveScreen('explore'); setTimeout(() => showPlaceDetail(place), 50);} } },
    ];
    let nextNotificationId = mockNotifications.length + 1;
    let trustedContacts = [
        { id: 1, name: "Gogo", phone: "76021234" },
        { id: 2, name: "Sbu (Friend)", phone: "76056789" }
    ];
    let nextTrustedContactId = 3;
    let bulletinPosts = [
        { id: 1, title: "Lost: Brown Goat near Mantenga", content: "Our brown goat with a white spot on its head went missing near Mantenga cultural village yesterday. Answers to 'Mbali'. Please call 76XXXXXX if you see her!", category: "lost_found", authorId: "nomsaM", timestamp: new Date(Date.now() - 86400000 * 0.5), comments: [{senderId: 'thaboK', text: 'Hope you find her!', timestamp: new Date()}] },
        { id: 2, title: "Community Market This Saturday!", content: "Multi-family market at the Malkerns Club this Saturday from 8 AM to 2 PM. Fresh produce, crafts, and food stalls!", category: "event_promo", authorId: "thaboK", timestamp: new Date(Date.now() - 86400000 * 1.2), comments: [] }
    ];
    let nextBulletinPostId = 3;
    let mockApplets = [
        { id: 'loadShedding', name: 'Load Shedding', icon: 'fas fa-power-off', color: '#E07A5F', desc: 'Get real-time load shedding schedules for your area from EEC.', installed: true },
        { id: 'localRideshare', name: 'Local Rideshare', icon: 'fas fa-car', color: '#FFC107', desc: 'A community-based rideshare service (kombis & private).', installed: true },
        { id: 'siswatiTutor', name: 'SiSwati Tutor AI', icon: 'fas fa-language', color: '#9575CD', desc: 'Practice SiSwati with an AI tutor that knows local phrases.', installed: true },
        { id: 'groupExpense', name: 'Group Expense Splitter', icon: 'fas fa-receipt', color: '#64B5F6', desc: 'Easily split bills and expenses with friends from your community channels.', installed: true },
    ];
    let integratedApps = [
        { id: 'google_calendar', name: 'Google Calendar', icon: 'fab fa-google', connected: false },
        { id: 'whatsapp', name: 'WhatsApp', icon: 'fab fa-whatsapp', connected: false },
        { id: 'health_kit', name: 'HealthKit / Google Fit', icon: 'fas fa-heart-pulse', connected: false }
    ];
    let lastUserAction = "None recorded";
    document.addEventListener('keydown', (event) => { if (event.key === 'Escape' && currentOpenModalId) closeModal(currentOpenModalId); });
    function trackUserAction(action) {
        lastUserAction = action;
    }
    function populateIconSelector(selectorId, selectedIconClass = null) {
        const selector = document.getElementById(selectorId);
        if(!selector) return;
        selector.innerHTML = '';
        availableIcons.forEach(iconClass => {
            const option = document.createElement('button');
            option.type = 'button';
            option.className = 'icon-option';
            if (iconClass === selectedIconClass) option.classList.add('selected');
            option.innerHTML = `<i class="${iconClass}"></i>`;
            option.dataset.icon = iconClass;
            option.setAttribute('role', 'radio');
            option.setAttribute('aria-checked', iconClass === selectedIconClass ? 'true' : 'false');
            option.setAttribute('aria-label', iconClass.replace('fas fa-', '')); 
            option.onclick = () => {
                selector.querySelectorAll('.icon-option').forEach(el => {
                    el.classList.remove('selected');
                    el.setAttribute('aria-checked', 'false');
                });
                option.classList.add('selected');
                option.setAttribute('aria-checked', 'true');
            };
            selector.appendChild(option);
        });
    }
     function populateColorSelector(selectorId, selectedColorValue = null) {
        const selector = document.getElementById(selectorId);
        if(!selector) return;
        selector.innerHTML = '';
        availableColors.forEach(colorValue => {
            const option = document.createElement('button');
            option.type = 'button';
            option.className = 'icon-option'; 
            if (colorValue === selectedColorValue) option.classList.add('selected');
            
            const colorDot = document.createElement('div');
            colorDot.style.width = '24px';
            colorDot.style.height = '24px';
            colorDot.style.borderRadius = '50%';
            colorDot.style.backgroundColor = colorValue;
            colorDot.style.border = '1px solid rgba(0,0,0,0.1)'; 

            option.appendChild(colorDot);
            option.dataset.color = colorValue;
            option.setAttribute('role', 'radio');
            option.setAttribute('aria-checked', colorValue === selectedColorValue ? 'true' : 'false');
            option.setAttribute('aria-label', `Color ${colorValue}`); 
            option.onclick = () => {
                selector.querySelectorAll('.icon-option').forEach(el => {
                    el.classList.remove('selected');
                    el.setAttribute('aria-checked', 'false');
                });
                option.classList.add('selected');
                option.setAttribute('aria-checked', 'true');
            };
            selector.appendChild(option);
        });
    }
    function clearInputField(inputId, buttonEl) {
        const inputField = document.getElementById(inputId);
        if (inputField) inputField.value = '';
        if (buttonEl) buttonEl.classList.add('hidden');
        if (inputField) inputField.focus();
        if (inputId === 'exploreSearchInput') handleExploreSearch(true);
    }
    function setupInputClearButtons() {
        const inputsWithClear = [
            { inputId: 'newTaskInput', clearBtnId: 'clearNewTaskInput' },
            { inputId: 'exploreSearchInput', clearBtnId: 'clearExploreSearchInput' }
        ];
        inputsWithClear.forEach(item => {
            const input = document.getElementById(item.inputId);
            const btn = document.getElementById(item.clearBtnId);
            if (input && btn) {
                input.addEventListener('input', () => {
                    btn.classList.toggle('hidden', input.value === '');
                });
                btn.classList.toggle('hidden', input.value === '');
            }
        });
    }
    navItems.forEach(item => item.addEventListener('click', () => {
        trackUserAction(`Tapped Nav: ${item.dataset.screen}`);
        setActiveScreen(item.dataset.screen);
        if (navigator.vibrate) navigator.vibrate(10); 
    }));
    function getSkeletonTaskItem() {
        return `
            <div class="skeleton-list-item">
                <div class="skeleton-checkbox"></div>
                <div style="flex-grow:1;">
                    <div class="skeleton-text-line long"></div>
                    <div class="skeleton-text-line short"></div>
                </div>
            </div>`;
    }
    function getSkeletonPlaceCard() { 
        return `
            <article class="skeleton-card card no-press">
                <div class="skeleton-avatar" style="width:60px; height:60px; border-radius:var(--border-radius-md);"></div>
                <div class="skeleton-info">
                    <div class="skeleton-item title" style="height:16px; width:70%;"></div>
                    <div class="skeleton-item text" style="height:10px; width:90%;"></div>
                    <div class="skeleton-item text-short" style="height:10px; width:50%;"></div>
                </div>
            </article>`;
    }
    function getSkeletonChannelItem() {
        return `
            <div class="channel-item skeleton-list-item" style="padding: 12px 15px !important; align-items: center; background:var(--card-bg);">
                <div class="skeleton-avatar" style="width:48px; height:48px; border-radius:50%; margin-right: 12px;"></div>
                <div style="flex-grow:1;">
                    <div class="skeleton-text-line long" style="height:16px; width:60%; margin-bottom:4px;"></div>
                    <div class="skeleton-text-line short" style="height:12px; width:80%;"></div>
                </div>
                <div style="display:flex; flex-direction:column; align-items:flex-end;">
                     <div class="skeleton-item" style="height:10px; width:30px; margin-bottom:5px;"></div>
                     <div class="skeleton-item" style="height:18px; width:18px; border-radius:50%;"></div>
                </div>
            </div>`;
    }
    function getSkeletonHabitItem() {
         return `
            <div class="skeleton-list-item">
                 <div style="flex-grow:1;">
                    <div class="skeleton-text-line long"></div>
                    <div class="skeleton-text-line short"></div>
                </div>
                <div class="skeleton-avatar" style="width:40px; height:40px; border-radius:50%;"></div>
            </div>`;
    }
     function getSkeletonPinnedWidget() {
        return `
            <div class="pinned-widget-item">
                <div class="skeleton-item" style="width: 20px; height: 20px; border-radius: 4px; margin-bottom: 8px;"></div>
                <div class="skeleton-item title" style="width: 80%; height: 10px; margin-bottom: 5px;"></div>
                <div class="skeleton-item text-short" style="width: 60%; height: 12px;"></div>
            </div>`;
    }
    function renderDashboardTasks() {
        const container = document.getElementById('dashboardTaskList');
        const aiInsightContainer = document.getElementById('aiDashboardInsight');
        if (!container || !aiInsightContainer) return;
        container.innerHTML = Array(2).fill(getSkeletonTaskItem()).join('');
        container.setAttribute('aria-busy', 'true');
        aiInsightContainer.classList.add('hidden');
        setTimeout(() => {
            container.innerHTML = ''; 
            const today = new Date().toISOString().split('T')[0];
            const upcomingTasks = tasks.filter(t => !t.completed && (t.dueDate === today || t.dueDate === "Today" || !t.dueDate)).slice(0, 3); 
            if (upcomingTasks.length === 0) {
                container.innerHTML = `<div class="empty-state" style="padding:10px 0;"><i class="fas fa-check-circle"></i><p>All tasks done for now!</p></div>`;
                 aiInsightContainer.innerHTML = `<i class="fas fa-brain"></i> AI: Great job clearing your tasks, ${userName}! Time to relax or plan something fun.`;
                 aiInsightContainer.classList.remove('hidden');
            } else {
                upcomingTasks.forEach(task => {
                     const taskEl = document.createElement('div');
                     taskEl.className = 'task-item'; 
                     taskEl.setAttribute('role', 'listitem');
                     taskEl.innerHTML = `
                        <button class="task-checkbox-button" onclick="toggleTaskStatus(${task.id}, true)" aria-label="${task.completed ? 'Mark as incomplete' : 'Mark as complete'} ${task.title}">
                            <div class="task-checkbox ${task.completed ? 'completed' : ''}">${task.completed ? '<i class="fas fa-check"></i>' : ''}</div>
                        </button>
                        <div class="task-info">
                            <div class="task-title">${task.title}</div>
                        </div>
                        <div class="task-time">${task.time}</div>
                     `;
                     container.appendChild(taskEl);
                });
                const todayStr = new Date().toISOString().split('T')[0];
                if(upcomingTasks.some(t => t.category === 'work' && (t.dueDate === todayStr || t.dueDate === "Today") )) {
                     aiInsightContainer.innerHTML = `<i class="fas fa-brain"></i> AI: Looks like a productive day ahead, ${userName}! Focus on those work items.`;
                     aiInsightContainer.classList.remove('hidden');
                } else if (upcomingTasks.some(t => t.category === 'health')) {
                     aiInsightContainer.innerHTML = `<i class="fas fa-brain"></i> AI: Don't forget your wellness goals today, ${userName}!`;
                     aiInsightContainer.classList.remove('hidden');
                } else {
                     aiInsightContainer.classList.add('hidden');
                }
            }
            container.setAttribute('aria-busy', 'false');
            renderPinnedWidgets(); 
        }, 500); 
    }
    function cycleSafetyTicker() {
        currentSafetyTickerIndex = (currentSafetyTickerIndex + 1) % safetyTickerMessages.length;
        const tickerTextEl = document.getElementById('safetyTickerText');
        if(tickerTextEl) {
            tickerTextEl.style.opacity = 0;
            setTimeout(() => {
                tickerTextEl.textContent = safetyTickerMessages[currentSafetyTickerIndex];
                tickerTextEl.style.opacity = 1;
            }, 200);
        }
    }
    function renderPinnedWidgets() {
        const container = document.getElementById('pinnedWidgetsContainer');
        if (!container) return;
        container.innerHTML = Array(2).fill(getSkeletonPinnedWidget()).join('');
        container.setAttribute('aria-busy', 'true');
        setTimeout(() => {
            container.innerHTML = '';
            const widgets = [];
            const today = new Date().toISOString().split('T')[0];
            const nextTask = tasks.find(t => !t.completed && (t.dueDate === today || t.dueDate === "Today" || !t.dueDate));
            if (nextTask) {
                widgets.push({
                    icon: 'fas fa-clipboard-list', color: 'var(--primary-accent)', title: 'Next Task',
                    value: `${nextTask.title.substring(0, 25)}${nextTask.title.length > 25 ? '...' : ''}`,
                    action: () => setActiveScreen('planner')
                });
            } else {
                 widgets.push({
                    icon: 'fas fa-check-circle', color: 'var(--success-color)', title: 'Tasks',
                    value: 'All clear!', action: () => setActiveScreen('planner')
                });
            }
            const waterHabit = habits.find(h => h.isWaterTracker);
            if (waterHabit) {
                widgets.push({
                    icon: 'fas fa-tint', color: 'var(--soft-blue)', title: 'Water Intake',
                    value: `${waterHabit.current}/${waterHabit.goal} ${waterHabit.unit || 'glasses'}`,
                    action: () => setActiveScreen('wellness')
                });
            }
            const unreadChannels = mockChannels.filter(c => c.isJoined && c.unreadCount > 0);
            const totalUnread = unreadChannels.reduce((sum, c) => sum + c.unreadCount, 0);
            if (totalUnread > 0) {
                widgets.push({
                    icon: 'fas fa-comments', color: 'var(--moss-green)', title: 'Community',
                    value: `${totalUnread} unread in ${unreadChannels.length} channel${unreadChannels.length > 1 ? 's' : ''}`,
                    action: () => setActiveScreen('chat')
                });
            }
            const highStreakHabit = habits.find(h => h.streak > 5);
            if(highStreakHabit){
                 widgets.push({
                    icon: 'fas fa-fire', color: '#FF9800', title: `${highStreakHabit.name.substring(0,12)}...`,
                    value: `${highStreakHabit.streak} Day Streak!`, action: () => setActiveScreen('wellness')
                });
            }
            const savedPlace = mockPlaces.all.find(p => p.saved);
            if (savedPlace) {
                widgets.push({
                    icon: 'fas fa-store', color: 'var(--muted-terracotta)', title: `${savedPlace.name.substring(0,15)}...`,
                    value: `${savedPlace.openNow ? 'Open Now' : 'Closed'}`, action: () => showPlaceDetail(savedPlace)
                });
            }
            const shuffledWidgets = widgets.sort(() => 0.5 - Math.random()).slice(0, Math.min(widgets.length, 4));
            if (shuffledWidgets.length === 0) {
                container.innerHTML = `<p class="card-subtitle text-center" style="grid-column: 1 / -1;">No pinned info available. Configure in Settings.</p>`;
            } else {
                shuffledWidgets.forEach(widgetData => {
                    const widgetEl = document.createElement('div');
                    widgetEl.className = 'pinned-widget-item';
                    widgetEl.onclick = widgetData.action;
                    widgetEl.innerHTML = `
                        <i class="${widgetData.icon} widget-icon" style="color:${widgetData.color};"></i>
                        <span class="widget-title">${widgetData.title}</span>
                        <span class="widget-value">${widgetData.value}</span>
                    `;
                    container.appendChild(widgetEl);
                });
            }
            container.setAttribute('aria-busy', 'false');
        }, 300);
    }
    function updateProactiveSuggestions() {
        const container = document.getElementById('proactiveSuggestionsContainer');
        if (!container) return;
        container.innerHTML = '<p class="card-subtitle"><i class="fas fa-spinner fa-spin" style="color: var(--primary-accent);" aria-hidden="true"></i> AI is thinking of suggestions...</p>';
        setTimeout(() => { 
            container.innerHTML = ''; 
            const suggestions = [];
            const today = new Date().toISOString().split('T')[0];
            const overdueWorkTask = tasks.find(t => !t.completed && t.category === 'work' && (t.dueDate === today || t.dueDate === "Today") && (!t.time || new Date().getHours() > parseInt(t.time.split(':'))) );
            if(overdueWorkTask){
                suggestions.push({
                    id: 'overdueWork', priority: 10, icon: 'fa-triangle-exclamation', text: `High Priority: Your task "${overdueWorkTask.title.substring(0,25)}..." seems to be approaching or past its time!`,
                    buttonText: 'View in Planner', buttonIcon: 'fa-calendar-alt', action: () => setActiveScreen('planner')
                });
            }
            const weatherTextEl = document.getElementById('currentWeather');
            if (weatherTextEl) {
                const weatherText = weatherTextEl.textContent.toLowerCase();
                if (weatherText && weatherText.includes('sunny') && tasks.some(t => t.title.toLowerCase().includes('walk') && !t.completed)) {
                    suggestions.push({
                        id: 'sunnyWalk', priority: 5, icon: 'fa-sun', text: `It's sunny, ${userName}  ideal for that walk you planned!`,
                        buttonText: 'Find a Nature Spot', buttonIcon: 'fa-tree',
                        action: () => { setActiveScreen('explore'); setTimeout(() => { const parkFilterButton = document.querySelector('#exploreFilterBar button[data-filter=\'parks\']'); if (parkFilterButton) filterPlaces('parks', parkFilterButton);}, 50);}
                    });
                } else if (weatherText && weatherText.includes('rain') && tasks.some(t => t.title.toLowerCase().includes('outdoor') && !t.completed)) {
                     suggestions.push({
                        id: 'rainyOutdoor', priority: 8, icon: 'fa-cloud-rain', text: "Looks like rain. Maybe reschedule that outdoor activity or find an indoor alternative?",
                        buttonText: 'Indoor Activities', buttonIcon: 'fa-building',
                        action: () => { setActiveScreen('explore'); setTimeout(() => { document.getElementById('exploreSearchInput').value = "cinema"; handleExploreSearch(true);}, 50);}
                    });
                }
            }
            const recentStressedMood = loggedMoods.find(m => ['', ''].includes(m.mood) && (new Date() - new Date(m.timestamp) < 24 * 60 * 60 * 1000));
            const wellnessHabit = habits.find(h => h.name.toLowerCase().includes('meditation'));
            if (recentStressedMood && wellnessHabit && aiLearningPreferences.learnMoodLogs) {
                 suggestions.push({
                    id: 'stressedMoodSugg', priority: 7, icon: 'fa-spa', text: `AI noticed you logged a less positive mood recently. A short meditation session might help. Shall I open the Guided Breathing tool?`,
                    buttonText: 'Open Breathing Tool', buttonIcon: 'fa-spa', action: () => { setActiveScreen('wellness'); setTimeout(() => openGuidedExerciseModal(), 50); }
                });
            }
            const savedCafe = mockPlaces.all.find(p => p.saved && p.type === 'food' && (p.name.toLowerCase().includes('cafe') || p.tags.includes('coffee')));
            const coffeeDeal = mockDeals.find(d => d.category === 'food' && d.title.toLowerCase().includes('coffee'));
            if(savedCafe && coffeeDeal && aiLearningPreferences.learnSavedPlaces){
                 suggestions.push({
                    id: 'cafeDeal', priority: 4, icon: 'fa-tags', text: `Since you like ${savedCafe.name.substring(0,15)}..., check out this deal: "${coffeeDeal.title.substring(0,20)}..."!`,
                    buttonText: 'View Deal', buttonIcon: 'fa-compass', action: () => { setActiveScreen('explore'); setTimeout(() => showDealDetailModal(coffeeDeal), 50); }
                });
            }
            const longStreakHabit = habits.find(h => h.streak > 10 && h.current < h.goal);
            if (longStreakHabit && aiLearningPreferences.learnHabitTracking) {
                suggestions.push({
                    id: 'habitStreak', priority: 6, icon: 'fa-fire', text: `Keep up the great work on "${longStreakHabit.name.substring(0,20)}..."! You're on a ${longStreakHabit.streak}-day streak!`,
                    buttonText: 'View Wellness', buttonIcon: 'fa-heartbeat', action: () => setActiveScreen('wellness')
                });
            }
            if (suggestions.length === 0) {
                container.innerHTML = `<div class="empty-state" style="padding:10px 0;"><i class="fas fa-brain"></i><p>AI: No specific suggestions right now, ${userName}. Enjoy your day!</p></div>`;
                return;
            }
            suggestions.sort((a,b) => b.priority - a.priority);
            const firstSugg = suggestions[0]; 
            const suggEl = document.createElement('div');
            suggEl.className = 'mb-3';
            suggEl.innerHTML = `
                <p class="card-subtitle"><i class="fas ${firstSugg.icon}" style="color: var(--primary-accent);" aria-hidden="true"></i> ${firstSugg.text}</p>
                ${firstSugg.buttonText ? `<button class="button button-secondary suggestion-action" data-sugg-id="${firstSugg.id}"><i class="fas ${firstSugg.buttonIcon}" aria-hidden="true"></i> ${firstSugg.buttonText}</button>` : ''}
            `;
            container.appendChild(suggEl);
            if (firstSugg.buttonText) {
                 const btn = suggEl.querySelector('button');
                 if (btn) btn.onclick = firstSugg.action;
            }
            if (suggestions.length > 1) {
                const seeMoreButton = document.createElement('button');
                seeMoreButton.className = 'button button-secondary mt-2';
                seeMoreButton.style.fontSize = '0.8rem';
                seeMoreButton.innerHTML = `<i class="fas fa-layer-group"></i> AI: View ${suggestions.length - 1} More Suggestions`;
                seeMoreButton.onclick = () => {
                    let suggestionHtml = "<ul>";
                    suggestions.forEach(s => suggestionHtml += `<li><i class="fas ${s.icon}"></i> ${s.text}</li>`);
                    suggestionHtml += "</ul><p class='mt-2 card-subtitle'><em>These could be swipeable cards or shown in the AI chat.</em></p>";
                    openGenericModal("AI Proactive Suggestions", suggestionHtml);
                };
                container.appendChild(seeMoreButton);
            }
        }, 800);
    }
    function renderDealsOnDashboard() {
        const container = document.getElementById('dashboardDealsList');
        if (!container) return;
        container.innerHTML = getSkeletonPlaceCard(); 
        container.setAttribute('aria-busy', 'true');
        setTimeout(() => {
            container.innerHTML = '';
            let topDeals = [];
            const savedPlace = mockPlaces.all.find(p => p.saved);
            const wellnessHabit = habits.some(h => h.name.toLowerCase().includes('yoga') || h.name.toLowerCase().includes('gym'));
            if (savedPlace && aiLearningPreferences.learnSavedPlaces) {
                const relatedDeal = mockDeals.find(d => d.businessName.toLowerCase().includes(savedPlace.name.toLowerCase().split(" ")[0]) || d.category === savedPlace.type);
                if (relatedDeal) topDeals.push(relatedDeal);
            }
            if (wellnessHabit && aiLearningPreferences.learnHabitTracking) {
                const wellnessDeal = mockDeals.find(d => d.category === 'wellness');
                if (wellnessDeal) topDeals.push(wellnessDeal);
            }
            const otherDeals = mockDeals.filter(d => !topDeals.some(td => td.id === d.id));
            while (topDeals.length < 2 && otherDeals.length > 0) {
                topDeals.push(otherDeals.shift());
            }
            topDeals = [...new Set(topDeals)].slice(0, 2);
            if (topDeals.length === 0) {
                container.innerHTML = `<div class="empty-state" style="padding:10px 0;"><i class="fas fa-tags"></i><p>AI: No special deals match your profile today, ${userName}. Check Explore!</p></div>`;
            } else {
                topDeals.forEach(deal => {
                    const dealEl = document.createElement('article');
                    dealEl.className = 'card deal-card no-press'; 
                    dealEl.style.marginBottom = '10px'; 
                    dealEl.setAttribute('role', 'button');
                    dealEl.setAttribute('tabindex', '0');
                    dealEl.onclick = () => showDealDetailModal(deal);
                    dealEl.onkeypress = (event) => { if(event.key === 'Enter' || event.key === ' ') showDealDetailModal(deal); };
                    let expiryText = '';
                    if (deal.expiryDate) {
                        const expiry = new Date(deal.expiryDate);
                        const today = new Date();
                        today.setHours(0,0,0,0);
                        expiryText = expiry < today ? `<span class="expiry" style="color:var(--danger-color); font-weight:bold;">Expired</span>` : `<span class="expiry">Expires: ${expiry.toLocaleDateString()}</span>`;
                    }
                    dealEl.innerHTML = `
                        <img src="${deal.img}" alt="${deal.title}" loading="lazy">
                        <div class="deal-info">
                            <div class="name">${deal.title}</div>
                            <div class="details">${deal.description.substring(0, 50)}...</div>
                            <div class="business">${deal.businessName}</div>
                            ${expiryText}
                        </div>
                    `;
                    container.appendChild(dealEl);
                });
            }
            container.setAttribute('aria-busy', 'false');
        }, 700);
    }
    window.navigateToExploreDeals = function() {
        setActiveScreen('explore');
        setTimeout(() => {
            const dealFilterButton = document.querySelector('#exploreFilterBar button[data-filter="deals"]');
            if (dealFilterButton) {
                filterPlaces('deals', dealFilterButton);
            }
        }, 100);
    }
    const taskListEl = document.getElementById('taskList');
    const newTaskInputEl = document.getElementById('newTaskInput');
    const taskCategories = ["personal", "work", "errands", "learning", "health", "general"];
    const aiPlannerSuggestionEl = document.getElementById('aiPlannerSuggestion');
    function renderTasks(fromDashboardToggle = false) { 
        if (!taskListEl) { return; }
        taskListEl.innerHTML = Array(3).fill(getSkeletonTaskItem()).join('');
        taskListEl.setAttribute('aria-busy', 'true');
        setTimeout(() => {
            taskListEl.innerHTML = '';
            const today = new Date().toDateString();
            if (tasks.length === 0) {
                taskListEl.innerHTML = `<li class="empty-state"><i class="fas fa-calendar-check"></i><p>Your day is clear! Add a task to get started.</p></li>`;
            } else {
                tasks.sort((a,b) => { 
                    if (a.completed !== b.completed) return a.completed - b.completed;
                    const aDate = a.dueDate ? new Date(a.dueDate) : new Date(8640000000000000);
                    const bDate = b.dueDate ? new Date(b.dueDate) : new Date(8640000000000000);
                    if (aDate.getTime() !== bDate.getTime()) return aDate - bDate;
                    const categoryOrder = { "work": 1, "learning": 2, "health": 3, "errands": 4, "personal": 5, "general": 6 };
                    return (categoryOrder[a.category] || 99) - (categoryOrder[b.category] || 99);
                }).forEach(task => { 
                    const taskItem = document.createElement('li');
                    taskItem.className = `task-card task-category-${task.category || 'general'}`;
                    taskItem.dataset.taskId = task.id;
                    let aiMetaHtml = '';
                    if(task.aiParsedDetails && Object.keys(task.aiParsedDetails).length > 0){
                        aiMetaHtml = `<div class="task-meta-ai"><i class="fas fa-brain"></i> AI Parsed: ${Object.entries(task.aiParsedDetails).map(([key, value]) => `${key.charAt(0).toUpperCase() + key.slice(1)}: ${value}`).join('; ')}</div>`;
                    }
                    const dueDateString = task.dueDate ? `<span class="task-duedate"><i class="fas fa-calendar-day"></i>${new Date(task.dueDate).toLocaleDateString([], {month: 'short', day: 'numeric'})}</span>`: '';
                    const timeString = task.time ? `<span class="task-time"><i class="fas fa-clock"></i>${task.time}</span>` : '';
                    taskItem.innerHTML = `
                        <div class="task-category-color-bar"></div>
                        <button class="task-checkbox-button" onclick="toggleTaskStatus(${task.id})" aria-label="${task.completed ? 'Mark as incomplete' : 'Mark as complete'} ${task.title}">
                            <div class="task-checkbox ${task.completed ? 'completed' : ''}">
                                ${task.completed ? '<i class="fas fa-check"></i>' : ''}
                            </div>
                        </button>
                        <div class="task-info">
                            <div class="task-title ${task.completed ? 'completed' : ''}">${task.title}</div>
                            <div class="task-meta">${timeString} ${dueDateString}</div>
                            ${aiMetaHtml}
                        </div>
                        <div class="task-actions">
                            <button class="task-action-button edit" onclick="openEditTaskModal(${task.id})" aria-label="Edit task: ${task.title}"><i class="fas fa-pencil-alt"></i></button>
                            <button class="task-action-button delete" onclick="deleteTask(${task.id})" aria-label="Delete task: ${task.title}"><i class="fas fa-trash-alt"></i></button>
                        </div>
                    `;
                    taskListEl.appendChild(taskItem);
                });
            }
            taskListEl.setAttribute('aria-busy', 'false');
            renderDashboardTasks(); 
            updateProactiveSuggestions();
            renderPinnedWidgets();
            saveTasksToLocalStorage();
        }, 500);
    }
    function decomposeTask(taskId) {
        const taskIndex = tasks.findIndex(t => t.id === taskId);
        if (taskIndex === -1) return;
        const originalTask = tasks[taskIndex];
        tasks.splice(taskIndex, 1);
        const subTasks = [
            { title: `Set budget for ${originalTask.title}`, category: "personal", time: "ASAP" },
            { title: `Create guest list for ${originalTask.title}`, category: "personal", time: "Soon" },
            { title: `Research and book venue for party`, category: "errands", time: "This week" },
            { title: `Send out invitations for ${originalTask.title}`, category: "personal", time: "Next week" },
        ];
        subTasks.forEach(st => {
            tasks.push({ id: nextTaskId++, title: st.title, time: st.time, category: st.category, completed: false, notes: `Sub-task of '${originalTask.title}'`, dueDate: new Date().toISOString().split('T')[0], recurrence: "none", aiParsedDetails: { project: originalTask.title } });
        });
        renderTasks();
        showToast("AI has broken down the task for you!", "success");
        addXP(15, 'planner');
    }
    function addNewTask(titleFromAI = null, categoryFromAI = null, timeFromAI = null, dateFromAI = null, parsedDetailsFromAI = null) { 
        if (!newTaskInputEl && !titleFromAI) { return false; }
        const taskTitle = titleFromAI || newTaskInputEl.value.trim();
        if (!taskTitle) {
            showToast("Please enter a task title.", "error", 2000);
            if (newTaskInputEl) newTaskInputEl.focus();
            return false;
        }
        const isComplex = taskTitle.toLowerCase().startsWith('plan ') || taskTitle.toLowerCase().startsWith('organize ');
        if(isComplex && !titleFromAI){
            const tempId = Date.now();
            tasks.push({ id: tempId, title: taskTitle, time: "Project", category: "personal", completed: false, notes: "", dueDate: new Date().toISOString().split('T')[0], recurrence: "none" });
            renderTasks();
            if (aiPlannerSuggestionEl) {
                aiPlannerSuggestionEl.innerHTML = `<i class="fas fa-brain"></i> This looks like a multi-step project. Can I break it down for you? <button class="button-secondary" style="padding:2px 5px; font-size:0.7rem; margin-left:5px;" onclick="decomposeTask(${tempId})">Yes, Please!</button>`;
                aiPlannerSuggestionEl.classList.remove('hidden');
            }
            if (newTaskInputEl) {
                newTaskInputEl.value = '';
                document.getElementById('clearNewTaskInput')?.classList.add('hidden');
            }
            return;
        }
        let category = categoryFromAI || "personal"; 
        let time = timeFromAI || "Anytime";
        let dueDate = dateFromAI || new Date().toISOString().split('T')[0];
        let aiParsedDetails = parsedDetailsFromAI || {};
        if(!titleFromAI) {
            const lowerTitle = taskTitle.toLowerCase();
            if (lowerTitle.includes("meeting") || lowerTitle.includes("report") || lowerTitle.includes("call client") || lowerTitle.includes("work on") || lowerTitle.includes("submit proposal")) category = "work";
            else if (lowerTitle.includes("buy ") || lowerTitle.includes("pick up") || lowerTitle.includes("groceries") || lowerTitle.includes("errand for")) category = "errands";
            else if (lowerTitle.includes("learn ") || lowerTitle.includes("study for") || lowerTitle.includes("read book")) category = "learning";
            else if (lowerTitle.includes("gym") || lowerTitle.includes("workout") || lowerTitle.includes("doctor appt") || lowerTitle.includes("meditation") || lowerTitle.includes("jog")) category = "health";
            const timeMatch = taskTitle.match(/at\s+(\d{1,2}(:\d{2})?\s*(am|pm)?)/i);
            if (timeMatch && timeMatch[0]) {
                time = timeMatch[0].trim().toUpperCase();
                aiParsedDetails.time = time;
            }
            const dateMatch = taskTitle.match(/on\s+(monday|tuesday|wednesday|thursday|friday|saturday|sunday|today|tomorrow)/i);
            if(dateMatch && dateMatch[1]) {
                const day = dateMatch[1].toLowerCase();
                let dateObj = new Date();
                if(day === 'tomorrow') dateObj.setDate(dateObj.getDate() + 1);
                else if (day !== 'today') {
                    const weekdays = ['sunday', 'monday', 'tuesday', 'wednesday', 'thursday', 'friday', 'saturday'];
                    let dayIndex = weekdays.indexOf(day);
                    while(dateObj.getDay() !== dayIndex) {
                        dateObj.setDate(dateObj.getDate() + 1);
                    }
                }
                dueDate = dateObj.toISOString().split('T')[0];
                aiParsedDetails.date = dueDate;
            } else {
                 const explicitDateMatch = taskTitle.match(/(\d{1,2}[\/-]\d{1,2}(?:[\/-]\d{2,4})?)/);
                 if(explicitDateMatch && explicitDateMatch[0]) {
                     dueDate = new Date(explicitDateMatch[0]).toISOString().split('T')[0];
                     aiParsedDetails.date = dueDate;
                 }
            }
            const locationMatch = taskTitle.match(/(?:at|in|from)\s+([A-Z][a-zA-Z\s]+(?:Cafe|Park|Store|Cleaners|Market|Library|Office|Hub|Center|Plaza|Square))/);
            if (locationMatch && locationMatch[1]) {
                aiParsedDetails.location = locationMatch[1].trim();
            }
            const personMatch = taskTitle.match(/(?:with|for|call|meet)\s+([A-Z][a-z]+(?:\s+[A-Z][a-z]+)?)/);
            if (personMatch && personMatch[1] && !taskCategories.includes(personMatch[1].toLowerCase()) && personMatch[1].toLowerCase() !== "mom" && personMatch[1].toLowerCase() !== "dad") {
                aiParsedDetails.person = personMatch[1].trim();
            }
            if (aiPlannerSuggestionEl) {
                if(Object.keys(aiParsedDetails).length > 0){
                    aiPlannerSuggestionEl.innerHTML = `<i class="fas fa-brain"></i> AI parsed: ${Object.entries(aiParsedDetails).map(([key, value]) => `${key.charAt(0).toUpperCase() + key.slice(1)}: ${value}`).join('; ')}. <button class="button-secondary" style="padding:2px 5px; font-size:0.7rem;" onclick="this.parentElement.classList.add('hidden')">Dismiss</button>`;
                    aiPlannerSuggestionEl.classList.remove('hidden');
                } else {
                    aiPlannerSuggestionEl.classList.add('hidden');
                }
            }
        } else {
             if (timeFromAI) aiParsedDetails.time = timeFromAI;
             if (dateFromAI) aiParsedDetails.date = dateFromAI;
        }
        const conflictingTask = tasks.find(t => t.dueDate === dueDate && t.time === time && !t.completed);
        if (conflictingTask) {
            openConfirmationModal(
                "AI: Schedule Conflict Detected",
                `<p>You already have a task: "<strong>${conflictingTask.title}</strong>" scheduled at ${time} on this day.</p><p>How would you like to resolve this?</p>`,
                () => {
                    const newTime = prompt("Enter a new time for the original task (e.g., '11:00 AM')", "11:00 AM");
                    if (newTime) {
                        conflictingTask.time = newTime;
                        tasks.push({ id: nextTaskId++, title: taskTitle, time: time, category: category, completed: false, notes: "", dueDate: dueDate, recurrence: "none", aiParsedDetails: Object.keys(aiParsedDetails).length > 0 ? aiParsedDetails : null });
                        renderTasks();
                        showToast("AI has rescheduled the original task and added the new one.", "success");
                    }
                }
            );
            const confirmBtn = document.getElementById('confirmActionButton');
            if(confirmBtn) confirmBtn.textContent = 'Reschedule Original Task';
            return;
        }
        const newTask = { id: nextTaskId++, title: taskTitle, time: time, category: category, completed: false, notes: "", dueDate: dueDate, recurrence: "none", aiParsedDetails: Object.keys(aiParsedDetails).length > 0 ? aiParsedDetails : null };
        tasks.push(newTask);
        renderTasks();
        addXP(5, 'planner');
        if (!titleFromAI && newTaskInputEl) {
            newTaskInputEl.value = '';
            document.getElementById('clearNewTaskInput')?.classList.add('hidden');
        }
        showToast("Task added!", "success", 1500);
        triggerFabSuggestion();
        scheduleTaskNotification(tasks[tasks.length - 1]);
        native.addToCalendar(newTask);
        return true; 
    }
    window.toggleTaskStatus = function(taskId, fromDashboard = false) { 
        const task = tasks.find(t => t.id === taskId);
        if (task) {
            const wasIncomplete = !task.completed;
            task.completed = !task.completed;
            if (navigator.vibrate) navigator.vibrate(10); 
            if(wasIncomplete && task.completed) {
                addXP(10, 'planner');
                showDynamicIslandAlert('fas fa-check', `Task Complete! +10 XP`);
            }
            if (fromDashboard && document.getElementById('dashboard').classList.contains('active')) {
                renderDashboardTasks(); 
            } else if (!fromDashboard && document.getElementById('planner').classList.contains('active')) {
                renderTasks();
            }
            showToast(task.completed ? `Task "${task.title.substring(0,15)}..." completed!` : `Task "${task.title.substring(0,15)}..." marked incomplete.`, "info", 1800);
            checkForWellnessPatterns();
        } else {
            showToast("Error: Task not found.", "error", 2000, true);
        }
    }
    window.deleteTask = function(taskId) { 
        const taskIndex = tasks.findIndex(t => t.id === taskId);
        if (taskIndex > -1) {
            const deletedTaskTitle = tasks[taskIndex].title;
            tasks.splice(taskIndex, 1);
            renderTasks();
            showToast(`Task "${deletedTaskTitle.substring(0,20)}..." deleted.`, "info", 1500);
        } else {
            showToast("Error: Task not found for deletion.", "error", 2000, true);
        }
    }
    function openEditTaskModal(taskId) {
        const task = tasks.find(t => t.id === taskId);
        if (!task) { showToast("Error: Task not found.", "error", 2000, true); return; }
        document.getElementById('editingTaskId').value = task.id;
        document.getElementById('editTaskTitleInput').value = task.title;
        document.getElementById('editTaskTimeInput').value = task.time;
        let dateValue = task.dueDate;
        if (dateValue === "Today") dateValue = new Date().toISOString().split('T')[0];
        else if (dateValue === "Tomorrow") {
            let tomorrow = new Date(); tomorrow.setDate(tomorrow.getDate() + 1);
            dateValue = tomorrow.toISOString().split('T')[0];
        }
        document.getElementById('editTaskDueDateInput').value = dateValue || '';
        document.getElementById('editTaskRecurrenceSelect').value = task.recurrence || 'none';
        document.getElementById('editTaskNotesInput').value = task.notes || '';
        const categorySelect = document.getElementById('editTaskCategorySelect');
        categorySelect.innerHTML = ''; 
        taskCategories.forEach(cat => {
            const option = document.createElement('option');
            option.value = cat;
            option.textContent = cat.charAt(0).toUpperCase() + cat.slice(1);
            categorySelect.appendChild(option);
        });
        categorySelect.value = task.category || 'general';
        openModal('editTaskModal');
    }
    function saveEditedTask() {
        const taskId = parseInt(document.getElementById('editingTaskId').value);
        const task = tasks.find(t => t.id === taskId);
        if (!task) { showToast("Error: Could not save, task not found.", "error", 2000, true); return; }
        const newTitle = document.getElementById('editTaskTitleInput').value.trim();
        if (!newTitle) { showToast("Task title cannot be empty.", "error", 2000, true); return; }
        task.title = newTitle;
        task.time = document.getElementById('editTaskTimeInput').value.trim();
        task.category = document.getElementById('editTaskCategorySelect').value;
        task.dueDate = document.getElementById('editTaskDueDateInput').value.trim();
        task.recurrence = document.getElementById('editTaskRecurrenceSelect').value;
        task.notes = document.getElementById('editTaskNotesInput').value.trim();
        if (task.title !== newTitle && !task.aiParsedDetails) {
            const lowerTitle = newTitle.toLowerCase();
            task.aiParsedDetails = {};
            const timeMatch = newTitle.match(/at\s+(\d{1,2}(:\d{2})?\s*(am|pm)?)/i);
            if (timeMatch && timeMatch[0]) task.aiParsedDetails.time = timeMatch[0].trim().toUpperCase();
             const dateMatch = newTitle.match(/on\s+(monday|tuesday|wednesday|thursday|friday|saturday|sunday|today|tomorrow|\d{1,2}[\/-]\d{1,2}(?:[\/-]\d{2,4})?)/i);
            if(dateMatch && dateMatch[0]) task.aiParsedDetails.date = dateMatch[0].trim();
        }
        renderTasks();
        closeModal('editTaskModal');
        showToast("Task updated successfully!", "success", 1500);
        scheduleTaskNotification(task);
        native.addToCalendar(task);
    }
    function optimizeMyDay() { 
        tasks.sort((a, b) => {
            if (a.completed !== b.completed) return a.completed - b.completed;
            const aDate = a.dueDate ? new Date(a.dueDate) : new Date(8640000000000000);
            const bDate = b.dueDate ? new Date(b.dueDate) : new Date(8640000000000000);
            if (aDate.getTime() !== bDate.getTime()) return aDate - bDate;
            const categoryOrder = { "work": 1, "learning": 2, "health": 3, "errands": 4, "personal": 5, "general": 6 };
            return (categoryOrder[a.category] || 99) - (categoryOrder[b.category] || 99);
        });
        renderTasks();
        openGenericModal("AI Day Optimization", `<p>${userName}, I've reordered your tasks based on priority (due dates, work tasks first, etc.).</p><p>A more advanced AI could consider task dependencies, estimated durations, and your energy levels.</p>`);
    }
    function getAIDayBrief() {
        let brief = ""; 
        const incompleteTasks = tasks.filter(t => !t.completed);
        if (incompleteTasks.length > 0) {
            brief += `You have ${incompleteTasks.length} task${incompleteTasks.length > 1 ? 's' : ''} remaining, ${userName}. `;
            const keyTasks = incompleteTasks.filter(t => t.category === 'work' || t.dueDate === new Date().toISOString().split('T')[0]).slice(0,2);
            if (keyTasks.length > 0) {
                 brief += `Key tasks include: ${keyTasks.map(t => `${t.title.substring(0,25)}...`).join(', ')}.`;
            } else {
                 brief += `Top tasks: ${incompleteTasks.slice(0,2).map(t => `${t.title.substring(0,25)}...`).join(', ')}.`;
            }
            if (incompleteTasks.length > 3 && aiLearningPreferences.learnTaskPatterns) {
                 brief += ` It looks like a busy day! Try to focus on one task at a time or use Focus Mode.`;
            }
        } else {
            brief += `All tasks completed! Great job, ${userName}!  How about planning something fun for tomorrow or exploring local deals?`;
        }
        const weatherTextEl = document.getElementById('currentWeather');
        const weatherText = weatherTextEl ? weatherTextEl.textContent : "not available";
        brief += ` Current weather is ${weatherText}.`;
         const currentSafetyMsg = document.getElementById('safetyTickerText')?.textContent;
         if (currentSafetyMsg && (currentSafetyMsg.toLowerCase().includes("outage") || currentSafetyMsg.toLowerCase().includes("closure") || currentSafetyMsg.toLowerCase().includes("alert"))) {
            brief += ` Important Alert: ${currentSafetyMsg}`;
        }
        speakText(brief);
        showToast("Playing AI Day Brief...", "ai_info");
    }
    function aiScheduleMyDay() {
        const today = new Date().toISOString().split('T')[0];
        const incompleteTasksToday = tasks.filter(t => !t.completed && (t.dueDate === today || t.dueDate === "Today" || !t.dueDate));
        if (incompleteTasksToday.length === 0) {
            showToast("No tasks for today to schedule!", "info");
            return;
        }
        let scheduleHtml = `<p>Here's a potential schedule for today, ${userName}:</p><ul>`;
        let currentTime = 9;
        incompleteTasksToday.forEach(task => {
            let taskDuration = 1;
            if (task.category === 'work') taskDuration = 1.5;
            if (task.title.toLowerCase().includes('report')) taskDuration = 2;
            if (task.title.toLowerCase().includes('meeting')) taskDuration = 1;
            const timeMatch = task.time.match(/(\d{1,2})(:(\d{2}))?\s*(am|pm)?/i);
            let startHour = currentTime;
            if (timeMatch && timeMatch[1]) {
                let parsedHour = parseInt(timeMatch[1]);
                if (timeMatch[4] && timeMatch[4].toLowerCase() === 'pm' && parsedHour < 12) parsedHour += 12;
                if (timeMatch[4] && timeMatch[4].toLowerCase() === 'am' && parsedHour === 12) parsedHour = 0;
                if (parsedHour >= currentTime) startHour = parsedHour;
            }
            const endHour = startHour + taskDuration;
            scheduleHtml += `<li><strong>${startHour % 12 || 12}:00 ${startHour < 12 || startHour === 24 ? 'AM' : 'PM'} - ${endHour % 12 || 12}:00 ${endHour < 12 || endHour === 24 ? 'AM' : 'PM'}:</strong> ${task.title}</li>`;
            currentTime = Math.ceil(endHour);
        });
        scheduleHtml += "</ul><p class='mt-2 card-subtitle'>This is a time-blocking suggestion. I can update your task times if you approve.</p>";
        const modalBody = `${scheduleHtml}<button class='button mt-3' style='width:100%' onclick="applyAISchedule('${JSON.stringify(incompleteTasksToday.map(t => t.id))}')">Looks Good, Apply to Tasks</button>`;
        openGenericModal("AI Proposed Schedule", modalBody);
    }
    window.applyAISchedule = function(taskIdsJson) {
        const taskIdsToUpdate = JSON.parse(taskIdsJson);
        let currentTime = 9;
        taskIdsToUpdate.forEach(id => {
            const task = tasks.find(t => t.id === id);
            if (task) {
                let taskDuration = 1;
                if (task.category === 'work') taskDuration = 1.5;
                const startHour = currentTime;
                const endHour = startHour + taskDuration;
                task.time = `${startHour % 12 || 12}:00 ${startHour < 12 ? 'AM' : 'PM'} - ${endHour % 12 || 12}:00 ${endHour < 12 ? 'AM' : 'PM'}`;
                currentTime = Math.ceil(endHour);
            }
        });
        renderTasks();
        closeModal('genericModal');
        showToast('AI schedule applied to your tasks!', 'success');
        saveTasksToLocalStorage();
    }
    const placesListEl = document.getElementById('placesList');
    function renderPlaces(filter = 'all') { 
        if (!placesListEl) { return; }
        placesListEl.innerHTML = Array(4).fill(getSkeletonPlaceCard()).join(''); 
        placesListEl.setAttribute('aria-busy', 'true');
        placesListEl.className = 'grid-view';
        setTimeout(() => {
            placesListEl.innerHTML = '';
            placesListEl.className = 'grid-view';
            let itemsToRender = [];
            let itemType = 'place'; 
            const searchTerm = document.getElementById('exploreSearchInput')?.value.toLowerCase() || '';
            if (filter === 'bulletin') {
                itemType = 'bulletin';
                itemsToRender = [...bulletinPosts];
                if (searchTerm) {
                    itemsToRender = itemsToRender.filter(post =>
                        post.title.toLowerCase().includes(searchTerm) ||
                        post.content.toLowerCase().includes(searchTerm)
                    );
                }
            } else if (filter === 'deals') {
                itemsToRender = [...mockDeals];
                itemType = 'deal';
                if (searchTerm) {
                    itemsToRender = itemsToRender.filter(deal =>
                        deal.title.toLowerCase().includes(searchTerm) ||
                        deal.businessName.toLowerCase().includes(searchTerm) ||
                        deal.description.toLowerCase().includes(searchTerm) ||
                        deal.category.toLowerCase().includes(searchTerm)
                    );
                }
            } else { 
                itemType = 'place';
                let sourceArray;
                if (filter === 'saved') {
                    sourceArray = mockPlaces.all.filter(p => p.saved);
                }
                else if (filter === 'ai_recommended') { 
                    sourceArray = [...mockPlaces.ai_recommended]; 
                    if (aiLearningPreferences.learnSavedPlaces && mockPlaces.all.some(p=>p.saved)) {
                        const savedPlaceType = mockPlaces.all.find(p=>p.saved)?.type;
                        if(savedPlaceType) sourceArray = sourceArray.filter(p => p.type === savedPlaceType || p.rating > 4.6);
                    }
                    if (loggedMoods.some(m => m.mood === '' || m.mood === '') && aiLearningPreferences.learnMoodLogs) {
                        sourceArray.push(...mockPlaces.events.filter(e => !sourceArray.find(s => s.id === e.id && s.type === e.type)));
                        sourceArray.push(...mockPlaces.all.filter(p => p.tags.includes("fun") && !sourceArray.find(s => s.id === p.id && s.type === p.type)));
                    }
                } else if (filter === 'all') {
                    sourceArray = [...mockPlaces.all]; 
                } else if (mockPlaces[filter] && Array.isArray(mockPlaces[filter])) {
                    sourceArray = [...mockPlaces[filter]];
                } else { 
                    sourceArray = [...mockPlaces.all]; 
                }
                itemsToRender = [...sourceArray];
                if (searchTerm) {
                    itemsToRender = itemsToRender.filter(place =>
                        place.name.toLowerCase().includes(searchTerm) ||
                        place.details.toLowerCase().includes(searchTerm) ||
                        (place.sub && place.sub.toLowerCase().includes(searchTerm)) ||
                        (place.tags && place.tags.some(tag => tag.toLowerCase().includes(searchTerm)))
                    );
                }
            }
            if (itemsToRender.length === 0) {
                placesListEl.classList.remove('grid-view');
                let emptyMessage = `No ${filter === 'deals' ? 'deals' : (filter === 'bulletin' ? 'posts' : 'places')} found`;
                if(filter === 'ai_recommended') emptyMessage = `AI couldn't find specific recommendations for "${searchTerm || 'your profile'}" right now, ${userName}.`;
                if (filter === 'saved') emptyMessage = 'You haven\'t saved any places yet. Tap the bookmark icon on a place to save it!';
                placesListEl.innerHTML = `<div class="empty-state"><i class="fas fa-map-signs"></i><p>${emptyMessage}</p><p class="card-subtitle mt-1" style="font-size:0.8rem;">Try a broader search or different filters.</p></div>`;
            } else {
                itemsToRender.sort((a,b) => (b.timestamp || 0) - (a.timestamp || 0)).forEach(item => {
                    const article = document.createElement('article');
                    article.className = 'card'; 
                    article.setAttribute('role', 'button');
                    article.setAttribute('tabindex', '0');
                    if (itemType === 'bulletin') {
                        article.classList.add('bulletin-post-card');
                        const author = mockUsers[item.authorId] || mockUsers.defaultBot;
                        article.innerHTML = `
                            <div class="bulletin-post-header">
                                <img src="${author.avatarUrl}" alt="${author.name}" class="bulletin-post-avatar" loading="lazy">
                                <div class="bulletin-post-meta">
                                    <div class="name">${author.name}</div>
                                    <div class="timestamp">${new Date(item.timestamp).toLocaleString()}</div>
                                </div>
                            </div>
                            <h4 class="card-title" style="margin-bottom: var(--space-xs);">${item.title}</h4>
                            <div class="bulletin-post-body">${item.content}</div>
                            <div class="bulletin-post-actions">
                                <button onclick="addXP(2, 'community')"><i class="far fa-thumbs-up"></i> Helpful</button>
                                <button onclick="openBulletinCommentsModal(${item.id})"><i class="far fa-comment-dots"></i> Comment</button>
                                <button onclick="shareContent('bulletin', {title: '${item.title}', content: '${item.content}'})"><i class="fas fa-share-alt"></i> Share</button>
                            </div>
                        `;
                    } else if (itemType === 'deal') {
                        article.classList.add('deal-card');
                        article.onclick = () => showDealDetailModal(item);
                        article.onkeypress = (event) => { if(event.key === 'Enter' || event.key === ' ') showDealDetailModal(item); };
                        let expiryText = '';
                        if (item.expiryDate) {
                            const expiry = new Date(item.expiryDate);
                            const today = new Date();
                            today.setHours(0,0,0,0);
                            expiryText = expiry < today ? `<span class="expiry" style="color:var(--danger-color); font-weight:bold;">Expired</span>` : `<span class="expiry">Expires: ${expiry.toLocaleDateString()}</span>`;
                        }
                        article.innerHTML = `
                            <img src="${item.img}" alt="${item.title}" loading="lazy">
                            <div class="deal-info">
                                <div class="name">${item.title}</div>
                                <div class="details">${item.description.substring(0, 70)}...</div>
                                <div class="business">${item.businessName}</div>
                                ${expiryText}
                            </div>
                        `;
                    } else {
                        article.classList.add('place-card');
                        article.onclick = () => showPlaceDetail(item);
                        article.onkeypress = (event) => { if(event.key === 'Enter' || event.key === ' ') showPlaceDetail(item); };
                        let tagsHtml = "";
                        if(item.tags && item.tags.length > 0) {
                            tagsHtml = `<div class="tags">${item.tags.slice(0,3).map(tag => `<span class="tag">#${tag}</span>`).join('')}</div>`;
                        }
                        article.innerHTML = `
                            <img src="${item.img}" alt="${item.name}" loading="lazy">
                            <div class="place-info">
                                <div class="name">${item.name}</div>
                                <div class="details">${item.details}</div>
                                <div class="details">${item.sub || ''}</div>
                                ${tagsHtml}
                            </div>
                            <button class="save-place-button ${item.saved ? 'saved' : ''}" onclick="event.stopPropagation(); toggleSavePlace(${item.id}, this)" aria-label="${item.saved ? 'Unsave' : 'Save'} ${item.name}" aria-pressed="${item.saved ? 'true' : 'false'}">
                                <i class="fas fa-bookmark"></i>
                            </button>
                        `;
                    }
                    placesListEl.appendChild(article);
                });
            }
            placesListEl.setAttribute('aria-busy', 'false');
            updateMapMarkers(itemsToRender.filter(item => item.position));
        }, 600);
    }
    window.filterPlaces = function(filterType, buttonEl) { 
        document.querySelectorAll('#exploreFilterBar .filter-button').forEach(btn => {
            btn.classList.remove('active');
            btn.setAttribute('aria-selected', 'false');
        });
        if (buttonEl) {
            buttonEl.classList.add('active');
            buttonEl.setAttribute('aria-selected', 'true');
        } else { 
            const targetBtn = document.querySelector(`#exploreFilterBar .filter-button[data-filter="${filterType}"]`);
            if (targetBtn) {
                targetBtn.classList.add('active');
                targetBtn.setAttribute('aria-selected', 'true');
            }
        }
        renderPlaces(filterType);
        showAIExploreSuggestion(); 
    }
    function handleExploreSearch(instant = false) {
        clearTimeout(exploreSearchDebounceTimeout);
        exploreSearchDebounceTimeout = setTimeout(() => {
            const activeFilterButton = document.querySelector('#exploreFilterBar .filter-button.active');
            const currentFilter = activeFilterButton ? activeFilterButton.dataset.filter : 'all';
            renderPlaces(currentFilter);
            showAIExploreSuggestion();
            if(!instant) showToast('AI refined search results.', "ai_info", 1500);
        }, instant ? 0 : 400); 
    }
    function showPlaceDetail(place) { 
        if (!place) { showToast("Error: Place details not available.", "error", 2000, true); return; }
        document.getElementById('modalPlaceName').textContent = place.name;
        document.getElementById('modalPlaceImage').src = place.img;
        document.getElementById('modalPlaceImage').alt = place.name;
        document.getElementById('modalPlaceDetails').innerHTML = `<p>${place.details}</p><p>${place.sub}</p>`;
        const tagsContainer = document.getElementById('modalPlaceTags');
        if (tagsContainer) {
            if (place.tags && place.tags.length > 0) {
                tagsContainer.innerHTML = place.tags.map(tag => `<span class="tag">#${tag}</span>`).join('');
                tagsContainer.classList.remove('hidden');
            } else {
                tagsContainer.innerHTML = '';
                tagsContainer.classList.add('hidden');
            }
        }
        const aiSummaryEl = document.getElementById('aiPlaceReviewSummary');
        if(place.aiSummary && aiSummaryEl){
            let enhancedSummary = place.aiSummary;
            if (place.rating > 4.5 && aiLearningPreferences.learnSavedPlaces) enhancedSummary += " Many consider this a top-tier local spot.";
            else if (place.rating < 3.5 && aiLearningPreferences.learnSavedPlaces) enhancedSummary += " Reviews suggest some mixed experiences here.";
            aiSummaryEl.innerHTML = `<i class="fas fa-brain"></i> <strong>AI Summary:</strong> ${enhancedSummary}`;
            aiSummaryEl.classList.remove('hidden');
        } else if (aiSummaryEl) {
            aiSummaryEl.classList.add('hidden');
        }
        const ratingStarsContainer = document.getElementById('placeRatingStars');
        ratingStarsContainer.dataset.placeId = place.id; 
        ratingStarsContainer.querySelectorAll('.fa-star').forEach(star => {
            star.classList.remove('selected');
            if (star.dataset.value <= (place.userRating || 0)) { 
                star.classList.add('selected');
            }
        });
        document.getElementById('placeReviewInput').value = place.userReview || "";
        openModal('placeDetailModal');
    }
    window.toggleSavePlace = function(placeId, buttonEl) {
        const mainPlace = mockPlaces.all.find(p => p.id === placeId);
        if (mainPlace) {
            mainPlace.saved = !mainPlace.saved;
            if(mainPlace.saved) {
                mockPlaces.saved.push(mainPlace);
                addXP(5, 'explore');
            } else {
                mockPlaces.saved = mockPlaces.saved.filter(p => p.id !== placeId);
            }
            if (mockPlaces[mainPlace.type]) {
                const catPlace = mockPlaces[mainPlace.type].find(p => p.id === placeId);
                if (catPlace) catPlace.saved = mainPlace.saved;
            }
            if(mockPlaces.open_now){ 
                const openPlace = mockPlaces.open_now.find(p => p.id === placeId);
                if(openPlace) openPlace.saved = mainPlace.saved;
            }
            if(mockPlaces.ai_recommended){ 
                const aiRecPlace = mockPlaces.ai_recommended.find(p => p.id === placeId);
                if(aiRecPlace) aiRecPlace.saved = mainPlace.saved;
            }
            buttonEl.classList.toggle('saved', mainPlace.saved);
            buttonEl.setAttribute('aria-pressed', mainPlace.saved.toString());
            buttonEl.setAttribute('aria-label', `${mainPlace.saved ? 'Unsave' : 'Save'} ${mainPlace.name}`);
            showToast(mainPlace.saved ? `AI: ${mainPlace.name.substring(0,20)}... saved! I'll consider this for future suggestions, ${userName}.` : `${mainPlace.name.substring(0,20)}... unsaved.`, "ai_info", 2000);
            showAIExploreSuggestion(); 
            renderPinnedWidgets();
            savePlacesToLocalStorage();
        } else {
            showToast("Error: Could not save place.", "error", 2000, true);
        }
    }
    document.getElementById('exploreSearchInput')?.addEventListener('input', () => {
        handleExploreSearch();
        document.getElementById('clearExploreSearchInput')?.classList.toggle('hidden', document.getElementById('exploreSearchInput').value === '');
    });
    window.ratePlace = function(starElement) {
        const rating = starElement.dataset.value;
        const stars = starElement.parentElement.querySelectorAll('.fa-star');
        stars.forEach(s => {
            s.classList.toggle('selected', s.dataset.value <= rating);
        });
    }
    window.submitPlaceReview = function() {
        const placeId = document.getElementById('placeRatingStars').dataset.placeId;
        const reviewText = document.getElementById('placeReviewInput').value;
        const selectedRating = document.querySelectorAll('#placeRatingStars .fa-star.selected').length;
        const place = mockPlaces.all.find(p => p.id == placeId);
        if(place){
            place.userRating = selectedRating; 
            place.userReview = reviewText;
            if(reviewText.length > 10) place.aiSummary = `Recent review highlights: "${reviewText.substring(0,30)}..." (Rating: ${selectedRating}/5).`;
        }
        addXP(15, 'community');
        savePlacesToLocalStorage();
        showToast(`Review for ${place ? place.name.substring(0,15) + "..." : "place"} submitted (AI processing). Rating: ${selectedRating} stars.`, "success", 2500);
    }
    function showAIExploreSuggestion() {
        const suggestionCard = document.getElementById('aiExploreSuggestion');
        const suggestionText = document.getElementById('aiExploreSuggestionText');
        const suggestionActionButton = document.getElementById('aiExploreSuggestionAction');
        if (!suggestionCard || !suggestionText || !suggestionActionButton || !aiLearningPreferences.aiSuggestions) {
            if(suggestionCard) suggestionCard.classList.add('hidden');
            return;
        }
        const activeFilter = document.querySelector('#exploreFilterBar .filter-button.active')?.dataset.filter || 'all';
        let suggestion = null;
        const weatherText = document.getElementById('currentWeather')?.textContent.toLowerCase();
        const isRaining = weatherText && weatherText.includes('rain');
        if (isRaining && new Date().getHours() > 13) {
            const cinema = mockPlaces.all.find(p => p.tags.includes("cinema"));
            const cafe = mockPlaces.all.find(p => p.tags.includes("cafe") && p.id !== cinema?.id);
            if (cinema && cafe) {
                suggestion = {
                    title: "A Perfect Rainy Afternoon",
                    text: `1. Catch a movie at '${cinema.name}'. 2. Then, warm up with a specialty coffee nearby at '${cafe.name}'.`,
                    buttonText: "View Itinerary",
                    action: () => openGenericModal("AI Itinerary: Rainy Afternoon", `<p>Here is your suggested plan:</p><ul><li><strong>Step 1:</strong> Visit <strong>${cinema.name}</strong>.</li><li><strong>Step 2:</strong> Warm up at <strong>${cafe.name}</strong>.</li></ul><p class="mt-2 card-subtitle">I've checked and both are open now. I can add these to your planner if you'd like.</p>`)
                };
            }
        } else if (new Date().getDay() >= 5 && new Date().getHours() > 15) {
             suggestion = {
                title: "AI Weekend Plan",
                text: "It's the weekend! How about dinner at 'Malandela's' followed by live music at 'House on Fire'?",
                buttonText: "Sounds Fun!",
                action: () => {
                    const dinnerTask = "Dinner at Malandela's";
                    const musicTask = "Live music at House on Fire";
                    if(!tasks.some(t => t.title === dinnerTask)) addNewTask(dinnerTask, 'personal', '7:00 PM');
                    if(!tasks.some(t => t.title === musicTask)) addNewTask(musicTask, 'personal', '8:30 PM');
                    showToast("Added weekend plans to your planner!", "success");
                    setActiveScreen('planner');
                }
            };
        }
        if (suggestion) {
            suggestionCard.querySelector('.card-title').innerHTML = `<i class="fas fa-lightbulb"></i> ${suggestion.title}`;
            suggestionText.textContent = suggestion.text;
            suggestionActionButton.textContent = suggestion.buttonText;
            suggestionActionButton.onclick = suggestion.action;
            suggestionCard.classList.remove('hidden');
            suggestionCard.style.opacity = 1; suggestionCard.style.transform = 'translateY(0)';
        } else {
            suggestionCard.style.opacity = 0; suggestionCard.style.transform = 'translateY(10px)';
            setTimeout(() => suggestionCard.classList.add('hidden'), 300);
        }
    }
    function openSubmitTipModal() {
        document.getElementById('submitTipForm').reset();
        document.getElementById('tipImagePreview').classList.add('hidden');
        document.getElementById('tipImageUploadText').textContent = 'Click to Upload or Open Camera';
        openModal('submitTipModal');
    }
    function previewImage(event, previewElId, textElId) {
        const reader = new FileReader();
        const preview = document.getElementById(previewElId);
        const uploadText = document.getElementById(textElId);
        if (!event.target.files[0]) return;
        reader.onload = function(){
            preview.src = reader.result;
            preview.classList.remove('hidden');
            if (uploadText) uploadText.textContent = 'Change image';
        };
        reader.readAsDataURL(event.target.files[0]);
    }
    function submitCommunityTip() {
        const title = document.getElementById('tipTitleInput').value.trim();
        const description = document.getElementById('tipDescriptionInput').value.trim();
        const subDetails = document.getElementById('tipSubDetailsInput').value.trim();
        const category = document.getElementById('tipCategorySelect').value;
        const tags = document.getElementById('tipTagsInput').value.split(',').map(t => t.trim()).filter(Boolean);
        const imgFile = document.getElementById('tipImageFileInput').files[0];
        const img = imgFile ? URL.createObjectURL(imgFile) : `https://source.unsplash.com/random/60x60/?${encodeURIComponent(tags[0] || category || 'eswatini')}`;
        if (!title || !description) {
            showToast("Please fill in both title and description.", "error", 2000, true);
            return;
        }
        const newPlace = {
            id: mockPlaces.all.length + 100,
            name: title,
            details: description,
            sub: subDetails,
            type: category,
            img: img,
            saved: false,
            openNow: subDetails.toLowerCase().includes("open"),
            rating: 0,
            aiSummary: "A new community submission. Awaiting more reviews.",
            tags: tags,
            isCommunityTip: true
        };
        mockPlaces.all.push(newPlace);
        if(!mockPlaces[category]) mockPlaces[category] = [];
        mockPlaces[category].push(newPlace);
        addXP(20, 'community');
        unlockBadge('contributor');
        closeModal('submitTipModal');
        showToast("Community tip submitted! AI will verify & it will appear in Explore.", "success", 2500);
        renderPlaces(category);
    }
    const communityChannelListEl = document.getElementById('communityChannelList');
    const typingIndicatorArea = document.getElementById('typingIndicatorArea');
    const mockUserSuggestionPopup = document.getElementById('mockUserSuggestionPopup');
    let typingTimeout;
    let lastMessageDate = null;
    function formatChannelTimestamp(timestamp) {
        if (!timestamp) return '';
        const messageDate = new Date(timestamp);
        const today = new Date();
        const yesterday = new Date(today);
        yesterday.setDate(today.getDate() - 1);
        if (messageDate.toDateString() === today.toDateString()) {
            return messageDate.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
        } else if (messageDate.toDateString() === yesterday.toDateString()) {
            return 'Yesterday';
        } else if (today.getFullYear() === messageDate.getFullYear()) {
            return messageDate.toLocaleDateString([], { month: 'short', day: 'numeric' });
        } else {
            return messageDate.toLocaleDateString([], { year:'2-digit', month: 'numeric', day: 'numeric' });
        }
    }
    function toggleChannelListType(type, buttonEl) {
        document.querySelectorAll('.channel-list-toggle button').forEach(btn => btn.classList.remove('active'));
        if (buttonEl) buttonEl.classList.add('active');
        renderChannels(type);
    }
    function findOrCreateDMChannel(otherUserId) {
        const otherUser = mockUsers[otherUserId];
        if (!otherUser) return null;
        const dmId = ['user', otherUserId].sort().join('-');
        let dmChannel = mockChannels.find(c => c.dmId === dmId);
        if (!dmChannel) {
            dmChannel = {
                id: nextChannelId++,
                dmId: dmId,
                name: otherUser.name,
                icon: 'fas fa-user-secret',
                color: otherUser.color || 'var(--primary-accent)',
                type: 'direct_message',
                participantIds: ['user', otherUserId],
                lastMessage: "No messages yet.",
                lastMessageTimestamp: new Date(),
                unreadCount: 0,
                isJoined: true,
                isFavorite: false,
                messages: [{
                    mid: nextMessageId++,
                    senderId: 'defaultBot',
                    text: `This is the beginning of your direct message history with ${otherUser.name}.`,
                    timestamp: new Date()
                }]
            };
            const triggeringNotification = mockNotifications.find(n => n.type === 'dm' && n.text.includes(otherUser.name));
            if(triggeringNotification) {
                 dmChannel.messages.push({
                    mid: nextMessageId++,
                    senderId: otherUserId,
                    text: triggeringNotification.text,
                    timestamp: new Date(triggeringNotification.timestamp)
                });
                dmChannel.lastMessage = triggeringNotification.text;
                dmChannel.lastMessageTimestamp = new Date(triggeringNotification.timestamp);
            }
            mockChannels.push(dmChannel);
            saveChannelsToLocalStorage();
        }
        return dmChannel;
    }
    function renderChannels(type = 'channels') {
        if (!communityChannelListEl) { return; }
        communityChannelListEl.innerHTML = Array(3).fill(getSkeletonChannelItem()).join('');
        communityChannelListEl.setAttribute('aria-busy', 'true');
        setTimeout(() => {
            communityChannelListEl.innerHTML = '';
            let channelsToRender;
            if (type === 'dms') {
                channelsToRender = mockChannels.filter(c => c.type === 'direct_message' && c.isJoined);
            } else if (type === 'favorites') {
                channelsToRender = mockChannels.filter(c => c.isFavorite && c.isJoined);
            } else if (type === 'recent') {
                channelsToRender = mockChannels.filter(c => c.isJoined).sort((a,b) => (b.lastOpened || 0) - (a.lastOpened || 0)).slice(0, 10);
            } else {
                channelsToRender = mockChannels.filter(c => c.type !== 'direct_message' && c.isJoined);
            }

            if (channelsToRender.length === 0) {
                const emptyStateHTML = `<div class="empty-state" style="padding: 20px 0; background-color: var(--card-bg);"><i class="fas fa-${type === 'dms' ? 'paper-plane' : 'comments'}"></i><p>No ${type} yet.</p></div>`;
                communityChannelListEl.innerHTML = emptyStateHTML;
            } else {
                if (type !== 'recent') {
                    channelsToRender.sort((a,b) => (b.isFavorite - a.isFavorite) || (new Date(b.lastMessageTimestamp) - new Date(a.lastMessageTimestamp)) );
                }
                channelsToRender.forEach(channel => {
                    const channelEl = document.createElement('button');
                    channelEl.className = 'channel-item';
                    channelEl.setAttribute('aria-label', `Open ${channel.name} channel. ${channel.unreadCount > 0 ? channel.unreadCount + ' unread messages.' : ''} ${channel.isFavorite ? 'Favorite channel.' : ''}`);
                    channelEl.onclick = () => showSpecificChatView(channel.id);
                    let favoriteIconClass = channel.isFavorite ? 'fas fa-star favorited' : 'far fa-star';
                    const formattedTimestamp = formatChannelTimestamp(channel.lastMessageTimestamp);
                    let avatarHtml;
                    if (channel.type === 'direct_message') {
                        const otherUserId = channel.participantIds.find(id => id !== 'user');
                        const otherUser = mockUsers[otherUserId];
                        avatarHtml = `<img src="${otherUser.avatarUrl}" alt="${otherUser.name}" class="channel-icon" style="width:48px; height:48px; object-fit: cover;" loading="lazy" />`;
                    } else if (channel.customIconUrl) {
                        avatarHtml = `<img src="${channel.customIconUrl}" alt="${channel.name}" class="channel-icon" style="width:48px; height:48px; object-fit: cover;" loading="lazy" />`;
                    } else {
                         avatarHtml = `<div class="channel-icon" style="background-color: ${channel.color};"><i class="${channel.icon}" aria-hidden="true"></i></div>`;
                    }
                    channelEl.innerHTML = `
                        ${avatarHtml}
                        <div class="channel-info-wrapper">
                             <div class="channel-info">
                                <div class="name">${channel.name}</div>
                                <div class="last-message">${channel.lastMessage || 'No messages yet.'}</div>
                            </div>
                            <div class="channel-actions-container">
                                <span class="last-message-timestamp">${formattedTimestamp}</span>
                                ${channel.unreadCount > 0 ? `<span class="unread-badge">${channel.unreadCount}</span>` : `<i class="channel-favorite-icon ${favoriteIconClass}" onclick="event.stopPropagation(); toggleFavoriteChannel(${channel.id}, false, this);" aria-label="${channel.isFavorite ? 'Unfavorite' : 'Favorite'} channel ${channel.name}"></i>`}
                            </div>
                        </div>
                    `;
                    communityChannelListEl.appendChild(channelEl);
                });
            }
            communityChannelListEl.setAttribute('aria-busy', 'false');
            renderPinnedWidgets();
        }, 500);
    }
    function updateChannelDescPlaceholder(channelType) {
        const descInput = document.getElementById('newChannelDesc');
        if (descInput) {
            if (channelType === 'skill_swap') {
                descInput.placeholder = "e.g., Offering: Web design help. Seeking: Guitar lessons. Clearly state if you're offering or seeking a skill.";
            } else if (channelType === 'hobby') {
                descInput.placeholder = "e.g., For local photography enthusiasts to share tips and organize meetups.";
            } else if (channelType === 'announcements') {
                descInput.placeholder = "e.g., Important updates for the Oakwood neighborhood association.";
            } else if (channelType === 'local_events') {
                descInput.placeholder = "e.g., Discussing the upcoming Summer Fest, planning carpools, sharing photos afterwards.";
            }
             else {
                descInput.placeholder = "e.g., Share gardening tips, or discuss local news.";
            }
        }
    }
    function openCreateChannelModal(nameFromAI = "", typeFromAI = "general", descFromAI = "") {
        document.getElementById('newChannelName').value = nameFromAI;
        document.getElementById('newChannelDesc').value = descFromAI;
        const channelTypeSelect = document.getElementById('newChannelType');
        if(channelTypeSelect) channelTypeSelect.value = typeFromAI;
        updateChannelDescPlaceholder(typeFromAI);
        populateIconSelector('newChannelIconSelector');
        openModal('createChannelModal');
    }
    function submitNewChannel(isAIInitiated = false) {
        const nameInput = document.getElementById('newChannelName');
        const descInput = document.getElementById('newChannelDesc');
        const typeInput = document.getElementById('newChannelType');
        const name = nameInput.value.trim();
        const desc = descInput.value.trim();
        const type = typeInput.value;
        const selectedIconEl = document.querySelector('#newChannelIconSelector .icon-option.selected');
        const customIconFile = document.getElementById('channelIconUpload').files[0];
        if (!name) { 
            if(!isAIInitiated) showToast("Channel name is required.", "error", 2000, true); nameInput.focus(); 
            return false; 
        }
        if (!selectedIconEl && !customIconFile) { 
            if(!isAIInitiated) showToast("Please select an icon or upload a custom one.", "error", 2000, true); 
            return false; 
        }
        let firstMessageText = `Welcome to ${name}! ${desc ? 'About: ' + desc : ''}`;
        if (type === 'skill_swap') {
            firstMessageText = `This is a Skill Swap channel! Please start your posts with "OFFERING:" or "SEEKING:" to make it clear. Example: "OFFERING: Basic plumbing help." or "SEEKING: Someone to teach Spanish." AI can help match users!`;
        }
        const now = new Date();
        const newChannel = {
            id: nextChannelId++, name: name, description: desc, icon: selectedIconEl?.dataset.icon, type: type,
            customIconUrl: customIconFile ? URL.createObjectURL(customIconFile) : null,
            color: availableColors[Math.floor(Math.random() * availableColors.length)], 
            lastMessage: "Channel created! Start the conversation.", lastMessageTimestamp: now,
            unreadCount: 0, 
            isJoined: true, isFavorite: false, 
            messages: [{ mid: nextMessageId++, senderId: 'defaultBot', text: firstMessageText, timestamp: now, reactions: {} }]
        };
        mockChannels.unshift(newChannel); 
        renderChannels();
        if(!isAIInitiated) closeModal('createChannelModal');
        showToast(`AI: Channel "${name}" created and joined!`, "ai_info", 2000);
        addXP(20, 'community');
        triggerFabSuggestion();
        saveChannelsToLocalStorage();
        return true;
    }
    const channelListView = document.getElementById('channelListView');
    const specificChatView = document.getElementById('specificChatView');
    const specificChatTitle = document.getElementById('specificChatTitle');
    const specificChatMessagesArea = document.getElementById('specificChatMessagesArea');
    const specificChatInput = document.getElementById('specificChatInput');
    const aiChatSummaryButtonContainer = document.getElementById('aiChatSummaryButtonContainer');
    const specificChatAvatar = document.getElementById('specificChatAvatar');
    const specificChatStatus = document.getElementById('specificChatStatus');
    let currentChatChannelId = null;
    function showSpecificChatView(channelId) { 
        const channel = mockChannels.find(c => c.id === channelId);
        if (!channel) { showToast("Error: Channel not found.", "error", 2000, true); return; }
        currentChatChannelId = channelId;
        channel.lastOpened = new Date();
        lastMessageDate = null;
        appContainer.classList.add('full-page-active'); 
        if (specificChatTitle) specificChatTitle.textContent = channel.name;
        if (specificChatAvatar) {
            if(channel.type === 'direct_message') {
                const otherUserId = channel.participantIds.find(id => id !== 'user');
                const otherUser = mockUsers[otherUserId];
                specificChatAvatar.src = otherUser.avatarUrl;
                specificChatAvatar.alt = otherUser.name;
                specificChatStatus.textContent = otherUser.location || "Online";
            } else if (channel.customIconUrl) {
                specificChatAvatar.src = channel.customIconUrl;
                specificChatAvatar.alt = channel.name;
            } else {
                 const tempAvatarText = channel.name.split(' ').map(w => w[0]).join('').substring(0,2);
                 specificChatAvatar.src = `https://via.placeholder.com/40/${channel.color.replace('#','')}/FFFFFF?text=${tempAvatarText}`;
                 specificChatAvatar.alt = channel.name;
                 const members = new Set(channel.messages?.map(m => m.senderId) || []);
                 specificChatStatus.textContent = `${members.size} member${members.size !== 1 ? 's' : ''}, ${Math.floor(Math.random() * (members.size -1))} online`;
            }
        }
        if (specificChatMessagesArea) specificChatMessagesArea.innerHTML = ''; 
        if (channel.unreadCount > 5 && aiChatSummaryButtonContainer && userSubscriptionTier.startsWith('pro') && notificationPreferences.aiSmartAlerts) {
            aiChatSummaryButtonContainer.innerHTML = `<button class="button button-secondary" onclick="summarizeChannel(${channel.id})"><i class="fas fa-brain"></i> AI: Summarize What I Missed</button>`;
            aiChatSummaryButtonContainer.classList.remove('hidden');
        } else if (aiChatSummaryButtonContainer) {
            aiChatSummaryButtonContainer.classList.add('hidden');
        }
        (channel.messages || []).forEach((msg) => addMessageToSpecificChatDOM(msg, true));
        if (specificChatMessagesArea) specificChatMessagesArea.scrollTop = specificChatMessagesArea.scrollHeight;
        if (channelListView) channelListView.style.display = 'none';
        if (specificChatView) {
            specificChatView.classList.remove('hidden');
            specificChatView.classList.add('active'); 
        }
        if (specificChatInput) {
            specificChatInput.focus();
            autoGrowTextarea(specificChatInput);
        }
        if (channel.unreadCount > 0) {
            channel.unreadCount = 0; 
            renderChannels(document.querySelector('.channel-list-toggle button.active')?.id.replace('show','').replace('Btn','').toLowerCase() || 'channels');
            saveChannelsToLocalStorage();
        }
    }
    function summarizeChannel(channelId) {
        const channel = mockChannels.find(c => c.id === channelId);
        if (!channel || !channel.messages) return;
        const unreadMessages = channel.messages.slice(-channel.unreadCount);
        let summaryText = `Summary of the last ${unreadMessages.length} messages: `;
        let topics = new Set();
        let questions = 0;
        unreadMessages.forEach(msg => {
            if (msg.text.includes('?')) questions++;
            if (msg.senderId !== 'user') topics.add(`@${(mockUsers[msg.senderId] || mockUsers.defaultBot).name} talked about something.`);
        });
        const mainTopic = channel.messages.slice(-1)[0].text.substring(0, 30) + '...';
        summaryText += `Main conversation is about "${mainTopic}". `;
        if(questions > 0) summaryText += `${questions} question${questions > 1 ? 's were' : ' was'} asked.`;
        showToast(summaryText, 'ai_info', 5000);
        aiChatSummaryButtonContainer.classList.add('hidden');
    }
    function showChannelListView(silent = false) { 
        appContainer.classList.remove('full-page-active');
        if (channelListView) channelListView.style.display = 'block';
        if (specificChatView) {
            specificChatView.classList.add('hidden');
            specificChatView.classList.remove('active');
        }
        currentChatChannelId = null;
        if(!silent) renderChannels(document.querySelector('.channel-list-toggle button.active')?.id.replace('show','').replace('Btn','').toLowerCase() || 'channels');
    }
    window.showChannelDetailModal = function() {
        if (!currentChatChannelId) return;
        const channel = mockChannels.find(c => c.id === currentChatChannelId);
        if (!channel) return;
        if(channel.type === 'direct_message') {
            const otherUserId = channel.participantIds.find(id => id !== 'user');
            if(otherUserId) showOtherUserProfile(otherUserId);
            return;
        }
        document.getElementById('channelDetailModalTitle').textContent = channel.name;
        const iconEl = document.getElementById('channelDetailIcon');
        if (channel.customIconUrl) {
            iconEl.innerHTML = `<img src="${channel.customIconUrl}" style="width:100%; height:100%; border-radius:50%; object-fit:cover;">`;
            iconEl.style.backgroundColor = 'transparent';
        } else {
            iconEl.innerHTML = `<i class="${channel.icon}"></i>`;
            iconEl.style.backgroundColor = channel.color;
        }
        document.getElementById('channelDetailType').textContent = channelTypeLabels[channel.type] || "General";
        document.getElementById('channelDetailDescription').textContent = channel.description || "No description provided.";
        document.getElementById('channelDetailMemberCount').textContent = (new Set(channel.messages.map(m=>m.senderId))).size;
        const joinButton = document.getElementById('channelDetailJoinButton');
        joinButton.textContent = channel.isJoined ? 'Leave Channel' : 'Join Channel';
        joinButton.onclick = () => toggleJoinChannel(channel.id, true);
        const favButton = document.getElementById('channelDetailFavoriteButton');
        favButton.innerHTML = channel.isFavorite ? `<i class="fas fa-star"></i> Favorited` : `<i class="far fa-star"></i> Add to Favorites`;
        favButton.onclick = () => toggleFavoriteChannel(channel.id, true, favButton.querySelector('i'));
        openModal('channelDetailModal');
    }
    window.toggleJoinChannel = function(channelId, fromModal = false) {
        const channel = mockChannels.find(c => c.id === channelId);
        if (channel) {
            channel.isJoined = !channel.isJoined;
            showToast(channel.isJoined ? `Joined "${channel.name}"!` : `Left "${channel.name}".`, 'success');
            renderChannels();
            saveChannelsToLocalStorage();
            if (fromModal && currentOpenModalId === 'channelDetailModal') { 
                document.getElementById('channelDetailJoinButton').textContent = channel.isJoined ? 'Leave Channel' : 'Join Channel';
            }
        }
    }
    window.toggleFavoriteChannel = function(channelId, fromModalOrIcon = false, iconElement = null) {
        const channel = mockChannels.find(c => c.id === channelId);
        if (channel) {
            channel.isFavorite = !channel.isFavorite;
            showToast(channel.isFavorite ? `"${channel.name}" added to favorites!` : `"${channel.name}" removed from favorites.`, 'success');
            if (fromModalOrIcon && currentOpenModalId === 'channelDetailModal') { 
                const modalFavButtonIcon = document.querySelector('#channelDetailFavoriteButton i');
                if(modalFavButtonIcon) {
                    modalFavButtonIcon.className = channel.isFavorite ? 'fas fa-star' : 'far fa-star';
                    document.getElementById('channelDetailFavoriteButton').innerHTML = channel.isFavorite ? `<i class="fas fa-star"></i> Favorited` : `<i class="far fa-star"></i> Add to Favorites`;
                }
            }
            renderChannels(document.querySelector('.channel-list-toggle button.active')?.id.replace('show','').replace('Btn','').toLowerCase() || 'channels');
            saveChannelsToLocalStorage();
        }
    }
    function addMessageToSpecificChatDOM(message, isHistory = false) {
        if (!specificChatMessagesArea) return;
        const messageDate = new Date(message.timestamp);
        if (!lastMessageDate || messageDate.toDateString() !== lastMessageDate.toDateString()) {
            const dateSeparator = document.createElement('div');
            dateSeparator.className = 'chat-date-separator';
            if (messageDate.toDateString() === new Date().toDateString()) {
                dateSeparator.textContent = 'Today';
            } else if (messageDate.toDateString() === new Date(Date.now() - 86400000).toDateString()) {
                dateSeparator.textContent = 'Yesterday';
            } else {
                dateSeparator.textContent = messageDate.toLocaleDateString([], { weekday: 'long', month: 'long', day: 'numeric' });
            }
            specificChatMessagesArea.appendChild(dateSeparator);
        }
        lastMessageDate = messageDate;
        const senderIsUser = message.senderId === 'user';
        const senderDetails = mockUsers[message.senderId] || mockUsers.defaultBot; 
        const messageWrapper = document.createElement('div');
        messageWrapper.classList.add('chat-message-wrapper', senderIsUser ? 'user' : 'other');
        messageWrapper.dataset.messageId = message.mid;
        const avatarImg = document.createElement('img');
        if (!senderIsUser) {
            avatarImg.src = senderDetails.avatarUrl;
            avatarImg.alt = senderDetails.name;
            avatarImg.classList.add('chat-avatar', 'other-avatar');
            avatarImg.onclick = () => showOtherUserProfile(message.senderId);
            avatarImg.loading = 'lazy';
        }
        const bubble = document.createElement('div');
        bubble.classList.add('chat-bubble', senderIsUser ? 'user' : 'other');
        if (message.isAIIntervention && !senderIsUser) {
            bubble.classList.add('ai-intervention');
        }
        const messageTime = messageDate.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
        let reactionsHtml = '<div class="message-reactions">';
        if(message.reactions && Object.keys(message.reactions).length > 0) {
            Object.entries(message.reactions).forEach(([emoji, data]) => {
                const reactedByUser = data.users.includes('user');
                reactionsHtml += `<button class="reaction-button ${reactedByUser ? 'reacted-by-user' : ''}" onclick="toggleReaction(${currentChatChannelId}, ${message.mid}, '${emoji}')" aria-label="React with ${emoji}">${emoji} ${data.count > 0 ? data.count : ''}</button>`;
            });
        }
        reactionsHtml += '</div>';
        let senderNameHtml = '';
        const currentChannel = mockChannels.find(c => c.id === currentChatChannelId);
        if (!senderIsUser && currentChannel?.type !== 'direct_message') {
            senderNameHtml = `<strong class="chat-sender-name" onclick="showOtherUserProfile('${message.senderId}')">${senderDetails.name}</strong>`;
        }
        let messageMetaHtml = `<span class="message-meta"><span class="timestamp">${messageTime}</span>`;
        if(senderIsUser) { 
            const ticksIcon = message.readByRecipient_mock ? 'fa-check-double' : 'fa-check'; 
            const ticksColor = message.readByRecipient_mock ? 'var(--info-color)' : 'var(--chat-user-timestamp-color)';
            messageMetaHtml += `<span class="status-ticks" style="color: ${ticksColor};"><i class="fas ${ticksIcon}"></i></span>`;
        }
        messageMetaHtml += `</span>`;
        let messageActionsHtml = `
            <div class="chat-message-actions">
                <button onclick="replyToMessage(${currentChatChannelId}, ${message.mid})" aria-label="Reply"><i class="fas fa-reply"></i></button>`;
        if (senderIsUser) {
            messageActionsHtml += `<button onclick="editMessage(${currentChatChannelId}, ${message.mid})" aria-label="Edit"><i class="fas fa-pencil-alt"></i></button>
                                   <button onclick="deleteMessage(${currentChatChannelId}, ${message.mid})" aria-label="Delete"><i class="fas fa-trash-alt"></i></button>`;
        }
        messageActionsHtml += `</div>`;
        bubble.innerHTML = `
            ${messageActionsHtml}
            ${senderNameHtml}
            <div class="chat-bubble-content">
                <span class="chat-bubble-text">${message.text.replace(/\n/g, '<br>')}</span>
                ${messageMetaHtml}
            </div>
            ${reactionsHtml}
        `;
        if (senderIsUser) {
            messageWrapper.appendChild(bubble);
        } else {
            messageWrapper.appendChild(avatarImg); 
            messageWrapper.appendChild(bubble);
        }
        specificChatMessagesArea.appendChild(messageWrapper);
        if (!isHistory) {
             specificChatMessagesArea.scrollTop = specificChatMessagesArea.scrollHeight;
        }
    }
    window.replyToMessage = function(channelId, messageId) {
        const channel = mockChannels.find(c => c.id === channelId);
        if (channel && channel.messages) {
            const msg = channel.messages.find(m => m.mid === messageId);
            if (msg && specificChatInput) {
                const senderName = (mockUsers[msg.senderId] || mockUsers.defaultBot).name;
                specificChatInput.value = `> @${senderName}: ${msg.text.substring(0,30)}...\n\n` + specificChatInput.value;
                specificChatInput.focus();
                autoGrowTextarea(specificChatInput);
                showToast("Quoted message for reply.", "info");
            }
        }
    }
    window.editMessage = function(channelId, messageId) {
        const channel = mockChannels.find(c => c.id === channelId);
        if (channel && channel.messages) {
            const msgIndex = channel.messages.findIndex(m => m.mid === messageId);
            if (msgIndex !== -1 && channel.messages[msgIndex].senderId === 'user') {
                const newText = prompt("Edit your message:", channel.messages[msgIndex].text);
                if (newText !== null && newText.trim() !== "") {
                    channel.messages[msgIndex].text = newText.trim();
                    channel.messages[msgIndex].edited = true;
                    channel.lastMessage = `You: ${newText.trim().substring(0,25)}... (edited)`;
                    channel.lastMessageTimestamp = new Date();
                    lastMessageDate = null;
                    specificChatMessagesArea.innerHTML = ''; 
                    (channel.messages || []).forEach((m) => addMessageToSpecificChatDOM(m, true));
                    specificChatMessagesArea.scrollTop = specificChatMessagesArea.scrollHeight;
                    renderChannels(channel.type === 'direct_message' ? 'dms' : 'channels');
                    saveChannelsToLocalStorage();
                    showToast("Message edited.", "success");
                }
            }
        }
    }
    window.deleteMessage = function(channelId, messageId) {
        const channel = mockChannels.find(c => c.id === channelId);
        if (channel && channel.messages) {
             const msgIndex = channel.messages.findIndex(m => m.mid === messageId);
             if (msgIndex !== -1 && channel.messages[msgIndex].senderId === 'user') {
                openConfirmationModal(
                    "Delete Message?", 
                    "Are you sure you want to delete this message? This action cannot be undone.", 
                    () => {
                        channel.messages.splice(msgIndex, 1);
                        if (channel.messages.length > 0) {
                             const lastMsg = channel.messages[channel.messages.length -1];
                             const senderName = (mockUsers[lastMsg.senderId] || mockUsers.defaultBot).name;
                             channel.lastMessage = `${senderName}: ${lastMsg.text.substring(0,25)}...`;
                             channel.lastMessageTimestamp = new Date(lastMsg.timestamp);
                        } else {
                            channel.lastMessage = "No messages yet.";
                            channel.lastMessageTimestamp = new Date();
                        }
                        lastMessageDate = null;
                        specificChatMessagesArea.innerHTML = ''; 
                        (channel.messages || []).forEach((m) => addMessageToSpecificChatDOM(m, true));
                        specificChatMessagesArea.scrollTop = specificChatMessagesArea.scrollHeight;
                        renderChannels(channel.type === 'direct_message' ? 'dms' : 'channels');
                        saveChannelsToLocalStorage();
                        showToast("Message deleted.", "success");
                    }
                );
            }
        }
    }
    window.showOtherUserProfile = function(userId) {
        const user = mockUsers[userId];
        if (!user) { showToast("User profile not found.", "error", 2000, true); return; }
        document.getElementById('otherUserAvatar').src = user.avatarUrl;
        document.getElementById('otherUserAvatar').alt = user.name;
        document.getElementById('otherUserProfileModalTitle').textContent = user.name;
        document.getElementById('otherUserUsername').textContent = user.username;
        document.getElementById('otherUserBio').textContent = user.bio || "No bio available.";
        document.getElementById('otherUserInterests').textContent = user.interests || "No interests listed.";
        const userChannels = mockChannels.filter(c => c.isJoined && c.type !== 'direct_message').map(c => c.id);
        const otherUserChannels = mockChannels.filter(c => Math.random() > 0.3).map(c => c.id);
        const mutualChannelIds = userChannels.filter(id => otherUserChannels.includes(id));
        const mutualChannels = mockChannels.filter(c => mutualChannelIds.includes(c.id));
        document.getElementById('otherUserMutualChannels').textContent = mutualChannels.length > 0 ? mutualChannels.map(c => c.name).join(', ') : "No mutual channels found.";
        const messageButton = document.getElementById('otherUserMessageButton');
        messageButton.onclick = () => {
            closeModal('otherUserProfileModal');
            startDirectMessage(userId);
        };
        openModal('otherUserProfileModal');
    }
    function startDirectMessage(otherUserId) {
        const dmChannel = findOrCreateDMChannel(otherUserId);
        if(dmChannel) {
            setActiveScreen('chat');
            setTimeout(() => {
                toggleChannelListType('dms', document.getElementById('showDMsBtn'));
                showSpecificChatView(dmChannel.id);
            }, 100);
        } else {
            showToast("Could not start a direct message.", "error");
        }
    }
    function toggleReaction(channelId, messageId, reactionEmoji) {
        const channel = mockChannels.find(c => c.id === channelId);
        if (channel && channel.messages) {
            const message = channel.messages.find(m => m.mid === messageId);
            if (message) {
                if (!message.reactions) message.reactions = {};
                if (!message.reactions[reactionEmoji]) message.reactions[reactionEmoji] = { count: 0, users: [] };
                const userIndex = message.reactions[reactionEmoji].users.indexOf('user');
                if (userIndex > -1) {
                    message.reactions[reactionEmoji].count--;
                    message.reactions[reactionEmoji].users.splice(userIndex, 1);
                } else {
                    message.reactions[reactionEmoji].count++;
                    message.reactions[reactionEmoji].users.push('user');
                    addXP(1, 'community');
                }
                if (message.reactions[reactionEmoji].count === 0) {
                    delete message.reactions[reactionEmoji];
                }
                const messageWrapper = specificChatMessagesArea.querySelector(`.chat-message-wrapper[data-message-id="${messageId}"]`);
                if (messageWrapper) {
                    const reactionContainer = messageWrapper.querySelector('.message-reactions');
                    let reactionsHtml = '';
                    if(message.reactions && Object.keys(message.reactions).length > 0) {
                        Object.entries(message.reactions).forEach(([emoji, data]) => {
                             const reactedByUser = data.users.includes('user');
                             reactionsHtml += `<button class="reaction-button ${reactedByUser ? 'reacted-by-user' : ''}" onclick="toggleReaction(${currentChatChannelId}, ${message.mid}, '${emoji}')" aria-label="React with ${emoji}">${emoji} ${data.count > 0 ? data.count : ''}</button>`;
                        });
                    }
                    reactionContainer.innerHTML = reactionsHtml;
                } else {
                    lastMessageDate = null; 
                    specificChatMessagesArea.innerHTML = ''; 
                    (channel.messages || []).forEach((msg) => addMessageToSpecificChatDOM(msg, true));
                    specificChatMessagesArea.scrollTop = specificChatMessagesArea.scrollHeight;
                }
                saveChannelsToLocalStorage();
            }
        }
    }
    function handleChatInputTyping(textarea, type = 'specific') {
        const container = textarea.closest('.chat-input-container');
        const wrapper = container.querySelector('.chat-input-wrapper');
        const actionBtn = container.querySelector('.chat-input-action-button');
        const actionIcon = actionBtn.querySelector('i');
        const hasText = textarea.value.trim().length > 0;
        wrapper.classList.toggle('typing-active', hasText);
        if (hasText) {
            actionIcon.className = 'fas fa-paper-plane';
            actionBtn.setAttribute('aria-label', 'Send message');
            actionBtn.onclick = (type === 'specific') ? sendSpecificChatMessage : sendAIChatMessage;
        } else {
            actionIcon.className = 'fas fa-microphone';
            actionBtn.setAttribute('aria-label', 'Use voice input');
            actionBtn.onclick = (type === 'specific') ? () => native.speechToText('specific') : () => native.speechToText('ai');
        }
        if (type === 'specific') {
            handleSpecificChatInputForMentions(textarea);
        } else {
            updateAIChatTypingSuggestion(textarea.value);
        }
    }
    function sendSpecificChatMessage() { 
        if (!specificChatInput) return;
        const messageText = specificChatInput.value.trim();
        if (!messageText || !currentChatChannelId) {
             if (!messageText) native.speechToText('specific');
             return;
        }
        const timestamp = new Date();
        const channel = mockChannels.find(c => c.id === currentChatChannelId);
        if (!channel) return;
        if (!channel.messages) channel.messages = [];
        const newMessage = { mid: nextMessageId++, senderId: 'user', text: messageText, timestamp, reactions: {}, readByRecipient_mock: false };
        channel.messages.push(newMessage);
        addMessageToSpecificChatDOM(newMessage);
        addXP(2, 'community');
        specificChatInput.value = '';
        autoGrowTextarea(specificChatInput);
        handleChatInputTyping(specificChatInput, 'specific');
        if (mockUserSuggestionPopup) mockUserSuggestionPopup.classList.add('hidden');
        channel.lastMessage = `You: ${messageText.substring(0,25)}...`;
        channel.lastMessageTimestamp = timestamp;
        if (typingIndicatorArea) {
            let botName = mockUsers.defaultBot.name.split(' ')[0];
            if(channel.type === 'direct_message') {
                const otherUserId = channel.participantIds.find(id => id !== 'user');
                botName = mockUsers[otherUserId].name.split(' ')[0];
            }
            typingIndicatorArea.textContent = `${botName} is typing...`;
            typingIndicatorArea.classList.remove('hidden');
        }
        clearTimeout(typingTimeout);
        typingTimeout = setTimeout(() => {
            if (typingIndicatorArea) typingIndicatorArea.classList.add('hidden');
            let reply = "Got it!"; 
            let isAIIntervention = false;
            let aiReplySender = 'defaultBot'; 
            if(channel.type === 'direct_message') {
                aiReplySender = channel.participantIds.find(id => id !== 'user');
                const replies = ["Okay, I see.", "That's interesting.", "Thanks for letting me know.", "Haha, that's funny.", "What do you think?"];
                reply = replies[Math.floor(Math.random() * replies.length)];
            } else {
                if (channel.type === 'skill_swap' && messageText.toLowerCase().startsWith("seeking:") && messageText.toLowerCase().includes("garden")) {
                    const gardeningChannel = mockChannels.find(c => c.name.toLowerCase().includes('gardeners'));
                    const gardener = gardeningChannel?.messages.find(m => m.text.toLowerCase().includes("offering:") || m.text.toLowerCase().includes("extra plants"));
                    if (gardener) {
                        reply = `AI Connector: I noticed you're seeking help with a garden. @${(mockUsers[gardener.senderId] || {}).name || 'BenS'} recently mentioned having extra tomato plants in the #Local-Gardeners channel. You might want to connect!`;
                        isAIIntervention = true;
                    }
                } else if (messageText.toLowerCase().includes("remember to") || messageText.toLowerCase().includes("i need to add task")) {
                    const taskMatch = messageText.match(/(remember to|i need to add task)\s+(.*)/i);
                    if (taskMatch && taskMatch[2]) {
                        reply = `AI: I can help with that, ${userName}! Would you like me to add "${taskMatch[2].substring(0,30)}..." as a task for you? <button class="button" onclick="addNewTask('${taskMatch[2].replace(/'/g, "\\'")}')">Yes, Add Task</button>`;
                        isAIIntervention = true;
                    }
                } else if (messageText.toLowerCase().includes("help me draft a reply") && messageText.length > 20 && aiLearningPreferences.learnChatStyle) {
                     reply = `AI: Okay, ${userName}. Based on the context, how about this reply: "That sounds interesting! Can you tell me more about [topic]?"`;
                     isAIIntervention = true;
                }
            }
            newMessage.readByRecipient_mock = true;
            const userMessageBubble = specificChatMessagesArea.querySelector(`.chat-message-wrapper[data-message-id="${newMessage.mid}"] .chat-bubble.user .status-ticks i`);
            if (userMessageBubble) {
                userMessageBubble.className = 'fas fa-check-double';
                userMessageBubble.parentElement.style.color = 'var(--info-color)';
            }
            const replyTimestamp = new Date();
            const aiReplyMessage = { mid: nextMessageId++, senderId: aiReplySender, text: reply, timestamp: replyTimestamp, reactions: {}, isAIIntervention };
            channel.messages.push(aiReplyMessage);
            const replySenderName = mockUsers[aiReplySender]?.name || 'Bot';
            channel.lastMessage = `${replySenderName}: ${reply.substring(0,25)}...`;
            channel.lastMessageTimestamp = replyTimestamp;
            addMessageToSpecificChatDOM(aiReplyMessage);
            renderChannels(document.querySelector('.channel-list-toggle button.active')?.id.replace('show','').replace('Btn','').toLowerCase() || 'channels'); 
            saveChannelsToLocalStorage();
        }, 800 + Math.random() * 700);
    }
    if (specificChatInput) {
        specificChatInput.addEventListener('keypress', function (e) { if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); sendSpecificChatMessage(); }});
        specificChatInput.addEventListener('input', () => handleChatInputTyping(specificChatInput, 'specific'));
    }
    function handleSpecificChatInputForMentions(textarea) {
        const text = textarea.value;
        const cursorPos = textarea.selectionStart;
        const atMatch = text.substring(0, cursorPos).match(/@(\w*)$/);
        if (atMatch && atMatch[1] && mockUserSuggestionPopup) {
            const searchTerm = atMatch[1].toLowerCase();
            const suggestions = Object.values(mockUsers)
                .filter(u => u.id !== 'user' && u.name.toLowerCase().includes(searchTerm))
                .slice(0, 5);
            if (suggestions.length > 0) {
                mockUserSuggestionPopup.innerHTML = '';
                suggestions.forEach(user => {
                    const btn = document.createElement('button');
                    btn.textContent = user.name;
                    btn.onclick = () => {
                        const newText = text.substring(0, cursorPos - searchTerm.length -1) + `@${user.name} ` + text.substring(cursorPos);
                        textarea.value = newText;
                        textarea.focus();
                        textarea.setSelectionRange(cursorPos - searchTerm.length + user.name.length + 2, cursorPos - searchTerm.length + user.name.length + 2);
                        mockUserSuggestionPopup.classList.add('hidden');
                        autoGrowTextarea(textarea);
                    };
                    mockUserSuggestionPopup.appendChild(btn);
                });
                mockUserSuggestionPopup.classList.remove('hidden');
            } else {
                mockUserSuggestionPopup.classList.add('hidden');
            }
        } else if (mockUserSuggestionPopup) {
            mockUserSuggestionPopup.classList.add('hidden');
        }
    }
    document.addEventListener('click', function(event) {
        if (mockUserSuggestionPopup && !mockUserSuggestionPopup.contains(event.target) && event.target !== specificChatInput) {
            mockUserSuggestionPopup.classList.add('hidden');
        }
    });
    function autoGrowTextarea(textarea) {
        textarea.style.height = 'auto';
        const scrollHeight = textarea.scrollHeight;
        if(scrollHeight > 0) {
             textarea.style.height = scrollHeight + 'px';
        }
        if (textarea.value.trim().length > 0) {
            textarea.style.alignSelf = 'flex-end';
        } else {
            textarea.style.alignSelf = 'center';
        }
    }
    function aiSuggestChannelToJoin() {
        if (mockChannels.length > 2) {
            const potentialChannels = mockChannels.filter(ch => !ch.isJoined && ch.type !== 'announcements' && ch.id !== currentChatChannelId);
            if(potentialChannels.length > 0) {
                const randomChannel = potentialChannels[Math.floor(Math.random() * potentialChannels.length)];
                 openGenericModal("AI Channel Suggestion", `<p>Based on local activity and your interests, ${userName}, you might like the channel: <strong>${randomChannel.name}</strong>.</p><p><em>Description: ${randomChannel.description || 'General discussions.'}</em></p><button class="button mt-2" onclick="closeModal('genericModal'); toggleJoinChannel(${randomChannel.id}); showSpecificChatView(${randomChannel.id});">Join & View Channel</button>`);
            } else {
                 showToast("AI: You've already joined most relevant channels or there aren't many new ones yet!", "ai_info");
            }
        } else {
            showToast("AI: Not enough channels to make a suggestion yet. Explore existing ones!", "ai_info");
        }
    }
    window.toggleAIChat = function() { 
        if (!aiBottomSheet || !aiFab) return;
        const isActive = aiBottomSheet.classList.toggle('active');
        appContainer.classList.toggle('full-page-active', isActive && window.innerWidth <= 450);
        aiFab.classList.remove('has-suggestion');
        aiFab.style.animation = '';
        aiFab.setAttribute('aria-expanded', isActive.toString());
        if(isActive && aiChatInputText) {
            const activeScreen = document.querySelector('.screen.active');
            let placeholder = "Ask or command...";
            let quickAction = "Plan my day";
            switch(activeScreen?.id) {
                case 'planner': placeholder = "e.g., Optimize my schedule..."; quickAction = "Optimize My Day"; break;
                case 'explore': placeholder = "e.g., Build an itinerary for tonight..."; quickAction = "Plan an evening"; break;
                case 'wellness': placeholder = "e.g., Review my wellness patterns..."; quickAction = "Wellness summary"; break;
            }
            aiChatInputText.placeholder = placeholder;
            const quickPlanButton = document.querySelector('.ai-quick-action-button[onclick*="Plan my day"]');
            if (quickPlanButton) quickPlanButton.textContent = quickAction;
            aiChatInputText.focus();
        }
        if (navigator.vibrate) navigator.vibrate(10); 
    }
    function addMessageToAIChat(sender, text, isHTML = false) { 
        if (!aiChatArea) return;
        const bubbleWrapper = document.createElement('div');
        bubbleWrapper.className = `chat-message-wrapper ${sender === 'user' ? 'user' : 'other'}`;
        const bubble = document.createElement('div');
        bubble.classList.add('chat-bubble', sender === 'user' ? 'user' : 'other');
        const bubbleContent = document.createElement('div');
        bubbleContent.className = 'chat-bubble-content';
        const textSpan = document.createElement('span');
        textSpan.className = 'chat-bubble-text';
        if (isHTML) {
            textSpan.innerHTML = text; 
        } else {
            textSpan.textContent = text;
        }
        bubbleContent.appendChild(textSpan);
        bubble.appendChild(bubbleContent);
        bubbleWrapper.appendChild(bubble);
        aiChatArea.appendChild(bubbleWrapper);
        aiChatArea.scrollTop = aiChatArea.scrollHeight;
    }
    window.sendAIChatMessage = function() { 
        if (!aiChatInputText) return;
        const command = aiChatInputText.value.trim();
        if (!command) {
            native.speechToText('ai');
            return;
        }
        if (aiConversationContext) {
            processAICommand(command, true);
        } else {
            processAICommand(command);
        }
        addMessageToAIChat('user', command);
        aiChatInputText.value = '';
        autoGrowTextarea(aiChatInputText);
        handleChatInputTyping(aiChatInputText, 'ai');
        if (aiChatTypingSuggestionEl) aiChatTypingSuggestionEl.textContent = '';
    }
    if (aiChatInputText) aiChatInputText.addEventListener('keypress', function (e) { if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); sendAIChatMessage(); }});
    window.updateAIChatTypingSuggestion = function(text) {
        if (!aiChatTypingSuggestionEl) return;
        text = text.toLowerCase();
        let suggestion = "";
        if (text.startsWith("add task")) suggestion = "e.g., add task Meeting with Sbu at The Gables Tomorrow at 2pm";
        else if (text.startsWith("find")) suggestion = "e.g., find places with braai spots OR find deals on mobile data";
        else if (text.startsWith("plan my")) suggestion = "e.g., plan my day OR plan my weekend trip to Ezulwini";
        else if (text.startsWith("set reminder")) suggestion = "e.g., set reminder to call Gogo in 1 hour";
        else if (text.startsWith("log mood")) suggestion = "e.g., log mood happy with note: Great day!";
        else if (text.startsWith("summarize channel")) suggestion = "e.g., summarize channel \"Eswatini Foodies\"";
        else if (text.startsWith("suggest habit for")) suggestion = "e.g., suggest habit for stress relief";
        else if (text.startsWith("analyze my last journal")) suggestion = "e.g., analyze my last journal entry";
        aiChatTypingSuggestionEl.textContent = suggestion;
    }
    function clearAIChat() {
        if (aiChatArea) aiChatArea.innerHTML = '';
        aiConversationContext = null; aiExpectedResponseType = null;
        addMessageToAIChat('other', getAIPersonalityPrefix() + "Chat cleared. How can I help?");
        showToast("AI Chat cleared.", "info");
    }
    function getAIPersonalityPrefix() {
        let prefix = ""; 
        switch(currentAiPersonality) {
            case 'friendly': prefix = "Your friendly AI: "; break;
            case 'professional': prefix = "Assistant: "; break;
            case 'witty': prefix = "Your (slightly snarky) AI: "; break;
            case 'coach': prefix = "Your Calm Coach: "; break;
            case 'mentor': prefix = "Your Business Mentor: "; break;
            case 'helpful': prefix = "Helpful Bot: "; break;
        }
        return prefix;
    }
    function triggerFabSuggestion(isContextual = true, newIconClass = 'fa-lightbulb') { 
        if (aiFab && aiFabIcon && !aiBottomSheet.classList.contains('active') && !appContainer.classList.contains('full-page-active') && notificationPreferences.aiSuggestions) {
            aiFab.classList.add('has-suggestion');
            aiFab.style.backgroundColor = 'var(--info-color)';
            aiFabIcon.className = `fas ${newIconClass}`;
            clearTimeout(fabSuggestionTimeout);
            fabSuggestionTimeout = setTimeout(() => {
                aiFab.classList.remove('has-suggestion');
                aiFab.style.backgroundColor = '';
                updateContextualFabIcon();
            }, 3000);
            if (isContextual) {
                showToast("AI has a contextual suggestion! (Tap the icon)", "ai_info", 2500);
            }
        }
    }
    function processAICommand(originalCommand, isFollowUp = false) {
        const command = originalCommand.toLowerCase();
        let response = "I'm processing that. ";
        let aiPrefix = getAIPersonalityPrefix();
        let isHTMLResponse = false;
        let requiresFollowUpInResponse = false;
        let currentScreenId = document.querySelector('.screen.active')?.id;
        let contextMessage = "";
        if(currentScreenId === 'explore' && (command.includes("any of these") || command.includes("about this area"))){
            const currentFilter = document.querySelector('#exploreFilterBar .filter-button.active')?.dataset.filter || 'all';
            contextMessage = `(Context: Explore, filter: ${currentFilter}) `;
        } else if (currentScreenId === 'planner' && (command.includes("this task") || command.includes("my schedule"))){
             contextMessage = `(Context: Planner) `;
        } else if (currentScreenId === 'wellness' && (command.includes("my mood") || command.includes("my habits"))){
             contextMessage = `(Context: Wellness Hub) `;
        }
        if (isFollowUp && aiConversationContext) {
            if (aiConversationContext === "party_planning_date") {
                aiConversationContext = "party_planning_guests";
                aiExpectedResponseType = "number";
                response = `Great, party on ${originalCommand}! How many guests are you expecting, ${userName}?`;
                requiresFollowUpInResponse = true;
            } else if (aiConversationContext === "party_planning_guests") {
                aiConversationContext = "party_planning_venue";
                aiExpectedResponseType = "text";
                response = `${originalCommand} guests, noted! Will it be at home, or should I search for venues?`;
                requiresFollowUpInResponse = true;
            } else if (aiConversationContext === "party_planning_venue") {
                aiConversationContext = null;
                aiExpectedResponseType = null;
                if (command.includes("search") || command.includes("venue")) {
                     setActiveScreen('explore');
                     setTimeout(() => {
                        const searchInput = document.getElementById('exploreSearchInput');
                        if (searchInput) searchInput.value = "party venue";
                        filterPlaces('services', document.querySelector('#exploreFilterBar button[data-filter="services"]'));
                        handleExploreSearch(true);
                    }, 100);
                    response = "Okay, searching for party venues in Explore. Let me know what else for the party!";
                } else {
                    response = "Sounds good. We can look into food and themes next for your party at home!";
                }
            } else if (aiConversationContext === "plan_route_place1") {
                const place1Name = originalCommand;
                const place1 = mockPlaces.all.find(p => p.name.toLowerCase().includes(place1Name.toLowerCase()));
                if (place1) {
                    aiConversationContext = { state: "plan_route_place2", place1: place1.name };
                    aiExpectedResponseType = "text";
                    response = `Okay, starting route from "${place1.name}". What's the destination?`;
                    requiresFollowUpInResponse = true;
                } else {
                    response = `I couldn't find a place called "${place1Name}". Please try again with a known place name.`;
                    aiConversationContext = "plan_route_place1";
                    requiresFollowUpInResponse = true;
                }
            } else if (aiConversationContext && aiConversationContext.state === "plan_route_place2") {
                const place2Name = originalCommand;
                const place2 = mockPlaces.all.find(p => p.name.toLowerCase().includes(place2Name.toLowerCase()));
                if (place2) {
                    const fromPlaceName = aiConversationContext.place1;
                    aiConversationContext = null; aiExpectedResponseType = null;
                    response = `Planning route from "${fromPlaceName}" to "${place2.name}"... This opens a native map app with directions.`;
                    setActiveScreen('explore');
                    getDirections(place2.name, fromPlaceName);
                } else {
                    response = `I couldn't find a place called "${place2Name}". What's the destination from "${aiConversationContext.place1}"?`;
                    requiresFollowUpInResponse = true;
                }
            } else {
                aiConversationContext = null; aiExpectedResponseType = null;
                response = "Sorry, I lost the thread of our conversation. Let's start over. How can I help?";
            }
            addMessageToAIChat('other', aiPrefix + response, isHTMLResponse);
            if (!requiresFollowUpInResponse) {
                aiConversationContext = null;
                aiExpectedResponseType = null;
            }
            return;
        }
        aiConversationContext = null; aiExpectedResponseType = null;
        setTimeout(() => {
            if (command.startsWith("add task ")) {
                const taskDetails = originalCommand.substring(9).trim(); 
                if(taskDetails) {
                    let taskTitle = taskDetails;
                    let taskTime, taskDate, parsedAIAgain = {};
                    const timeMatch = taskDetails.match(/at\s+(\d{1,2}(:\d{2})?\s*(am|pm)?)/i);
                    if (timeMatch && timeMatch[0]) {
                        taskTime = timeMatch[0].trim().toUpperCase();
                        taskTitle = taskTitle.replace(timeMatch[0], '').trim(); 
                        parsedAIAgain.time = taskTime;
                    }
                    const dateMatch = taskDetails.match(/on\s+(monday|tuesday|wednesday|thursday|friday|saturday|sunday|today|tomorrow|\d{1,2}[\/-]\d{1,2}(?:[\/-]\d{2,4})?)/i);
                     if(dateMatch && dateMatch[0]) {
                        taskDate = dateMatch[0].trim();
                        taskTitle = taskTitle.replace(dateMatch[0], '').trim(); 
                        parsedAIAgain.date = taskDate;
                    }
                     const locationMatch = taskTitle.match(/(?:at|in|from)\s+([A-Z][a-zA-Z\s]+(?:Cafe|Park|Store|Cleaners|Market|Library|Office|Hub|Center|Plaza|Square))/);
                    if (locationMatch && locationMatch[1]) {
                        parsedAIAgain.location = locationMatch[1].trim();
                    }
                    const personMatch = taskTitle.match(/(?:with|for|call|meet)\s+([A-Z][a-z]+(?:\s+[A-Z][a-z]+)?)/);
                    if (personMatch && personMatch[1] && !taskCategories.includes(personMatch[1].toLowerCase())) {
                        parsedAIAgain.person = personMatch[1].trim();
                    }
                    if (addNewTask(taskTitle, null, taskTime, taskDate, parsedAIAgain)) response = `Okay, I've added "${taskTitle}" ${taskTime ? 'at '+taskTime : ''} ${taskDate ? 'on '+taskDate : ''} to your planner and synced it with your device calendar.`;
                    else response = "Hmm, I couldn't add that task. Maybe try again with just the title?";
                } else {
                    response = "What task would you like to add? Example: 'add task Call Gogo at 2pm on Tuesday'";
                }
            } else if (command.startsWith("clear completed tasks")) {
                const completedCount = tasks.filter(t => t.completed).length;
                if (completedCount > 0) {
                    tasks = tasks.filter(t => !t.completed);
                    renderTasks();
                    response = `Alright, I've cleared ${completedCount} completed task${completedCount > 1 ? 's' : ''}.`;
                } else {
                    response = "No completed tasks to clear right now.";
                }
            } else if (command.includes("top 3 tasks") || command.includes("my top tasks")) {
                const topTasks = tasks.filter(t => !t.completed).slice(0, 3);
                if (topTasks.length > 0) {
                    isHTMLResponse = true;
                    response = `${contextMessage}Here are your top tasks, ${userName}:<ul>`;
                    topTasks.forEach(t => response += `<li>${t.title} (${t.time || 'anytime'}) ${t.dueDate ? '(Due: '+t.dueDate+')':''}</li>`);
                    response += "</ul>";
                } else {
                    response = `${contextMessage}Looks like you're all caught up on tasks!`;
                }
            } else if (command.includes("what's my next task") && currentScreenId === 'planner') {
                const nextTask = tasks.find(t => !t.completed);
                if (nextTask) response = `${contextMessage}Your next task is: "${nextTask.title}" at ${nextTask.time || 'anytime'}.`;
                else response = `${contextMessage}You have no upcoming tasks!`;
            } else if (command.includes("log") && command.includes("water") && currentScreenId === 'wellness') {
                const waterAmountMatch = command.match(/log\s+(\d+)\s+glass(es)?\s+of\s+water/i);
                const waterHabit = habits.find(h => h.isWaterTracker);
                if(waterAmountMatch && waterAmountMatch[1] && waterHabit){
                    const amount = parseInt(waterAmountMatch[1]);
                    incrementWater(waterHabit.id, amount);
                    response = `${contextMessage}Logged ${amount} glass(es) of water. Your total is now ${waterHabit.current}/${waterHabit.goal}.`;
                } else {
                    response = `${contextMessage}How many glasses of water would you like to log? e.g., "log 2 glasses of water"`;
                }
            } else if (command.startsWith("plan my day") || command.startsWith("create an itinerary")) {
                 if (userSubscriptionTier !== 'pro_plus') {
                    response = `Itinerary planning is a Pro+ feature. Would you like to view subscription options?`;
                    aiConversationContext = "prompt_subscription";
                    requiresFollowUpInResponse = true;
                } else {
                    const coffeePlace = mockPlaces.food.find(p => p.name.toLowerCase().includes("vickery"));
                    const naturePlace = mockPlaces.parks.find(p => p.name.toLowerCase().includes("mlilwane"));
                    const lunchPlace = mockPlaces.food.find(p => p.name.toLowerCase().includes("malandela"));
                    const eventPlace = mockPlaces.events.find(p => p.name.toLowerCase().includes("bushfire"));
                    isHTMLResponse = true;
                    response = `${contextMessage}Okay, ${userName}, here's a plan for a day out in Eswatini:<ul>`;
                    if(coffeePlace) response += `<li>Morning: Start with coffee at <strong>${coffeePlace.name}</strong>. <button class="button-secondary" style="font-size:0.7rem;padding:2px 4px;" onclick="addNewTask('Coffee at ${coffeePlace.name}', 'personal', 'Morning')">Add to Planner</button></li>`;
                    if(naturePlace) response += `<li>Mid-morning: A relaxing walk in <strong>${naturePlace.name}</strong>. <button class="button-secondary" style="font-size:0.7rem;padding:2px 4px;" onclick="addNewTask('Walk in ${naturePlace.name}', 'health', 'Mid-morning')">Add to Planner</button></li>`;
                    if(lunchPlace) response += `<li>Lunch: Grab a bite at <strong>${lunchPlace.name}</strong>. <button class="button-secondary" style="font-size:0.7rem;padding:2px 4px;" onclick="addNewTask('Lunch at ${lunchPlace.name}', 'personal', 'Lunchtime')">Add to Planner</button></li>`;
                    if(eventPlace) response += `<li>Afternoon: Check for tickets for <strong>${eventPlace.name}</strong>. <button class="button-secondary" style="font-size:0.7rem;padding:2px 4px;" onclick="addNewTask('Buy tickets for ${eventPlace.name}', 'personal', 'Afternoon')">Add to Planner</button></li>`;
                    response += `</ul><p>Would you like me to search for any of these in Explore?</p>`;
                    requiresFollowUpInResponse = true;
                }
            } else if (command.startsWith("summarize channel") || command.startsWith("catch me up on")) {
                 const channelNameMatch = command.match(/(summarize channel|catch me up on)\s+"?([^"]+)"?/i);
                 const channelName = channelNameMatch ? channelNameMatch[2].trim() : "";
                 const channel = mockChannels.find(c => c.name.toLowerCase().includes(channelName.toLowerCase()));
                 if (channel && channel.messages && channel.messages.length > 0) {
                    isHTMLResponse = true;
                    response = `Here's a quick summary for "${channel.name}":<ul>`;
                    channel.messages.slice(-Math.min(3, channel.messages.length)).forEach(msg => {
                        let senderDetails = mockUsers[msg.senderId] || mockUsers.defaultBot;
                        response += `<li><strong>${senderDetails.name}:</strong> ${msg.text.substring(0,40)}...</li>`;
                    });
                    response += "</ul><p><em>This is a brief summary. Full history in the channel.</em></p>";
                } else if (channel) {
                    response = `The channel "${channel.name}" doesn't have much activity to summarize yet.`;
                } else {
                    response = `I couldn't find a channel named "${channelName}" to summarize.`;
                }
            } else if (command.startsWith("plan my party")) {
                isHTMLResponse = true;
                response = `${contextMessage}Okay, ${userName}, let's plan your party! Here are some steps we can take:
                    <ul>
                        <li><strong>Set Date & Time:</strong> When do you want the party?</li>
                        <li><strong>Guest List:</strong> Who are you inviting? (Rough number)</li>
                        <li><strong>Venue:</strong> At home, or need to find a place? I can search Explore for venues.</li>
                        <li><strong>Food & Drinks:</strong> Catering, potluck, or DIY? I can look for deals on supplies or restaurants.</li>
                        <li><strong>Theme/Decorations:</strong> Any specific theme?</li>
                        <li><strong>Activities/Entertainment:</strong> Music, games, etc.?</li>
                    </ul>
                    <p>Let's start with the <strong>date and time</strong> for your party. What did you have in mind?</p>`;
                aiConversationContext = "party_planning_date";
                aiExpectedResponseType = "date_time_text";
                requiresFollowUpInResponse = true;
            } else if (command.startsWith("plan a route")) {
                response = "Sure, I can help with that. What's the starting point for your route?";
                aiConversationContext = "plan_route_place1";
                aiExpectedResponseType = "text";
                requiresFollowUpInResponse = true;
            } else if (command.startsWith("global search")) {
                const searchTerm = originalCommand.substring(13).trim();
                if(searchTerm){
                    isHTMLResponse = true;
                    response = `Global Search for "${searchTerm}":<ul>`;
                    tasks.filter(t => t.title.toLowerCase().includes(searchTerm)).forEach(t => response += `<li>Task: ${t.title.substring(0,30)}...</li>`);
                    mockPlaces.all.filter(p => p.name.toLowerCase().includes(searchTerm) || (p.tags && p.tags.includes(searchTerm))).forEach(p => response += `<li>Place: ${p.name.substring(0,30)}...</li>`);
                    mockDeals.filter(d => d.title.toLowerCase().includes(searchTerm) || d.businessName.toLowerCase().includes(searchTerm)).forEach(d => response += `<li>Deal: ${d.title.substring(0,30)}...</li>`);
                    mockChannels.filter(c => c.name.toLowerCase().includes(searchTerm)).forEach(c => response += `<li>Channel: ${c.name.substring(0,30)}...</li>`);
                    response += `</ul><p><em>Clicking these would navigate to the item.</em></p>`;
                } else {
                    response = "What would you like to search for globally?";
                }
            }
            else if (command.includes("hello") || command.includes("hi") || command.includes("hey")) {
                response = currentAiPersonality === 'witty' ? "Well, hello there. What marvels shall we NOT accomplish today?" : `Sanibonani, ${userName}! How can I assist you today?`;
            } else if (command.includes("time")) {
                response = `The current time is ${new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })}.`;
            } else if (command.includes("date")) {
                response = `Today's date is ${new Date().toLocaleDateString([], { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' })}.`;
            } else if (command.includes("weather")) {
                const weatherTextEl = document.getElementById('currentWeather');
                response = `Currently, it's ${weatherTextEl ? weatherTextEl.textContent : "lovely outside"}.`;
            } else if (command.includes("what's on my dashboard") || command.includes("dashboard summary")) {
                const upcomingTasks = tasks.filter(t => !t.completed).slice(0, 2);
                const pulseItems = Array.from(document.querySelectorAll('.nearby-pulse-carousel .story-label')).slice(0, 2).map(el => el.textContent);
                isHTMLResponse = true;
                response = "On your dashboard:<br>";
                if (upcomingTasks.length > 0) response += `Top tasks: ${upcomingTasks.map(t=>t.title.substring(0,20)+"...").join(', ')}.<br>`;
                else response += "No pressing tasks visible on dashboard.<br>";
                if (pulseItems.length > 0) response += `Nearby Pulse: ${pulseItems.join(' & ')}.<br>`;
                response += `Weather: ${document.getElementById('currentWeather')?.textContent || 'N/A'}.<br>`;
                response += `<em>This is a brief summary.</em>`;
            } else if (command.includes("summarize my day") || command.includes("what's my day look like")) {
                const incompleteTasks = tasks.filter(t => !t.completed);
                isHTMLResponse = true;
                if (incompleteTasks.length > 0) {
                    response = `You have ${incompleteTasks.length} task${incompleteTasks.length > 1 ? 's' : ''} remaining, ${userName}. Key ones:<ul>`;
                    incompleteTasks.slice(0,3).forEach(t => response += `<li>${t.title}</li>`);
                    response += "</ul>";
                } else {
                    response = "All tasks completed! Great job!";
                }
                response += `<br>Current weather: ${document.getElementById('currentWeather')?.textContent || 'N/A'}.`;
            } else if (command.includes("event") || command.includes("happening")) {
                const upcomingEvents = mockPlaces.events.slice(0,2).map(e => e.name).join(' and ');
                response = upcomingEvents ? `Some upcoming events are: ${upcomingEvents}. Interested? I can show you the Explore tab.` : "I don't see any major events right now. Check the Explore tab for more!";
            } else if (command.includes("what's good for") && command.includes("?")){
                const forWhomMatch = command.match(/what's good for\s+([^?]+)\??/i);
                const forWhom = forWhomMatch ? forWhomMatch[1].trim() : "";
                if (forWhom === "kids" || forWhom === "children" || forWhom === "family") {
                    const kidFriendlyPlaces = mockPlaces.all.filter(p => p.tags && p.tags.includes("family"));
                    if (kidFriendlyPlaces.length > 0) {
                        isHTMLResponse = true;
                        response = `For ${forWhom}, I'd suggest:<ul>`;
                        kidFriendlyPlaces.slice(0,3).forEach(p => response += `<li>${p.name} (${p.type})</li>`);
                        response += `</ul><p>You can search for "family" in Explore for more.</p>`;
                    } else {
                        response = `I don't have specific "family" tagged places right now, but you could try searching for "parks" or "playgrounds" in Explore.`;
                    }
                } else {
                     response = `I can try to find places for "${forWhom}". What type of place are you looking for (e.g., food, park, activity)?`;
                }
            }
            else if (command.includes("deal on") || command.includes("offer on") || command.includes("deals for") || command.includes("offers for")) {
                
                const dealQueryMatch = command.match(/(deal|offer)s?\s+(on|for)\s+(.+)/i);
                const dealQuery = dealQueryMatch ? dealQueryMatch[3].trim() : "";
                const filteredDeals = mockDeals.filter(d => d.title.toLowerCase().includes(dealQuery) || d.category.toLowerCase().includes(dealQuery) || d.businessName.toLowerCase().includes(dealQuery));
                if (filteredDeals.length > 0) {
                    isHTMLResponse = true;
                    response = `Found these deals for "${dealQuery}":<ul>`;
                    filteredDeals.slice(0,3).forEach(d => response += `<li>${d.title} at ${d.businessName}</li>`);
                    response += `</ul>Would you like to search for "${dealQuery}" in Explore Deals?`;
                    requiresFollowUpInResponse = true; 
                } else {
                    response = `Sorry, I couldn't find specific deals for "${dealQuery}". You can browse all deals in Explore.`;
                }
            } else if (command.includes("show ") || command.includes("open ")) {
                const target = command.replace("show ", "").replace("open ", "");
                const screenMap = { "dashboard": "dashboard", "home": "dashboard", "planner": "planner", "schedule": "planner", "explore": "explore", "map": "explore", "chat": "chat", "community": "chat", "wellness": "wellness", "hub": "wellness", "settings": "settings", "config": "settings", "services": "servicesMarket", "governance": "governance", "app store": "appStore", "applets": "appStore", "privacy": "privacyDashboard" };
                const targetScreen = screenMap[target];
                if (targetScreen) {
                    setActiveScreen(targetScreen);
                    if (targetScreen === 'explore' && (target.includes("deals") || target.includes("offers"))) {
                       setTimeout(() => {
                           const dealFilterButton = document.querySelector('#exploreFilterBar button[data-filter="deals"]');
                           if (dealFilterButton) filterPlaces('deals', dealFilterButton);
                       }, 50);
                    }
                    if (aiBottomSheet.classList.contains('active')) toggleAIChat(); 
                    showToast(`AI: Navigated to ${targetScreen.charAt(0).toUpperCase() + targetScreen.slice(1)}`, "ai_info", 1500); return; 
                } else if (target.includes("create task") || target.includes("new task")) {
                    setActiveScreen('planner');
                    setTimeout(() => newTaskInputEl?.focus(), 100);
                    if (aiBottomSheet.classList.contains('active')) toggleAIChat();
                    response = "Switched to Planner. You can add a new task there.";
                } else if (target.includes("journal")) {
                     openJournalModal();
                     if (aiBottomSheet.classList.contains('active')) toggleAIChat();
                     response = "Opened your journal.";
                }
                else {
                    response = `I can't directly open or show "${target}". Try a screen name like 'planner' or 'explore'.`;
                }
            } else if (command.includes("how am i doing") || command.includes("wellness check")) {
                response = "Based on data, you're doing okay! For a more detailed summary, you can check the Wellness Hub. Would you like to see the AI Wellness Summary?";
            } else if (command.startsWith("find ") || command.startsWith("search for ")) {
                const query = originalCommand.replace(/find|search for/i, '').trim();
                if (query) {
                    let targetFilter = 'all'; 
                    let searchInputContent = query;
                    if (query.toLowerCase().includes("deal") || query.toLowerCase().includes("offer")) {
                        targetFilter = 'deals';
                        searchInputContent = query.replace(/deals?|offers?/gi, '').trim();
                        if (!searchInputContent && query.toLowerCase().includes("food")) searchInputContent = "food"; 
                        else if (!searchInputContent && query.toLowerCase().includes("service")) searchInputContent = "services";
                    } else if (query.toLowerCase().includes("food") || query.toLowerCase().includes("restaurant")) targetFilter = 'food';
                    else if (query.toLowerCase().includes("park")) targetFilter = 'parks';
                    response = `${contextMessage}Sure, opening Explore and searching for "${searchInputContent}" under the "${targetFilter}" filter.`;
                    setActiveScreen('explore');
                    setTimeout(() => {
                        const searchInput = document.getElementById('exploreSearchInput');
                        if (searchInput) {
                            searchInput.value = searchInputContent; 
                            document.getElementById('clearExploreSearchInput')?.classList.remove('hidden');
                        }
                        const filterButton = document.querySelector(`#exploreFilterBar button[data-filter="${targetFilter}"]`);
                        if (filterButton) filterPlaces(targetFilter, filterButton);
                        else renderPlaces(targetFilter); 
                        handleExploreSearch(true); 
                    }, 100); 
                    if (aiBottomSheet.classList.contains('active')) toggleAIChat();
                    showToast(`AI: Searching for "${searchInputContent}" in Explore.`, "ai_info", 2000); return;
                } else {
                    response = "What would you like me to find? e.g., 'find cafes' or 'find food deals'";
                }
            } else if (command.includes("schedule for tomorrow") || command.includes("tomorrow's tasks")) {
                const tomorrowsTasks = tasks.filter(t => t.dueDate === new Date(Date.now() + 86400000).toISOString().split('T')[0] && !t.completed);
                if(tomorrowsTasks.length > 0){
                    isHTMLResponse = true;
                    response = `For tomorrow, ${userName}, you have:<ul>${tomorrowsTasks.map(t => `<li>${t.title} (${t.time || 'anytime'})</li>`).join('')}</ul>`;
                } else {
                    response = "Looks like your schedule for tomorrow is clear so far!";
                }
            } else if (command.startsWith("set reminder") || command.startsWith("remind me to")) {
                const reminderText = originalCommand.replace(/set reminder|remind me to/i, '').trim();
                if (reminderText) {
                    response = `Okay, I've set a reminder for: "${reminderText}". This will use your device's native notification system.`;
                } else {
                    response = "What would you like me to remind you about?";
                }
            } else if (command.startsWith("create channel")) {
                const channelNameMatch = originalCommand.match(/create channel\s+"?([^"]+)"?/i);
                const channelName = channelNameMatch ? channelNameMatch[1].trim() : "";
                if (channelName) {
                    setActiveScreen('chat');
                    openCreateChannelModal(channelName);
                    response = `Okay, I've opened the 'Create Channel' form with the name "${channelName}". Please select an icon and type.`;
                } else {
                    response = "What name would you like for the new channel? e.g., 'create channel My Hobby Group'";
                }
            } else if (command.startsWith("log mood")) {
                const moodMatch = command.match(/log mood\s+(happy|sad|neutral|excited|relaxed|||||||)/i);
                const noteMatch = command.match(/with note\s+(.+)/i);
                const note = noteMatch ? noteMatch[1].trim() : "";
                if (moodMatch && moodMatch[1]) {
                    const moodSymbol = { happy: '', sad: '', neutral: '', excited: '', relaxed: '' }[moodMatch[1].toLowerCase()] || moodMatch[1];
                    const moodButton = document.querySelector(`.mood-emoji-button[data-mood="${moodSymbol}"]`);
                    if (moodButton) {
                        selectMood(moodButton);
                        if(logMood(moodSymbol, note)){
                            response = `Mood logged as ${moodSymbol}${note ? ' with note.' : ''}. Anything else?`;
                        } else {
                            response = `Could not log mood ${moodSymbol}. Try again.`;
                        }
                    } else {
                        response = `Sorry, I couldn't find an emoji for "${moodMatch[1]}". Try , , , etc.`;
                    }
                } else {
                    response = "How are you feeling? e.g., 'log mood happy' or 'log mood  with note feeling tired'";
                }
            } else if (command.startsWith("how am i doing with") && command.includes("habit")) {
                const habitNameMatch = command.match(/how am i doing with\s+"?([^"]+)"?\s+habit/i);
                const habitName = habitNameMatch ? habitNameMatch[1].trim() : "";
                const habit = habits.find(h => h.name.toLowerCase().includes(habitName.toLowerCase()));
                if (habit) {
                    response = `For your "${habit.name}" habit: You're at ${habit.current}/${habit.goal} ${habit.unit || ''} with a streak of ${habit.streak} day(s).`;
                } else {
                    response = `I couldn't find a habit called "${habitName}".`;
                }
            } else if (command.startsWith("set habit") || command.startsWith("create habit")) {
                 const habitDetailsMatch = originalCommand.match(/(set|create) habit\s+"?([^"]+)"?\s+for\s+(\d+)\s*([a-zA-Z]*)/i);
                 if (habitDetailsMatch) {
                    const habitName = habitDetailsMatch[2].trim();
                    const goal = parseInt(habitDetailsMatch[3]);
                    const unit = habitDetailsMatch[4].trim();
                    setActiveScreen('wellness');
                    openCreateHabitModal(habitName, goal, unit); 
                    response = `Okay, opening the habit creation form for "${habitName}" with goal ${goal} ${unit}. Please select an icon and color.`;
                 } else {
                    response = "To set a habit, try: 'set habit \"Drink Water\" for 8 glasses'";
                 }
            } else if (command.startsWith("analyze my last journal entry") && currentScreenId === 'wellness') {
                const journalEntries = loggedMoods.filter(m => m.type === 'journal');
                if (journalEntries.length > 0) {
                    const lastEntry = journalEntries[journalEntries.length - 1];
                    isHTMLResponse = true;
                    response = `Analyzing your last journal entry ("${lastEntry.note.substring(0,20)}..."):<br> `;
                    if (lastEntry.note.toLowerCase().includes("happy") || lastEntry.note.toLowerCase().includes("great")) response += "It seems you had a positive experience! ";
                    if (lastEntry.note.toLowerCase().includes("challenge") || lastEntry.note.toLowerCase().includes("difficult")) response += "It sounds like you overcame something. ";
                    if (lastEntry.note.toLowerCase().includes("learn") || lastEntry.note.toLowerCase().includes("discovered")) response += "Glad to see you're learning! ";
                    response += "Reflecting on entries can provide good insights. Keep it up!";
                } else {
                    response = "You don't have any journal entries yet for me to analyze.";
                }
            } else if (command.startsWith("find services for")) {
                const serviceTypeMatch = command.match(/find services for\s+(.+)/i);
                const serviceType = serviceTypeMatch ? serviceTypeMatch[1].trim() : "";
                if (serviceType) {
                    setActiveScreen('servicesMarket');
                    response = `Okay, I'm searching the Local Services Marketplace for "${serviceType}".`;
                } else {
                    response = "What kind of service are you looking for? e.g., 'find services for plumbing'";
                }
            }
            else if (command.includes("latest in") && command.includes("channel")) {
                const channelNameMatch = command.match(/latest in\s+"?([^"]+)"?\s+channel/i);
                const channelName = channelNameMatch ? channelNameMatch[1].trim() : "";
                const channel = mockChannels.find(c => c.name.toLowerCase().includes(channelName.toLowerCase()));
                if (channel && channel.messages && channel.messages.length > 0) {
                    isHTMLResponse = true;
                    response = `Latest in "${channel.name}":<ul>`;
                    channel.messages.slice(-2).forEach(msg => {
                        const senderDetails = mockUsers[msg.senderId] || mockUsers.defaultBot;
                        response += `<li><strong>${senderDetails.name}</strong>: ${msg.text.substring(0,30)}...</li>`
                    });
                    response += "</ul>";
                } else if (channel) {
                    response = `The channel "${channel.name}" has no messages yet.`;
                } else {
                    response = `I couldn't find a channel called "${channelName}".`;
                }
            } else if (command.includes("is") && command.includes("open") && command.includes("?")) {
                const placeNameMatch = command.match(/is\s+"?([^"]+)"?\s+open/i);
                const placeName = placeNameMatch ? placeNameMatch[1].trim() : "";
                const place = mockPlaces.all.find(p => p.name.toLowerCase().includes(placeName.toLowerCase()));
                if (place) {
                    response = `${place.name} is ${place.openNow ? 'currently open.' : 'currently closed.'} ${place.sub || ''}`;
                } else {
                    response = `I don't have information on "${placeName}". Try searching in Explore.`;
                }
            } else if (command.includes("what's the emergency number") || command.includes("emergency call")) {
                response = "In an emergency, please dial 999. You can also use the Emergency Dashboard from the home screen for more tools.";
            } else if (command.includes("how to submit a deal") || command.includes("submit offer")) {
                response = "You can submit a deal or offer by going to the 'Explore' screen and tapping the 'Submit a Deal' button at the bottom. I can take you there if you like.";
            } else if (command.includes("how to submit a tip") || command.includes("community tip")) {
                response = "To submit a community tip, go to the 'Explore' screen and tap the 'Add a Place/Tip' button. I can navigate there for you.";
            } else if (command.includes("who is shamase")) {
                response = currentAiPersonality === 'witty' ? "Shamase? Sounds like someone important. Or maybe just the person testing me. You tell me." : `Shamase is the user of this LocalLife OS concept! That's you, ${userName}, right?`;
            } else if (command.includes("tell me a joke") || command.includes("joke")) {
                const jokes = [
                    "Why don't scientists trust atoms? Because they make up everything!",
                    "Why did the scarecrow win an award? Because he was outstanding in his field!",
                    "Why don't eggs tell jokes? They'd crack each other up!",
                    "I told my wife she was drawing her eyebrows too high. She seemed surprised."
                ];
                response = jokes[Math.floor(Math.random() * jokes.length)];
            } else if (command.includes("give me a quote") || command.includes("quote")) {
                 const quotes = [
                    "The only way to do great work is to love what you do. - Steve Jobs",
                    "The purpose of our lives is to be happy. - Dalai Lama",
                    "Get busy living or get busy dying. - Stephen King",
                    "You only live once, but if you do it right, once is enough. - Mae West"
                ];
                response = quotes[Math.floor(Math.random() * quotes.length)];
            } else if (command.includes("relax") || command.includes("stressed") || command.includes("calm down")) {
                response = `I understand, ${userName}. How about some deep breaths? You can also try the Journaling feature in the Wellness Hub for reflection. Or I can use the device's voice to guide you.`;
            } else if (command.includes("help") || command.includes("what can you do")) {
                isHTMLResponse = true;
                response = `${contextMessage}I can help you with various tasks, ${userName}! Try things like:
                    <ul>
                         <li>General: "hello", "time", "date", "weather", "tell me a joke", "global search [term]"</li>
                        <li>Planner: "add task Go to gym at 6pm on Friday", "clear completed tasks", "top 3 tasks", "what's my next task?" (when on planner)</li>
                        <li>Navigation: "show planner", "open explore deals", "go to settings"</li>
                        <li>Explore: "find pizza places", "search for parks", "any food deals?", "is The Gables open?", "plan a day for me", "plan a route", "what's good for kids?"</li>
                        <li>Chat: "create channel My Garden Club", "latest in Mbabane Community Updates channel?", "summarize Eswatini Hikers channel"</li>
                        <li>Wellness: "log mood happy", "how am i doing with water habit?", "set habit Meditate for 10 minutes", "log 2 glasses of water" (when on wellness), "suggest habit for stress relief", "analyze my last journal entry"</li>
                        <li>App Info: "how to submit a deal?", "what's the emergency number?"</li>
                        <li>"Clear chat"</li>
                    </ul>
                    <p class="card-subtitle" style="font-size:0.8rem">I leverage native device features like voice input, text-to-speech, camera, and calendar linking.</p>`;
            } else if (command.includes("what's the community safety alert") || command.includes("safety alert")) {
                const safetyText = document.getElementById('safetyTickerText')?.textContent;
                response = safetyText ? `Current safety alert: "${safetyText}"` : "No active safety alerts displayed right now.";
            }
            else {
                response = `${contextMessage}${currentAiPersonality === 'witty' ? "I'm not sure I understand. And frankly, at this point, I'm too afraid to ask. Try something simpler, like 'add task groceries'." : "That's an interesting command! I'm still learning. Try 'help' to see what I can do."}`;
            }
            addMessageToAIChat('other', aiPrefix + response, isHTMLResponse);
            if(requiresFollowUpInResponse || command.includes("?")) triggerFabSuggestion(false); 
            if (aiConversationContext && !requiresFollowUpInResponse) {
                 aiConversationContext = null;
                 aiExpectedResponseType = null;
            }
        }, 600 + Math.random() * 400);
    }
    const habitListContainerEl = document.getElementById('habitListContainer');
    const moodHabitTimelineEl = document.getElementById('moodHabitTimeline');
    const aiWellnessInsightEl = document.getElementById('aiWellnessInsight');
    function renderHabits() {
        if (!habitListContainerEl) { return; }
        habitListContainerEl.innerHTML = Array(3).fill(getSkeletonHabitItem()).join('');
        habitListContainerEl.setAttribute('aria-busy', 'true');
        let allHabitsDone = habits.length > 0 && habits.every(h => h.current >= h.goal);
        if(aiWellnessInsightEl && aiLearningPreferences.learnHabitTracking){
            if(allHabitsDone){
                aiWellnessInsightEl.innerHTML = `<i class="fas fa-brain"></i> AI: Amazing, ${userName}! You've completed all your habits for today!  Consider setting a new challenge or enjoying your progress.`;
                aiWellnessInsightEl.classList.remove('hidden');
            } else if (habits.some(h => h.streak > 5)) {
                const highStreakHabit = habits.find(h => h.streak > 5);
                aiWellnessInsightEl.innerHTML = `<i class="fas fa-brain"></i> AI: You're on a great ${highStreakHabit.streak}-day streak with "${highStreakHabit.name.substring(0,20)}..."! Keep up the momentum!`;
                aiWellnessInsightEl.classList.remove('hidden');
            } else if(sleepData.length > 0) {
                const lastSleep = sleepData[sleepData.length -1];
                if(lastSleep.sleep && lastSleep.sleep < 6) {
                     aiWellnessInsightEl.innerHTML = `<i class="fas fa-brain"></i> AI: I noticed you logged less than 6 hours of sleep. Prioritizing rest can boost your ability to stick to habits.`;
                     aiWellnessInsightEl.classList.remove('hidden');
                }
            }
            else {
                aiWellnessInsightEl.classList.add('hidden');
            }
        }
        setTimeout(() => {
            habitListContainerEl.innerHTML = ''; 
            if (habits.length === 0) {
                habitListContainerEl.innerHTML = `<div class="empty-state"><i class="fas fa-seedling"></i><p>No habits being tracked yet.</p><p class="card-subtitle mt-1">Add a new habit to start your wellness journey!</p></div>`;
            } else {
                habits.forEach(habit => {
                    const habitEl = document.createElement('div');
                    habitEl.className = 'habit-card';
                    habitEl.dataset.habitId = habit.id;
                    const progress = habit.goal > 0 ? habit.current / habit.goal : 0;
                    const circumference = 150.7; 
                    let extraControls = '';
                    if (habit.isWaterTracker) {
                        extraControls = `
                        <div class="water-tracker-buttons">
                            <button class="button button-secondary water-add-button" onclick="incrementWater(${habit.id}, 1)">+1 ${habit.unit || 'glass'}</button>
                            <button class="button button-secondary water-add-button" onclick="incrementWater(${habit.id}, 2)">+2 ${habit.unit || 'glass'}</button>
                        </div>`;
                    }
                    habitEl.innerHTML = `
                        <button class="progress-ring-button ${habit.current >= habit.goal ? 'completed' : ''}" onclick="toggleHabitProgress(${habit.id})" aria-label="Update progress for ${habit.name}">
                            <svg width="56" height="56" viewBox="0 0 52 52" aria-hidden="true">
                                <circle cx="26" cy="26" r="24" fill="transparent" stroke="${document.body.classList.contains('dark-mode') ? 'var(--warm-gray)' : 'var(--placeholder-bg)'}" stroke-width="4"/>
                                <circle class="progress-ring-circle" cx="26" cy="26" r="24" fill="transparent" stroke="${habit.color}" stroke-width="4" transform="rotate(-90 26 26)" style="stroke-dashoffset: ${circumference * (1 - Math.min(progress,1))};"/>
                            </svg>
                            <i class="fas fa-check completion-check" aria-hidden="true"></i>
                        </button>
                        <div class="habit-info">
                            <div class="habit-name"><i class="${habit.icon}" style="color:${habit.color}; margin-right:8px;"></i>${habit.name}</div>
                            <div class="habit-meta">
                                <span class="habit-streak"><i class="fas fa-fire"></i> ${habit.streak} day${habit.streak !== 1 ? 's' : ''}</span>
                                <span class="habit-progress-info">${habit.current}/${habit.goal} ${habit.unit || ''}</span>
                            </div>
                            ${extraControls}
                        </div>
                        <div class="habit-actions">
                            <button class="habit-action-button edit" onclick="openEditHabitModal(${habit.id})" aria-label="Edit habit: ${habit.name}"><i class="fas fa-pencil-alt"></i></button>
                            <button class="habit-action-button delete" onclick="deleteHabit(${habit.id})" aria-label="Delete habit: ${habit.name}"><i class="fas fa-times"></i></button>
                        </div>
                    `;
                    habitListContainerEl.appendChild(habitEl);
                });
            }
            habitListContainerEl.setAttribute('aria-busy', 'false');
            updateWellnessTimeline();
            renderPinnedWidgets();
            saveHabitsToLocalStorage();
        }, 500);
    }
    function openCreateHabitModal(nameFromAI = "", goalFromAI = 1, unitFromAI = "") {
        document.getElementById('editingHabitId').value = '';
        document.getElementById('newHabitName').value = nameFromAI;
        document.getElementById('newHabitGoal').value = goalFromAI;
        document.getElementById('newHabitUnit').value = unitFromAI;
        document.getElementById('submitHabitButton').textContent = 'Create Habit';
        document.getElementById('createHabitModalTitle').textContent = 'Create New Habit';
        populateIconSelector('newHabitIconSelector');
        populateColorSelector('newHabitColorSelector');
        openModal('createHabitModal');
    }
    function openEditHabitModal(habitId) {
        const habit = habits.find(h => h.id === habitId);
        if (!habit) { showToast("Error: Habit not found.", "error", 2000, true); return; }
        document.getElementById('editingHabitId').value = habit.id;
        document.getElementById('newHabitName').value = habit.name;
        document.getElementById('newHabitGoal').value = habit.goal;
        document.getElementById('newHabitUnit').value = habit.unit || '';
        document.getElementById('submitHabitButton').textContent = 'Save Changes';
        document.getElementById('createHabitModalTitle').textContent = 'Edit Habit';
        populateIconSelector('newHabitIconSelector', habit.icon);
        populateColorSelector('newHabitColorSelector', habit.color);
        openModal('createHabitModal');
    }
    function submitNewHabit(isAIInitiated = false) {
        const nameInput = document.getElementById('newHabitName');
        const goalInput = document.getElementById('newHabitGoal');
        const unitInput = document.getElementById('newHabitUnit');
        const name = nameInput.value.trim();
        const goal = parseInt(goalInput.value) || 1;
        const unit = unitInput.value.trim();
        const selectedIconEl = document.querySelector('#newHabitIconSelector .icon-option.selected');
        const selectedColorEl = document.querySelector('#newHabitColorSelector .icon-option.selected');
        const editingHabitId = parseInt(document.getElementById('editingHabitId').value);
        if (!name) { 
            if(!isAIInitiated) showToast("Habit name is required.", "error", 2000, true); nameInput.focus(); 
            return false; 
        }
        if (goal <= 0) { 
            if(!isAIInitiated) showToast("Goal must be a positive number.", "error", 2000, true); goalInput.focus(); 
            return false;
        }
        if (!selectedIconEl) { 
            if(!isAIInitiated) showToast("Please select an icon.", "error", 2000, true); 
            return false; 
        }
        if (!selectedColorEl) { 
            if(!isAIInitiated) showToast("Please select a color.", "error", 2000, true); 
            return false; 
        }
        const isWater = name.toLowerCase().includes("water") && (unit.toLowerCase().includes("glass") || unit.toLowerCase().includes("ml"));
        if (editingHabitId) { 
            const habit = habits.find(h => h.id === editingHabitId);
            if (habit) {
                habit.name = name; habit.goal = goal; habit.unit = unit;
                habit.icon = selectedIconEl.dataset.icon; habit.color = selectedColorEl.dataset.color;
                if(isWater) habit.isWaterTracker = true; else delete habit.isWaterTracker;
                showToast(`Habit "${name}" updated!`, "success", 2000);
            } else { showToast("Error updating habit.", "error", 2000, true); return false; }
        } else { 
            const newHabit = {
                id: nextHabitId++, name: name, goal: goal, current: 0, unit: unit, streak: 0,
                icon: selectedIconEl.dataset.icon, color: selectedColorEl.dataset.color
            };
            if(isWater) newHabit.isWaterTracker = true;
            habits.unshift(newHabit); 
            showToast(`Habit "${name}" created! AI will help track it.`, "ai_info", 2000);
            addXP(10, 'wellness');
        }
        renderHabits();
        if(!isAIInitiated) closeModal('createHabitModal');
        return true;
    }
    window.incrementWater = function(habitId, amount) {
        const habit = habits.find(h => h.id === habitId && h.isWaterTracker);
        if (habit) {
            habit.current += amount;
            if (habit.current >= habit.goal && (habit.current - amount < habit.goal)) { 
                 habit.streak++;
                 showToast(`Nice! "${habit.name.substring(0,20)}..." completed! Streak: ${habit.streak} days.`, "success", 2500);
                 addXP(10, 'wellness');
                 if(habit.streak % 7 === 0) unlockBadge('hydration_pro');
                 checkForWellnessPatterns();
            } else if (habit.current < habit.goal) {
                 showToast(`Progress for "${habit.name.substring(0,20)}..." updated!`, "info", 1500);
                 addXP(1, 'wellness');
            } else { 
                 showToast(`Extra water logged for "${habit.name.substring(0,20)}..."!`, "info", 1500);
            }
            if (navigator.vibrate) navigator.vibrate(10);
            renderHabits();
        }
    }
    window.toggleHabitProgress = function(habitId) {
        const habit = habits.find(h => h.id === habitId);
        if (habit) {
            if (habit.isWaterTracker) { 
                showToast("Use +1 / +2 buttons for water tracking.", "info");
                return;
            }
            if (habit.current < habit.goal) {
                habit.current++;
                if (habit.current === habit.goal) {
                     habit.streak++;
                     showToast(`Nice! "${habit.name.substring(0,20)}..." completed! Streak: ${habit.streak} days.`, "success", 2500);
                     showDynamicIslandAlert('fas fa-trophy', `Habit Complete! +10 XP`);
                     addXP(10, 'wellness');
                     checkForWellnessPatterns();
                } else {
                    showToast(`Progress for "${habit.name.substring(0,20)}..." updated!`, "info", 1500);
                }
            } else { 
                habit.current = 0; 
                showToast(`"${habit.name.substring(0,20)}..." progress reset.`, "info", 1500);
            }
            if (navigator.vibrate) navigator.vibrate(10);
            renderHabits(); 
        } else { showToast("Error: Habit not found.", "error", 2000, true); }
    }
    window.deleteHabit = function(habitId) {
        const habitIndex = habits.findIndex(h => h.id === habitId);
        if (habitIndex > -1) {
            const deletedHabitName = habits[habitIndex].name;
            habits.splice(habitIndex, 1);
            renderHabits();
            showToast(`Habit "${deletedHabitName.substring(0,20)}..." deleted.`, "info", 1500);
        } else { showToast("Error: Habit not found for deletion.", "error", 2000, true);}
    }
    let selectedMoodValue = null;
    const moodNoteInputEl = document.getElementById('moodNoteInput');
    const journalInputEl = document.getElementById('journalInput');
    window.selectMood = function(moodElement) {
        document.querySelectorAll('#moodSelector .mood-emoji-button.selected').forEach(el => {
            el.classList.remove('selected'); el.setAttribute('aria-pressed', 'false');
        });
        moodElement.classList.add('selected'); moodElement.setAttribute('aria-pressed', 'true');
        selectedMoodValue = moodElement.dataset.mood;
        if (navigator.vibrate) navigator.vibrate(10);
    }
    window.logMood = function(moodFromAI = null, noteFromAI = "") {
        const moodToLog = moodFromAI || selectedMoodValue;
        const noteToLog = noteFromAI || (moodNoteInputEl ? moodNoteInputEl.value.trim() : "");
        if (!moodToLog) { 
            if(!moodFromAI) showToast("Please select a mood first.", "error", 2000, true); 
            return false;
        }
        loggedMoods.push({ id: Date.now(), mood: moodToLog, note: noteToLog, timestamp: new Date(), type: 'mood' });
        showToast(`Mood logged: ${moodToLog} ${noteToLog ? 'with note.' : ''} AI will analyze this.`, "success", 2000);
        addXP(5, 'wellness');
        if (['', ''].includes(moodToLog) && !moodFromAI && aiLearningPreferences.learnMoodLogs) { 
             setTimeout(() => {
                openConfirmationModal(
                    "AI Wellness Copilot",
                    `<p>I see you're feeling down, ${userName}. It can be helpful to write down what's on your mind.</p><p>Would you like to open a journal entry?</p>`,
                    () => {
                        openJournalModal(null, true);
                    }
                )
             }, 1500);
        }
        if(!moodFromAI) { 
            document.querySelectorAll('#moodSelector .mood-emoji-button.selected').forEach(el => {
                el.classList.remove('selected'); el.setAttribute('aria-pressed', 'false');
            });
            if(moodNoteInputEl) moodNoteInputEl.value = '';
            selectedMoodValue = null;
        }
        updateWellnessTimeline();
        renderPinnedWidgets();
        saveLoggedMoodsToLocalStorage();
        checkForWellnessPatterns();
        return true;
    }
    function checkForWellnessPatterns() {
        const patternCard = document.getElementById('aiPatternCard');
        const patternText = document.getElementById('aiPatternText');
        if (!patternCard || !patternText || !aiLearningPreferences.learnHabitTracking || !aiLearningPreferences.learnMoodLogs) return;
        const jogHabit = habits.find(h => h.name.toLowerCase().includes("walk"));
        if (jogHabit && loggedMoods.length > 3) {
            const daysWithJog = new Set(tasks.filter(t => t.title.toLowerCase().includes("walk") && t.completed).map(t => new Date(t.timestamp || Date.now()).toDateString()));
            const positiveMoodDays = new Set(loggedMoods.filter(m => ['', '', ''].includes(m.mood)).map(m => new Date(m.timestamp).toDateString()));
            let correlationCount = 0;
            daysWithJog.forEach(day => {
                if (positiveMoodDays.has(day)) {
                    correlationCount++;
                }
            });
            if (daysWithJog.size > 1 && (correlationCount / daysWithJog.size) >= 0.75) {
                patternText.innerHTML = `On days you complete your '<strong>${jogHabit.name}</strong>' habit, you are <strong>75% more likely</strong> to log a positive mood. Keep up the great work!`;
                patternCard.style.display = 'block';
                return;
            }
        }
        if (sleepData.length > 2) {
            const lastSleep = sleepData[sleepData.length-1];
            if (lastSleep && lastSleep.sleep < 6) {
                const recentSadMood = loggedMoods.find(m => ['', ''].includes(m.mood) && new Date(m.timestamp).toDateString() === new Date(lastSleep.timestamp).toDateString());
                if (recentSadMood) {
                    patternText.innerHTML = `I noticed you logged <strong>less than 6 hours of sleep</strong> and also felt <strong>${recentSadMood.mood}</strong>. Quality sleep is key to well-being. Consider a relaxing activity before bed.`;
                    patternCard.style.display = 'block';
                    return;
                }
            }
        }
        patternCard.style.display = 'none';
    }
    window.openJournalModal = function(entry = null, fromMoodLog = false) {
        const promptTextEl = document.getElementById('journalPromptText');
        const journalInputEl = document.getElementById('journalInput');
        const modalTitleEl = document.getElementById('journalModalTitle');
        if (entry) {
            modalTitleEl.textContent = `Journal Entry - ${new Date(entry.timestamp).toLocaleDateString()}`;
            promptTextEl.textContent = `You logged this on ${new Date(entry.timestamp).toLocaleString()}`;
            journalInputEl.value = entry.note;
            journalInputEl.readOnly = true;
            document.querySelector('#journalModal .button[onclick="saveJournalEntry()"]').classList.add('hidden');
        } else {
            modalTitleEl.textContent = 'AI Reflection Prompt';
            const lastMood = fromMoodLog ? loggedMoods[loggedMoods.length-1] : null;
            let personalizedPrompt = journalPrompts[Math.floor(Math.random() * journalPrompts.length)];
            if(lastMood && lastMood.mood === '' && aiLearningPreferences.learnMoodLogs){
                personalizedPrompt = "Reflect on what's challenging right now. What's one small step you can take to feel a bit better?";
            } else if (tasks.some(t => t.completed && t.category === 'learning') && aiLearningPreferences.learnTaskPatterns) {
                personalizedPrompt = "You've been learning recently! What's the most interesting new idea you've encountered?";
            }
            promptTextEl.textContent = personalizedPrompt;
            journalInputEl.value = "";
            journalInputEl.readOnly = false;
            document.querySelector('#journalModal .button[onclick="saveJournalEntry()"]').classList.remove('hidden');
        }
        openModal('journalModal');
    }
    window.saveJournalEntry = function() {
        if (journalInputEl && journalInputEl.value.trim()=== "") {
            showToast("Please write something in your journal.", "error", 2000, true);
            if (journalInputEl) journalInputEl.focus(); return;
        }
        const entryText = journalInputEl ? journalInputEl.value : "";
        loggedMoods.push({ id: Date.now(), mood: '', note: entryText, timestamp: new Date(), type: 'journal' });
        showToast("Journal entry saved. AI will analyze this for insights.", "success", 2000);
        addXP(15, 'wellness');
        if (aiLearningPreferences.learnMoodLogs && entryText.toLowerCase().includes("excited for")) {
            const excitementMatch = entryText.toLowerCase().match(/excited for\s+([^.!]+)/);
            if (excitementMatch && excitementMatch[1]) {
                 setTimeout(() => {
                    addMessageToAIChat('other', `${getAIPersonalityPrefix()}That's great you're excited for ${excitementMatch[1]}! I can help you plan or find related local events if you'd like.`);
                    if(!aiBottomSheet.classList.contains('active')) triggerFabSuggestion();
                }, 1000);
            }
        }
        closeModal('journalModal');
        updateWellnessTimeline(); 
        saveLoggedMoodsToLocalStorage();
    }
    function openGuidedExerciseModal() {
        const modal = document.getElementById('guidedExerciseModal');
        if (modal) {
            setBreathingPace('relax');
            openModal('guidedExerciseModal');
        }
    }
    function setBreathingPace(paceName) {
        stopBreathingExercise();
        const paces = {
            relax: { name: 'relax', inhale: 4000, hold1: 4000, exhale: 6000, hold2: 1000, steps: 6 },
            focus: { name: 'focus', inhale: 4000, hold1: 1000, exhale: 4000, hold2: 1000, steps: 8 },
            calm: { name: 'calm', inhale: 5000, hold1: 0, exhale: 5000, hold2: 0, steps: 6 }
        };
        breathingPace = paces[paceName] || paces.relax;
        const dotsContainer = document.getElementById('breathingProgressDots');
        if (dotsContainer) {
            dotsContainer.innerHTML = Array(breathingPace.steps).fill('<div class="dot"></div>').join('');
        }
        showToast(`Pace set to: ${paceName.charAt(0).toUpperCase() + paceName.slice(1)}`, 'info');
    }
    function startBreathingExercise() {
        if (breathingIsActive) return;
        breathingIsActive = true;
        const circle = document.getElementById('breathing-circle');
        const glow = document.getElementById('breathing-glow');
        const instruction = document.getElementById('breathing-instruction');
        const dots = document.querySelectorAll('#breathingProgressDots .dot');
        const startButton = document.getElementById('breathingStartButton');
        if (!circle || !instruction || !dots.length) return;
        startButton.disabled = true;
        let currentStep = 0;
        let breathCount = 0;
        function runSequence() {
            if (breathCount >= breathingPace.steps) {
                stopBreathingExercise();
                addXP(15, 'wellness');
                showDynamicIslandAlert('fas fa-spa', `Breathing exercise complete!`);
                return;
            }
            dots.forEach((dot, index) => dot.classList.toggle('active', index < breathCount));
            const sequence = [
                { text: `Inhale...`, duration: breathingPace.inhale, state: 'inhale' },
                ...(breathingPace.hold1 > 0 ? [{ text: `Hold`, duration: breathingPace.hold1, state: 'inhale' }] : []),
                { text: `Exhale...`, duration: breathingPace.exhale, state: 'exhale' },
                ...(breathingPace.hold2 > 0 ? [{ text: `Hold`, duration: breathingPace.hold2, state: 'exhale' }] : [])
            ];
            const step = sequence[currentStep];
            instruction.textContent = step.text;
            circle.className = 'breathing-circle ' + step.state;
            glow.className = 'breathing-glow ' + step.state;
            [circle, glow].forEach(el => el.style.transitionDuration = `${step.duration / 1000}s`);
            breathingInterval = setTimeout(() => {
                currentStep = (currentStep + 1) % sequence.length;
                if (currentStep === 0) {
                    breathCount++;
                }
                runSequence();
            }, step.duration);
        }
        runSequence();
    }
    function stopBreathingExercise() {
        clearTimeout(breathingInterval);
        breathingIsActive = false;
        const circle = document.getElementById('breathing-circle');
        const glow = document.getElementById('breathing-glow');
        const instruction = document.getElementById('breathing-instruction');
        const startButton = document.getElementById('breathingStartButton');
        const dots = document.querySelectorAll('#breathingProgressDots .dot');
        if (circle) {
            circle.className = 'breathing-circle';
            glow.className = 'breathing-glow';
            [circle, glow].forEach(el => el.style.transitionDuration = '1s');
        }
        if (instruction) instruction.textContent = 'Ready?';
        if (startButton) startButton.disabled = false;
        dots.forEach(dot => dot.classList.remove('active'));
    }
    function logSleepAndScreenTime() {
        const sleepInput = document.getElementById('sleepHoursInput');
        const screenInput = document.getElementById('screenTimeInput');
        const sleep = parseFloat(sleepInput.value);
        const screenTime = parseFloat(screenInput.value);
        if (isNaN(sleep) && isNaN(screenTime)) {
            showToast("Please enter either sleep or screen time.", "error");
            return;
        }
        const todayDataIndex = sleepData.findIndex(d => new Date(d.timestamp).toDateString() === new Date().toDateString());
        if (todayDataIndex > -1) {
            if (!isNaN(sleep)) sleepData[todayDataIndex].sleep = sleep;
            if (!isNaN(screenTime)) sleepData[todayDataIndex].screenTime = screenTime;
        } else {
            sleepData.push({
                timestamp: new Date().toISOString(),
                sleep: !isNaN(sleep) ? sleep : null,
                screenTime: !isNaN(screenTime) ? screenTime : null,
            });
        }
        showToast("Sleep and screen data logged. AI will analyze patterns.", "success");
        sleepInput.value = '';
        screenInput.value = '';
        saveSleepDataToLocalStorage();
        checkForWellnessPatterns();
    }
    window.showAIWellnessSummaryModal = function() {
        let summaryHtml = `<p>Based on your recent activity, ${userName} (AI Analysis):</p><ul>`;
        const positiveMoods = loggedMoods.filter(m => ['', '', '', ''].includes(m.mood)).length;
        const neutralSadMoods = loggedMoods.filter(m => ['', '', ''].includes(m.mood)).length;
        if (loggedMoods.length === 0 && aiLearningPreferences.learnMoodLogs) summaryHtml += "<li>AI: No mood data logged yet to analyze. Try logging your mood daily!</li>";
        else if (positiveMoods > neutralSadMoods && aiLearningPreferences.learnMoodLogs) summaryHtml += "<li>AI: Your mood has generally been positive! Keep up the great work! </li>";
        else if (neutralSadMoods > positiveMoods && aiLearningPreferences.learnMoodLogs) summaryHtml += "<li>AI: It seems you've had some challenging days. Remember self-compassion. Consider a guided exercise.</li>";
        else if (aiLearningPreferences.learnMoodLogs) summaryHtml += "<li>AI: Your mood seems balanced. How are you feeling overall?</li>";
        const completedHabits = habits.filter(h => h.current >= h.goal);
        if(habits.length === 0 && aiLearningPreferences.learnHabitTracking) summaryHtml += "<li>AI: Start tracking habits to build positive routines!</li>";
        else if(completedHabits.length > 0 && aiLearningPreferences.learnHabitTracking) summaryHtml += `<li>AI: Fantastic effort completing ${completedHabits.length} habit${completedHabits.length > 1 ? 's' : ''} recently!</li>`; else if (aiLearningPreferences.learnHabitTracking) summaryHtml += `<li>AI: Keep working on your habits. Consistency is key!</li>`;
    const waterHabit = habits.find(h => h.isWaterTracker);
    if(waterHabit && waterHabit.current < waterHabit.goal && aiLearningPreferences.learnHabitTracking) summaryHtml += `<li>AI Reminder: Stay hydrated! You're at ${waterHabit.current}/${waterHabit.goal} ${waterHabit.unit} for water.</li>`;
    const journalEntries = loggedMoods.filter(m => m.type === 'journal').length;
    if(journalEntries > 1 && aiLearningPreferences.learnMoodLogs) summaryHtml += `<li>AI: You've made ${journalEntries} journal entries. Keep reflecting!</li>`;
    if (loggedMoods.length > 2 && habits.some(h => h.name.toLowerCase().includes("walk") && h.current >= h.goal) && aiLearningPreferences.learnMoodLogs && aiLearningPreferences.learnHabitTracking) {
         summaryHtml += `<li><strong>AI Pattern Detected:</strong> You often log positive moods on days you complete your 'Morning Walk' habit. Keep it up!</li>`;
    }
    summaryHtml += "</ul><p class='mt-2'>This is a summary. A real AI would provide more personalized insights and track trends over time.</p>";
    openGenericModal("AI Wellness Summary", summaryHtml);
}
    function updateWellnessTimeline() {
        if (!moodHabitTimelineEl) return;
        moodHabitTimelineEl.innerHTML = '';
        let items = [];
        const today = new Date().toDateString();
        loggedMoods.filter(m => new Date(m.timestamp).toDateString() === today).forEach(mood => {
            items.push({ type: 'mood', data: mood, timestamp: new Date(mood.timestamp) });
        });
        habits.filter(h => h.current >= h.goal).forEach(habit => {
            items.push({ type: 'habit', data: habit, timestamp: new Date() });
        });
        if (items.length === 0) {
            moodHabitTimelineEl.innerHTML = `<p class="card-subtitle" style="width:100%; text-align:center;">No entries yet for today, ${userName}.</p>`;
            return;
        }
        items.sort((a, b) => a.timestamp - b.timestamp).forEach(item => {
            const card = document.createElement('div');
            card.className = 'timeline-card';
            if (item.type === 'mood') {
                card.innerHTML = `<div class="icon">${item.data.mood}</div><div class="title">${item.data.type === 'journal' ? 'Journal Entry' : 'Mood Log'}</div><div class="time">${item.timestamp.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})}</div>`;
                card.onclick = () => openJournalModal(item.data);
            } else if (item.type === 'habit') {
                card.innerHTML = `<div class="icon" style="color:${item.data.color};"><i class="${item.data.icon}"></i></div><div class="title">${item.data.name.substring(0, 15)}...</div><div class="time">Completed Today</div>`;
                card.onclick = () => openEditHabitModal(item.data.id);
            }
            moodHabitTimelineEl.appendChild(card);
        });
    }
    const darkModeToggleContainer = document.getElementById('darkModeToggleContainer');
    const darkModeToggleVisual = document.getElementById('darkModeToggleVisual');
    const aiPersonalitySelect = document.getElementById('aiPersonalitySelect');
    function toggleDarkMode() { 
        document.body.classList.toggle('dark-mode');
        const isDarkMode = document.body.classList.contains('dark-mode');
        if (darkModeToggleVisual) darkModeToggleVisual.classList.toggle('active', isDarkMode);
        if (darkModeToggleContainer) darkModeToggleContainer.setAttribute('aria-checked', isDarkMode.toString());
        localStorage.setItem('darkMode', isDarkMode.toString()); 
        renderHabits(); 
        const activeScreenId = document.querySelector('.screen.active')?.id;
        if (activeScreenId === 'explore') {
            renderPlaces(document.querySelector('#exploreFilterBar .filter-button.active')?.dataset.filter || 'all');
            initMap();
        }
        if (activeScreenId === 'dashboard') {
            renderDealsOnDashboard();
            renderPinnedWidgets();
        }
        if (navigator.vibrate) navigator.vibrate(10);
    }
    function changeThemeAccent(color, buttonElement) { 
        document.documentElement.style.setProperty('--primary-accent', color);
        let darkerColor;
        try {
            let r = parseInt(color.slice(1,3), 16) - 20; let g = parseInt(color.slice(3,5), 16) - 20; let b = parseInt(color.slice(5,7), 16) - 20;
            r = Math.max(0, r).toString(16).padStart(2,'0'); g = Math.max(0, g).toString(16).padStart(2,'0'); b = Math.max(0, b).toString(16).padStart(2,'0');
            darkerColor = `#${r}${g}${b}`;
        } catch (e) { darkerColor = color; }
        document.documentElement.style.setProperty('--primary-accent-darker', darkerColor);
        document.querySelectorAll('.theme-selector .theme-color-button').forEach(btn => {
            btn.classList.remove('active'); btn.setAttribute('aria-checked', 'false');
        });
        if (buttonElement) {
            buttonElement.classList.add('active'); buttonElement.setAttribute('aria-checked', 'true');
        }
        localStorage.setItem('themeAccent', color);
        showToast("Theme accent changed.", "success", 1500);
    }
    function changeAIPersonality(personality) {
        if (personality.includes('(Pro)') && !userSubscriptionTier.startsWith('pro')) {
            showToast(`The ${personality.replace(' (Pro)', '')} personality is a Pro feature.`, "info");
            openSubscriptionModal();
            aiPersonalitySelect.value = currentAiPersonality;
            return;
        }
        currentAiPersonality = personality;
        localStorage.setItem('aiPersonality', personality);
        showToast(`AI Personality set to ${personality.replace(' (Pro)', '')}.`, "ai_info", 2000);
        addMessageToAIChat('other', `${getAIPersonalityPrefix()}${personality.replace(' (Pro)', '').charAt(0).toUpperCase() + personality.replace(' (Pro)', '').slice(1)} AI ready. ${personality === 'witty' ? 'Try not to bore me.' : 'How can I assist?'}`);
    }
    function openGenericModal(title, bodyHtml) {
        const modalTitleEl = document.getElementById('genericModalTitle');
        const modalBodyEl = document.getElementById('genericModalBody');
        if (modalTitleEl) modalTitleEl.textContent = title;
        if (modalBodyEl) modalBodyEl.innerHTML = bodyHtml;
        openModal('genericModal');
    }
    function openConfirmationModal(title, message, confirmCallback) {
        document.getElementById('confirmationModalTitle').textContent = title;
        document.getElementById('confirmationModalMessage').innerHTML = message;
        const confirmButton = document.getElementById('confirmActionButton');
        confirmButton.style.display = '';
        confirmButton.onclick = () => {
            confirmCallback();
            closeModal('confirmationModal');
        };
        openModal('confirmationModal');
    }
    function openUserProfileModal() {
        const user = mockUsers['user'];
        if(!user) return;
        const userAvatarEl = document.getElementById('userProfileAvatar');
        if(userAvatarEl) userAvatarEl.src = user.avatarUrl;
        document.getElementById('profileNameInput').value = user.name;
        document.getElementById('profileUsernameInput').value = user.username;
        document.getElementById('profileLocationInput').value = user.location || '';
        document.getElementById('profileBioInput').value = user.bio;
        document.getElementById('profileInterestsInput').value = user.interests || '';
        updateGamificationUI('user');
        openModal('userProfileModal');
    }
    function saveUserProfile() {
        if(!mockUsers['user']) return;
        const newName = document.getElementById('profileNameInput').value;
        const newUsername = document.getElementById('profileUsernameInput').value;
        const newBio = document.getElementById('profileBioInput').value;
        const newLocation = document.getElementById('profileLocationInput').value;
        const newInterests = document.getElementById('profileInterestsInput').value;
        userName = newName.split(' ')[0];
        mockUsers['user'].name = newName;
        mockUsers['user'].username = newUsername;
        mockUsers['user'].bio = newBio;
        mockUsers['user'].location = newLocation;
        mockUsers['user'].interests = newInterests;
        const aiGreetingEl = document.getElementById('aiGreeting');
        if(aiGreetingEl) {
             const currentGreeting = aiGreetingEl.textContent;
             const namePart = currentGreeting.substring(currentGreeting.indexOf(',') + 2, currentGreeting.lastIndexOf('!'));
             aiGreetingEl.textContent = currentGreeting.replace(namePart, userName);
        }
        saveUsersToLocalStorage(); 
        showToast("Profile saved. AI can use this for better personalization.", "success");
        closeModal('userProfileModal');
    }
    function openDashboardCustomizationModal() {
        const container = document.getElementById('dashboardCardToggleContainer');
        if(!container) return;
        container.innerHTML = '';
        const savedConfig = JSON.parse(localStorage.getItem('dashboardCardConfig')) || dashboardCardConfig;
        dashboardCardConfig.forEach(defaultCard => {
            const currentCardState = savedConfig.find(sc => sc.id === defaultCard.id) || defaultCard;
            const itemDiv = document.createElement('div');
            itemDiv.className= 'setting-item';
            const isDisabled = defaultCard.id === 'newsSummaryCard' && !userSubscriptionTier.startsWith('pro');
            itemDiv.innerHTML = `
                <span class="setting-label ${isDisabled ? 'text-secondary' : ''}">${currentCardState.name} ${isDisabled ? '(Pro)' : ''}</span>
                <button class="toggle-switch-button" data-card-id="${currentCardState.id}" ${isDisabled ? 'disabled' : ''} onclick="this.firstChild.classList.toggle('active')" role="switch" aria-checked="${currentCardState.visible}">
                    <span class="toggle-switch ${currentCardState.visible ? 'active' : ''}"></span>
                </button>
            `;
            container.appendChild(itemDiv);
        });
        openModal('dashboardCustomizationModal');
    }
    function saveDashboardCustomization() {
        const toggles = document.querySelectorAll('#dashboardCardToggleContainer .toggle-switch-button');
        let newConfig = [];
        toggles.forEach(toggleButton => {
            const cardId = toggleButton.dataset.cardId;
            const cardData = dashboardCardConfig.find(c => c.id === cardId);
            if(cardData) {
                const isVisible = toggleButton.querySelector('.toggle-switch')?.classList.contains('active') ?? false;
                newConfig.push({ id: cardId, name: cardData.name, visible: isVisible });
            }
        });
        dashboardCardConfig = newConfig;
        localStorage.setItem('dashboardCardConfig', JSON.stringify(newConfig));
        applyDashboardCustomization(newConfig);
        showToast("Dashboard customization saved. AI will adapt.", "success");
        closeModal('dashboardCustomizationModal');
    }
    function applyDashboardCustomization(configToApply) {
        const currentConfig = configToApply || JSON.parse(localStorage.getItem('dashboardCardConfig')) || dashboardCardConfig;
        dashboardCardConfig.forEach(cardConf => {
            const cardElement = document.getElementById(cardConf.id);
            const isVisible = currentConfig.find(c => c.id === cardConf.id)?.visible ?? true;
            if (cardElement) {
                cardElement.style.display = isVisible ? '' : 'none';
            }
        });
    }
    function openNotificationSettingsModal(){
        const modal = document.getElementById('notificationSettingsModal');
        if(modal){
            Object.keys(notificationPreferences).forEach(key => {
                const toggle = modal.querySelector(`[data-pref="${key}"] .toggle-switch`);
                if(toggle) toggle.classList.toggle('active', notificationPreferences[key]);
            });
            openModal('notificationSettingsModal');
        }
    }
    function saveNotificationPreferences() {
        const modal = document.getElementById('notificationSettingsModal');
        if(modal) {
             Object.keys(notificationPreferences).forEach(key => {
                const toggle = modal.querySelector(`[data-pref="${key}"] .toggle-switch`);
                if(toggle) notificationPreferences[key] = toggle.classList.contains('active');
            });
            saveDestinationPreference = notificationPreferences.saveDestination;
            localStorage.setItem('notificationPreferences', JSON.stringify(notificationPreferences));
            showToast('Notification preferences saved!', 'success');
            closeModal('notificationSettingsModal');
        }
    }
    function openHelpAboutModal(){
        openModal('helpAboutModal');
    }
    function openAILearningPrefsModal(){
        const prefs = JSON.parse(localStorage.getItem('aiLearningPreferences')) || aiLearningPreferences;
        const modal = document.getElementById('aiLearningPrefsModal');
        if(!modal) return;
        Object.keys(prefs).forEach(key => {
            const toggleButtonContainer = modal.querySelector(`.toggle-switch-button[data-pref="${key}"]`);
            if(toggleButtonContainer){
                const visualSwitch = toggleButtonContainer.querySelector('.toggle-switch');
                if(visualSwitch) visualSwitch.classList.toggle('active', prefs[key]);
            }
        });
        openModal('aiLearningPrefsModal');
    }
    window.toggleAILearningPref = function(buttonElement) {
        const prefKey = buttonElement.dataset.pref;
        const visualSwitch = buttonElement.querySelector('.toggle-switch');
        if(visualSwitch) {
            visualSwitch.classList.toggle('active');
            aiLearningPreferences[prefKey] = visualSwitch.classList.contains('active');
            localStorage.setItem('aiLearningPreferences', JSON.stringify(aiLearningPreferences));
            showToast(`AI Learning for '${prefKey.replace(/([A-Z])/g, ' $1').toLowerCase()}' ${aiLearningPreferences[prefKey] ? 'enabled' : 'disabled'}.`, "ai_info");
        }
    }
    function exportUserData() {
        const dataToExport = {
            tasks: tasks,
            habits: habits,
            loggedMoods: loggedMoods,
            sleepData: sleepData,
            bulletinPosts: bulletinPosts,
            trustedContacts: trustedContacts,
            mockDeals: mockDeals,
            mockChannels: mockChannels, 
            mockUsers: mockUsers,
            mockNotifications: mockNotifications,
            savedPlacesIds: mockPlaces.all.filter(p => p.saved).map(p=>p.id),
            gamification: { userLevel, userXP, xpToNextLevel, unlockedBadges: Array.from(unlockedBadges) },
            settings: {
                darkMode: localStorage.getItem('darkMode') === 'true',
                themeAccent: localStorage.getItem('themeAccent'),
                aiPersonality: localStorage.getItem('aiPersonality'),
                dashboardConfig: JSON.parse(localStorage.getItem('dashboardCardConfig')),
                notificationPreferences: JSON.parse(localStorage.getItem('notificationPreferences')),
                userProfile: JSON.parse(localStorage.getItem('userProfile')),
                aiLearningPreferences: JSON.parse(localStorage.getItem('aiLearningPreferences'))
            }
        };
        const jsonString = JSON.stringify(dataToExport, null, 2);
        const blob = new Blob([jsonString], { type: "application/json" });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = 'LocalLifeOS_data.json';
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
        showToast("User data exported as JSON. AI uses this (anonymized) to learn.", "success");
    }
    function clearAllDataWithConfirmation() {
        openConfirmationModal(
            "Clear All Data?",
            "<p>This will reset all your tasks, habits, mood logs, custom settings, and other application data. This action cannot be undone.</p><p><strong>Are you absolutely sure?</strong></p>",
            () => {
                localStorage.clear();
                showToast("All application data has been cleared. Please log in again.", "success", 3000);
                setTimeout(() => {
                    window.location.reload();
                }, 3100);
            }
        );
    }
    function showDealDetailModal(deal) {
        if (!deal) { showToast("Error: Deal details not available.", "error", 2000, true); return; }
        
        const contentContainer = document.getElementById('dealDetailContent');
        if (!contentContainer) return;
        
        let bodyHtml = `<p><strong>Business:</strong> ${deal.businessName}</p>`;
        bodyHtml += `<p>${deal.description}</p>`;
        if (deal.expiryDate) {
             const expiry = new Date(deal.expiryDate);
             const today = new Date();
             today.setHours(0,0,0,0);
             if (expiry < today) {
                bodyHtml += `<p><strong>Status:</strong> <span style="color:var(--danger-color); font-weight:bold;">Expired on ${expiry.toLocaleDateString()}</span></p>`;
             } else {
                bodyHtml += `<p><strong>Expires:</strong> ${expiry.toLocaleDateString()}</p>`;
             }
        } else {
            bodyHtml += `<p><strong>Expires:</strong> No expiration date (ongoing)</p>`;
        }
        if (deal.terms) {
            bodyHtml += `<h4 class="mt-2 card-subtitle" style="font-size:0.9rem; font-weight:500;">Terms & Conditions:</h4><p style="font-size:0.8rem;">${deal.terms}</p>`;
        }

        contentContainer.innerHTML = `
            <h3 id="modalDealTitle" class="modal-title">${deal.title}</h3>
            <img id="modalDealImage" src="${deal.img}" alt="${deal.title}" style="width:100%; max-height:clamp(120px, 30vh, 150px); object-fit:cover; border-radius:var(--border-radius-md); margin-bottom:var(--space-sm);" loading="lazy">
            <div id="modalDealBody" class="modal-body">${bodyHtml}</div>
            <div id="dealRedemptionContainer" class="mt-3" style="display:flex; gap:var(--space-sm);">
                <button id="redeemDealButton" class="button" style="flex:1;"><i class="fas fa-ticket-alt" aria-hidden="true"></i> Redeem</button>
                <button class="button button-secondary" style="flex:1;" onclick="shareContent('deal')"><i class="fas fa-share-alt" aria-hidden="true"></i> Share</button>
            </div>
        `;
        
        const redeemButton = contentContainer.querySelector('#redeemDealButton');
        redeemButton.onclick = () => redeemDeal(deal, contentContainer);
        
        openModal('dealDetailModal');
    }
    function redeemDeal(deal, contentContainer) {
        let step = 1;
        const updateRedemptionUI = () => {
            let html = '';
            switch (step) {
                case 1: 
                    html = `
                        <h4 class="modal-title text-center">Confirm Redemption</h4>
                        <p class="text-center card-subtitle">You are about to redeem:</p>
                        <p class="text-center" style="font-weight: 600; font-size: 1.1rem;">${deal.title}</p>
                        <p class="text-center card-subtitle mt-2">AI is verifying your eligibility for this offer...</p>
                        <div class="mt-3" style="display:flex; gap:var(--space-sm);">
                            <button class="button" style="flex-grow:1;" onclick="redeemDealStep(2)">Confirm</button>
                            <button class="button button-secondary" style="flex-grow:1;" onclick="closeModal('dealDetailModal')">Cancel</button>
                        </div>`;
                    break;
                case 2: 
                    html = `
                        <h4 class="modal-title text-center">Payment</h4>
                        <p class="text-center card-subtitle">Simulating payment via Mobile Money.</p>
                        <div class="text-center my-3"><i class="fas fa-mobile-alt fa-3x" style="color: var(--primary-accent);"></i></div>
                        <p class="text-center">A prompt would be sent to your phone to confirm payment of <strong>E0.00</strong> (for this demo).</p>
                        <div class="mt-3" style="display:flex; gap:var(--space-sm);">
                             <button class="button" style="flex-grow:1;" onclick="redeemDealStep(3)">Simulate Approval</button>
                        </div>`;
                    break;
                case 3: 
                    html = `
                        <h4 class="modal-title text-center" style="color:var(--success-color);">Deal Redeemed!</h4>
                        <p class="text-center card-subtitle">Show this screen to the merchant for verification.</p>
                        <div class="text-center my-3">
                           <i class="fas fa-qrcode fa-8x"></i>
                           <p style="font-family: monospace; letter-spacing: 2px; margin-top: var(--space-sm);">LL-SWAZI-12345</p>
                        </div>
                        <p class="text-center card-subtitle">A confirmation has been sent to your notifications.</p>
                        <button class="button mt-3" style="width:100%" onclick="closeModal('dealDetailModal')">Done</button>
                    `;
                    if (step === 3) {
                         showDynamicIslandAlert('fas fa-ticket-alt', 'Deal Redeemed!');
                         addXP(10, 'explore');
                    }
                    break;
            }
            contentContainer.innerHTML = html;
        };

        window.redeemDealStep = (nextStep) => {
            step = nextStep;
            updateRedemptionUI();
        };

        updateRedemptionUI();
    }
    function openSubmitDealModal() {
        const form = document.getElementById('submitDealForm');
        if (form) form.reset();
        const categorySelect = document.getElementById('dealCategorySelect');
        if (categorySelect) {
            categorySelect.innerHTML = '';
            dealCategories.forEach(cat => {
                const option = document.createElement('option');
                option.value = cat;
                option.textContent = cat.charAt(0).toUpperCase() + cat.slice(1);
                categorySelect.appendChild(option);
            });
             if(dealCategories.length > 0) {
                 categorySelect.value = dealCategories[0];
             }
        }
        document.getElementById('dealImagePreview').classList.add('hidden');
        document.getElementById('dealImageUploadText').textContent = 'Click to Upload or Open Camera';
        openModal('submitDealModal');
    }
    function submitNewDeal() {
        const titleInput = document.getElementById('dealTitleInput');
        const businessNameInput = document.getElementById('dealBusinessNameInput');
        const descriptionInput = document.getElementById('dealDescriptionInput');
        const categorySelect = document.getElementById('dealCategorySelect');
        const expiryDateInput = document.getElementById('dealExpiryDateInput');
        const termsInput = document.getElementById('dealTermsInput');
        const imageFile = document.getElementById('dealImageFileInput').files[0];
        if (!titleInput || !businessNameInput || !descriptionInput || !categorySelect || !expiryDateInput || !termsInput) {
            return;
        }
        const title = titleInput.value.trim();
        const businessName = businessNameInput.value.trim();
        const description = descriptionInput.value.trim();
        const category = categorySelect.value;
        const imageUrl = imageFile ? URL.createObjectURL(imageFile) : `https://source.unsplash.com/random/80x80/?${encodeURIComponent(category)}`;
        const expiryDate = expiryDateInput.value;
        const terms = termsInput.value.trim();
        if (!title || !businessName ||!description || !category) {
            showToast("Please fill in all required fields (*).", "error", 2000, true);
            if(!title && titleInput) titleInput.focus();
            else if(!businessName && businessNameInput) businessNameInput.focus();
            else if(!description && descriptionInput) descriptionInput.focus();
            else if(!category && categorySelect) categorySelect.focus();
            return;
        }
        const newDeal = {
            id: nextDealId++,
            title: title,
            description: description,
            businessName: businessName,
            category: category,
            img: imageUrl,
            expiryDate: expiryDate || null,
            terms: terms || "N/A"
        };
        mockDeals.unshift(newDeal);
        const activeScreenId = document.querySelector('.screen.active')?.id;
        if (activeScreenId === 'dashboard') {
            renderDealsOnDashboard();
        } else if (activeScreenId === 'explore') {
            const activeExploreFilter = document.querySelector('#exploreFilterBar .filter-button.active')?.dataset.filter;
            if (activeExploreFilter === 'deals' || category === activeExploreFilter || activeExploreFilter === 'all') {
                 renderPlaces(activeExploreFilter);
            }
        }
        closeModal('submitDealModal');
        showToast("Deal submitted (AI will review & categorize). Thank you!", "success", 2500);
        addXP(20, 'community');
        saveDealsToLocalStorage();
        triggerFabSuggestion();
    }
    function saveTasksToLocalStorage() { localStorage.setItem('localLifeTasks', JSON.stringify(tasks)); }
    function loadTasksFromLocalStorage() {
        const storedTasks = localStorage.getItem('localLifeTasks');
        if (storedTasks) { tasks = JSON.parse(storedTasks); nextTaskId = Math.max(0, ...tasks.map(t=>t.id)) + 1; }
    }
    function saveHabitsToLocalStorage() { localStorage.setItem('localLifeHabits', JSON.stringify(habits)); }
    function loadHabitsFromLocalStorage() {
        const storedHabits = localStorage.getItem('localLifeHabits');
        if (storedHabits) { habits = JSON.parse(storedHabits); nextHabitId = Math.max(0, ...habits.map(h=>h.id)) + 1; }
    }
    function saveLoggedMoodsToLocalStorage() { localStorage.setItem('localLifeMoods', JSON.stringify(loggedMoods)); }
    function loadLoggedMoodsToLocalStorage() {
        const storedMoods = localStorage.getItem('localLifeMoods');
        if (storedMoods) { loggedMoods = JSON.parse(storedMoods); }
    }
    function saveDealsToLocalStorage() { localStorage.setItem('localLifeDeals', JSON.stringify(mockDeals)); }
    function loadDealsFromLocalStorage() {
        const storedDeals = localStorage.getItem('localLifeDeals');
        if (storedDeals) {
            mockDeals = JSON.parse(storedDeals);
            nextDealId = Math.max(0, ...mockDeals.map(d => d.id)) + 1;
        }
    }
    function savePlacesToLocalStorage() {
        const savedPlaceIds = mockPlaces.all.filter(p => p.saved).map(p => p.id);
        localStorage.setItem('localLifeSavedPlaces', JSON.stringify(savedPlaceIds));
    }
    function loadPlacesFromLocalStorage() {
        const storedSavedPlaceIds = localStorage.getItem('localLifeSavedPlaces');
        if (storedSavedPlaceIds) {
            const savedIds = JSON.parse(storedSavedPlaceIds);
            mockPlaces.all.forEach(p => p.saved = savedIds.includes(p.id));
            mockPlaces.saved = mockPlaces.all.filter(p => p.saved);
        }
    }
    function saveChannelsToLocalStorage() { localStorage.setItem('localLifeChannels', JSON.stringify(mockChannels));}
    function loadChannelsFromLocalStorage() {
        const storedChannels = localStorage.getItem('localLifeChannels');
        if(storedChannels) {
            mockChannels = JSON.parse(storedChannels);
            nextChannelId = Math.max(0, ...mockChannels.map(c => c.id)) + 1;
            let maxMid = 0;
            mockChannels.forEach(c => {
                if(c.messages) c.messages.forEach(m => { 
                    if(m.mid > maxMid) maxMid = m.mid;
                    m.timestamp = new Date(m.timestamp);
                });
                if(c.lastMessageTimestamp) c.lastMessageTimestamp = new Date(c.lastMessageTimestamp);
            });
            nextMessageId = maxMid + 1;
        }
    }
    function saveUsersToLocalStorage() { localStorage.setItem('localLifeUsers', JSON.stringify(mockUsers));}
    function loadUsersFromLocalStorage() {
        const storedUsers = localStorage.getItem('localLifeUsers');
        if(storedUsers) {
            mockUsers = JSON.parse(storedUsers);
        }
        const userProfile = JSON.parse(localStorage.getItem('userProfile'));
        if(userProfile && mockUsers['user']){
            mockUsers['user'].name = userProfile.name;
            mockUsers['user'].username = userProfile.username;
            mockUsers['user'].bio = userProfile.bio;
            userName = userProfile.name.split(' ')[0]; 
        } else if (mockUsers['user']) {
            userName = mockUsers['user'].name.split(' ')[0];
        } else {
            userName = 'User';
        }
    }
    function loadAILearningPrefsFromLocalStorage() {
        const storedPrefs = localStorage.getItem('aiLearningPreferences');
        if(storedPrefs) {
            aiLearningPreferences = JSON.parse(storedPrefs);
        }
    }
    function saveNotificationsToLocalStorage() { localStorage.setItem('localLifeNotifications', JSON.stringify(mockNotifications));}
    function loadNotificationsFromLocalStorage() {
        const storedNotifications = localStorage.getItem('localLifeNotifications');
        if (storedNotifications) {
            mockNotifications = JSON.parse(storedNotifications).map(n => ({...n, timestamp: new Date(n.timestamp)}));
            nextNotificationId = Math.max(0, ...mockNotifications.map(n => n.id)) + 1;
        }
    }
    function loadNotificationPreferencesFromLocalStorage() {
        const storedPrefs = localStorage.getItem('notificationPreferences');
        if (storedPrefs) {
            notificationPreferences = JSON.parse(storedPrefs);
            saveDestinationPreference = notificationPreferences.saveDestination;
        }
    }
    function loadDashboardConfigFromLocalStorage() {
        const storedConfig = localStorage.getItem('dashboardCardConfig');
        if(storedConfig) {
            dashboardCardConfig = JSON.parse(storedConfig);
        }
    }
    function saveTrustedContactsToLocalStorage() { localStorage.setItem('localLifeTrustedContacts', JSON.stringify(trustedContacts)); }
    function loadTrustedContactsFromLocalStorage() {
        const stored = localStorage.getItem('localLifeTrustedContacts');
        if (stored) { trustedContacts = JSON.parse(stored); nextTrustedContactId = Math.max(0, ...trustedContacts.map(c => c.id)) + 1; }
    }
    function saveBulletinPostsToLocalStorage() { localStorage.setItem('localLifeBulletinPosts', JSON.stringify(bulletinPosts)); }
    function loadBulletinPostsFromLocalStorage() {
        const stored = localStorage.getItem('localLifeBulletinPosts');
        if (stored) { bulletinPosts = JSON.parse(stored); nextBulletinPostId = Math.max(0, ...bulletinPosts.map(p => p.id)) + 1; }
    }
    function saveSleepDataToLocalStorage() { localStorage.setItem('localLifeSleepData', JSON.stringify(sleepData)); }
    function loadSleepDataFromLocalStorage() {
        const stored = localStorage.getItem('localLifeSleepData');
        if (stored) { sleepData = JSON.parse(stored); }
    }
    function saveGamificationDataToLocalStorage() {
        const data = { userLevel,userXP, xpToNextLevel, unlockedBadges: Array.from(unlockedBadges) };
        localStorage.setItem('localLifeGamification', JSON.stringify(data));
    }
    function loadGamificationDataFromLocalStorage() {
        const stored = localStorage.getItem('localLifeGamification');
        if (stored) {
            const data = JSON.parse(stored);
            userLevel = data.userLevel || 1;
            userXP = data.userXP || 0;
            xpToNextLevel = data.xpToNextLevel || 100;
            unlockedBadges = new Set(data.unlockedBadges || []);
        }
    }
    function saveAppletsToLocalStorage() { localStorage.setItem('localLifeApplets', JSON.stringify(mockApplets)); }
    function loadAppletsFromLocalStorage() {
        const stored = localStorage.getItem('localLifeApplets');
        if (stored) { mockApplets = JSON.parse(stored); }
    }
     function saveSubscriptionToLocalStorage() { localStorage.setItem('userSubscriptionTier', userSubscriptionTier); }
    function loadSubscriptionFromLocalStorage() {
        const stored = localStorage.getItem('userSubscriptionTier');
        if (stored) { userSubscriptionTier = stored; }
    }
    function saveIntegratedAppsToLocalStorage() { localStorage.setItem('localLifeIntegratedApps', JSON.stringify(integratedApps)); }
    function loadIntegratedAppsFromLocalStorage() {
        const stored = localStorage.getItem('localLifeIntegratedApps');
        if (stored) { integratedApps = JSON.parse(stored); }
    }
    const loginScreen = document.getElementById('loginScreen');
    const signupScreen = document.getElementById('signupScreen');
    function showLoginScreen() {
        if (loginScreen) loginScreen.classList.add('active');
        if (signupScreen) signupScreen.classList.remove('active');
    }
    function showSignupScreen() {
        if (signupScreen) signupScreen.classList.add('active');
        if (loginScreen) loginScreen.classList.remove('active');
    }
    function handleLoginAttempt() {
        const email = document.getElementById('loginEmail').value;
        const password = document.getElementById('loginPassword').value;
        if (!email || !password) {
            showToast("Please enter both email/username and password.", "error");
            return;
        }
        if (email === "test@example.com" && password === "password") {
            localStorage.setItem('isLoggedIn', 'true');
            const storedProfile = JSON.parse(localStorage.getItem('userProfile'));
            if (storedProfile && storedProfile.name) {
                 userName = storedProfile.name.split(' ')[0];
            } else {
                 userName = "User";
                 localStorage.setItem('userProfile', JSON.stringify({ name: 'Demo User', username: '@demo_user', bio: 'New to LocalLife OS!' }));
            }
            authContainer.style.display = 'none';
            appContainer.classList.remove('hidden');
            initializeAppPostLogin();
            showToast(`Welcome back, ${userName}!`, "success");
        } else {
            showToast("Invalid credentials (Use: test@example.com / password)", "error");
        }
    }
    function handleSignupAttempt() {
        const name = document.getElementById('signupName').value;
        const email = document.getElementById('signupEmail').value;
        const password = document.getElementById('signupPassword').value;
        const confirmPassword = document.getElementById('signupConfirmPassword').value;
        if (!name || !email || !password || !confirmPassword) {
            showToast("Please fill all fields for signup.", "error");
            return;
        }
        if (password !== confirmPassword) {
            showToast("Passwords do not match.", "error");
            return;
        }
        const newUserName = name.split(' ')[0];
        const newUsernameHandle = '@' + newUserName.toLowerCase() + '_local';
        localStorage.setItem('isLoggedIn', 'true');
        localStorage.setItem('userProfile', JSON.stringify({ name: name, username: newUsernameHandle, bio: `Hi, I'm ${newUserName}!` }));
        userName = newUserName;
        if (!mockUsers['user']) {
            mockUsers['user'] = { id: 'user', name: name, username: newUsernameHandle, avatarUrl: `https://i.pravatar.cc/40?u=user`, bio: `Hi, I'm ${newUserName}!` };
            saveUsersToLocalStorage();
        } else {
            mockUsers['user'].name = name;
            mockUsers['user'].username = newUsernameHandle;
            mockUsers['user'].bio = `Hi, I'm ${newUserName}!`;
            saveUsersToLocalStorage();
        }
        authContainer.style.display = 'none';
        appContainer.classList.remove('hidden');
        initializeAppPostLogin();
        showToast(`Welcome to LocalLife OS, ${userName}! Account created.`, "success");
    }
    function handleLogout() {
        openConfirmationModal("Log Out?", "Are you sure you want to log out?", () => {
            localStorage.removeItem('isLoggedIn');
            authContainer.style.display = 'flex';
            appContainer.classList.add('hidden');
            showLoginScreen();
            showToast("Logged out successfully.", "success");
        });
    }
    function initializeAppPostLogin() {
        loadUsersFromLocalStorage(); 
        loadTasksFromLocalStorage();
        loadHabitsFromLocalStorage();
        loadLoggedMoodsToLocalStorage();
        loadDealsFromLocalStorage();
        loadPlacesFromLocalStorage();
        loadChannelsFromLocalStorage(); 
        loadAILearningPrefsFromLocalStorage();
        loadNotificationPreferencesFromLocalStorage();
        loadNotificationsFromLocalStorage();
        loadDashboardConfigFromLocalStorage();
        loadTrustedContactsFromLocalStorage();
        loadBulletinPostsFromLocalStorage();
        loadSleepDataFromLocalStorage();
        loadGamificationDataFromLocalStorage();
        loadAppletsFromLocalStorage();
        loadSubscriptionFromLocalStorage();
        loadIntegratedAppsFromLocalStorage();
        if (typeof google !== 'undefined') initMap();
        native.requestNotificationPermission();
        const isDarkModeSaved = localStorage.getItem('darkMode') === 'true';
        if (isDarkModeSaved) {
            document.body.classList.add('dark-mode');
            if (darkModeToggleVisual) darkModeToggleVisual.classList.add('active');
            if (darkModeToggleContainer) darkModeToggleContainer.setAttribute('aria-checked', 'true');
        } else {
            if (darkModeToggleContainer) darkModeToggleContainer.setAttribute('aria-checked', 'false');
        }
        const savedTheme = localStorage.getItem('themeAccent');
        const defaultThemeColor = '#4DB6AC';
        let defaultThemeButton = Array.from(document.querySelectorAll('.theme-selector .theme-color-button i.theme-color-dot'))
                                .find(dot => dot.style.color.toUpperCase().includes(defaultThemeColor.toUpperCase()))?.parentElement;
        if (!defaultThemeButton && document.querySelector('.theme-selector .theme-color-button')) {
             defaultThemeButton = document.querySelector('.theme-selector .theme-color-button');
        }
        if (savedTheme) {
            const matchingButton = Array.from(document.querySelectorAll('.theme-selector .theme-color-button')).find(btn => {
                 const dot = btn.querySelector('.theme-color-dot');
                 return dot && dot.style.color.toUpperCase().includes(savedTheme.toUpperCase());
            });
            if (matchingButton) changeThemeAccent(savedTheme, matchingButton);
            else if (defaultThemeButton) changeThemeAccent(defaultThemeColor, defaultThemeButton);
        } else if (defaultThemeButton) changeThemeAccent(defaultThemeColor, defaultThemeButton);
        const savedAIPersonality = localStorage.getItem('aiPersonality');
        if (savedAIPersonality && aiPersonalitySelect) {
            currentAiPersonality = savedAIPersonality;
            aiPersonalitySelect.value = savedAIPersonality;
        }
        setActiveScreen('dashboard', true);
        updateAIData();
        setInterval(updateAIData, 30000);
        setInterval(cycleSafetyTicker, 7000);
        setInterval(checkTaskReminders, 60000);
        updateUnreadNotificationBadge();
        renderDashboardTasks();
        renderDealsOnDashboard();
        renderPinnedWidgets();
        renderTasks();
        generateCalendarPlaceholder();
        renderPlaces('all');
        renderChannels();
        renderHabits();
        updateProactiveSuggestions();
        showAIExploreSuggestion();
        updateWellnessTimeline();
        setupInputClearButtons();
        applyDashboardCustomization();
        fetchNewsSummary();
        updateGamificationUI('all');
        updateSubscriptionStatusUI();
        renderInstalledAppletsOnDashboard();
        if (aiChatArea.children.length === 0) {
            addMessageToAIChat('other', getAIPersonalityPrefix() + `Sanibonani ${userName}! I'm LocalLife AI. How can I help you? Try 'help'.`);
        }
        if (aiBottomSheet) aiBottomSheet.setAttribute('aria-hidden', 'true');
        if (aiFab) aiFab.setAttribute('aria-expanded', 'false');
        const lastBriefingDate = localStorage.getItem('lastBriefingDate');
        const todayDateString = new Date().toDateString();
        if (lastBriefingDate !== todayDateString) {
            showDailyBriefing();
            localStorage.setItem('lastBriefingDate', todayDateString);
        }
    }
    document.addEventListener('DOMContentLoaded', () => {
        const isLoggedIn = localStorage.getItem('isLoggedIn') === 'true';
        if (isLoggedIn) {
            authContainer.style.display = 'none';
            appContainer.classList.remove('hidden');
            initializeAppPostLogin();
        } else {
            authContainer.style.display = 'flex';
            appContainer.classList.add('hidden');
            showLoginScreen();
        }
    });
    showToast = function(message, type = "info", duration = 3000, isError = false) {
        if (!toastNotification) return;
        clearTimeout(toastTimeout);
        toastNotification.textContent = message;
        toastNotification.className = 'toast-notification';
        toastNotification.style.backgroundColor = '';
        toastNotification.style.color = '';
        if (type === "success") {
            toastNotification.style.backgroundColor = 'var(--success-color)';
            toastNotification.style.color = 'white';
        } else if (type === "error" || isError) {
            toastNotification.style.backgroundColor = 'var(--danger-color)';
            toastNotification.style.color = 'white';
        } else if (type === "ai_info") { 
            toastNotification.classList.add('ai-info-toast');
        } else if (type === "xp") {
            toastNotification.style.backgroundColor = 'var(--xp-color)';
            toastNotification.style.color = 'white';
        }
        toastNotification.classList.add('show');
        toastTimeout = setTimeout(() => {
            toastNotification.classList.remove('show');
        }, duration);
    }
    openModal = function(modalId) {
        const modal = document.getElementById(modalId);
        if (modal) {
            if (modal.id === 'focusModeModal' || modal.id.startsWith('applet-')) {
                modal.style.display = 'flex';
                setTimeout(() => modal.classList.add('active'), 10);
            } else {
                modal.style.display = 'flex';
                setTimeout(() => modal.classList.add('active'), 10);
            }
            
            const event = new CustomEvent('show', { bubbles: true });
            modal.dispatchEvent(event);
            
            currentOpenModalId = modalId;
            const focusableElements = 'button, [href], input, select, textarea, [tabindex]:not([tabindex="-1"])';
            const firstFocusableElement = modal.querySelector(focusableElements);
            if (firstFocusableElement) firstFocusableElement.focus();
        }
    }
    closeModal = function(modalIdToClose) {
        const modalToActOn = modalIdToClose || currentOpenModalId;
        if (!modalToActOn) return;
        const modal = document.getElementById(modalToActOn);
        if (modal) {
            modal.classList.remove('active');
            setTimeout(() => {
                modal.style.display = 'none';
            }, 400); 
            if (modalToActOn === currentOpenModalId) currentOpenModalId = null;
            if (modalIdToClose === 'arViewModal') {
                const arVideo = document.getElementById('arVideo');
                if (arVideo && arVideo.srcObject) {
                    arVideo.srcObject.getTracks().forEach(track => track.stop());
                    arVideo.srcObject = null;
                }
            }
        }
    }
    function updateContextualFabIcon() {
        if (!aiFabIcon) return;
        const activeScreenId = document.querySelector('.screen.active')?.id;
        let newIcon = 'fa-brain';
        switch (activeScreenId) {
            case 'planner': newIcon = 'fa-wand-magic-sparkles'; break;
            case 'explore': newIcon = 'fa-route'; break;
            case 'wellness': newIcon = 'fa-chart-line'; break;
        }
        aiFabIcon.className = `fas ${newIcon}`;
    }
    setActiveScreen = function(screenId, skipScroll = false) {
        if (appContainer.classList.contains('full-page-active') && window.innerWidth <= 450) {
            appContainer.classList.remove('full-page-active');
            if (aiBottomSheet.classList.contains('active')) {
                aiBottomSheet.classList.remove('active');
                aiBottomSheet.setAttribute('aria-hidden', 'true');
            }
            if (specificChatView.classList.contains('active')) {
                specificChatView.classList.remove('active');
                specificChatView.classList.add('hidden');
            }
        }
        screens.forEach(screen => screen.classList.remove('active'));
        navItems.forEach(item => {
            item.classList.remove('active'); item.setAttribute('aria-selected', 'false');
        });
        const targetScreen = document.getElementById(screenId);
        if (targetScreen) {
            targetScreen.classList.add('active');
             if (screenId === 'chat') {
                channelListView.style.display = 'block';
                specificChatView.classList.add('hidden');
                specificChatView.classList.remove('active'); 
            }
        }
        else {
            document.getElementById('dashboard')?.classList.add('active');
            screenId = 'dashboard';
        }
        const targetNavItem = document.querySelector(`.nav-item[data-screen="${screenId}"]`);
        if (targetNavItem) {
            targetNavItem.classList.add('active'); targetNavItem.setAttribute('aria-selected', 'true');
        }
        updateContextualFabIcon();
        if (!skipScroll) {
            const contentArea = document.querySelector('.content');
            if(contentArea) contentArea.scrollTop = 0;
        }
        if (currentOpenModalId && currentOpenModalId !== "aiBottomSheet" && currentOpenModalId !== "notificationsModal") {
            closeModal(currentOpenModalId);
        }
        if (screenId === 'chat' && document.getElementById('newChannelIconSelector') && !document.getElementById('newChannelIconSelector').hasChildNodes()) {
            populateIconSelector('newChannelIconSelector');
        }
        if (screenId === 'wellness') {
            if (document.getElementById('newHabitIconSelector') && !document.getElementById('newHabitIconSelector').hasChildNodes()) {
                populateIconSelector('newHabitIconSelector');
            }
            if (document.getElementById('newHabitColorSelector') && !document.getElementById('newHabitColorSelector').hasChildNodes()){
                 populateColorSelector('newHabitColorSelector');
            }
            updateWellnessTimeline();
            checkForWellnessPatterns();
        }
        if (screenId === 'explore') showAIExploreSuggestion();
        if (screenId === 'dashboard') {
            updateProactiveSuggestions();
            renderDealsOnDashboard();
            renderPinnedWidgets();
            applyDashboardCustomization();
        }
        if (screenId === 'planner' && aiPlannerSuggestionEl) {
            aiPlannerSuggestionEl.classList.add('hidden'); 
        }
        if (screenId === 'appStore') {
            renderApplets();
        }
        if (screenId === 'privacyDashboard') {
            renderPrivacyDashboard();
        }
    }
    updateAIData = function() {
        const aiGreetingEl = document.getElementById('aiGreeting');
        const localTimeDateEl = document.getElementById('localTimeDate');
        const now = new Date();
        const hours = now.getHours();
        let greeting = `Sanibonani, ${userName}!`;
        if (hours < 12) greeting = `Kusile, ${userName}!`;
        else if (hours < 18) greeting = `Good Afternoon, ${userName}!`;
        else greeting = `Good Evening, ${userName}!`;
        if (aiGreetingEl) aiGreetingEl.textContent = greeting;
        if (localTimeDateEl) {
             const options = { weekday: 'short', month: 'short', day: 'numeric', hour: '2-digit', minute: '2-digit', hour12: true };
             localTimeDateEl.textContent = now.toLocaleTimeString('en-US', options).replace(',', ' -');
        }
        updateUnreadNotificationBadge();
        updateLiveLocationInfo();
    }
    generateCalendarPlaceholder = function() {
        const calendarEl = document.getElementById('calendarPlaceholder');
        if (!calendarEl) return;
        calendarEl.innerHTML = '';
        const daysOfWeek = ['S', 'M', 'T', 'W', 'T', 'F', 'S'];
        daysOfWeek.forEach(day => {
            const dayHeader = document.createElement('div');
            dayHeader.className = 'day'; dayHeader.style.fontWeight = 'bold';
            dayHeader.textContent = day; calendarEl.appendChild(dayHeader);
        });
        const today = new Date().getDate();
        const currentMonthDays = new Date(new Date().getFullYear(), new Date().getMonth() + 1, 0).getDate();
        const firstDayOfMonth = new Date(new Date().getFullYear(), new Date().getMonth(), 1).getDay();
        for(let i=0; i < firstDayOfMonth; i++){
            const emptyCell = document.createElement('div');
            emptyCell.className = 'day'; calendarEl.appendChild(emptyCell);
        }
        for (let i = 1; i <= currentMonthDays ; i++) {
            if (calendarEl.childElementCount >= 35 + daysOfWeek.length) break;
            const dayCell = document.createElement('div');
            dayCell.className = 'day'; dayCell.textContent = i;
            if (i === today) {
                dayCell.classList.add('today'); dayCell.setAttribute('aria-current', 'date');
                dayCell.setAttribute('aria-label', `Today, ${i}`);
            } else { dayCell.setAttribute('aria-label', `Date ${i}`); }
            const thisDateString = new Date(new Date().getFullYear(), new Date().getMonth(), i).toISOString().split('T')[0];
            const hasTask = tasks.some(t => t.dueDate === thisDateString && !t.completed);
            if (hasTask) {
                const dot = document.createElement('div');
                dot.className = 'calendar-task-dot';
                dayCell.appendChild(dot);
            }
            dayCell.onclick = () => openFullCalendar('tasks');
            calendarEl.appendChild(dayCell);
        }
    }
    const notificationListContainer = document.getElementById('notificationListContainer');
    const unreadNotificationBadge = document.getElementById('unreadNotificationBadge');
    function updateUnreadNotificationBadge() {
        if (!unreadNotificationBadge) return;
        const unreadCount = mockNotifications.filter(n => !n.read).length;
        unreadNotificationBadge.textContent = unreadCount;
        unreadNotificationBadge.classList.toggle('hidden', unreadCount === 0);
    }
    function renderNotifications() {
        if (!notificationListContainer) return;
        notificationListContainer.innerHTML = '';
        if (mockNotifications.length === 0) {
            notificationListContainer.innerHTML = `<li class="empty-state" style="padding:20px 0;"><i class="fas fa-bell-slash"></i><p>No notifications yet.</p></li>`;
            updateUnreadNotificationBadge();
            return;
        }
        mockNotifications.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp)).forEach(notif => {
            const item = document.createElement('li');
            item.className = `notification-item ${notif.read ? '' : 'unread'}`;
            item.setAttribute('role', 'listitem');
            let actionButtonsHtml = '';
            if (notif.type === 'task_reminder' && !tasks.find(t=>t.id === (notif.relatedId || -1))?.completed) {
                actionButtonsHtml = `<div class="action-buttons">
                    <button class="button button-secondary" style="font-size:0.8rem; padding:4px 8px;" onclick="event.stopPropagation(); toggleTaskStatus(${notif.relatedId})">Mark Done</button>
                    <button class="button button-secondary" style="font-size:0.8rem; padding:4px 8px;" onclick="event.stopPropagation(); showToast('Snoozing for 15 mins', 'info')">Snooze</button>
                </div>`;
            }
            item.innerHTML = `
                <i class="notification-icon ${notif.icon}" aria-hidden="true"></i>
                <div class="notification-content">
                    <div class="notification-title">${notif.title}</div>
                    <div class="notification-text">${notif.text}</div>
                    <div class="notification-timestamp">${new Date(notif.timestamp).toLocaleString()}</div>
                    ${actionButtonsHtml}
                </div>
            `;
            item.onclick = () => {
                const wasUnread = !notif.read;
                notif.read = true;
                if (notif.action && typeof notif.action === 'function') {
                    closeModal('notificationsModal');
                    notif.action();
                }
                if (wasUnread) {
                    renderNotifications(); 
                    updateUnreadNotificationBadge();
                    saveNotificationsToLocalStorage();
                }
            };
            notificationListContainer.appendChild(item);
        });
        updateUnreadNotificationBadge();
    }
    function showDailyBriefing() {
        if(!notificationPreferences.dailyBriefing) return;
        const weather = document.getElementById('currentWeather')?.textContent || "Partly cloudy";
        const taskCount = tasks.filter(t => t.dueDate === new Date().toISOString().split('T')[0] && !t.completed).length;
        const savedCafe = mockPlaces.all.find(p => p.saved && p.tags.includes('cafe'));
        let dealText = "";
        if (savedCafe) {
            const dealForCafe = mockDeals.find(d => d.businessName === savedCafe.name);
            if (dealForCafe) {
                dealText = ` Also, there's a new '${dealForCafe.title}' deal at '${dealForCafe.businessName}', one of your saved places.`;
            }
        }
        const safetyAlert = safetyTickerMessages.find(m => m.toLowerCase().includes('closure') || m.toLowerCase().includes('outage') || m.toLowerCase().includes('shedding'));
        let briefingText = `Kusile, ${userName}! It's ${weather}. You have ${taskCount} task${taskCount !== 1 ? 's' : ''} today.${dealText}`;
        if(safetyAlert) {
            briefingText += ` Heads up: ${safetyAlert.split('.')[0]}.`
        }
        const briefingNotification = {
            id: nextNotificationId++,
            icon: 'fas fa-sun',
            title: 'Your Daily Briefing',
            text: briefingText,
            timestamp: new Date(),
            read: false,
            type: 'daily_briefing',
            action: () => setActiveScreen('dashboard')
        };
        const existingBriefing = mockNotifications.find(n => n.type === 'daily_briefing' && new Date(n.timestamp).toDateString() === new Date().toDateString());
        if(!existingBriefing){
            mockNotifications.unshift(briefingNotification);
            renderNotifications();
            updateUnreadNotificationBadge();
            showDynamicIslandAlert('fas fa-sun', 'Your Daily Briefing is ready!');
            saveNotificationsToLocalStorage();
        }
    }
    window.showNotificationsPanel = function() {
        renderNotifications();
        openModal('notificationsModal');
    }
    window.markAllNotificationsRead = function() {
        mockNotifications.forEach(n => n.read = true);
        renderNotifications();
        updateUnreadNotificationBadge();
        saveNotificationsToLocalStorage();
        showToast("All notifications marked as read.", "success");
    }
    window.clearAllNotifications = function() {
        openConfirmationModal("Clear All Notifications?", "Are you sure you want to clear all notifications? This cannot be undone.", () => {
            mockNotifications = [];
            nextNotificationId = 1;
            renderNotifications();
            updateUnreadNotificationBadge();
            saveNotificationsToLocalStorage();
            showToast("All notifications cleared.", "success");
        });
    }
    window.showPulseDetailModal = function(itemName, itemIcon, itemDescription) {
        
        const safeItemName = itemName.replace(/'/g, "\\'");
        const safeItemDescription = itemDescription.replace(/'/g, "\\'");

        let modalBodyHtml = `
            <div class="text-center mb-3">
                <i class="${itemIcon} fa-3x" style="color: var(--primary-accent);"></i>
            </div>
            <p>${itemDescription}</p>
            <p class="mt-2 card-subtitle" style="font-size:0.8rem;">AI can provide related events, directions, or allow sharing from here.</p>
            <div class="mt-3" style="display:flex; gap:var(--space-sm);">
                <button class="button" style="flex:1;" onclick="getDirections('${safeItemName}')"><i class="fas fa-directions"></i> Get Directions</button>
                <button class="button button-secondary" style="flex:1;" onclick="native.share('pulse', { title: '${safeItemName}', text: '${safeItemDescription}' })"><i class="fas fa-share-alt"></i> Share</button>
            </div>
        `;
        openGenericModal(itemName, modalBodyHtml);
    }
    function openFullCalendar(type) {
        currentCalendarType = type;
        calendarCurrentDate = new Date();
        renderFullCalendar();
        openModal('fullCalendarModal');
    }
    function navigateCalendar(monthOffset) {
        calendarCurrentDate.setMonth(calendarCurrentDate.getMonth() + monthOffset);
        renderFullCalendar();
    }
    function renderFullCalendar() {
        const gridBody = document.getElementById('calendarGridBody');
        const modalTitle = document.getElementById('fullCalendarModalTitle');
        const detailPanel = document.getElementById('calendarDayDetailPanel');
        if (!gridBody || !modalTitle) return;
        gridBody.innerHTML = '';
        detailPanel.classList.add('hidden');
        const year = calendarCurrentDate.getFullYear();
        const month = calendarCurrentDate.getMonth();
        modalTitle.textContent = calendarCurrentDate.toLocaleString('default', { month: 'long', year: 'numeric' });
        const firstDayOfMonth = new Date(year, month, 1).getDay();
        const daysInMonth = new Date(year, month + 1, 0).getDate();
        for (let i = 0; i < firstDayOfMonth; i++) {
            gridBody.innerHTML += `<div class="calendar-day other-month"></div>`;
        }
        for (let day = 1; day <= daysInMonth; day++) {
            const dayEl = document.createElement('div');
            dayEl.className = 'calendar-day';
            const thisDate = new Date(year, month, day);
            const thisDateString = thisDate.toISOString().split('T')[0];
            if (thisDateString === new Date().toISOString().split('T')[0]) {
                dayEl.classList.add('today');
            }
            let contentHtml = `<div class="day-number">${day}</div>`;
            if (currentCalendarType === 'tasks') {
                const tasksOnDay = tasks.filter(t => t.dueDate === thisDateString);
                if (tasksOnDay.length > 0) {
                    tasksOnDay.slice(0, 2).forEach(task => {
                        contentHtml += `<div class="task-indicator" style="background-color: var(--${{work:'moss-green',health:'soft-blue',errands:'muted-terracotta'}[task.category] || 'primary-accent'}); color: white;">${task.title}</div>`;
                    });
                     if (tasksOnDay.length > 2) contentHtml += `<div class="task-indicator" style="background: var(--warm-gray); color: var(--text-color);">+${tasksOnDay.length - 2} more</div>`;
                }
            } else if (currentCalendarType === 'moods') {
                const moodOnDay = loggedMoods.find(m => new Date(m.timestamp).toDateString() === thisDate.toDateString());
                if (moodOnDay) {
                    contentHtml += `<div class="mood-indicator">${moodOnDay.mood}</div>`;
                }
            }
            dayEl.innerHTML =contentHtml;
            dayEl.onclick = () => showCalendarDayDetails(thisDate);
            gridBody.appendChild(dayEl);
        }
    }
    function showCalendarDayDetails(date) {
        const detailPanel = document.getElementById('calendarDayDetailPanel');
        let detailHtml = `<h4>Details for ${date.toLocaleDateString()}</h4>`;
        let foundContent = false;
        if (currentCalendarType === 'tasks') {
            const tasksOnDay = tasks.filter(t => t.dueDate === date.toISOString().split('T')[0]);
            if (tasksOnDay.length > 0) {
                detailHtml += '<ul>';
                tasksOnDay.forEach(task => detailHtml += `<li>${task.completed ? '' : ''} ${task.title}</li>`);
                detailHtml += '</ul>';
                foundContent = true;
            }
        } else if (currentCalendarType === 'moods') {
            const moodsOnDay = loggedMoods.filter(m => new Date(m.timestamp).toDateString() === date.toDateString());
            if(moodsOnDay.length > 0) {
                detailHtml += '<ul>';
                moodsOnDay.forEach(mood => detailHtml += `<li>${mood.mood} ${mood.note ? `- "${mood.note}"` : ''}</li>`);
                detailHtml += '</ul>';
                foundContent = true;
            }
        }
        if (!foundContent) {
            detailHtml += `<p class="card-subtitle">No ${currentCalendarType} logged for this day.</p>`;
        } else if (currentCalendarType === 'moods' && foundContent) {
            const moodsOnDay = loggedMoods.filter(m => new Date(m.timestamp).toDateString() === date.toDateString());
            detailHtml += `<p class="card-subtitle mt-2"><em>AI could analyze mood trends for this day of the week (e.g., "You tend to feel ${moodsOnDay[0].mood} on Mondays").</em></p>`;
        }
        detailPanel.innerHTML = detailHtml;
        detailPanel.classList.remove('hidden');
    }
    function openHabitStatsModal() {
        const statsBody = document.getElementById('habitStatsBody');
        const aiInsight = document.getElementById('habitStatsAIInsight');
        if (!statsBody || !aiInsight) return;
        let totalHabits = habits.length;
        if (totalHabits === 0) {
            statsBody.innerHTML = `<p class="text-center">No habits to show stats for yet.</p>`;
            aiInsight.classList.add('hidden');
            openModal('habitStatsModal');
            return;
        }
        let statsHtml = '';
        let totalCompletion = 0;
        let bestStreak = { name: '', streak: 0 };
        let mostConsistent = { name: '', rate: 0 };
        habits.forEach(habit => {
            const completionRate = habit.goal > 0 ? (habit.current / habit.goal) * 100 : 0;
            totalCompletion += completionRate;
            statsHtml += `
                <div class="habit-stat-item">
                    <div class="stat-title">${habit.name}</div>
                    <div class="progress-bar-container">
                        <div class="progress-bar" style="width: ${completionRate}%; background-color: ${habit.color};"></div>
                    </div>
                    <p class="card-subtitle mt-1" style="font-size: 0.8rem;">Today: ${Math.round(completionRate)}% | Streak: ${habit.streak} days</p>
                </div>
            `;
            if (habit.streak > bestStreak.streak) {
                bestStreak = { name: habit.name, streak: habit.streak };
            }
            if(completionRate > mostConsistent.rate) {
                 mostConsistent = { name: habit.name, rate: completionRate };
            }
        });
        const overallCompletion = totalCompletion / totalHabits;
        statsHtml = `<div class="habit-stat-item">
            <div class="stat-title"><strong>Overall Daily Completion</strong></div>
            <div class="progress-bar-container">
                <div class="progress-bar" style="width: ${overallCompletion}%;"></div>
            </div>
            <p class="card-subtitle mt-1" style="font-size: 0.8rem;">Today you've completed <strong>${Math.round(overallCompletion)}%</strong> of your goals.</p>
        </div>` + statsHtml;
        statsBody.innerHTML = statsHtml;
        let insightText = `<i class="fas fa-brain"></i> <strong>AI Insight:</strong> `;
        if(bestStreak.streak > 5) {
            insightText += `You have an amazing ${bestStreak.streak}-day streak on "${bestStreak.name}"! This is your strongest habit. `;
        }
        if (overallCompletion < 50 && habits.length > 3) {
            insightText += `It looks like a busy day. To avoid feeling overwhelmed, maybe focus on completing just one key habit, like "${mostConsistent.name}".`;
        } else if (overallCompletion > 80) {
            insightText += `You're on fire today! Fantastic consistency. Consider adding a new, small habit to build on this momentum.`;
        } else {
             insightText += `Keep up the steady progress. Consistency is the key to building lasting habits.`;
        }
        aiInsight.innerHTML = insightText;
        aiInsight.classList.remove('hidden');
        openModal('habitStatsModal');
    }
    function openEmergencyDashboard() {
        openModal('emergencyDashboardModal');
        if (emergencyKeywordRecognition) {
            emergencyKeywordRecognition.start();
            showToast("AI Emergency Listener is active.", "ai_info");
        }
    }
    function alertTrustedCircle() {
        if(trustedContacts.length === 0){
            showToast("No trusted contacts configured. Please add them in Settings > Trusted Circle.", "error", 3000);
            return;
        }
        native.geolocation.getCurrent(
            position => {
                const { latitude, longitude } = position.coords;
                userLocationCoords = { lat: latitude, lng: longitude };
                const contacts = trustedContacts.map(c => c.phone).join(',');
                const message = encodeURIComponent(`Emergency alert from LocalLife OS: I may need help. My last known location is: https://maps.google.com/?q=${latitude},${longitude}`);
                window.location.href = `sms:${contacts}?body=${message}`;
                showToast("Opening messaging app to alert trusted circle...", "success", 3000);
            },
            () => {
                const contacts = trustedContacts.map(c => c.phone).join(',');
                const message = encodeURIComponent(`Emergency alert from LocalLife OS: I may need help. Unable to get current location.`);
                window.location.href = `sms:${contacts}?body=${message}`;
                showToast("Could not get location. Alerting without it...", "error", 3000);
            }
        );
    }
    function shareLiveLocation() {
        native.geolocation.getCurrent(
            position => {
                const { latitude, longitude } = position.coords;
                userLocationCoords = { lat: latitude, lng: longitude };
                const locationText = `Emergency! My live location is being shared from LocalLife OS. Current coordinates: ${latitude}, ${longitude}. Map: https://maps.google.com/?q=${latitude},${longitude}`;
                native.share('location', { text: locationText, title: 'Live Location' });
            }, () => {
                showToast("Could not get location. Please enable location services.", "error");
            }
        );
    }
    function openTrustedCircleModal() {
        renderTrustedContacts();
        openModal('trustedCircleModal');
    }
    function renderTrustedContacts() {
        const listEl = document.getElementById('trustedContactsList');
        if (!listEl) return;
        listEl.innerHTML = '';
        if (trustedContacts.length === 0) {
            listEl.innerHTML = `<div class="setting-item"><span class="setting-label">No contacts added.</span></div>`;
        } else {
            trustedContacts.forEach(contact => {
                const itemEl = document.createElement('div');
                itemEl.className = 'setting-item';
                itemEl.innerHTML = `
                    <span class="setting-label">${contact.name} <span class="text-secondary">(${contact.phone})</span></span>
                    <button class="button danger" style="padding: 4px 8px; font-size: 0.8rem;" onclick="removeTrustedContact(${contact.id})">Remove</button>
                `;
                listEl.appendChild(itemEl);
            });
        }
    }
    function addTrustedContact() {
        const nameInput = document.getElementById('addContactName');
        const phoneInput = document.getElementById('addContactPhone');
        const name = nameInput.value.trim();
        const phone = phoneInput.value.trim();
        if (!name || !phone) {
            showToast("Please enter both name and phone number.", "error");
            return;
        }
        trustedContacts.push({ id: nextTrustedContactId++, name, phone });
        nameInput.value = '';
        phoneInput.value = '';
        renderTrustedContacts();
        saveTrustedContactsToLocalStorage();
        showToast("Trusted contact added.", "success");
    }
    function removeTrustedContact(contactId) {
        trustedContacts = trustedContacts.filter(c => c.id !== contactId);
        renderTrustedContacts();
        saveTrustedContactsToLocalStorage();
        showToast("Trusted contact removed.", "info");
    }
    function openCreateBulletinPostModal() {
        openModal('createBulletinPostModal');
    }
    function submitBulletinPost() {
        const title = document.getElementById('bulletinPostTitleInput').value.trim();
        const content = document.getElementById('bulletinPostContentInput').value.trim();
        const category = document.getElementById('bulletinPostCategorySelect').value;
        if (!title || !content) {
            showToast("Title and content are required.", "error");
            return;
        }
        const newPost = {
            id: nextBulletinPostId++,
            title: title,
            content: content,
            category: category,
            authorId: 'user',
            timestamp: new Date(),
            comments: []
        };
        bulletinPosts.unshift(newPost);
        closeModal('createBulletinPostModal');
        saveBulletinPostsToLocalStorage();
        const activeFilterButton = document.querySelector('#exploreFilterBar .filter-button.active');
        if (activeFilterButton && activeFilterButton.dataset.filter === 'bulletin') {
            renderPlaces('bulletin');
        }
        showToast("Bulletin post submitted.", "success");
        addXP(15, 'community');
    }
    const focusQuotes = [
        '"The secret of getting ahead is getting started." - Mark Twain',
        '"Concentrate all your thoughts upon the work at hand. The sun\'s rays do not burn until brought to a focus." - Alexander Graham Bell',
        '"The successful warrior is the average man, with laser-like focus." - Bruce Lee',
        '"That\'s been one of my mantras - focus and simplicity." - Steve Jobs'
    ];
    function openFocusModeModal() {
        const taskSelect = document.getElementById('focusTaskSelect');
        taskSelect.innerHTML = '<option value="">-- No Specific Task --</option>';
        tasks.filter(t => !t.completed).forEach(task => {
            const option = document.createElement('option');
            option.value = task.id;
            option.textContent = task.title;
            taskSelect.appendChild(option);
        });
        const nextTask = tasks.find(t => !t.completed);
        if (nextTask) taskSelect.value = nextTask.id;
        applyFocusModeChanges(true); 
        const timerEl = document.getElementById('focusSessionTimer');
        if(timerEl) timerEl.textContent = focusQuotes[0];
        focusQuoteInterval = setInterval(() => {
            if(timerEl) timerEl.textContent = focusQuotes[Math.floor(Math.random() * focusQuotes.length)];
        }, 8000);
        openModal('focusModeModal');
    }
    function stopFocusMode() {
        clearInterval(focusQuoteInterval);
        closeModal('focusModeModal');
        showToast("Focus mode ended.", "info");
    }
    function openEditFocusModeModal() {
        openModal('editFocusModeModal');
    }
    function applyFocusModeChanges(isInitial = false) {
        const taskId = document.getElementById('focusTaskSelect').value;
        const task = tasks.find(t => t.id == taskId);
        const taskLabel = document.getElementById('focusSessionTaskLabel');
        if (taskLabel) {
            taskLabel.textContent = task ? `Focusing on: "${task.title.substring(0, 30)}..."` : "General focus session.";
        }
        if (!isInitial) closeModal('editFocusModeModal');
    }
    function fetchNewsSummary() {
        const newsCard = document.getElementById('newsSummaryCard');
        const newsContent = document.getElementById('newsSummaryContent');
        if (!newsCard || !newsContent) return;
        if (!userSubscriptionTier.startsWith('pro')) {
            newsContent.innerHTML = `<div class="empty-state" style="padding:10px 0;">
                <i class="fas fa-lock"></i>
                <p>AI News Summary is a Pro feature.</p>
                <button class="button mt-2" style="font-size:0.8rem; padding: 4px 8px;" onclick="openSubscriptionModal()">Upgrade to Pro</button>
            </div>`;
            return;
        }
        const mockNews = [
            "Eswatini Electricity Company (EEC) announces Stage 2 load shedding for the week.",
            "Ministry of Health launches new vaccination drive in the Shiselweni region.",
            "Construction on the new Manzini-Mbabane highway bypass is ahead of schedule."
        ];
        newsContent.innerHTML = `<ul>${mockNews.map(item => `<li>${item}</li>`).join('')}</ul><p class="card-subtitle mt-2" style="font-size:0.8rem;">AI Summary of top Eswatini headlines.</p>`;
    }
    function openPrivacySettingsModal() {
        openModal('privacySettingsModal');
    }
    function openIntegrationSettingsModal() {
        renderIntegrationSettings();
        openModal('integrationSettingsModal');
    }
    function openDataImportModal() {
        openModal('dataImportModal');
    }
    function handleDataImport() {
        const fileInput = document.getElementById('importFileInput');
        const file = fileInput.files[0];
        if (!file) {
            showToast("Please select a JSON file to import.", "error");
            return;
        }
        const reader = new FileReader();
        reader.onload = (event) => {
            try {
                const importedData = JSON.parse(event.target.result);
                if (Array.isArray(importedData.tasks)) tasks = importedData.tasks;
                if (Array.isArray(importedData.habits)) habits = importedData.habits;
                if (Array.isArray(importedData.loggedMoods)) loggedMoods = importedData.loggedMoods;
                if (importedData.gamification) {
                    userLevel = importedData.gamification.userLevel || 1;
                    userXP = importedData.gamification.userXP || 0;
                    xpToNextLevel = importedData.gamification.xpToNextLevel || 100;
                    unlockedBadges = new Set(importedData.gamification.unlockedBadges || []);
                }
                if (importedData.settings) {
                    localStorage.setItem('darkMode', importedData.settings.darkMode);
                    localStorage.setItem('themeAccent', importedData.settings.themeAccent);
                    localStorage.setItem('aiPersonality', importedData.settings.aiPersonality);
                    localStorage.setItem('dashboardCardConfig', JSON.stringify(importedData.settings.dashboardConfig));
                    localStorage.setItem('notificationPreferences', JSON.stringify(importedData.settings.notificationPreferences));
                    localStorage.setItem('aiLearningPreferences', JSON.stringify(importedData.settings.aiLearningPreferences));
                }
                if (importedData.savedPlacesIds) {
                     mockPlaces.all.forEach(p => p.saved = importedData.savedPlacesIds.includes(p.id));
                }
                showToast("Data imported successfully! The app will now reload.", "success");
                setTimeout(() => window.location.reload(), 2000);
            } catch (error) {
                showToast("Invalid JSON file or incorrect format.", "error");
            }
        };
        reader.readAsText(file);
    }
    function openBulletinCommentsModal(postId) {
        const post = bulletinPosts.find(p => p.id === postId);
        if (!post) return;
        const modalTitle = document.getElementById('bulletinCommentsModalTitle');
        const commentsList = document.getElementById('bulletinCommentsList');
        const submitBtn = document.getElementById('bulletinCommentSubmit');
        modalTitle.textContent = `Comments on "${post.title.substring(0, 20)}..."`;
        commentsList.innerHTML = '';
        if (post.comments && post.comments.length > 0) {
            post.comments.forEach(comment => {
                 const senderDetails = mockUsers[comment.senderId] || mockUsers.defaultBot;
                 const bubble = document.createElement('div');
                 bubble.className = 'chat-message-wrapper other';
                 bubble.innerHTML = `
                    <img src="${senderDetails.avatarUrl}" alt="${senderDetails.name}" class="chat-avatar other-avatar" loading="lazy">
                    <div class="chat-bubble other">
                        <strong class="chat-sender-name">${senderDetails.name}</strong>
                        <div class="chat-bubble-text">${comment.text}</div>
                    </div>
                 `;
                 commentsList.appendChild(bubble);
            });
        } else {
            commentsList.innerHTML = `<div class="empty-state" style="padding:10px;"><p>No comments yet.</p></div>`;
        }
        submitBtn.onclick = () => submitBulletinComment(postId);
        openModal('bulletinCommentsModal');
    }
    function submitBulletinComment(postId) {
        const input = document.getElementById('bulletinCommentInput');
        const text = input.value.trim();
        if (!text) return;
        const post = bulletinPosts.find(p => p.id === postId);
        if (post) {
            if (!post.comments) post.comments = [];
            post.comments.push({ senderId: 'user', text: text, timestamp: new Date() });
            input.value = '';
            autoGrowTextarea(input);
            openBulletinCommentsModal(postId); 
            saveBulletinPostsToLocalStorage();
        }
    }
    function showDynamicIslandAlert(icon, text, duration = 4000) {
        if (!dynamicIsland) return;
        clearTimeout(dynamicIslandTimeout);
        document.getElementById('dynamicIslandIcon').className = `icon ${icon}`;
        document.getElementById('dynamicIslandText').textContent = text;
        dynamicIsland.classList.add('show');
        dynamicIslandTimeout = setTimeout(() => {
            dynamicIsland.classList.remove('show');
        }, duration);
    }
    const badges = {
        task_master: { icon: 'fa-clipboard-check', title: "Task Master", desc: "Complete 10 tasks." },
        planner_pro: { icon: 'fa-calendar-alt', title: "Planner Pro", desc: "Complete 50 tasks." },
        hydration_pro: { icon: 'fa-tint', title: "Hydration Pro", desc: "Maintain a 7-day water streak." },
        zen_master: { icon: 'fa-brain', title: "Zen Master", desc: "Maintain a 7-day meditation streak." },
        contributor: { icon: 'fa-plus-circle', title: "Contributor", desc: "Submit your first place or deal." },
        social_butterfly: { icon: 'fa-comments', title: "Social Butterfly", desc: "Join 5 channels." },
        focus_master: { icon: 'fa-stopwatch-20', title: "Focus Master", desc: "Complete a Focus Mode session." }
    };
    function addXP(amount, category) {
        userXP += amount;
        showToast(`+${amount} XP (${category})`, 'xp', 1500);
        if (userXP >= xpToNextLevel) {
            userLevel++;
            userXP -= xpToNextLevel;
            xpToNextLevel = Math.round(xpToNextLevel * 1.5);
            showDynamicIslandAlert('fas fa-arrow-up', `Level Up! You are now Level ${userLevel}!`);
            unlockBadge('task_master');
        }
        updateGamificationUI();
        saveGamificationDataToLocalStorage();
    }
    function unlockBadge(badgeId) {
        if (!unlockedBadges.has(badgeId)) {
            unlockedBadges.add(badgeId);
            const badge = badges[badgeId];
            showToast(`Badge Unlocked: ${badge.title}!`, 'xp', 4000);
            showDynamicIslandAlert(`fas ${badge.icon}`, `Badge Unlocked: ${badge.title}`);
            updateGamificationUI();
            saveGamificationDataToLocalStorage();
        }
    }
    function updateGamificationUI(context = 'all') {
        if(context === 'wellness' || context === 'all') {
            const wellnessLevelEl = document.getElementById('wellnessLevel');
            if (wellnessLevelEl) wellnessLevelEl.textContent = userLevel;
        }
        if(context === 'user' || context === 'all') {
            const userLevelEl = document.getElementById('userLevel');
            if (userLevelEl) userLevelEl.textContent = userLevel;
            const userXPEl = document.getElementById('userXP');
            if (userXPEl) userXPEl.textContent = userXP;
            const userXPToNextLevelEl = document.getElementById('userXPToNextLevel');
            if (userXPToNextLevelEl) userXPToNextLevelEl.textContent = xpToNextLevel;
            const xpBar = document.getElementById('userXPBar');
            if (xpBar) xpBar.style.width = `${(userXP / xpToNextLevel) * 100}%`;
            const badgesContainer = document.getElementById('userBadgesContainer');
            if (badgesContainer) {
                badgesContainer.innerHTML = '';
                unlockedBadges.forEach(badgeId => {
                    const badge = badges[badgeId];
                    if (badge) {
                        const badgeEl = document.createElement('div');
                        badgeEl.className = 'gamification-badge';
                        badgeEl.title = `${badge.title}: ${badge.desc}`;
                        badgeEl.innerHTML = `<i class="fas ${badge.icon}"></i>`;
                        badgesContainer.appendChild(badgeEl);
                    }
                });
            }
        }
    }
    function renderApplets() {
        const container = document.getElementById('appletStoreContainer');
        if (!container) return;
        container.innerHTML = ''; 
        mockApplets.forEach(applet => {
            const card = document.createElement('div');
            card.className = 'applet-card';
            card.innerHTML = `
                <div class="applet-header">
                    <div class="applet-icon" style="background-color: ${applet.color};"><i class="${applet.icon}"></i></div>
                    <h4 class="applet-title">${applet.name}</h4>
                </div>
                <p class="applet-desc">${applet.desc}</p>
                <div class="applet-ai-insight"><i class="fas fa-brain"></i> AI suggests this for users interested in 'community' and 'productivity'.</div>
                <div class="applet-actions">
                    <button class="button install-button ${applet.installed ? 'danger' : ''}" data-applet-id="${applet.id}" onclick="handleAppletInstallToggle(this, '${applet.id}')">
                        <span class="button-text">${applet.installed ? 'Uninstall' : 'Install'}</span>
                        <div class="loader"></div>
                    </button>
                </div>
            `;
            container.appendChild(card);
        });
    }
    function renderInstalledAppletsOnDashboard() {
        const container = document.getElementById('dashboardAppletsContainer');
        if (!container) return;
        const installed = mockApplets.filter(a => a.installed);
        if (installed.length === 0) {
            container.innerHTML = `<p class="card-subtitle">No applets installed. Visit the Applet Store in Settings to add more functionality!</p>`;
            return;
        }
        let html = '<div class="wellness-tools-grid">';
        installed.forEach(applet => {
            html += `
                <button class="wellness-tool-card" onclick="launchApplet('${applet.id}')">
                    <i class="${applet.icon}" style="color:${applet.color};"></i>
                    <span class="tool-title">${applet.name}</span>
                </button>
            `;
        });
        html += '</div>';
        container.innerHTML = html;
    }
    function handleAppletInstallToggle(button, appletId) {
        const applet = mockApplets.find(a => a.id === appletId);
        if (!applet) return;
        const buttonText = button.querySelector('.button-text');
        button.classList.add('loading');
        button.disabled = true;
        setTimeout(() => {
            applet.installed = !applet.installed;
            button.classList.remove('loading');
            button.disabled = false;
            button.classList.toggle('danger', applet.installed);
            buttonText.textContent = applet.installed ? 'Uninstall' : 'Install';
            showToast(`${applet.name} ${applet.installed ? 'installed' : 'uninstalled'}!`, 'success');
            saveAppletsToLocalStorage();
            renderInstalledAppletsOnDashboard();
        }, 1500);
    }
    function renderPrivacyDashboard() {
        const container = document.getElementById('privacyDashboardContent');
        if (!container) return;
        const privacyScore = calculatePrivacyScore();
        const scoreColor = privacyScore > 75 ? 'var(--success-color)' : privacyScore > 40 ? 'var(--favorite-color)' : 'var(--danger-color)';
        container.innerHTML = `
            <article class="card">
                <h3 class="card-title">Your Privacy Score</h3>
                <div class="privacy-score-container">
                    <div class="privacy-score-dial">
                        <svg viewBox="0 0 36 36">
                            <path class="dial-bg" d="M18 2.0845 a 15.9155 15.9155 0 0 1 0 31.831 a 15.9155 15.9155 0 0 1 0 -31.831" />
                            <path class="dial-value" id="privacyScoreDial" stroke-dasharray="${privacyScore}, 100" d="M18 2.0845 a 15.9155 15.9155 0 0 1 0 31.831 a 15.9155 15.9155 0 0 1 0 -31.831" />
                        </svg>
                        <div id="privacyScoreText" class="privacy-score-text">${privacyScore}</div>
                    </div>
                    <p class="card-subtitle">This score reflects how your privacy settings are configured. Higher is better.</p>
                    <button class="button mt-2" style="width:100%;" onclick="openPrivacySettingsModal()">Privacy & Security Settings</button>
                </div>
            </article>
            <article class="card">
                <h3 class="card-title">Data Usage by Module</h3>
                <div class="data-usage-bar">
                    <div class="label">Planner</div>
                    <div class="bar-container"><div class="bar-fill" style="width: 70%;"></div></div>
                </div>
                <div class="data-usage-bar">
                    <div class="label">Explore</div>
                    <div class="bar-container"><div class="bar-fill" style="width: 90%; background-color: var(--muted-terracotta);"></div></div>
                </div>
                 <div class="data-usage-bar">
                    <div class="label">Wellness</div>
                    <div class="bar-container"><div class="bar-fill" style="width: 50%; background-color: var(--soft-blue);"></div></div>
                </div>
                <p class="card-subtitle mt-2" style="font-size:0.8rem;">Data access frequency. You control what the AI can see.</p>
            </article>
            <article class="card">
                <h3 class="card-title">AI Awareness Map (What I've Learned)</h3>
                <div id="aiMemoryList" class="settings-list" style="padding:0;"></div>
            </article>
        `;
        document.getElementById('privacyScoreDial').style.stroke = scoreColor;
        document.getElementById('privacyScoreText').style.color = scoreColor;
        renderAIMemoryList();
    }
    function calculatePrivacyScore() {
        let score = 100;
        if(aiLearningPreferences.learnSavedPlaces) score -= 10;
        if(aiLearningPreferences.learnMoodLogs) score -= 15;
        if(aiLearningPreferences.learnTaskPatterns) score -= 10;
        if(aiLearningPreferences.learnHabitTracking) score -= 10;
        if(aiLearningPreferences.learnChatStyle) score -= 5;
        return Math.max(0, score);
    }
    function renderAIMemoryList() {
        const container = document.getElementById('aiMemoryList');
        if(!container) return;
        container.innerHTML = '';
        let memories = [];
        if(aiLearningPreferences.learnSavedPlaces) {
            const savedPlace = mockPlaces.all.find(p => p.saved);
            if(savedPlace) memories.push(`You like the place: <strong>${savedPlace.name}</strong>.`);
        }
         if(aiLearningPreferences.learnMoodLogs) {
            const lastMood = loggedMoods[loggedMoods.length -1];
            if(lastMood) memories.push(`Your last logged mood was: ${lastMood.mood}`);
        }
         if(aiLearningPreferences.learnTaskPatterns) {
            const workTasks = tasks.filter(t => t.category === 'work').length;
            if(workTasks > 2) memories.push(`You seem to have many <strong>work-related</strong> tasks.`);
        }
        if(memories.length === 0) {
            container.innerHTML = `<div class="setting-item"><span class="setting-label">AI hasn't learned any specific preferences yet.</span></div>`;
        } else {
            memories.forEach(mem => {
                const item = document.createElement('div');
                item.className = 'ai-memory-item';
                item.innerHTML = `<span class="ai-memory-text">${mem}</span> <button class="button danger" style="padding: 2px 6px; font-size: 0.7rem;" onclick="showToast('AI will forget this preference.', 'info')">Forget</button>`;
                container.appendChild(item);
            });
        }
    }
    function openFeedbackModal() {
        trackUserAction(`Opened Feedback Modal`);
        let modalBody = `
            <p>Help us improve LocalLife OS! Please describe the issue you encountered.</p>
            <div class="input-group">
                <label for="feedbackType">Type of Issue</label>
                <select id="feedbackType" class="input-field">
                    <option value="bug">Bug Report</option>
                    <option value="suggestion">Feature Suggestion</option>
                    <option value="ui_ux">UI/UX Feedback</option>
                    <option value="other">Other</option>
                </select>
            </div>
            <div class="input-group">
                <label for="feedbackContent">Description*</label>
                <textarea id="feedbackContent" class="input-field" rows="4" placeholder="e.g., The add task button did not work when I..." required></textarea>
            </div>
            <div class="input-group">
                <label for="feedbackScreenshot">Screenshot (Optional)</label>
                <input type="file" id="feedbackScreenshot" class="input-field" accept="image/*">
            </div>
            <div class="input-group">
                <label>Diagnostic Info (Auto-attached)</label>
                <p class="card-subtitle" style="background-color:var(--placeholder-bg); padding:var(--space-sm); border-radius: var(--border-radius-sm); font-size:0.8rem;">
                    <strong>Last Action:</strong> ${lastUserAction}<br>
                    <strong>Version:</strong> v12.0
                </p>
            </div>
            <button class="button mt-2" style="width:100%" onclick="submitFeedback()">Submit Feedback</button>
        `;
        openGenericModal("Assist & Report Bug", modalBody);
    }
    function submitFeedback() {
        const feedback = document.getElementById('feedbackContent')?.value.trim();
        if(!feedback) {
            showToast("Please provide a description of the issue.", "error");
            return;
        }
        showToast("Thank you! Your feedback has been submitted.", "success");
        closeModal('genericModal');
    }
    function updateSubscriptionStatusUI() {
        const statusEl = document.getElementById('subscriptionStatus');
        if (statusEl) {
            let tierText = "Free";
            if (userSubscriptionTier === 'pro') tierText = "Pro Tier";
            else if (userSubscriptionTier === 'pro_plus') tierText = "Pro+ Tier";
            statusEl.textContent = tierText;
        }
        const newsCard = document.getElementById('newsSummaryCard');
        if (newsCard) {
            fetchNewsSummary(); 
        }
        const personalitySelect = document.getElementById('aiPersonalitySelect');
        if (personalitySelect) {
            Array.from(personalitySelect.options).forEach(option => {
                if (option.text.includes('(Pro)')) {
                    option.disabled = !userSubscriptionTier.startsWith('pro');
                }
            });
            if (currentAiPersonality.endsWith('(Pro)') && !userSubscriptionTier.startsWith('pro')) {
                changeAIPersonality('neutral');
                personalitySelect.value = 'neutral';
            }
        }
    }
    function openSubscriptionModal() {
        const modal = document.getElementById('subscriptionModal');
        if (!modal) return;
        document.querySelectorAll('.tier-card').forEach(card => card.classList.remove('active-plan'));
        const activeCard = document.getElementById(`tier-${userSubscriptionTier.replace('_plus', '-plus')}`);
        if (activeCard) {
            activeCard.classList.add('active-plan');
            const button = activeCard.querySelector('button');
            if (button) {
                button.textContent = "Current Plan";
                button.disabled = true;
            }
        }
        document.querySelectorAll('.tier-card button').forEach(button => {
            const tier = button.dataset.tier;
            if (tier && tier !== userSubscriptionTier) {
                const tierOrder = { free: 0, pro: 1, pro_plus: 2 };
                const currentTierLevel = tierOrder[userSubscriptionTier];
                const buttonTierLevel = tierOrder[tier];
                if (buttonTierLevel > currentTierLevel) {
                    button.textContent = `Upgrade to ${tier.replace('_', '+').replace(/^\w/, c => c.toUpperCase())}`;
                    button.disabled = false;
                } else {
                    button.textContent = `Downgrade to ${tier.replace('_', '+').replace(/^\w/, c => c.toUpperCase())}`;
                    button.disabled = false;
                }
            }
        });
        openModal('subscriptionModal');
    }
    function handleSubscriptionChange(newTier) {
        userSubscriptionTier = newTier;
        saveSubscriptionToLocalStorage();
        updateSubscriptionStatusUI();
        closeModal('subscriptionModal');
        showToast(`Successfully subscribed to ${newTier.replace('_', '+').replace(/^\w/, c => c.toUpperCase())} tier! Features unlocked.`, 'success');
    }
    const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
    let recognition;
    if (SpeechRecognition) {
        recognition = new SpeechRecognition();
        recognition.continuous = false;
        recognition.lang = 'en-US';
        recognition.interimResults = false;
        recognition.maxAlternatives = 1;
    }
    function startVoiceRecognition(targetInputId, callback) {
        if (!SpeechRecognition) {
            showToast("Voice recognition is not supported by your browser.", "error");
            return;
        }
        const targetInput = document.getElementById(targetInputId);
        if (!targetInput) return;
        showToast("Listening...", "ai_info", 3000);
        recognition.start();
        recognition.onresult = (event) => {
            const transcript = event.results[0][0].transcript;
            targetInput.value = transcript;
            showToast(`AI heard: "${transcript}"`, "success");
            if (callback && typeof callback === 'function') {
                callback(true); 
            }
        };
        recognition.onspeechend = () => {
            recognition.stop();
        };
        recognition.onerror = (event) => {
            showToast(`Error occurred in recognition: ${event.error}`, "error");
        };
    }
    function speakText(text) {
        if ('speechSynthesis' in window) {
            const utterance = new SpeechSynthesisUtterance(text);
            utterance.pitch = 1;
            utterance.rate = 1;
            window.speechSynthesis.speak(utterance);
        } else {
            showToast("Text-to-speech is not supported by your browser.", "error");
        }
    }
    function shareContent(type, data = {}) {
        let shareData = {
            title: 'LocalLife OS',
            text: 'Check this out from LocalLife OS!',
            url: window.location.href
        };
        if (type === 'place' && currentOpenModalId === 'placeDetailModal') {
            const placeName = document.getElementById('modalPlaceName').textContent;
            shareData.text = `Check out this cool place I found on LocalLife OS: ${placeName}`;
        } else if (type === 'deal' && currentOpenModalId === 'dealDetailModal') {
            const dealTitle = document.getElementById('modalDealTitle').textContent;
            shareData.text = `Check out this great deal on LocalLife OS: ${dealTitle}`;
        } else if (type === 'location') {
            shareData.title = data.title || 'My Live Location';
            shareData.text = data.text;
        } else if (type === 'bulletin' && data) {
            shareData.title = `Bulletin Post: ${data.title}`;
            shareData.text = data.content;
        }
        if (navigator.share) {
            navigator.share(shareData);
        } else {
            showToast("Web Share API not supported. Cannot share natively.", "error");
        }
    }
    function scheduleTaskNotification(task) {
        if (!notificationPreferences.taskReminders || !task.dueDate || !task.time || task.completed) return;
        const timeMatch = task.time.match(/(\d{1,2}):?(\d{2})?\s*(am|pm)/i);
        if (!timeMatch) return;
        let hour = parseInt(timeMatch[1]);
        const minute = parseInt(timeMatch[2] || '0');
        const isPM = timeMatch[3].toLowerCase() === 'pm';
        if (isPM && hour < 12) hour += 12;
        if (!isPM && hour === 12) hour = 0;
        const taskDate = new Date(task.dueDate);
        taskDate.setHours(hour, minute, 0, 0);
        const timeToTask = taskDate.getTime() - Date.now();
        if (timeToTask > 0) {
            setTimeout(() => {
                const taskStillExists = tasks.find(t => t.id === task.id && !t.completed);
                if (taskStillExists) {
                    native.showNotification('Task Reminder', {
                        body: task.title,
                        icon: 'https://via.placeholder.com/192/4DB6AC/FFFFFF?text=LL' 
                    });
                }
            }, timeToTask);
        }
    }
    function checkTaskReminders() {
        tasks.forEach(task => {
            if (!task.completed && task.dueDate && task.time) {
                const timeMatch = task.time.match(/(\d{1,2}):?(\d{2})?\s*(am|pm)/i);
                if (timeMatch) {
                    let hour = parseInt(timeMatch[1]);
                    const minute = parseInt(timeMatch[2] || '0');
                    const isPM = timeMatch[3].toLowerCase() === 'pm';
                    if (isPM && hour < 12) hour += 12;
                    if (!isPM && hour === 12) hour = 0;
                    const now = new Date();
                    const taskDate = new Date(task.dueDate);
                    taskDate.setHours(hour, minute, 0, 0);
                    if (taskDate > now && (taskDate.getTime() - now.getTime() < 5 * 60 * 1000) && !task.notified) {
                        native.showNotification('Upcoming Task', { body: `Reminder: ${task.title} is starting soon.`});
                        task.notified = true;
                    }
                }
            }
        });
    }
    function updateLiveLocationInfo() {
        native.geolocation.getCurrent(
            position => {
                const lat = position.coords.latitude;
                const lng = position.coords.longitude;
                userLocationCoords = { lat, lng };
                const geocoder = new google.maps.Geocoder();
                geocoder.geocode({ location: { lat, lng } }, (results, status) => {
                    if (status === "OK" && results[0]) {
                        const address = results[0].formatted_address;
                        document.getElementById('currentLocation').textContent = address.split(',').slice(0, 2).join(',');
                    } else {
                         document.getElementById('currentLocation').textContent = `Lat: ${lat.toFixed(4)}, Lng: ${lng.toFixed(4)}`;
                    }
                });
                fetch(`https://api.openweathermap.org/data/2.5/weather?lat=${lat}&lon=${lng}&appid=${OPENWEATHER_API_KEY}&units=metric`)
                    .then(response => response.json())
                    .then(data => {
                        const temp = Math.round(data.main.temp);
                        const description = data.weather[0].description;
                        const city = data.name;
                        document.getElementById('currentWeather').textContent = `${temp}C, ${description} - ${city}`;
                    }).catch(() => {
                        document.getElementById('currentWeather').textContent = `Weather data unavailable`;
                    });
            },
            () => {
                document.getElementById('currentLocation').textContent = 'Eswatini (Location access denied)';
                document.getElementById('currentWeather').textContent = `Weather unavailable`;
            }
        );
    }
    function handleAvatarUpload(event) {
        const file = event.target.files[0];
        if (file) {
            const reader = new FileReader();
            reader.onload = (e) => {
                const avatarImg = document.getElementById('userProfileAvatar');
                avatarImg.src = e.target.result;
                mockUsers['user'].avatarUrl = e.target.result;
                saveUsersToLocalStorage();
                showToast("Avatar updated!", "success");
            };
            reader.readAsDataURL(file);
        }
    }
    function launchApplet(appletId) {
        if (appletId === 'loadShedding') {
            renderLoadSheddingApplet();
            openModal('applet-loadShedding-modal');
        } else if (appletId === 'localRideshare' || appletId === 'groupExpense' || appletId === 'siswatiTutor') {
            openModal(`applet-${appletId}-modal`);
        } else {
            showToast(`Launching ${appletId} applet...`, 'ai_info');
        }
    }
    function useCurrentLocationForRide() {
        const pickupInput = document.getElementById('ride-pickup');
        if(!pickupInput) return;
        showToast("Getting current location...", "ai_info");
        native.geolocation.getCurrent(
            position => {
                pickupInput.value = `Lat: ${position.coords.latitude.toFixed(4)}, Lng: ${position.coords.longitude.toFixed(4)}`;
                checkRideInputs();
            },
            () => { showToast("Could not get location.", "error"); }
        );
    }
    function addExpenseParticipant() {
        const list = document.getElementById('expense-participant-list');
        const count = list.children.length + 1;
        const input = document.createElement('input');
        input.type = 'text';
        input.className = 'input-field mb-1';
        input.placeholder = `Participant ${count}`;
        list.appendChild(input);
    }
    function calculateSplit() {
        const amount = parseFloat(document.getElementById('expense-amount').value) || 0;
        const tipPercent = parseFloat(document.getElementById('expense-tip').value) || 0;
        const participantInputs = document.querySelectorAll('#expense-participant-list input');
        const participants = Array.from(participantInputs).map(input => input.value.trim()).filter(Boolean);
        const resultEl = document.getElementById('split-result');
        if (amount <= 0 || participants.length === 0) {
            resultEl.innerHTML = `<p class="text-center" style="color:var(--danger-color);">Please enter a valid amount and at least one participant.</p>`;
            return;
        }
        const tipAmount = amount * (tipPercent / 100);
        const totalAmount = amount + tipAmount;
        const splitAmount = totalAmount / participants.length;
        
        let resultHtml = `
            <p><strong>Total Bill:</strong> E ${amount.toFixed(2)}</p>
            <p><strong>Tip (${tipPercent}%):</strong> E ${tipAmount.toFixed(2)}</p>
            <h4 class="mt-2">Total to Pay: E ${totalAmount.toFixed(2)}</h4>
            <ul class="settings-list mt-2" style="padding:0;">
        `;
        participants.forEach(name => {
            resultHtml += `<li class="setting-item">${name} pays: <strong style="color:var(--primary-accent);">E ${splitAmount.toFixed(2)}</strong></li>`;
        });
        resultHtml += '</ul><button class="button button-secondary mt-2" style="width:100%;" onclick="shareSplitResults()">Share Results</button>';
        resultEl.innerHTML = resultHtml;
    }
    function shareSplitResults() {
        const resultEl = document.getElementById('split-result');
        if (resultEl) {
            native.share('split', { title: 'Expense Split', text: resultEl.innerText });
        }
    }
    function renderIntegrationSettings() {
        const listEl = document.getElementById('integrationSettingsList');
        if (!listEl) return;
        listEl.innerHTML = '';
        integratedApps.forEach(app => {
            const itemEl = document.createElement('div');
            itemEl.className = 'setting-item';
            itemEl.innerHTML = `
                <span class="setting-label"><i class="${app.icon}" style="margin-right:var(--space-sm);"></i> ${app.name}</span>
                <button class="toggle-switch-button" data-app-id="${app.id}" onclick="toggleAppIntegration(this, '${app.id}')">
                    <span class="toggle-switch ${app.connected ? 'active' : ''}"></span>
                </button>
            `;
            listEl.appendChild(itemEl);
        });
    }
    function toggleAppIntegration(button, appId) {
        const app = integratedApps.find(a => a.id === appId);
        if(app) {
            app.connected = !app.connected;
            button.querySelector('.toggle-switch').classList.toggle('active', app.connected);
            showToast(`${app.name} ${app.connected ? 'connected' : 'disconnected'}.`, 'success');
            if (app.connected) {
                showToast(`AI can now use your ${app.name} data for richer suggestions (e.g., creating playlists, analyzing workouts).`, 'ai_info', 4000);
            }
            saveIntegratedAppsToLocalStorage();
        }
    }
    function addAppIntegration() {
        const input = document.getElementById('newAppIntegrationInput');
        const appName = input.value.trim();
        if(!appName) {
            showToast("Please enter an app name.", "error");
            return;
        }
        const newApp = { id: appName.toLowerCase().replace(/\s/g, '_'), name: appName, icon: 'fas fa-puzzle-piece', connected: false };
        if (integratedApps.some(app => app.id === newApp.id)) {
            showToast(`${appName} is already in the list.`, 'info');
            return;
        }
        integratedApps.push(newApp);
        renderIntegrationSettings();
        input.value = '';
        showToast(`${appName} added. You can now connect it.`, 'success');
        saveIntegratedAppsToLocalStorage();
    }
    function initMap() {
        const mapContainer = document.getElementById('map-container');
        if (!mapContainer || typeof google === 'undefined' || !google.maps) return;
        const defaultLocation = { lat: -26.3056, lng: 31.1428 }; 
        const isDarkMode = document.body.classList.contains('dark-mode');
        const mapStyles = isDarkMode ? [ { "elementType": "geometry", "stylers": [ { "color": "#242f3e" } ] }, { "elementType": "labels.text.fill", "stylers": [ { "color": "#746855" } ] }, { "elementType": "labels.text.stroke", "stylers": [ { "color": "#242f3e" } ] }, { "featureType": "administrative.locality", "elementType": "labels.text.fill", "stylers": [ { "color": "#d59563" } ] }, { "featureType": "poi", "elementType": "labels.text.fill", "stylers": [ { "color": "#d59563" } ] }, { "featureType": "poi.park", "elementType": "geometry", "stylers": [ { "color": "#263c3f" } ] }, { "featureType": "poi.park", "elementType": "labels.text.fill", "stylers": [ { "color": "#6b9a76" } ] }, { "featureType": "road", "elementType": "geometry", "stylers": [ { "color": "#38414e" } ] }, { "featureType": "road", "elementType": "geometry.stroke", "stylers": [ { "color": "#212a37" } ] }, { "featureType": "road", "elementType": "labels.text.fill", "stylers": [ { "color": "#9ca5b3" } ] }, { "featureType": "road.highway", "elementType": "geometry", "stylers": [ { "color": "#746855" } ] }, { "featureType": "road.highway", "elementType": "geometry.stroke", "stylers": [ { "color": "#1f2835" } ] }, { "featureType": "road.highway", "elementType": "labels.text.fill", "stylers": [ { "color": "#f3d19c" } ] }, { "featureType": "transit", "elementType": "geometry", "stylers": [ { "color": "#2f3948" } ] }, { "featureType": "transit.station", "elementType": "labels.text.fill", "stylers": [ { "color": "#d59563" } ] }, { "featureType": "water", "elementType": "geometry", "stylers": [ { "color": "#17263c" } ] }, { "featureType": "water", "elementType": "labels.text.fill", "stylers": [ { "color": "#515c6d" } ] }, { "featureType": "water", "elementType": "labels.text.stroke", "stylers": [ { "color": "#17263c" } ] } ] : [];

        map = new google.maps.Map(mapContainer, {
            center: defaultLocation, zoom: 11, disableDefaultUI: true, styles: mapStyles,
        });
        native.geolocation.getCurrent(position => {
            const userLocation = { lat: position.coords.latitude, lng: position.coords.longitude };
            userLocationCoords = userLocation;
            map.setCenter(userLocation);
            if(currentPositionMarker) currentPositionMarker.setMap(null);
            currentPositionMarker = new google.maps.Marker({
                position: userLocation, map: map, title: "Your Location",
                icon: { path: google.maps.SymbolPath.CIRCLE, scale: 7, fillColor: '#4285F4', fillOpacity: 1, strokeWeight: 2, strokeColor: 'white' }
            });
            updateLiveLocationInfo();
            updateNearbyPulse();
        }, () => {
             updateLiveLocationInfo();
             updateNearbyPulse();
        });
        updateMapMarkers(mockPlaces.all);
    }
    function updateMapMarkers(placesToShow) {
        if (!map) return;
        mapMarkers.forEach(marker => marker.setMap(null));
        mapMarkers = [];
        const bounds = new google.maps.LatLngBounds();
        
        placesToShow.forEach(place => {
            if (!place.position) return;
            const marker = new google.maps.Marker({
                position: place.position,
                map: map,
                title: place.name
            });
             const infowindow = new google.maps.InfoWindow({ content: `<strong>${place.name}</strong><br><button onclick="showPlaceDetailById(${place.id})">View Details</button>` });
             marker.addListener('click', () => { infowindow.open(map, marker); });
             mapMarkers.push(marker);
             bounds.extend(place.position);
        });

        if (placesToShow.length === 1 && placesToShow[0].position) {
            map.setCenter(placesToShow[0].position);
            map.setZoom(15);
        } else if (placesToShow.length > 1) {
            map.fitBounds(bounds);
        }
    }
    function showPlaceDetailById(placeId) {
        const place = mockPlaces.all.find(p => p.id === placeId);
        if (place) {
            showPlaceDetail(place);
        }
    }
    function getDirections(destination, origin = null) {
        let url;
        if (origin) {
            url = `https://www.google.com/maps/dir/?api=1&origin=${encodeURIComponent(origin)}&destination=${encodeURIComponent(destination)}`;
        } else {
            url = `https://www.google.com/maps/dir/?api=1&destination=${encodeURIComponent(destination)}`;
        }
        window.open(url, '_blank');
        showToast("Opening Google Maps for directions...", "ai_info");
    }
    function openArView() {
        openModal('arViewModal');
        const arVideo = document.getElementById('arVideo');
        const arOverlay = document.getElementById('arOverlay');
        if (navigator.mediaDevices && navigator.mediaDevices.getUserMedia) {
            navigator.mediaDevices.getUserMedia({ video: { facingMode: "environment" } })
                .then(stream => { 
                    arVideo.srcObject = stream; 
                    setTimeout(() => {
                        const nearbyPlace = mockPlaces.all[0]; 
                        arOverlay.innerHTML = `<h4><i class="fas fa-store"></i> ${nearbyPlace.name}</h4><p>${nearbyPlace.sub} - ${nearbyPlace.rating} <i class="fas fa-star" style="color:var(--favorite-color);"></i></p>`;
                    }, 3000);
                })
                .catch(() => {
                    showToast("Could not access camera for AR view.", "error");
                    closeModal('arViewModal');
                });
        }
    }
    function openAILayersModal() { openModal('aiLayersModal'); }
    function applyAILayer(layerType) {
        closeModal('aiLayersModal');
        clearAILayers();
        if (layerType === 'reset') {
            showToast("Map layers reset to default.", "info");
            return;
        }
        showToast(`Applying AI Layer: ${layerType}`, "ai_info");
        switch (layerType) {
            case 'heatmap':
                const heatmapData = mockPlaces.all.map(p => ({ location: new google.maps.LatLng(p.position.lat, p.position.lng), weight: p.rating }));
                heatmap = new google.maps.visualization.HeatmapLayer({ data: heatmapData, map: map, radius: 20 });
                break;
            case 'danger':
                mapPolygons.push(new google.maps.Polygon({
                    paths: [{lat: -26.495, lng: 31.375}, {lat: -26.500, lng: 31.378}, {lat: -26.498, lng: 31.380}],
                    strokeColor: "#FF0000", strokeWeight: 0, fillColor: "#FF0000", fillOpacity: 0.35, map: map
                }));
                break;
            case 'quiet':
                mockPlaces.all.filter(p=>p.tags.includes('scenic')).forEach(p => {
                    mapPolygons.push(new google.maps.Circle({
                        strokeColor: 'var(--soft-blue)', strokeOpacity: 0.8, strokeWeight: 2,
                        fillColor: 'var(--soft-blue)', fillOpacity: 0.35, map: map,
                        center: p.position, radius: 200
                    }));
                });
                break;
        }
    }
    function clearAILayers() {
        if(heatmap) heatmap.setMap(null);
        mapPolygons.forEach(p => p.setMap(null));
        mapPolygons = [];
    }
    function findNearbyHelp() {
        setActiveScreen('explore');
        setTimeout(() => {
            const searchInput = document.getElementById('exploreSearchInput');
            if (searchInput) searchInput.value = "hospital, police station";
            handleExploreSearch(true);
        }, 100);
        showToast("Searching for nearby emergency services...", "ai_info");
        closeModal('emergencyDashboardModal');
    }
    function createCalendarEvent(task = null) {
        let currentTask = task;
        if (!currentTask) {
            const taskId = parseInt(document.getElementById('editingTaskId')?.value);
            if (taskId) {
                currentTask = tasks.find(t => t.id === taskId);
            }
        }
        if (!currentTask) {
            showToast("No task selected to add to calendar.", "error");
            return;
        }
        let startDate, endDate;
        if (currentTask.dueDate) {
            const date = new Date(currentTask.dueDate);
            let startTime = [9, 0]; 
            let endTime = [10, 0]; 

            const timeMatch = currentTask.time.match(/(\d{1,2}):?(\d{2})?\s*(am|pm)/i);
            if (timeMatch) {
                let hour = parseInt(timeMatch[1]);
                let minute = parseInt(timeMatch[2] || '0');
                const isPM = timeMatch[3] && timeMatch[3].toLowerCase() === 'pm';
                if (isPM && hour < 12) hour += 12;
                if (!isPM && hour === 12) hour = 0;
                startTime = [hour, minute];
                endTime = [hour + 1, minute];
            }
            startDate = new Date(date.getFullYear(), date.getMonth(), date.getDate(), startTime[0], startTime[1]);
            endDate = new Date(date.getFullYear(), date.getMonth(), date.getDate(), endTime[0], endTime[1]);
        } else {
            const tomorrow = new Date();
            tomorrow.setDate(tomorrow.getDate() + 1);
            startDate = new Date(tomorrow.getFullYear(), tomorrow.getMonth(), tomorrow.getDate(), 9, 0);
            endDate = new Date(tomorrow.getFullYear(), tomorrow.getMonth(), tomorrow.getDate(), 10, 0);
        }

        const formatDateForGoogle = (date) => date.toISOString().replace(/-|:|\.\d+/g, '');
        
        const googleCalendarUrl = `https://www.google.com/calendar/render?action=TEMPLATE&text=${encodeURIComponent(currentTask.title)}&dates=${formatDateForGoogle(startDate)}/${formatDateForGoogle(endDate)}&details=${encodeURIComponent(currentTask.notes || 'Added from LocalLife OS')}`;
        
        const appleCalendarUrl = `data:text/calendar;charset=utf8,BEGIN:VCALENDAR%0AVERSION:2.0%0ABEGIN:VEVENT%0AURL:${encodeURIComponent(window.location.href)}%0ADTSTART:${formatDateForGoogle(startDate)}%0ADTEND:${formatDateForGoogle(endDate)}%0ASUMMARY:${encodeURIComponent(currentTask.title)}%0ADESCRIPTION:${encodeURIComponent(currentTask.notes || 'Added from LocalLife OS')}%0AEND:VEVENT%0AEND:VCALENDAR`;

        openConfirmationModal(
            "Add to Calendar",
            `<p>Choose your calendar provider to add the event: "<strong>${currentTask.title}</strong>".</p>
             <div style="display:flex; flex-direction:column; gap:var(--space-sm); margin-top:var(--space-md);">
                <a href="${googleCalendarUrl}" target="_blank" class="button" style="text-decoration:none;"><i class="fab fa-google" style="margin-right:var(--space-sm);"></i> Google Calendar</a>
                <a href="${appleCalendarUrl}" download="event.ics" class="button button-secondary" style="text-decoration:none;"><i class="fab fa-apple" style="margin-right:var(--space-sm);"></i> Apple Calendar (.ics)</a>
             </div>`,
            () => {  }
        );
        const confirmButton = document.getElementById('confirmActionButton');
        if (confirmButton) confirmButton.style.display = 'none'; 
    }
    function toggleBiometricLock(button) {
        if (!userSubscriptionTier.startsWith('pro')) {
            showToast("Biometric Lock is a Pro feature.", "info");
            openSubscriptionModal();
            return;
        }
        const visualSwitch = button.querySelector('.toggle-switch');
        const isEnabled = !visualSwitch.classList.contains('active');
        visualSwitch.classList.toggle('active', isEnabled);
        localStorage.setItem('biometricLockEnabled', isEnabled);
        showToast(`Biometric Lock ${isEnabled ? 'enabled' : 'disabled'}.`, 'success');
        if (isEnabled) {
            isAppLocked = true;
            lockScreen.classList.remove('hidden');
        }
    }
    function unlockApp() {
        showToast("Authenticating...", "ai_info");
        native.authenticate((success) => {
            if (success) {
                isAppLocked = false;
                lockScreen.classList.add('hidden');
                showToast("Unlocked!", "success");
            } else {
                showToast("Authentication Failed", "error");
            }
        });
    }

    const siswatiVocabulary = [
        { en: "Hello", si: "Sawubona" }, { en: "How are you?", si: "Unjani?" }, { en: "I am fine", si: "Ngiyaphila" },
        { en: "Thank you", si: "Ngiyabonga" }, { en: "Yes", si: "Yebo" }, { en: "No", si: "Cha" },
        { en: "Water", si: "Emanti" }, { en: "Food", si: "Kudla" }, { en: "Please", si: "Ngicela" },
        { en: "Goodbye", si: "Sala kahle" }, { en: "Man", si: "Indvodza" }, { en: "Woman", si: "Umfati" },
        { en: "Sun", si: "Lilanga" }, { en: "Home", si: "Likhaya" }
    ];
    let siswatiQuizState = { score: 0, total: 0, mode: null };
    
    function setupSiswatiTutor() {
        const contentEl = document.getElementById('siswatiTutorContent');
        if(!contentEl) return;
        siswatiQuizState.score = 0;
        siswatiQuizState.total = 0;
        contentEl.innerHTML = `
            <h4 class="card-title text-center">Choose a Quiz Mode</h4>
            <div class="quiz-mode-selection mt-3">
                <button class="button" onclick="startSiswatiQuiz('en_to_si')">English to SiSwati</button>
                <button class="button" onclick="startSiswatiQuiz('si_to_en')">SiSwati to English</button>
            </div>
        `;
    }

    function startSiswatiQuiz(mode) {
        siswatiQuizState.mode = mode;
        const words = [...siswatiVocabulary].sort(() => 0.5 - Math.random()).slice(0, 4);
        const correctWord = words[Math.floor(Math.random() * words.length)];
        siswatiQuizState.correctAnswer = correctWord;

        const contentEl = document.getElementById('siswatiTutorContent');
        if(!contentEl) return;

        const questionWord = mode === 'en_to_si' ? correctWord.en : correctWord.si;
        const options = words.map(word => mode === 'en_to_si' ? word.si : word.en);

        let optionsHtml = options.map(option => 
            `<button class="button button-secondary" style="width:100%; margin-bottom:var(--space-xs);" onclick="checkSiswatiAnswer('${option}')">${option}</button>`
        ).join('');

        contentEl.innerHTML = `
            <div class="quiz-score">Score: ${siswatiQuizState.score} / ${siswatiQuizState.total}</div>
            <h4 class="card-title text-center">Translate to ${mode === 'en_to_si' ? 'SiSwati' : 'English'}:</h4>
            <p class="text-center" style="font-size: 1.5rem; font-weight: 600; margin: var(--space-md) 0;">${questionWord}</p>
            <div id="siswatiOptions">${optionsHtml}</div>
            <p id="siswatiResult" class="card-subtitle text-center mt-3"></p>
            <button class="button mt-3" style="width:100%;" onclick="setupSiswatiTutor()">Change Mode</button>
        `;
    }

    function checkSiswatiAnswer(selectedAnswer) {
        const resultEl = document.getElementById('siswatiResult');
        if (!resultEl) return;
        siswatiQuizState.total++;
        const correctAnswer = siswatiQuizState.mode === 'en_to_si' ? siswatiQuizState.correctAnswer.si : siswatiQuizState.correctAnswer.en;

        if (selectedAnswer === correctAnswer) {
            resultEl.innerHTML = `<span style="color:var(--success-color); font-weight:bold;">Correct! Well done!</span>`;
            siswatiQuizState.score++;
            addXP(5, 'wellness');
        } else {
            resultEl.innerHTML = `<span style="color:var(--danger-color);">Not quite. The correct answer was <strong>${correctAnswer}</strong>.</span>`;
        }
        document.querySelectorAll('#siswatiOptions button').forEach(btn => btn.disabled = true);
        setTimeout(() => startSiswatiQuiz(siswatiQuizState.mode), 2000);
    }
    
    function openForgotPasswordModal() {
        openModal('forgotPasswordModal');
    }

    function handlePasswordRecovery() {
        const emailInput = document.getElementById('recoveryEmail');
        const email = emailInput.value.trim();
        const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
        if (!email || !emailRegex.test(email)) {
            showToast("Please enter a valid email address.", "error");
            return;
        }
        
        showToast("Checking our records...", "ai_info");
        setTimeout(() => {
            if (email === "test@example.com") {
                showToast("A password recovery link has been sent to your email.", "success");
                closeModal('forgotPasswordModal');
            } else {
                
                showToast("If that email is in our system, a recovery link has been sent.", "info");
                closeModal('forgotPasswordModal');
            }
        }, 1500);
    }
    
    document.addEventListener('visibilitychange', () => {
        const isBiometricEnabled = localStorage.getItem('biometricLockEnabled') === 'true';
        if (isBiometricEnabled && document.visibilityState === 'hidden') {
            isAppLocked = true;
        } else if (isAppLocked && document.visibilityState === 'visible') {
            lockScreen.classList.remove('hidden');
        }
    });

    document.getElementById('applet-siswatiTutor-modal').addEventListener('show', setupSiswatiTutor);
    document.querySelectorAll('#applet-localRideshare-modal input').forEach(input => {
        input.addEventListener('input', checkRideInputs);
    });

    function checkRideInputs() {
        const pickup = document.getElementById('ride-pickup').value.trim();
        const destination = document.getElementById('ride-destination').value.trim();
        const findButton = document.getElementById('findRideButton');
        findButton.disabled = !(pickup && destination);
    }

    function openAiItineraryModal() {
        if (!userSubscriptionTier.startsWith('pro')) {
            showToast("AI Itinerary planning is a Pro+ feature.", "info");
            openSubscriptionModal();
            return;
        }
        const itineraryResult = document.getElementById('itinerary-result');
        if(itineraryResult) itineraryResult.innerHTML = '';
        openModal('aiItineraryModal');
    }

    function generateAiItinerary() {
        const occasion = document.getElementById('itinerary-occasion').value;
        const resultContainer = document.getElementById('itinerary-result');
        resultContainer.innerHTML = `<p class="card-subtitle"><i class="fas fa-spinner fa-spin"></i> AI is planning your perfect "${occasion}"...</p>`;

        setTimeout(() => {
            let plan = `
                <h4>AI Itinerary: ${occasion}</h4>
                <ul>
                    <li><strong>Stop 1:</strong> Start with a scenic drive through the Ezulwini Valley.</li>
                    <li><strong>Stop 2:</strong> Visit Mantenga Cultural Village for an authentic experience.</li>
                    <li><strong>Stop 3:</strong> Enjoy dinner at Malandela's Restaurant.</li>
                </ul>
                <button class="button mt-2" style="width:100%" onclick="addItineraryToPlanner()">Add All to Planner</button>
            `;
            resultContainer.innerHTML = plan;
        }, 1500);
    }
    window.addItineraryToPlanner = function() {
        addNewTask("Scenic drive through Ezulwini", "personal", "Afternoon");
        addNewTask("Visit Mantenga Cultural Village", "personal", "Late Afternoon");
        addNewTask("Dinner at Malandela's", "personal", "Evening");
        showToast("Itinerary added to your planner!", "success");
        closeModal('aiItineraryModal');
        setActiveScreen('planner');
    }
    function renderLoadSheddingApplet() {
        const contentEl = document.getElementById('loadSheddingContent');
        contentEl.innerHTML = `
            <p class="card-subtitle">AI has determined you are in <strong>Zone 3 (Mbabane West)</strong> based on your location.</p>
            <h4 class="mt-3">Today's Schedule:</h4>
            <ul class="settings-list" style="padding:0;">
                <li class="setting-item"><span>08:00 - 10:30</span><span class="setting-value" style="color:var(--danger-color);">OFF</span></li>
                <li class="setting-item"><span>18:00 - 20:30</span><span class="setting-value" style="color:var(--danger-color);">OFF</span></li>
            </ul>
            <h4 class="mt-3">Tomorrow's Schedule:</h4>
            <ul class="settings-list" style="padding:0;">
                 <li class="setting-item"><span>10:00 - 12:30</span><span class="setting-value" style="color:var(--danger-color);">OFF</span></li>
            </ul>
            <p class="card-subtitle mt-2" style="font-size:0.8rem;">This is mock data. A real applet would fetch live data from EEC's API.</p>
        `;
    }

    const emergencyKeywords = ['help', 'emergency', 'danger', 'hurt', 'accident', 'call the police', 'fire'];
    
    if (SpeechRecognition) {
        emergencyKeywordRecognition = new SpeechRecognition();
        emergencyKeywordRecognition.continuous = true;
        emergencyKeywordRecognition.lang = 'en-US';
        emergencyKeywordRecognition.onresult = (event) => {
            for (let i = event.resultIndex; i < event.results.length; ++i) {
                const transcript = event.results[i][0].transcript.toLowerCase();
                
                if (emergencyKeywords.some(keyword => transcript.includes(keyword))) {
                    triggerEmergencyProtocol(transcript);
                    emergencyKeywordRecognition.stop(); 
                }
            }
        };
        emergencyKeywordRecognition.onerror = (event) => {
            
        }
    }

    function triggerEmergencyProtocol(context) {
        closeModal('emergencyDashboardModal');
        showToast("EMERGENCY DETECTED!", "error", 5000);
        showDynamicIslandAlert('fas fa-triangle-exclamation', 'Emergency Keyword Detected!');
        
        let message = `EMERGENCY from LocalLife OS for ${userName}. Context: "${context}".`;
        
        native.geolocation.getCurrent(
            position => {
                const { latitude, longitude } = position.coords;
                userLocationCoords = { lat: latitude, lng: longitude };
                message += ` Last known location: https://maps.google.com/?q=${latitude},${longitude}`;
                sendEmergencyAlerts(message);
            },
            () => {
                message += " Could not get current location.";
                sendEmergencyAlerts(message);
            }
        );
    }

    function sendEmergencyAlerts(message) {
        if (trustedContacts.length > 0) {
            const contacts = trustedContacts.map(c => c.phone).join(',');
            const smsUrl = `sms:${contacts}?body=${encodeURIComponent(message)}`;
            window.location.href = smsUrl; 
        } else {
            window.location.href = 'tel:999';
        }
        showToast("Alerting emergency contacts and/or services...", "error", 5000);
    }
    function updateNearbyPulse() {
        const pulseContainer = document.getElementById('nearbyPulseCarousel');
        if (!pulseContainer) return;
        
        const pulseItems = [
            { name: 'Manzini Market', icon: 'fas fa-store', desc: 'Vibrant market with fresh local produce. Try the fruit smoothies!', position: {lat: -26.4947, lng: 31.3787} },
            { name: 'Bushfire Fest', icon: 'fas fa-fire', desc: 'The annual MTN Bushfire festival is approaching! Get tickets now.', position: {lat: -26.4950, lng: 31.1969} },
            { name: 'New Cafe', icon: 'fas fa-mug-saucer', desc: 'Ekhaya Kasi cafe in Mbabane is now open! 10% off today.', position: {lat: -26.3167, lng: 31.1333} },
            { name: 'Bholoja Gig', icon: 'fas fa-guitar', desc: 'Catch local legend Bholoja live at House on Fire tonight.', position: {lat: -26.4950, lng: 31.1969} },
            { name: 'Mlilwane Walk', icon: 'fas fa-hippo', desc: 'Guided nature walks available this weekend at Mlilwane.', position: {lat: -26.4883, lng: 31.1517} },
            { name: 'Cleanup Day', icon: 'fas fa-recycle', desc: 'Join the community cleanup this Saturday in Mbabane.', position: {lat: -26.3250, lng: 31.1417} }
        ];

        
        const haversineDistance = (coords1, coords2) => {
            const toRad = x => x * Math.PI / 180;
            const R = 6371; 
            const dLat = toRad(coords2.lat - coords1.lat);
            const dLon = toRad(coords2.lng - coords1.lng);
            const a = Math.sin(dLat / 2) * Math.sin(dLat / 2) + Math.cos(toRad(coords1.lat)) * Math.cos(toRad(coords2.lat)) * Math.sin(dLon / 2) * Math.sin(dLon / 2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
            return R * c; 
        };

        pulseItems.forEach(item => {
            item.distance = haversineDistance(userLocationCoords, item.position);
        });

        
        pulseItems.sort((a, b) => a.distance - b.distance);

        pulseContainer.innerHTML = ''; 
        pulseItems.forEach(item => {
            const itemEl = document.createElement('button');
            itemEl.className = 'story-item';
            itemEl.onclick = () => showPulseDetailModal(item.name, item.icon, item.desc);
            itemEl.setAttribute('aria-label', `View ${item.name} details`);
            itemEl.innerHTML = `
                <div class="story-avatar"><i class="${item.icon}" aria-hidden="true"></i></div>
                <span class="story-label">${item.name}</span>
            `;
            pulseContainer.appendChild(itemEl);
        });
    }
    
    function openNewMessageModal() {
        const userListEl = document.getElementById('newMessageUserList');
        if (!userListEl) return;
        userListEl.innerHTML = '';
        Object.values(mockUsers).filter(u => u.id !== 'user' && u.id !== 'defaultBot').forEach(user => {
            const itemEl = document.createElement('div');
            itemEl.className = 'setting-item';
            itemEl.setAttribute('role', 'button');
            itemEl.setAttribute('tabindex', '0');
            itemEl.innerHTML = `
                <div style="display:flex; align-items:center; gap:var(--space-sm);">
                    <img src="${user.avatarUrl}" alt="${user.name}" style="width:32px; height:32px; border-radius:50%;">
                    <span class="setting-label">${user.name}</span>
                </div>
                <i class="fas fa-chevron-right"></i>`;
            itemEl.onclick = () => {
                closeModal('newMessageModal');
                startDirectMessage(user.id);
            };
            userListEl.appendChild(itemEl);
        });
        openModal('newMessageModal');
    }
</script>
</body>
</html>