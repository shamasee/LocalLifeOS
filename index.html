<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>LocalLife OS - Feature Packed Concept</title>
    <!-- Font Awesome for Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <!-- Google Fonts: Inter -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">

    <style>
        /* --- Global Styles & Variables --- */
        :root {
            --bg-color: #F7F7F7;
            --card-bg: #FFFFFF;
            --text-color: #333333;
            --text-secondary-color: #777777;
            --primary-accent: #4DB6AC; /* Teal - Default */
            --primary-accent-darker: #3aa396; /* Default darker version, updated by JS */
            --moss-green: #8FBC8F;
            --soft-blue: #ADD8E6;
            --warm-gray: #D3D3D3; /* Used for borders, subtle UI elements */
            --muted-terracotta: #E07A5F;
            --danger-color: #E57373;
            --success-color: #66BB6A;
            --placeholder-bg: #F0F0F0; /* Updated placeholder */
            --info-color: #2196F3; /* Standard info blue */
            --ai-suggestion-bg: color-mix(in srgb, var(--primary-accent) 10%, var(--card-bg));
            --ai-info-toast-bg: #2979FF; /* More distinct AI info color */
            --favorite-color: #FFC107;


            --font-family: 'Inter', sans-serif;
            --base-font-size: 16px; /* For reference with rem units */
            --border-radius-lg: 20px;
            --border-radius-md: 12px;
            --border-radius-sm: 8px;

            /* New Shadow System for Modern Depth */
            --shadow-color-rgb: 0, 0, 0; /* Base for RGBA shadows */
            --card-shadow: 0 4px 12px 0 rgba(var(--shadow-color-rgb), 0.08);
            --element-shadow: 0 2px 8px 0 rgba(var(--shadow-color-rgb), 0.07);
            --card-shadow-hover: 0 8px 20px 0 rgba(var(--shadow-color-rgb), 0.1);
            --fab-shadow: 0 6px 16px 0 rgba(var(--shadow-color-rgb), 0.12);

            --skeleton-bg: #EAEAEA;
            --skeleton-highlight: #F5F5F5;

            /* Chat Specific Colors */
            --chat-bg: #E5DDD5; /* WhatsApp-like subtle background */
            --chat-bubble-user-bg: var(--primary-accent); /* Already defined, but for clarity */
            --chat-bubble-other-bg: var(--card-bg);
            --chat-timestamp-color: rgba(0, 0, 0, 0.45);
            --chat-user-timestamp-color: rgba(255, 255, 255, 0.7);
            --chat-header-status-color: #666;
            --chat-date-separator-bg: #e1f3fb;
            --chat-date-separator-text: #5085a0;

            /* Responsive Spacing */
            --space-xs: clamp(0.25rem, 1vw, 0.5rem); /* 4px-8px */
            --space-sm: clamp(0.5rem, 1.5vw, 0.75rem); /* 8px-12px */
            --space-md: clamp(0.75rem, 2.5vw, 1.25rem); /* 12px-20px */
            --space-lg: clamp(1rem, 3.5vw, 1.75rem); /* 16px-28px */
            --space-xl: clamp(1.5rem, 5vw, 2.5rem); /* 24px-40px */
        }

        body.dark-mode {
            --bg-color: #121212; /* Darker black for OLED screens */
            --card-bg: #1E1E1E;
            --text-color: #E0E0E0;
            --text-secondary-color: #AAAAAA;
            --warm-gray: #4A4A4A;
            --placeholder-bg: #2C2C2C; /* Updated placeholder for dark */
            --info-color: #64B5F6; /* Lighter blue for dark mode info */
            --ai-suggestion-bg: color-mix(in srgb, var(--primary-accent) 20%, var(--card-bg));
            --ai-info-toast-bg: #64B5F6;
            
            /* Adjusted shadow color for dark mode */
            --shadow-color-rgb: 0, 0, 0; /* Still black, but alpha will be higher for visibility */
            --card-shadow: 0 4px 12px 0 rgba(var(--shadow-color-rgb), 0.35);
            --element-shadow: 0 2px 8px 0 rgba(var(--shadow-color-rgb), 0.3);
            --card-shadow-hover: 0 8px 20px 0 rgba(var(--shadow-color-rgb), 0.4);
            --fab-shadow: 0 6px 16px 0 rgba(var(--shadow-color-rgb), 0.45);

            --skeleton-bg: #3a3a3a;
            --skeleton-highlight: #4a4a4a;

            /* Chat Specific Dark Mode Colors */
            --chat-bg: #0e1621; /* Darker chat background */
            --chat-bubble-other-bg: #262d31; /* Darker other bubble */
            --chat-timestamp-color: rgba(255, 255, 255, 0.45);
            --chat-header-status-color: #ccc;
            --chat-date-separator-bg: #1f2c34;
            --chat-date-separator-text: #8696a0;
        }

        * { box-sizing: border-box; margin: 0; padding: 0; }
        html { font-size: var(--base-font-size); height: 100%; } /* Base font size for rem */
        body { 
            min-height: 100svh; /* Use smallest viewport height */
            font-family: var(--font-family); 
            background-color: var(--bg-color); 
            color: var(--text-color); 
            -webkit-tap-highlight-color: transparent; 
            transition: background-color 0.3s, color 0.3s; 
            display: flex; /* For centering auth container */
            flex-direction: column;
        }
        
        /* --- NEW: Auth Container & Screens --- */
        #authContainer {
            display: flex; /* Initially shown */
            flex-direction: column;
            align-items: center;
            justify-content: center;
            flex-grow: 1; /* Take available height */
            width: 100%;
            padding: var(--space-md);
            background-color: var(--bg-color); /* Use app bg for consistency */
        }
        .auth-screen {
            display: none; /* Hidden by default, JS controls active */
            width: 100%;
            max-width: 400px;
            text-align: center;
            animation: fadeInAuth 0.5s ease-in-out;
        }
        .auth-screen.active {
            display: block;
        }
        @keyframes fadeInAuth { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }

        .auth-logo {
            font-size: clamp(2rem, 6vw, 2.5rem);
            color: var(--primary-accent);
            margin-bottom: var(--space-sm);
        }
        .auth-title {
            font-size: clamp(1.5rem, 4.5vw, 1.8rem);
            font-weight: 600;
            margin-bottom: var(--space-xs);
            color: var(--text-color);
        }
        .auth-subtitle {
            font-size: clamp(0.9rem, 2.5vw, 1rem);
            color: var(--text-secondary-color);
            margin-bottom: var(--space-lg);
        }
        .auth-form .input-group { margin-bottom: var(--space-md); }
        .auth-form .input-field { text-align: left; } /* Align placeholder text left */
        .auth-form .button { width: 100%; margin-top: var(--space-sm); }
        .auth-link {
            display: block;
            margin-top: var(--space-md);
            color: var(--primary-accent);
            text-decoration: none;
            font-weight: 500;
            font-size: clamp(0.85rem, 2.2vw, 0.95rem);
        }
        .auth-link:hover { text-decoration: underline; }
        /* --- END: Auth Container & Screens --- */

        .app-container { 
            display: flex; 
            flex-direction: column; 
            height: 100svh; /* Full smallest viewport height */
            width: 100%;
            max-width: 450px; /* Max width for phone-like view on larger screens */
            margin: 0 auto; 
            background-color: var(--bg-color); 
            overflow: hidden; 
            position: relative; 
        }
        .app-container.hidden { display: none; } /* Used by JS to hide app until login */
        
        .content { 
            flex-grow: 1; 
            overflow-y: auto; 
            padding: var(--space-md) var(--space-md) calc(var(--space-xl) + 60px + env(safe-area-inset-bottom)) var(--space-md); /* Adjusted padding with responsive vars and safe area */
            transition: padding-bottom 0.3s ease; 
            overscroll-behavior: contain; /* Prevent body scroll when scrolling content */
            -webkit-overflow-scrolling: touch; /* Momentum scrolling on iOS */
        }
        
        /* Full page chat active state */
        .app-container.full-page-active .bottom-nav,
        .app-container.full-page-active .ai-fab {
             transform: translateY(150%);
             pointer-events: none;
             opacity: 0; /* Added for smoother transition */
        }
        .app-container.full-page-active .content {
            padding-bottom: 0px; /* Remove bottom padding when nav is hidden */
        }


        .screen { display: none; animation: fadeIn 0.3s ease-in-out; }
        .screen.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        .screen-header { display: flex; align-items: center; margin-bottom: var(--space-sm); justify-content: space-between;}
        .screen-header .back-button { font-size: clamp(1.1rem, 3vw, 1.2rem); color: var(--primary-accent); margin-right: var(--space-sm); padding: var(--space-xs); cursor: pointer; background: none; border: none; }
        .screen-header .title-group { display: flex; align-items: center; min-width: 0; flex-grow: 1; /* Allow title group to grow */ }
        .screen-header .title { 
            font-size: clamp(1.3rem, 4vw, 1.5rem); 
            font-weight: 600; 
            white-space: nowrap; 
            overflow: hidden; 
            text-overflow: ellipsis; 
            min-width: 0; /* Crucial for ellipsis */
        }
        .screen-header .action-button { font-size: clamp(1.1rem, 3vw, 1.2rem); color: var(--primary-accent); padding: var(--space-xs); cursor: pointer; background: none; border: none; flex-shrink: 0; margin-left: var(--space-xs); position:relative;}
        .unread-notification-badge {
            position: absolute;
            top: -2px;
            right: -5px;
            background-color: var(--danger-color);
            color: white;
            border-radius: 50%;
            width: clamp(16px, 4vw, 18px); /* Responsive size */
            height: clamp(16px, 4vw, 18px); /* Responsive size */
            font-size: clamp(0.6rem, 1.8vw, 0.7rem); /* Responsive font */
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            box-shadow: 0 0 5px rgba(0,0,0,0.3);
        }
        
        /* --- Skeleton Loader --- */
        .skeleton-loader .skeleton-item { background-color: var(--skeleton-bg); border-radius: var(--border-radius-sm); margin-bottom: var(--space-sm); animation: pulse 1.5s infinite ease-in-out; }
        .skeleton-loader .skeleton-item.title { height: clamp(18px, 2.5vw, 20px); width: 60%; margin-bottom: var(--space-md); }
        .skeleton-loader .skeleton-item.text { height: clamp(10px, 1.8vw, 12px); width: 80%; }
        .skeleton-loader .skeleton-item.text-short { height: clamp(10px, 1.8vw, 12px); width: 40%; margin-top: var(--space-xs); }
        .skeleton-loader .skeleton-card { background-color: var(--card-bg); border-radius: var(--border-radius-lg); padding: var(--space-md); margin-bottom: var(--space-md); box-shadow: var(--card-shadow); display:flex; gap: var(--space-sm); align-items:center;}
        .skeleton-loader .skeleton-card .skeleton-avatar { width:clamp(50px, 12vw, 60px); height:clamp(50px, 12vw, 60px); border-radius:var(--border-radius-md); background-color: var(--skeleton-bg); animation: pulse 1.5s infinite ease-in-out; flex-shrink:0;}
        .skeleton-loader .skeleton-card .skeleton-info { flex-grow:1;}
        .skeleton-loader .skeleton-list-item { display: flex; align-items: center; padding: var(--space-sm) 0; border-bottom: 1px solid var(--placeholder-bg); }
        .skeleton-loader .skeleton-list-item .skeleton-checkbox { width: clamp(18px, 4.5vw, 20px); height: clamp(18px, 4.5vw, 20px); border-radius: 50%; background-color: var(--skeleton-bg); margin-right: var(--space-sm); animation: pulse 1.5s infinite ease-in-out; }
        .skeleton-loader .skeleton-list-item .skeleton-text-line { height: clamp(14px, 2.2vw, 16px); background-color: var(--skeleton-bg); border-radius: 4px; animation: pulse 1.5s infinite ease-in-out; }
        .skeleton-loader .skeleton-list-item .skeleton-text-line.long { width: 70%; }
        .skeleton-loader .skeleton-list-item .skeleton-text-line.short { width: 40%; margin-top: var(--space-xs); height: clamp(10px, 1.8vw, 12px); }

        @keyframes pulse { 0% { background-color: var(--skeleton-bg); } 50% { background-color: var(--skeleton-highlight); } 100% { background-color: var(--skeleton-bg); } }

        .empty-state { text-align: center; padding: var(--space-lg) var(--space-md); color: var(--text-secondary-color); }
        .empty-state i { font-size: clamp(2rem, 6vw, 2.5rem); margin-bottom: var(--space-sm); color: var(--warm-gray); }
        .empty-state p { font-size: clamp(0.9rem, 2.5vw, 1rem); line-height: 1.5; }


        /* --- UI Elements --- */
        .card { background-color: var(--card-bg); border-radius: var(--border-radius-lg); padding: var(--space-md); margin-bottom: var(--space-md); box-shadow: var(--card-shadow); transition: transform 0.25s ease-out, background-color 0.3s, box-shadow 0.25s ease-out; }
        .card:hover:not(.no-press) { box-shadow: var(--card-shadow-hover); transform: translateY(-3px); }
        .card:active:not(.no-press) { transform: scale(0.98) translateY(0px); box-shadow: var(--card-shadow); }
        .card-title { font-size: clamp(1.1rem, 3.2vw, 1.2rem); font-weight: 600; margin-bottom: var(--space-sm); color: var(--text-color); white-space: nowrap; overflow: hidden; text-overflow: ellipsis;}
        .card-subtitle { font-size: clamp(0.85rem, 2.4vw, 0.9rem); color: var(--text-secondary-color); margin-bottom: var(--space-sm); }
        .button { background-color: var(--primary-accent); color: white; border: none; padding: clamp(10px, 2.8vw, 12px) clamp(16px, 4vw, 20px); border-radius: var(--border-radius-md); font-size: clamp(0.9rem, 2.5vw, 1rem); font-weight: 500; cursor: pointer; text-align: center; box-shadow: var(--element-shadow); transition: background-color 0.2s, transform 0.1s, box-shadow 0.2s; }
        .button:active { background-color: var(--primary-accent-darker); transform: scale(0.96); box-shadow: none; }
        .button:disabled { background-color: var(--warm-gray); cursor: not-allowed; opacity: 0.7; box-shadow: none; }
        .button-secondary { background-color: var(--placeholder-bg); color: var(--text-color); } /* Updated for better contrast */
        .button-secondary:active { background-color: color-mix(in srgb, var(--placeholder-bg) 80%, black); }
        body.dark-mode .button-secondary { background-color: #444; color: var(--text-color); }
        body.dark-mode .button-secondary:active { background-color: #555; }
        .button.danger { background-color: var(--danger-color); }
        .button.danger:active { background-color: #d32f2f; }
        
        .input-group { position: relative; margin-bottom: var(--space-sm); }
        .input-field {
            width: 100%;
            padding: clamp(10px, 2.8vw, 12px);
            border: 1px solid color-mix(in srgb, var(--text-color) 20%, transparent);
            border-radius: var(--border-radius-md);
            font-size: clamp(0.9rem, 2.5vw, 1rem);
            background-color: color-mix(in srgb, var(--bg-color) 95%, var(--text-color) 3%);
            color: var(--text-color);
            transition: border-color 0.2s, box-shadow 0.2s, background-color 0.2s;
        }
        .input-field:focus {
            outline: none;
            border-color: var(--primary-accent);
            background-color: var(--card-bg);
            box-shadow: 0 0 0 3px color-mix(in srgb, var(--primary-accent) 20%, transparent);
        }
        body.dark-mode .input-field {
            border-color: color-mix(in srgb, var(--text-color) 25%, transparent);
            background-color: color-mix(in srgb, var(--bg-color) 95%, var(--text-color) 5%);
        }
        body.dark-mode .input-field:focus {
            background-color: var(--card-bg); /* Use card-bg for focused input in dark mode as well */
        }
        .input-clear-btn { position: absolute; right: 10px; top: 50%; transform: translateY(-50%); background: none; border: none; color: var(--text-secondary-color); cursor: pointer; font-size: clamp(1rem, 2.8vw, 1.1rem); padding: var(--space-xs); }
        textarea.input-field { min-height: 5rem; /* Using rem for scalable min-height */ resize: vertical;}
        label { display: block; margin-bottom: var(--space-xs); font-weight: 500; font-size: clamp(0.85rem, 2.3vw, 0.9rem);}
        select.input-field { appearance: none; -webkit-appearance: none; -moz-appearance: none; background-image: url("data:image/svg+xml;charset=US-ASCII,%3Csvg%20xmlns%3D%27http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%27%20width%3D%27292.4%27%20height%3D%27292.4%27%3E%3Cpath%20fill%3D%27%23777777%27%20d%3D%27M287%2069.4a17.6%2017.6%200%200%200-13-5.4H18.4c-5%200-9.3%201.8-12.9%205.4A17.6%2017.6%200%200%200%200%2082.2c0%205%201.8%209.3%205.4%2012.9l128%20127.9c3.6%203.6%207.8%205.4%2012.8%205.4s9.2-1.8%2012.8-5.4L287%2095c3.5-3.5%205.4-7.8%205.4-12.8%200-5-1.9-9.2-5.5-12.8z%27%2F%3E%3C%2Fsvg%3E"); background-repeat: no-repeat; background-position: right 10px center; background-size: .65em auto; padding-right: 30px; }
        body.dark-mode select.input-field { background-image: url("data:image/svg+xml;charset=US-ASCII,%3Csvg%20xmlns%3D%27http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%27%20width%3D%27292.4%27%20height%3D%27292.4%27%3E%3Cpath%20fill%3D%27%23AAAAAA%27%20d%3D%27M287%2069.4a17.6%2017.6%200%200%200-13-5.4H18.4c-5%200-9.3%201.8-12.9%205.4A17.6%2017.6%200%200%200%200%2082.2c0%205%201.8%209.3%205.4%2012.9l128%20127.9c3.6%203.6%207.8%205.4%2012.8%205.4s9.2-1.8%2012.8-5.4L287%2095c3.5-3.5%205.4-7.8%205.4-12.8%200-5-1.9-9.2-5.5-12.8z%27%2F%3E%3C%2Fsvg%3E");}


        /* --- Bottom Navigation --- */
        .bottom-nav {
            position: fixed; bottom: 0; left: 0; right: 0;
            max-width: 450px; margin: 0 auto; /* Centered within app-container */
            display: flex; justify-content: space-around;
            background-color: var(--card-bg);
            padding: var(--space-xs) 0 calc(var(--space-sm) + env(safe-area-inset-bottom)) 0; /* Safe area for gesture nav */
            box-shadow: 0 -2px 10px rgba(var(--shadow-color-rgb),0.1);
            border-top-left-radius: var(--border-radius-lg);
            border-top-right-radius: var(--border-radius-lg);
            z-index: 1000;
            transition: background-color 0.3s, transform 0.3s ease-in-out, opacity 0.3s ease-in-out; 
        }
        .nav-item {
            display: flex; flex-direction: column;
            align-items: center; justify-content: center;
            color: var(--text-secondary-color);
            cursor: pointer;
            padding: var(--space-sm) var(--space-xs);
            border-radius: var(--border-radius-sm);
            transition: color 0.2s, background-color 0.2s, transform 0.1s;
            flex-basis: 0; flex-grow: 1;
            text-align: center;
            background: none; border: none;
        }
        .nav-item i {
            font-size: clamp(1.2rem, 3.5vw, 1.35rem); /* Responsive icon size */
            margin-bottom: 0; /* No text below */
        }
        .nav-item span {
            display: none; /* Text labels are now permanently hidden */
        }
        .nav-item.active {
            color: var(--primary-accent);
        }
        .nav-item:active {
            background-color: color-mix(in srgb, var(--primary-accent) 10%, transparent);
            transform: scale(0.95);
        }
        body.dark-mode .nav-item:active {
            background-color: color-mix(in srgb, var(--primary-accent) 15%, transparent);
        }

        /* --- Dashboard --- */
        #dashboard .ai-greeting { font-size: clamp(1.3rem, 4vw, 1.5rem); font-weight: 600; margin-bottom: var(--space-xs); }
        #dashboard .local-context-card .context-item { display: flex; align-items: center; margin-bottom: var(--space-xs); font-size: clamp(0.85rem, 2.3vw, 0.9rem); }
        #dashboard .local-context-card .context-item i { margin-right: var(--space-sm); color: var(--primary-accent); width: 20px; text-align: center; }
        .nearby-pulse-carousel { display: flex; overflow-x: auto; padding-bottom: var(--space-sm); gap: var(--space-sm); margin-bottom: var(--space-md); -webkit-overflow-scrolling: touch; scroll-snap-type: x mandatory;}
        .nearby-pulse-carousel::-webkit-scrollbar { display: none; }
        .story-item { display: flex; flex-direction: column; align-items: center; cursor: pointer; min-width: clamp(70px, 18vw, 80px); background: none; border:none; padding:0; transition: transform 0.2s; scroll-snap-align: start;}
        .story-item:active { transform: scale(0.9); }
        .story-item .story-avatar { width: clamp(50px, 13vw, 60px); height: clamp(50px, 13vw, 60px); border-radius: 50%; background-color: var(--warm-gray); border: 3px solid var(--primary-accent); display: flex; justify-content: center; align-items: center; overflow: hidden; margin-bottom: var(--space-xs); box-shadow: var(--element-shadow); }
        .story-item .story-avatar i { font-size: clamp(1.5rem, 4.5vw, 1.8rem); color: white; }
        .story-item .story-label { font-size: clamp(0.7rem, 2vw, 0.75rem); text-align: center; color: var(--text-secondary-color); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; width: clamp(60px, 17vw, 70px); }
        
        .safety-ticker { background-color: var(--muted-terracotta); color: white; padding: var(--space-sm); border-radius: var(--border-radius-md); font-size: clamp(0.8rem, 2.2vw, 0.85rem); text-align: center; margin-bottom: var(--space-md); box-shadow: var(--element-shadow); cursor:pointer; display:flex; align-items:center; justify-content:center; }
        .safety-ticker #safetyTickerText { transition: opacity 0.2s ease-in-out; margin-left: var(--space-xs); flex-grow:1; text-align:left;}
        .safety-ticker .sos-button { background-color: #fff; color: var(--danger-color); border:none; border-radius:50%; width:clamp(28px, 7vw, 30px); height:clamp(28px, 7vw, 30px); font-size:clamp(0.8rem, 2.2vw, 0.9rem); display:flex; align-items:center; justify-content:center; margin-left:var(--space-sm); box-shadow: var(--element-shadow); flex-shrink:0;}
        
        .suggestion-action { display: block; margin-top: var(--space-sm); padding: clamp(6px, 1.8vw, 8px) clamp(10px, 2.5vw, 12px); font-size: clamp(0.85rem, 2.3vw, 0.9rem); }
        
        /* Pinned Widgets Specific Styling */
        #pinnedWidgetsContainer {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(110px, 1fr)); /* More flexible min for smaller screens */
            gap: var(--space-sm);
        }
        .pinned-widget-item {
            background-color: color-mix(in srgb, var(--bg-color) 90%, var(--card-bg) 10%); /* Subtle background */
            border: 1px solid var(--placeholder-bg);
            border-radius: var(--border-radius-md);
            padding: var(--space-sm);
            font-size: clamp(0.75rem, 2vw, 0.8rem);
            display: flex;
            flex-direction: column; /* Stack icon/title and value */
            align-items: flex-start; /* Align content to the start */
            box-shadow: var(--element-shadow);
            min-height: clamp(60px, 15vw, 70px); /* Minimum height for consistency */
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
        }
        .pinned-widget-item:hover {
            transform: translateY(-2px);
            box-shadow: var(--card-shadow-hover);
        }
        body.dark-mode .pinned-widget-item {
             background-color: color-mix(in srgb, var(--bg-color) 90%, var(--card-bg) 10%);
             border-color: var(--warm-gray);
        }
        .pinned-widget-item .widget-icon {
            font-size: clamp(1.1rem, 3vw, 1.2rem);
            margin-bottom: var(--space-xs);
            color: var(--primary-accent); /* Use accent color for icons */
        }
        .pinned-widget-item .widget-title {
            font-weight: 500;
            color: var(--text-secondary-color);
            margin-bottom: 3px;
        }
        .pinned-widget-item .widget-value {
            font-weight: 600;
            font-size: clamp(0.85rem, 2.3vw, 0.9rem);
            color: var(--text-color);
            line-height: 1.3;
            word-break: break-word; /* Prevent overflow of long values */
        }
        /* End Pinned Widgets */

        #dashboardDealsList .deal-card { margin-bottom: var(--space-sm); } 
        #dashboardDealsList .deal-card:last-child { margin-bottom: 0; }
        #aiDashboardInsight { background-color: var(--ai-suggestion-bg); padding: var(--space-sm); border-radius: var(--border-radius-md); font-size: clamp(0.8rem, 2.2vw, 0.85rem); margin-top: var(--space-xs); color: var(--text-color); border: 1px solid color-mix(in srgb, var(--primary-accent) 30%, transparent);}
        #aiDashboardInsight i { margin-right: var(--space-xs); color: var(--primary-accent); }

        /* --- Planner --- */
        .task-list { list-style: none; padding: 0; }
        .task-item { display: flex; align-items: center; padding: var(--space-sm) 0; border-bottom: 1px solid var(--placeholder-bg); transition: background-color 0.1s;}
        .task-item:hover { background-color: color-mix(in srgb, var(--primary-accent) 5%, transparent); }
        body.dark-mode .task-item { border-bottom: 1px solid var(--warm-gray); }
        body.dark-mode .task-item:hover { background-color: color-mix(in srgb, var(--primary-accent) 10%, var(--card-bg)); }
        .task-item:last-child { border-bottom: none; }
        .task-item .task-checkbox-button { background:none; border:none; padding:0; margin-right: var(--space-sm); cursor: pointer; flex-shrink: 0; }
        .task-item .task-checkbox { width: clamp(18px, 4.5vw, 20px); height: clamp(18px, 4.5vw, 20px); border: 2px solid var(--primary-accent); border-radius: 50%; display: flex; justify-content: center; align-items: center;}
        .task-item .task-checkbox.completed { background-color: var(--primary-accent); border-color: var(--primary-accent); }
        .task-item .task-checkbox.completed i { color: white; font-size: clamp(0.7em, 1.8vw, 0.8em); }
        .task-item .task-info { flex-grow: 1; min-width: 0; }
        .task-item .task-title { font-weight: 500; word-break: break-word; font-size: clamp(0.9rem, 2.5vw, 1rem); }
        .task-item .task-title.completed { text-decoration: line-through; color: var(--text-secondary-color); }
        .task-item .task-time { font-size: clamp(0.75rem, 2vw, 0.8rem); color: var(--text-secondary-color); }
        .task-item .task-meta-ai { font-size: clamp(0.7rem, 1.9vw, 0.75rem); color: var(--primary-accent); font-style: italic; margin-top: 3px; background-color: var(--ai-suggestion-bg); padding: 3px 6px; border-radius: var(--border-radius-sm); display: inline-block;}
        .task-item .task-actions { display:flex; align-items:center; flex-shrink: 0; }
        .task-item .task-action-button { color: var(--text-secondary-color); margin-left:var(--space-xs); cursor:pointer; font-size:clamp(0.85rem, 2.3vw, 0.9rem); background:none; border:none; padding:var(--space-xs);}
        .task-item .task-action-button.delete { color: var(--danger-color); }
        .task-category-work { border-left: 5px solid var(--moss-green); padding-left: var(--space-sm) !important; }
        .task-category-personal { border-left: 5px solid var(--soft-blue); padding-left: var(--space-sm) !important; }
        .task-category-errands { border-left: 5px solid var(--muted-terracotta); padding-left: var(--space-sm) !important; }
        .task-category-learning { border-left: 5px solid #FFC107; padding-left: var(--space-sm) !important;} 
        .task-category-health { border-left: 5px solid #9575CD; padding-left: var(--space-sm) !important; } 
        .calendar-view-placeholder { min-height: clamp(120px, 30vh, 150px); background-color: var(--placeholder-bg); border-radius: var(--border-radius-md); display: grid; grid-template-columns: repeat(7, 1fr); gap: 2px; padding: var(--space-xs); color: var(--text-secondary-color); margin-bottom: var(--space-md); }
        .calendar-view-placeholder .day { background-color: var(--card-bg); border-radius: 4px; display: flex; align-items: center; justify-content: center; font-size: clamp(0.6rem, 1.8vw, 0.7rem); }
        .calendar-view-placeholder .day.today { background-color: var(--primary-accent); color: white; font-weight: bold; }
        .add-task-input-container { display: flex; gap: var(--space-sm); margin-bottom: var(--space-sm); }
        .add-task-input { flex-grow:1; } 
        .add-task-button { padding: 0 clamp(12px, 3.5vw, 15px); font-size: clamp(1.1rem, 3vw, 1.2rem); }
        .ai-planner-suggestion { background-color: var(--ai-suggestion-bg); padding: var(--space-sm) var(--space-md); border-radius: var(--border-radius-md); font-size: clamp(0.85rem, 2.3vw, 0.9rem); margin-top: var(--space-sm); color: var(--text-color); border: 1px solid color-mix(in srgb, var(--primary-accent) 30%, transparent);}
        .ai-planner-suggestion i { color: var(--primary-accent); margin-right: var(--space-xs);}

        /* --- Explore --- */
        .map-placeholder { position: relative; height: clamp(180px, 40svh, 220px); background-color: var(--placeholder-bg); border-radius: var(--border-radius-lg); margin-bottom: var(--space-md); display: flex; flex-direction:column; justify-content: center; align-items: center; color: var(--text-secondary-color); font-size: clamp(1rem, 3vw, 1.2rem); background-image: url('https://via.placeholder.com/400x200.png?text=Interactive+Map+Area'); background-size: cover; background-position: center; }
        .map-placeholder .map-overlay-text { background-color: rgba(var(--shadow-color-rgb), 0.7); color: white; padding: var(--space-sm) var(--space-md); border-radius: var(--border-radius-md); text-align: center; }
        .map-actions { position: absolute; bottom: var(--space-sm); right: var(--space-sm); display: flex; gap: var(--space-xs); }
        .map-action-button { background-color: var(--card-bg); color: var(--text-color); border: none; padding: var(--space-xs) var(--space-sm); border-radius: var(--border-radius-md); box-shadow: var(--element-shadow); cursor: pointer; font-size: clamp(0.8rem, 2.2vw, 0.9rem); }

        .search-bar-container { display: flex; gap: var(--space-sm); margin-bottom: var(--space-md); }
        #exploreSearchInput { flex-grow: 1;}
        .filter-bar { display: flex; gap: var(--space-sm); margin-bottom: var(--space-md); overflow-x: auto; padding-bottom: var(--space-sm); -webkit-overflow-scrolling: touch; scroll-snap-type: x mandatory;}
        .filter-bar::-webkit-scrollbar { display: none; }
        .filter-button { padding: clamp(6px, 1.8vw, 8px) clamp(12px, 3.5vw, 15px); background-color: var(--placeholder-bg); border: none; border-radius: var(--border-radius-md); font-size: clamp(0.85rem, 2.3vw, 0.9rem); cursor: pointer; white-space: nowrap; transition: background-color 0.2s, color 0.2s, box-shadow 0.2s; color: var(--text-color); scroll-snap-align: start; }
        body.dark-mode .filter-button { background-color: #383838; color: var(--text-color); }
        .filter-button.active { background-color: var(--primary-accent); color: white; font-weight: 600; box-shadow: var(--element-shadow); }
        body.dark-mode .filter-button.active { background-color: var(--primary-accent-darker); border: 1px solid var(--primary-accent); }
        
        #placesList.grid-view { display: grid; gap: var(--space-sm); grid-template-columns: 1fr; } 
        
        .place-card, .deal-card { display: flex; gap: var(--space-sm); align-items: flex-start; cursor:pointer; } 
        .place-card img, .deal-card img { width: clamp(50px, 13vw, 60px); height: clamp(50px, 13vw, 60px); border-radius: var(--border-radius-md); object-fit: cover; flex-shrink: 0;}
        .place-info, .deal-info { flex-grow:1; min-width: 0; }
        .place-info .name, .deal-info .name { font-weight: 600; margin-bottom: 4px; line-height: 1.3; font-size: clamp(0.9rem, 2.5vw, 0.95rem); white-space: nowrap; overflow: hidden; text-overflow: ellipsis;}
        .place-info .details, .deal-info .details { font-size: clamp(0.75rem, 2vw, 0.8rem); color: var(--text-secondary-color); line-height: 1.4; }
        .place-info .rating { color: #FFC107; }
        .place-info .tags { font-size: clamp(0.65rem, 1.8vw, 0.7rem); color: var(--primary-accent); margin-top: 4px;}
        .place-info .tags .tag { background-color: var(--ai-suggestion-bg); padding: 2px 5px; border-radius: var(--border-radius-sm); margin-right: 4px; display: inline-block;}

        .deal-info .business { font-size:clamp(0.75rem, 2vw, 0.8rem); font-weight:500; color: var(--primary-accent); margin-top:3px;}
        .deal-info .expiry { font-size:clamp(0.7rem, 1.9vw, 0.75rem); color: var(--text-secondary-color); margin-top:3px;}
        .save-place-button { background:none; border:none; color: var(--text-secondary-color); font-size:clamp(1.1rem, 3vw, 1.2rem); cursor:pointer; padding:var(--space-xs); flex-shrink:0;}
        .save-place-button.saved { color: var(--primary-accent); }
        .ai-review-summary { font-size: clamp(0.75rem, 2vw, 0.8rem); font-style: italic; color: var(--primary-accent); margin-top: var(--space-xs); padding: var(--space-xs); background-color: var(--ai-suggestion-bg); border-radius: var(--border-radius-sm); border: 1px solid color-mix(in srgb, var(--primary-accent) 20%, transparent); }
        .ai-review-summary i { margin-right: var(--space-xs); }


        #aiExploreSuggestion.card {
            background-color: var(--ai-suggestion-bg);
            border: 1px solid color-mix(in srgb, var(--primary-accent) 40%, transparent);
            padding: var(--space-sm);
            transition: opacity 0.3s, transform 0.3s;
        }
        #aiExploreSuggestion .card-title { font-size: clamp(0.95rem, 2.6vw, 1rem); margin-bottom: var(--space-xs); }
        #aiExploreSuggestion .suggestion-action { font-size: clamp(0.8rem, 2.2vw, 0.85rem); padding: var(--space-xs) var(--space-sm); background-color: var(--primary-accent); color:white;}
        #aiExploreSuggestion .suggestion-action:active { background-color: var(--primary-accent-darker); }


        /* --- Chat --- */
        #chat.screen { padding: 0 !important; } /* Full bleed chat screen */
        #communityChannelList { margin: 0 var(--space-md) var(--space-sm) var(--space-md); border-radius: var(--border-radius-lg); overflow: hidden; }

        .chat-section-header { padding: 0 var(--space-md); } 

        .channel-list-toggle { display: flex; gap: var(--space-xs); margin: 0 var(--space-md) var(--space-sm) var(--space-md); background-color: var(--placeholder-bg); padding: var(--space-xs); border-radius: var(--border-radius-md); }
        .channel-list-toggle button { flex: 1; padding: var(--space-xs); border: none; border-radius: var(--border-radius-sm); background: none; font-weight: 500; color: var(--text-secondary-color); font-size: clamp(0.85rem, 2.3vw, 0.9rem);}
        .channel-list-toggle button.active { background-color: var(--card-bg); color: var(--primary-accent); box-shadow: var(--element-shadow); }

        .channel-list .channel-item {
            display: flex; 
            align-items: center;
            padding: var(--space-sm) var(--space-md); 
            border-bottom: 1px solid var(--placeholder-bg);
            cursor: pointer;
            transition: background-color 0.2s;
            background: var(--card-bg); border:none; 
            width: 100%; 
            text-align:left;
        }
        body.dark-mode .channel-list .channel-item { border-bottom: 1px solid var(--warm-gray); }
        .channel-list .channel-item:last-child { border-bottom: none; }
        .channel-list .channel-item:hover { background-color: rgba(var(--shadow-color-rgb),0.03); }
        body.dark-mode .channel-list .channel-item:hover { background-color: rgba(255,255,255,0.03); }

        .channel-icon { width: clamp(40px, 11vw, 48px); height: clamp(40px, 11vw, 48px); border-radius: 50%; display: flex; justify-content: center; align-items: center; color: white; font-size: clamp(1.3rem, 4vw, 1.5rem); flex-shrink:0; margin-right: var(--space-sm); } 
        
        .channel-info-wrapper {
            display: flex;
            justify-content: space-between;
            align-items: center; /* Vertically center align items */
            flex-grow: 1;
            min-width: 0;
        }
        .channel-info { flex-grow: 1; min-width: 0; margin-right: var(--space-xs); /* Space before actions */ }
        .channel-info .name { font-weight: 500; font-size: clamp(0.95rem, 2.6vw, 1rem); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; color: var(--text-color); margin-bottom: 2px;}
        body.dark-mode .channel-info .name { color: var(--text-color); }
        .channel-info .last-message { font-size: clamp(0.8rem, 2.2vw, 0.85rem); color: var(--text-secondary-color); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .channel-info .channel-type-indicator { display:none; } 

        .channel-actions-container { 
            display: flex; 
            flex-direction: column; 
            align-items: flex-end; 
            flex-shrink: 0; 
            height: auto;
            gap: 4px;
            justify-content: flex-start;
        }
        .channel-actions-container .last-message-timestamp { font-size: clamp(0.7rem, 1.9vw, 0.75rem); color: var(--text-secondary-color); }

        .unread-badge { background-color: var(--primary-accent); color: white; font-size: clamp(0.65rem, 1.8vw, 0.7rem); padding: 3px 7px; border-radius: 10px; flex-shrink: 0; font-weight: 500;}
        .channel-favorite-icon { color: var(--text-secondary-color); font-size: clamp(1rem, 2.8vw, 1.1rem); padding: 0px; cursor: pointer; z-index: 1; } 
        .channel-favorite-icon.favorited { color: var(--favorite-color); }

        #chatScreenContainer { height: 100svh; display: flex; flex-direction: column; background-color: var(--bg-color); }
        #specificChatView.active, #aiBottomSheet.active {
            position: fixed; top: 0; left: 0; right: 0; bottom: 0;
            max-width: 450px; margin: 0 auto;
            width: 100%; height: 100svh; /* Use smallest viewport height */
            display: flex; flex-direction: column;
            background-color: var(--chat-bg); /* Match chat area */
            z-index: 1002;
            animation: fadeIn 0.3s;
            opacity: 1; /* Ensure visible */
        }
        #specificChatView .specific-chat-content, #aiBottomSheet .ai-chat-content {
            flex-grow: 1; display: flex; flex-direction: column; overflow: hidden;
        }

        /* NEW Chat Header Styling */
        #specificChatView .screen-header {
            background-color: var(--card-bg);
            padding: clamp(6px, 1.8vw, 8px) clamp(8px, 2.2vw, 10px) !important; /* Override inline */
            box-shadow: var(--element-shadow);
            z-index: 10; /* Ensure above messages */
        }
        .chat-header-info { display: flex; align-items: center; flex-grow: 1; margin-left: var(--space-sm); min-width: 0; cursor: pointer; }
        .chat-header-avatar { width: clamp(36px, 10vw, 40px); height: clamp(36px, 10vw, 40px); border-radius: 50%; object-fit: cover; margin-right: var(--space-sm); }
        .chat-header-text { display: flex; flex-direction: column; flex-grow:1; min-width:0; }
        .chat-header-text .title { font-size: clamp(1rem, 2.8vw, 1.1rem) !important; margin-bottom: 0; } /* Smaller title in chat */
        .chat-header-status { font-size: clamp(0.7rem, 1.9vw, 0.75rem); color: var(--chat-header-status-color); }
        .chat-header-actions { display: flex; align-items: center; }
        .chat-header-actions .action-button { margin-left: var(--space-xs); font-size: clamp(1rem, 2.8vw, 1.1rem); }

        /* Chat Messages Area Improvements */
        .chat-messages-area {
            flex-grow: 1; overflow-y: auto; padding: var(--space-sm); display: flex; flex-direction: column; gap: 2px; /* Reduced gap for tighter bubbles */
            background-color: var(--chat-bg); 
            overscroll-behavior: contain;
            -webkit-overflow-scrolling: touch;
        }
        /* Date Separator Styling */
        .chat-date-separator {
            align-self: center;
            background-color: var(--chat-date-separator-bg);
            color: var(--chat-date-separator-text);
            padding: 4px var(--space-sm);
            border-radius: var(--border-radius-sm);
            font-size: clamp(0.7rem, 1.9vw, 0.75rem);
            font-weight: 500;
            margin: var(--space-sm) 0;
            box-shadow: var(--element-shadow);
        }

        .chat-message-wrapper { display: flex; margin-bottom: var(--space-xs); align-items: flex-end; max-width: 90%; /* Prevent full width bubbles */}
        .chat-message-wrapper.user { justify-content: flex-end; margin-left: auto; }
        .chat-message-wrapper.other { justify-content: flex-start; margin-right: auto; }
        .chat-avatar { width: clamp(28px, 8vw, 32px); height: clamp(28px, 8vw, 32px); border-radius: 50%; object-fit: cover; flex-shrink: 0; box-shadow: var(--element-shadow); cursor: pointer; align-self: flex-end; /* Align with bottom of bubble */}
        .chat-avatar.user-avatar { display: none; /* Usually user avatar is not shown next to their own messages */ }
        .chat-avatar.other-avatar { margin-right: var(--space-xs); }

        .chat-bubble { 
            padding: clamp(6px, 1.8vw, 8px) clamp(10px, 2.8vw, 12px); 
            border-radius: var(--border-radius-md); 
            max-width: 100%; 
            font-size: clamp(0.9rem, 2.5vw, 0.95rem); 
            line-height: 1.4; 
            word-break: break-word; 
            position:relative; 
            animation: bubbleIn 0.3s ease-out; 
            box-shadow: var(--element-shadow); 
            display: flex;
            flex-direction: column;
        }
        @keyframes bubbleIn { from { opacity:0; transform: scale(0.8) translateY(10px); } to { opacity:1; transform: scale(1) translateY(0); } }
        
        /* Bubble Tails */
        .chat-bubble::before {
            content: "";
            position: absolute;
            bottom: 0px; 
            width: 12px;
            height: 10px; /* Adjust for desired tail size */
        }
        .chat-bubble.user { background-color: var(--chat-bubble-user-bg); color: white; border-bottom-right-radius: 4px; /* Sharper corner where tail is */}
        .chat-bubble.user::before {
            right: -6px; /* Position tail */
            background-color: var(--chat-bubble-user-bg);
            clip-path: polygon(100% 100%, 0 100%, 100% 0); /* Triangle tail */
        }
        .chat-bubble.other { background-color: var(--chat-bubble-other-bg); color: var(--text-color); border-bottom-left-radius: 4px; /* Sharper corner */ }
        .chat-bubble.other::before {
            left: -6px; /* Position tail */
            background-color: var(--chat-bubble-other-bg);
            clip-path: polygon(0 0, 0 100%, 100% 100%); /* Triangle tail */
        }
        .chat-bubble.other.ai-intervention { background-color: var(--ai-suggestion-bg); border: 1px solid color-mix(in srgb, var(--primary-accent) 20%, transparent);}
        .chat-bubble.other.ai-intervention::before { background-color: var(--ai-suggestion-bg); }

        body.dark-mode .chat-bubble.other { background-color: var(--chat-bubble-other-bg); }
        body.dark-mode .chat-bubble.other::before { background-color: var(--chat-bubble-other-bg); }
        body.dark-mode .chat-sender-name { color: color-mix(in srgb, var(--primary-accent) 80%, white); }

        .chat-sender-name { font-weight: 600; font-size: clamp(0.75rem, 2vw, 0.8rem); margin-bottom: 3px; display: block; color: var(--primary-accent); cursor: pointer;}
        .chat-bubble.user .chat-sender-name { display: none; } /* User's own name not shown */
        
        .chat-bubble-content { 
            display: flex;
            align-items: flex-end; /* Align text and meta baseline */
            flex-wrap: wrap; /* Allow meta to wrap if text is very short */
        }
        .chat-bubble-text { 
            flex-grow: 1; /* Allow text to take available space */
            padding-right: var(--space-xs); /* Space before timestamp */
        }
        
        /* Message Meta: Timestamp and Status Ticks */
        .message-meta {
            margin-left: auto; 
            margin-top: 4px; 
            font-size: clamp(0.65rem, 1.8vw, 0.7rem);
            line-height: 1; 
            display: flex; 
            align-items: center;
            align-self: flex-end; 
            white-space: nowrap; 
            padding-left: var(--space-xs); 
        }
        .chat-bubble.user .message-meta .timestamp { color: var(--chat-user-timestamp-color); }
        .chat-bubble.other .message-meta .timestamp { color: var(--chat-timestamp-color); }
        .message-meta .status-ticks {
            margin-left: 3px;
            font-size: clamp(0.7rem, 1.9vw, 0.8rem); 
            color: var(--chat-user-timestamp-color); 
        }
        .chat-bubble.other .message-meta .status-ticks { display: none; } 


        .chat-message-actions { display: none; position: absolute; top: -25px; background-color: var(--card-bg); border-radius: var(--border-radius-sm); box-shadow: var(--element-shadow); padding: 3px; z-index: 10; gap: 3px; }
        .chat-message-wrapper:hover .chat-message-actions { display: flex; }
        .chat-message-actions button { background: none; border: none; color: var(--text-secondary-color); font-size: clamp(0.75rem, 2vw, 0.8rem); padding: 4px; cursor: pointer; }
        .chat-bubble.user .chat-message-actions { right: 5px; }
        .chat-bubble.other .chat-message-actions { left: 5px; }

        /* CHAT INPUT FIELD REDESIGN */
        .chat-input-container {
            display: flex;
            padding: var(--space-sm) var(--space-sm) calc(var(--space-sm) + env(safe-area-inset-bottom)) var(--space-sm); /* Safe area */
            background-color: var(--card-bg);
            border-top: 1px solid var(--placeholder-bg);
            align-items: flex-end; /* Align items to the bottom */
            gap: var(--space-sm);
            flex-shrink: 0;
        }
        body.dark-mode .chat-input-container { border-top-color: var(--warm-gray); }

        .chat-input-wrapper {
            flex-grow: 1;
            display: flex;
            align-items: flex-end;
            background-color: var(--placeholder-bg);
            border-radius: var(--border-radius-lg); /* More rounded */
            padding: 0 var(--space-xs);
            min-height: clamp(40px, 11vw, 44px);
        }
        body.dark-mode .chat-input-wrapper { background-color: #2A2A2A; } /* Darker input bg */

        .chat-input-wrapper .chat-icon-button {
            background: none; border: none; cursor: pointer;
            color: var(--text-secondary-color);
            font-size: clamp(1.2rem, 3.3vw, 1.3rem);
            padding: var(--space-xs);
            flex-shrink: 0;
            transition: opacity 0.2s, transform 0.2s;
        }
        .chat-input-wrapper.typing-active .chat-icon-button.hides-on-typing {
            opacity: 0;
            transform: scale(0.5);
            pointer-events: none;
            width: 0;
            padding: var(--space-xs) 0;
        }

        textarea.chat-input {
            flex-grow: 1;
            border: none;
            background: transparent;
            padding: clamp(10px, 2.8vw, 12px) var(--space-xs);
            font-size: clamp(0.9rem, 2.5vw, 1rem);
            line-height: 1.4;
            resize: none;
            max-height: 7.5rem; /* ~120px, using rem */
            align-self: center; /* Vertically center single-line text */
        }
        textarea.chat-input:focus {
            outline: none; box-shadow: none;
        }

        .chat-input-action-button {
            background-color: var(--primary-accent);
            color: white;
            border: none;
            border-radius: 50%;
            width: clamp(40px, 11vw, 44px);
            height: clamp(40px, 11vw, 44px);
            font-size: clamp(1.2rem, 3.3vw, 1.3rem);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
            transition: transform 0.2s, background-color 0.2s;
        }
        .chat-input-action-button:active { transform: scale(0.9); }
        /* END CHAT INPUT FIELD REDESIGN */

        .ai-chat-summary-button-container { padding: var(--space-xs) var(--space-md); text-align:center; background-color: var(--chat-bg); /* Match messages area bg */}

        .typing-indicator { font-style: italic; color: var(--text-secondary-color); padding: var(--space-xs) var(--space-md); font-size: clamp(0.8rem, 2.2vw, 0.85rem); transition: opacity 0.2s; background-color: var(--chat-bg); /* Match messages area bg */}
        
        /* FIX: Reaction buttons UI cleanup */
        .message-reactions { 
            margin-top: var(--space-xs);
            display:flex; 
            gap: 4px; 
            align-self: flex-start;
            flex-wrap: wrap; /* Allow wrapping */
        }
        .chat-bubble.user .message-reactions { align-self: flex-end; justify-content: flex-end; }
        .reaction-button { background-color: color-mix(in srgb, var(--card-bg) 85%, transparent); border:1px solid var(--placeholder-bg); border-radius: var(--border-radius-lg); padding: 2px clamp(5px, 1.5vw, 7px); font-size:clamp(0.65rem, 1.8vw, 0.7rem); cursor:pointer; }
        .chat-bubble.user .reaction-button { background-color: color-mix(in srgb, var(--primary-accent) 80%, black 20%); color: rgba(255,255,255,0.9); border-color: transparent;}

        .reaction-button.reacted-by-user { background-color: var(--primary-accent); color:white; border-color: var(--primary-accent-darker);}
        body.dark-mode .reaction-button { background-color: #3e4042; border-color: #4a4c4e; }
        body.dark-mode .chat-bubble.user .reaction-button { background-color: color-mix(in srgb, var(--primary-accent) 90%, black 10%);}
        body.dark-mode .reaction-button.reacted-by-user { background-color: var(--primary-accent); border-color: var(--primary-accent-darker); }
        
        #mockUserSuggestionPopup { position: absolute; background-color: var(--card-bg); border: 1px solid var(--warm-gray); border-radius: var(--border-radius-sm); box-shadow: var(--element-shadow); z-index: 1100; padding: var(--space-xs); max-height: 120px; overflow-y: auto; bottom: calc(env(safe-area-inset-bottom) + 70px); /* Adjust based on chat input height */ left: var(--space-sm); right: var(--space-sm); width: auto; }
        .mock-user-suggestion-popup button { display: block; width: 100%; text-align: left; padding: var(--space-xs) var(--space-sm); background: none; border: none; cursor: pointer; border-radius: var(--border-radius-sm); font-size: clamp(0.85rem, 2.3vw, 0.9rem);}
        .mock-user-suggestion-popup button:hover { background-color: var(--placeholder-bg); }


        /* --- AI Assistant --- */
        .ai-fab { 
            position: fixed; 
            bottom: calc(75px + env(safe-area-inset-bottom)); /* Adjust for main nav and safe area */
            right: var(--space-md); 
            width: clamp(50px, 13vw, 60px); 
            height: clamp(50px, 13vw, 60px); 
            background-color: var(--primary-accent); 
            border-radius: 50%; 
            display: flex; 
            justify-content: center; 
            align-items: center; 
            color: white; 
            font-size: clamp(1.5rem, 4.5vw, 1.8rem); 
            box-shadow: var(--fab-shadow); 
            cursor: pointer; 
            z-index: 1001; 
            transition: transform 0.2s, background-color 0.2s, box-shadow 0.2s, width 0.2s, height 0.2s, opacity 0.2s; 
            border:none;
        }
        .ai-fab:active { transform: scale(0.95); background-color: var(--primary-accent-darker); box-shadow: var(--element-shadow); }
        .ai-fab.has-suggestion { background-color: var(--info-color); /* Animation can be added */ transform: scale(1.1); }
        .ai-fab.has-suggestion:active { background-color: color-mix(in srgb, var(--info-color) 80%, black); }

        .ai-bottom-sheet { 
            display: none; /* Initially hidden, managed by JS */
            transform: translateY(100%);
            transition: transform 0.3s ease-out, opacity 0.3s ease-out; /* Added opacity */
            opacity: 0; /* Initially transparent */
        }
        .ai-bottom-sheet.active { 
            transform: translateY(0);
            opacity: 1; /* Fully visible */
            border-radius: 0;
            padding: 0;
            background-color: var(--chat-bg); /* Match chat view */
            height: 100svh; /* Full viewport height */
        }
        /* AI Chat bubbles use general chat bubble styling, handled by .chat-bubble */
        .ai-chat-area { 
            flex-grow: 1; 
            overflow-y: auto; 
            margin-bottom: 0px; 
            display:flex; 
            flex-direction:column; 
            gap:var(--space-sm); /* Gap between bubbles */
            padding: var(--space-sm) var(--space-md);
            overscroll-behavior: contain;
            -webkit-overflow-scrolling: touch;
        }
        .ai-chat-area ul { list-style-position: inside; padding-left: var(--space-sm); margin: var(--space-xs) 0; }
        .ai-chat-area ul li { margin-bottom: var(--space-xs); }
        
        /* ENHANCEMENT: AI Chat Input container style tweaks */
        #aiBottomSheet .chat-input-container {
            flex-wrap: wrap; /* Allow suggestions to wrap */
        }
        #aiBottomSheet .chat-input-wrapper {
             background-color: var(--placeholder-bg);
        }
        body.dark-mode #aiBottomSheet .chat-input-wrapper {
             background-color: #2A2A2A;
        }

        .ai-chat-typing-suggestion { 
            font-size: clamp(0.7rem, 1.9vw, 0.75rem); 
            color: var(--text-secondary-color); 
            width:100%; 
            padding: 3px var(--space-xs) 0px var(--space-xs); 
            height: 1.2em;
            text-align: left;
            flex-basis: 100%; /* Take full width */
        }


        /* FIX: Sticky AI Quick Actions Bar */
        .ai-quick-actions-wrapper {
            position: sticky;
            top: 0;
            z-index: 5;
            background-color: var(--card-bg);
            border-bottom: 1px solid var(--placeholder-bg);
            padding: var(--space-sm) var(--space-md);
        }
        body.dark-mode .ai-quick-actions-wrapper { border-bottom-color: var(--warm-gray); }
        .ai-quick-actions { 
            display: flex; 
            gap: var(--space-xs); 
            overflow-x: auto; 
            scroll-snap-type: x mandatory;
        }
        .ai-quick-actions::-webkit-scrollbar { display: none; }
        .ai-quick-action-button { font-size:clamp(0.75rem, 2vw, 0.8rem); padding: var(--space-xs) clamp(6px, 1.8vw, 8px); background-color: var(--placeholder-bg); color:var(--text-color); border:none; border-radius: var(--border-radius-sm); cursor:pointer; transition: background-color 0.2s; white-space: nowrap; scroll-snap-align: start;}
        .ai-quick-action-button:hover { background-color: color-mix(in srgb, var(--placeholder-bg) 85%, black); }
        body.dark-mode .ai-quick-action-button { background-color: #444; }
        body.dark-mode .ai-quick-action-button:hover { background-color: #555; }


        /* --- Wellness --- */
        .mood-log-container { display: flex; justify-content: flex-start; margin-bottom: var(--space-md); padding: var(--space-sm); background-color: var(--placeholder-bg); border-radius: var(--border-radius-md); overflow-x: auto; -webkit-overflow-scrolling: touch; scroll-snap-type: x mandatory;}
        .mood-log-container::-webkit-scrollbar { height: 6px; }
        .mood-log-container::-webkit-scrollbar-thumb { background: var(--text-secondary-color); border-radius: 3px; }
        .mood-emoji-button { font-size: clamp(1.8rem, 5.5vw, 2.2rem); cursor: pointer; transition: transform 0.2s, opacity 0.2s; padding: var(--space-xs) clamp(6px, 1.8vw, 8px); opacity: 0.6; background:none; border:none; flex-shrink: 0; scroll-snap-align: center; }
        .mood-emoji-button:hover, .mood-emoji-button.selected { transform: scale(1.2); opacity: 1; }
        .mood-note-input { width: 100%; } 
        
        #habitListContainer { max-height: 350px; overflow-y: auto; padding-right: var(--space-xs); }
        .habit-tracker .habit-item { display: flex; justify-content: space-between; align-items: center; padding: var(--space-sm) 0; border-bottom: 1px solid var(--placeholder-bg); }
        body.dark-mode .habit-tracker .habit-item { border-bottom: 1px solid var(--warm-gray); }
        .habit-tracker .habit-item:last-child { border-bottom: none; }
        .habit-info { display: flex; flex-direction: column; flex-grow:1; margin-right:var(--space-sm); min-width: 0; }
        .habit-name { font-weight: 600; margin-bottom: 3px; font-size: clamp(0.9rem, 2.5vw, 1rem); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .habit-streak { font-size: clamp(0.75rem, 2vw, 0.8rem); color: var(--text-secondary-color); }
        .habit-progress-info { font-size: clamp(0.75rem, 2vw, 0.8rem); color: var(--primary-accent); } 
        .progress-ring-button { width: clamp(36px, 10vw, 40px); height: clamp(36px, 10vw, 40px); position: relative; cursor: pointer; background:none; border:none; padding:0; flex-shrink:0; }
        .progress-ring-circle { stroke-dasharray: 100.48; stroke-dashoffset: 100.48; stroke-linecap: round; transition: stroke-dashoffset 0.5s ease; }
        .progress-ring-button .completion-check { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); font-size: clamp(0.9rem, 2.5vw, 1rem); color: var(--primary-accent); opacity: 0; transition: opacity 0.3s; }
        .progress-ring-button.completed .completion-check { opacity: 1; }
        .habit-actions { display:flex; align-items:center; flex-shrink:0;}
        .habit-action-button { color: var(--text-secondary-color); margin-left:var(--space-xs); cursor:pointer; font-size:clamp(0.75rem, 2vw, 0.8rem); background:none; border:none; padding:var(--space-xs);}
        .habit-action-button.delete { color: var(--danger-color); }
        .water-tracker-buttons { display:flex; gap: var(--space-xs); margin-top: var(--space-sm);}
        .water-add-button { font-size:clamp(0.75rem, 2vw, 0.8rem); padding: clamp(4px, 1.2vw, 6px) clamp(8px, 2.2vw, 10px);}
        .ai-wellness-insight { background-color: var(--ai-suggestion-bg); padding: var(--space-sm) var(--space-md); border-radius: var(--border-radius-md); font-size: clamp(0.8rem, 2.2vw, 0.85rem); margin-bottom: var(--space-sm); color: var(--text-color); border: 1px solid color-mix(in srgb, var(--primary-accent) 30%, transparent);}
        .ai-wellness-insight i { color: var(--primary-accent); margin-right: var(--space-xs);}
        #viewMoodCalendarButton { /* For specific prominence */
            background-color: var(--primary-accent); color:white;
            font-weight: 500;
        }
        #viewMoodCalendarButton:active {
            background-color: var(--primary-accent-darker);
        }
        body.dark-mode #viewMoodCalendarButton {
             background-color: var(--primary-accent); color:white;
        }
        #aiPatternCard {
            background-color: var(--ai-suggestion-bg);
            border: 1px dashed var(--primary-accent);
        }


        /* --- Settings --- */
        .settings-list .setting-item { display: flex; justify-content: space-between; align-items: center; padding: clamp(14px, 3.8vw, 18px) 0; border-bottom: 1px solid var(--placeholder-bg); cursor: pointer; transition: background-color 0.1s;}
        .settings-list .setting-item:hover { background-color: color-mix(in srgb, var(--primary-accent) 5%, transparent); }
        body.dark-mode .settings-list .setting-item { border-bottom: 1px solid var(--warm-gray); }
        body.dark-mode .settings-list .setting-item:hover { background-color: color-mix(in srgb, var(--primary-accent) 10%, var(--card-bg)); }

        .settings-list .setting-item:last-child { border-bottom: none; }
        .setting-item .setting-label { font-size: clamp(0.95rem, 2.6vw, 1rem); flex-grow: 1; margin-right: var(--space-sm); }
        .setting-item .setting-value, .setting-item i:not(.theme-color-dot) { color: var(--text-secondary-color); flex-shrink: 0; font-size: clamp(0.9rem, 2.5vw, 1rem);}
        .setting-item .toggle-switch-button { background:none; border:none; padding:0; cursor:pointer; flex-shrink: 0;}
        .setting-item .toggle-switch { width: 50px; height: 26px; background-color: var(--warm-gray); border-radius: 13px; position: relative;  transition: background-color 0.2s; display:inline-block; }
        .setting-item .toggle-switch.active { background-color: var(--primary-accent); }
        .setting-item .toggle-switch::before { content: ''; position: absolute; width: 22px; height: 22px; border-radius: 50%; background-color: white; top: 2px; left: 2px; transition: transform 0.2s ease-in-out; box-shadow: 0 1px 3px rgba(0,0,0,0.2); }
        .setting-item .toggle-switch.active::before { transform: translateX(24px); }
        
        /* Modal Toggle Fix - General Rule for all modals */
        .modal .setting-item { padding: var(--space-sm) 0; }
        .modal .setting-item .setting-label { flex-grow: 1; margin-right: var(--space-sm); }
        .modal .setting-item .toggle-switch-button { flex-shrink: 0; }

        .theme-selector { display: flex; gap: var(--space-sm); }
        .theme-color-button { background:none; border:2px solid transparent; padding:0; border-radius:50%; cursor:pointer;}
        .theme-color-dot { width: clamp(20px, 5.5vw, 24px); height: clamp(20px, 5.5vw, 24px); border-radius: 50%; box-shadow: var(--element-shadow); display:block;}
        .theme-color-button.active { border-color: var(--text-color); }

        /* --- Modal --- */
        .modal { display: none; position: fixed; z-index: 2000; left: 0; top: 0; width: 100%; height: 100svh; overflow: auto; background-color: rgba(var(--shadow-color-rgb),0.5); justify-content: center; align-items: center; padding: var(--space-md); }
        .modal.active { display: flex; animation: fadeInModal 0.3s ease; }
        .modal-content { 
            background-color: var(--card-bg); 
            padding: var(--space-lg); 
            border-radius: var(--border-radius-lg); 
            box-shadow: 0 10px 30px rgba(var(--shadow-color-rgb),0.2); 
            width: 100%; 
            max-width: 400px; 
            position: relative; 
            animation: slideInModal 0.3s ease; 
            max-height: 85svh; /* User request */
            overflow-y:auto;
            overscroll-behavior: contain;
            -webkit-overflow-scrolling: touch;
        }
        .modal-close-button { position: absolute; top: var(--space-sm); right: var(--space-md); font-size: clamp(1.3rem, 4vw, 1.5rem); color: var(--text-secondary-color); cursor: pointer; background:none; border:none; padding:var(--space-xs);}
        @keyframes fadeInModal { from { opacity: 0; } to { opacity: 1; } }
        @keyframes slideInModal { from { transform: translateY(-30px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        .modal-title { font-size: clamp(1.2rem, 3.5vw, 1.3rem); font-weight: 600; margin-bottom: var(--space-sm); }
        .modal-body p { margin-bottom: var(--space-sm); line-height: 1.5; font-size: clamp(0.9rem, 2.5vw, 1rem); }
        .modal-body ul { list-style-position: inside; padding-left: var(--space-xs); margin-bottom: var(--space-sm);}
        .modal-body li { margin-bottom: var(--space-xs); font-size: clamp(0.9rem, 2.5vw, 1rem); }
        .icon-selector { display:flex; flex-wrap:wrap; gap:var(--space-sm); margin-bottom:var(--space-sm); justify-content:center;}
        .icon-selector .icon-option { padding:var(--space-sm); border-radius:var(--border-radius-sm); border:1px solid var(--warm-gray); cursor:pointer; font-size:clamp(1.3rem, 4vw, 1.5rem); width:clamp(44px, 12vw, 50px); height:clamp(44px, 12vw, 50px); display:flex; align-items:center; justify-content:center; transition: background-color 0.2s, border-color 0.2s;}
        .icon-selector .icon-option:hover, .icon-selector .icon-option.selected { background-color:var(--primary-accent); color:white; border-color:var(--primary-accent);}
        .rating-stars { margin-top:var(--space-xs); margin-bottom:var(--space-sm); }
        .rating-stars .fa-star { color: var(--warm-gray); cursor:pointer; font-size:clamp(1.3rem, 4vw, 1.5rem); margin:0 2px; transition: color 0.2s;}
        .rating-stars .fa-star.selected, .rating-stars .fa-star:hover, .rating-stars .fa-star:hover ~ .fa-star { color: #FFC107; }

        /* Notification Modal Styles */
        #notificationsModal .modal-content { max-height: 85svh; padding-bottom: 70px; } /* More space for notifications */
        .notification-list { list-style: none; padding: 0; }
        .notification-item { display: flex; align-items: flex-start; padding: var(--space-sm) 0; border-bottom: 1px solid var(--placeholder-bg); }
        body.dark-mode .notification-item { border-bottom-color: var(--warm-gray); }
        .notification-item:last-child { border-bottom: none; }
        .notification-icon { font-size: clamp(1.1rem, 3vw, 1.2rem); color: var(--primary-accent); margin-right: var(--space-sm); width: 25px; text-align: center; margin-top: 3px; flex-shrink: 0;}
        .notification-content { flex-grow: 1; }
        .notification-title { font-weight: 600; font-size: clamp(0.9rem, 2.5vw, 0.95rem); margin-bottom: 3px; }
        .notification-text { font-size: clamp(0.8rem, 2.2vw, 0.85rem); color: var(--text-secondary-color); line-height: 1.4; }
        .notification-timestamp { font-size: clamp(0.65rem, 1.8vw, 0.7rem); color: var(--text-secondary-color); margin-top: var(--space-xs); }
        .notification-item.unread .notification-title { color: var(--primary-accent); font-weight: 700; }


        /* --- Toast Notification --- */
        .toast-notification { 
            position: fixed; 
            bottom: var(--space-md); 
            left: 50%; 
            transform: translateX(-50%); 
            background-color: rgba(30,30,30,0.9); 
            color: white; 
            padding: clamp(10px, 2.8vw, 12px) clamp(16px, 4vw, 20px); 
            border-radius: var(--border-radius-md); 
            font-size: clamp(0.85rem, 2.3vw, 0.9rem); 
            z-index: 3000; 
            opacity: 0; 
            transition: opacity 0.3s, bottom 0.3s, transform 0.3s; 
            pointer-events: none; 
            box-shadow: 0 4px 10px rgba(var(--shadow-color-rgb),0.15); 
            max-width: calc(100% - (2 * var(--space-md))); /* Ensure it doesn't touch screen edges */
            text-align: center;
        }
        body.dark-mode .toast-notification { background-color: rgba(240,240,240,0.9); color: #333;}
        .toast-notification.show { opacity: 1; bottom: calc(var(--space-lg) + env(safe-area-inset-bottom)); } /* Default position */
        .app-container:not(.hidden) ~ .toast-notification.show { bottom: calc(60px + var(--space-lg) + env(safe-area-inset-bottom)); } /* Position above nav when app is visible and nav is present*/
        .toast-notification.ai-info-toast { background-color: var(--ai-info-toast-bg) !important; color:white !important; }
        body.dark-mode .toast-notification.ai-info-toast { background-color: var(--ai-info-toast-bg) !important; color:white !important; }

        /* Full Page Calendar Modal Styles */
        #fullCalendarModal .modal-content {
            max-width: 95vw;
            width: 100%;
            height: 90svh; /* Use svh */
            display: flex; /* Enable flexbox for layout */
            flex-direction: column;
        }
        @media (min-width: 768px) {
            #fullCalendarModal .modal-content { max-width: 800px; }
        }
        .calendar-container { display: flex; flex-direction: column; height: 100%; flex-grow: 1; overflow: hidden; }
        .calendar-header { display: flex; justify-content: space-between; align-items: center; padding-bottom: var(--space-sm); }
        .calendar-grid { flex-grow: 1; display: grid; grid-template-columns: repeat(7, 1fr); grid-auto-rows: minmax(clamp(50px, 10vh, 70px), 1fr); gap: 2px; overflow-y: auto; /* Allow grid to scroll if content overflows */ overscroll-behavior: contain; -webkit-overflow-scrolling: touch;}
        .calendar-day-header { text-align: center; font-weight: 600; color: var(--text-secondary-color); font-size: clamp(0.7rem, 2vw, 0.8rem); padding-bottom: var(--space-xs);}
        .calendar-day { background-color: var(--placeholder-bg); border-radius: var(--border-radius-sm); padding: var(--space-xs); overflow-y: auto; cursor: pointer; }
        .calendar-day.other-month { opacity: 0.4; }
        .calendar-day.today { border: 2px solid var(--primary-accent); }
        .calendar-day .day-number { font-weight: 500; font-size: clamp(0.7rem, 2vw, 0.8rem); }
        .calendar-day .task-indicator { font-size: clamp(0.6rem, 1.7vw, 0.65rem); padding: 2px 4px; border-radius: 4px; margin-top: 3px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .calendar-day .mood-indicator { font-size: clamp(1rem, 3vw, 1.2rem); display: block; text-align: center; margin-top: var(--space-xs); }
        .day-detail-panel { margin-top: var(--space-sm); padding: var(--space-sm); background-color: var(--ai-suggestion-bg); border-radius: var(--border-radius-md); }
        .day-detail-panel h4 { font-size: clamp(0.95rem, 2.6vw, 1rem); }
        .day-detail-panel ul { list-style: none; padding-left: 0; }

        /* Habit Stats Modal */
        .habit-stat-item { margin-bottom: var(--space-sm); }
        .habit-stat-item .stat-title { font-weight: 500; font-size: clamp(0.85rem, 2.3vw, 0.9rem); }
        .progress-bar-container { width: 100%; background-color: var(--placeholder-bg); border-radius: 5px; height: 10px; overflow: hidden; margin-top: var(--space-xs); }
        .progress-bar { height: 100%; background-color: var(--primary-accent); border-radius: 5px; transition: width 0.5s ease; }
        
        /* --- Utility classes & Responsive --- */
        .mb-1{margin-bottom:var(--space-xs)}.mb-2{margin-bottom:var(--space-sm)}.mb-3{margin-bottom:var(--space-md)}.mb-4{margin-bottom:var(--space-lg)}
        .mt-1{margin-top:var(--space-xs)}.mt-2{margin-top:var(--space-sm)}.mt-3{margin-top:var(--space-md)}.mt-4{margin-top:var(--space-lg)}
        .text-center{text-align:center}.hidden{display:none !important}
        .placeholder-box { background-color: var(--placeholder-bg); border-radius:var(--border-radius-md); padding:var(--space-md); color:var(--text-secondary-color); text-align:center; }
        .visually-hidden { position: absolute; width: 1px; height: 1px; padding: 0; margin: -1px; overflow: hidden; clip: rect(0, 0, 0, 0); border: 0; } /* Accessibility */


        /* Responsive adjustments */
        /* Default: Mobile-first styles are above */

        /* Ultra-small screens */
        @media (max-width: 360px) {
             .nav-item i { font-size: 1.15rem; } /* Slightly smaller */
             .mood-emoji-button { font-size: clamp(1.6rem, 5vw, 1.8rem); padding: 4px clamp(4px, 1.2vw, 5px); }
             .place-card img, .deal-card img { width: clamp(45px, 12vw, 50px); height: clamp(45px, 12vw, 50px); }
             .place-card, .deal-card { gap: var(--space-xs); }
             .card-title { font-size: clamp(1rem, 3vw, 1.1rem); }
             .task-title { font-size: clamp(0.85rem, 2.4vw, 0.9rem); }
             .pinned-widget-item .widget-value { font-size: clamp(0.8rem, 2.2vw, 0.85rem); }
             .ai-fab { width: 48px; height: 48px; font-size: 1.4rem; bottom: calc(65px + env(safe-area-inset-bottom)); right: var(--space-sm); }
             .calendar-grid { grid-auto-rows: minmax(clamp(45px, 9vh, 60px), 1fr); }
             .calendar-day .day-number { font-size: clamp(0.65rem, 1.8vw, 0.7rem); }
        }

        /* Desktop / Wider View - App Centered */
        @media (min-width: 451px) {
            body { background-color: var(--placeholder-bg); } /* Different background for the "outside" area */
            body.dark-mode { background-color: #000; }
            .app-container { 
                border-radius: var(--border-radius-lg); 
                box-shadow: 0 10px 40px rgba(var(--shadow-color-rgb), 0.15); 
                height: calc(100svh - 40px); /* Adjust height for margin */
                max-height: 850px; /* Max height of the app frame */
                margin: 20px auto; /* Vertical margin for spacing */
            }
            /* Ensure bottom rounded corners for elements that stick to the bottom of app-container */
            .bottom-nav {
                border-bottom-left-radius: var(--border-radius-lg);
                border-bottom-right-radius: var(--border-radius-lg);
            }
             #specificChatView.active, #aiBottomSheet.active {
                /* When app-container is constrained, these should also be constrained */
                left: auto; right: auto; /* Allow max-width to center it */
                border-bottom-left-radius: var(--border-radius-lg);
                border-bottom-right-radius: var(--border-radius-lg);
            }
            /* Optionally, make chat/AI sheet full height of the app-container, not viewport */
            #specificChatView.active, #aiBottomSheet.active {
                height: 100%; /* Fill the constrained .app-container */
            }

            #placesList.grid-view { grid-template-columns: repeat(2, 1fr); }
            #pinnedWidgetsContainer { grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); }
        }
        
        /* Tablet specific adjustments (within constrained app view or for a wider app view if max-width of app-container changes) */
        @media (min-width: 768px) {
            .app-container {
                 max-width: 600px; /* Example: slightly wider app frame on tablets */
            }
            .content {
                padding: var(--space-lg) var(--space-lg) calc(var(--space-xl) + 70px + env(safe-area-inset-bottom)) var(--space-lg); /* Larger padding */
            }
            #pinnedWidgetsContainer { grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); }
            .card-title { font-size: clamp(1.2rem, 3vw, 1.3rem); } /* Slightly larger titles */
        }
    </style>
</head>
<body>
    <!-- NEW: Authentication Container -->
    <div id="authContainer">
        <section id="loginScreen" class="auth-screen active" aria-labelledby="loginTitle">
            <i class="fas fa-street-view auth-logo" aria-hidden="true"></i>
            <h1 id="loginTitle" class="auth-title">Welcome to LocalLife OS</h1>
            <p class="auth-subtitle">Your community, connected.</p>
            <form id="loginForm" class="auth-form">
                <div class="input-group">
                    <label for="loginEmail" class="visually-hidden">Email or Username</label>
                    <input type="email" id="loginEmail" class="input-field" placeholder="Email or Username" required>
                </div>
                <div class="input-group">
                    <label for="loginPassword" class="visually-hidden">Password</label>
                    <input type="password" id="loginPassword" class="input-field" placeholder="Password" required>
                </div>
                <button type="button" class="button" onclick="handleLoginAttempt()">Login</button>
            </form>
            <a href="#" class="auth-link" onclick="showSignupScreen()">Don't have an account? Sign Up</a>
            <a href="#" class="auth-link" style="font-size:0.8rem; margin-top:10px;" onclick="showToast('Password recovery is a conceptual feature.', 'info')">Forgot Password?</a>
        </section>

        <section id="signupScreen" class="auth-screen" aria-labelledby="signupTitle">
            <i class="fas fa-user-plus auth-logo" aria-hidden="true"></i>
            <h1 id="signupTitle" class="auth-title">Create Account</h1>
            <p class="auth-subtitle">Join your local community.</p>
            <form id="signupForm" class="auth-form">
                <div class="input-group">
                    <label for="signupName" class="visually-hidden">Full Name</label>
                    <input type="text" id="signupName" class="input-field" placeholder="Full Name" required>
                </div>
                <div class="input-group">
                    <label for="signupEmail" class="visually-hidden">Email</label>
                    <input type="email" id="signupEmail" class="input-field" placeholder="Email Address" required>
                </div>
                <div class="input-group">
                    <label for="signupPassword" class="visually-hidden">Password</label>
                    <input type="password" id="signupPassword" class="input-field" placeholder="Create Password" required>
                </div>
                 <div class="input-group">
                    <label for="signupConfirmPassword" class="visually-hidden">Confirm Password</label>
                    <input type="password" id="signupConfirmPassword" class="input-field" placeholder="Confirm Password" required>
                </div>
                <button type="button" class="button" onclick="handleSignupAttempt()">Sign Up</button>
            </form>
            <a href="#" class="auth-link" onclick="showLoginScreen()">Already have an account? Login</a>
        </section>
    </div>
    <!-- END: Authentication Container -->

    <div class="app-container hidden"> <!-- Initially hidden -->
        <main class="content">
            <!-- 1. Hyperlocal Dashboard Screen -->
            <section id="dashboard" class="screen active" aria-labelledby="dashboardTitle">
                <div class="screen-header">
                    <div class="title-group">
                        <p class="ai-greeting" id="aiGreeting">Good Morning, Shamase!</p>
                    </div>
                    <button class="action-button" onclick="showNotificationsPanel()" aria-label="View notifications">
                        <i class="fas fa-bell"></i>
                        <span id="unreadNotificationBadge" class="unread-notification-badge hidden">0</span>
                    </button>
                </div>
                <h2 id="dashboardTitle" class="card-subtitle mb-3" style="font-size: clamp(0.9rem, 2.5vw, 1rem); font-weight: 500;">Here's your LocalLife snapshot.</h2>

                <article class="card local-context-card no-press" id="localContextCard" aria-labelledby="localContextTitle">
                    <h3 id="localContextTitle" class="visually-hidden">Local Context</h3>
                    <div class="context-item"><i class="fas fa-clock" aria-hidden="true"></i> <span id="localTimeDate">--:-- --, ---, --- --</span></div>
                    <div class="context-item"><i class="fas fa-cloud-sun" aria-hidden="true"></i> <span id="currentWeather">24°C, Sunny - Downtown</span></div>
                    <div class="context-item"><i class="fas fa-map-marker-alt" aria-hidden="true"></i> <span id="currentLocation">Home (Greenwood Ave)</span></div>
                </article>
                
                <div id="nearbyPulseSection"> <!-- Wrapper for H3 and carousel for easier show/hide -->
                    <h3 class="card-title">Nearby Pulse</h3>
                    <div class="nearby-pulse-carousel" role="region" aria-label="Nearby local events and points of interest">
                        <button class="story-item" onclick="showPulseDetailModal('Farmers Market', 'fas fa-store', 'Fresh local produce, artisan goods, and community vibes. Open Saturdays 9 AM - 1 PM at Central Plaza. AI Suggests: Check out the new organic bakery stall!')" aria-label="View Farmers Market details">
                            <div class="story-avatar"><i class="fas fa-store" aria-hidden="true"></i></div><span class="story-label">Farmers Market</span>
                        </button>
                        <button class="story-item" onclick="showPulseDetailModal('Yoga in the Park', 'fas fa-person-hiking', 'Free community yoga session every Sunday at 10 AM in Willow Creek Park (near the fountain). All levels welcome. Bring your own mat. AI Suggests: Grab a healthy smoothie from \'The Green Spot\' nearby afterwards!')" aria-label="View Yoga in the Park details">
                            <div class="story-avatar"><i class="fas fa-person-hiking" aria-hidden="true"></i></div><span class="story-label">Yoga in Park</span>
                        </button>
                        <button class="story-item" onclick="showPulseDetailModal('New Cafe Opening: \'The Grind House\'', 'fas fa-mug-saucer', 'Grand opening of \'The Grind House\' cafe today! Speciality coffees, pastries, and a cozy atmosphere. Located at 123 Main Street. AI Suggests: They have a 20% off opening day special!')" aria-label="View New Cafe Opening details">
                            <div class="story-avatar"><i class="fas fa-mug-saucer" aria-hidden="true"></i></div><span class="story-label">New Cafe</span>
                        </button>
                         <button class="story-item" onclick="showPulseDetailModal('Local Band: \'The Night Owls\'', 'fas fa-guitar', 'Catch \'The Night Owls\' live at The Downbeat Lounge tonight at 9 PM. Cover charge $5. Playing rock and blues. AI Suggests: The Downbeat has great local craft beers on tap.')" aria-label="View Local Band Gig details">
                            <div class="story-avatar"><i class="fas fa-guitar" aria-hidden="true"></i></div><span class="story-label">Band Gig</span>
                        </button>
                         <button class="story-item" onclick="showPulseDetailModal('Community Garden Meetup', 'fas fa-seedling', 'Join the monthly Community Garden Meetup this Wednesday at 6 PM. Share tips, swap seeds, and help maintain our beautiful green space. Location: End of Oak Street. AI Suggests: Bring your own gloves and a small trowel if you have one!')" aria-label="View Community Garden Meetup">
                            <div class="story-avatar"><i class="fas fa-seedling"></i></div><span class="story-label">Garden Club</span>
                        </button>
                        <button class="story-item" onclick="showPulseDetailModal('Community Cleanup Day', 'fas fa-recycle', 'Help keep our neighborhood beautiful! Join the cleanup drive this Saturday, starting 9 AM at the Town Hall. Gloves and bags provided. AI Suggests: Afterwards, volunteers get a free coffee voucher for \'The Cozy Corner Cafe\'.')" aria-label="View Community Cleanup details">
                            <div class="story-avatar"><i class="fas fa-recycle" aria-hidden="true"></i></div><span class="story-label">Cleanup Day</span>
                        </button>
                    </div>
                </div>


                <article class="card" id="dashboardTaskListCard" aria-labelledby="dayViewTitle">
                    <h3 id="dayViewTitle" class="card-title">Dynamic Day View</h3>
                    <div id="dashboardTaskList" aria-live="polite">
                        <!-- Skeleton loader will be injected here by JS -->
                    </div>
                    <div id="aiDashboardInsight" class="hidden"></div>
                     <button class="button button-secondary mt-2" style="width:100%; font-size:clamp(0.85rem, 2.3vw, 0.9rem);" onclick="setActiveScreen('planner')">View Full Planner</button>
                </article>
                
                <article class="card" id="pinnedWidgetsCard" aria-labelledby="pinnedWidgetsTitle">
                    <h3 id="pinnedWidgetsTitle" class="card-title">Pinned Widgets</h3>
                     <p class="card-subtitle" style="font-size:clamp(0.75rem, 2vw, 0.8rem); margin-top:-5px; margin-bottom:10px;"><em>AI auto-updates relevant info here. Configurable in Settings.</em></p>
                    <div id="pinnedWidgetsContainer" aria-live="polite">
                        <!-- Pinned widgets will be dynamically rendered here -->
                        <div class="skeleton-loader"> <!-- Skeleton for pinned widgets -->
                            <div class="pinned-widget-item"><div class="skeleton-item title" style="width: 80%; height: 12px;"></div><div class="skeleton-item text" style="width: 60%; height: 10px;"></div></div>
                            <div class="pinned-widget-item"><div class="skeleton-item title" style="width: 70%; height: 12px;"></div><div class="skeleton-item text" style="width: 50%; height: 10px;"></div></div>
                        </div>
                    </div>
                </article>

                <article class="card" id="proactiveSuggestionsCard" aria-labelledby="suggestionsTitle">
                    <h3 id="suggestionsTitle" class="card-title">Smart Proactive Suggestions</h3>
                    <div id="proactiveSuggestionsContainer">
                        <!-- Suggestions will be injected here by JS -->
                        <p class="card-subtitle"><i class="fas fa-spinner fa-spin" style="color: var(--primary-accent);" aria-hidden="true"></i> AI is thinking of suggestions...</p>
                    </div>
                </article>

                <article class="card" id="topDealsCard" aria-labelledby="topDealsTitle">
                    <h3 id="topDealsTitle" class="card-title">Today's Top Deals (AI Curated)</h3>
                    <div id="dashboardDealsList" aria-live="polite">
                        <!-- Skeleton or deals will be injected here -->
                    </div>
                    <button class="button button-secondary mt-2" style="width:100%; font-size:clamp(0.85rem, 2.3vw, 0.9rem);" onclick="navigateToExploreDeals()">View More Deals in Explore</button>
                </article>
                
                <div class="safety-ticker" id="safetyTicker" role="alert" onclick="cycleSafetyTicker()">
                    <i class="fas fa-bullhorn" aria-hidden="true"></i> <!-- Changed icon -->
                    <span id="safetyTickerText">Water outage on Main Street until 2 PM. Report issues at City Hall.</span>
                    <button class="sos-button" onclick="event.stopPropagation(); triggerSOS()" aria-label="Trigger SOS (mock)">SOS</button>
                </div>
            </section>

            <!-- 2. AI-Powered Daily Planner Screen -->
            <section id="planner" class="screen" aria-labelledby="plannerTitle">
                <div class="screen-header"><h2 id="plannerTitle" class="title">AI Daily Planner</h2></div>
                <p class="card-subtitle mb-3">Manage your schedule effortlessly. AI helps parse tasks and suggests optimizations. Haptic feedback (conceptual) on task completion.</p>

                <article class="card" aria-labelledby="addTaskSectionTitle">
                    <h3 id="addTaskSectionTitle" class="visually-hidden">Add New Task</h3>
                    <div class="add-task-input-container">
                        <div class="input-group" style="flex-grow:1; margin-bottom:0;">
                            <input type="text" id="newTaskInput" class="input-field add-task-input" placeholder="Add task (e.g., 'Plan Mom's birthday party')" aria-label="New task input">
                            <button id="clearNewTaskInput" class="input-clear-btn hidden" onclick="clearInputField('newTaskInput', this)" aria-label="Clear new task input">&times;</button>
                        </div>
                        <button class="button add-task-button" onclick="addNewTask()" aria-label="Add new task"><i class="fas fa-plus" aria-hidden="true"></i></button>
                    </div>
                    <div id="aiPlannerSuggestion" class="ai-planner-suggestion hidden"></div>
                    
                </article>

                <article class="card" aria-labelledby="scheduleTitle">
                    <h3 id="scheduleTitle" class="card-title">Today's Schedule</h3>
                    <div class="calendar-view-placeholder" id="calendarPlaceholder" aria-label="Mini calendar view"></div>
                    <ul class="task-list" id="taskList" aria-label="List of tasks">
                        <!-- Skeleton loader will be injected here by JS -->
                    </ul>
                </article>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: var(--space-sm);">
                    <button class="button" onclick="addNewTask()"><i class="fas fa-plus-circle" aria-hidden="true"></i> Add Task</button>
                    <button class="button" onclick="aiScheduleMyDay()"><i class="fas fa-magic"></i> AI, Schedule Day</button>
                </div>
                <button class="button button-secondary" style="width:100%; margin-top: var(--space-sm);" onclick="openFullCalendar('tasks')"><i class="fas fa-calendar-week" aria-hidden="true"></i> View Full Calendar</button>
                <button class="button button-secondary mt-2" style="width:100%;" onclick="optimizeMyDay()"><i class="fas fa-wand-magic-sparkles" aria-hidden="true"></i> Optimize My Day (AI)</button>
                <button class="button button-secondary mt-2" style="width:100%;" onclick="getAIDayBrief()"><i class="fas fa-comment-dots"></i> Get AI Day Brief</button>
            </section>

            <!-- 3. Explore Nearby Module Screen -->
            <section id="explore" class="screen" aria-labelledby="exploreTitle">
                <div class="screen-header"><h2 id="exploreTitle" class="title">Explore Nearby</h2></div>
                <p class="card-subtitle mb-3">Discover what's around you. AI provides personalized suggestions. Real-time map updates (conceptual).</p>

                <div class="search-bar-container">
                    <div class="input-group" style="flex-grow:1; margin-bottom:0;">
                        <input type="search" id="exploreSearchInput" class="input-field" placeholder="Search places, events, deals..." aria-label="Search nearby places, events, and deals">
                        <button id="clearExploreSearchInput" class="input-clear-btn hidden" onclick="clearInputField('exploreSearchInput', this); handleExploreSearch(true);" aria-label="Clear search input">&times;</button>
                    </div>
                    <button class="button" onclick="handleExploreSearch()" aria-label="Submit search"><i class="fas fa-search"></i></button>
                </div>

                <div class="map-placeholder" id="mapPlaceholder" role="application" aria-label="Interactive Map Area">
                    <div id="mapOverlayText" class="map-overlay-text hidden"></div>
                    <div class="map-actions">
                        <button class="map-action-button" onclick="openAILayersModal()" aria-label="Open AI Map Layers"><i class="fas fa-layer-group"></i> AI Layers</button>
                    </div>
                </div>
                <div class="filter-bar" id="exploreFilterBar" role="tablist" aria-label="Filter places by category">
                    <button class="filter-button active" role="tab" aria-selected="true" data-filter="all" onclick="filterPlaces('all', this)">All Places</button>
                    <button class="filter-button" role="tab" aria-selected="false" data-filter="ai_recommended" onclick="filterPlaces('ai_recommended', this)"><i class="fas fa-wand-magic-sparkles" style="margin-right:5px;"></i>AI Picks</button>
                    <button class="filter-button" role="tab" aria-selected="false" data-filter="deals" onclick="filterPlaces('deals', this)">Deals</button>
                    <button class="filter-button" role="tab" aria-selected="false" data-filter="events" onclick="filterPlaces('events', this)">Events</button>
                    <button class="filter-button" role="tab" aria-selected="false" data-filter="food" onclick="filterPlaces('food', this)">Food</button>
                    <button class="filter-button" role="tab" aria-selected="false" data-filter="shops" onclick="filterPlaces('shops', this)">Shops</button>
                    <button class="filter-button" role="tab" aria-selected="false" data-filter="parks" onclick="filterPlaces('parks', this)">Parks</button>
                    <button class="filter-button" role="tab" aria-selected="false" data-filter="services" onclick="filterPlaces('services', this)">Services</button>
                    <button class="filter-button" role="tab" aria-selected="false" data-filter="open_now" onclick="filterPlaces('open_now', this)">Open Now</button>
                </div>
                <div id="aiExploreSuggestion" class="card hidden no-press">
                    <h4 class="card-title"><i class="fas fa-lightbulb"></i> AI Suggestion</h4>
                    <p id="aiExploreSuggestionText" class="card-subtitle" style="margin-bottom:10px;"></p>
                    <button class="button suggestion-action" id="aiExploreSuggestionAction">Sounds good!</button>
                </div>
                <div id="placesList" class="grid-view" aria-live="polite"> <!-- This will now also show deals based on filter -->
                    <!-- Skeleton loader will be injected here by JS -->
                </div>
                <button class="button button-secondary mt-2" style="width:100%" onclick="openSubmitTipModal()"><i class="fas fa-plus-circle"></i> Submit a Community Tip</button>
                <button class="button mt-2" style="width:100%" onclick="openSubmitDealModal()"><i class="fas fa-tags"></i> Submit a Deal/Offer</button>
                <p class="card-subtitle mt-2 text-center" style="font-size:clamp(0.75rem, 2vw, 0.8rem);"><em>AI can also learn your preferences for distance & rating over time (Conceptual)</em></p>
            </section>

            <!-- 4. Local Chat + Community Hub Screen -->
            <section id="chat" class="screen" aria-labelledby="chatTitle">
                <div id="chatScreenContainer"> <!-- Ensure this container is what becomes 100svh when active -->
                    <div id="channelListView">
                        <div class="screen-header chat-section-header">
                            <div class="title-group"><h2 id="chatTitle" class="title">Local Community</h2></div>
                        </div>
                         <!-- NEW: Toggle for Channels / DMs -->
                        <div class="channel-list-toggle">
                            <button id="showChannelsBtn" class="active" onclick="toggleChannelListType('channels', this)">Channels</button>
                            <button id="showDMsBtn" onclick="toggleChannelListType('dms', this)">Messages</button>
                        </div>
                        <p class="card-subtitle mb-3 chat-section-header">Connect with your neighborhood. AI can help summarize channels or suggest replies (Conceptual).</p>
                        <div class="channel-list" id="communityChannelList" aria-labelledby="channelsListTitle">
                            <!-- Skeleton loader will be injected here by JS -->
                        </div>
                        <div style="padding: 0 var(--space-md);"> <!-- Wrapper for buttons -->
                            <button class="button mt-2" style="width:100%" onclick="openCreateChannelModal()"><i class="fas fa-plus-circle"></i> Create New Channel</button>
                            <button class="button button-secondary mt-2" style="width:100%" onclick="aiSuggestChannelToJoin()"><i class="fas fa-wand-magic-sparkles"></i> AI: Suggest a Channel for Me</button>
                        </div>
                    </div>

                    <div id="specificChatView" class="hidden"> <!-- This is the full-page chat view -->
                        <div class="specific-chat-content">
                            <!-- UPDATED CHAT HEADER -->
                            <div class="screen-header" style="padding: var(--space-sm) var(--space-md); border-bottom: 1px solid var(--placeholder-bg); flex-shrink:0;">
                                <button class="back-button" onclick="showChannelListView()" aria-label="Go back to channel list"><i class="fas fa-arrow-left" aria-hidden="true"></i></button>
                                <div id="specificChatHeaderInfo" class="chat-header-info" onclick="showChannelDetailModal()">
                                    <img id="specificChatAvatar" src="" alt="Chat Avatar" class="chat-header-avatar">
                                    <div class="chat-header-text">
                                        <h2 id="specificChatTitle" class="title">Channel Name</h2>
                                        <span id="specificChatStatus" class="chat-header-status">Tap for info</span> <!-- Mock -->
                                    </div>
                                </div>
                                <div class="chat-header-actions">
                                    <button class="action-button" onclick="mockCall('voice')" aria-label="Voice Call (mock)"><i class="fas fa-phone"></i></button>
                                    <button class="action-button" onclick="mockCall('video')" aria-label="Video Call (mock)"><i class="fas fa-video"></i></button>
                                    <button class="action-button" onclick="showChannelDetailModal()" aria-label="View channel info and actions"><i class="fas fa-info-circle"></i></button>
                                </div>
                            </div>
                            <!-- END UPDATED CHAT HEADER -->
                            <div id="aiChatSummaryButtonContainer" class="ai-chat-summary-button-container hidden"></div>
                            <div class="chat-messages-area" id="specificChatMessagesArea" aria-live="polite"></div>
                            <div id="typingIndicatorArea" class="typing-indicator hidden" aria-live="polite"></div>
                            <!-- NEW CHAT INPUT -->
                            <div class="chat-input-container">
                                <div class="chat-input-wrapper">
                                    <button class="chat-icon-button" onclick="showToast('Emoji picker would open (conceptual).', 'info')" aria-label="Open emoji picker (mock)"><i class="far fa-smile"></i></button>
                                    <textarea id="specificChatInput" class="input-field chat-input" placeholder="Message" aria-label="Chat message input" rows="1" oninput="autoGrowTextarea(this); handleChatInputTyping(this, 'specific');"></textarea>
                                    <button id="specificChatAttachBtn" class="chat-icon-button hides-on-typing" onclick="mockChannelAttachFile()" aria-label="Attach file (mock)"><i class="fas fa-paperclip"></i></button>
                                    <button id="specificChatCameraBtn" class="chat-icon-button hides-on-typing" onclick="mockChannelShareImage()" aria-label="Take a photo (mock)"><i class="fas fa-camera"></i></button>
                                </div>
                                <button id="specificChatActionBtn" class="chat-input-action-button" onclick="mockChannelVoiceInput()" aria-label="Use voice input (mock)">
                                    <i id="specificChatActionIcon" class="fas fa-microphone" aria-hidden="true"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </section>

            <!-- 5. Wellness + Self-Tracking Screen -->
            <section id="wellness" class="screen" aria-labelledby="wellnessTitle">
                <div class="screen-header">
                     <div class="title-group"><h2 id="wellnessTitle" class="title">Wellness Hub</h2></div>
                </div>
                <p class="card-subtitle mb-3">Track your well-being. AI provides insights and personalized suggestions. Haptic feedback (conceptual) for logging.</p>
                <div id="aiWellnessInsight" class="ai-wellness-insight hidden"></div>

                <article class="card" id="aiPatternCard" aria-labelledby="aiPatternCardTitle" style="display: none;">
                    <h3 id="aiPatternCardTitle" class="card-title" style="font-size: clamp(0.95rem, 2.6vw, 1rem);"><i class="fas fa-brain"></i> AI Pattern Detected</h3>
                    <p id="aiPatternText" class="card-subtitle"></p>
                </article>
                

                <article class="card" aria-labelledby="moodLogCardTitle">
                    <h3 class="card-title" id="moodLogCardTitle">How are you feeling today?</h3>
                    <div class="mood-log-container" id="moodSelector" role="radiogroup" aria-labelledby="moodLogCardTitle">
                        <button class="mood-emoji-button" data-mood="😞" onclick="selectMood(this)" aria-label="Sad mood"><span role="img" aria-label="Sad face emoji">😞</span></button>
                        <button class="mood-emoji-button" data-mood="🙁" onclick="selectMood(this)" aria-label="Slightly sad mood"><span role="img" aria-label="Slightly sad face emoji">🙁</span></button>
                        <button class="mood-emoji-button" data-mood="😐" onclick="selectMood(this)" aria-label="Neutral mood"><span role="img" aria-label="Neutral face emoji">😐</span></button>
                        <button class="mood-emoji-button" data-mood="🙂" onclick="selectMood(this)" aria-label="Slightly happy mood"><span role="img" aria-label="Slightly happy face emoji">🙂</span></button>
                        <button class="mood-emoji-button" data-mood="😄" onclick="selectMood(this)" aria-label="Happy mood"><span role="img" aria-label="Happy face emoji">😄</span></button>
                         <button class="mood-emoji-button" data-mood="🤩" onclick="selectMood(this)" aria-label="Excited mood"><span role="img" aria-label="Excited face emoji">🤩</span></button>
                         <button class="mood-emoji-button" data-mood="😌" onclick="selectMood(this)" aria-label="Relaxed mood"><span role="img" aria-label="Relaxed face emoji">😌</span></button>
                    </div>
                    <textarea id="moodNoteInput" class="input-field mood-note-input" rows="2" placeholder="Add a note about your mood (AI can analyze this for patterns, optional)" aria-label="Optional note for mood"></textarea>
                    <button class="button mt-2" style="width:100%;" onclick="logMood()">Log Mood</button>
                </article>

                <article class="card habit-tracker" aria-labelledby="habitTrackerTitle">
                    <h3 id="habitTrackerTitle" class="card-title">Habit Tracker</h3>
                    <div id="habitListContainer" aria-live="polite">
                        <!-- Skeleton loader will be injected here by JS -->
                    </div>
                    <button class="button button-secondary mt-2" style="width:100%;" onclick="openCreateHabitModal()"><i class="fas fa-plus-circle"></i> Add New Habit</button>
                    <button class="button button-secondary mt-2" style="width:100%;" onclick="openHabitStatsModal()"><i class="fas fa-chart-line"></i> View Habit Stats</button>
                </article>
                 <article class="card" aria-labelledby="aiWellnessToolsTitle">
                    <h3 id="aiWellnessToolsTitle" class="card-title">AI Insights & Tools</h3>
                    <p class="card-subtitle" id="journalPromptStaticText">AI Reflection: "What's one small thing that brought you joy today, and how can you invite more of it into your week?"</p>
                    <button class="button button-secondary" style="width:100%;" onclick="openJournalModal()"><i class="fas fa-feather-alt" aria-hidden="true"></i> Journal Response</button>
                    <button class="button button-secondary mt-2" style="width:100%;" onclick="showAIWellnessSummaryModal()"><i class="fas fa-brain"></i> Get AI Wellness Summary</button>
                    <button class="button button-secondary mt-2" style="width:100%;" onclick="openGuidedExerciseModal()"><i class="fas fa-spa"></i> Guided Exercise (Mock)</button>
                    <div id="moodHabitTimelinePlaceholder" class="placeholder-box mt-3" style="min-height:100px; text-align:left; padding:var(--space-md); border-radius:var(--border-radius-md); background-color:var(--placeholder-bg)">
                        <h4 style="font-size:clamp(0.85rem, 2.3vw, 0.9rem); margin-bottom:var(--space-xs); color:var(--text-secondary-color);">Mood & Habit Timeline (Summary)</h4>
                        <div id="timelineContent" style="font-size:clamp(0.75rem, 2vw, 0.8rem); color:var(--text-color);">No entries yet for today.</div>
                        <button id="viewMoodCalendarButton" class="button mt-2" style="font-size:clamp(0.75rem, 2vw, 0.8rem); padding: var(--space-xs) var(--space-sm);" onclick="openFullCalendar('moods')"><i class="fas fa-calendar-alt"></i> View Mood Calendar</button>
                    </div>
                </article>
            </section>

            <!-- 6. Settings Screen -->
            <section id="settings" class="screen" aria-labelledby="settingsTitle">
                <div class="screen-header"><h2 id="settingsTitle" class="title">Settings</h2></div>
                <p class="card-subtitle mb-3">Customize your LocalLife OS. Fine-tune AI behavior and app preferences. Offline capabilities via PWA (conceptual).</p>

                <article class="card settings-list no-press" aria-label="Application Settings">
                     <div class="setting-item" role="button" tabindex="0" onclick="openUserProfileModal()" onkeypress="if(event.key==='Enter') openUserProfileModal()">
                        <span class="setting-label">My Profile & Account</span><i class="fas fa-user-circle" aria-hidden="true"></i>
                    </div>
                    <div class="setting-item">
                        <span class="setting-label">AI Personality</span>
                        <select id="aiPersonalitySelect" class="input-field" style="width:auto; padding: var(--space-xs); margin-bottom:0; font-size: clamp(0.85rem, 2.3vw, 0.9rem);" onchange="changeAIPersonality(this.value)" aria-label="Select AI Assistant Personality">
                            <option value="neutral">Neutral</option>
                            <option value="friendly">Friendly</option>
                            <option value="professional">Professional</option>
                            <option value="witty">Witty (Pro)</option>
                            <option value="helpful">Helpful Bot</option>
                        </select>
                    </div>
                    <div class="setting-item" role="button" tabindex="0" onclick="openAILearningPrefsModal()" onkeypress="if(event.key==='Enter') openAILearningPrefsModal()">
                        <span class="setting-label">AI Learning Preferences</span><i class="fas fa-brain" aria-hidden="true"></i>
                    </div>
                    <div class="setting-item">
                        <span class="setting-label" id="darkModeLabel">Dark Mode</span>
                        <button class="toggle-switch-button" id="darkModeToggleContainer" onclick="toggleDarkMode()" aria-labelledby="darkModeLabel" role="switch" aria-checked="false">
                             <span class="toggle-switch" id="darkModeToggleVisual"></span>
                        </button>
                    </div>
                    <div class="setting-item">
                        <span class="setting-label">Theme Accent</span>
                        <div class="theme-selector" role="radiogroup" aria-label="Select theme accent color">
                            <button class="theme-color-button active" onclick="changeThemeAccent('#4DB6AC', this)" aria-label="Teal theme" role="radio" aria-checked="true"><i class="fas fa-circle theme-color-dot" style="color: #4DB6AC;" aria-hidden="true"></i></button>
                            <button class="theme-color-button" onclick="changeThemeAccent('#64B5F6', this)" aria-label="Blue theme" role="radio" aria-checked="false"><i class="fas fa-circle theme-color-dot" style="color: #64B5F6;" aria-hidden="true"></i></button>
                             <button class="theme-color-button" onclick="changeThemeAccent('#FFB74D', this)" aria-label="Orange theme" role="radio" aria-checked="false"><i class="fas fa-circle theme-color-dot" style="color: #FFB74D;" aria-hidden="true"></i></button>
                            <button class="theme-color-button" onclick="changeThemeAccent('#E07A5F', this)" aria-label="Terracotta theme" role="radio" aria-checked="false"><i class="fas fa-circle theme-color-dot" style="color: #E07A5F;" aria-hidden="true"></i></button>
                            <button class="theme-color-button" onclick="changeThemeAccent('#9CCC65', this)" aria-label="Light Green theme" role="radio" aria-checked="false"><i class="fas fa-circle theme-color-dot" style="color: #9CCC65;" aria-hidden="true"></i></button>
                        </div>
                    </div>
                    <div class="setting-item" role="button" tabindex="0" onclick="openDashboardCustomizationModal()" onkeypress="if(event.key==='Enter') openDashboardCustomizationModal()">
                        <span class="setting-label">Customize Dashboard</span><i class="fas fa-th-large" aria-hidden="true"></i>
                    </div>
                     <div class="setting-item" role="button" tabindex="0" onclick="openNotificationSettingsModal()" onkeypress="if(event.key==='Enter') openNotificationSettingsModal()">
                        <span class="setting-label">Notification Preferences</span><i class="fas fa-bell" aria-hidden="true"></i>
                    </div>
                    <div class="setting-item" role="button" tabindex="0" onclick="openGenericModal('Privacy & Data Controls', '<p>Manage permissions for location, camera, microphone (conceptual for native features).</p><p>AI data usage: Control how AI uses your anonymized data to improve its suggestions (conceptual).</p><button class=\'button mt-2\' onclick=\'exportUserData()\'>Export My Data (JSON)</button><p class=\'mt-2\'>Request account deletion (conceptual).</p>')">
                        <span class="setting-label">Privacy & Data Controls</span><i class="fas fa-user-secret" aria-hidden="true"></i>
                    </div>
                    <div class="setting-item" role="button" tabindex="0" onclick="openGenericModal('Subscription Details', 'Current Tier: Pro ($6.99/mo). Options to upgrade (unlock more AI personalities, advanced analytics, AI-powered itinerary planning), downgrade, or cancel your subscription. View billing history. (Mock UI)')" onkeypress="if(event.key==='Enter') openGenericModal('Subscription Details', '(Mock UI)')">
                        <span class="setting-label">Subscription: <span style="color:var(--primary-accent); font-weight:bold;">Pro Tier</span></span>
                        <span class="setting-value">Manage</span>
                    </div>
                     <div class="setting-item" role="button" tabindex="0" onclick="openHelpAboutModal()" onkeypress="if(event.key==='Enter') openHelpAboutModal()">
                        <span class="setting-label">Help & About</span><i class="fas fa-question-circle" aria-hidden="true"></i>
                    </div>
                     <div class="setting-item" role="button" tabindex="0" onclick="handleLogout()" onkeypress="if(event.key==='Enter') handleLogout()">
                        <span class="setting-label" style="color: var(--danger-color);">Log Out</span>
                        <i class="fas fa-sign-out-alt" style="color: var(--danger-color);" aria-hidden="true"></i>
                    </div>
                     <div class="setting-item" role="button" tabindex="0" onclick="clearAllDataWithConfirmation()" onkeypress="if(event.key==='Enter') clearAllDataWithConfirmation()">
                        <span class="setting-label" style="color: var(--danger-color);">Clear All My Data (Reset App)</span>
                        <i class="fas fa-trash-restore" style="color: var(--danger-color);" aria-hidden="true"></i>
                    </div>
                </article>
                 <article class="card text-center no-press">
                    <p class="card-subtitle">LocalLife OS v1.0.0 (Hyper-Integrated)</p>
                    <p class="card-subtitle">Made with <i class="fas fa-heart" style="color: var(--muted-terracotta);" aria-hidden="true"></i> for local life, supercharged by AI.</p>
                    <p class="card-subtitle" style="font-size:clamp(0.7rem, 1.9vw, 0.75rem);"><em>Conceptual Monetization: Pro Tier for advanced AI features, featured listings for businesses, service marketplace commissions.</em></p>
                </article>
            </section>
            
            <!-- 7. Local Services Screen (New Module Placeholder) -->
            <section id="servicesMarket" class="screen" aria-labelledby="servicesMarketTitle">
                <div class="screen-header"><h2 id="servicesMarketTitle" class="title">Local Services Marketplace</h2></div>
                <p class="card-subtitle mb-3">Find or offer local services. AI can help match providers with seekers (Conceptual).</p>
                 <div class="empty-state">
                    <i class="fas fa-handshake-angle fa-3x"></i>
                    <p>Local Services Marketplace coming soon!</p>
                    <p class="card-subtitle mt-2" style="font-size:clamp(0.8rem, 2.2vw, 0.85rem);"><em>Here you could connect with locals for services like babysitting, tutoring, handyman work, pet sitting, etc. AI-powered matching, reputation system, and secure payments (conceptual, potential commission model). AI could help you draft a service listing or find a provider based on your needs.</em></p>
                     <button class="button mt-2" onclick="showToast('AI: Searching for \'Plumbers near me\' (Conceptual marketplace search).', 'ai_info')"><i class="fas fa-search"></i> AI: Find me a Plumber (Mock)</button>
                </div>
            </section>

            <!-- 8. Local Governance Screen (New Module Placeholder) -->
            <section id="governance" class="screen" aria-labelledby="governanceTitle">
                <div class="screen-header"><h2 id="governanceTitle" class="title">Civic Engagement Hub</h2></div>
                <p class="card-subtitle mb-3">Connect with local governance. AI can summarize meeting notes or proposals (Conceptual).</p>
                <div class="empty-state">
                    <i class="fas fa-landmark-flag fa-3x"></i>
                    <p>Local Governance & Civic Engagement module coming soon!</p>
                    <p class="card-subtitle mt-2" style="font-size:clamp(0.8rem, 2.2vw, 0.85rem);"><em>This hub could provide information on local representatives, upcoming town meetings, voting information, and public forums. AI could summarize public records, highlight key discussion points from meeting transcripts (with moderation), or help citizens draft inquiries to local officials (conceptual).</em></p>
                    <button class="button mt-2" onclick="showToast('AI: Summarizing latest town hall meeting minutes (Conceptual).', 'ai_info')"><i class="fas fa-file-alt"></i> AI: Summarize Last Meeting (Mock)</button>
                </div>
            </section>
            <div id="mockUserSuggestionPopup" class="mock-user-suggestion-popup hidden"></div>
        </main>

        <button class="ai-fab" id="aiFab" onclick="toggleAIChat()" aria-label="Open AI Assistant" aria-expanded="false">
            <i id="aiFabIcon" class="fas fa-brain" aria-hidden="true"></i>
        </button>

        <div class="ai-bottom-sheet" id="aiBottomSheet" role="dialog" aria-modal="true" aria-labelledby="aiAssistantTitle" aria-hidden="true">
            <div class="ai-chat-content">
                <div class="screen-header" style="padding: var(--space-sm) var(--space-md); border-bottom: 1px solid var(--placeholder-bg); flex-shrink: 0;">
                    <div class="title-group">
                         <button class="back-button" onclick="toggleAIChat()" aria-label="Close AI Assistant"><i class="fas fa-arrow-left" aria-hidden="true"></i></button>
                        <h2 id="aiAssistantTitle" class="title">LocalLife AI</h2>
                    </div>
                </div>
                <!-- FIX: Sticky Quick Actions -->
                <div class="ai-quick-actions-wrapper">
                    <div class="ai-quick-actions">
                        <button class="ai-quick-action-button" onclick="aiChatInputText.value = 'Add task '; aiChatInputText.focus();">Add Task</button>
                        <button class="ai-quick-action-button" onclick="aiChatInputText.value = 'Find '; aiChatInputText.focus();">Find...</button>
                        <button class="ai-quick-action-button" onclick="aiChatInputText.value = 'Plan my day'; sendAIChatMessage();">Plan Day</button>
                        <button class="ai-quick-action-button" onclick="aiChatInputText.value = 'Summarize my day'; sendAIChatMessage();">Day Summary</button>
                        <button class="ai-quick-action-button" onclick="aiChatInputText.value = 'Help'; sendAIChatMessage();">Help</button>
                        <button class="ai-quick-action-button" onclick="clearAIChat()">Clear</button>
                    </div>
                </div>
                <div class="ai-chat-area" id="aiChatArea" aria-live="polite"></div>
                <!-- NEW AI CHAT INPUT -->
                 <div class="chat-input-container"> <!-- This one already uses env(safe-area-inset-bottom) through its shared class with specific chat -->
                    <div class="chat-input-wrapper">
                         <button class="chat-icon-button" onclick="showToast('AI Emoji picker would open (conceptual).', 'info')" aria-label="Open emoji picker (mock)"><i class="far fa-smile"></i></button>
                        <textarea id="aiChatInputText" class="input-field chat-input" placeholder="Ask or command..." aria-label="AI assistant chat input" rows="1" oninput="autoGrowTextarea(this); handleChatInputTyping(this, 'ai');"></textarea>
                        <button id="aiChatAttachBtn" class="chat-icon-button hides-on-typing" onclick="mockAIAttachFile()" aria-label="Attach file (mock)"><i class="fas fa-paperclip"></i></button>
                        <button id="aiChatCameraBtn" class="chat-icon-button hides-on-typing" onclick="mockAIAttachFile()" aria-label="Use camera (mock)"><i class="fas fa-camera"></i></button>
                    </div>
                    <button id="aiChatActionBtn" class="chat-input-action-button" onclick="mockAIVoiceInput()" aria-label="Use voice input (mock)">
                        <i id="aiChatActionIcon" class="fas fa-microphone" aria-hidden="true"></i>
                    </button>
                    <div class="ai-chat-typing-suggestion" id="aiChatTypingSuggestion"></div>
                </div>
            </div>
        </div>

        <nav class="bottom-nav" role="navigation" aria-label="Main application navigation">
            <button class="nav-item active" data-screen="dashboard" aria-label="Home screen" aria-selected="true"><i class="fas fa-home" aria-hidden="true"></i><span>Home</span></button>
            <button class="nav-item" data-screen="planner" aria-label="Planner screen" aria-selected="false"><i class="fas fa-calendar-alt" aria-hidden="true"></i><span>Planner</span></button>
            <button class="nav-item" data-screen="explore" aria-label="Explore screen" aria-selected="false"><i class="fas fa-compass" aria-hidden="true"></i><span>Explore</span></button>
            <button class="nav-item" data-screen="chat" aria-label="Community chat screen" aria-selected="false"><i class="fas fa-comments" aria-hidden="true"></i><span>Community</span></button>
            <button class="nav-item" data-screen="wellness" aria-label="Wellness screen" aria-selected="false"><i class="fas fa-heartbeat" aria-hidden="true"></i><span>Wellness</span></button>
            <button class="nav-item" data-screen="settings" aria-label="Settings screen" aria-selected="false"><i class="fas fa-cog" aria-hidden="true"></i><span>Settings</span></button>
        </nav>

        <!-- MODALS -->
        <div id="placeDetailModal" class="modal" role="dialog" aria-modal="true" aria-labelledby="modalPlaceName">
            <div class="modal-content">
                <button class="modal-close-button" onclick="closeModal('placeDetailModal')" aria-label="Close place details">&times;</button>
                <h3 id="modalPlaceName" class="modal-title">Place Name</h3>
                <img id="modalPlaceImage" src="" alt="" style="width:100%; max-height:clamp(120px, 30vh, 150px); object-fit:cover; border-radius:var(--border-radius-md); margin-bottom:var(--space-sm);">
                <div id="modalPlaceDetails" class="modal-body"></div>
                <div id="modalPlaceTags" class="tags mb-2"></div>
                <div id="aiPlaceReviewSummary" class="ai-review-summary hidden"></div>
                <div class="mt-3">
                    <h4 class="card-subtitle" style="font-size:clamp(0.85rem, 2.3vw, 0.9rem); font-weight:500;">Rate this place (Mock):</h4>
                    <div class="rating-stars" id="placeRatingStars" data-place-id="">
                        <i class="fas fa-star" data-value="1" onclick="ratePlace(this)" aria-label="Rate 1 star"></i>
                        <i class="fas fa-star" data-value="2" onclick="ratePlace(this)" aria-label="Rate 2 stars"></i>
                        <i class="fas fa-star" data-value="3" onclick="ratePlace(this)" aria-label="Rate 3 stars"></i>
                        <i class="fas fa-star" data-value="4" onclick="ratePlace(this)" aria-label="Rate 4 stars"></i>
                        <i class="fas fa-star" data-value="5" onclick="ratePlace(this)" aria-label="Rate 5 stars"></i>
                    </div>
                    <label for="placeReviewInput" class="visually-hidden">Write a short review</label>
                    <textarea id="placeReviewInput" class="input-field" rows="2" placeholder="Write a short review (optional, mock)..." aria-label="Place review input"></textarea>
                    <button class="button mt-2 button-secondary" style="width:100%; font-size:clamp(0.85rem, 2.3vw, 0.9rem);" onclick="submitPlaceReview()">Submit Review (Mock)</button>
                </div>
                <button class="button mt-3" style="width:100%" onclick="showToast('Showing directions (mock). AI could suggest scenic routes or avoid traffic (conceptual). Haptic feedback (conceptual).', 'ai_info')"><i class="fas fa-directions" aria-hidden="true"></i> Get Directions</button>
            </div>
        </div>
        
        <div id="dealDetailModal" class="modal" role="dialog" aria-modal="true" aria-labelledby="modalDealTitle">
            <div class="modal-content">
                <button class="modal-close-button" onclick="closeModal('dealDetailModal')" aria-label="Close deal details">&times;</button>
                <h3 id="modalDealTitle" class="modal-title">Deal Title</h3>
                <img id="modalDealImage" src="" alt="" style="width:100%; max-height:clamp(120px, 30vh, 150px); object-fit:cover; border-radius:var(--border-radius-md); margin-bottom:var(--space-sm);">
                <div id="modalDealBody" class="modal-body">
                    <!-- Deal details will be populated here -->
                </div>
                <button class="button mt-3" style="width:100%" onclick="showToast('Redeeming deal (mock). AI could check for conflicting deals or better offers (conceptual). Haptic feedback (conceptual).', 'ai_info')"><i class="fas fa-ticket-alt" aria-hidden="true"></i> Redeem Deal (Mock)</button>
            </div>
        </div>

        <div id="submitDealModal" class="modal" role="dialog" aria-modal="true" aria-labelledby="submitDealModalTitle">
            <div class="modal-content">
                <button class="modal-close-button" onclick="closeModal('submitDealModal')" aria-label="Close submit deal form">&times;</button>
                <h3 class="modal-title" id="submitDealModalTitle">Submit a Deal or Offer</h3>
                <form id="submitDealForm">
                    <div class="input-group">
                        <label for="dealTitleInput">Deal Title*</label>
                        <input type="text" id="dealTitleInput" class="input-field" placeholder="e.g., 2-for-1 Coffee Mornings" required>
                    </div>
                    <div class="input-group">
                        <label for="dealBusinessNameInput">Business Name*</label>
                        <input type="text" id="dealBusinessNameInput" class="input-field" placeholder="e.g., The Cozy Corner Cafe" required>
                    </div>
                    <div class="input-group">
                        <label for="dealDescriptionInput">Description*</label>
                        <textarea id="dealDescriptionInput" class="input-field" rows="3" placeholder="Describe the deal in detail..." required></textarea>
                    </div>
                    <div class="input-group">
                        <label for="dealCategorySelect">Category*</label>
                        <select id="dealCategorySelect" class="input-field" required></select>
                    </div>
                    <div class="input-group">
                        <label for="dealImageUrlInput">Image URL (Optional, Mock)</label>
                        <input type="url" id="dealImageUrlInput" class="input-field" placeholder="https://via.placeholder.com/80x80.png?text=Deal">
                    </div>
                    <div class="input-group">
                        <label for="dealExpiryDateInput">Expiry Date (Optional)</label>
                        <input type="date" id="dealExpiryDateInput" class="input-field">
                    </div>
                    <div class="input-group">
                        <label for="dealTermsInput">Terms & Conditions (Optional)</label>
                        <textarea id="dealTermsInput" class="input-field" rows="2" placeholder="e.g., Valid Mon-Fri, 9 AM - 11 AM."></textarea>
                    </div>
                    <p class="card-subtitle" style="font-size:clamp(0.75rem, 2vw, 0.8rem); margin-bottom:10px;"><em>* Required fields. Submitted deals are mock-reviewed by AI & human moderators.</em></p>
                    <button type="button" class="button mt-2" style="width:100%" onclick="submitNewDeal()">Submit Deal for Review</button>
                </form>
            </div>
        </div>


        <div id="journalModal" class="modal" role="dialog" aria-modal="true" aria-labelledby="journalModalTitle">
            <div class="modal-content">
                <button class="modal-close-button" onclick="closeModal('journalModal')" aria-label="Close journal entry">&times;</button>
                <h3 class="modal-title" id="journalModalTitle">AI Reflection Prompt</h3>
                <p class="card-subtitle" id="journalPromptText"></p>
                <label for="journalInput" class="visually-hidden">Journal Entry</label>
                <textarea id="journalInput" class="input-field mood-note-input" rows="5" placeholder="Your thoughts... AI can offer insights on your entries over time (conceptual)." style="width:100%; margin-top:0;" aria-label="Journal entry input"></textarea>
                <button class="button mt-3" style="width:100%" onclick="saveJournalEntry()">Save Entry</button>
            </div>
        </div>
        
        <div id="createChannelModal" class="modal" role="dialog" aria-modal="true" aria-labelledby="createChannelModalTitle">
            <div class="modal-content">
                <button class="modal-close-button" onclick="closeModal('createChannelModal')" aria-label="Close create channel form">&times;</button>
                <h3 class="modal-title" id="createChannelModalTitle">Create New Channel</h3>
                <label for="newChannelName">Channel Name</label>
                <input type="text" id="newChannelName" class="input-field" placeholder="e.g., Local Gardeners">
                
                <label for="newChannelType">Channel Type</label>
                <select id="newChannelType" class="input-field mb-2" onchange="updateChannelDescPlaceholder(this.value)">
                    <option value="general">General Discussion</option>
                    <option value="skill_swap">Skill Swap (Offer/Request)</option>
                    <option value="hobby">Hobby Group</option>
                    <option value="announcements">Announcements</option>
                    <option value="local_events">Local Events Discussion</option>
                </select>

                <label for="newChannelDesc">Description (Optional, AI can help generate this)</label>
                <textarea id="newChannelDesc" class="input-field" rows="2" placeholder="e.g., Share gardening tips, or discuss local news."></textarea>
                
                <label>Channel Icon (Choose one, AI can suggest based on name/type)</label>
                <div class="icon-selector" id="newChannelIconSelector" role="radiogroup" aria-label="Select channel icon"></div>
                <p class="card-subtitle mt-2" style="font-size:clamp(0.75rem, 2vw, 0.8rem);"><em>Moderation tools for channel creators (conceptual). AI can assist with moderation.</em></p>
                <button class="button mt-3" style="width:100%" onclick="submitNewChannel()">Create Channel</button>
            </div>
        </div>

        <div id="createHabitModal" class="modal" role="dialog" aria-modal="true" aria-labelledby="createHabitModalTitle">
            <div class="modal-content">
                <button class="modal-close-button" onclick="closeModal('createHabitModal')" aria-label="Close create habit form">&times;</button>
                <h3 class="modal-title" id="createHabitModalTitle">Create New Habit</h3>
                <input type="hidden" id="editingHabitId">
                <label for="newHabitName">Habit Name (AI can suggest habits based on your goals)</label>
                <input type="text" id="newHabitName" class="input-field" placeholder="e.g., Morning Meditation">
                <label for="newHabitGoal">Goal (daily count)</label>
                <input type="number" id="newHabitGoal" class="input-field" value="1" min="1">
                <label for="newHabitUnit">Unit (optional)</label>
                <input type="text" id="newHabitUnit" class="input-field" placeholder="e.g., minutes, reps, glasses">
                <label>Habit Icon (Choose one)</label>
                <div class="icon-selector" id="newHabitIconSelector" role="radiogroup" aria-label="Select habit icon"></div>
                 <label>Color</label>
                <div class="icon-selector" id="newHabitColorSelector" role="radiogroup" aria-label="Select habit color"></div>
                <button id="submitHabitButton" class="button mt-3" style="width:100%" onclick="submitNewHabit()">Create Habit</button>
            </div>
        </div>
        
        <div id="editTaskModal" class="modal" role="dialog" aria-modal="true" aria-labelledby="editTaskModalTitle">
            <div class="modal-content">
                <button class="modal-close-button" onclick="closeModal('editTaskModal')" aria-label="Close edit task form">&times;</button>
                <h3 class="modal-title" id="editTaskModalTitle">Edit Task</h3>
                <input type="hidden" id="editingTaskId">
                <label for="editTaskTitleInput">Task Title</label>
                <input type="text" id="editTaskTitleInput" class="input-field">
                <label for="editTaskTimeInput">Time / Context (AI can parse this)</label>
                <input type="text" id="editTaskTimeInput" class="input-field">
                <label for="editTaskCategorySelect">Category (AI can suggest)</label>
                <select id="editTaskCategorySelect" class="input-field">
                    <option value="personal">Personal</option>
                    <option value="work">Work</option>
                    <option value="errands">Errands</option>
                    <option value="learning">Learning</option>
                    <option value="health">Health</option>
                    <option value="general">General</option>
                </select>
                <label for="editTaskDueDateInput">Due Date (mock, AI can help schedule)</label>
                <input type="text" id="editTaskDueDateInput" class="input-field" placeholder="e.g., Tomorrow, 2024-12-25">
                <label for="editTaskRecurrenceSelect">Recurring (mock UI)</label>
                <select id="editTaskRecurrenceSelect" class="input-field">
                    <option value="none">None</option>
                    <option value="daily">Daily</option>
                    <option value="weekly">Weekly</option>
                    <option value="monthly">Monthly</option>
                </select>
                <label for="editTaskNotesInput">Notes / Subtasks (AI can help break down)</label>
                <textarea id="editTaskNotesInput" class="input-field" rows="3" placeholder="Add details or subtasks here..."></textarea>
                <button class="button mt-3" style="width:100%" onclick="saveEditedTask()">Save Changes</button>
            </div>
        </div>

        <!-- FIX: Expanded Submit Tip Modal -->
        <div id="submitTipModal" class="modal" role="dialog" aria-modal="true" aria-labelledby="submitTipModalTitle">
            <div class="modal-content">
                <button class="modal-close-button" onclick="closeModal('submitTipModal')" aria-label="Close submit tip form">&times;</button>
                <h3 class="modal-title" id="submitTipModalTitle">Submit a Community Tip / Place</h3>
                <form id="submitTipForm">
                    <div class="input-group">
                        <label for="tipTitleInput">Place Name / Tip Title*</label>
                        <input type="text" id="tipTitleInput" class="input-field" placeholder="e.g., Willow Creek Park or Road Closure Alert" required>
                    </div>
                    <div class="input-group">
                        <label for="tipDescriptionInput">Main Details*</label>
                        <textarea id="tipDescriptionInput" class="input-field" rows="2" placeholder="e.g., Green Space, Playground, Trails..." required></textarea>
                    </div>
                     <div class="input-group">
                        <label for="tipSubDetailsInput">Sub-details (Optional)</label>
                        <input type="text" id="tipSubDetailsInput" class="input-field" placeholder="e.g., Open 24/7 or Tonight at 8 PM">
                    </div>
                    <div class="input-group">
                        <label for="tipCategorySelect">Category (AI can auto-categorize)</label>
                        <select id="tipCategorySelect" class="input-field">
                            <option value="food">Food</option>
                            <option value="parks">Parks</option>
                            <option value="events">Events</option>
                            <option value="shops">Shops</option>
                            <option value="services">Services</option>
                            <option value="safety">Safety Alert</option>
                            <option value="general">General Info</option>
                        </select>
                    </div>
                    <div class="input-group">
                        <label for="tipTagsInput">Tags (comma-separated, optional)</label>
                        <input type="text" id="tipTagsInput" class="input-field" placeholder="e.g., outdoor, quiet, family, free">
                    </div>
                     <div class="input-group">
                        <label for="tipImageURLInput">Image URL (Optional)</label>
                        <input type="url" id="tipImageURLInput" class="input-field" placeholder="https://via.placeholder.com/60x60.png?text=Place">
                    </div>
                    <button type="button" class="button mt-3" style="width:100%" onclick="submitCommunityTip()">Submit Tip (AI Moderated)</button>
                </form>
            </div>
        </div>
        
        <div id="genericModal" class="modal" role="dialog" aria-modal="true" aria-labelledby="genericModalTitle">
            <div class="modal-content">
                <button class="modal-close-button" onclick="closeModal('genericModal')" aria-label="Close modal">&times;</button>
                <h3 id="genericModalTitle" class="modal-title"></h3>
                <div id="genericModalBody" class="modal-body"></div>
                <button class="button mt-3" style="width:100%" onclick="closeModal('genericModal')">OK</button>
            </div>
        </div>
        
        <!-- ENHANCEMENT: Expanded User Profile Modal -->
        <div id="userProfileModal" class="modal" role="dialog" aria-modal="true" aria-labelledby="userProfileModalTitle">
            <div class="modal-content">
                <button class="modal-close-button" onclick="closeModal('userProfileModal')" aria-label="Close user profile form">&times;</button>
                <h3 class="modal-title" id="userProfileModalTitle">My Profile</h3>
                <div class="text-center mb-3">
                    <img id="userProfileAvatar" src="https://via.placeholder.com/80/4DB6AC/FFFFFF?text=SL" alt="User Avatar" style="width: clamp(70px, 18vw, 80px); height: clamp(70px, 18vw, 80px); border-radius: 50%; object-fit: cover; margin-bottom: var(--space-sm); border: 3px solid var(--primary-accent);">
                    <p class="mt-1"><button class="button button-secondary" style="font-size:clamp(0.75rem, 2vw, 0.8rem); padding: var(--space-xs) var(--space-sm);">Change Avatar (Mock)</button></p>
                </div>
                <div class="input-group">
                    <label for="profileNameInput">Full Name</label>
                    <input type="text" id="profileNameInput" class="input-field" value="Shamase Local">
                </div>
                <div class="input-group">
                    <label for="profileUsernameInput">Username</label>
                    <input type="text" id="profileUsernameInput" class="input-field" value="@shamase_local" disabled>
                </div>
                 <div class="input-group">
                    <label for="profileLocationInput">My Neighborhood</label>
                    <input type="text" id="profileLocationInput" class="input-field" placeholder="e.g., Downtown, Willow Creek">
                </div>
                <div class="input-group">
                    <label for="profileBioInput">Short Bio (AI can help write this!)</label>
                    <textarea id="profileBioInput" class="input-field" rows="2" placeholder="Tell us about yourself..."></textarea>
                </div>
                 <div class="input-group">
                    <label for="profileInterestsInput">Interests (comma-separated)</label>
                    <textarea id="profileInterestsInput" class="input-field" rows="2" placeholder="e.g., hiking, coffee, local music, tech"></textarea>
                </div>
                <button class="button mt-3" style="width:100%" onclick="saveUserProfile()">Save Profile (Mock)</button>
            </div>
        </div>

        <!-- ENHANCEMENT: Expanded Other User Profile Modal -->
        <div id="otherUserProfileModal" class="modal" role="dialog" aria-modal="true" aria-labelledby="otherUserProfileModalTitle">
            <div class="modal-content">
                <button class="modal-close-button" onclick="closeModal('otherUserProfileModal')" aria-label="Close user profile">&times;</button>
                <div class="text-center mb-3">
                    <img id="otherUserAvatar" src="" alt="User Avatar" style="width: clamp(70px, 18vw, 80px); height: clamp(70px, 18vw, 80px); border-radius: 50%; object-fit: cover; margin-bottom: var(--space-sm); border: 3px solid var(--primary-accent);">
                    <h3 id="otherUserProfileModalTitle" class="modal-title" style="margin-bottom: var(--space-xs);">User Name</h3>
                    <p id="otherUserUsername" class="card-subtitle" style="margin-top:-5px;"></p>
                    <p id="otherUserBio" class="card-subtitle"></p>
                </div>
                <div id="otherUserInteractions" class="modal-body">
                    <h4 class="card-subtitle" style="font-size:clamp(0.85rem, 2.3vw, 0.9rem); font-weight:500;">Interests</h4>
                    <p id="otherUserInterests" class="mb-2">...</p>
                    <h4 class="card-subtitle" style="font-size:clamp(0.85rem, 2.3vw, 0.9rem); font-weight:500;">Mutual Channels (Mock)</h4>
                    <p id="otherUserMutualChannels" class="mb-2">...</p>
                    <button id="otherUserMessageButton" class="button button-secondary mt-2" style="width:100%; font-size:clamp(0.85rem, 2.3vw, 0.9rem);"><i class="fas fa-paper-plane"></i> Message User</button>
                </div>
            </div>
        </div>

        <div id="channelDetailModal" class="modal" role="dialog" aria-modal="true" aria-labelledby="channelDetailModalTitle">
            <div class="modal-content">
                <button class="modal-close-button" onclick="closeModal('channelDetailModal')" aria-label="Close channel details">&times;</button>
                <div class="text-center mb-2">
                    <div id="channelDetailIcon" class="channel-icon" style="width:clamp(44px, 12vw, 50px); height:clamp(44px, 12vw, 50px); font-size:clamp(1.6rem, 4.8vw, 1.8rem); margin:0 auto var(--space-sm) auto;"></div>
                    <h3 id="channelDetailModalTitle" class="modal-title" style="margin-bottom:var(--space-xs);">Channel Name</h3>
                </div>
                <p class="card-subtitle"><strong>Type:</strong> <span id="channelDetailType"></span></p>
                <p class="card-subtitle"><strong>Description:</strong> <span id="channelDetailDescription"></span></p>
                <p class="card-subtitle"><strong>Members:</strong> <span id="channelDetailMemberCount"></span> (mock)</p>
                <div id="channelDetailAIActions" class="ai-suggestion-bg p-2 mt-2" style="border-radius:var(--border-radius-sm); font-size:clamp(0.8rem, 2.2vw, 0.85rem); border: 1px solid color-mix(in srgb, var(--primary-accent) 20%, transparent);">
                    <p><i class="fas fa-brain" style="color:var(--primary-accent)"></i> <strong>AI Actions (Conceptual):</strong></p>
                    <button class="button button-secondary" style="font-size:clamp(0.75rem, 2vw, 0.8rem); padding: var(--space-xs) var(--space-sm); margin-top:var(--space-xs);" onclick="showToast('AI Summarizing channel highlights (mock)...', 'ai_info')">Summarize Highlights</button>
                    <button class="button button-secondary" style="font-size:clamp(0.75rem, 2vw, 0.8rem); padding: var(--space-xs) var(--space-sm); margin-top:var(--space-xs); margin-left:var(--space-xs);" onclick="showToast('AI generating suggested reply based on last message (mock)...', 'ai_info')">Suggest Reply</button>
                </div>
                <div class="mt-3" style="display:flex; gap:var(--space-sm);">
                    <button id="channelDetailJoinButton" class="button" style="flex-grow:1;" onclick=""></button>
                    <button id="channelDetailFavoriteButton" class="button button-secondary" style="flex-grow:1;" onclick=""></button>
                </div>
            </div>
        </div>

        <!-- NEW: Full Page Calendar Modal -->
        <div id="fullCalendarModal" class="modal" role="dialog" aria-modal="true" aria-labelledby="fullCalendarModalTitle">
            <div class="modal-content">
                <button class="modal-close-button" onclick="closeModal('fullCalendarModal')" aria-label="Close calendar">&times;</button>
                <div class="calendar-container">
                    <div class="calendar-header">
                        <button class="button" onclick="navigateCalendar(-1)" aria-label="Previous month"><i class="fas fa-chevron-left"></i></button>
                        <h3 id="fullCalendarModalTitle" class="modal-title" style="margin-bottom:0;">Month Year</h3>
                        <button class="button" onclick="navigateCalendar(1)" aria-label="Next month"><i class="fas fa-chevron-right"></i></button>
                    </div>
                    <div class="calendar-grid day-headers" style="grid-auto-rows: min-content;">
                        <div class="calendar-day-header">Sun</div>
                        <div class="calendar-day-header">Mon</div>
                        <div class="calendar-day-header">Tue</div>
                        <div class="calendar-day-header">Wed</div>
                        <div class="calendar-day-header">Thu</div>
                        <div class="calendar-day-header">Fri</div>
                        <div class="calendar-day-header">Sat</div>
                    </div>
                    <div id="calendarGridBody" class="calendar-grid"></div>
                    <div id="calendarDayDetailPanel" class="day-detail-panel hidden"></div>
                </div>
                 <!-- NEW: Close button for calendar -->
                <button class="button mt-3" style="width:100%; flex-shrink: 0;" onclick="closeModal('fullCalendarModal')">Close Calendar</button>
            </div>
        </div>

        <!-- NEW: Habit Statistics Modal -->
        <div id="habitStatsModal" class="modal" role="dialog" aria-modal="true" aria-labelledby="habitStatsModalTitle">
            <div class="modal-content">
                <button class="modal-close-button" onclick="closeModal('habitStatsModal')" aria-label="Close habit statistics">&times;</button>
                <h3 id="habitStatsModalTitle" class="modal-title">Habit Statistics</h3>
                <div id="habitStatsBody" class="modal-body">
                    <!-- Stats will be rendered here by JS -->
                </div>
                <div id="habitStatsAIInsight" class="ai-wellness-insight mt-3">
                    <!-- AI Insight will be rendered here -->
                </div>
                <button class="button mt-3" style="width:100%" onclick="closeModal('habitStatsModal')">Close</button>
            </div>
        </div>


        <div id="dashboardCustomizationModal" class="modal" role="dialog" aria-modal="true" aria-labelledby="dashboardCustomizationModalTitle">
            <div class="modal-content">
                <button class="modal-close-button" onclick="closeModal('dashboardCustomizationModal')" aria-label="Close dashboard customization form">&times;</button>
                <h3 class="modal-title" id="dashboardCustomizationModalTitle">Customize Dashboard</h3>
                <p class="card-subtitle mb-2">Toggle visibility of dashboard cards. AI can suggest an optimal layout! (Conceptual) Reordering coming soon!</p>
                <div id="dashboardCardToggleContainer" class="settings-list" style="padding:0;">
                    <!-- Toggles will be populated by JS -->
                </div>
                <button class="button mt-3" style="width:100%" onclick="saveDashboardCustomization()">Save Changes</button>
            </div>
        </div>
        
        <div id="notificationSettingsModal" class="modal" role="dialog" aria-modal="true" aria-labelledby="notificationSettingsModalTitle">
            <div class="modal-content">
                <button class="modal-close-button" onclick="closeModal('notificationSettingsModal')" aria-label="Close notification settings">&times;</button>
                <h3 class="modal-title" id="notificationSettingsModalTitle">Notification Preferences (Mock)</h3>
                <p class="card-subtitle mb-2">Control what you get notified about. AI can manage "Smart Alerts" to reduce noise. Push notifications (conceptual).</p>
                <div class="settings-list" style="padding:0;">
                    <div class="setting-item">
                        <span class="setting-label">Daily AI Briefing (7 AM)</span>
                        <button class="toggle-switch-button" onclick="this.firstChild.classList.toggle('active')"><span class="toggle-switch active"></span></button>
                    </div>
                     <div class="setting-item">
                        <span class="setting-label">AI Smart Alerts (Fewer, more relevant)</span>
                         <button class="toggle-switch-button" onclick="this.firstChild.classList.toggle('active')"><span class="toggle-switch active"></span></button>
                    </div>
                    <div class="setting-item">
                        <span class="setting-label">New Chat Messages (All)</span>
                         <button class="toggle-switch-button" onclick="this.firstChild.classList.toggle('active')"><span class="toggle-switch"></span></button>
                    </div>
                    <div class="setting-item">
                        <span class="setting-label">Chat Mentions</span>
                        <button class="toggle-switch-button" onclick="this.firstChild.classList.toggle('active')"><span class="toggle-switch active"></span></button>
                    </div>
                     <div class="setting-item">
                        <span class="setting-label">AI Proactive Suggestions</span>
                        <button class="toggle-switch-button" onclick="this.firstChild.classList.toggle('active')"><span class="toggle-switch"></span></button>
                    </div>
                    <div class="setting-item">
                        <span class="setting-label">Local Deals Alerts</span>
                        <button class="toggle-switch-button" onclick="this.firstChild.classList.toggle('active'); showToast('Local Deals Alerts ' + (this.firstChild.classList.contains('active') ? 'enabled (AI will personalize)' : 'disabled') + ' (mock).', 'info')" ><span class="toggle-switch"></span></button>
                    </div>
                </div>
                <button class="button mt-3" style="width:100%" onclick="closeModal('notificationSettingsModal')">Save Preferences (Mock)</button>
            </div>
        </div>

        <div id="helpAboutModal" class="modal" role="dialog" aria-modal="true" aria-labelledby="helpAboutModalTitle">
            <div class="modal-content">
                <button class="modal-close-button" onclick="closeModal('helpAboutModal')" aria-label="Close help and about">&times;</button>
                <h3 class="modal-title" id="helpAboutModalTitle">Help & About</h3>
                <p><strong>LocalLife OS v1.0.0 (Hyper-Integrated)</strong></p>
                <p>This is a conceptual prototype demonstrating various features of a hyperlocal operating system with advanced AI integration.</p>
                <h4 class="mt-2">Key AI Features (Conceptual/Mocked):</h4>
                <ul>
                    <li>AI-Powered Planning, Task Parsing & Optimization</li>
                    <li>Smarter Proactive Suggestions & Contextual Insights</li>
                    <li>AI-Curated Content (Deals, Explore Picks)</li>
                    <li>AI Itinerary Building & Review Summaries</li>
                    <li>AI Assistance in Chat (Summaries, Smart Replies, User/Channel Matching, @Mentions)</li>
                    <li>Personalized Wellness Insights & Habit Suggestions</li>
                    <li>Customizable AI Personality & Learning Preferences</li>
                    <li>Conceptual AI Moderation & Matching in Community/Services</li>
                    <li>AI Pattern Detection for habits and moods</li>
                    <li>Contextual AI Commands and Multi-turn Conversations</li>
                </ul>
                <h4 class="mt-2">FAQ (Conceptual)</h4>
                <p><strong>Q: How does the AI learn?</strong><br>A: (Mock) The AI learns from your interactions, preferences, and anonymized local data to provide personalized assistance. You can control learning preferences in Settings.</p>
                <p><strong>Q: Is my data private?</strong><br>A: (Mock) We prioritize user privacy. You can manage data permissions, AI learning toggles, and export your data in Settings.</p>
                <p class="mt-2 text-center card-subtitle" style="font-size:clamp(0.75rem, 2vw, 0.8rem);"><em>Haptic feedback on interactions (conceptual for native app).</em></p>
                <button class="button mt-3" style="width:100%" onclick="closeModal('helpAboutModal')">Close</button>
            </div>
        </div>

        <div id="guidedExerciseModal" class="modal" role="dialog" aria-modal="true" aria-labelledby="guidedExerciseModalTitle">
            <div class="modal-content">
                <button class="modal-close-button" onclick="closeModal('guidedExerciseModal')" aria-label="Close guided exercise">&times;</button>
                <h3 class="modal-title" id="guidedExerciseModalTitle">Guided Mindfulness Exercise (Mock)</h3>
                <div class="text-center mb-3">
                    <i class="fas fa-spa fa-3x" style="color:var(--primary-accent);"></i>
                </div>
                <p>Take a few deep breaths. Inhale slowly through your nose, feeling your abdomen expand. Hold for a moment. Exhale slowly through your mouth, releasing any tension.</p>
                <p class="mt-2"><strong>AI Suggestion:</strong> <span id="aiGuidedExerciseSuggestion">"Based on your logged mood, a 5-minute breathing exercise might be beneficial."</span> (Conceptual)</p>
                <p class="mt-2 card-subtitle" style="font-size:clamp(0.75rem, 2vw, 0.8rem);"><em>This is a mock exercise. A real app could offer various AI-adaptive audio/visual guided sessions.</em></p>
                <button class="button mt-3" style="width:100%" onclick="closeModal('guidedExerciseModal')">Done</button>
            </div>
        </div>


        <div id="aiWellnessSummaryModal" class="modal" role="dialog" aria-modal="true" aria-labelledby="aiWellnessSummaryTitle">
            <div class="modal-content">
                <button class="modal-close-button" onclick="closeModal('aiWellnessSummaryModal')" aria-label="Close AI Wellness Summary">&times;</button>
                <h3 class="modal-title" id="aiWellnessSummaryTitle">AI Wellness Summary</h3>
                <div id="aiWellnessSummaryBody" class="modal-body">
                    <p>Based on your recent activity:</p>
                    <ul>
                        <li>Your mood has generally been positive this week! 😊</li>
                        <li>You're consistent with your 'Read for 30 minutes' habit. Great job!</li>
                        <li>AI Pattern Detected: You tend to complete more tasks on days you log your 'Morning Jog' habit. Keep it up! (Conceptual)</li>
                        <li>Consider scheduling a short walk if you feel your energy dip in the afternoons.</li>
                        <li>Remember to log your water intake to see progress.</li>
                    </ul>
                    <p class="mt-2"><em>This is a mock summary. A real AI would provide more personalized insights and track trends over time.</em></p>
                </div>
                <button class="button mt-3" style="width:100%" onclick="closeModal('aiWellnessSummaryModal')">Okay, Got It!</button>
            </div>
        </div>

        <div id="aiLearningPrefsModal" class="modal" role="dialog" aria-modal="true" aria-labelledby="aiLearningPrefsModalTitle">
            <div class="modal-content">
                <button class="modal-close-button" onclick="closeModal('aiLearningPrefsModal')" aria-label="Close AI Learning Preferences">&times;</button>
                <h3 class="modal-title" id="aiLearningPrefsModalTitle">AI Learning Preferences</h3>
                <p class="card-subtitle mb-2">Control how LocalLife AI learns to personalize your experience.</p>
                <div class="settings-list" style="padding:0;">
                    <div class="setting-item">
                        <span class="setting-label">Learn from saved places & deals</span>
                        <button class="toggle-switch-button" data-pref="learnSavedPlaces" onclick="toggleAILearningPref(this)"><span class="toggle-switch active"></span></button>
                    </div>
                    <div class="setting-item">
                        <span class="setting-label">Consider mood logs for suggestions</span>
                         <button class="toggle-switch-button" data-pref="learnMoodLogs" onclick="toggleAILearningPref(this)"><span class="toggle-switch active"></span></button>
                    </div>
                    <div class="setting-item">
                        <span class="setting-label">Analyze task patterns for planner tips</span>
                        <button class="toggle-switch-button" data-pref="learnTaskPatterns" onclick="toggleAILearningPref(this)"><span class="toggle-switch active"></span></button>
                    </div>
                     <div class="setting-item">
                        <span class="setting-label">Use habit tracking for wellness insights</span>
                        <button class="toggle-switch-button" data-pref="learnHabitTracking" onclick="toggleAILearningPref(this)"><span class="toggle-switch active"></span></button>
                    </div>
                    <div class="setting-item">
                        <span class="setting-label">Personalize chat suggestions based on my style</span>
                        <button class="toggle-switch-button" data-pref="learnChatStyle" onclick="toggleAILearningPref(this);"><span class="toggle-switch"></span></button>
                    </div>
                </div>
                <p class="card-subtitle mt-3" style="font-size:clamp(0.75rem, 2vw, 0.8rem);"><em>These settings allow fine-grained control over AI personalization.</em></p>
                <button class="button mt-3" style="width:100%" onclick="closeModal('aiLearningPrefsModal'); showToast('AI Learning preferences saved.', 'success');">Save Preferences</button>
            </div>
        </div>

        <div id="confirmationModal" class="modal" role="dialog" aria-modal="true" aria-labelledby="confirmationModalTitle">
            <div class="modal-content">
                 <h3 id="confirmationModalTitle" class="modal-title">Confirm Action</h3>
                <p id="confirmationModalMessage" class="modal-body"></p>
                <div style="display:flex; gap:var(--space-sm); margin-top:var(--space-md);">
                    <button id="confirmActionButton" class="button danger" style="flex-grow:1;">Confirm</button>
                    <button class="button button-secondary" style="flex-grow:1;" onclick="closeModal('confirmationModal')">Cancel</button>
                </div>
            </div>
        </div>
        
        <div id="notificationsModal" class="modal" role="dialog" aria-modal="true" aria-labelledby="notificationsModalTitle">
            <div class="modal-content">
                <button class="modal-close-button" onclick="closeModal('notificationsModal')" aria-label="Close notifications">&times;</button>
                <h3 id="notificationsModalTitle" class="modal-title">Notifications</h3>
                 <div class="setting-item" style="padding:var(--space-xs) 0 var(--space-sm) 0; border-bottom: 1px solid var(--placeholder-bg);">
                    <span class="setting-label" style="font-size:clamp(0.85rem, 2.3vw, 0.9rem);">AI Smart Filter (Conceptual)</span>
                    <button class="toggle-switch-button" onclick="this.firstChild.classList.toggle('active'); showToast('AI Smart Filter ' + (this.firstChild.classList.contains('active') ? 'On' : 'Off') + ' (Mock)', 'ai_info');"><span class="toggle-switch active"></span></button>
                </div>
                <ul id="notificationListContainer" class="notification-list" style="margin-top:var(--space-sm);">
                    <!-- Notifications will be rendered here -->
                </ul>
                <div class="notification-actions" style="display:flex; gap: var(--space-sm); margin-top: var(--space-md);">
                    <button class="button button-secondary" style="font-size:clamp(0.75rem, 2vw, 0.8rem); padding:var(--space-xs) var(--space-sm); flex:1;" onclick="markAllNotificationsRead()">Mark All Read</button>
                    <button class="button button-secondary danger" style="font-size:clamp(0.75rem, 2vw, 0.8rem); padding:var(--space-xs) var(--space-sm); flex:1;" onclick="clearAllNotifications()">Clear All</button>
                </div>
            </div>
        </div>

        <div id="aiLayersModal" class="modal" role="dialog" aria-modal="true" aria-labelledby="aiLayersModalTitle">
             <div class="modal-content">
                <button class="modal-close-button" onclick="closeModal('aiLayersModal')" aria-label="Close AI Layers selection">&times;</button>
                <h3 class="modal-title" id="aiLayersModalTitle">AI Map Overlays (Conceptual)</h3>
                <p class="card-subtitle mb-2">View the map through different AI-curated lenses.</p>
                <div class="settings-list" style="padding:0;">
                    <div class="setting-item" role="button" tabindex="0" onclick="applyAILayer('quiet')">
                        <span class="setting-label"><i class="fas fa-moon" style="margin-right:var(--space-sm); color: var(--soft-blue);"></i>Quiet Zone</span><i class="fas fa-chevron-right"></i>
                    </div>
                    <div class="setting-item" role="button" tabindex="0" onclick="applyAILayer('vibrant')">
                        <span class="setting-label"><i class="fas fa-bolt" style="margin-right:var(--space-sm); color: var(--favorite-color);"></i>Vibrant Zone</span><i class="fas fa-chevron-right"></i>
                    </div>
                    <div class="setting-item" role="button" tabindex="0" onclick="applyAILayer('family')">
                        <span class="setting-label"><i class="fas fa-child" style="margin-right:var(--space-sm); color: var(--moss-green);"></i>Family Fun</span><i class="fas fa-chevron-right"></i>
                    </div>
                    <div class="setting-item" role="button" tabindex="0" onclick="applyAILayer('heatmap')">
                        <span class="setting-label"><i class="fas fa-fire" style="margin-right:var(--space-sm); color: var(--muted-terracotta);"></i>Popularity Heatmap</span><i class="fas fa-chevron-right"></i>
                    </div>
                     <div class="setting-item" role="button" tabindex="0" onclick="applyAILayer('reset')">
                        <span class="setting-label">Reset to Default</span>
                    </div>
                </div>
             </div>
        </div>

        <div id="toastNotification" class="toast-notification" role="status" aria-live="assertive"></div>
    </div>

<script>
    // --- Global State & Elements ---
    const authContainer = document.getElementById('authContainer'); // NEW
    const appContainer = document.querySelector('.app-container');
    const screens = document.querySelectorAll('.screen');
    const navItems = document.querySelectorAll('.nav-item');
    const aiFab = document.getElementById('aiFab');
    const aiFabIcon = document.getElementById('aiFabIcon');
    const aiBottomSheet = document.getElementById('aiBottomSheet');
    const aiChatArea = document.getElementById('aiChatArea');
    const aiChatInputText = document.getElementById('aiChatInputText');
    const aiChatTypingSuggestionEl = document.getElementById('aiChatTypingSuggestion');
    const toastNotification = document.getElementById('toastNotification');
    let currentOpenModalId = null;
    let toastTimeout;
    let currentAiPersonality = 'neutral'; 
    let aiConversationContext = null; // For multi-turn AI chat
    let aiExpectedResponseType = null; // For multi-turn AI chat

    let exploreSearchDebounceTimeout;
    let fabSuggestionTimeout;
    let mockUserSuggestionPopupTimeout;
    let userName = 'Shamase'; // Default, will be loaded

    // Full Calendar State
    let calendarCurrentDate = new Date();
    let currentCalendarType = 'tasks';


    // --- Initial Data (Mock) ---
    let tasks = [
        { id: 1, title: "Finalize Q3 Report for the upcoming board meeting this Friday", time: "9:00 AM - 10:30 AM", category: "work", completed: false, notes: "Include sales figures and projections.", dueDate: "2024-07-26", recurrence: "none", aiParsedDetails: { project: "Q3 Report", deadline: "Friday"} },
        { id: 2, title: "Morning Jog around Willow Creek Park path", time: "7:00 AM - 7:30 AM", category: "health", completed: true, notes: "Aim for 3km.", dueDate: new Date().toISOString().split('T')[0], recurrence: "daily", aiParsedDetails: {location: "Willow Creek Park"} },
        { id: 3, title: "Pick up dry cleaning from Main Street Cleaners", time: "Geo: Near \"Cleaners Inc.\"", category: "errands", completed: false, notes: "Ticket #12345", dueDate: new Date().toISOString().split('T')[0], recurrence: "none", aiParsedDetails: {item: "dry cleaning", location: "Main Street Cleaners"}},
        { id: 4, title: "Read 'Atomic Habits' Chapter 5 & Take Notes", time: "Evening", category: "learning", completed: false, notes: "Focus on habit stacking.", dueDate: new Date(Date.now() + 86400000).toISOString().split('T')[0], recurrence: "none", aiParsedDetails: {book: "Atomic Habits"}},
        { id: 5, title: "Call Sarah about weekend plans", time: "After 5 PM", category: "personal", completed: false, notes: "Discuss movie options.", dueDate: new Date().toISOString().split('T')[0], recurrence: "none", aiParsedDetails: {person: "Sarah", topic: "weekend plans"}}
    ];
    let nextTaskId = 6;

    const mockPlaces = { // Added tags for better AI filtering
        all: [
            { id: 1, name: "The Cozy Corner Cafe & Bistro", details: "Coffee, Pastries, Light Lunches - <span class='rating'><i class='fas fa-star'></i> 4.5</span> (120 reviews)", sub: "Open until 6 PM", type: "food", img: "https://via.placeholder.com/60x60.png?text=Cafe", saved:false, openNow: true, rating: 4.5, aiSummary: "Visitors love the ambiance and great coffee, but mention it can get busy during peak hours.", tags: ["cafe", "coffee", "lunch", "wifi", "cozy", "popular", "quiet"] },
            { id: 2, name: "Willow Creek Park & Nature Reserve", details: "Green Space, Playground, Trails for walking and biking, dog friendly area.", sub: "Open 24/7", type: "parks", img: "https://via.placeholder.com/60x60.png?text=Park", saved:true, openNow: true, rating: 4.2, aiSummary: "A spacious park, perfect for walks and family outings. Trails are well-maintained.", tags: ["park", "nature", "playground", "kids-friendly", "dog-friendly", "trails", "outdoor", "quiet", "family"] },
            { id: 3, name: "Outdoor Movie Night: Classic Cinema Screening Under The Stars", details: "Community Event - <span class='rating'><i class='fas fa-thumbs-up'></i> Popular</span>", sub: "Tonight, 8 PM @ Central Square", type: "events", img: "https://via.placeholder.com/60x60.png?text=Event", saved:false, openNow: false, rating: 4.0, aiSummary: "A popular community event, great for a unique evening experience. Bring a blanket!", tags: ["event", "community", "movie", "outdoor", "free", "vibrant", "family"] }, 
            { id: 4, name: "Tech Hub Co-working & Innovation Center", details: "Shared Office Space, High-Speed Internet, Meeting Rooms", sub: "Closes at 9 PM", type: "shops", img: "https://via.placeholder.com/60x60.png?text=Work", saved:false, openNow: true, rating: 4.1, aiSummary: "Modern co-working space with reliable internet and good amenities for professionals.", tags: ["work", "coworking", "wifi", "services", "business", "quiet"] },
            { id: 5, name: "Artisan Bakery & Brews", details: "Freshly Baked Bread, Craft Coffee, Local Teas & Pastries - <span class='rating'><i class='fas fa-star'></i> 4.8</span> (85 reviews)", sub: "New! Open 7 AM - 4 PM", type: "food", img: "https://via.placeholder.com/60x60.png?text=Bakery", saved:false, openNow: true, rating: 4.8, aiSummary: "Highly rated for its delicious baked goods and quality coffee. A must-try new spot.", tags: ["bakery", "coffee", "pastries", "new", "fresh", "local"] },
            { id: 6, name: "City Library - Downtown Branch", details: "Books, Quiet Study Area, Computers, Children's Section", sub: "Closes 8 PM", type: "services", img: "https://via.placeholder.com/60x60.png?text=Library", saved: true, openNow: false, rating: 4.3, aiSummary: "Offers a wide range of resources and a quiet environment for study or reading.", tags: ["library", "books", "study", "kids-friendly", "services", "quiet"] }, 
            { id: 7, name: "Greenwood Farmers Market & Local Crafts Fair", details: "Fresh Local Produce, Handmade Crafts, Food Stalls - <span class='rating'><i class='fas fa-leaf'></i> Local Fav</span>", sub: "Sat 9 AM - 1 PM", type: "events", img: "https://via.placeholder.com/60x60.png?text=Market", saved: false, openNow: false, rating: 4.7, aiSummary: "A vibrant market with fresh produce and unique local crafts. Best to go early.", tags: ["market", "local", "crafts", "food", "event", "weekend", "fresh-produce", "vibrant"]},
            { id: 8, name: "KidZone Indoor Playground", details: "Fun and safe play area for children aged 1-10. Ball pits, slides, climbing structures.", sub: "Open 10 AM - 7 PM", type: "services", img: "https://via.placeholder.com/60x60.png?text=Kids", saved:false, openNow: true, rating: 4.4, aiSummary: "Great place for kids to burn off energy, especially on rainy days. Can get crowded.", tags: ["kids-friendly", "playground", "indoor", "family", "fun", "vibrant"] },
            { id: 9, name: "The Book Nook & Literary Cafe", details: "Used & New Books, Cozy Reading Nooks, Coffee & Tea - <span class='rating'><i class='fas fa-star'></i> 4.6</span> (92 reviews)", sub: "Open until 7 PM", type: "shops", img: "https://via.placeholder.com/60x60.png?text=Books", saved:false, openNow: true, rating: 4.6, aiSummary: "A charming bookstore with a great selection and a peaceful cafe area. Perfect for book lovers.", tags: ["bookstore", "cafe", "reading", "quiet", "local"] },
            { id: 10, name: "Riverside Bike Rentals & Tours", details: "Rent bikes by the hour or day. Guided city tours available.", sub: "Open 9 AM - 5 PM", type: "services", img: "https://via.placeholder.com/60x60.png?text=Bike", saved:false, openNow: true, rating: 4.3, aiSummary: "Good quality bikes and friendly staff. Tours are informative. AI suggests booking tours in advance.", tags: ["bike-rental", "tours", "outdoor", "active", "riverside", "vibrant"] }
        ],
        events: [], food: [], shops: [], parks: [], services: [], open_now: [], ai_recommended: []
    };
    mockPlaces.all.forEach(place => {
        if (!mockPlaces[place.type]) mockPlaces[place.type] = [];
        mockPlaces[place.type].push(place);
        if (place.openNow) mockPlaces.open_now.push(place);
        if (place.rating >= 4.5 && place.type !== 'events') mockPlaces.ai_recommended.push(place); // AI picks not just high rating but varied types
    });

    let mockUsers = {
        'user': { id: 'user', name: 'Shamase Local', username: '@shamase_local', avatarUrl: 'https://via.placeholder.com/40/4DB6AC/FFFFFF?text=SL', bio: 'Loves exploring the city and trying new cafes!', location: 'Downtown', interests: 'hiking, coffee, local music, tech' },
        'benS': { id: 'benS', name: 'Ben S.', username: '@bennyS', avatarUrl: 'https://via.placeholder.com/40/FFB74D/000000?text=BS', bio: 'Into hiking and local music scenes.', location: 'Willow Creek', interests: 'outdoors, guitar, photography' },
        'sarahG': { id: 'sarahG', name: 'Sarah G.', username: '@sarahG', avatarUrl: 'https://via.placeholder.com/40/E07A5F/FFFFFF?text=SG', bio: 'Bookworm and foodie, new to the area.', location: 'Uptown', interests: 'reading, cooking, gardening, tacos' },
        'mikeT': { id: 'mikeT', name: 'Mike T.', username: '@mikeT', avatarUrl: 'https://via.placeholder.com/40/64B5F6/FFFFFF?text=MT', bio: 'Tech enthusiast and community volunteer.', location: 'Downtown', interests: 'volunteering, gadgets, community events'},
        'defaultBot': { id: 'defaultBot', name: 'LocalLife AI', username: '@ai_assistant', avatarUrl: 'https://via.placeholder.com/40/9CCC65/FFFFFF?text=AI', bio: 'Your friendly neighborhood AI assistant.', location: 'The Cloud', interests: 'efficiency, data, helping people'}
    };
    
    let mockChannels = [
        { id: 1, name: 'Downtown Announcements', icon: 'fas fa-bullhorn', color: 'var(--moss-green)', type: 'announcements', description: "Official news and updates for downtown residents.", lastMessage: "Mayor: Street fair this weekend!", lastMessageTimestamp: new Date(Date.now() - 3600000 * 1), unreadCount: 1, isJoined: true, isFavorite: false, messages: [{ mid: 101, senderId: 'defaultBot', text: 'Mayor: Street fair this weekend! Don\'t miss the local crafts.', timestamp: new Date(Date.now() - 3600000 * 2), reactions:{'👍': {count:1, users:['benS']}} }, { mid: 102, senderId: 'user', text: 'Sounds great! What time does it start?', timestamp: new Date(Date.now() - 3600000 * 1.5), reactions:{} }, { mid: 103, senderId: 'defaultBot', text: 'Starts at 10 AM on Saturday.', timestamp: new Date(Date.now() - 3600000 * 1), reactions:{'👍':{count:1, users:['user']}} }] },
        { id: 2, name: 'Dog Owners Park Group', icon: 'fas fa-dog', color: 'var(--soft-blue)', type: 'hobby', description: "Connect with fellow dog owners for playdates and park info.", lastMessage: "Sarah: Anyone free for a walk at 5?", lastMessageTimestamp: new Date(Date.now() - 1800000), unreadCount: 3, isJoined: true, isFavorite: true, messages: [{ mid: 201, senderId: 'sarahG', text: "Anyone free for a walk at 5?", timestamp: new Date(Date.now() - 1800000), reactions:{} }, { mid: 202, senderId: 'benS', text: "Can't make 5, but how about 6:30?", timestamp: new Date(Date.now() - 1700000), reactions:{'👍': {count:1, users:['sarahG']}} }, { mid: 203, senderId: 'mikeT', text: "Just a reminder, the park fountain is off for maintenance this week.", timestamp: new Date(Date.now() - 1600000), reactions:{} }, { mid: 204, senderId: 'user', text: "Thanks for the heads-up, @Mike T!", timestamp: new Date(Date.now() - 1500000), reactions:{'👍': {count:1, users:['mikeT']}} }] },
        { id: 3, name: 'Local Foodies & Reviews', icon: 'fas fa-utensils', color: 'var(--muted-terracotta)', type: 'general', description: "Discover new restaurants, share recipes, and talk all things food!", lastMessage: "Mike: Tried the new taco place? Amazing!", lastMessageTimestamp: new Date(Date.now() - 7200000), unreadCount: 8, isJoined: true, isFavorite: false, messages: [{ mid: 301, senderId: 'mikeT', text: "Tried the new taco place? Amazing!", timestamp: new Date(Date.now() - 7200000), reactions:{'🌮':{count:2, users:['user', 'sarahG']}, '❤️':{count:1, users:['benS']}} }, { mid: 302, senderId: 'sarahG', text: 'Where is it? I need good tacos in my life.', timestamp: new Date(Date.now() - 7100000), reactions: {} }, { mid: 303, senderId: 'mikeT', text: 'On Elm Street, next to the old cinema!', timestamp: new Date(Date.now() - 7000000), reactions: {} }, { mid: 304, senderId: 'user', text: 'Oh, "El Fuego"? I heard it was good!', timestamp: new Date(Date.now() - 6900000), reactions: {} }, { mid: 305, senderId: 'benS', text: 'Confirming it is excellent. The spicy margaritas are... potent.', timestamp: new Date(Date.now() - 6800000), reactions: {'😂': {count: 2, users: ['user', 'mikeT']}} } ] },
        { id: 4, name: 'Skill Swap Central', icon: 'fas fa-tools', color: 'var(--primary-accent)', type: 'skill_swap', description: "Offer your skills or find someone to help you learn something new. Post 'OFFERING:' or 'SEEKING:'", lastMessage: "New: SEEKING: Someone to help with my garden", lastMessageTimestamp: new Date(Date.now() - 30000), unreadCount: 0, isJoined: false, isFavorite: false, messages: [{ mid: 401, senderId: 'defaultBot', text: "Welcome to Skill Swap Central! Clearly state if you're 'OFFERING:' a skill or 'SEEKING:' help. Be specific for best results!", timestamp: new Date(Date.now() - 120000), reactions:{}}, { mid: 402, senderId: 'benS', text: "OFFERING: Guitar lessons for beginners!", timestamp: new Date(Date.now() - 60000), reactions:{} }, { mid: 403, senderId: 'sarahG', text: "SEEKING: Someone to help with my garden. My tomato plants are looking sad.", timestamp: new Date(Date.now() - 30000), reactions:{}}]},
        { id: 5, name: 'Local Gardeners', icon: 'fas fa-seedling', color: 'var(--moss-green)', type: 'hobby', description: "For local gardening enthusiasts.", lastMessage: "BenS: I have extra tomato plants if anyone wants them!", lastMessageTimestamp: new Date(Date.now() - 86400000 * 2), unreadCount: 0, isJoined: true, isFavorite: false, messages: [{ mid: 501, senderId: 'benS', text: "I have extra tomato plants if anyone wants them!", timestamp: new Date(Date.now() - 86400000 * 2), reactions:{} } ] }
    ];
    let nextChannelId = mockChannels.length + 1;
    let nextMessageId = 502; // For new messages
    const channelTypeLabels = {
        general: "General", skill_swap: "Skill Swap", hobby: "Hobby Group", announcements: "Announcements", local_events: "Local Events", direct_message: "Direct Message"
    };


    let habits = [
        { id: 1, name: "Drink 8 glasses of water daily", goal: 8, current: 6, unit: "glasses", streak: 5, icon: "fas fa-glass-water", color: "var(--soft-blue)", isWaterTracker: true},
        { id: 2, name: "Read for 30 minutes before bed", goal: 1, current: 1, unit: "session", streak: 12, icon: "fas fa-book-open", color: "var(--moss-green)"},
        { id: 3, name: "10 min Morning Meditation Practice", goal: 1, current: 0, unit: "session", streak: 0, icon: "fas fa-brain", color: "var(--muted-terracotta)"},
        { id: 4, name: "Take a 15-min walk during lunch break", goal: 1, current: 0, unit: "walk", streak: 2, icon: "fas fa-person-walking", color: "var(--primary-accent)"},
        { id: 5, name: "Practice Duolingo Spanish for 10 mins", goal: 1, current: 1, unit: "lesson", streak: 25, icon: "fas fa-language", color: "#FFC107"},
        { id: 6, name: "No sugary drinks for the day", goal: 1, current: 0, unit: "day", streak: 1, icon: "fas fa-wine-bottle", color: "#9575CD"},
    ];
    let nextHabitId = habits.length + 1;
    let loggedMoods = []; 
    const availableIcons = ['fas fa-star', 'fas fa-heart', 'fas fa-tree', 'fas fa-building', 'fas fa-bicycle', 'fas fa-gamepad', 'fas fa-music', 'fas fa-paint-brush', 'fas fa-users', 'fas fa-comments', 'fas fa-lightbulb', 'fas fa-briefcase', 'fas fa-code', 'fas fa-language', 'fas fa-wrench', 'fas fa-seedling', 'fas fa-graduation-cap', 'fas fa-dumbbell', 'fas fa-apple-alt', 'fas fa-person-walking', 'fas fa-book-open', 'fas fa-brain', 'fas fa-glass-water', 'fas fa-wine-bottle'];
    const availableColors = ['var(--primary-accent)', 'var(--moss-green)', 'var(--soft-blue)', 'var(--muted-terracotta)', '#FFC107', '#9575CD', '#9CCC65', '#F06292'];
    const journalPrompts = [
        "What's one small thing that brought you joy today, and how can you invite more of it into your week?",
        "Describe a challenge you faced recently. How did you handle it, and what did you learn?",
        "What are you grateful for right now? List three things.",
        "If you could give your younger self one piece of advice, what would it be?",
        "What's a skill you'd like to learn or improve, and what's one step you can take towards it?"
    ];
    const safetyTickerMessages = [
        "Water outage on Main Street until 2 PM. Report issues at City Hall.",
        "Road closure on Elm Avenue due to construction. Plan alternate routes.",
        "Community cleanup event this Saturday at Willow Creek Park, 9 AM - 12 PM.",
        "Reminder: Local library's summer reading program sign-ups are now open!",
        "High pollen count today. Take precautions if you have allergies.",
        "Emergency Test: This is only a test of the LocalLife OS Alert System."
    ];
    let currentSafetyTickerIndex = 0;
    let dashboardCardConfig = [  // Make it let for modification by load
        { id: "localContextCard", name: "Local Context", visible: true }, 
        { id: "nearbyPulseSection", name: "Nearby Pulse", visible: true }, // Changed ID to match wrapper
        { id: "dashboardTaskListCard", name: "Dynamic Day View", visible: true },
        { id: "pinnedWidgetsCard", name: "Pinned Widgets", visible: true },
        { id: "proactiveSuggestionsCard", name: "Smart Suggestions", visible: true },
        { id: "topDealsCard", name: "Today's Top Deals", visible: true },
    ];
    let aiLearningPreferences = { // Default AI learning preferences
        learnSavedPlaces: true, learnMoodLogs: true, learnTaskPatterns: true, learnHabitTracking: true, learnChatStyle: false
    };


    let mockDeals = [
        { id: 1, title: "2-for-1 Coffee Mornings", description: "Get two coffees for the price of one every weekday before 11 AM. Perfect for starting your day or sharing with a friend!", businessName: "The Cozy Corner Cafe", category: "food", img: "https://via.placeholder.com/80x80.png?text=Coffee", expiryDate: "2024-12-31", terms: "Valid Mon-Fri, 7 AM - 11 AM. Excludes specialty drinks." },
        { id: 2, title: "20% Off First Haircut", description: "New customers get 20% off their first haircut service. Mention this deal when booking your appointment.", businessName: "Style Central Salon", category: "services", img: "https://via.placeholder.com/80x80.png?text=Haircut", expiryDate: "2024-11-30", terms: "New customers only. Cannot be combined with other offers. Appointment required." },
        { id: 3, title: "Happy Hour Pizza Slice", description: "Grab any pizza slice for just $2 during our happy hour, 4 PM - 6 PM daily. Choices vary daily.", businessName: "Pete's Pizza Parlor", category: "food", img: "https://via.placeholder.com/80x80.png?text=Pizza", expiryDate: null, terms: "Daily 4 PM - 6 PM. Limit 2 slices per person per visit. In-store only." },
        { id: 4, title: "15% Off All Books This Weekend", description: "Expand your library! Get 15% off all new and used books this weekend only. Great chance to find your next read.", businessName: "The Book Nook & Literary Cafe", category: "retail", img: "https://via.placeholder.com/80x80.png?text=Books", expiryDate: "2024-08-04", terms: "Valid this Saturday and Sunday only. Excludes rare editions." },
        { id: 5, title: "Free Yoga Trial Class", description: "Try your first yoga class for free! Experience Vinyasa, Hatha, or Restorative yoga with our expert instructors. All levels welcome.", businessName: "Zenith Yoga Studio", category: "wellness", img: "https://via.placeholder.com/80x80.png?text=Yoga", expiryDate: "2024-09-15", terms: "One free trial class per person. Must book in advance online or by phone." },
        { id: 6, title: "Lunch Special: Sandwich + Drink $10", description: "Enjoy our daily sandwich special with a fountain drink for just $10. Available 11 AM - 2 PM weekdays.", businessName: "Downtown Deli", category: "food", img: "https://via.placeholder.com/80x80.png?text=Deli", expiryDate: null, terms: "Weekdays 11 AM - 2 PM. Sandwich selection varies." },
        { id: 7, title: "Half-Price Appetizers (Mon-Thu)", description: "Enjoy 50% off all appetizers from Monday to Thursday, 3 PM - 6 PM. Great for an after-work snack!", businessName: "The Social Hub Eatery", category: "food", img: "https://via.placeholder.com/80x80.png?text=Apps", expiryDate: "2024-10-31", terms: "Valid Mon-Thu, 3PM-6PM. Dine-in only." }
    ];
    let nextDealId = mockDeals.length + 1;
    const dealCategories = ["food", "services", "retail", "wellness", "other"]; 

    let mockNotifications = [
        { id: 1, icon: 'fas fa-comments', title: 'New message in "Local Foodies"', text: 'MikeT: "Anyone tried the new Italian place on Elm? Heard it\'s great!"', timestamp: new Date(Date.now() - 3600000), read: false, type: 'chat_mention', action: () => { setActiveScreen('chat'); setTimeout(() => showSpecificChatView(3), 50); } },
        { id: 2, icon: 'fas fa-calendar-check', title: 'Task Reminder: Finalize Q3 Report', text: 'Due today at 10:30 AM. Don\'t forget to include sales figures.', timestamp: new Date(Date.now() - 7200000), read: true, type: 'task_reminder', action: () => { setActiveScreen('planner'); setTimeout(() => openFullCalendar('tasks'), 50); } },
        { id: 3, icon: 'fas fa-brain', title: 'AI Suggestion: Lunch Spot', text: 'It\'s almost lunchtime! Based on your preference for cafes, how about "The Cozy Corner Cafe"?', timestamp: new Date(Date.now() - 10800000), read: false, type: 'ai_suggestion', action: () => { const cafe = mockPlaces.all.find(p=>p.id===1); if(cafe) { setActiveScreen('explore'); setTimeout(() => showPlaceDetail(cafe), 50);} } },
        { id: 4, icon: 'fas fa-tags', title: 'New Deal Alert: Pizza!', text: 'Pete\'s Pizza Parlor is offering Happy Hour Slices for $2 from 4-6 PM.', timestamp: new Date(Date.now() - 14400000), read: false, type: 'deal_alert', action: () => { const deal = mockDeals.find(d=>d.id===3); if(deal) { setActiveScreen('explore'); setTimeout(() => showDealDetailModal(deal), 50); } } },
        { id: 5, icon: 'fas fa-user-friends', title: 'Channel Joined: "Dog Owners Park Group"', text: 'You have successfully joined the channel. Say hi to fellow dog lovers!', timestamp: new Date(Date.now() - 86400000), read: true, type: 'chat_activity', action: () => { setActiveScreen('chat'); setTimeout(() => showSpecificChatView(2), 50); } },
        { id: 6, icon: 'fas fa-paper-plane', title: 'New Direct Message', text: 'Sarah G: "Hey! Saw you in the foodies channel, you mentioned El Fuego, was it really that good?"', timestamp: new Date(Date.now() - 2 * 3600000), read: false, type: 'dm', action: () => { setActiveScreen('chat'); setTimeout(() => { toggleChannelListType('dms'); const dmChannel = findOrCreateDMChannel('sarahG'); showSpecificChatView(dmChannel.id); }, 100); } }
    ];
    let nextNotificationId = mockNotifications.length + 1;


    // --- Utility Functions ---
    document.addEventListener('keydown', (event) => { if (event.key === 'Escape' && currentOpenModalId) closeModal(currentOpenModalId); });

    function populateIconSelector(selectorId, selectedIconClass = null) {
        const selector = document.getElementById(selectorId);
        if(!selector) { console.error(`Icon selector #${selectorId} not found.`); return; }
        selector.innerHTML = '';
        availableIcons.forEach(iconClass => {
            const option = document.createElement('button');
            option.type = 'button';
            option.className = 'icon-option';
            if (iconClass === selectedIconClass) option.classList.add('selected');
            option.innerHTML = `<i class="${iconClass}"></i>`;
            option.dataset.icon = iconClass;
            option.setAttribute('role', 'radio');
            option.setAttribute('aria-checked', iconClass === selectedIconClass ? 'true' : 'false');
            option.setAttribute('aria-label', iconClass.replace('fas fa-', '')); 
            option.onclick = () => {
                selector.querySelectorAll('.icon-option').forEach(el => {
                    el.classList.remove('selected');
                    el.setAttribute('aria-checked', 'false');
                });
                option.classList.add('selected');
                option.setAttribute('aria-checked', 'true');
            };
            selector.appendChild(option);
        });
    }
     function populateColorSelector(selectorId, selectedColorValue = null) {
        const selector = document.getElementById(selectorId);
        if(!selector) { console.error(`Color selector #${selectorId} not found.`); return; }
        selector.innerHTML = '';
        availableColors.forEach(colorValue => {
            const option = document.createElement('button');
            option.type = 'button';
            option.className = 'icon-option'; 
            if (colorValue === selectedColorValue) option.classList.add('selected');
            
            const colorDot = document.createElement('div');
            colorDot.style.width = '24px';
            colorDot.style.height = '24px';
            colorDot.style.borderRadius = '50%';
            colorDot.style.backgroundColor = colorValue;
            colorDot.style.border = '1px solid rgba(0,0,0,0.1)'; 

            option.appendChild(colorDot);
            option.dataset.color = colorValue;
            option.setAttribute('role', 'radio');
            option.setAttribute('aria-checked', colorValue === selectedColorValue ? 'true' : 'false');
            option.setAttribute('aria-label', `Color ${colorValue}`); 
            option.onclick = () => {
                selector.querySelectorAll('.icon-option').forEach(el => {
                    el.classList.remove('selected');
                    el.setAttribute('aria-checked', 'false');
                });
                option.classList.add('selected');
                option.setAttribute('aria-checked', 'true');
            };
            selector.appendChild(option);
        });
    }
    function clearInputField(inputId, buttonEl) {
        const inputField = document.getElementById(inputId);
        if (inputField) inputField.value = '';
        if (buttonEl) buttonEl.classList.add('hidden');
        if (inputField) inputField.focus();
        if (inputId === 'exploreSearchInput') handleExploreSearch(true); // Force re-render for explore
    }
    function setupInputClearButtons() {
        const inputsWithClear = [
            { inputId: 'newTaskInput', clearBtnId: 'clearNewTaskInput' },
            { inputId: 'exploreSearchInput', clearBtnId: 'clearExploreSearchInput' }
        ];
        inputsWithClear.forEach(item => {
            const input = document.getElementById(item.inputId);
            const btn = document.getElementById(item.clearBtnId);
            if (input && btn) {
                input.addEventListener('input', () => {
                    btn.classList.toggle('hidden', input.value === '');
                });
                // Initialize visibility
                btn.classList.toggle('hidden', input.value === '');
            }
        });
    }

    // --- Navigation ---
    navItems.forEach(item => item.addEventListener('click', () => {
        setActiveScreen(item.dataset.screen);
        if (navigator.vibrate) navigator.vibrate(50); 
    }));


    // --- Skeleton Loaders ---
    function getSkeletonTaskItem() {
        return `
            <div class="skeleton-list-item">
                <div class="skeleton-checkbox"></div>
                <div style="flex-grow:1;">
                    <div class="skeleton-text-line long"></div>
                    <div class="skeleton-text-line short"></div>
                </div>
            </div>`;
    }
    function getSkeletonPlaceCard() { 
        return `
            <article class="skeleton-card card no-press">
                <div class="skeleton-avatar" style="width:60px; height:60px; border-radius:var(--border-radius-md);"></div>
                <div class="skeleton-info">
                    <div class="skeleton-item title" style="height:16px; width:70%;"></div>
                    <div class="skeleton-item text" style="height:10px; width:90%;"></div>
                    <div class="skeleton-item text-short" style="height:10px; width:50%;"></div>
                </div>
            </article>`;
    }
    function getSkeletonChannelItem() { // Chat UI improved, skeleton adapts
        return `
            <div class="channel-item skeleton-list-item" style="padding: 12px 15px !important; align-items: center; background:var(--card-bg);">
                <div class="skeleton-avatar" style="width:48px; height:48px; border-radius:50%; margin-right: 12px;"></div>
                <div style="flex-grow:1;">
                    <div class="skeleton-text-line long" style="height:16px; width:60%; margin-bottom:4px;"></div>
                    <div class="skeleton-text-line short" style="height:12px; width:80%;"></div>
                </div>
                <div style="display:flex; flex-direction:column; align-items:flex-end;">
                     <div class="skeleton-item" style="height:10px; width:30px; margin-bottom:5px;"></div>
                     <div class="skeleton-item" style="height:18px; width:18px; border-radius:50%;"></div>
                </div>
            </div>`;
    }
    function getSkeletonHabitItem() {
         return `
            <div class="skeleton-list-item">
                 <div style="flex-grow:1;">
                    <div class="skeleton-text-line long"></div>
                    <div class="skeleton-text-line short"></div>
                </div>
                <div class="skeleton-avatar" style="width:40px; height:40px; border-radius:50%;"></div>
            </div>`;
    }
     function getSkeletonPinnedWidget() {
        return `
            <div class="pinned-widget-item">
                <div class="skeleton-item" style="width: 20px; height: 20px; border-radius: 4px; margin-bottom: 8px;"></div>
                <div class="skeleton-item title" style="width: 80%; height: 10px; margin-bottom: 5px;"></div>
                <div class="skeleton-item text-short" style="width: 60%; height: 12px;"></div>
            </div>`;
    }

    // --- Dashboard ---
    function renderDashboardTasks() {
        const container = document.getElementById('dashboardTaskList');
        const aiInsightContainer = document.getElementById('aiDashboardInsight');
        if (!container || !aiInsightContainer) return;
        
        container.innerHTML = Array(2).fill(getSkeletonTaskItem()).join('');
        container.setAttribute('aria-busy', 'true');
        aiInsightContainer.classList.add('hidden');


        setTimeout(() => {
            container.innerHTML = ''; 
            const today = new Date().toISOString().split('T')[0];
            const upcomingTasks = tasks.filter(t => !t.completed && (t.dueDate === today || t.dueDate === "Today" || !t.dueDate)).slice(0, 3); 
            if (upcomingTasks.length === 0) {
                container.innerHTML = `<div class="empty-state" style="padding:10px 0;"><i class="fas fa-check-circle"></i><p>All tasks done for now!</p></div>`;
                 aiInsightContainer.innerHTML = `<i class="fas fa-brain"></i> AI: Great job clearing your tasks, ${userName}! Time to relax or plan something fun.`;
                 aiInsightContainer.classList.remove('hidden');
            } else {
                upcomingTasks.forEach(task => {
                     const taskEl = document.createElement('div');
                     taskEl.className = 'task-item'; 
                     taskEl.setAttribute('role', 'listitem');
                     taskEl.innerHTML = `
                        <button class="task-checkbox-button" onclick="toggleTaskStatus(${task.id}, true)" aria-label="${task.completed ? 'Mark as incomplete' : 'Mark as complete'} ${task.title}">
                            <div class="task-checkbox ${task.completed ? 'completed' : ''}">${task.completed ? '<i class="fas fa-check"></i>' : ''}</div>
                        </button>
                        <div class="task-info">
                            <div class="task-title">${task.title}</div>
                            <div class="task-time">${task.time}</div>
                        </div>
                     `;
                     container.appendChild(taskEl);
                });
                const todayStr = new Date().toISOString().split('T')[0];
                if(upcomingTasks.some(t => t.category === 'work' && (t.dueDate === todayStr || t.dueDate === "Today") )) {
                     aiInsightContainer.innerHTML = `<i class="fas fa-brain"></i> AI: Looks like a productive day ahead, ${userName}! Focus on those work items.`;
                     aiInsightContainer.classList.remove('hidden');
                } else if (upcomingTasks.some(t => t.category === 'health')) {
                     aiInsightContainer.innerHTML = `<i class="fas fa-brain"></i> AI: Don't forget your wellness goals today, ${userName}!`;
                     aiInsightContainer.classList.remove('hidden');
                } else {
                     aiInsightContainer.classList.add('hidden');
                }
            }
            container.setAttribute('aria-busy', 'false');
            renderPinnedWidgets(); 
        }, 500); 
    }
    function cycleSafetyTicker() {
        currentSafetyTickerIndex = (currentSafetyTickerIndex + 1) % safetyTickerMessages.length;
        const tickerTextEl = document.getElementById('safetyTickerText');
        if(tickerTextEl) {
            tickerTextEl.style.opacity = 0;
            setTimeout(() => {
                tickerTextEl.textContent = safetyTickerMessages[currentSafetyTickerIndex];
                tickerTextEl.style.opacity = 1;
            }, 200);
        }
    }
    function triggerSOS() {
        if (navigator.vibrate) navigator.vibrate([100, 50, 100, 50, 200]);
        openGenericModal("SOS Triggered (Mock)", "<p><i class='fas fa-triangle-exclamation fa-2x' style='color:var(--danger-color);'></i> This is a mock SOS alert.</p><p>In a real application, this would immediately perform the following actions (based on your pre-configured settings):</p><ul><li>Notify your emergency contacts (e.g., family, friends) with your precise location.</li><li>Optionally, share your location with a trusted community safety group channel.</li><li>Provide a one-tap button to call local emergency services (e.g., 911).</li></ul><p><strong>(Conceptual AI Feature):</strong> The AI could attempt to listen for keywords (e.g., 'help', 'fire') via the microphone to add context to the alert, or analyze recent app activity for clues about your situation. This is a highly conceptual feature and would require strict user permissions and privacy considerations.</p>");
    }

    function renderPinnedWidgets() {
        const container = document.getElementById('pinnedWidgetsContainer');
        if (!container) return;
        container.innerHTML = Array(2).fill(getSkeletonPinnedWidget()).join('');
        container.setAttribute('aria-busy', 'true');

        setTimeout(() => {
            container.innerHTML = '';
            const widgets = [];
            const today = new Date().toISOString().split('T')[0];

            // 1. Next Important Task Widget
            const nextTask = tasks.find(t => !t.completed && (t.dueDate === today || t.dueDate === "Today" || !t.dueDate));
            if (nextTask) {
                widgets.push({
                    icon: 'fas fa-clipboard-list', color: 'var(--primary-accent)', title: 'Next Task',
                    value: `${nextTask.title.substring(0, 25)}${nextTask.title.length > 25 ? '...' : ''}`,
                    action: () => setActiveScreen('planner')
                });
            } else {
                 widgets.push({
                    icon: 'fas fa-check-circle', color: 'var(--success-color)', title: 'Tasks',
                    value: 'All clear!', action: () => setActiveScreen('planner')
                });
            }

            // 2. Water Intake Widget
            const waterHabit = habits.find(h => h.isWaterTracker);
            if (waterHabit) {
                widgets.push({
                    icon: 'fas fa-tint', color: 'var(--soft-blue)', title: 'Water Intake',
                    value: `${waterHabit.current}/${waterHabit.goal} ${waterHabit.unit || 'glasses'}`,
                    action: () => setActiveScreen('wellness')
                });
            }

            // 3. Unread Community Messages Widget
            const unreadChannels = mockChannels.filter(c => c.isJoined && c.unreadCount > 0);
            const totalUnread = unreadChannels.reduce((sum, c) => sum + c.unreadCount, 0);
            if (totalUnread > 0) {
                widgets.push({
                    icon: 'fas fa-comments', color: 'var(--moss-green)', title: 'Community',
                    value: `${totalUnread} unread in ${unreadChannels.length} channel${unreadChannels.length > 1 ? 's' : ''}`,
                    action: () => setActiveScreen('chat')
                });
            }
            
            // 4. Habit Streak Widget
            const highStreakHabit = habits.find(h => h.streak > 5);
            if(highStreakHabit){
                 widgets.push({
                    icon: 'fas fa-fire', color: '#FF9800', title: `${highStreakHabit.name.substring(0,12)}...`,
                    value: `${highStreakHabit.streak} Day Streak!`, action: () => setActiveScreen('wellness')
                });
            }

            // 5. Favorite Place Open Status Widget
            const savedPlace = mockPlaces.all.find(p => p.saved); // Find any saved place
            if (savedPlace) {
                widgets.push({
                    icon: 'fas fa-store', color: 'var(--muted-terracotta)', title: `${savedPlace.name.substring(0,15)}...`,
                    value: `${savedPlace.openNow ? 'Open Now' : 'Closed'}`, action: () => showPlaceDetail(savedPlace)
                });
            }
            
            // Shuffle and pick up to 4 to display
            const shuffledWidgets = widgets.sort(() => 0.5 - Math.random()).slice(0, Math.min(widgets.length, 4));


            if (shuffledWidgets.length === 0) {
                container.innerHTML = `<p class="card-subtitle text-center" style="grid-column: 1 / -1;">No pinned info available. Configure in Settings.</p>`;
            } else {
                shuffledWidgets.forEach(widgetData => {
                    const widgetEl = document.createElement('div');
                    widgetEl.className = 'pinned-widget-item';
                    widgetEl.onclick = widgetData.action;
                    widgetEl.innerHTML = `
                        <i class="${widgetData.icon} widget-icon" style="color:${widgetData.color};"></i>
                        <span class="widget-title">${widgetData.title}</span>
                        <span class="widget-value">${widgetData.value}</span>
                    `;
                    container.appendChild(widgetEl);
                });
            }

            container.setAttribute('aria-busy', 'false');
        }, 300);
    }


    function updateProactiveSuggestions() {
        const container = document.getElementById('proactiveSuggestionsContainer');
        if (!container) return;
        container.innerHTML = '<p class="card-subtitle"><i class="fas fa-spinner fa-spin" style="color: var(--primary-accent);" aria-hidden="true"></i> AI is thinking of suggestions...</p>';

        setTimeout(() => { 
            container.innerHTML = ''; 
            const suggestions = [];
            const today = new Date().toISOString().split('T')[0];
            
            // Task-based suggestion
            const overdueWorkTask = tasks.find(t => !t.completed && t.category === 'work' && (t.dueDate === today || t.dueDate === "Today") && (!t.time || new Date().getHours() > parseInt(t.time.split(':')[0])) ); // Check if past time
            if(overdueWorkTask){
                suggestions.push({
                    id: 'overdueWork', icon: 'fa-triangle-exclamation', text: `High Priority: Your task "${overdueWorkTask.title.substring(0,25)}..." seems to be approaching or past its time!`,
                    buttonText: 'View in Planner', buttonIcon: 'fa-calendar-alt', action: () => setActiveScreen('planner')
                });
            }

            const weatherTextEl = document.getElementById('currentWeather');
            if (weatherTextEl) {
                const weatherText = weatherTextEl.textContent.toLowerCase();
                if (weatherText && weatherText.includes('sunny') && tasks.some(t => t.title.toLowerCase().includes('walk') && !t.completed)) {
                    suggestions.push({
                        id: 'sunnyWalk', icon: 'fa-sun', text: `It's sunny, ${userName} – ideal for that park walk you planned!`,
                        buttonText: 'Find a Park', buttonIcon: 'fa-tree',
                        action: () => { setActiveScreen('explore'); setTimeout(() => { const parkFilterButton = document.querySelector('#exploreFilterBar button[data-filter=\'parks\']'); if (parkFilterButton) filterPlaces('parks', parkFilterButton);}, 50);}
                    });
                } else if (weatherText && weatherText.includes('rain') && tasks.some(t => t.title.toLowerCase().includes('outdoor') && !t.completed)) {
                     suggestions.push({
                        id: 'rainyOutdoor', icon: 'fa-cloud-rain', text: "Looks like rain. Maybe reschedule that outdoor activity or find an indoor alternative?",
                        buttonText: 'Indoor Activities', buttonIcon: 'fa-building',
                        action: () => { setActiveScreen('explore'); setTimeout(() => { document.getElementById('exploreSearchInput').value = "indoor"; handleExploreSearch(true);}, 50);}
                    });
                }
            }
            const recentStressedMood = loggedMoods.find(m => ['😞', '🙁'].includes(m.mood) && (new Date() - new Date(m.timestamp) < 24 * 60 * 60 * 1000));
            const yogaEvent = mockPlaces.all.find(p => p.name.toLowerCase().includes('yoga in the park')); // More specific
            if (recentStressedMood && yogaEvent && aiLearningPreferences.learnMoodLogs) {
                 suggestions.push({
                    id: 'stressedMoodSugg', icon: 'fa-spa', text: `AI noticed you logged a less positive mood recently. The 'Yoga in the Park' is often available. Shall I add it to your planner for tomorrow?`,
                    buttonText: 'Add to Planner', buttonIcon: 'fa-calendar-plus', action: () => { const tomorrow = new Date(Date.now() + 86400000).toISOString().split('T')[0]; addNewTask("Yoga in the Park", "health", "10:00 AM", tomorrow); showToast("Yoga added to planner for tomorrow!", "success");}
                });
            }
            
            const savedCafe = mockPlaces.all.find(p => p.saved && p.type === 'food' && (p.name.toLowerCase().includes('cafe') || p.tags.includes('cafe')));
            const coffeeDeal = mockDeals.find(d => d.category === 'food' && d.title.toLowerCase().includes('coffee'));
            if(savedCafe && coffeeDeal && aiLearningPreferences.learnSavedPlaces){
                 suggestions.push({
                    id: 'cafeDeal', icon: 'fa-tags', text: `Since you like ${savedCafe.name.substring(0,15)}..., check out this deal: "${coffeeDeal.title.substring(0,20)}..."!`,
                    buttonText: 'View Deal', buttonIcon: 'fa-compass', action: () => { setActiveScreen('explore'); setTimeout(() => showDealDetailModal(coffeeDeal), 50); }
                });
            }
             // Habit Streak Suggestion
            const longStreakHabit = habits.find(h => h.streak > 10 && h.current < h.goal);
            if (longStreakHabit && aiLearningPreferences.learnHabitTracking) {
                suggestions.push({
                    id: 'habitStreak', icon: 'fa-fire', text: `Keep up the great work on "${longStreakHabit.name.substring(0,20)}..."! You're on a ${longStreakHabit.streak}-day streak!`,
                    buttonText: 'View Wellness', buttonIcon: 'fa-heartbeat', action: () => setActiveScreen('wellness')
                });
            }


            if (suggestions.length === 0) {
                container.innerHTML = `<div class="empty-state" style="padding:10px 0;"><i class="fas fa-brain"></i><p>AI: No specific suggestions right now, ${userName}. Enjoy your day!</p></div>`;
                return;
            }
            const firstSugg = suggestions[Math.floor(Math.random() * suggestions.length)]; 
            const suggEl = document.createElement('div');
            suggEl.className = 'mb-3';
            suggEl.innerHTML = `
                <p class="card-subtitle"><i class="fas ${firstSugg.icon}" style="color: var(--primary-accent);" aria-hidden="true"></i> ${firstSugg.text}</p>
                ${firstSugg.buttonText ? `<button class="button button-secondary suggestion-action" data-sugg-id="${firstSugg.id}"><i class="fas ${firstSugg.buttonIcon}" aria-hidden="true"></i> ${firstSugg.buttonText}</button>` : ''}
            `;
            container.appendChild(suggEl);
            if (firstSugg.buttonText) {
                 const btn = suggEl.querySelector('button');
                 if (btn) btn.onclick = firstSugg.action;
            }
            if (suggestions.length > 1) {
                const seeMoreButton = document.createElement('button');
                seeMoreButton.className = 'button button-secondary mt-2';
                seeMoreButton.style.fontSize = '0.8rem';
                seeMoreButton.innerHTML = `<i class="fas fa-layer-group"></i> AI: View ${suggestions.length - 1} More Suggestions`;
                seeMoreButton.onclick = () => {
                    let suggestionHtml = "<ul>";
                    suggestions.forEach(s => suggestionHtml += `<li><i class="fas ${s.icon}"></i> ${s.text}</li>`);
                    suggestionHtml += "</ul><p class='mt-2 card-subtitle'><em>In a real app, these could be swipeable cards or shown in the AI chat.</em></p>";
                    openGenericModal("AI Proactive Suggestions", suggestionHtml);
                };
                container.appendChild(seeMoreButton);
            }
        }, 800);
    }
    
    function renderDealsOnDashboard() {
        const container = document.getElementById('dashboardDealsList');
        if (!container) return;

        container.innerHTML = getSkeletonPlaceCard(); 
        container.setAttribute('aria-busy', 'true');

        setTimeout(() => {
            container.innerHTML = '';
            
            let topDeals = [];
            
            // AI Logic: Prioritize deals related to saved places or user habits
            const savedPlace = mockPlaces.all.find(p => p.saved);
            const wellnessHabit = habits.some(h => h.category === 'health' || h.name.toLowerCase().includes('yoga') || h.name.toLowerCase().includes('gym'));
            
            if (savedPlace && aiLearningPreferences.learnSavedPlaces) {
                const relatedDeal = mockDeals.find(d => d.businessName.toLowerCase().includes(savedPlace.name.split(" ")[0].toLowerCase()) || d.category === savedPlace.type);
                if (relatedDeal) topDeals.push(relatedDeal);
            }
            if (wellnessHabit && aiLearningPreferences.learnHabitTracking) {
                const wellnessDeal = mockDeals.find(d => d.category === 'wellness');
                if (wellnessDeal) topDeals.push(wellnessDeal);
            }

          
// Fill up with other deals if AI didn't find specific ones
            const otherDeals = mockDeals.filter(d => !topDeals.some(td => td.id === d.id));
            while (topDeals.length < 2 && otherDeals.length > 0) {
                topDeals.push(otherDeals.shift());
            }
            topDeals = [...new Set(topDeals)].slice(0, 2); // Ensure unique and max 2

            if (topDeals.length === 0) {
                container.innerHTML = `<div class="empty-state" style="padding:10px 0;"><i class="fas fa-tags"></i><p>AI: No special deals match your profile today, ${userName}. Check Explore!</p></div>`;
            } else {
                topDeals.forEach(deal => {
                    const dealEl = document.createElement('article');
                    dealEl.className = 'card deal-card no-press'; 
                    dealEl.style.marginBottom = '10px'; 
                    dealEl.setAttribute('role', 'button');
                    dealEl.setAttribute('tabindex', '0');
                    dealEl.onclick = () => showDealDetailModal(deal);
                    dealEl.onkeypress = (event) => { if(event.key === 'Enter' || event.key === ' ') showDealDetailModal(deal); };

                    let expiryText = '';
                    if (deal.expiryDate) {
                        const expiry = new Date(deal.expiryDate);
                        const today = new Date();
                        today.setHours(0,0,0,0);
                        expiryText = expiry < today ? `<span class="expiry" style="color:var(--danger-color); font-weight:bold;">Expired</span>` : `<span class="expiry">Expires: ${expiry.toLocaleDateString()}</span>`;
                    }
                    dealEl.innerHTML = `
                        <img src="${deal.img}" alt="${deal.title}">
                        <div class="deal-info">
                            <div class="name">${deal.title}</div>
                            <div class="details">${deal.description.substring(0, 50)}...</div>
                            <div class="business">${deal.businessName}</div>
                            ${expiryText}
                        </div>
                    `;
                    container.appendChild(dealEl);
                });
            }
            container.setAttribute('aria-busy', 'false');
        }, 700);
    }

    window.navigateToExploreDeals = function() {
        setActiveScreen('explore');
        setTimeout(() => {
            const dealFilterButton = document.querySelector('#exploreFilterBar button[data-filter="deals"]');
            if (dealFilterButton) {
                filterPlaces('deals', dealFilterButton);
            }
        }, 100);
    }


    // --- Planner ---
    const taskListEl = document.getElementById('taskList');
    const newTaskInputEl = document.getElementById('newTaskInput');
    const taskCategories = ["personal", "work", "errands", "learning", "health", "general"];
    const aiPlannerSuggestionEl = document.getElementById('aiPlannerSuggestion');


    function renderTasks(fromDashboardToggle = false) { 
        if (!taskListEl) { console.error("taskListEl not found"); return; }
        taskListEl.innerHTML = Array(3).fill(getSkeletonTaskItem()).join('');
        taskListEl.setAttribute('aria-busy', 'true');

        setTimeout(() => {
            taskListEl.innerHTML = '';
            const today = new Date().toDateString();
            if (tasks.length === 0) {
                taskListEl.innerHTML = `<li class="empty-state"><i class="fas fa-calendar-check"></i><p>Your day is clear! Add a task to get started.</p></li>`;
            } else {
                tasks.sort((a,b) => { 
                    if (a.completed !== b.completed) return a.completed - b.completed;
                    
                    const aDate = a.dueDate ? new Date(a.dueDate) : new Date(8640000000000000); // Far future
                    const bDate = b.dueDate ? new Date(b.dueDate) : new Date(8640000000000000);
                    if (aDate.getTime() !== bDate.getTime()) return aDate - bDate;

                    const categoryOrder = { "work": 1, "learning": 2, "health": 3, "errands": 4, "personal": 5, "general": 6 };
                    return (categoryOrder[a.category] || 99) - (categoryOrder[b.category] || 99);
                }).forEach(task => { 
                    const taskItem = document.createElement('li');
                    taskItem.className = `task-item task-category-${task.category || 'general'}`;
                    taskItem.dataset.taskId = task.id;
                    let aiMetaHtml = '';
                    if(task.aiParsedDetails && Object.keys(task.aiParsedDetails).length > 0){
                        aiMetaHtml = `<div class="task-meta-ai"><i class="fas fa-brain"></i> AI Parsed: ${Object.entries(task.aiParsedDetails).map(([key, value]) => `${key.charAt(0).toUpperCase() + key.slice(1)}: ${value}`).join('; ')}</div>`;
                    }
                    const dueDateString = task.dueDate ? `(Due: ${new Date(task.dueDate).toLocaleDateString([], {month: 'short', day: 'numeric'})})`: '';

                    taskItem.innerHTML = `
                        <button class="task-checkbox-button" onclick="toggleTaskStatus(${task.id})" aria-label="${task.completed ? 'Mark as incomplete' : 'Mark as complete'} ${task.title}">
                            <div class="task-checkbox ${task.completed ? 'completed' : ''}">
                                ${task.completed ? '<i class="fas fa-check"></i>' : ''}
                            </div>
                        </button>
                        <div class="task-info">
                            <div class="task-title ${task.completed ? 'completed' : ''}">${task.title}</div>
                            <div class="task-time">${task.time} ${dueDateString}</div>
                            ${aiMetaHtml}
                        </div>
                        <div class="task-actions">
                            <button class="task-action-button edit" onclick="openEditTaskModal(${task.id})" aria-label="Edit task: ${task.title}"><i class="fas fa-pencil-alt"></i></button>
                            <button class="task-action-button delete" onclick="deleteTask(${task.id})" aria-label="Delete task: ${task.title}"><i class="fas fa-trash-alt"></i></button>
                        </div>
                    `;
                    taskListEl.appendChild(taskItem);
                });
            }
            taskListEl.setAttribute('aria-busy', 'false');
            if (!fromDashboardToggle) renderDashboardTasks(); 
            updateProactiveSuggestions();
            renderPinnedWidgets();
            saveTasksToLocalStorage();
        }, 500);
    }
    
    function decomposeTask(taskId) {
        const taskIndex = tasks.findIndex(t => t.id === taskId);
        if (taskIndex === -1) return;

        const originalTask = tasks[taskIndex];
        // Remove original task
        tasks.splice(taskIndex, 1);

        // Add decomposed sub-tasks
        const subTasks = [
            { title: `Set budget for ${originalTask.title}`, category: "personal", time: "ASAP" },
            { title: `Create guest list for ${originalTask.title}`, category: "personal", time: "Soon" },
            { title: `Research and book venue for party`, category: "errands", time: "This week" },
            { title: `Send out invitations for ${originalTask.title}`, category: "personal", time: "Next week" },
        ];

        subTasks.forEach(st => {
            tasks.push({ id: nextTaskId++, title: st.title, time: st.time, category: st.category, completed: false, notes: `Sub-task of '${originalTask.title}'`, dueDate: new Date().toISOString().split('T')[0], recurrence: "none", aiParsedDetails: { project: originalTask.title } });
        });

        renderTasks();
        showToast("AI has broken down the task for you!", "success");
    }

    function addNewTask(titleFromAI = null, categoryFromAI = null, timeFromAI = null, dateFromAI = null, parsedDetailsFromAI = null) { 
        if (!newTaskInputEl && !titleFromAI) { console.error("newTaskInputEl not found and no title from AI"); return false; }
        const taskTitle = titleFromAI || newTaskInputEl.value.trim();
        if (!taskTitle) {
            showToast("Please enter a task title.", "error", 2000);
            if (newTaskInputEl) newTaskInputEl.focus();
            return false;
        }

        // AI Task Decomposition check
        const isComplex = taskTitle.toLowerCase().startsWith('plan ') || taskTitle.toLowerCase().startsWith('organize ');
        if(isComplex && !titleFromAI){
            const tempId = Date.now(); // temp id
            tasks.push({ id: tempId, title: taskTitle, time: "Project", category: "personal", completed: false, notes: "", dueDate: new Date().toISOString().split('T')[0], recurrence: "none" });
            renderTasks();
            if (aiPlannerSuggestionEl) {
                aiPlannerSuggestionEl.innerHTML = `<i class="fas fa-brain"></i> This looks like a multi-step project. Can I break it down for you? <button class="button-secondary" style="padding:2px 5px; font-size:0.7rem; margin-left:5px;" onclick="decomposeTask(${tempId})">Yes, Please!</button>`;
                aiPlannerSuggestionEl.classList.remove('hidden');
            }
            if (newTaskInputEl) {
                newTaskInputEl.value = '';
                document.getElementById('clearNewTaskInput')?.classList.add('hidden');
            }
            return;
        }


        let category = categoryFromAI || "personal"; 
        let time = timeFromAI || "Anytime";
        let dueDate = dateFromAI || new Date().toISOString().split('T')[0];
        let aiParsedDetails = parsedDetailsFromAI || {};
        
        if(!titleFromAI) { // Parse if not from AI directly
            const lowerTitle = taskTitle.toLowerCase();
            // Category parsing
            if (lowerTitle.includes("meeting") || lowerTitle.includes("report") || lowerTitle.includes("call client") || lowerTitle.includes("work on") || lowerTitle.includes("submit proposal")) category = "work";
            else if (lowerTitle.includes("buy ") || lowerTitle.includes("pick up") || lowerTitle.includes("groceries") || lowerTitle.includes("errand for")) category = "errands";
            else if (lowerTitle.includes("learn ") || lowerTitle.includes("study for") || lowerTitle.includes("read book")) category = "learning";
            else if (lowerTitle.includes("gym") || lowerTitle.includes("workout") || lowerTitle.includes("doctor appt") || lowerTitle.includes("meditation") || lowerTitle.includes("jog")) category = "health";

            // Time parsing
            const timeMatch = taskTitle.match(/at\s+(\d{1,2}(:\d{2})?\s*(am|pm)?)/i);
            if (timeMatch && timeMatch[1]) {
                time = timeMatch[1].trim().toUpperCase();
                aiParsedDetails.time = time;
            }
            // Date parsing
            const dateMatch = taskTitle.match(/on\s+(monday|tuesday|wednesday|thursday|friday|saturday|sunday|today|tomorrow)/i);
            if(dateMatch && dateMatch[1]) {
                const day = dateMatch[1].toLowerCase();
                let dateObj = new Date();
                if(day === 'tomorrow') dateObj.setDate(dateObj.getDate() + 1);
                // Simple weekday parsing for demo
                else if (day !== 'today') {
                    const weekdays = ['sunday', 'monday', 'tuesday', 'wednesday', 'thursday', 'friday', 'saturday'];
                    let dayIndex = weekdays.indexOf(day);
                    while(dateObj.getDay() !== dayIndex) {
                        dateObj.setDate(dateObj.getDate() + 1);
                    }
                }
                dueDate = dateObj.toISOString().split('T')[0];
                aiParsedDetails.date = dueDate;
            } else {
                 const explicitDateMatch = taskTitle.match(/(\d{1,2}[\/-]\d{1,2}(?:[\/-]\d{2,4})?)/);
                 if(explicitDateMatch && explicitDateMatch[1]) {
                     // This needs robust parsing in a real app
                     dueDate = new Date(explicitDateMatch[1]).toISOString().split('T')[0];
                     aiParsedDetails.date = dueDate;
                 }
            }
            // Location parsing
            const locationMatch = taskTitle.match(/(?:at|in|from)\s+([A-Z][a-zA-Z\s]+(?:Cafe|Park|Store|Cleaners|Market|Library|Office|Hub|Center|Plaza|Square))/); // More specific location keywords
            if (locationMatch && locationMatch[1]) {
                aiParsedDetails.location = locationMatch[1].trim();
            }
            // Person parsing
            const personMatch = taskTitle.match(/(?:with|for|call|meet)\s+([A-Z][a-z]+(?:\s+[A-Z][a-z]+)?)/); // Names usually capitalized
            if (personMatch && personMatch[1] && !taskCategories.includes(personMatch[1].toLowerCase()) && personMatch[1].toLowerCase() !== "mom" && personMatch[1].toLowerCase() !== "dad") { // Avoid matching categories or generic terms
                aiParsedDetails.person = personMatch[1].trim();
            }

            if (aiPlannerSuggestionEl) {
                if(Object.keys(aiParsedDetails).length > 0){
                    aiPlannerSuggestionEl.innerHTML = `<i class="fas fa-brain"></i> AI parsed: ${Object.entries(aiParsedDetails).map(([key, value]) => `${key.charAt(0).toUpperCase() + key.slice(1)}: ${value}`).join('; ')}. <button class="button-secondary" style="padding:2px 5px; font-size:0.7rem;" onclick="this.parentElement.classList.add('hidden')">Dismiss</button>`;
                    aiPlannerSuggestionEl.classList.remove('hidden');
                } else {
                    aiPlannerSuggestionEl.classList.add('hidden');
                }
            }


        } else { // From AI directly, details are already parsed
             if (timeFromAI) aiParsedDetails.time = timeFromAI;
             if (dateFromAI) aiParsedDetails.date = dateFromAI;
        }


        tasks.push({ id: nextTaskId++, title: taskTitle, time: time, category: category, completed: false, notes: "", dueDate: dueDate, recurrence: "none", aiParsedDetails: Object.keys(aiParsedDetails).length > 0 ? aiParsedDetails : null });
        renderTasks();
        if (!titleFromAI && newTaskInputEl) {
            newTaskInputEl.value = '';
            document.getElementById('clearNewTaskInput')?.classList.add('hidden');
        }
        showToast("Task added!", "success", 1500);
        triggerFabSuggestion();
        return true; 
    }

    window.toggleTaskStatus = function(taskId, fromDashboard = false) { 
        const task = tasks.find(t => t.id === taskId);
        if (task) {
            task.completed = !task.completed;
            if (navigator.vibrate) navigator.vibrate(50); 
            renderTasks(fromDashboard); 
            if (fromDashboard && document.getElementById('dashboard').classList.contains('active')) {
                renderDashboardTasks(); 
            }
            showToast(task.completed ? `Task "${task.title.substring(0,15)}..." completed!` : `Task "${task.title.substring(0,15)}..." marked incomplete.`, "info", 1800);
            checkForWellnessPatterns();
        } else {
            showToast("Error: Task not found.", "error", 2000, true);
        }
    }
    window.deleteTask = function(taskId) { 
        const taskIndex = tasks.findIndex(t => t.id === taskId);
        if (taskIndex > -1) {
            const deletedTaskTitle = tasks[taskIndex].title;
            tasks.splice(taskIndex, 1);
            renderTasks();
            showToast(`Task "${deletedTaskTitle.substring(0,20)}..." deleted.`, "info", 1500);
        } else {
            showToast("Error: Task not found for deletion.", "error", 2000, true);
        }
    }
    function openEditTaskModal(taskId) {
        const task = tasks.find(t => t.id === taskId);
        if (!task) { showToast("Error: Task not found.", "error", 2000, true); return; }

        document.getElementById('editingTaskId').value = task.id;
        document.getElementById('editTaskTitleInput').value = task.title;
        document.getElementById('editTaskTimeInput').value = task.time;
        // Convert to 'YYYY-MM-DD' for date input, handle friendly names
        let dateValue = task.dueDate;
        if (dateValue === "Today") dateValue = new Date().toISOString().split('T')[0];
        else if (dateValue === "Tomorrow") {
            let tomorrow = new Date(); tomorrow.setDate(tomorrow.getDate() + 1);
            dateValue = tomorrow.toISOString().split('T')[0];
        }
        document.getElementById('editTaskDueDateInput').value = dateValue || '';
        document.getElementById('editTaskDueDateInput').type = 'date'; // Change to date picker
        document.getElementById('editTaskRecurrenceSelect').value = task.recurrence || 'none';
        document.getElementById('editTaskNotesInput').value = task.notes || '';

        const categorySelect = document.getElementById('editTaskCategorySelect');
        categorySelect.innerHTML = ''; 
        taskCategories.forEach(cat => {
            const option = document.createElement('option');
            option.value = cat;
            option.textContent = cat.charAt(0).toUpperCase() + cat.slice(1);
            categorySelect.appendChild(option);
        });
        categorySelect.value = task.category || 'general';
        openModal('editTaskModal');
    }
    function saveEditedTask() {
        const taskId = parseInt(document.getElementById('editingTaskId').value);
        const task = tasks.find(t => t.id === taskId);
        if (!task) { showToast("Error: Could not save, task not found.", "error", 2000, true); return; }

        const newTitle = document.getElementById('editTaskTitleInput').value.trim();
        if (!newTitle) { showToast("Task title cannot be empty.", "error", 2000, true); return; }

        task.title = newTitle;
        task.time = document.getElementById('editTaskTimeInput').value.trim();
        task.category = document.getElementById('editTaskCategorySelect').value;
        task.dueDate = document.getElementById('editTaskDueDateInput').value.trim();
        task.recurrence = document.getElementById('editTaskRecurrenceSelect').value;
        task.notes = document.getElementById('editTaskNotesInput').value.trim();
        
        // Re-parse AI details if title changed significantly
        if (task.title !== newTitle && !task.aiParsedDetails) { // Simple re-parse if title changes and no prior AI details
            const lowerTitle = newTitle.toLowerCase();
            task.aiParsedDetails = {};
            const timeMatch = newTitle.match(/at\s+(\d{1,2}(:\d{2})?\s*(am|pm)?)/i);
            if (timeMatch && timeMatch[1]) task.aiParsedDetails.time = timeMatch[1].trim().toUpperCase();
             const dateMatch = newTitle.match(/on\s+(monday|tuesday|wednesday|thursday|friday|saturday|sunday|today|tomorrow|\d{1,2}[\/-]\d{1,2}(?:[\/-]\d{2,4})?)/i);
            if(dateMatch && dateMatch[1]) task.aiParsedDetails.date = dateMatch[1].trim();
        }

        renderTasks();
        closeModal('editTaskModal');
        showToast("Task updated successfully!", "success", 1500);
    }
    function optimizeMyDay() { 
        tasks.sort((a, b) => {
            if (a.completed !== b.completed) return a.completed - b.completed;

            const aDate = a.dueDate ? new Date(a.dueDate) : new Date(8640000000000000);
            const bDate = b.dueDate ? new Date(b.dueDate) : new Date(8640000000000000);
            if (aDate.getTime() !== bDate.getTime()) return aDate - bDate;
            
            const categoryOrder = { "work": 1, "learning": 2, "health": 3, "errands": 4, "personal": 5, "general": 6 };
            return (categoryOrder[a.category] || 99) - (categoryOrder[b.category] || 99);
        });
        renderTasks();
        openGenericModal("AI Day Optimization", `<p>${userName}, I've reordered your tasks based on priority (due dates, work tasks first, etc.).</p><p><em>This is a simplified optimization. A more advanced AI could consider task dependencies, estimated durations, and your energy levels.</em></p>`);
    }
    function getAIDayBrief() {
        let brief = ""; 
        const incompleteTasks = tasks.filter(t => !t.completed);
        if (incompleteTasks.length > 0) {
            brief += `<p>You have ${incompleteTasks.length} task${incompleteTasks.length > 1 ? 's' : ''} remaining, ${userName}. `;
            const keyTasks = incompleteTasks.filter(t => t.category === 'work' || t.dueDate === new Date().toISOString().split('T')[0]).slice(0,2);
            if (keyTasks.length > 0) {
                 brief += `Key tasks include: ${keyTasks.map(t => `<em>${t.title.substring(0,25)}...</em>`).join(', ')}.</p>`;
            } else {
                 brief += `Top tasks: ${incompleteTasks.slice(0,2).map(t => `<em>${t.title.substring(0,25)}...</em>`).join(', ')}.</p>`;
            }
            if (incompleteTasks.length > 3 && aiLearningPreferences.learnTaskPatterns) {
                 brief += `<p>AI Tip: Looks like a busy day! Try to focus on one task at a time or use the Pomodoro technique.</p>`;
            }
        } else {
            brief += `<p>All tasks completed! Great job, ${userName}! 🎉</p>`;
            brief += "<p>AI Suggestion: How about planning something fun for tomorrow or exploring local deals?</p>";
        }
        const weatherTextEl = document.getElementById('currentWeather');
        const weatherText = weatherTextEl ? weatherTextEl.textContent : "not available";
        brief += `<p>Current weather is ${weatherText}.</p>`;
        
        const currentSafetyMsg = document.getElementById('safetyTickerText')?.textContent;
         if (currentSafetyMsg && (currentSafetyMsg.toLowerCase().includes("outage") || currentSafetyMsg.toLowerCase().includes("closure") || currentSafetyMsg.toLowerCase().includes("alert"))) {
            brief += `<p><strong>Important Alert:</strong> ${currentSafetyMsg}</p>`;
        }
        openGenericModal("AI Day Brief", brief);
    }

    function aiScheduleMyDay() {
        const today = new Date().toISOString().split('T')[0];
        const incompleteTasksToday = tasks.filter(t => !t.completed && (t.dueDate === today || t.dueDate === "Today" || !t.dueDate));
        if (incompleteTasksToday.length === 0) {
            showToast("No tasks for today to schedule!", "info");
            return;
        }

        let scheduleHtml = `<p>Here's a potential schedule for today, ${userName}:</p><ul>`;
        let currentTime = 9; // Start at 9 AM

        incompleteTasksToday.forEach(task => {
            let taskDuration = 1; // Default 1 hour
            if (task.category === 'work') taskDuration = 1.5;
            if (task.title.toLowerCase().includes('report')) taskDuration = 2;
            if (task.title.toLowerCase().includes('meeting')) taskDuration = 1;
            
            // Try to use existing time if specified and valid
            const timeMatch = task.time.match(/(\d{1,2})(:(\d{2}))?\s*(am|pm)?/i);
            let startHour = currentTime;
            if (timeMatch) {
                let parsedHour = parseInt(timeMatch[1]);
                if (timeMatch[4] && timeMatch[4].toLowerCase() === 'pm' && parsedHour < 12) parsedHour += 12;
                if (timeMatch[4] && timeMatch[4].toLowerCase() === 'am' && parsedHour === 12) parsedHour = 0; // Midnight
                if (parsedHour >= currentTime) startHour = parsedHour; // Use specified time if it's later
            }
            
            const endHour = startHour + taskDuration;
            scheduleHtml += `<li><strong>${startHour % 12 || 12}:00 ${startHour < 12 || startHour === 24 ? 'AM' : 'PM'} - ${endHour % 12 || 12}:00 ${endHour < 12 || endHour === 24 ? 'AM' : 'PM'}:</strong> ${task.title}</li>`;
            currentTime = Math.ceil(endHour); // Move to next whole hour after task
        });
        scheduleHtml += "</ul><p class='mt-2 card-subtitle'><em>This is a conceptual time-blocking suggestion. I can update your task times if you approve.</em></p>";
        
        const modalBody = `${scheduleHtml}<button class='button mt-3' style='width:100%' onclick="applyAISchedule('${JSON.stringify(incompleteTasksToday.map(t => t.id))}')">Looks Good, Apply to Tasks</button>`;
        openGenericModal("AI Proposed Schedule", modalBody);
    }
    
    window.applyAISchedule = function(taskIdsJson) {
        const taskIdsToUpdate = JSON.parse(taskIdsJson);
        let currentTime = 9;
        taskIdsToUpdate.forEach(id => {
            const task = tasks.find(t => t.id === id);
            if (task) {
                let taskDuration = 1;
                if (task.category === 'work') taskDuration = 1.5;
                // Use existing time parsing logic if needed or just block
                const startHour = currentTime;
                const endHour = startHour + taskDuration;
                task.time = `${startHour % 12 || 12}:00 ${startHour < 12 ? 'AM' : 'PM'} - ${endHour % 12 || 12}:00 ${endHour < 12 ? 'AM' : 'PM'}`;
                currentTime = Math.ceil(endHour);
            }
        });
        renderTasks();
        closeModal('genericModal');
        showToast('AI schedule applied to your tasks!', 'success');
        saveTasksToLocalStorage();
    }


    // --- Explore ---
    const placesListEl = document.getElementById('placesList');
    const mapPlaceholder = document.getElementById('mapPlaceholder');
    const mapOverlayText = document.getElementById('mapOverlayText');

    function renderPlaces(filter = 'all') { 
        if (!placesListEl) { console.error("placesListEl (for explore) not found"); return; }
        placesListEl.innerHTML = Array(4).fill(getSkeletonPlaceCard()).join(''); 
        placesListEl.setAttribute('aria-busy', 'true');
        placesListEl.className = 'grid-view';

        setTimeout(() => {
            placesListEl.innerHTML = '';
            placesListEl.className = 'grid-view';

            let itemsToRender = [];
            let itemType = 'place'; 

            const searchTerm = document.getElementById('exploreSearchInput')?.value.toLowerCase() || '';

            if (filter === 'deals') {
                itemsToRender = [...mockDeals];
                itemType = 'deal';
                if (searchTerm) {
                    itemsToRender = itemsToRender.filter(deal =>
                        deal.title.toLowerCase().includes(searchTerm) ||
                        deal.businessName.toLowerCase().includes(searchTerm) ||
                        deal.description.toLowerCase().includes(searchTerm) ||
                        deal.category.toLowerCase().includes(searchTerm)
                    );
                }
            } else { 
                itemType = 'place';
                let sourceArray;
                if (filter === 'ai_recommended') { 
                    sourceArray = [...mockPlaces.ai_recommended]; 
                     // More advanced AI pick logic (mock)
                    if (aiLearningPreferences.learnSavedPlaces && mockPlaces.all.some(p=>p.saved)) {
                        const savedPlaceType = mockPlaces.all.find(p=>p.saved)?.type;
                        if(savedPlaceType) sourceArray = sourceArray.filter(p => p.type === savedPlaceType || p.rating > 4.6);
                    }
                    if (loggedMoods.some(m => m.mood === '🤩' || m.mood === '😄') && aiLearningPreferences.learnMoodLogs) { // If happy, suggest fun events/places
                        sourceArray.push(...mockPlaces.events.filter(e => !sourceArray.find(s => s.id === e.id && s.type === e.type)));
                        sourceArray.push(...mockPlaces.all.filter(p => p.tags.includes("fun") && !sourceArray.find(s => s.id === p.id && s.type === p.type)));
                    }


                } else if (filter === 'all') {
                    sourceArray = [...mockPlaces.all]; 
                } else if (mockPlaces[filter] && Array.isArray(mockPlaces[filter])) {
                    sourceArray = [...mockPlaces[filter]];
                } else { 
                    sourceArray = [...mockPlaces.all]; 
                }
                itemsToRender = [...sourceArray];

                if (searchTerm) {
                    itemsToRender = itemsToRender.filter(place =>
                        place.name.toLowerCase().includes(searchTerm) ||
                        place.details.toLowerCase().includes(searchTerm) ||
                        (place.sub && place.sub.toLowerCase().includes(searchTerm)) ||
                        (place.tags && place.tags.some(tag => tag.toLowerCase().includes(searchTerm)))
                    );
                }
            }


            if (itemsToRender.length === 0) {
                placesListEl.classList.remove('grid-view');
                let emptyMessage = `No ${filter === 'deals' ? 'deals' : 'places'} found`;
                if(filter === 'ai_recommended') emptyMessage = `AI couldn't find specific recommendations for "${searchTerm || 'your profile'}" right now, ${userName}.`;
                placesListEl.innerHTML = `<div class="empty-state"><i class="fas fa-map-signs"></i><p>${emptyMessage}</p><p class="card-subtitle mt-1" style="font-size:0.8rem;">Try a broader search or different filters.</p></div>`;
            } else {
                itemsToRender.forEach(item => {
                    const article = document.createElement('article');
                    article.className = 'card'; 
                    article.setAttribute('role', 'button');
                    article.setAttribute('tabindex', '0');

                    if (itemType === 'deal') {
                        article.classList.add('deal-card');
                        article.onclick = () => showDealDetailModal(item);
                        article.onkeypress = (event) => { if(event.key === 'Enter' || event.key === ' ') showDealDetailModal(item); };

                        let expiryText = '';
                        if (item.expiryDate) {
                            const expiry = new Date(item.expiryDate);
                            const today = new Date();
                            today.setHours(0,0,0,0);
                            expiryText = expiry < today ? `<span class="expiry" style="color:var(--danger-color); font-weight:bold;">Expired</span>` : `<span class="expiry">Expires: ${expiry.toLocaleDateString()}</span>`;
                        }

                        article.innerHTML = `
                            <img src="${item.img}" alt="${item.title}">
                            <div class="deal-info">
                                <div class="name">${item.title}</div>
                                <div class="details">${item.description.substring(0, 70)}...</div>
                                <div class="business">${item.businessName}</div>
                                ${expiryText}
                            </div>
                        `;
                    } else { // It's a place
                        article.classList.add('place-card');
                        article.onclick = () => showPlaceDetail(item);
                        article.onkeypress = (event) => { if(event.key === 'Enter' || event.key === ' ') showPlaceDetail(item); };
                        
                        let tagsHtml = "";
                        if(item.tags && item.tags.length > 0) {
                            tagsHtml = `<div class="tags">${item.tags.slice(0,3).map(tag => `<span class="tag">#${tag}</span>`).join('')}</div>`;
                        }

                        
article.innerHTML = `
                            <img src="${item.img}" alt="${item.name}">
                            <div class="place-info">
                                <div class="name">${item.name}</div>
                                <div class="details">${item.details}</div>
                                <div class="details">${item.sub || ''}</div>
                                ${tagsHtml}
                            </div>
                            <button class="save-place-button ${item.saved ? 'saved' : ''}" onclick="event.stopPropagation(); toggleSavePlace(${item.id}, this)" aria-label="${item.saved ? 'Unsave' : 'Save'} ${item.name}" aria-pressed="${item.saved ? 'true' : 'false'}">
                                <i class="fas fa-bookmark"></i>
                            </button>
                        `;
                    }
                    placesListEl.appendChild(article);
                });
            }
            placesListEl.setAttribute('aria-busy', 'false');
        }, 600);
    }
    window.filterPlaces = function(filterType, buttonEl) { 
        document.querySelectorAll('#exploreFilterBar .filter-button').forEach(btn => {
            btn.classList.remove('active');
            btn.setAttribute('aria-selected', 'false');
        });
        if (buttonEl) {
            buttonEl.classList.add('active');
            buttonEl.setAttribute('aria-selected', 'true');
        } else { 
            const targetBtn = document.querySelector(`#exploreFilterBar .filter-button[data-filter="${filterType}"]`);
            if (targetBtn) {
                targetBtn.classList.add('active');
                targetBtn.setAttribute('aria-selected', 'true');
            }
        }
        renderPlaces(filterType);
        showAIExploreSuggestion(); 
    }
    function handleExploreSearch(instant = false) {
        clearTimeout(exploreSearchDebounceTimeout);
        exploreSearchDebounceTimeout = setTimeout(() => {
            const activeFilterButton = document.querySelector('#exploreFilterBar .filter-button.active');
            const currentFilter = activeFilterButton ? activeFilterButton.dataset.filter : 'all';
            renderPlaces(currentFilter);
            showAIExploreSuggestion();
            if(!instant) showToast('AI refined search results.', "ai_info", 1500);
        }, instant ? 0 : 400); 
    }
    function showPlaceDetail(place) { 
        if (!place) { showToast("Error: Place details not available.", "error", 2000, true); return; }
        document.getElementById('modalPlaceName').textContent = place.name;
        document.getElementById('modalPlaceImage').src = place.img;
        document.getElementById('modalPlaceImage').alt = place.name;
        document.getElementById('modalPlaceDetails').innerHTML = `<p>${place.details}</p><p>${place.sub}</p>`;
        
        const tagsContainer = document.getElementById('modalPlaceTags');
        if (tagsContainer) {
            if (place.tags && place.tags.length > 0) {
                tagsContainer.innerHTML = place.tags.map(tag => `<span class="tag">#${tag}</span>`).join('');
                tagsContainer.classList.remove('hidden');
            } else {
                tagsContainer.innerHTML = '';
                tagsContainer.classList.add('hidden');
            }
        }
        
        const aiSummaryEl = document.getElementById('aiPlaceReviewSummary');
        if(place.aiSummary && aiSummaryEl){
            // Mock a more detailed AI summary
            let enhancedSummary = place.aiSummary;
            if (place.rating > 4.5 && aiLearningPreferences.learnSavedPlaces) enhancedSummary += " Many consider this a top-tier local spot.";
            else if (place.rating < 3.5 && aiLearningPreferences.learnSavedPlaces) enhancedSummary += " Reviews suggest some mixed experiences here.";

            aiSummaryEl.innerHTML = `<i class="fas fa-brain"></i> <strong>AI Summary:</strong> ${enhancedSummary}`;
            aiSummaryEl.classList.remove('hidden');
        } else if (aiSummaryEl) {
            aiSummaryEl.classList.add('hidden');
        }


        const ratingStarsContainer = document.getElementById('placeRatingStars');
        ratingStarsContainer.dataset.placeId = place.id; 
        ratingStarsContainer.querySelectorAll('.fa-star').forEach(star => {
            star.classList.remove('selected');
            if (star.dataset.value <= (place.userRating || 0)) { 
                star.classList.add('selected');
            }
        });
        document.getElementById('placeReviewInput').value = place.userReview || "";


        openModal('placeDetailModal');
    }
    window.toggleSavePlace = function(placeId, buttonEl) {
        const mainPlace = mockPlaces.all.find(p => p.id === placeId);
        if (mainPlace) {
            mainPlace.saved = !mainPlace.saved;
            // Update in categorized arrays as well
            if (mockPlaces[mainPlace.type]) {
                const catPlace = mockPlaces[mainPlace.type].find(p => p.id === placeId);
                if (catPlace) catPlace.saved = mainPlace.saved;
            }
            if(mockPlaces.open_now){ 
                const openPlace = mockPlaces.open_now.find(p => p.id === placeId);
                if(openPlace) openPlace.saved = mainPlace.saved;
            }
            if(mockPlaces.ai_recommended){ 
                const aiRecPlace = mockPlaces.ai_recommended.find(p => p.id === placeId);
                if(aiRecPlace) aiRecPlace.saved = mainPlace.saved;
            }


            buttonEl.classList.toggle('saved', mainPlace.saved);
            buttonEl.setAttribute('aria-pressed', mainPlace.saved.toString());
            buttonEl.setAttribute('aria-label', `${mainPlace.saved ? 'Unsave' : 'Save'} ${mainPlace.name}`);
            showToast(mainPlace.saved ? `AI: ${mainPlace.name.substring(0,20)}... saved! I'll consider this for future suggestions, ${userName}.` : `${mainPlace.name.substring(0,20)}... unsaved.`, "ai_info", 2000);
            showAIExploreSuggestion(); 
            renderPinnedWidgets();
            savePlacesToLocalStorage();
        } else {
            showToast("Error: Could not save place.", "error", 2000, true);
        }
    }
    document.getElementById('exploreSearchInput')?.addEventListener('input', () => {
        handleExploreSearch();
        document.getElementById('clearExploreSearchInput')?.classList.toggle('hidden', document.getElementById('exploreSearchInput').value === '');
    });
    window.ratePlace = function(starElement) {
        const rating = starElement.dataset.value;
        const stars = starElement.parentElement.querySelectorAll('.fa-star');
        stars.forEach(s => {
            s.classList.toggle('selected', s.dataset.value <= rating);
        });
    }
    window.submitPlaceReview = function() {
        const placeId = document.getElementById('placeRatingStars').dataset.placeId;
        const reviewText = document.getElementById('placeReviewInput').value;
        const selectedRating = document.querySelectorAll('#placeRatingStars .fa-star.selected').length;
        
        const place = mockPlaces.all.find(p => p.id == placeId);
        if(place){
            place.userRating = selectedRating; 
            place.userReview = reviewText;
            if(reviewText.length > 10) place.aiSummary = `Recent review highlights: "${reviewText.substring(0,30)}..." (Rating: ${selectedRating}/5).`;
        }
        savePlacesToLocalStorage(); // Save updated review/rating info
        showToast(`Review for ${place ? place.name.substring(0,15) + "..." : "place"} submitted (mock AI processing). Rating: ${selectedRating} stars.`, "success", 2500);
    }


    function showAIExploreSuggestion() {
        const suggestionCard = document.getElementById('aiExploreSuggestion');
        const suggestionText = document.getElementById('aiExploreSuggestionText');
        const suggestionActionButton = document.getElementById('aiExploreSuggestionAction');
        if (!suggestionCard || !suggestionText || !suggestionActionButton) return;

        const activeFilter = document.querySelector('#exploreFilterBar .filter-button.active')?.dataset.filter || 'all';
        let suggestion = null;

        const weatherText = document.getElementById('currentWeather')?.textContent.toLowerCase();
        const isRaining = weatherText && weatherText.includes('rain');

        // AI Itinerary Suggestion
        if (isRaining && new Date().getHours() > 13) { // After 1pm and raining
            const bookStore = mockPlaces.all.find(p => p.tags.includes("bookstore"));
            const cafe = mockPlaces.all.find(p => p.tags.includes("cafe") && p.id !== bookStore?.id); // Find a different one
            if (bookStore && cafe) {
                suggestion = {
                    title: "A Perfect Rainy Afternoon",
                    text: `1. Visit '${bookStore.name}' to browse for an hour. 2. Then, warm up with a specialty coffee nearby at '${cafe.name}'.`,
                    buttonText: "View Itinerary",
                    action: () => openGenericModal("AI Itinerary: Rainy Afternoon", `<p>Here is your suggested plan:</p><ul><li><strong>Step 1:</strong> Visit <strong>${bookStore.name}</strong>.</li><li><strong>Step 2:</strong> Warm up at <strong>${cafe.name}</strong>.</li></ul><p class="mt-2 card-subtitle">I've checked and both are open now. I can add these to your planner if you'd like.</p>`)
                };
            }
        }
        
        // Fallback to simpler suggestions if no itinerary is generated
        if (!suggestion) {
            if ((activeFilter === 'food' || activeFilter === 'all' || activeFilter === 'ai_recommended') && aiLearningPreferences.learnSavedPlaces) {
                const savedCafes = mockPlaces.food.filter(p => p.saved && p.tags.includes('cafe'));
                const unSavedBakeries = mockPlaces.food.filter(p => !p.saved && p.tags.includes('bakery') && p.rating >= 4.0 );
                if (savedCafes.length > 0 && unSavedBakeries.length > 0) {
                    suggestion = {
                        title: "AI Suggestion",
                        text: `Since you liked "${savedCafes[0].name.substring(0,20)}...", you might enjoy the highly-rated "${unSavedBakeries[0].name.substring(0,20)}...".`,
                        buttonText: "Find It",
                        action: () => {
                            document.getElementById('exploreSearchInput').value = unSavedBakeries[0].name;
                            filterPlaces('food', document.querySelector('#exploreFilterBar button[data-filter="food"]'));
                            suggestionCard.classList.add('hidden');
                            showToast(`AI: Searching for "${unSavedBakeries[0].name}"`, "ai_info");
                        }
                    };
                }
            } else if (activeFilter === 'parks' && mockPlaces.all.some(p => p.tags && p.tags.includes('kids-friendly') && p.type === 'parks')) {
                const kidFriendlyPark = mockPlaces.all.find(p => p.tags.includes('kids-friendly') && p.type === 'parks');
                if (kidFriendlyPark) {
                    suggestion = {
                        title: "AI Suggestion",
                        text: `Planning a family outing? "${kidFriendlyPark.name.substring(0,20)}..." is great for kids!`,
                        buttonText: "View Details",
                        action: () => { showPlaceDetail(kidFriendlyPark); suggestionCard.classList.add('hidden'); }
                    };
                }
            }
        }
        
        if (suggestion) {
            suggestionCard.querySelector('.card-title').innerHTML = `<i class="fas fa-lightbulb"></i> ${suggestion.title}`;
            suggestionText.textContent = suggestion.text;
            suggestionActionButton.textContent = suggestion.buttonText;
            suggestionActionButton.onclick = suggestion.action;
            suggestionCard.classList.remove('hidden');
            suggestionCard.style.opacity = 1; suggestionCard.style.transform = 'translateY(0)';
        } else {
            suggestionCard.style.opacity = 0; suggestionCard.style.transform = 'translateY(10px)';
            setTimeout(() => suggestionCard.classList.add('hidden'), 300);
        }
    }
    // FIX: Expanded submit tip modal logic
    function openSubmitTipModal() {
        document.getElementById('submitTipForm').reset();
        openModal('submitTipModal');
    }
    function submitCommunityTip() {
        const title = document.getElementById('tipTitleInput').value.trim();
        const description = document.getElementById('tipDescriptionInput').value.trim();
        const subDetails = document.getElementById('tipSubDetailsInput').value.trim();
        const category = document.getElementById('tipCategorySelect').value;
        const tags = document.getElementById('tipTagsInput').value.split(',').map(t => t.trim()).filter(Boolean);
        const img = document.getElementById('tipImageURLInput').value.trim() || `https://via.placeholder.com/60x60.png?text=${encodeURIComponent(title.substring(0,10) || 'Tip')}`;

        if (!title || !description) {
            showToast("Please fill in both title and description.", "error", 2000, true);
            return;
        }
        
        const newPlace = {
            id: mockPlaces.all.length + 100, // Use a high ID to avoid conflicts
            name: title,
            details: description,
            sub: subDetails,
            type: category,
            img: img,
            saved: false,
            openNow: subDetails.toLowerCase().includes("open"),
            rating: 0,
            aiSummary: "A new community submission. Awaiting more reviews.",
            tags: tags,
            isCommunityTip: true
        };
        
        mockPlaces.all.push(newPlace);
        if(!mockPlaces[category]) mockPlaces[category] = [];
        mockPlaces[category].push(newPlace);
        
        console.log("Community Tip Submitted & Added as a Place:", newPlace);
        closeModal('submitTipModal');
        showToast("Community tip submitted! AI will verify & it will appear in Explore.", "success", 2500);
        renderPlaces(category); // Re-render the category it was added to
    }
    function openAILayersModal() {
        openModal('aiLayersModal');
    }
    function applyAILayer(layerType) {
        let overlayHTML = '';
        let toastText = '';
        closeModal('aiLayersModal');

        switch (layerType) {
            case 'quiet':
                overlayHTML = `<h3><i class="fas fa-moon"></i> Quiet Zone Overlay</h3><p>Map now highlights libraries, quiet parks, and calm cafes.</p>`;
                toastText = 'AI Layer: Quiet Zone applied.';
                break;
            case 'vibrant':
                overlayHTML = `<h3><i class="fas fa-bolt"></i> Vibrant Zone Overlay</h3><p>Map now highlights live music venues, popular bars, and event spaces.</p>`;
                toastText = 'AI Layer: Vibrant Zone applied.';
                break;
            case 'family':
                overlayHTML = `<h3><i class="fas fa-child"></i> Family Fun Overlay</h3><p>Map now highlights playgrounds, kid-friendly restaurants, and attractions.</p>`;
                toastText = 'AI Layer: Family Fun applied.';
                break;
            case 'heatmap':
                 overlayHTML = `<h3><i class="fas fa-fire"></i> Popularity Heatmap</h3><p>Map now shows areas trending in popularity based on community check-ins.</p>`;
                toastText = 'AI Layer: Popularity Heatmap applied.';
                break;
            case 'reset':
                mapOverlayText.innerHTML = '';
                mapOverlayText.classList.add('hidden');
                toastText = 'Map layer reset to default.';
                showToast(toastText, "info");
                return;
        }

        if (mapOverlayText) {
            mapOverlayText.innerHTML = overlayHTML;
            mapOverlayText.classList.remove('hidden');
        }
        showToast(toastText, "ai_info");
    }


    // --- Chat ---
    const communityChannelListEl = document.getElementById('communityChannelList');
    const typingIndicatorArea = document.getElementById('typingIndicatorArea');
    const mockUserSuggestionPopup = document.getElementById('mockUserSuggestionPopup');
    let typingTimeout;
    let lastMessageDate = null; // For date separators

    function formatChannelTimestamp(timestamp) {
        if (!timestamp) return '';
        const messageDate = new Date(timestamp);
        const today = new Date();
        const yesterday = new Date(today);
        yesterday.setDate(today.getDate() - 1);

        if (messageDate.toDateString() === today.toDateString()) {
            return messageDate.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
        } else if (messageDate.toDateString() === yesterday.toDateString()) {
            return 'Yesterday';
        } else if (today.getFullYear() === messageDate.getFullYear()) {
            return messageDate.toLocaleDateString([], { month: 'short', day: 'numeric' });
        } else {
            return messageDate.toLocaleDateString([], { year:'2-digit', month: 'numeric', day: 'numeric' });
        }
    }

    // NEW: Function to toggle between Channels and DMs
    function toggleChannelListType(type, buttonEl) {
        document.querySelectorAll('.channel-list-toggle button').forEach(btn => btn.classList.remove('active'));
        if (buttonEl) buttonEl.classList.add('active');
        renderChannels(type);
    }
    
    function findOrCreateDMChannel(otherUserId) {
        const otherUser = mockUsers[otherUserId];
        if (!otherUser) return null;
    
        // Construct a consistent ID for the DM channel
        const dmId = ['user', otherUserId].sort().join('-');
        
        let dmChannel = mockChannels.find(c => c.dmId === dmId);
    
        if (!dmChannel) {
            // Create a new DM channel if it doesn't exist
            dmChannel = {
                id: nextChannelId++,
                dmId: dmId, // Special ID for DMs
                name: otherUser.name,
                icon: 'fas fa-user-secret',
                color: otherUser.color || 'var(--primary-accent)',
                type: 'direct_message',
                participantIds: ['user', otherUserId],
                lastMessage: "No messages yet.",
                lastMessageTimestamp: new Date(),
                unreadCount: 0,
                isJoined: true, // DMs are always "joined"
                isFavorite: false,
                messages: [{
                    mid: nextMessageId++,
                    senderId: 'defaultBot',
                    text: `This is the beginning of your direct message history with ${otherUser.name}.`,
                    timestamp: new Date()
                }]
            };
            
            // Add initial message if a notification triggered this
            const triggeringNotification = mockNotifications.find(n => n.type === 'dm' && n.text.includes(otherUser.name));
            if(triggeringNotification) {
                 dmChannel.messages.push({
                    mid: nextMessageId++,
                    senderId: otherUserId,
                    text: triggeringNotification.text,
                    timestamp: new Date(triggeringNotification.timestamp)
                });
                dmChannel.lastMessage = triggeringNotification.text;
                dmChannel.lastMessageTimestamp = new Date(triggeringNotification.timestamp);
            }
            mockChannels.push(dmChannel);
            saveChannelsToLocalStorage();
        }
        return dmChannel;
    }

    function renderChannels(type = 'channels') {
        if (!communityChannelListEl) { console.error("communityChannelListEl not found"); return; }
        
        communityChannelListEl.innerHTML = Array(3).fill(getSkeletonChannelItem()).join('');
        communityChannelListEl.setAttribute('aria-busy', 'true');

        setTimeout(() => {
            communityChannelListEl.innerHTML = '';
            
            let channelsToRender;
            if(type === 'dms') {
                channelsToRender = mockChannels.filter(c => c.type === 'direct_message');
            } else {
                channelsToRender = mockChannels.filter(c => c.type !== 'direct_message');
            }

            if (channelsToRender.length === 0) {
                const emptyStateHTML = `<div class="empty-state" style="padding: 20px 0; background-color: var(--card-bg);"><i class="fas fa-${type === 'dms' ? 'paper-plane' : 'comments'}"></i><p>No ${type} yet.</p></div>`;
                communityChannelListEl.innerHTML = emptyStateHTML;
            } else {
                channelsToRender.sort((a,b) => (b.isFavorite - a.isFavorite) || (b.unreadCount || 0) - (a.unreadCount || 0) || (new Date(b.lastMessageTimestamp) - new Date(a.lastMessageTimestamp)) );
                channelsToRender.forEach(channel => {
                    const channelEl = document.createElement('button');
                    channelEl.className = 'channel-item';
                    channelEl.setAttribute('aria-label', `Open ${channel.name} channel. ${channel.unreadCount > 0 ? channel.unreadCount + ' unread messages.' : ''} ${channel.isFavorite ? 'Favorite channel.' : ''}`);
                    channelEl.onclick = () => showSpecificChatView(channel.id);
                    
                    let favoriteIconClass = channel.isFavorite ? 'fas fa-star favorited' : 'far fa-star';
                    const formattedTimestamp = formatChannelTimestamp(channel.lastMessageTimestamp);

                    // Determine avatar for DMs
                    let avatarHtml;
                    if (channel.type === 'direct_message') {
                        const otherUserId = channel.participantIds.find(id => id !== 'user');
                        const otherUser = mockUsers[otherUserId];
                        avatarHtml = `<img src="${otherUser.avatarUrl}" alt="${otherUser.name}" class="channel-icon" style="width:48px; height:48px; object-fit: cover;" />`;
                    } else {
                        avatarHtml = `<div class="channel-icon" style="background-color: ${channel.color};"><i class="${channel.icon}" aria-hidden="true"></i></div>`;
                    }

                    channelEl.innerHTML = `
                        ${avatarHtml}
                        <div class="channel-info-wrapper">
                             <div class="channel-info">
                                <div class="name">${channel.name}</div>
                                <div class="last-message">${channel.lastMessage || 'No messages yet.'}</div>
                            </div>
                            <div class="channel-actions-container">
                                <span class="last-message-timestamp">${formattedTimestamp}</span>
                                ${channel.unreadCount > 0 ? `<span class="unread-badge">${channel.unreadCount}</span>` : `<i class="channel-favorite-icon ${favoriteIconClass}" onclick="event.stopPropagation(); toggleFavoriteChannel(${channel.id}, false, this);" aria-label="${channel.isFavorite ? 'Unfavorite' : 'Favorite'} channel ${channel.name}"></i>`}
                            </div>
                        </div>
                    `;
                    communityChannelListEl.appendChild(channelEl);
                });
            }
            communityChannelListEl.setAttribute('aria-busy', 'false');
            renderPinnedWidgets();
        }, 500);
    }
    function updateChannelDescPlaceholder(channelType) {
        const descInput = document.getElementById('newChannelDesc');
        if (descInput) {
            if (channelType === 'skill_swap') {
                descInput.placeholder = "e.g., Offering: Web design help. Seeking: Guitar lessons. Clearly state if you're offering or seeking a skill.";
            } else if (channelType === 'hobby') {
                descInput.placeholder = "e.g., For local photography enthusiasts to share tips and organize meetups.";
            } else if (channelType === 'announcements') {
                descInput.placeholder = "e.g., Important updates for the Oakwood neighborhood association.";
            } else if (channelType === 'local_events') {
                descInput.placeholder = "e.g., Discussing the upcoming Summer Fest, planning carpools, sharing photos afterwards.";
            }
             else {
                descInput.placeholder = "e.g., Share gardening tips, or discuss local news.";
            }
        }
    }
    function openCreateChannelModal(nameFromAI = "", typeFromAI = "general", descFromAI = "") {
        document.getElementById('newChannelName').value = nameFromAI;
        document.getElementById('newChannelDesc').value = descFromAI;
        const channelTypeSelect = document.getElementById('newChannelType');
        if(channelTypeSelect) channelTypeSelect.value = typeFromAI;
        updateChannelDescPlaceholder(typeFromAI);
        populateIconSelector('newChannelIconSelector');
        openModal('createChannelModal');
    }
    function submitNewChannel(isAIInitiated = false) {
        const nameInput = document.getElementById('newChannelName');
        const descInput = document.getElementById('newChannelDesc');
        const typeInput = document.getElementById('newChannelType');
        const name = nameInput.value.trim();
        const desc = descInput.value.trim();
        const type = typeInput.value;
        const selectedIconEl = document.querySelector('#newChannelIconSelector .icon-option.selected');
        
        if (!name) { 
            if(!isAIInitiated) showToast("Channel name is required.", "error", 2000, true); nameInput.focus(); 
            return false; 
        }
        if (!selectedIconEl) { 
            if(!isAIInitiated) showToast("Please select an icon.", "error", 2000, true); 
            return false; 
        }

        let firstMessageText = `Welcome to ${name}! ${desc ? 'About: ' + desc : ''}`;
        if (type === 'skill_swap') {
            firstMessageText = `This is a Skill Swap channel! Please start your posts with "OFFERING:" or "SEEKING:" to make it clear. Example: "OFFERING: Basic plumbing help." or "SEEKING: Someone to teach Spanish." AI can help match users! (Conceptual)`;
        }
        const now = new Date();
        const newChannel = {
            id: nextChannelId++, name: name, description: desc, icon: selectedIconEl.dataset.icon, type: type,
            color: availableColors[Math.floor(Math.random() * availableColors.length)], 
            lastMessage: "Channel created! Start the conversation.", lastMessageTimestamp: now,
            unreadCount: 0, 
            isJoined: true, isFavorite: false, 
            messages: [{ mid: nextMessageId++, senderId: 'defaultBot', text: firstMessageText, timestamp: now, reactions: {} }]
        };
        mockChannels.unshift(newChannel); 
        renderChannels();
        if(!isAIInitiated) closeModal('createChannelModal');
        showToast(`AI: Channel "${name}" created and joined!`, "ai_info", 2000);
        triggerFabSuggestion();
        saveChannelsToLocalStorage();
        return true;
    }
    const channelListView = document.getElementById('channelListView');
    const specificChatView = document.getElementById('specificChatView');
    const specificChatTitle = document.getElementById('specificChatTitle');
    const specificChatMessagesArea = document.getElementById('specificChatMessagesArea');
    const specificChatInput = document.getElementById('specificChatInput');
    const aiChatSummaryButtonContainer = document.getElementById('aiChatSummaryButtonContainer');
    const specificChatAvatar = document.getElementById('specificChatAvatar');
    const specificChatStatus = document.getElementById('specificChatStatus');

    let currentChatChannelId = null;
    
    function showSpecificChatView(channelId) { 
        const channel = mockChannels.find(c => c.id === channelId);
        if (!channel) { showToast("Error: Channel not found.", "error", 2000, true); return; }

        currentChatChannelId = channelId;
        lastMessageDate = null; // Reset for new chat view
        appContainer.classList.add('full-page-active'); 
        if (specificChatTitle) specificChatTitle.textContent = channel.name;
        
        // Update header based on channel type (DM or group)
        if (specificChatAvatar) {
            if(channel.type === 'direct_message') {
                const otherUserId = channel.participantIds.find(id => id !== 'user');
                const otherUser = mockUsers[otherUserId];
                specificChatAvatar.src = otherUser.avatarUrl;
                specificChatAvatar.alt = otherUser.name;
                specificChatStatus.textContent = otherUser.location || "Online"; // Use location as status
            } else { // Group Channel
                 const tempAvatarText = channel.name.split(' ').map(w => w[0]).join('').substring(0,2);
                 specificChatAvatar.src = `https://via.placeholder.com/40/${channel.color.replace('#','')}/FFFFFF?text=${tempAvatarText}`;
                 specificChatAvatar.alt = channel.name;
                 const members = new Set(channel.messages?.map(m => m.senderId) || []);
                 specificChatStatus.textContent = `${members.size} member${members.size !== 1 ? 's' : ''}, ${Math.floor(Math.random() * (members.size -1))} online`; // Mock online count
            }
        }

        if (specificChatMessagesArea) specificChatMessagesArea.innerHTML = ''; 
        
        if (channel.unreadCount > 5 && aiChatSummaryButtonContainer) {
            aiChatSummaryButtonContainer.innerHTML = `<button class="button button-secondary" onclick="summarizeChannel(${channel.id})"><i class="fas fa-brain"></i> AI: Summarize What I Missed</button>`;
            aiChatSummaryButtonContainer.classList.remove('hidden');
        } else if (aiChatSummaryButtonContainer) {
            aiChatSummaryButtonContainer.classList.add('hidden');
        }

        (channel.messages || []).forEach((msg) => addMessageToSpecificChatDOM(msg, true));
        if (specificChatMessagesArea) specificChatMessagesArea.scrollTop = specificChatMessagesArea.scrollHeight; // Scroll after all messages


        if (channelListView) channelListView.style.display = 'none';
        if (specificChatView) {
            specificChatView.classList.remove('hidden');
            specificChatView.classList.add('active'); 
        }
        if (specificChatInput) {
            specificChatInput.focus();
            autoGrowTextarea(specificChatInput);
        }

        if (channel.unreadCount > 0) {
            channel.unreadCount = 0; 
            renderChannels(channel.type === 'direct_message' ? 'dms' : 'channels');
            saveChannelsToLocalStorage();
        }
    }

    function summarizeChannel(channelId) {
        const channel = mockChannels.find(c => c.id === channelId);
        if (!channel || !channel.messages) return;

        const unreadMessages = channel.messages.slice(-channel.unreadCount); // This is a mock, in reality we'd track last read timestamp
        let summaryText = `Summary of the last ${unreadMessages.length} messages: `;
        
        let topics = new Set();
        let questions = 0;

        unreadMessages.forEach(msg => {
            if (msg.text.includes('?')) questions++;
            if (msg.senderId !== 'user') topics.add(`@${(mockUsers[msg.senderId] || mockUsers.defaultBot).name} talked about something.`);
        });
        
        const mainTopic = channel.messages.slice(-1)[0].text.substring(0, 30) + '...';
        summaryText += `Main conversation is about "${mainTopic}". `;
        if(questions > 0) summaryText += `${questions} question${questions > 1 ? 's were' : ' was'} asked.`;

        showToast(summaryText, 'ai_info', 5000);
        aiChatSummaryButtonContainer.classList.add('hidden'); // Hide after clicking
    }

    function showChannelListView(silent = false) { 
        appContainer.classList.remove('full-page-active');
        if (channelListView) channelListView.style.display = 'block';
        if (specificChatView) {
            specificChatView.classList.add('hidden');
            specificChatView.classList.remove('active');
        }
        currentChatChannelId = null;
        if(!silent) renderChannels(document.querySelector('.channel-list-toggle button.active')?.id === 'showDMsBtn' ? 'dms' : 'channels');
    }
    
    window.showChannelDetailModal = function() {
        if (!currentChatChannelId) return;
        const channel = mockChannels.find(c => c.id === currentChatChannelId);
        if (!channel) return;
        
        // If it's a DM, show the other user's profile instead
        if(channel.type === 'direct_message') {
            const otherUserId = channel.participantIds.find(id => id !== 'user');
            if(otherUserId) showOtherUserProfile(otherUserId);
            return;
        }

        document.getElementById('channelDetailModalTitle').textContent = channel.name;
        const iconEl = document.getElementById('channelDetailIcon');
        iconEl.innerHTML = `<i class="${channel.icon}"></i>`;
        iconEl.style.backgroundColor = channel.color;
        document.getElementById('channelDetailType').textContent = channelTypeLabels[channel.type] || "General";
        document.getElementById('channelDetailDescription').textContent = channel.description || "No description provided.";
        document.getElementById('channelDetailMemberCount').textContent = Math.floor(Math.random() * 50) + 5; // Mock members

        const joinButton = document.getElementById('channelDetailJoinButton');
        joinButton.textContent = channel.isJoined ? 'Leave Channel' : 'Join Channel';
        joinButton.onclick = () => toggleJoinChannel(channel.id, true);

        const favButton = document.getElementById('channelDetailFavoriteButton');
        favButton.innerHTML = channel.isFavorite ? `<i class="fas fa-star"></i> Favorited` : `<i class="far fa-star"></i> Add to Favorites`;
        favButton.onclick = () => toggleFavoriteChannel(channel.id, true, favButton.querySelector('i')); // Pass icon for direct update

        openModal('channelDetailModal');
    }

    window.toggleJoinChannel = function(channelId, fromModal = false) {
        const channel = mockChannels.find(c => c.id === channelId);
        if (channel) {
            channel.isJoined = !channel.isJoined;
            showToast(channel.isJoined ? `Joined "${channel.name}"!` : `Left "${channel.name}".`, 'success');
            renderChannels();
            saveChannelsToLocalStorage();
            if (fromModal && currentOpenModalId === 'channelDetailModal') { 
                document.getElementById('channelDetailJoinButton').textContent = channel.isJoined ? 'Leave Channel' : 'Join Channel';
            }
        }
    }

    window.toggleFavoriteChannel = function(channelId, fromModalOrIcon = false, iconElement = null) {
        const channel = mockChannels.find(c => c.id === channelId);
        if (channel) {
            channel.isFavorite = !channel.isFavorite;
            showToast(channel.isFavorite ? `"${channel.name}" added to favorites!` : `"${channel.name}" removed from favorites.`, 'success');
            
            if (fromModalOrIcon && currentOpenModalId === 'channelDetailModal') { 
                const modalFavButtonIcon = document.querySelector('#channelDetailFavoriteButton i');
                if(modalFavButtonIcon) {
                    modalFavButtonIcon.className = channel.isFavorite ? 'fas fa-star' : 'far fa-star';
                    document.getElementById('channelDetailFavoriteButton').innerHTML = channel.isFavorite ? `<i class="fas fa-star"></i> Favorited` : `<i class="far fa-star"></i> Add to Favorites`;
                }
            }
            renderChannels(channel.type === 'direct_message' ? 'dms' : 'channels');
            saveChannelsToLocalStorage();
        }
    }

    // Chat Message DOM creation with Date Separators
    function addMessageToSpecificChatDOM(message, isHistory = false) {
        if (!specificChatMessagesArea) return;

        const messageDate = new Date(message.timestamp);
        if (!lastMessageDate || messageDate.toDateString() !== lastMessageDate.toDateString()) {
            const dateSeparator = document.createElement('div');
            dateSeparator.className = 'chat-date-separator';
            if (messageDate.toDateString() === new Date().toDateString()) {
                dateSeparator.textContent = 'Today';
            } else if (messageDate.toDateString() === new Date(Date.now() - 86400000).toDateString()) {
                dateSeparator.textContent = 'Yesterday';
            } else {
                dateSeparator.textContent = messageDate.toLocaleDateString([], { weekday: 'long', month: 'long', day: 'numeric' });
            }
            specificChatMessagesArea.appendChild(dateSeparator);
        }
        lastMessageDate = messageDate;

        const senderIsUser = message.senderId === 'user';
        const senderDetails = mockUsers[message.senderId] || mockUsers.defaultBot; 

        const messageWrapper = document.createElement('div');
        messageWrapper.classList.add('chat-message-wrapper', senderIsUser ? 'user' : 'other');
        messageWrapper.dataset.messageId = message.mid;

        const avatarImg = document.createElement('img');
        if (!senderIsUser) { // Only show avatar for 'other'
            avatarImg.src = senderDetails.avatarUrl;
            avatarImg.alt = senderDetails.name;
            avatarImg.classList.add('chat-avatar', 'other-avatar');
            avatarImg.onclick = () => showOtherUserProfile(message.senderId);
        }

        const bubble = document.createElement('div');
        bubble.classList.add('chat-bubble', senderIsUser ? 'user' : 'other');
        if (message.isAIIntervention && !senderIsUser) {
            bubble.classList.add('ai-intervention');
        }
        if (!isHistory) bubble.style.animation = 'bubbleIn 0.3s ease-out';
        
        const messageTime = messageDate.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
        
        let reactionsHtml = '<div class="message-reactions">';
        if(message.reactions && Object.keys(message.reactions).length > 0) {
            Object.entries(message.reactions).forEach(([emoji, data]) => {
                const reactedByUser = data.users.includes('user');
                reactionsHtml += `<button class="reaction-button ${reactedByUser ? 'reacted-by-user' : ''}" onclick="toggleReaction(${currentChatChannelId}, ${message.mid}, '${emoji}')" aria-label="React with ${emoji}">${emoji} ${data.count > 0 ? data.count : ''}</button>`;
            });
        }
        reactionsHtml += '</div>';

        let senderNameHtml = '';
        const currentChannel = mockChannels.find(c => c.id === currentChatChannelId);
        if (!senderIsUser && currentChannel?.type !== 'direct_message') {
            senderNameHtml = `<strong class="chat-sender-name" onclick="showOtherUserProfile('${message.senderId}')">${senderDetails.name}</strong>`;
        }
        
        // Message Meta: Timestamp and Ticks
        let messageMetaHtml = `<span class="message-meta"><span class="timestamp">${messageTime}</span>`;
        if(senderIsUser) { 
            const ticksIcon = message.readByRecipient_mock ? 'fa-check-double' : 'fa-check'; 
            const ticksColor = message.readByRecipient_mock ? 'var(--info-color)' : 'var(--chat-user-timestamp-color)';
            messageMetaHtml += `<span class="status-ticks" style="color: ${ticksColor};"><i class="fas ${ticksIcon}"></i></span>`;
        }
        messageMetaHtml += `</span>`;


        let messageActionsHtml = `
            <div class="chat-message-actions">
                <button onclick="replyToMessage(${currentChatChannelId}, ${message.mid})" aria-label="Reply"><i class="fas fa-reply"></i></button>`;
        if (senderIsUser) {
            messageActionsHtml += `<button onclick="editMessage(${currentChatChannelId}, ${message.mid})" aria-label="Edit"><i class="fas fa-pencil-alt"></i></button>
                                   <button onclick="deleteMessage(${currentChatChannelId}, ${message.mid})" aria-label="Delete"><i class="fas fa-trash-alt"></i></button>`;
        }
        messageActionsHtml += `</div>`;

        // Construct bubble content
        bubble.innerHTML = `
            ${messageActionsHtml}
            ${senderNameHtml}
            <div class="chat-bubble-content">
                <span class="chat-bubble-text">${message.text.replace(/\n/g, '<br>')}</span>
                ${messageMetaHtml}
            </div>
            ${reactionsHtml}
        `;
        
        if (senderIsUser) {
            messageWrapper.appendChild(bubble);
        } else {
            messageWrapper.appendChild(avatarImg); 
            messageWrapper.appendChild(bubble);
        }

        specificChatMessagesArea.appendChild(messageWrapper);
        if (!isHistory) specificChatMessagesArea.scrollTop = specificChatMessagesArea.scrollHeight;
    }
    window.replyToMessage = function(channelId, messageId) {
        const channel = mockChannels.find(c => c.id === channelId);
        if (channel && channel.messages) {
            const msg = channel.messages.find(m => m.mid === messageId);
            if (msg && specificChatInput) {
                const senderName = (mockUsers[msg.senderId] || mockUsers.defaultBot).name;
                specificChatInput.value = `> @${senderName}: ${msg.text.substring(0,30)}...\n\n` + specificChatInput.value;
                specificChatInput.focus();
                autoGrowTextarea(specificChatInput);
                showToast("Quoted message for reply.", "info");
            }
        }
    }
    window.editMessage = function(channelId, messageId) {
        const channel = mockChannels.find(c => c.id === channelId);
        if (channel && channel.messages) {
            const msgIndex = channel.messages.findIndex(m => m.mid === messageId);
            if (msgIndex !== -1 && channel.messages[msgIndex].senderId === 'user') {
                const newText = prompt("Edit your message:", channel.messages[msgIndex].text);
                if (newText !== null && newText.trim() !== "") {
                    channel.messages[msgIndex].text = newText.trim();
                    channel.messages[msgIndex].edited = true; // Mark as edited (conceptual)
                    channel.lastMessage = `You: ${newText.trim().substring(0,25)}... (edited)`;
                    channel.lastMessageTimestamp = new Date();
                    
                    lastMessageDate = null; // Force re-render of date separators
                    specificChatMessagesArea.innerHTML = ''; 
                    (channel.messages || []).forEach((m) => addMessageToSpecificChatDOM(m, true));
                    specificChatMessagesArea.scrollTop = specificChatMessagesArea.scrollHeight;
                    renderChannels(channel.type === 'direct_message' ? 'dms' : 'channels');
                    saveChannelsToLocalStorage();
                    showToast("Message edited.", "success");
                }
            }
        }
    }
    window.deleteMessage = function(channelId, messageId) {
        const channel = mockChannels.find(c => c.id === channelId);
        if (channel && channel.messages) {
             const msgIndex = channel.messages.findIndex(m => m.mid === messageId);
             if (msgIndex !== -1 && channel.messages[msgIndex].senderId === 'user') {
                openConfirmationModal(
                    "Delete Message?", 
                    "Are you sure you want to delete this message? This action cannot be undone.", 
                    () => {
                        channel.messages.splice(msgIndex, 1);
                        // Update last message if this was the last one
                        if (channel.messages.length > 0) {
                             const lastMsg = channel.messages[channel.messages.length -1];
                             const senderName = (mockUsers[lastMsg.senderId] || mockUsers.defaultBot).name;
                             channel.lastMessage = `${senderName}: ${lastMsg.text.substring(0,25)}...`;
                             channel.lastMessageTimestamp = new Date(lastMsg.timestamp);
                        } else {
                            channel.lastMessage = "No messages yet.";
                            channel.lastMessageTimestamp = new Date();
                        }
                        
                        lastMessageDate = null; // Force re-render of date separators
                        specificChatMessagesArea.innerHTML = ''; 
                        (channel.messages || []).forEach((m) => addMessageToSpecificChatDOM(m, true));
                        specificChatMessagesArea.scrollTop = specificChatMessagesArea.scrollHeight;
                        renderChannels(channel.type === 'direct_message' ? 'dms' : 'channels');
                        saveChannelsToLocalStorage();
                        showToast("Message deleted.", "success");
                    }
                );
            }
        }
    }


    window.showOtherUserProfile = function(userId) {
        const user = mockUsers[userId];
        if (!user) { showToast("User profile not found.", "error", 2000, true); return; }

        document.getElementById('otherUserAvatar').src = user.avatarUrl;
        document.getElementById('otherUserAvatar').alt = user.name;
        document.getElementById('otherUserProfileModalTitle').textContent = user.name;
        document.getElementById('otherUserUsername').textContent = user.username;
        document.getElementById('otherUserBio').textContent = user.bio || "No bio available.";
        document.getElementById('otherUserInterests').textContent = user.interests || "No interests listed.";
        
        // Find mutual channels (mock logic)
        const userChannels = mockChannels.filter(c => c.isJoined && c.type !== 'direct_message').map(c => c.id);
        const otherUserChannels = mockChannels.filter(c => Math.random() > 0.3).map(c => c.id); // Mock
        const mutualChannelIds = userChannels.filter(id => otherUserChannels.includes(id));
        const mutualChannels = mockChannels.filter(c => mutualChannelIds.includes(c.id));
        document.getElementById('otherUserMutualChannels').textContent = mutualChannels.length > 0 ? mutualChannels.map(c => c.name).join(', ') : "No mutual channels found.";
        
        const messageButton = document.getElementById('otherUserMessageButton');
        messageButton.onclick = () => {
            closeModal('otherUserProfileModal');
            startDirectMessage(userId);
        };

        openModal('otherUserProfileModal');
    }

    function startDirectMessage(otherUserId) {
        const dmChannel = findOrCreateDMChannel(otherUserId);
        if(dmChannel) {
            setActiveScreen('chat');
            setTimeout(() => {
                toggleChannelListType('dms');
                showSpecificChatView(dmChannel.id);
            }, 100);
        } else {
            showToast("Could not start a direct message.", "error");
        }
    }


    function toggleReaction(channelId, messageId, reactionEmoji) {
        const channel = mockChannels.find(c => c.id === channelId);
        if (channel && channel.messages) {
            const message = channel.messages.find(m => m.mid === messageId);
            if (message) {
                if (!message.reactions) message.reactions = {};
                if (!message.reactions[reactionEmoji]) message.reactions[reactionEmoji] = { count: 0, users: [] };

                const userIndex = message.reactions[reactionEmoji].users.indexOf('user');
                if (userIndex > -1) { // User already reacted, so un-react
                    message.reactions[reactionEmoji].count--;
                    message.reactions[reactionEmoji].users.splice(userIndex, 1);
                } else { // User has not reacted, so react
                    message.reactions[reactionEmoji].count++;
                    message.reactions[reactionEmoji].users.push('user');
                }
                if (message.reactions[reactionEmoji].count === 0) { // Clean up if no reactions left for this emoji
                    delete message.reactions[reactionEmoji];
                }
                
                // Re-render only the affected message bubble for efficiency
                const messageWrapper = specificChatMessagesArea.querySelector(`.chat-message-wrapper[data-message-id="${messageId}"]`);
                if (messageWrapper) {
                    const reactionContainer = messageWrapper.querySelector('.message-reactions');
                    let reactionsHtml = '';
                    if(message.reactions && Object.keys(message.reactions).length > 0) {
                        Object.entries(message.reactions).forEach(([emoji, data]) => {
                             const reactedByUser = data.users.includes('user');
                             reactionsHtml += `<button class="reaction-button ${reactedByUser ? 'reacted-by-user' : ''}" onclick="toggleReaction(${currentChatChannelId}, ${message.mid}, '${emoji}')" aria-label="React with ${emoji}">${emoji} ${data.count > 0 ? data.count : ''}</button>`;
                        });
                    }
                    reactionContainer.innerHTML = reactionsHtml;
                } else { // Fallback if specific bubble not found
                    lastMessageDate = null; 
                    specificChatMessagesArea.innerHTML = ''; 
                    (channel.messages || []).forEach((msg) => addMessageToSpecificChatDOM(msg, true));
                    specificChatMessagesArea.scrollTop = specificChatMessagesArea.scrollHeight;
                }
                saveChannelsToLocalStorage();
            }
        }
    }

    // NEW: Handle typing in chat input to change icons and visibility
    function handleChatInputTyping(textarea, type = 'specific') {
        const container = textarea.closest('.chat-input-container');
        const wrapper = container.querySelector('.chat-input-wrapper');
        const actionBtn = container.querySelector('.chat-input-action-button');
        const actionIcon = actionBtn.querySelector('i');
    
        const hasText = textarea.value.trim().length > 0;
    
        wrapper.classList.toggle('typing-active', hasText);
        
        if (hasText) {
            actionIcon.className = 'fas fa-paper-plane';
            actionBtn.setAttribute('aria-label', 'Send message');
            actionBtn.onclick = (type === 'specific') ? sendSpecificChatMessage : sendAIChatMessage;
        } else {
            actionIcon.className = 'fas fa-microphone';
            actionBtn.setAttribute('aria-label', 'Use voice input (mock)');
            actionBtn.onclick = (type === 'specific') ? mockChannelVoiceInput : mockAIVoiceInput;
        }
    
        if (type === 'specific') {
            handleSpecificChatInputForMentions(textarea);
        } else {
            updateAIChatTypingSuggestion(textarea.value);
        }
    }

    function sendSpecificChatMessage() { 
        if (!specificChatInput) return;
        const messageText = specificChatInput.value.trim();
        if (!messageText || !currentChatChannelId) {
             if (!messageText) mockChannelVoiceInput(); // Trigger voice if button is mic
             return;
        }
        
        const timestamp = new Date();
        const channel = mockChannels.find(c => c.id === currentChatChannelId);
        if (!channel) return;
        
        if (!channel.messages) channel.messages = [];
        const newMessage = { mid: nextMessageId++, senderId: 'user', text: messageText, timestamp, reactions: {}, readByRecipient_mock: false }; // Conceptual: message status
        channel.messages.push(newMessage);
        addMessageToSpecificChatDOM(newMessage);
        
        specificChatInput.value = '';
        autoGrowTextarea(specificChatInput);
        handleChatInputTyping(specificChatInput, 'specific'); // Reset icons
        if (mockUserSuggestionPopup) mockUserSuggestionPopup.classList.add('hidden');
        channel.lastMessage = `You: ${messageText.substring(0,25)}...`;
        channel.lastMessageTimestamp = timestamp;
        
        if (typingIndicatorArea) {
            let botName = mockUsers.defaultBot.name.split(' ')[0];
            if(channel.type === 'direct_message') {
                const otherUserId = channel.participantIds.find(id => id !== 'user');
                botName = mockUsers[otherUserId].name.split(' ')[0];
            }
            typingIndicatorArea.textContent = `${botName} is typing...`;
            typingIndicatorArea.classList.remove('hidden');
        }
        clearTimeout(typingTimeout);
        typingTimeout = setTimeout(() => {
            if (typingIndicatorArea) typingIndicatorArea.classList.add('hidden');
            let reply = "Got it! (mock reply)"; 
            let isAIIntervention = false;
            let aiReplySender = 'defaultBot'; 
            
            if(channel.type === 'direct_message') {
                aiReplySender = channel.participantIds.find(id => id !== 'user');
                const replies = ["Okay, I see.", "That's interesting.", "Thanks for letting me know.", "Haha, that's funny.", "What do you think?"];
                reply = replies[Math.floor(Math.random() * replies.length)];
            } else {
                // Group chat AI logic
                if (channel.type === 'skill_swap' && messageText.toLowerCase().startsWith("seeking:") && messageText.toLowerCase().includes("garden")) {
                    const gardeningChannel = mockChannels.find(c => c.name.toLowerCase().includes('gardeners'));
                    const gardener = gardeningChannel?.messages.find(m => m.text.toLowerCase().includes("offering:") || m.text.toLowerCase().includes("extra plants"));
                    if (gardener) {
                        reply = `AI Connector: I noticed you're seeking help with a garden. @${(mockUsers[gardener.senderId] || {}).name || 'BenS'} recently mentioned having extra tomato plants in the #Local-Gardeners channel. You might want to connect!`;
                        isAIIntervention = true;
                    }
                } else if (messageText.toLowerCase().includes("remember to") || messageText.toLowerCase().includes("i need to add task")) {
                    const taskMatch = messageText.match(/(remember to|i need to add task)\s+(.*)/i);
                    if (taskMatch && taskMatch[2]) {
                        reply = `AI: I can help with that, ${userName}! Would you like me to add "${taskMatch[2].substring(0,30)}..." as a task for you? (Conceptual)`;
                        isAIIntervention = true;
                    }
                } else if (messageText.toLowerCase().includes("help me draft a reply") && messageText.length > 20) {
                     reply = `AI: Okay, ${userName}. Based on the context, how about this reply: "That sounds interesting! Can you tell me more about [topic]?" (Conceptual)`;
                     isAIIntervention = true;
                }
            }
            
            // Mark user's message as read
            newMessage.readByRecipient_mock = true;
            const userMessageBubble = specificChatMessagesArea.querySelector(`.chat-message-wrapper[data-message-id="${newMessage.mid}"] .chat-bubble.user .status-ticks i`);
            if (userMessageBubble) {
                userMessageBubble.className = 'fas fa-check-double';
                userMessageBubble.parentElement.style.color = 'var(--info-color)'; // Read color
            }

            const replyTimestamp = new Date();
            const aiReplyMessage = { mid: nextMessageId++, senderId: aiReplySender, text: reply, timestamp: replyTimestamp, reactions: {}, isAIIntervention };
            channel.messages.push(aiReplyMessage);
            const replySenderName = mockUsers[aiReplySender]?.name || 'Bot';
            channel.lastMessage = `${replySenderName}: ${reply.substring(0,25)}...`;
            channel.lastMessageTimestamp = replyTimestamp;
            addMessageToSpecificChatDOM(aiReplyMessage);
            renderChannels(channel.type === 'direct_message' ? 'dms' : 'channels'); 
            saveChannelsToLocalStorage();
        }, 800 + Math.random() * 700);
    }
    if (specificChatInput) {
        specificChatInput.addEventListener('keypress', function (e) { if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); sendSpecificChatMessage(); }});
        specificChatInput.addEventListener('input', () => handleChatInputTyping(specificChatInput, 'specific'));
    }
    
    function handleSpecificChatInputForMentions(textarea) {
        const text = textarea.value;
        const cursorPos = textarea.selectionStart;
        const atMatch = text.substring(0, cursorPos).match(/@(\w*)$/);

        if (atMatch && mockUserSuggestionPopup) {
            const searchTerm = atMatch[1].toLowerCase();
            const suggestions = Object.values(mockUsers)
                .filter(u => u.id !== 'user' && u.name.toLowerCase().includes(searchTerm))
                .slice(0, 5);

            if (suggestions.length > 0) {
                mockUserSuggestionPopup.innerHTML = '';
                suggestions.forEach(user => {
                    const btn = document.createElement('button');
                    btn.textContent = user.name;
                    btn.onclick = () => {
                        const newText = text.substring(0, cursorPos - searchTerm.length -1) + `@${user.name} ` + text.substring(cursorPos);
                        textarea.value = newText;
                        textarea.focus();
                        textarea.setSelectionRange(cursorPos - searchTerm.length + user.name.length + 1, cursorPos - searchTerm.length + user.name.length +1);
                        mockUserSuggestionPopup.classList.add('hidden');
                        autoGrowTextarea(textarea);
                    };
                    mockUserSuggestionPopup.appendChild(btn);
                });
                mockUserSuggestionPopup.classList.remove('hidden');
            } else {
                mockUserSuggestionPopup.classList.add('hidden');
            }
        } else if (mockUserSuggestionPopup) {
            mockUserSuggestionPopup.classList.add('hidden');
        }
    }
    document.addEventListener('click', function(event) { // Hide mention popup on outside click
        if (mockUserSuggestionPopup && !mockUserSuggestionPopup.contains(event.target) && event.target !== specificChatInput) {
            mockUserSuggestionPopup.classList.add('hidden');
        }
    });

    function autoGrowTextarea(textarea) {
        textarea.style.height = 'auto'; // Reset height
        const scrollHeight = textarea.scrollHeight;
        if(scrollHeight > 0) { // Only set height if it's a positive number
             textarea.style.height = scrollHeight + 'px'; // Set to content height
        }
        if (textarea.value.trim().length > 0) {
            textarea.style.alignSelf = 'flex-end';
        } else {
            textarea.style.alignSelf = 'center';
        }
    }

    function mockCall(type) { showToast(`Starting ${type} call (mock feature)...`, 'ai_info'); }
    function mockChannelAttachFile() { showToast("Mock: Attach file dialog would open.", "info"); }
    function mockChannelShareImage() { showToast("Mock: Share image dialog would open.", "info"); }
    function mockChannelVoiceInput() { showToast("Mock: Voice input activated for channel chat.", "info"); }


    function aiSuggestChannelToJoin() {
        if (mockChannels.length > 2) {
            const potentialChannels = mockChannels.filter(ch => !ch.isJoined && ch.type !== 'announcements' && ch.id !== currentChatChannelId);
            if(potentialChannels.length > 0) {
                const randomChannel = potentialChannels[Math.floor(Math.random() * potentialChannels.length)];
                 openGenericModal("AI Channel Suggestion", `<p>Based on local activity and your (mock) interests, ${userName}, you might like the channel: <strong>${randomChannel.name}</strong>.</p><p><em>Description: ${randomChannel.description || 'General discussions.'}</em></p><button class="button mt-2" onclick="closeModal('genericModal'); toggleJoinChannel(${randomChannel.id}); showSpecificChatView(${randomChannel.id});">Join & View Channel</button>`);
            } else {
                 showToast("AI: You've already joined most relevant channels or there aren't many new ones yet!", "ai_info");
            }
        } else {
            showToast("AI: Not enough channels to make a suggestion yet. Explore existing ones!", "ai_info");
        }
    }

// --- AI Assistant ---
    window.toggleAIChat = function() { 
        if (!aiBottomSheet || !aiFab) return;
        const isActive = aiBottomSheet.classList.toggle('active');
        appContainer.classList.toggle('full-page-active', isActive);

        aiFab.classList.remove('has-suggestion'); 
        aiFab.setAttribute('aria-expanded', isActive.toString());
        aiBottomSheet.setAttribute('aria-hidden', (!isActive).toString());
        
        if(isActive && aiChatInputText) {
            const activeScreen = document.querySelector('.screen.active');
            let placeholder = "Ask or command...";
            let quickAction = "Plan my day";
            switch(activeScreen?.id) {
                case 'planner': placeholder = "e.g., Optimize my schedule..."; quickAction = "Optimize My Day"; break;
                case 'explore': placeholder = "e.g., Build an itinerary for tonight..."; quickAction = "Plan an evening"; break;
                case 'wellness': placeholder = "e.g., Review my wellness patterns..."; quickAction = "Wellness summary"; break;
            }
            aiChatInputText.placeholder = placeholder;
            const quickPlanButton = document.querySelector('.ai-quick-action-button[onclick*="Plan my day"]');
            if (quickPlanButton) quickPlanButton.textContent = quickAction;

            aiChatInputText.focus();
        }
        
        if (navigator.vibrate) navigator.vibrate(30); 
    }
    function addMessageToAIChat(sender, text, isHTML = false) { 
        if (!aiChatArea) return;
        const bubbleWrapper = document.createElement('div');
        bubbleWrapper.className = `chat-message-wrapper ${sender === 'user' ? 'user' : 'other'}`;

        const bubble = document.createElement('div');
        bubble.classList.add('chat-bubble', sender === 'user' ? 'user' : 'other');
        bubble.style.animation = 'bubbleIn 0.3s ease-out';
        
        const bubbleContent = document.createElement('div');
        bubbleContent.className = 'chat-bubble-content';

        const textSpan = document.createElement('span');
        textSpan.className = 'chat-bubble-text';
        if (isHTML) {
            textSpan.innerHTML = text; 
        } else {
            textSpan.textContent = text;
        }
        bubbleContent.appendChild(textSpan);
        bubble.appendChild(bubbleContent);
        
        bubbleWrapper.appendChild(bubble);
        aiChatArea.appendChild(bubbleWrapper);
        aiChatArea.scrollTop = aiChatArea.scrollHeight;
    }
    window.sendAIChatMessage = function() { 
        if (!aiChatInputText) return;
        const command = aiChatInputText.value.trim();
        if (!command) {
            mockAIVoiceInput();
            return;
        }

        if (aiConversationContext) { // Handle multi-turn response
            processAICommand(command, true);
        } else {
            processAICommand(command);
        }
        addMessageToAIChat('user', command);
        aiChatInputText.value = '';
        autoGrowTextarea(aiChatInputText);
        handleChatInputTyping(aiChatInputText, 'ai');
        if (aiChatTypingSuggestionEl) aiChatTypingSuggestionEl.textContent = '';
    }
    if (aiChatInputText) aiChatInputText.addEventListener('keypress', function (e) { if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); sendAIChatMessage(); }});
    
    window.updateAIChatTypingSuggestion = function(text) {
        if (!aiChatTypingSuggestionEl) return;
        text = text.toLowerCase();
        let suggestion = "";
        if (text.startsWith("add task")) suggestion = "e.g., add task Meeting with Sarah at Cafe Tomorrow at 2pm";
        else if (text.startsWith("find")) suggestion = "e.g., find parks with playgrounds OR find deals on pizza";
        else if (text.startsWith("plan my")) suggestion = "e.g., plan my day OR plan my weekend trip";
        else if (text.startsWith("set reminder")) suggestion = "e.g., set reminder to call mom in 1 hour";
        else if (text.startsWith("log mood")) suggestion = "e.g., log mood happy with note: Great day!";
        else if (text.startsWith("summarize channel")) suggestion = "e.g., summarize channel \"Local Foodies\"";
        else if (text.startsWith("suggest habit for")) suggestion = "e.g., suggest habit for stress relief";
        else if (text.startsWith("analyze my last journal")) suggestion = "e.g., analyze my last journal entry";
        aiChatTypingSuggestionEl.textContent = suggestion;
    }


    function clearAIChat() {
        if (aiChatArea) aiChatArea.innerHTML = '';
        aiConversationContext = null; aiExpectedResponseType = null;
        addMessageToAIChat('other', getAIPersonalityPrefix() + "Chat cleared. How can I help?");
        showToast("AI Chat cleared.", "info");
    }
    function getAIPersonalityPrefix() {
        let prefix = ""; 
        switch(currentAiPersonality) {
            case 'friendly': prefix = "Your friendly AI: "; break;
            case 'professional': prefix = "Assistant: "; break;
            case 'witty': prefix = "Your (slightly snarky) AI: "; break;
            case 'helpful': prefix = "Helpful Bot: "; break;
        }
        return prefix;
    }
    function triggerFabSuggestion(isContextual = true, newIconClass = 'fa-lightbulb') { 
        if (aiFab && aiFabIcon && !aiBottomSheet.classList.contains('active') && !appContainer.classList.contains('full-page-active')) { // Ensure FAB is visible
            aiFab.classList.add('has-suggestion');
            aiFabIcon.className = `fas ${newIconClass}`;
            clearTimeout(fabSuggestionTimeout);
            fabSuggestionTimeout = setTimeout(() => {
                aiFab.classList.remove('has-suggestion');
                updateContextualFabIcon(); // Revert to contextual icon, not just brain
            }, 3000);
            if (isContextual) {
                showToast("AI has a contextual suggestion! (Tap the icon)", "ai_info", 2500);
            }
        }
    }
    function mockAIAttachFile() { showToast("Mock: AI File attachment dialog would appear.", "ai_info"); }
    function mockAIVoiceInput() { showToast("Mock: AI Voice input activated. Say your command...", "ai_info"); }

    function processAICommand(originalCommand, isFollowUp = false) {
        const command = originalCommand.toLowerCase();
        let response = "I'm processing that. ";
        let aiPrefix = getAIPersonalityPrefix();
        let isHTMLResponse = false;
        let requiresFollowUpInResponse = false; // Different from the input `isFollowUp`

        let currentScreenId = document.querySelector('.screen.active')?.id;
        let contextMessage = "";
        if(currentScreenId === 'explore' && (command.includes("any of these") || command.includes("about this area"))){
            const currentFilter = document.querySelector('#exploreFilterBar .filter-button.active')?.dataset.filter || 'all';
            contextMessage = `(Context: Explore, filter: ${currentFilter}) `;
        } else if (currentScreenId === 'planner' && (command.includes("this task") || command.includes("my schedule"))){
             contextMessage = `(Context: Planner) `;
        } else if (currentScreenId === 'wellness' && (command.includes("my mood") || command.includes("my habits"))){
             contextMessage = `(Context: Wellness Hub) `;
        }

        if (isFollowUp && aiConversationContext) {
            // Handle multi-turn conversation logic
            if (aiConversationContext === "party_planning_date") {
                aiConversationContext = "party_planning_guests";
                aiExpectedResponseType = "number";
                response = `Great, party on ${originalCommand}! How many guests are you expecting, ${userName}?`;
                requiresFollowUpInResponse = true;
            } else if (aiConversationContext === "party_planning_guests") {
                aiConversationContext = "party_planning_venue";
                aiExpectedResponseType = "text";
                response = `${originalCommand} guests, noted! Will it be at home, or should I search for venues?`;
                requiresFollowUpInResponse = true;
            } else if (aiConversationContext === "party_planning_venue") {
                aiConversationContext = null; // End this thread
                aiExpectedResponseType = null;
                if (command.includes("search") || command.includes("venue")) {
                     setActiveScreen('explore');
                     setTimeout(() => {
                        const searchInput = document.getElementById('exploreSearchInput');
                        if (searchInput) searchInput.value = "party venue";
                        filterPlaces('services', document.querySelector('#exploreFilterBar button[data-filter="services"]'));
                        handleExploreSearch(true);
                    }, 100);
                    response = "Okay, searching for party venues in Explore. Let me know what else for the party!";
                } else {
                    response = "Sounds good. We can look into food and themes next for your party at home!";
                }
            } else if (aiConversationContext === "plan_route_place1") {
                const place1Name = originalCommand;
                const place1 = mockPlaces.all.find(p => p.name.toLowerCase().includes(place1Name.toLowerCase()));
                if (place1) {
                    aiConversationContext = { state: "plan_route_place2", place1: place1.name };
                    aiExpectedResponseType = "text";
                    response = `Okay, starting route from "${place1.name}". What's the destination?`;
                    requiresFollowUpInResponse = true;
                } else {
                    response = `I couldn't find a place called "${place1Name}". Please try again with a known place name.`;
                    aiConversationContext = "plan_route_place1"; // Re-prompt for place1
                    requiresFollowUpInResponse = true;
                }
            } else if (aiConversationContext && aiConversationContext.state === "plan_route_place2") {
                const place2Name = originalCommand;
                const place2 = mockPlaces.all.find(p => p.name.toLowerCase().includes(place2Name.toLowerCase()));
                if (place2) {
                    const fromPlaceName = aiConversationContext.place1; // Store before clearing context
                    aiConversationContext = null; aiExpectedResponseType = null;
                    response = `Planning route from "${fromPlaceName}" to "${place2.name}"... (Mock: This would open a map view with the route highlighted).`;
                    // Conceptually, navigate to map and show route
                    setActiveScreen('explore');
                    setTimeout(() => {
                         openGenericModal("Mock Route Planned", `<p>Route from: <strong>${fromPlaceName}</strong><br>To: <strong>${place2.name}</strong></p><p><em>In a real app, this would show an interactive map with directions. AI could suggest points of interest along the way.</em></p>`);
                    }, 200);
                } else {
                    response = `I couldn't find a place called "${place2Name}". What's the destination from "${aiConversationContext.place1}"?`;
                    requiresFollowUpInResponse = true; // Re-prompt for place2
                }
            } else {
                // Fallback if context is lost or not handled
                aiConversationContext = null; aiExpectedResponseType = null;
                response = "Sorry, I lost the thread of our conversation. Let's start over. How can I help?";
            }
            // Add response and reset context if not requiring further follow-up
            addMessageToAIChat('other', aiPrefix + response, isHTMLResponse);
            if (!requiresFollowUpInResponse) {
                aiConversationContext = null;
                aiExpectedResponseType = null;
            }
            return; // End processing for follow-up
        }


        // Standard command processing if not a follow-up
        aiConversationContext = null; aiExpectedResponseType = null; // Reset context for new commands


        setTimeout(() => {
            if (command.startsWith("add task ")) {
                const taskDetails = originalCommand.substring(9).trim(); 
                if(taskDetails) {
                    let taskTitle = taskDetails;
                    let taskTime, taskDate, parsedAIAgain = {};
                    
                    const timeMatch = taskDetails.match(/at\s+(\d{1,2}(:\d{2})?\s*(am|pm)?)/i);
                    if (timeMatch && timeMatch[1]) {
                        taskTime = timeMatch[1].trim().toUpperCase();
                        taskTitle = taskTitle.replace(timeMatch[0], '').trim(); 
                        parsedAIAgain.time = taskTime;
                    }
                    const dateMatch = taskDetails.match(/on\s+(monday|tuesday|wednesday|thursday|friday|saturday|sunday|today|tomorrow|\d{1,2}[\/-]\d{1,2}(?:[\/-]\d{2,4})?)/i);
                     if(dateMatch && dateMatch[1]) {
                        taskDate = dateMatch[1].trim();
                        taskTitle = taskTitle.replace(dateMatch[0], '').trim(); 
                        parsedAIAgain.date = taskDate;
                    }
                     const locationMatch = taskTitle.match(/(?:at|in|from)\s+([A-Z][a-zA-Z\s]+(?:Cafe|Park|Store|Cleaners|Market|Library|Office|Hub|Center|Plaza|Square))/);
                    if (locationMatch && locationMatch[1]) {
                        parsedAIAgain.location = locationMatch[1].trim();
                    }
                    const personMatch = taskTitle.match(/(?:with|for|call|meet)\s+([A-Z][a-z]+(?:\s+[A-Z][a-z]+)?)/);
                    if (personMatch && personMatch[1] && !taskCategories.includes(personMatch[1].toLowerCase())) {
                        parsedAIAgain.person = personMatch[1].trim();
                    }

                    if (addNewTask(taskTitle, null, taskTime, taskDate, parsedAIAgain)) response = `Okay, I've added "${taskTitle}" ${taskTime ? 'at '+taskTime : ''} ${taskDate ? 'on '+taskDate : ''} to your planner.`;
                    else response = "Hmm, I couldn't add that task. Maybe try again with just the title?";
                } else {
                    response = "What task would you like to add? Example: 'add task Call Mom at 2pm on Tuesday'";
                }
            } else if (command.startsWith("clear completed tasks")) {
                const completedCount = tasks.filter(t => t.completed).length;
                if (completedCount > 0) {
                    tasks = tasks.filter(t => !t.completed);
                    renderTasks();
                    response = `Alright, I've cleared ${completedCount} completed task${completedCount > 1 ? 's' : ''}.`;
                } else {
                    response = "No completed tasks to clear right now.";
                }
            } else if (command.includes("how am i doing on my new year's resolution")) {
                // Long-Term Memory feature
                const resolutionTaskKeyword = "read"; // Assume AI has learned this goal
                const completedBooks = tasks.filter(t => t.completed && t.title.toLowerCase().includes(resolutionTaskKeyword));
                isHTMLResponse = true;
                response = `I remember you wanted to '${resolutionTaskKeyword} more books' this year. Based on your completed tasks, you've finished <strong>${completedBooks.length} book${completedBooks.length !== 1 ? 's' : ''}</strong> so far. You're on track to meet your goal of 12 for the year! Would you like me to find new releases at 'The Book Nook'?`;
            } else if (command.includes("top 3 tasks") || command.includes("my top tasks")) {
                const topTasks = tasks.filter(t => !t.completed).slice(0, 3);
                if (topTasks.length > 0) {
                    isHTMLResponse = true;
                    response = `${contextMessage}Here are your top tasks, ${userName}:<ul>`;
                    topTasks.forEach(t => response += `<li>${t.title} (${t.time || 'anytime'}) ${t.dueDate ? '(Due: '+t.dueDate+')':''}</li>`);
                    response += "</ul>";
                } else {
                    response = `${contextMessage}Looks like you're all caught up on tasks!`;
                }
            } else if (command.includes("what's my next task") && currentScreenId === 'planner') {
                const nextTask = tasks.find(t => !t.completed);
                if (nextTask) response = `${contextMessage}Your next task is: "${nextTask.title}" at ${nextTask.time || 'anytime'}.`;
                else response = `${contextMessage}You have no upcoming tasks!`;
            } else if (command.includes("log") && command.includes("water") && currentScreenId === 'wellness') {
                const waterAmountMatch = command.match(/log\s+(\d+)\s+glass(es)?\s+of\s+water/i);
                const waterHabit = habits.find(h => h.isWaterTracker);
                if(waterAmountMatch && waterHabit){
                    const amount = parseInt(waterAmountMatch[1]);
                    incrementWater(waterHabit.id, amount);
                    response = `${contextMessage}Logged ${amount} glass(es) of water. Your total is now ${waterHabit.current}/${waterHabit.goal}.`;
                } else {
                    response = `${contextMessage}How many glasses of water would you like to log? e.g., "log 2 glasses of water"`;
                }
            } else if (command.startsWith("plan my day") || command.startsWith("create an itinerary")) {
                const coffeePlace = mockPlaces.food.find(p => p.name.toLowerCase().includes("cafe") || p.name.toLowerCase().includes("coffee") || p.tags.includes("coffee"));
                const parkPlace = mockPlaces.parks.length > 0 ? mockPlaces.parks[Math.floor(Math.random() * mockPlaces.parks.length)] : null;
                const lunchPlace = mockPlaces.food.find(p => p.tags && (p.tags.includes("lunch") || p.tags.includes("bistro"))); 
                const eventPlace = mockPlaces.events.length > 0 ? mockPlaces.events[0] : null;

                isHTMLResponse = true;
                response = `${contextMessage}Okay, ${userName}, here's a conceptual plan for a day out:<ul>`;
                if(coffeePlace) response += `<li>Morning: Start with coffee at <strong>${coffeePlace.name}</strong>. <button class="button-secondary" style="font-size:0.7rem;padding:2px 4px;" onclick="addNewTask('Coffee at ${coffeePlace.name}', 'personal', 'Morning')">Add to Planner</button></li>`;
                if(parkPlace) response += `<li>Mid-morning: A relaxing walk in <strong>${parkPlace.name}</strong>. <button class="button-secondary" style="font-size:0.7rem;padding:2px 4px;" onclick="addNewTask('Walk in ${parkPlace.name}', 'health', 'Mid-morning')">Add to Planner</button></li>`;
                if(lunchPlace) response += `<li>Lunch: Grab a bite at <strong>${lunchPlace.name}</strong>. <button class="button-secondary" style="font-size:0.7rem;padding:2px 4px;" onclick="addNewTask('Lunch at ${lunchPlace.name}', 'personal', 'Lunchtime')">Add to Planner</button></li>`;
                else if (coffeePlace && coffeePlace.tags.includes("lunch")) response += `<li>Lunch: Maybe back to <strong>${coffeePlace.name}</strong> if they have good lunch options?</li>`;
                else response += `<li>Lunch: Find a nice spot for lunch. I can search for "restaurants" if you like.</li>`;
                if(eventPlace) response += `<li>Afternoon: Check out <strong>${eventPlace.name}</strong>. <button class="button-secondary" style="font-size:0.7rem;padding:2px 4px;" onclick="addNewTask('Attend ${eventPlace.name}', 'personal', 'Afternoon')">Add to Planner</button></li>`;
                else response += `<li>Afternoon: Explore some local shops or revisit a favorite spot.</li>`;
                response += `</ul><p>Would you like me to search for any of these in Explore?</p>`;
                requiresFollowUpInResponse = true;
            } else if (command.startsWith("summarize channel") || command.startsWith("catch me up on")) {
                 const channelNameMatch = command.match(/(summarize channel|catch me up on)\s+"?([^"]+)"?/i);
                 const channelName = channelNameMatch ? channelNameMatch[2].trim() : "";
                 const channel = mockChannels.find(c => c.name.toLowerCase().includes(channelName.toLowerCase()));
                 if (channel && channel.messages && channel.messages.length > 0) {
                    isHTMLResponse = true;
                    response = `Here's a quick summary for "${channel.name}":<ul>`;
                    channel.messages.slice(-Math.min(3, channel.messages.length)).forEach(msg => {
                        let senderDetails = mockUsers[msg.senderId] || mockUsers.defaultBot;
                        response += `<li><strong>${senderDetails.name}:</strong> ${msg.text.substring(0,40)}...</li>`;
                    });
                    response += "</ul><p><em>This is a mock summary. Full history in the channel.</em></p>";
                } else if (channel) {
                    response = `The channel "${channel.name}" doesn't have much activity to summarize yet.`;
                } else {
                    response = `I couldn't find a channel named "${channelName}" to summarize.`;
                }
            } else if (command.startsWith("plan my party")) {
                isHTMLResponse = true;
                response = `${contextMessage}Okay, ${userName}, let's plan your party! Here are some steps we can take:
                    <ul>
                        <li><strong>Set Date & Time:</strong> When do you want the party?</li>
                        <li><strong>Guest List:</strong> Who are you inviting? (Rough number)</li>
                        <li><strong>Venue:</strong> At home, or need to find a place? I can search Explore for venues.</li>
                        <li><strong>Food & Drinks:</strong> Catering, potluck, or DIY? I can look for deals on supplies or restaurants.</li>
                        <li><strong>Theme/Decorations:</strong> Any specific theme?</li>
                        <li><strong>Activities/Entertainment:</strong> Music, games, etc.?</li>
                    </ul>
                    <p>Let's start with the <strong>date and time</strong> for your party. What did you have in mind?</p>`;
                aiConversationContext = "party_planning_date";
                aiExpectedResponseType = "date_time_text";
                requiresFollowUpInResponse = true;
            } else if (command.startsWith("plan a route")) {
                response = "Sure, I can help with that. What's the starting point for your route?";
                aiConversationContext = "plan_route_place1";
                aiExpectedResponseType = "text";
                requiresFollowUpInResponse = true;
            } else if (command.startsWith("global search")) {
                const searchTerm = originalCommand.substring(13).trim();
                if(searchTerm){
                    isHTMLResponse = true;
                    response = `Global Search (Mock) for "${searchTerm}":<ul>`;
                    tasks.filter(t => t.title.toLowerCase().includes(searchTerm)).forEach(t => response += `<li>Task: ${t.title.substring(0,30)}...</li>`);
                    mockPlaces.all.filter(p => p.name.toLowerCase().includes(searchTerm) || (p.tags && p.tags.includes(searchTerm))).forEach(p => response += `<li>Place: ${p.name.substring(0,30)}...</li>`);
                    mockDeals.filter(d => d.title.toLowerCase().includes(searchTerm) || d.businessName.toLowerCase().includes(searchTerm)).forEach(d => response += `<li>Deal: ${d.title.substring(0,30)}...</li>`);
                    mockChannels.filter(c => c.name.toLowerCase().includes(searchTerm)).forEach(c => response += `<li>Channel: ${c.name.substring(0,30)}...</li>`);
                    response += `</ul><p><em>Clicking these would navigate to the item. This is a simplified mock search.</em></p>`;
                } else {
                    response = "What would you like to search for globally?";
                }
            }
            else if (command.includes("hello") || command.includes("hi") || command.includes("hey")) {
                response = currentAiPersonality === 'witty' ? "Well, hello there, human. What marvels shall we NOT accomplish today?" : `Hello there, ${userName}! How can I assist you today?`;
            } else if (command.includes("time")) {
                response = `The current time is ${new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })}.`;
            } else if (command.includes("date")) {
                response = `Today's date is ${new Date().toLocaleDateString([], { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' })}.`;
            } else if (command.includes("weather")) {
                const weatherTextEl = document.getElementById('currentWeather');
                response = `Currently, it's ${weatherTextEl ? weatherTextEl.textContent : "lovely outside"}.`;
            } else if (command.includes("what's on my dashboard") || command.includes("dashboard summary")) {
                const upcomingTasks = tasks.filter(t => !t.completed).slice(0, 2);
                const pulseItems = Array.from(document.querySelectorAll('.nearby-pulse-carousel .story-label')).slice(0, 2).map(el => el.textContent);
                isHTMLResponse = true;
                response = "On your dashboard:<br>";
                if (upcomingTasks.length > 0) response += `Top tasks: ${upcomingTasks.map(t=>t.title.substring(0,20)+"...").join(', ')}.<br>`;
                else response += "No pressing tasks visible on dashboard.<br>";
                if (pulseItems.length > 0) response += `Nearby Pulse: ${pulseItems.join(' & ')}.<br>`;
                response += `Weather: ${document.getElementById('currentWeather')?.textContent || 'N/A'}.<br>`;
                response += `<em>This is a brief summary.</em>`;
            } else if (command.includes("summarize my day") || command.includes("what's my day look like")) {
                const incompleteTasks = tasks.filter(t => !t.completed);
                isHTMLResponse = true;
                if (incompleteTasks.length > 0) {
                    response = `You have ${incompleteTasks.length} task${incompleteTasks.length > 1 ? 's' : ''} remaining, ${userName}. Key ones:<ul>`;
                    incompleteTasks.slice(0,3).forEach(t => response += `<li>${t.title}</li>`);
                    response += "</ul>";
                } else {
                    response = "All tasks completed! Great job!";
                }
                response += `<br>Current weather: ${document.getElementById('currentWeather')?.textContent || 'N/A'}.`;
            } else if (command.includes("event") || command.includes("happening")) {
                const upcomingEvents = mockPlaces.events.slice(0,2).map(e => e.name).join(' and ');
                response = upcomingEvents ? `Some upcoming events are: ${upcomingEvents}. Interested? I can show you the Explore tab.` : "I don't see any major events right now. Check the Explore tab for more!";
            } else if (command.includes("what's good for") && command.includes("?")){
                const forWhomMatch = command.match(/what's good for\s+([^?]+)\??/i);
                const forWhom = forWhomMatch ? forWhomMatch[1].trim() : "";
                if (forWhom === "kids" || forWhom === "children" || forWhom === "family") {
                    const kidFriendlyPlaces = mockPlaces.all.filter(p => p.tags && p.tags.includes("kids-friendly"));
                    if (kidFriendlyPlaces.length > 0) {
                        isHTMLResponse = true;
                        response = `For ${forWhom}, I'd suggest:<ul>`;
                        kidFriendlyPlaces.slice(0,3).forEach(p => response += `<li>${p.name} (${p.type})</li>`);
                        response += `</ul><p>You can search for "kids friendly" in Explore for more.</p>`;
                    } else {
                        response = `I don't have specific "kids-friendly" tagged places right now, but you could try searching for "parks" or "playgrounds" in Explore.`;
                    }
                } else {
                     response = `I can try to find places for "${forWhom}". What type of place are you looking for (e.g., food, park, activity)?`;
                }
            }
            else if (command.includes("deal on") || command.includes("offer on") || command.includes("deals for") || command.includes("offers for")) {
                const dealQueryMatch = command.match(/(deal|offer)s?\s+(on|for)\s+(.+)/i);
                const dealQuery = dealQueryMatch ? dealQueryMatch[3].trim() : "";
                const filteredDeals = mockDeals.filter(d => d.title.toLowerCase().includes(dealQuery) || d.category.toLowerCase().includes(dealQuery) || d.businessName.toLowerCase().includes(dealQuery));
                if (filteredDeals.length > 0) {
                    isHTMLResponse = true;
                    response = `Found these deals for "${dealQuery}":<ul>`;
                    filteredDeals.slice(0,3).forEach(d => response += `<li>${d.title} at ${d.businessName}</li>`);
                    response += `</ul>Would you like to search for "${dealQuery}" in Explore Deals?`;
                    requiresFollowUpInResponse = true; 
                } else {
                    response = `Sorry, I couldn't find specific deals for "${dealQuery}". You can browse all deals in Explore.`;
                }

            } else if (command.includes("show ") || command.includes("open ")) {
                const target = command.replace("show ", "").replace("open ", "");
                const screenMap = { "dashboard": "dashboard", "home": "dashboard", "planner": "planner", "schedule": "planner", "explore": "explore", "map": "explore", "chat": "chat", "community": "chat", "wellness": "wellness", "hub": "wellness", "settings": "settings", "config": "settings", "services": "servicesMarket", "governance": "governance" };
                const targetScreen = screenMap[target];
                if (targetScreen) {
                    setActiveScreen(targetScreen);
                    if (targetScreen === 'explore' && (target.includes("deals") || target.includes("offers"))) {
                       setTimeout(() => {
                           const dealFilterButton = document.querySelector('#exploreFilterBar button[data-filter="deals"]');
                           if (dealFilterButton) filterPlaces('deals', dealFilterButton);
                       }, 50);
                    }
                    if (aiBottomSheet.classList.contains('active')) toggleAIChat(); 
                    showToast(`AI: Navigated to ${targetScreen.charAt(0).toUpperCase() + targetScreen.slice(1)}`, "ai_info", 1500); return; 
                } else if (target.includes("create task") || target.includes("new task")) {
                    setActiveScreen('planner');
                    setTimeout(() => newTaskInputEl?.focus(), 100);
                    if (aiBottomSheet.classList.contains('active')) toggleAIChat();
                    response = "Switched to Planner. You can add a new task there.";
                } else if (target.includes("journal")) {
                     openJournalModal();
                     if (aiBottomSheet.classList.contains('active')) toggleAIChat();
                     response = "Opened your journal.";
                }
                else {
                    response = `I can't directly open or show "${target}". Try a screen name like 'planner' or 'explore'.`;
                }
            } else if (command.includes("how am i doing") || command.includes("wellness check")) {
                response = "Based on mock data, you're doing okay! For a more detailed summary, you can check the Wellness Hub. Would you like to see the AI Wellness Summary?";
            } else if (command.startsWith("find ") || command.startsWith("search for ")) {
                const query = originalCommand.replace(/find|search for/i, '').trim();
                if (query) {
                    let targetFilter = 'all'; 
                    let searchInputContent = query;

                    if (query.toLowerCase().includes("deal") || query.toLowerCase().includes("offer")) {
                        targetFilter = 'deals';
                        searchInputContent = query.replace(/deals?|offers?/gi, '').trim();
                        if (!searchInputContent && query.toLowerCase().includes("food")) searchInputContent = "food"; 
                        else if (!searchInputContent && query.toLowerCase().includes("service")) searchInputContent = "services";
                    } else if (query.toLowerCase().includes("food") || query.toLowerCase().includes("restaurant")) targetFilter = 'food';
                    else if (query.toLowerCase().includes("park")) targetFilter = 'parks';
                    
                    response = `${contextMessage}Sure, opening Explore and searching for "${searchInputContent}" under the "${targetFilter}" filter.`;
                    setActiveScreen('explore');
                    setTimeout(() => {
                        const searchInput = document.getElementById('exploreSearchInput');
                        if (searchInput) {
                            searchInput.value = searchInputContent; 
                            document.getElementById('clearExploreSearchInput')?.classList.remove('hidden');
                        }
                        const filterButton = document.querySelector(`#exploreFilterBar button[data-filter="${targetFilter}"]`);
                        if (filterButton) filterPlaces(targetFilter, filterButton);
                        else renderPlaces(targetFilter); 

                        handleExploreSearch(true); 
                    }, 100); 
                    if (aiBottomSheet.classList.contains('active')) toggleAIChat();
                    showToast(`AI: Searching for "${searchInputContent}" in Explore.`, "ai_info", 2000); return;
                } else {
                    response = "What would you like me to find? e.g., 'find cafes' or 'find food deals'";
                }
            } else if (command.includes("schedule for tomorrow") || command.includes("tomorrow's tasks")) {
                const tomorrowsTasks = tasks.filter(t => t.dueDate === new Date(Date.now() + 86400000).toISOString().split('T')[0] && !t.completed);
                if(tomorrowsTasks.length > 0){
                    isHTMLResponse = true;
                    response = `For tomorrow, ${userName}, you have:<ul>${tomorrowsTasks.map(t => `<li>${t.title} (${t.time || 'anytime'})</li>`).join('')}</ul>`;
                } else {
                    response = "Looks like your schedule for tomorrow is clear so far!";
                }
            } else if (command.startsWith("set reminder") || command.startsWith("remind me to")) {
                const reminderText = originalCommand.replace(/set reminder|remind me to/i, '').trim();
                if (reminderText) {
                    response = `Okay, I've (mock) set a reminder for: "${reminderText}". This would use device reminders in a native app.`;
                } else {
                    response = "What would you like me to remind you about?";
                }
            } else if (command.startsWith("create channel")) {
                const channelNameMatch = originalCommand.match(/create channel\s+"?([^"]+)"?/i);
                const channelName = channelNameMatch ? channelNameMatch[1].trim() : "";
                if (channelName) {
                    setActiveScreen('chat');
                    openCreateChannelModal(channelName);
                    response = `Okay, I've opened the 'Create Channel' form with the name "${channelName}". Please select an icon and type.`;
                } else {
                    response = "What name would you like for the new channel? e.g., 'create channel My Hobby Group'";
                }
            } else if (command.startsWith("log mood")) {
                const moodMatch = command.match(/log mood\s+(happy|sad|neutral|excited|relaxed|🙂|😄|🤩|😌|😐|🙁|😞)/i);
                const noteMatch = command.match(/with note\s+(.+)/i);
                const note = noteMatch ? noteMatch[1].trim() : "";

                if (moodMatch && moodMatch[1]) {
                    const moodSymbol = { happy: '😄', sad: '😞', neutral: '😐', excited: '🤩', relaxed: '😌' }[moodMatch[1].toLowerCase()] || moodMatch[1];
                    const moodButton = document.querySelector(`.mood-emoji-button[data-mood="${moodSymbol}"]`);
                    if (moodButton) {
                        selectMood(moodButton); // Select it visually
                        if(logMood(moodSymbol, note)){ // Log it (will show its own toast)
                            response = `Mood logged as ${moodSymbol}${note ? ' with note' : ''}. Anything else?`;
                        } else {
                            response = `Could not log mood ${moodSymbol}. Try again.`;
                        }
                    } else {
                        response = `Sorry, I couldn't find an emoji for "${moodMatch[1]}". Try 😄, 😞, 😐, etc.`;
                    }
                } else {
                    response = "How are you feeling? e.g., 'log mood happy' or 'log mood 😞 with note feeling tired'";
                }
            } else if (command.startsWith("how am i doing with") && command.includes("habit")) {
                const habitNameMatch = command.match(/how am i doing with\s+"?([^"]+)"?\s+habit/i);
                const habitName = habitNameMatch ? habitNameMatch[1].trim() : "";
                const habit = habits.find(h => h.name.toLowerCase().includes(habitName.toLowerCase()));
                if (habit) {
                    response = `For your "${habit.name}" habit: You're at ${habit.current}/${habit.goal} ${habit.unit || ''} with a streak of ${habit.streak} day(s).`;
                } else {
                    response = `I couldn't find a habit called "${habitName}".`;
                }
            } else if (command.startsWith("set habit") || command.startsWith("create habit")) {
                 const habitDetailsMatch = originalCommand.match(/(set|create) habit\s+"?([^"]+)"?\s+for\s+(\d+)\s*([a-zA-Z]*)/i);
                 if (habitDetailsMatch) {
                    const habitName = habitDetailsMatch[2].trim();
                    const goal = parseInt(habitDetailsMatch[3]);
                    const unit = habitDetailsMatch[4].trim();
                    setActiveScreen('wellness');
                    openCreateHabitModal(habitName, goal, unit); 
                    response = `Okay, opening the habit creation form for "${habitName}" with goal ${goal} ${unit}. Please select an icon and color.`;
                 } else {
                    response = "To set a habit, try: 'set habit \"Drink Water\" for 8 glasses'";
                 }
            } else if (command.startsWith("analyze my last journal entry") && currentScreenId === 'wellness') {
                const journalEntries = loggedMoods.filter(m => m.type === 'journal');
                if (journalEntries.length > 0) {
                    const lastEntry = journalEntries[journalEntries.length - 1];
                    isHTMLResponse = true;
                    response = `Analyzing your last journal entry ("${lastEntry.note.substring(0,20)}..."):<br>(Mock Analysis) `;
                    if (lastEntry.note.toLowerCase().includes("happy") || lastEntry.note.toLowerCase().includes("great")) response += "It seems you had a positive experience! ";
                    if (lastEntry.note.toLowerCase().includes("challenge") || lastEntry.note.toLowerCase().includes("difficult")) response += "It sounds like you overcame something. ";
                    if (lastEntry.note.toLowerCase().includes("learn") || lastEntry.note.toLowerCase().includes("discovered")) response += "Glad to see you're learning! ";
                    response += "Reflecting on entries can provide good insights. Keep it up!";
                } else {
                    response = "You don't have any journal entries yet for me to analyze.";
                }
            } else if (command.startsWith("find services for")) {
                const serviceTypeMatch = command.match(/find services for\s+(.+)/i);
                const serviceType = serviceTypeMatch ? serviceTypeMatch[1].trim() : "";
                if (serviceType) {
                    setActiveScreen('servicesMarket');
                    response = `Okay, I'm (conceptually) searching the Local Services Marketplace for "${serviceType}".`;
                } else {
                    response = "What kind of service are you looking for? e.g., 'find services for plumbing'";
                }
            }
            else if (command.includes("latest in") && command.includes("channel")) {
                const channelNameMatch = command.match(/latest in\s+"?([^"]+)"?\s+channel/i);
                const channelName = channelNameMatch ? channelNameMatch[1].trim() : "";
                const channel = mockChannels.find(c => c.name.toLowerCase().includes(channelName.toLowerCase()));
                if (channel && channel.messages && channel.messages.length > 0) {
                    isHTMLResponse = true;
                    response = `Latest in "${channel.name}":<ul>`;
                    channel.messages.slice(-2).forEach(msg => {
                        const senderDetails = mockUsers[msg.senderId] || mockUsers.defaultBot;
                        response += `<li><strong>${senderDetails.name}</strong>: ${msg.text.substring(0,30)}...</li>`
                    });
                    response += "</ul>";
                } else if (channel) {
                    response = `The channel "${channel.name}" has no messages yet.`;
                } else {
                    response = `I couldn't find a channel called "${channelName}".`;
                }
            } else if (command.includes("is") && command.includes("open") && command.includes("?")) {
                const placeNameMatch = command.match(/is\s+"?([^"]+)"?\s+open/i);
                const placeName = placeNameMatch ? placeNameMatch[1].trim() : "";
                const place = mockPlaces.all.find(p => p.name.toLowerCase().includes(placeName.toLowerCase()));
                if (place) {
                    response = `${place.name} is ${place.openNow ? 'currently open.' : 'currently closed.'} ${place.sub || ''}`;
                } else {
                    response = `I don't have information on "${placeName}". Try searching in Explore.`;
                }
            } else if (command.includes("what's the emergency number") || command.includes("emergency call")) {
                response = "In an emergency, please dial your local emergency number (e.g., 911 in the US). This app does not directly make emergency calls, but the SOS button can alert contacts (conceptual).";
            } else if (command.includes("how to submit a deal") || command.includes("submit offer")) {
                response = "You can submit a deal or offer by going to the 'Explore' screen and tapping the 'Submit a Deal/Offer' button at the bottom. I can take you there if you like.";
            } else if (command.includes("how to submit a tip") || command.includes("community tip")) {
                response = "To submit a community tip, go to the 'Explore' screen and tap the 'Submit a Community Tip' button. I can navigate there for you.";
            } else if (command.includes("who is shamase")) {
                response = currentAiPersonality === 'witty' ? "Shamase? Sounds like someone important. Or maybe just the person testing me. You tell me." : `Shamase is the user of this LocalLife OS concept! That's you, ${userName}, right?`;
            } else if (command.includes("tell me a joke") || command.includes("joke")) {
                const jokes = [
                    "Why don't scientists trust atoms? Because they make up everything!",
                    "Why did the scarecrow win an award? Because he was outstanding in his field!",
                    "Why don't eggs tell jokes? They'd crack each other up!",
                    "I told my wife she was drawing her eyebrows too high. She seemed surprised."
                ];
                response = jokes[Math.floor(Math.random() * jokes.length)];
            } else if (command.includes("give me a quote") || command.includes("quote")) {
                 const quotes = [
                    "The only way to do great work is to love what you do. - Steve Jobs",
                    "The purpose of our lives is to be happy. - Dalai Lama",
                    "Get busy living or get busy dying. - Stephen King",
                    "You only live once, but if you do it right, once is enough. - Mae West"
                ];
                response = quotes[Math.floor(Math.random() * quotes.length)];
            } else if (command.includes("relax") || command.includes("stressed") || command.includes("calm down")) {
                response = `I understand, ${userName}. How about some deep breaths? You can also try the Journaling feature in the Wellness Hub for reflection. Or I can (mock) play some calming sounds for you.`;
            } else if (command.includes("help") || command.includes("what can you do")) {
                isHTMLResponse = true;
                response = `${contextMessage}I can help you with various tasks, ${userName}! Try things like:
                    <ul>
                        <li>General: "hello", "time", "date", "weather", "tell me a joke", "global search [term]"</li>
                        <li>Planner: "add task Go to gym at 6pm on Friday", "clear completed tasks", "top 3 tasks", "what's my next task?" (when on planner)</li>
                        <li>Navigation: "show planner", "open explore deals", "go to settings"</li>
                        <li>Explore: "find pizza places", "search for parks", "any food deals?", "is The Cozy Corner Cafe open?", "plan a day for me", "plan a route", "what's good for kids?"</li>
                        <li>Chat: "create channel My Garden Club", "latest in Downtown Announcements channel?", "summarize Dog Owners channel"</li>
                        <li>Wellness: "log mood happy", "how am i doing with water habit?", "set habit Meditate for 10 minutes", "log 2 glasses of water" (when on wellness), "suggest habit for stress relief", "analyze my last journal entry"</li>
                        <li>App Info: "how to submit a deal?", "what's the emergency number?"</li>
                        <li>"Clear chat"</li>
                    </ul>
                    <p class="card-subtitle" style="font-size:0.8rem"><em>Conceptual: Voice input, deeper device integration, multi-turn conversations.</em></p>`;
            } else if (command.includes("what's the community safety alert") || command.includes("safety alert")) {
                const safetyText = document.getElementById('safetyTickerText')?.textContent;
                response = safetyText ? `Current safety alert: "${safetyText}"` : "No active safety alerts displayed right now.";
            }
            else {
                response = `${contextMessage}${currentAiPersonality === 'witty' ? "I'm not sure I understand. And frankly, at this point, I'm too afraid to ask. Try something simpler, like 'add task groceries'." : "That's an interesting command! I'm still learning. Try 'help' to see what I can do."}`;
            }
            addMessageToAIChat('other', aiPrefix + response, isHTMLResponse);
            if(requiresFollowUpInResponse || command.includes("?")) triggerFabSuggestion(false); 
            
            // If this was a final response in a multi-turn, clear context
            if (aiConversationContext && !requiresFollowUpInResponse) {
                 aiConversationContext = null;
                 aiExpectedResponseType = null;
            }

        }, 600 + Math.random() * 400);
    }


    // --- Wellness ---
    const habitListContainerEl = document.getElementById('habitListContainer');
    const moodTimelineContentEl = document.getElementById('timelineContent');
    const aiWellnessInsightEl = document.getElementById('aiWellnessInsight');

    function renderHabits() {
        if (!habitListContainerEl) { console.error("habitListContainerEl not found"); return; }
        habitListContainerEl.innerHTML = Array(3).fill(getSkeletonHabitItem()).join('');
        habitListContainerEl.setAttribute('aria-busy', 'true');
        
        let allHabitsDone = habits.length > 0 && habits.every(h => h.current >= h.goal);
        if(aiWellnessInsightEl){
            if(allHabitsDone){
                aiWellnessInsightEl.innerHTML = `<i class="fas fa-brain"></i> AI: Amazing, ${userName}! You've completed all your habits for today! 🎉 Consider setting a new challenge or enjoying your progress.`;
                aiWellnessInsightEl.classList.remove('hidden');
            } else if (habits.some(h => h.streak > 5 && aiLearningPreferences.learnHabitTracking)) {
                const highStreakHabit = habits.find(h => h.streak > 5);
                aiWellnessInsightEl.innerHTML = `<i class="fas fa-brain"></i> AI: You're on a great ${highStreakHabit.streak}-day streak with "${highStreakHabit.name.substring(0,20)}..."! Keep up the momentum!`;
                aiWellnessInsightEl.classList.remove('hidden');
            } else {
                aiWellnessInsightEl.classList.add('hidden');
            }
        }


        setTimeout(() => {
            habitListContainerEl.innerHTML = ''; 
            if (habits.length === 0) {
                habitListContainerEl.innerHTML = `<div class="empty-state"><i class="fas fa-seedling"></i><p>No habits being tracked yet.</p><p class="card-subtitle mt-1">Add a new habit to start your wellness journey!</p></div>`;
            } else {
                habits.forEach(habit => {
                    const habitEl = document.createElement('div');
                    habitEl.className = 'habit-item';
                    habitEl.dataset.habitId = habit.id;
                    const progress = habit.goal > 0 ? habit.current / habit.goal : 0;
                    const circumference = 100.48; 

                    let extraControls = '';
                    if (habit.isWaterTracker) {
                        extraControls = `
                        <div class="water-tracker-buttons">
                            <button class="button button-secondary water-add-button" onclick="incrementWater(${habit.id}, 1)">+1 ${habit.unit || 'glass'}</button>
                            <button class="button button-secondary water-add-button" onclick="incrementWater(${habit.id}, 2)">+2 ${habit.unit || 'glass'}</button>
                        </div>`;
                    }

                    habitEl.innerHTML = `
                        <div class="habit-info">
                            <div class="habit-name"><i class="${habit.icon}" style="color:${habit.color}; margin-right:8px;"></i>${habit.name}</div>
                            <div class="habit-streak">Streak: ${habit.streak} day${habit.streak !== 1 ? 's' : ''} ${habit.streak > 5 ? '🔥' : ''}</div>
                            <div class="habit-progress-info">${habit.current}/${habit.goal} ${habit.unit || ''} completed</div>
                            ${extraControls}
                        </div>
                        <div class="habit-actions">
                            <button class="progress-ring-button ${habit.current >= habit.goal ? 'completed' : ''}" onclick="toggleHabitProgress(${habit.id})" aria-label="Update progress for ${habit.name}">
                                <svg width="40" height="40" viewBox="0 0 40 40" aria-hidden="true">
                                    <circle cx="20" cy="20" r="16" fill="transparent" stroke="${document.body.classList.contains('dark-mode') ? 'var(--warm-gray)' : 'var(--placeholder-bg)'}" stroke-width="3"/>
                                    <circle class="progress-ring-circle" cx="20" cy="20" r="16" fill="transparent" stroke="${habit.color}" stroke-width="3" transform="rotate(-90 20 20)" style="stroke-dashoffset: ${circumference * (1 - Math.min(progress,1))};"/>
                                </svg>
                                <i class="fas fa-check completion-check" aria-hidden="true"></i>
                            </button>
                            <button class="habit-action-button edit" onclick="openEditHabitModal(${habit.id})" aria-label="Edit habit: ${habit.name}"><i class="fas fa-pencil-alt"></i></button>
                            <button class="habit-action-button delete" onclick="deleteHabit(${habit.id})" aria-label="Delete habit: ${habit.name}"><i class="fas fa-times"></i></button>
                        </div>
                    `;
                    habitListContainerEl.appendChild(habitEl);
                });
            }
            habitListContainerEl.setAttribute('aria-busy', 'false');
            updateWellnessTimeline();
            renderPinnedWidgets();
            saveHabitsToLocalStorage();
        }, 500);
    }
    function openCreateHabitModal(nameFromAI = "", goalFromAI = 1, unitFromAI = "") {
        document.getElementById('editingHabitId').value = '';
        document.getElementById('newHabitName').value = nameFromAI;
        document.getElementById('newHabitGoal').value = goalFromAI;
        document.getElementById('newHabitUnit').value = unitFromAI;
        document.getElementById('submitHabitButton').textContent = 'Create Habit';
        document.getElementById('createHabitModalTitle').textContent = 'Create New Habit';
        populateIconSelector('newHabitIconSelector');
        populateColorSelector('newHabitColorSelector');
        openModal('createHabitModal');
    }
    function openEditHabitModal(habitId) {
        const habit = habits.find(h => h.id === habitId);
        if (!habit) { showToast("Error: Habit not found.", "error", 2000, true); return; }

        document.getElementById('editingHabitId').value = habit.id;
        document.getElementById('newHabitName').value = habit.name;
        document.getElementById('newHabitGoal').value = habit.goal;
        document.getElementById('newHabitUnit').value = habit.unit || '';
        document.getElementById('submitHabitButton').textContent = 'Save Changes';
        document.getElementById('createHabitModalTitle').textContent = 'Edit Habit';
        populateIconSelector('newHabitIconSelector', habit.icon);
        populateColorSelector('newHabitColorSelector', habit.color);
        openModal('createHabitModal');
    }
    function submitNewHabit(isAIInitiated = false) {
        const nameInput = document.getElementById('newHabitName');
        const goalInput = document.getElementById('newHabitGoal');
        const unitInput = document.getElementById('newHabitUnit');
        const name = nameInput.value.trim();
        const goal = parseInt(goalInput.value) || 1;
        const unit = unitInput.value.trim();
        const selectedIconEl = document.querySelector('#newHabitIconSelector .icon-option.selected');
        const selectedColorEl = document.querySelector('#newHabitColorSelector .icon-option.selected');
        const editingHabitId = parseInt(document.getElementById('editingHabitId').value);

        if (!name) { 
            if(!isAIInitiated) showToast("Habit name is required.", "error", 2000, true); nameInput.focus(); 
            return false;
        }
        if (goal <= 0) { 
            if(!isAIInitiated) showToast("Goal must be a positive number.", "error", 2000, true); goalInput.focus(); 
            return false;
        }
        if (!selectedIconEl) { 
            if(!isAIInitiated) showToast("Please select an icon.", "error", 2000, true); 
            return false;
        }
        if (!selectedColorEl) { 
            if(!isAIInitiated) showToast("Please select a color.", "error", 2000, true); 
            return false;
        }

        const isWater = name.toLowerCase().includes("water") && (unit.toLowerCase().includes("glass") || unit.toLowerCase().includes("ml"));

        if (editingHabitId) { 
            const habit = habits.find(h => h.id === editingHabitId);
            if (habit) {
                habit.name = name; habit.goal = goal; habit.unit = unit;
                habit.icon = selectedIconEl.dataset.icon; habit.color = selectedColorEl.dataset.color;
                if(isWater) habit.isWaterTracker = true; else delete habit.isWaterTracker;
                showToast(`Habit "${name}" updated!`, "success", 2000);
            } else { showToast("Error updating habit.", "error", 2000, true); return false; }
        } else { 
            const newHabit = {
                id: nextHabitId++, name: name, goal: goal, current: 0, unit: unit, streak: 0,
                icon: selectedIconEl.dataset.icon, color: selectedColorEl.dataset.color
            };
            if(isWater) newHabit.isWaterTracker = true;
            habits.unshift(newHabit); 
            showToast(`Habit "${name}" created! AI will help track it.`, "ai_info", 2000);
        }
        
        renderHabits();
        if(!isAIInitiated) closeModal('createHabitModal');
        return true;
    }
    window.incrementWater = function(habitId, amount) {
        const habit = habits.find(h => h.id === habitId && h.isWaterTracker);
        if (habit) {
            habit.current += amount;
            if (habit.current >= habit.goal && (habit.current - amount < habit.goal)) { 
                 habit.streak++;
                 showToast(`Nice! "${habit.name.substring(0,20)}..." completed! Streak: ${habit.streak} days.`, "success", 2500);
                 checkForWellnessPatterns();
            } else if (habit.current < habit.goal) {
                 showToast(`Progress for "${habit.name.substring(0,20)}..." updated!`, "info", 1500);
            } else { 
                 showToast(`Extra water logged for "${habit.name.substring(0,20)}..."!`, "info", 1500);
            }
            if (navigator.vibrate) navigator.vibrate(30);
            renderHabits();
        }
    }
    window.toggleHabitProgress = function(habitId) {
        const habit = habits.find(h => h.id === habitId);
        if (habit) {
            if (habit.isWaterTracker) { 
                showToast("Use +1 / +2 buttons for water tracking.", "info");
                return;
            }
            if (habit.current < habit.goal) {
                habit.current++;
                if (habit.current === habit.goal) {
                     habit.streak++;
                     showToast(`Nice! "${habit.name.substring(0,20)}..." completed! Streak: ${habit.streak} days.`, "success", 2500);
                     checkForWellnessPatterns();
                } else {
                    showToast(`Progress for "${habit.name.substring(0,20)}..." updated!`, "info", 1500);
                }
            } else { 
                habit.current = 0; 
                showToast(`"${habit.name.substring(0,20)}..." progress reset.`, "info", 1500);
            }
            if (navigator.vibrate) navigator.vibrate(50);
            renderHabits(); 
        } else { showToast("Error: Habit not found.", "error", 2000, true); }
    }
    window.deleteHabit = function(habitId) {
        const habitIndex = habits.findIndex(h => h.id === habitId);
        if (habitIndex > -1) {
            const deletedHabitName = habits[habitIndex].name;
            habits.splice(habitIndex, 1);
            renderHabits();
            showToast(`Habit "${deletedHabitName.substring(0,20)}..." deleted.`, "info", 1500);
        } else { showToast("Error: Habit not found for deletion.", "error", 2000, true);}
    }
    let selectedMoodValue = null;
    const moodNoteInputEl = document.getElementById('moodNoteInput');
    const journalInputEl = document.getElementById('journalInput');
    
    window.selectMood = function(moodElement) {
        document.querySelectorAll('#moodSelector .mood-emoji-button.selected').forEach(el => {
            el.classList.remove('selected'); el.setAttribute('aria-pressed', 'false');
        });
        moodElement.classList.add('selected'); moodElement.setAttribute('aria-pressed', 'true');
        selectedMoodValue = moodElement.dataset.mood;
        if (navigator.vibrate) navigator.vibrate(30);
    }
    window.logMood = function(moodFromAI = null, noteFromAI = "") {
        const moodToLog = moodFromAI || selectedMoodValue;
        const noteToLog = noteFromAI || (moodNoteInputEl ? moodNoteInputEl.value.trim() : "");

        if (!moodToLog) { 
            if(!moodFromAI) showToast("Please select a mood first.", "error", 2000, true); 
            return false;
        }
        loggedMoods.push({ mood: moodToLog, note: noteToLog, timestamp: new Date(), type: 'mood' });
        showToast(`Mood logged: ${moodToLog} ${noteToLog ? 'with note.' : ''} AI will analyze this.`, "success", 2000);
        
        // Cross-Module Wellness Suggestion
        if (['😞', '🙁'].includes(moodToLog) && !moodFromAI && aiLearningPreferences.learnMoodLogs) { 
            const yogaEvent = mockPlaces.all.find(p => p.name.toLowerCase().includes('yoga in the park'));
            if(yogaEvent){
                setTimeout(() => {
                    openConfirmationModal(
                        "AI Wellness Suggestion",
                        `<p>I see you're feeling down, ${userName}. I noticed that 'Yoga in the Park' is often available. Gentle exercise can sometimes help lift one's spirits.</p><p>Would you like me to add it to your planner?</p>`,
                        () => {
                            addNewTask("Yoga in the Park", "health", "10:00 AM", new Date(Date.now() + 86400000).toISOString().split('T')[0]);
                            showToast("Yoga in the Park added to your planner!", "success");
                        }
                    )
                }, 1500);
            }
        }

        if(!moodFromAI) { 
            document.querySelectorAll('#moodSelector .mood-emoji-button.selected').forEach(el => {
                el.classList.remove('selected'); el.setAttribute('aria-pressed', 'false');
            });
            if(moodNoteInputEl) moodNoteInputEl.value = '';
            selectedMoodValue = null;
        }
        updateWellnessTimeline();
        renderPinnedWidgets();
        saveLoggedMoodsToLocalStorage();
        checkForWellnessPatterns();
        return true;
    }

    function checkForWellnessPatterns() {
        const patternCard = document.getElementById('aiPatternCard');
        const patternText = document.getElementById('aiPatternText');
        if (!patternCard || !patternText || !aiLearningPreferences.learnHabitTracking || !aiLearningPreferences.learnMoodLogs) return;

        // Pattern 1: Jogging and mood
        const jogHabit = habits.find(h => h.name.toLowerCase().includes("jog"));
        if (jogHabit && loggedMoods.length > 3) {
            const daysWithJog = new Set(tasks.filter(t => t.title.toLowerCase().includes("jog") && t.completed).map(t => new Date(t.timestamp || Date.now()).toDateString())); // Mock timestamp
            const positiveMoodDays = new Set(loggedMoods.filter(m => ['😄', '🙂', '🤩'].includes(m.mood)).map(m => new Date(m.timestamp).toDateString()));

            let correlationCount = 0;
            daysWithJog.forEach(day => {
                if (positiveMoodDays.has(day)) {
                    correlationCount++;
                }
            });

            if (daysWithJog.size > 1 && (correlationCount / daysWithJog.size) >= 0.75) {
                patternText.innerHTML = `On days you complete your '<strong>${jogHabit.name}</strong>' habit, you are <strong>75% more likely</strong> to log a positive mood. Keep up the great work!`;
                patternCard.style.display = 'block';
                return; // Show first pattern found
            }
        }
        
        // Pattern 2: Work tasks and skipped meditation
        const meditationHabit = habits.find(h => h.name.toLowerCase().includes("meditation"));
        if (meditationHabit) {
             const busyWorkDays = new Set(tasks.filter(t => t.category === 'work').map(t => new Date(t.timestamp || Date.now()).toDateString()));
             let meditationSkippedOnBusyDays = 0;
             busyWorkDays.forEach(day => {
                // This is a simplification; a real app would check if habit was NOT completed on that day
                if(Math.random() > 0.5) meditationSkippedOnBusyDays++;
             });
             if (busyWorkDays.size > 2 && (meditationSkippedOnBusyDays / busyWorkDays.size) > 0.6) {
                patternText.innerHTML = `When you have a busy 'Work' day, you tend to skip your '<strong>${meditationHabit.name}</strong>'. Consider a short 5-minute session even on busy days.`;
                patternCard.style.display = 'block';
                return;
             }
        }
        
        // If no patterns found, hide the card
        patternCard.style.display = 'none';
    }


    window.openJournalModal = function() {
        const promptTextEl = document.getElementById('journalPromptText');
        if (promptTextEl) {
            const lastMood = loggedMoods.length > 0 ? loggedMoods[loggedMoods.length-1] : null;
            let personalizedPrompt = journalPrompts[Math.floor(Math.random() * journalPrompts.length)];
            if(lastMood && lastMood.mood === '😞' && aiLearningPreferences.learnMoodLogs){
                personalizedPrompt = "Reflect on what's challenging right now. What's one small step you can take to feel a bit better?";
            } else if (tasks.some(t => t.completed && t.category === 'learning') && aiLearningPreferences.learnTaskPatterns) {
                personalizedPrompt = "You've been learning recently! What's the most interesting new idea you've encountered?";
            }
            promptTextEl.textContent = personalizedPrompt;
        }
        if(journalInputEl) journalInputEl.value = ""; 
        openModal('journalModal');
    }
    window.saveJournalEntry = function() {
        if (journalInputEl && journalInputEl.value.trim() === "") {
            showToast("Please write something in your journal.", "error", 2000, true);
            if (journalInputEl) journalInputEl.focus(); return;
        }
        const entryText = journalInputEl ? journalInputEl.value : "";
        loggedMoods.push({ mood: '📝', note: entryText, timestamp: new Date(), type: 'journal' });
        showToast("Journal entry saved (AI will analyze for insights - mock).", "success", 2000);
        
        if (aiLearningPreferences.learnMoodLogs && entryText.toLowerCase().includes("excited for")) {
            const excitementMatch = entryText.toLowerCase().match(/excited for\s+([^.!]+)/);
            if (excitementMatch && excitementMatch[1]) {
                 setTimeout(() => {
                    addMessageToAIChat('other', `${getAIPersonalityPrefix()}That's great you're excited for ${excitementMatch[1]}! I can help you plan or find related local events if you'd like.`);
                    if(!aiBottomSheet.classList.contains('active')) triggerFabSuggestion();
                }, 1000);
            }
        }

        closeModal('journalModal');
        updateWellnessTimeline(); 
        saveLoggedMoodsToLocalStorage();
    }
    window.openGuidedExerciseModal = function() {
        const suggestionEl = document.getElementById('aiGuidedExerciseSuggestion');
        const lastMood = loggedMoods.length > 0 ? loggedMoods[loggedMoods.length-1] : null;
        if(suggestionEl && lastMood && ['😞', '🙁', '😐'].includes(lastMood.mood) && aiLearningPreferences.learnMoodLogs) {
            suggestionEl.textContent = `AI: Noticed you logged ${lastMood.mood}. A ${lastMood.mood === '😐' ? '5-min mindfulness' : 'calming breathing'} exercise might be helpful.`;
        } else if (suggestionEl) {
            suggestionEl.textContent = "AI: A short mindfulness break can boost focus and reduce stress.";
        }
        openModal('guidedExerciseModal');
    }
    window.showAIWellnessSummaryModal = function() {
        const bodyEl = document.getElementById('aiWellnessSummaryBody');
        if (!bodyEl) return;
        let summaryHtml = `<p>Based on your recent activity, ${userName} (AI Analysis - Mock):</p><ul>`;
        const positiveMoods = loggedMoods.filter(m => ['🙂', '😄', '🤩', '😌'].includes(m.mood)).length;
        const neutralSadMoods = loggedMoods.filter(m => ['😐', '🙁', '😞'].includes(m.mood)).length;

        if (loggedMoods.length === 0 && aiLearningPreferences.learnMoodLogs) summaryHtml += "<li>AI: No mood data logged yet to analyze. Try logging your mood daily!</li>";
        else if (positiveMoods > neutralSadMoods && aiLearningPreferences.learnMoodLogs) summaryHtml += "<li>AI: Your mood has generally been positive! Keep up the great work! 😊</li>";
        else if (neutralSadMoods > positiveMoods && aiLearningPreferences.learnMoodLogs) summaryHtml += "<li>AI: It seems you've had some challenging days. Remember self-compassion. Consider a guided exercise.</li>";
        else if (aiLearningPreferences.learnMoodLogs) summaryHtml += "<li>AI: Your mood seems balanced. How are you feeling overall?</li>";

        const completedHabits = habits.filter(h => h.current >= h.goal);
        if(habits.length === 0 && aiLearningPreferences.learnHabitTracking) summaryHtml += "<li>AI: Start tracking habits to build positive routines!</li>";
        else if(completedHabits.length > 0 && aiLearningPreferences.learnHabitTracking) summaryHtml += `<li>AI: Fantastic effort completing ${completedHabits.length} habit${completedHabits.length > 1 ? 's' : ''} recently!</li>`;
        else if (aiLearningPreferences.learnHabitTracking) summaryHtml += `<li>AI: Keep working on your habits. Consistency is key!</li>`;
        
        const waterHabit = habits.find(h => h.isWaterTracker);
        if(waterHabit && waterHabit.current < waterHabit.goal && aiLearningPreferences.learnHabitTracking) summaryHtml += `<li>AI Reminder: Stay hydrated! You're at ${waterHabit.current}/${waterHabit.goal} ${waterHabit.unit} for water.</li>`;
        
        const journalEntries = loggedMoods.filter(m => m.type === 'journal').length;
        if(journalEntries > 1 && aiLearningPreferences.learnMoodLogs) summaryHtml += `<li>AI: You've made ${journalEntries} journal entries. Keep reflecting!</li>`;
        
        if (loggedMoods.length > 2 && habits.some(h => h.name.toLowerCase().includes("jog") && h.current >= h.goal) && aiLearningPreferences.learnMoodLogs && aiLearningPreferences.learnHabitTracking) {
             summaryHtml += `<li><strong>AI Pattern Detected:</strong> You often log positive moods on days you complete your 'Morning Jog' habit. Keep it up! (Conceptual)</li>`;
        }


        summaryHtml += "</ul><p class='mt-2'><em>This is a mock AI summary. A real AI would provide deeper, personalized insights and track trends over time.</em></p>";
        bodyEl.innerHTML = summaryHtml;
        openModal('aiWellnessSummaryModal');
    }
    function updateWellnessTimeline() {
        if (!moodTimelineContentEl) return;
        let content = "";
        const todayEntries = loggedMoods.filter(m => new Date(m.timestamp).toDateString() === new Date().toDateString());
        if (todayEntries.length > 0) {
            content += `<p><strong>Today's Log:</strong> ${todayEntries.map(m => m.mood + (m.type === 'journal' ? '(Journal)' : '')).join(' ')}</p>`;
        }
        const completedToday = habits.filter(h => h.current >= h.goal);
        if (completedToday.length > 0) {
            content += `<p><strong>Habits Completed Today:</strong> ${completedToday.map(h => `<i class="${h.icon}" style="color:${h.color}; margin-right:3px;"></i>${h.name.substring(0,15)}...`).join(', ')}</p>`;
        }
        moodTimelineContentEl.innerHTML = content || `AI: No entries yet for today, ${userName}. Log a mood or complete a habit!`;
    }

    // --- Settings ---
    const darkModeToggleContainer = document.getElementById('darkModeToggleContainer');
    const darkModeToggleVisual = document.getElementById('darkModeToggleVisual');
    const aiPersonalitySelect = document.getElementById('aiPersonalitySelect');

    function toggleDarkMode() { 
        document.body.classList.toggle('dark-mode');
        const isDarkMode = document.body.classList.contains('dark-mode');
        if (darkModeToggleVisual) darkModeToggleVisual.classList.toggle('active', isDarkMode);
        if (darkModeToggleContainer) darkModeToggleContainer.setAttribute('aria-checked', isDarkMode.toString());
        localStorage.setItem('darkMode', isDarkMode.toString()); 
        renderHabits(); 
        
        const activeScreenId = document.querySelector('.screen.active')?.id;
        if (activeScreenId === 'explore') {
            renderPlaces(document.querySelector('#exploreFilterBar .filter-button.active')?.dataset.filter || 'all');
        }
        if (activeScreenId === 'dashboard') {
            renderDealsOnDashboard();
            renderPinnedWidgets();
        }

        if (navigator.vibrate) navigator.vibrate(30);
    }
    function changeThemeAccent(color, buttonElement) { 
        document.documentElement.style.setProperty('--primary-accent', color);
        let darkerColor;
        try {
            let r = parseInt(color.slice(1,3), 16) - 20; let g = parseInt(color.slice(3,5), 16) - 20; let b = parseInt(color.slice(5,7), 16) - 20;
            r = Math.max(0, r).toString(16).padStart(2,'0'); g = Math.max(0, g).toString(16).padStart(2,'0'); b = Math.max(0, b).toString(16).padStart(2,'0');
            darkerColor = `#${r}${g}${b}`;
        } catch (e) { darkerColor = color; }
        document.documentElement.style.setProperty('--primary-accent-darker', darkerColor);

        document.querySelectorAll('.theme-selector .theme-color-button').forEach(btn => {
            btn.classList.remove('active'); btn.setAttribute('aria-checked', 'false');
        });
        if (buttonElement) {
            buttonElement.classList.add('active'); buttonElement.setAttribute('aria-checked', 'true');
        }
        localStorage.setItem('themeAccent', color);
        showToast("Theme accent changed.", "success", 1500);
    }
    function changeAIPersonality(personality) {
        currentAiPersonality = personality;
        localStorage.setItem('aiPersonality', personality);
        showToast(`AI Personality set to ${personality}.`, "ai_info", 2000);
        addMessageToAIChat('other', `${getAIPersonalityPrefix()}${personality.charAt(0).toUpperCase() + personality.slice(1)} AI ready. ${personality === 'witty' ? 'Try not to bore me.' : 'How can I assist?'}`);
    }
    function openGenericModal(title, bodyHtml) {
        const modalTitleEl = document.getElementById('genericModalTitle');
        const modalBodyEl = document.getElementById('genericModalBody');
        if (modalTitleEl) modalTitleEl.textContent = title;
        if (modalBodyEl) modalBodyEl.innerHTML = bodyHtml;
        openModal('genericModal');
    }
    function openConfirmationModal(title, message, confirmCallback) {
        document.getElementById('confirmationModalTitle').textContent = title;
        document.getElementById('confirmationModalMessage').innerHTML = message; // Allow HTML in message
        document.getElementById('confirmActionButton').onclick = () => {
            confirmCallback();
            closeModal('confirmationModal');
        };
        openModal('confirmationModal');
    }
    function openUserProfileModal() {
        const user = mockUsers['user'];
        if(!user) return;
        const userAvatarEl = document.getElementById('userProfileAvatar');
        if(userAvatarEl) userAvatarEl.src = user.avatarUrl;
        document.getElementById('profileNameInput').value = user.name;
        document.getElementById('profileUsernameInput').value = user.username;
        document.getElementById('profileLocationInput').value = user.location || '';
        document.getElementById('profileBioInput').value = user.bio;
        document.getElementById('profileInterestsInput').value = user.interests || '';
        openModal('userProfileModal');
    }
    function saveUserProfile() {
        if(!mockUsers['user']) return;
        const newName = document.getElementById('profileNameInput').value;
        const newBio = document.getElementById('profileBioInput').value;
        const newLocation = document.getElementById('profileLocationInput').value;
        const newInterests = document.getElementById('profileInterestsInput').value;
        
        userName = newName.split(' ')[0];
        mockUsers['user'].name = newName;
        mockUsers['user'].bio = newBio;
        mockUsers['user'].location = newLocation;
        mockUsers['user'].interests = newInterests;
        
        const aiGreetingEl = document.getElementById('aiGreeting');
        if(aiGreetingEl) {
             const currentGreeting = aiGreetingEl.textContent;
             const namePart = currentGreeting.substring(currentGreeting.indexOf(',') + 2, currentGreeting.lastIndexOf('!'));
             aiGreetingEl.textContent = currentGreeting.replace(namePart, userName);
        }

        saveUsersToLocalStorage(); 

        showToast("Profile saved. AI can use this for better personalization.", "success");
        closeModal('userProfileModal');
    }
    function openDashboardCustomizationModal() {
        const container = document.getElementById('dashboardCardToggleContainer');
        if(!container) return;
        container.innerHTML = '';
        const savedConfig = JSON.parse(localStorage.getItem('dashboardCardConfig')) || dashboardCardConfig;

        dashboardCardConfig.forEach(defaultCard => { // Iterate over the base config to ensure all options are shown
            const currentCardState = savedConfig.find(sc => sc.id === defaultCard.id) || defaultCard; // Get saved state or default
            const itemDiv = document.createElement('div');
            itemDiv.className = 'setting-item';
            itemDiv.innerHTML = `
                <span class="setting-label">${currentCardState.name}</span>
                <button class="toggle-switch-button" data-card-id="${currentCardState.id}" onclick="this.firstChild.classList.toggle('active')" role="switch" aria-checked="${currentCardState.visible}">
                    <span class="toggle-switch ${currentCardState.visible ? 'active' : ''}"></span>
                </button>
            `;
            container.appendChild(itemDiv);
        });
        openModal('dashboardCustomizationModal');
    }
    function saveDashboardCustomization() {
        const toggles = document.querySelectorAll('#dashboardCardToggleContainer .toggle-switch-button');
        let newConfig = [];

        dashboardCardConfig.forEach(defaultCard => { // Iterate base config to ensure all cards are in newConfig
            const toggleButton = document.querySelector(`#dashboardCardToggleContainer .toggle-switch-button[data-card-id="${defaultCard.id}"]`);
            const isVisible = toggleButton && toggleButton.firstChild ? toggleButton.firstChild.classList.contains('active') : defaultCard.visible;
            newConfig.push({ id: defaultCard.id, name: defaultCard.name, visible: isVisible });
        });
        
        localStorage.setItem('dashboardCardConfig', JSON.stringify(newConfig));
        applyDashboardCustomization(newConfig);
        showToast("Dashboard customization saved. AI will adapt.", "success");
        closeModal('dashboardCustomizationModal');
    }
    function applyDashboardCustomization(configToApply) {
        const currentConfig = configToApply || JSON.parse(localStorage.getItem('dashboardCardConfig')) || dashboardCardConfig;
        currentConfig.forEach(cardConf => {
            const cardElement = document.getElementById(cardConf.id);
            if (cardElement) {
                cardElement.style.display = cardConf.visible ? '' : 'none';
            } else if (cardConf.id === "nearbyPulseSection") { 
                 const pulseSection = document.getElementById('nearbyPulseSection');
                 if (pulseSection) pulseSection.style.display = cardConf.visible ? '' : 'none';
            }
        });
    }
    function openNotificationSettingsModal(){
        const modal = document.getElementById('notificationSettingsModal');
        if(modal){
            openModal('notificationSettingsModal');
        }
    }
    function openHelpAboutModal(){
        openModal('helpAboutModal');
    }
    function openAILearningPrefsModal(){
        const prefs = JSON.parse(localStorage.getItem('aiLearningPreferences')) || aiLearningPreferences;
        const modal = document.getElementById('aiLearningPrefsModal');
        if(!modal) return;
        Object.keys(prefs).forEach(key => {
            const toggleButtonContainer = modal.querySelector(`.toggle-switch-button[data-pref="${key}"]`);
            if(toggleButtonContainer){
                const visualSwitch = toggleButtonContainer.querySelector('.toggle-switch');
                if(visualSwitch) visualSwitch.classList.toggle('active', prefs[key]);
            }
        });
        openModal('aiLearningPrefsModal');
    }
    window.toggleAILearningPref = function(buttonElement) {
        const prefKey = buttonElement.dataset.pref;
        const visualSwitch = buttonElement.querySelector('.toggle-switch');
        if(visualSwitch) {
            visualSwitch.classList.toggle('active');
            aiLearningPreferences[prefKey] = visualSwitch.classList.contains('active');
            localStorage.setItem('aiLearningPreferences', JSON.stringify(aiLearningPreferences));
            showToast(`AI Learning for '${prefKey.replace(/([A-Z])/g, ' $1').toLowerCase()}' ${aiLearningPreferences[prefKey] ? 'enabled' : 'disabled'}.`, "ai_info");
        }
    }


    function exportUserData() {
        const dataToExport = {
            tasks: tasks,
            habits: habits,
            loggedMoods: loggedMoods,
            mockDeals: mockDeals,
            mockChannels: mockChannels, 
            mockUsers: mockUsers,
            mockNotifications: mockNotifications,
            savedPlacesIds: mockPlaces.all.filter(p => p.saved).map(p=>p.id),
            settings: {
                darkMode: localStorage.getItem('darkMode') === 'true',
                themeAccent: localStorage.getItem('themeAccent'),
                aiPersonality: localStorage.getItem('aiPersonality'),
                dashboardConfig: JSON.parse(localStorage.getItem('dashboardCardConfig')),
                userProfile: JSON.parse(localStorage.getItem('userProfile')),
                aiLearningPreferences: JSON.parse(localStorage.getItem('aiLearningPreferences'))
            }
        };
        const jsonString = JSON.stringify(dataToExport, null, 2);
        const blob = new Blob([jsonString], { type: "application/json" });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = 'LocalLifeOS_data.json';
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
        showToast("User data exported as JSON. AI uses this (anonymized) to learn (conceptual).", "success");
    }
    function clearAllDataWithConfirmation() {
        openConfirmationModal(
            "Clear All Data?",
            "<p>This will reset all your tasks, habits, mood logs, custom settings, and other application data. This action cannot be undone.</p><p><strong>Are you absolutely sure?</strong></p>",
            () => {
                localStorage.clear(); // Clears everything
                
                // NEW: Redirect to login screen after clearing data
                showToast("All application data has been cleared. Please log in again.", "success", 3000);
                setTimeout(() => {
                    window.location.reload(); // Simplest way to ensure a full reset and go to login
                }, 3100);
            }
        );
    }


    // --- Local Deals (Integrated - Modal Logic) ---
    function showDealDetailModal(deal) {
        if (!deal) { showToast("Error: Deal details not available.", "error", 2000, true); return; }
        document.getElementById('modalDealTitle').textContent = deal.title;
        const modalImage = document.getElementById('modalDealImage');
        modalImage.src = deal.img;
        modalImage.alt = deal.title;

        let bodyHtml = `<p><strong>Business:</strong> ${deal.businessName}</p>`;
        bodyHtml += `<p>${deal.description}</p>`;
        if (deal.expiryDate) {
             const expiry = new Date(deal.expiryDate);
             const today = new Date();
             today.setHours(0,0,0,0);
             if (expiry < today) {
                bodyHtml += `<p><strong>Status:</strong> <span style="color:var(--danger-color); font-weight:bold;">Expired on ${expiry.toLocaleDateString()}</span></p>`;
             } else {
                bodyHtml += `<p><strong>Expires:</strong> ${expiry.toLocaleDateString()}</p>`;
             }
        } else {
            bodyHtml += `<p><strong>Expires:</strong> No expiration date (ongoing)</p>`;
        }
        if (deal.terms) {
            bodyHtml += `<h4 class="mt-2 card-subtitle" style="font-size:0.9rem; font-weight:500;">Terms & Conditions:</h4><p style="font-size:0.8rem;">${deal.terms}</p>`;
        }
        document.getElementById('modalDealBody').innerHTML = bodyHtml;
        openModal('dealDetailModal');
    }

    function openSubmitDealModal() {
        const form = document.getElementById('submitDealForm');
        if (form) form.reset();

        const categorySelect = document.getElementById('dealCategorySelect');
        if (categorySelect) {
            categorySelect.innerHTML = '';
            dealCategories.forEach(cat => {
                const option = document.createElement('option');
                option.value = cat;
                option.textContent = cat.charAt(0).toUpperCase() + cat.slice(1);
                categorySelect.appendChild(option);
            });
             if(dealCategories.length > 0) {
                 categorySelect.value = dealCategories[0];
             }
        }
        openModal('submitDealModal');
    }

    function submitNewDeal() {
        const titleInput = document.getElementById('dealTitleInput');
        const businessNameInput = document.getElementById('dealBusinessNameInput');
        const descriptionInput = document.getElementById('dealDescriptionInput');
        const categorySelect = document.getElementById('dealCategorySelect');
        const imageUrlInput = document.getElementById('dealImageUrlInput');
        const expiryDateInput = document.getElementById('dealExpiryDateInput');
        const termsInput = document.getElementById('dealTermsInput');

        if (!titleInput || !businessNameInput || !descriptionInput || !categorySelect || !imageUrlInput || !expiryDateInput || !termsInput) {
            console.error("One or more deal form elements not found.");
            showToast("Error: Deal form is incomplete.", "error");
            return;
        }

        const title = titleInput.value.trim();
        const businessName = businessNameInput.value.trim();
        const description = descriptionInput.value.trim();
        const category = categorySelect.value;
        let imageUrl = imageUrlInput.value.trim();
        const expiryDate = expiryDateInput.value;
        const terms = termsInput.value.trim();

        if (!title || !businessName || !description || !category) {
            showToast("Please fill in all required fields (*).", "error", 2000, true);
            if(!title && titleInput) titleInput.focus();
            else if(!businessName && businessNameInput) businessNameInput.focus();
            else if(!description && descriptionInput) descriptionInput.focus();
            else if(!category && categorySelect) categorySelect.focus();
            return;
        }

        if (!imageUrl) {
            imageUrl = `https://via.placeholder.com/80x80.png?text=${encodeURIComponent(title.substring(0,10) || 'Deal')}`;
        }

        const newDeal = {
            id: nextDealId++,
            title: title,
            description: description,
            businessName: businessName,
            category: category,
            img: imageUrl,
            expiryDate: expiryDate || null,
            terms: terms || "N/A"
        };

        mockDeals.unshift(newDeal);

        const activeScreenId = document.querySelector('.screen.active')?.id;
        if (activeScreenId === 'dashboard') {
            renderDealsOnDashboard();
        } else if (activeScreenId === 'explore') {
            const activeExploreFilter = document.querySelector('#exploreFilterBar .filter-button.active')?.dataset.filter;
            if (activeExploreFilter === 'deals' || category === activeExploreFilter || activeExploreFilter === 'all') {
                 renderPlaces(activeExploreFilter);
            }
        }

        closeModal('submitDealModal');
        showToast("Deal submitted (AI will review & categorize). Thank you!", "success", 2500);
        saveDealsToLocalStorage();
        triggerFabSuggestion();
    }


    // --- LocalStorage Persistence ---
    function saveTasksToLocalStorage() { localStorage.setItem('localLifeTasks', JSON.stringify(tasks)); }
    function loadTasksFromLocalStorage() {
        const storedTasks = localStorage.getItem('localLifeTasks');
        if (storedTasks) { tasks = JSON.parse(storedTasks); nextTaskId = Math.max(0, ...tasks.map(t=>t.id)) + 1; }
    }
    function saveHabitsToLocalStorage() { localStorage.setItem('localLifeHabits', JSON.stringify(habits)); }
    function loadHabitsFromLocalStorage() {
        const storedHabits = localStorage.getItem('localLifeHabits');
        if (storedHabits) { habits = JSON.parse(storedHabits); nextHabitId = Math.max(0, ...habits.map(h=>h.id)) + 1; }
    }
    function saveLoggedMoodsToLocalStorage() { localStorage.setItem('localLifeMoods', JSON.stringify(loggedMoods)); }
    function loadLoggedMoodsToLocalStorage() {
        const storedMoods = localStorage.getItem('localLifeMoods');
        if (storedMoods) { loggedMoods = JSON.parse(storedMoods); }
    }
    function saveDealsToLocalStorage() { localStorage.setItem('localLifeDeals', JSON.stringify(mockDeals)); }
    function loadDealsFromLocalStorage() {
        const storedDeals = localStorage.getItem('localLifeDeals');
        if (storedDeals) {
            mockDeals = JSON.parse(storedDeals);
            nextDealId = Math.max(0, ...mockDeals.map(d => d.id)) + 1;
        }
    }
    function savePlacesToLocalStorage() { // Save only saved status, not all place data
        const savedPlaceIds = mockPlaces.all.filter(p => p.saved).map(p => p.id);
        localStorage.setItem('localLifeSavedPlaces', JSON.stringify(savedPlaceIds));
    }
    function loadPlacesFromLocalStorage() {
        const storedSavedPlaceIds = localStorage.getItem('localLifeSavedPlaces');
        if (storedSavedPlaceIds) {
            const savedIds = JSON.parse(storedSavedPlaceIds);
            mockPlaces.all.forEach(p => {
                if (savedIds.includes(p.id)) p.saved = true;
                else p.saved = false; // Ensure consistency if a place was unsaved elsewhere
            });
            // Re-populate categorized arrays based on updated 'saved' status if needed
            mockPlaces.ai_recommended = mockPlaces.all.filter(p => p.rating >= 4.5 && p.type !== 'events');
            mockPlaces.open_now = mockPlaces.all.filter(p => p.openNow);
            Object.keys(mockPlaces).forEach(key => {
                if (key !== 'all' && key !== 'ai_recommended' && key !== 'open_now') {
                    mockPlaces[key] = mockPlaces.all.filter(p => p.type === key);
                }
            });
        }
    }
    function saveChannelsToLocalStorage() { localStorage.setItem('localLifeChannels', JSON.stringify(mockChannels));}
    function loadChannelsFromLocalStorage() {
        const storedChannels = localStorage.getItem('localLifeChannels');
        if(storedChannels) {
            mockChannels = JSON.parse(storedChannels);
            nextChannelId = Math.max(0, ...mockChannels.map(c => c.id)) + 1;
            let maxMid = 0;
            mockChannels.forEach(c => {
                if(c.messages) c.messages.forEach(m => { 
                    if(m.mid > maxMid) maxMid = m.mid;
                    m.timestamp = new Date(m.timestamp); // Re-hydrate dates
                });
                if(c.lastMessageTimestamp) c.lastMessageTimestamp = new Date(c.lastMessageTimestamp); // Re-hydrate
            });
            nextMessageId = maxMid + 1;
        }
    }
    function saveUsersToLocalStorage() { localStorage.setItem('localLifeUsers', JSON.stringify(mockUsers));}
    function loadUsersFromLocalStorage() {
        const storedUsers = localStorage.getItem('localLifeUsers');
        if(storedUsers) {
            mockUsers = JSON.parse(storedUsers);
        }
        const userProfile = JSON.parse(localStorage.getItem('userProfile')); // reload specific user settings
        if(userProfile && mockUsers['user']){
            mockUsers['user'].name = userProfile.name;
            mockUsers['user'].bio = userProfile.bio;
            userName = userProfile.name.split(' ')[0]; 
        } else if (mockUsers['user']) {
            userName = mockUsers['user'].name.split(' ')[0];
        } else {
            userName = 'User'; // Fallback
        }
    }
    function loadAILearningPrefsFromLocalStorage() {
        const storedPrefs = localStorage.getItem('aiLearningPreferences');
        if(storedPrefs) {
            aiLearningPreferences = JSON.parse(storedPrefs);
        }
    }
    function saveNotificationsToLocalStorage() { localStorage.setItem('localLifeNotifications', JSON.stringify(mockNotifications));}
    function loadNotificationsFromLocalStorage() {
        const storedNotifications = localStorage.getItem('localLifeNotifications');
        if (storedNotifications) {
            mockNotifications = JSON.parse(storedNotifications).map(n => ({...n, timestamp: new Date(n.timestamp)})); // Re-hydrate dates
            nextNotificationId = Math.max(0, ...mockNotifications.map(n => n.id)) + 1;
        }
    }
    function loadDashboardConfigFromLocalStorage() {
        const storedConfig = localStorage.getItem('dashboardCardConfig');
        if(storedConfig) {
            dashboardCardConfig = JSON.parse(storedConfig);
        }
    }

    // --- NEW: Authentication Logic ---
    const loginScreen = document.getElementById('loginScreen');
    const signupScreen = document.getElementById('signupScreen');

    function showLoginScreen() {
        if (loginScreen) loginScreen.classList.add('active');
        if (signupScreen) signupScreen.classList.remove('active');
    }
    function showSignupScreen() {
        if (signupScreen) signupScreen.classList.add('active');
        if (loginScreen) loginScreen.classList.remove('active');
    }

    function handleLoginAttempt() {
        const email = document.getElementById('loginEmail').value;
        const password = document.getElementById('loginPassword').value;

        if (!email || !password) {
            showToast("Please enter both email/username and password.", "error");
            return;
        }
        // Mock login: For demo, any non-empty fields will log in.
        // A real app would validate against a backend.
        if (email === "test@example.com" && password === "password") { // Mock successful login
            localStorage.setItem('isLoggedIn', 'true');
            const storedProfile = JSON.parse(localStorage.getItem('userProfile'));
            if (storedProfile && storedProfile.name) {
                 userName = storedProfile.name.split(' ')[0];
            } else {
                 userName = "User"; // Fallback if no profile
                 localStorage.setItem('userProfile', JSON.stringify({ name: 'Demo User', bio: 'New to LocalLife OS!' }));
            }

            authContainer.style.display = 'none';
            appContainer.classList.remove('hidden');
            initializeAppPostLogin(); // Initialize main app content
            showToast(`Welcome back, ${userName}!`, "success");
        } else {
            showToast("Invalid credentials (Mock: use test@example.com / password)", "error");
        }
    }

    function handleSignupAttempt() {
        const name = document.getElementById('signupName').value;
        const email = document.getElementById('signupEmail').value;
        const password = document.getElementById('signupPassword').value;
        const confirmPassword = document.getElementById('signupConfirmPassword').value;

        if (!name || !email || !password || !confirmPassword) {
            showToast("Please fill all fields for signup.", "error");
            return;
        }
        if (password !== confirmPassword) {
            showToast("Passwords do not match.", "error");
            return;
        }
        // Mock signup:
        const newUserName = name.split(' ')[0];
        localStorage.setItem('isLoggedIn', 'true'); // Auto-login after signup
        localStorage.setItem('userProfile', JSON.stringify({ name: name, bio: `Hi, I'm ${newUserName}!` }));
        userName = newUserName;
        
        // Update mockUsers if not already present
        if (!mockUsers['user']) {
            mockUsers['user'] = { id: 'user', name: name, avatarUrl: `https://via.placeholder.com/40/4DB6AC/FFFFFF?text=${name.substring(0,1)}`, bio: `Hi, I'm ${newUserName}!` };
            saveUsersToLocalStorage();
        } else {
            mockUsers['user'].name = name;
            mockUsers['user'].bio = `Hi, I'm ${newUserName}!`;
            saveUsersToLocalStorage();
        }


        authContainer.style.display = 'none';
        appContainer.classList.remove('hidden');
        initializeAppPostLogin();
        showToast(`Welcome to LocalLife OS, ${userName}! Account created.`, "success");
    }

    function handleLogout() {
        openConfirmationModal("Log Out?", "Are you sure you want to log out?", () => {
            localStorage.removeItem('isLoggedIn');
            // Potentially clear some session-specific data, but not all app data
            // For this demo, we'll just redirect to login
            authContainer.style.display = 'flex';
            appContainer.classList.add('hidden');
            showLoginScreen();
            showToast("Logged out successfully.", "success");
        });
    }
    
    function initializeAppPostLogin() {
        // Load all data that might be user-specific or need refresh
        loadUsersFromLocalStorage(); 
        loadTasksFromLocalStorage();
        loadHabitsFromLocalStorage();
        loadLoggedMoodsToLocalStorage();
        loadDealsFromLocalStorage();
        loadPlacesFromLocalStorage();
        loadChannelsFromLocalStorage(); 
        loadAILearningPrefsFromLocalStorage();
        loadNotificationsFromLocalStorage();
        loadDashboardConfigFromLocalStorage();

        const isDarkModeSaved = localStorage.getItem('darkMode') === 'true';
        if (isDarkModeSaved) {
            document.body.classList.add('dark-mode');
            if (darkModeToggleVisual) darkModeToggleVisual.classList.add('active');
            if (darkModeToggleContainer) darkModeToggleContainer.setAttribute('aria-checked', 'true');
        } else {            if (darkModeToggleContainer) darkModeToggleContainer.setAttribute('aria-checked', 'false');
        }

        const savedTheme = localStorage.getItem('themeAccent');
        const defaultThemeColor = '#4DB6AC';
        let defaultThemeButton = Array.from(document.querySelectorAll('.theme-selector .theme-color-button i.theme-color-dot'))
                                .find(dot => dot.style.color.toUpperCase().includes(defaultThemeColor.toUpperCase()))?.parentElement;
        if (!defaultThemeButton && document.querySelector('.theme-selector .theme-color-button')) {
             defaultThemeButton = document.querySelector('.theme-selector .theme-color-button');
        }


        if (savedTheme) {
            const matchingButton = Array.from(document.querySelectorAll('.theme-selector .theme-color-button')).find(btn => {
                 const dot = btn.querySelector('.theme-color-dot');
                 return dot && dot.style.color.toUpperCase().includes(savedTheme.toUpperCase());
            });
            if (matchingButton) changeThemeAccent(savedTheme, matchingButton);
            else if (defaultThemeButton) changeThemeAccent(defaultThemeColor, defaultThemeButton);
        } else if (defaultThemeButton) changeThemeAccent(defaultThemeColor, defaultThemeButton);

        const savedAIPersonality = localStorage.getItem('aiPersonality');
        if (savedAIPersonality && aiPersonalitySelect) {
            currentAiPersonality = savedAIPersonality;
            aiPersonalitySelect.value = savedAIPersonality;
        }

        setActiveScreen('dashboard', true); // Go to dashboard after login
        updateAIData(); // Update greeting, time, etc.
        setInterval(updateAIData, 30000);
        setInterval(cycleSafetyTicker, 7000);
        updateUnreadNotificationBadge();


        renderDashboardTasks();
        renderDealsOnDashboard();
        renderPinnedWidgets();
        renderTasks();
        generateCalendarPlaceholder();
        renderPlaces('all');
        renderChannels();
        renderHabits();
        updateProactiveSuggestions();
        showAIExploreSuggestion();
        updateWellnessTimeline();
        setupInputClearButtons();
        applyDashboardCustomization();

        if (aiChatArea.children.length === 0) { // Only add initial AI message if chat is empty
            addMessageToAIChat('other', getAIPersonalityPrefix() + `Hello ${userName}! I'm LocalLife AI. How can I help you? Try 'help'.`);
        }
        if (aiBottomSheet) aiBottomSheet.setAttribute('aria-hidden', 'true');
        if (aiFab) aiFab.setAttribute('aria-expanded', 'false');

        // Only show daily briefing if it hasn't been shown today
        const lastBriefingDate = localStorage.getItem('lastBriefingDate');
        const todayDateString = new Date().toDateString();
        if (lastBriefingDate !== todayDateString) {
            showDailyBriefing();
            localStorage.setItem('lastBriefingDate', todayDateString);
        }
    }


    // --- DOMContentLoaded & Initial Renders ---
    document.addEventListener('DOMContentLoaded', () => {
        // Check login status first
        const isLoggedIn = localStorage.getItem('isLoggedIn') === 'true';

        if (isLoggedIn) {
            authContainer.style.display = 'none';
            appContainer.classList.remove('hidden');
            initializeAppPostLogin(); // Load data and render app
        } else {
            authContainer.style.display = 'flex';
            appContainer.classList.add('hidden');
            showLoginScreen(); // Show login by default if not logged in
        }
        
        // const styleSheet = document.createElement("style");
        // styleSheet.innerText = ".visually-hidden { position: absolute; width: 1px; height: 1px; padding: 0; margin: -1px; overflow: hidden; clip: rect(0, 0, 0, 0); border: 0; }";
        // document.head.appendChild(styleSheet);
    });

    // --- Utility Functions (Toast, Modal, Screen Navigation) ---
    showToast = function(message, type = "info", duration = 3000, isError = false) {
        if (!toastNotification) return;
        toastNotification.textContent = message;
        toastNotification.className = 'toast-notification'; // Reset class

        toastNotification.style.backgroundColor = ''; // Reset inline styles
        toastNotification.style.color = '';

        if (type === "success") {
            toastNotification.style.backgroundColor = 'var(--success-color)';
            toastNotification.style.color = 'white';
        } else if (type === "error" || isError) { // isError flag for backward compatibility
            toastNotification.style.backgroundColor = 'var(--danger-color)';
            toastNotification.style.color = 'white';
        } else if (type === "ai_info") { 
            toastNotification.classList.add('ai-info-toast'); // Use class for AI info
        }
        else { // Default info
            if (document.body.classList.contains('dark-mode')) {
                toastNotification.style.backgroundColor = 'rgba(240,240,240,0.9)';
                toastNotification.style.color = '#333';
            } else {
                toastNotification.style.backgroundColor = 'rgba(30,30,30,0.9)';
                toastNotification.style.color = 'white';
            }
        }

        toastNotification.classList.add('show');
        // Adjust toast position based on whether appContainer is visible (i.e., nav is present)
        if (appContainer && !appContainer.classList.contains('hidden')) {
            // When appContainer is visible, toast should be above bottom nav
            // Using calculated value from CSS: calc(60px + var(--space-lg) + env(safe-area-inset-bottom))
            // Assuming nav height is around 60px, plus some large spacing
            const navHeightApproximation = "70px"; // Simplified for JS
            const safeAreaBottom = getComputedStyle(document.documentElement).getPropertyValue('env(safe-area-inset-bottom)') || "0px";
            toastNotification.style.bottom = `calc(${navHeightApproximation} + var(--space-lg) + ${safeAreaBottom})`;

        } else {
             // Auth screen or other states where nav isn't visible
            toastNotification.style.bottom = `calc(var(--space-lg) + env(safe-area-inset-bottom))`;
        }


        clearTimeout(toastTimeout);
        toastTimeout = setTimeout(() => {
            toastNotification.classList.remove('show');
        }, duration);
    }

    openModal = function(modalId) {
        const modal = document.getElementById(modalId);
        if (modal) {
            modal.classList.add('active');
            currentOpenModalId = modalId;
            const focusableElements = 'button, [href], input, select, textarea, [tabindex]:not([tabindex="-1"])';
            const firstFocusableElement = modal.querySelector(focusableElements);
            if (firstFocusableElement) firstFocusableElement.focus();
        } else { console.error(`Modal with ID "${modalId}" not found.`); }
    }

    closeModal = function(modalIdToClose) {
        const modalToActOn = modalIdToClose || currentOpenModalId;
        if (!modalToActOn) return;
        const modal = document.getElementById(modalToActOn);
        if (modal) {
            modal.classList.remove('active');
            if (modalToActOn === currentOpenModalId) currentOpenModalId = null;
        } else { console.warn(`Modal with ID "${modalToActOn}" not found during close.`);}
    }

    function updateContextualFabIcon() {
        if (!aiFabIcon) return;
        const activeScreenId = document.querySelector('.screen.active')?.id;
        let newIcon = 'fa-brain';
        switch (activeScreenId) {
            case 'planner': newIcon = 'fa-wand-magic-sparkles'; break;
            case 'explore': newIcon = 'fa-route'; break;
            case 'wellness': newIcon = 'fa-chart-line'; break;
        }
        aiFabIcon.className = `fas ${newIcon}`;
    }

    setActiveScreen = function(screenId, skipScroll = false) {
        // Handle full-page chat view exits
        if (appContainer.classList.contains('full-page-active')) {
            appContainer.classList.remove('full-page-active');
            if (aiBottomSheet.classList.contains('active')) {
                aiBottomSheet.classList.remove('active');
                aiBottomSheet.setAttribute('aria-hidden', 'true');
            }
            if (specificChatView.classList.contains('active')) {
                specificChatView.classList.remove('active');
                specificChatView.classList.add('hidden');
            }
        }

        screens.forEach(screen => screen.classList.remove('active'));
        navItems.forEach(item => {
            item.classList.remove('active'); item.setAttribute('aria-selected', 'false');
        });

        const targetScreen = document.getElementById(screenId);
        if (targetScreen) {
            targetScreen.classList.add('active');
             if (screenId === 'chat') {
                channelListView.style.display = 'block'; // Ensure list view is visible
                specificChatView.classList.add('hidden'); // Ensure specific chat is hidden
                specificChatView.classList.remove('active'); 
            }
        }
        else {
            console.error(`Screen with ID "${screenId}" not found. Defaulting to dashboard.`);
            document.getElementById('dashboard')?.classList.add('active');
            screenId = 'dashboard';
        }

        const targetNavItem = document.querySelector(`.nav-item[data-screen="${screenId}"]`);
        if (targetNavItem) {
            targetNavItem.classList.add('active'); targetNavItem.setAttribute('aria-selected', 'true');
        }
        
        updateContextualFabIcon();

        if (!skipScroll) {
            const contentArea = document.querySelector('.content');
            if(contentArea) contentArea.scrollTop = 0;
        }

        if (currentOpenModalId && currentOpenModalId !== "aiBottomSheet" && currentOpenModalId !== "notificationsModal") {
            closeModal(currentOpenModalId);
        }

        if (screenId === 'chat' && document.getElementById('newChannelIconSelector') && !document.getElementById('newChannelIconSelector').hasChildNodes()) {
            populateIconSelector('newChannelIconSelector');
        }
        if (screenId === 'wellness') {
            if (document.getElementById('newHabitIconSelector') && !document.getElementById('newHabitIconSelector').hasChildNodes()) {
                populateIconSelector('newHabitIconSelector');
            }
            if (document.getElementById('newHabitColorSelector') && !document.getElementById('newHabitColorSelector').hasChildNodes()){
                 populateColorSelector('newHabitColorSelector');
            }
            updateWellnessTimeline();
            checkForWellnessPatterns();
        }
        if (screenId === 'explore') showAIExploreSuggestion();
        if (screenId === 'dashboard') {
            updateProactiveSuggestions();
            renderDealsOnDashboard();
            renderPinnedWidgets();
            applyDashboardCustomization();
        }
        if (screenId === 'planner' && aiPlannerSuggestionEl) {
            aiPlannerSuggestionEl.classList.add('hidden'); 
        }
    }
    updateAIData = function() {
        const aiGreetingEl = document.getElementById('aiGreeting');
        const localTimeDateEl = document.getElementById('localTimeDate');
        const now = new Date();
        const hours = now.getHours();
        
        let greeting = `Hello, ${userName}!`; // userName is now global
        if (hours < 12) greeting = `Good Morning, ${userName}!`;
        else if (hours < 18) greeting = `Good Afternoon, ${userName}!`;
        else greeting = `Good Evening, ${userName}!`;

        if (aiGreetingEl) aiGreetingEl.textContent = greeting;

        if (localTimeDateEl) {
             const options = { weekday: 'short', month: 'short', day: 'numeric', hour: '2-digit', minute: '2-digit', hour12: true };
             localTimeDateEl.textContent = now.toLocaleTimeString('en-US', options).replace(',', ' -');
        }
        updateUnreadNotificationBadge();
    }
    generateCalendarPlaceholder = function() {
        const calendarEl = document.getElementById('calendarPlaceholder');
        if (!calendarEl) return;
        calendarEl.innerHTML = '';
        const daysOfWeek = ['S', 'M', 'T', 'W', 'T', 'F', 'S'];
        daysOfWeek.forEach(day => {
            const dayHeader = document.createElement('div');
            dayHeader.className = 'day'; dayHeader.style.fontWeight = 'bold';
            dayHeader.textContent = day; calendarEl.appendChild(dayHeader);
        });
        const today = new Date().getDate();
        const currentMonthDays = new Date(new Date().getFullYear(), new Date().getMonth() + 1, 0).getDate();
        const firstDayOfMonth = new Date(new Date().getFullYear(), new Date().getMonth(), 1).getDay();

        for(let i=0; i < firstDayOfMonth; i++){
            const emptyCell = document.createElement('div');
            emptyCell.className = 'day'; calendarEl.appendChild(emptyCell);
        }

        for (let i = 1; i <= currentMonthDays ; i++) {
            if (calendarEl.childElementCount >= 35 + daysOfWeek.length) break; // Max 5 weeks display
            const dayCell = document.createElement('div');
            dayCell.className = 'day'; dayCell.textContent = i;
            if (i === today) {
                dayCell.classList.add('today'); dayCell.setAttribute('aria-current', 'date');
                dayCell.setAttribute('aria-label', `Today, ${i}`);
            } else { dayCell.setAttribute('aria-label', `Date ${i}`); }
            calendarEl.appendChild(dayCell);
        }
    }

    // --- Notification Panel ---
    const notificationListContainer = document.getElementById('notificationListContainer');
    const unreadNotificationBadge = document.getElementById('unreadNotificationBadge');

    function updateUnreadNotificationBadge() {
        if (!unreadNotificationBadge) return;
        const unreadCount = mockNotifications.filter(n => !n.read).length;
        unreadNotificationBadge.textContent = unreadCount;
        unreadNotificationBadge.classList.toggle('hidden', unreadCount === 0);
    }

    function renderNotifications() {
        if (!notificationListContainer) return;
        notificationListContainer.innerHTML = ''; // Clear previous notifications

        if (mockNotifications.length === 0) {
            notificationListContainer.innerHTML = `<li class="empty-state" style="padding:20px 0;"><i class="fas fa-bell-slash"></i><p>No notifications yet.</p></li>`;
            updateUnreadNotificationBadge();
            return;
        }

        mockNotifications.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp)).forEach(notif => {
            const item = document.createElement('li');
            item.className = `notification-item ${notif.read ? '' : 'unread'}`;
            item.setAttribute('role', 'listitem');
            item.setAttribute('tabindex', '0');
            item.onclick = () => {
                const wasUnread = !notif.read;
                notif.read = true;
                if (notif.action && typeof notif.action === 'function') {
                    closeModal('notificationsModal'); // Close modal *before* action
                    notif.action();
                } else {
                    closeModal('notificationsModal');
                }
                if (wasUnread) {
                    renderNotifications(); 
                    updateUnreadNotificationBadge();
                    saveNotificationsToLocalStorage();
                }
            };
            item.onkeypress = (e) => { if(e.key === 'Enter' || e.key === ' ') item.click(); };

            item.innerHTML = `
                <i class="notification-icon ${notif.icon}" aria-hidden="true"></i>
                <div class="notification-content">
                    <div class="notification-title">${notif.title}</div>
                    <div class="notification-text">${notif.text}</div>
                    <div class="notification-timestamp">${new Date(notif.timestamp).toLocaleString()}</div>
                </div>
            `;
            notificationListContainer.appendChild(item);
        });
        updateUnreadNotificationBadge();
    }

    function showDailyBriefing() {
        const weather = document.getElementById('currentWeather')?.textContent || "Partly cloudy";
        const taskCount = tasks.filter(t => t.dueDate === new Date().toISOString().split('T')[0] && !t.completed).length;
        const savedCafe = mockPlaces.all.find(p => p.saved && p.tags.includes('cafe'));
        let dealText = "";
        if (savedCafe) {
            const dealForCafe = mockDeals.find(d => d.businessName === savedCafe.name);
            if (dealForCafe) {
                dealText = ` Also, there's a new '${dealForCafe.title}' deal at '${dealForCafe.businessName}', one of your saved places.`;
            }
        }
        const safetyAlert = safetyTickerMessages.find(m => m.toLowerCase().includes('closure') || m.toLowerCase().includes('outage'));
        
        let briefingText = `Morning, ${userName}! ☀️ It's ${weather}. You have ${taskCount} task${taskCount !== 1 ? 's' : ''} today.${dealText}`;
        if(safetyAlert) {
            briefingText += ` Heads up: ${safetyAlert.split('.')[0]}.`
        }

        // Add as a special notification
        const briefingNotification = {
            id: nextNotificationId++,
            icon: 'fas fa-sun',
            title: 'Your Daily Briefing',
            text: briefingText,
            timestamp: new Date(),
            read: false,
            type: 'daily_briefing',
            action: () => setActiveScreen('dashboard')
        };
        
        const existingBriefing = mockNotifications.find(n => n.type === 'daily_briefing' && new Date(n.timestamp).toDateString() === new Date().toDateString());
        if(!existingBriefing){
            mockNotifications.unshift(briefingNotification);
            renderNotifications();
            updateUnreadNotificationBadge();
            showToast("You have a new Daily Briefing in your notifications!", "ai_info", 4000);
            saveNotificationsToLocalStorage();
        }
    }

    window.showNotificationsPanel = function() {
        renderNotifications();
        openModal('notificationsModal');
    }

    window.markAllNotificationsRead = function() {
        mockNotifications.forEach(n => n.read = true);
        renderNotifications();
        updateUnreadNotificationBadge();
        saveNotificationsToLocalStorage();
        showToast("All notifications marked as read.", "success");
    }

    window.clearAllNotifications = function() {
        openConfirmationModal("Clear All Notifications?", "Are you sure you want to clear all notifications? This cannot be undone.", () => {
            mockNotifications = [];
            nextNotificationId = 1;
            renderNotifications();
            updateUnreadNotificationBadge();
            saveNotificationsToLocalStorage();
            showToast("All notifications cleared.", "success");
        });
    }

    // --- Nearby Pulse Detail Modal ---
    window.showPulseDetailModal = function(itemName, itemIcon, itemDescription) {
        let modalBodyHtml = `
            <div class="text-center mb-3">
                <i class="${itemIcon} fa-3x" style="color: var(--primary-accent);"></i>
            </div>
            <p>${itemDescription}</p>
            <p class="mt-2 card-subtitle" style="font-size:0.8rem;"><em>AI could provide related events, directions, or allow sharing from here.</em></p>
            <button class="button mt-3" style="width:100%" onclick="showToast('Showing directions to ${itemName} (mock). AI could suggest optimal routes. Haptic feedback (conceptual).', 'ai_info')">
                <i class="fas fa-directions"></i> Get Directions (Mock)
            </button>
        `;
        openGenericModal(itemName, modalBodyHtml);
    }
    
    // --- NEW: Full Calendar Functionality ---
    function openFullCalendar(type) {
        currentCalendarType = type;
        calendarCurrentDate = new Date(); // Reset to current month on open
        renderFullCalendar();
        openModal('fullCalendarModal');
    }

    function navigateCalendar(monthOffset) {
        calendarCurrentDate.setMonth(calendarCurrentDate.getMonth() + monthOffset);
        renderFullCalendar();
    }
    
    function renderFullCalendar() {
        const gridBody = document.getElementById('calendarGridBody');
        const modalTitle = document.getElementById('fullCalendarModalTitle');
        const detailPanel = document.getElementById('calendarDayDetailPanel');

        if (!gridBody || !modalTitle) return;

        gridBody.innerHTML = '';
        detailPanel.classList.add('hidden');
        
        const year = calendarCurrentDate.getFullYear();
        const month = calendarCurrentDate.getMonth();
        modalTitle.textContent = calendarCurrentDate.toLocaleString('default', { month: 'long', year: 'numeric' });

        const firstDayOfMonth = new Date(year, month, 1).getDay();
        const daysInMonth = new Date(year, month + 1, 0).getDate();

        for (let i = 0; i < firstDayOfMonth; i++) {
            gridBody.innerHTML += `<div class="calendar-day other-month"></div>`;
        }

        for (let day = 1; day <= daysInMonth; day++) {
            const dayEl = document.createElement('div');
            dayEl.className = 'calendar-day';
            const thisDate = new Date(year, month, day);
            const thisDateString = thisDate.toISOString().split('T')[0];

            if (thisDateString === new Date().toISOString().split('T')[0]) {
                dayEl.classList.add('today');
            }

            let contentHtml = `<div class="day-number">${day}</div>`;
            if (currentCalendarType === 'tasks') {
                const tasksOnDay = tasks.filter(t => t.dueDate === thisDateString);
                if (tasksOnDay.length > 0) {
                    tasksOnDay.slice(0, 2).forEach(task => {
                        contentHtml += `<div class="task-indicator" style="background-color: var(--${{work:'moss-green',health:'soft-blue',errands:'muted-terracotta'}[task.category] || 'primary-accent'}); color: white;">${task.title}</div>`;
                    });
                     if (tasksOnDay.length > 2) contentHtml += `<div class="task-indicator" style="background: var(--warm-gray); color: var(--text-color);">+${tasksOnDay.length - 2} more</div>`;
                }
            } else if (currentCalendarType === 'moods') {
                const moodOnDay = loggedMoods.find(m => new Date(m.timestamp).toDateString() === thisDate.toDateString());
                if (moodOnDay) {
                    contentHtml += `<div class="mood-indicator">${moodOnDay.mood}</div>`;
                }
            }
            dayEl.innerHTML = contentHtml;
            dayEl.onclick = () => showCalendarDayDetails(thisDate);
            gridBody.appendChild(dayEl);
        }
    }
    
    function showCalendarDayDetails(date) {
        const detailPanel = document.getElementById('calendarDayDetailPanel');
        let detailHtml = `<h4>Details for ${date.toLocaleDateString()}</h4>`;
        let foundContent = false;
        
        if (currentCalendarType === 'tasks') {
            const tasksOnDay = tasks.filter(t => t.dueDate === date.toISOString().split('T')[0]);
            if (tasksOnDay.length > 0) {
                detailHtml += '<ul>';
                tasksOnDay.forEach(task => detailHtml += `<li>${task.completed ? '✅' : '⬜'} ${task.title}</li>`);
                detailHtml += '</ul>';
                foundContent = true;
            }
        } else if (currentCalendarType === 'moods') {
            const moodsOnDay = loggedMoods.filter(m => new Date(m.timestamp).toDateString() === date.toDateString());
            if(moodsOnDay.length > 0) {
                detailHtml += '<ul>';
                moodsOnDay.forEach(mood => detailHtml += `<li>${mood.mood} ${mood.note ? `- "${mood.note}"` : ''}</li>`);
                detailHtml += '</ul>';
                foundContent = true;
            }
        }
        
        if (!foundContent) {
            detailHtml += `<p class="card-subtitle">No ${currentCalendarType} logged for this day.</p>`;
        } else if (currentCalendarType === 'moods' && foundContent) {
            const moodsOnDay = loggedMoods.filter(m => new Date(m.timestamp).toDateString() === date.toDateString());
            detailHtml += `<p class="card-subtitle mt-2"><em>AI could analyze mood trends for this day of the week (e.g., "You tend to feel ${moodsOnDay[0].mood} on Mondays").</em></p>`;
        }

        detailPanel.innerHTML = detailHtml;
        detailPanel.classList.remove('hidden');
    }

    // --- NEW: Habit Statistics Modal ---
    function openHabitStatsModal() {
        const statsBody = document.getElementById('habitStatsBody');
        const aiInsight = document.getElementById('habitStatsAIInsight');
        if (!statsBody || !aiInsight) return;

        let totalHabits = habits.length;
        if (totalHabits === 0) {
            statsBody.innerHTML = `<p class="text-center">No habits to show stats for yet.</p>`;
            aiInsight.classList.add('hidden');
            openModal('habitStatsModal');
            return;
        }

        let statsHtml = '';
        let totalCompletion = 0;
        let bestStreak = { name: '', streak: 0 };
        let mostConsistent = { name: '', rate: 0 };
        
        habits.forEach(habit => {
            const completionRate = habit.goal > 0 ? (habit.current / habit.goal) * 100 : 0;
            totalCompletion += completionRate;
            
            statsHtml += `
                <div class="habit-stat-item">
                    <div class="stat-title">${habit.name}</div>
                    <div class="progress-bar-container">
                        <div class="progress-bar" style="width: ${completionRate}%; background-color: ${habit.color};"></div>
                    </div>
                    <p class="card-subtitle mt-1" style="font-size: 0.8rem;">Today: ${Math.round(completionRate)}% | Streak: ${habit.streak} days</p>
                </div>
            `;
            if (habit.streak > bestStreak.streak) {
                bestStreak = { name: habit.name, streak: habit.streak };
            }
            if(completionRate > mostConsistent.rate) {
                 mostConsistent = { name: habit.name, rate: completionRate };
            }
        });
        
        const overallCompletion = totalCompletion / totalHabits;
        statsHtml = `<div class="habit-stat-item">
            <div class="stat-title"><strong>Overall Daily Completion</strong></div>
            <div class="progress-bar-container">
                <div class="progress-bar" style="width: ${overallCompletion}%;"></div>
            </div>
            <p class="card-subtitle mt-1" style="font-size: 0.8rem;">Today you've completed <strong>${Math.round(overallCompletion)}%</strong> of your goals.</p>
        </div>` + statsHtml;

        statsBody.innerHTML = statsHtml;
        
        // AI Insight
        let insightText = `<i class="fas fa-brain"></i> <strong>AI Insight:</strong> `;
        if(bestStreak.streak > 5) {
            insightText += `You have an amazing ${bestStreak.streak}-day streak on "${bestStreak.name}"! This is your strongest habit. `;
        }
        if (overallCompletion < 50 && habits.length > 3) {
            insightText += `It looks like a busy day. To avoid feeling overwhelmed, maybe focus on completing just one key habit, like "${mostConsistent.name}".`;
        } else if (overallCompletion > 80) {
            insightText += `You're on fire today! Fantastic consistency. Consider adding a new, small habit to build on this momentum.`;
        } else {
             insightText += `Keep up the steady progress. Consistency is the key to building lasting habits.`;
        }
        aiInsight.innerHTML = insightText;
        aiInsight.classList.remove('hidden');

        openModal('habitStatsModal');
    }
</script>
</body>
</html>
```
